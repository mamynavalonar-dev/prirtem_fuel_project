prirtem-fuel-webapp-docker-final-fix5 ty no IZY/
├─ client/
│  ├─ src/
│  │  ├─ auth/
│  │  │  └─ AuthContext.jsx
│  │  ├─ components/
│  │  │  ├─ AnimatedSidebar.jsx
│  │  │  ├─ FloatingLines.css
│  │  │  ├─ FloatingLines.jsx
│  │  │  ├─ GlowStatCard.css
│  │  │  ├─ GlowStatCard.jsx
│  │  │  ├─ Layout.jsx
│  │  │  ├─ Modal.jsx
│  │  │  ├─ NotificationBell.jsx
│  │  │  ├─ ProtectedRoute.jsx
│  │  │  ├─ ToastContext.jsx
│  │  │  └─ animatedSidebar.css
│  │  ├─ pages/
│  │  │  ├─ CalendarView.jsx
│  │  │  ├─ CarRequests.jsx
│  │  │  ├─ CarRequestsManage.jsx
│  │  │  ├─ Dashboard.jsx
│  │  │  ├─ Forgot.jsx
│  │  │  ├─ Fuel.jsx
│  │  │  ├─ FuelRequests.jsx
│  │  │  ├─ FuelRequestsManage.jsx
│  │  │  ├─ FuelRequestsRaf.jsx
│  │  │  ├─ ImportExcel.jsx
│  │  │  ├─ LogbookEdit.jsx
│  │  │  ├─ Logbooks.jsx
│  │  │  ├─ Login.jsx
│  │  │  ├─ Meta.jsx
│  │  │  ├─ PrintCarRequest.jsx
│  │  │  ├─ PrintFuelRequest.jsx
│  │  │  ├─ PrintLogbook.jsx
│  │  │  ├─ Register.jsx
│  │  │  ├─ Reset.jsx
│  │  │  ├─ Trash.jsx
│  │  │  └─ Users.jsx
│  │  ├─ utils/
│  │  │  └─ api.js
│  │  ├─ App.jsx
│  │  ├─ main.jsx
│  │  └─ styles.css
│  ├─ Dockerfile.dev
│  ├─ index.html
│  ├─ package-lock.json
│  ├─ package.json
│  └─ vite.config.js
├─ server/
│  ├─ src/
│  │  ├─ controllers/
│  │  │  ├─ authController.js
│  │  │  ├─ carRequestsController.js
│  │  │  ├─ fuelController.js
│  │  │  ├─ fuelRequestsController.js
│  │  │  ├─ importController.js
│  │  │  ├─ logbooksController.js
│  │  │  ├─ metaController.js
│  │  │  ├─ notificationsController.js
│  │  │  ├─ trashController.js
│  │  │  └─ usersController.js
│  │  ├─ middleware/
│  │  │  └─ auth.js
│  │  ├─ routes/
│  │  │  ├─ auth.js
│  │  │  ├─ carRequests.js
│  │  │  ├─ fuel.js
│  │  │  ├─ fuelRequests.js
│  │  │  ├─ import.js
│  │  │  ├─ logbooks.js
│  │  │  ├─ meta.js
│  │  │  ├─ notifications.js
│  │  │  ├─ trash.js
│  │  │  └─ users.js
│  │  ├─ sql/
│  │  │  ├─ initIfNeeded.js
│  │  │  ├─ reset.js
│  │  │  ├─ schema.sql
│  │  │  └─ seed.js
│  │  ├─ utils/
│  │  │  ├─ excel/
│  │  │  │  ├─ detectType.js
│  │  │  │  ├─ parseGenerator.js
│  │  │  │  ├─ parseOther.js
│  │  │  │  ├─ parseUtils.js
│  │  │  │  └─ parseVehicleFuel.js
│  │  │  ├─ asyncHandler.js
│  │  │  └─ mailer.js
│  │  ├─ db.js
│  │  └─ index.js
│  ├─ Dockerfile.dev
│  ├─ package-lock.json
│  └─ package.json
├─ Dockerfile
├─ README.md
├─ docker-compose.prod.yml
└─ docker-compose.yml


────────────────── client/package.json ──────────────────
{
  "name": "prirtem-fuel-client",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "chart.js": "^4.4.3",
    "react": "^18.3.1",
    "react-chartjs-2": "^5.2.0",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.26.2",
    "three": "^0.182.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.2",
    "vite": "^5.4.3"
  }
}


────────────────── client/package-lock.json ──────────────────
{
  "name": "prirtem-fuel-client",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "prirtem-fuel-client",
      "version": "1.0.0",
      "dependencies": {
        "chart.js": "^4.4.3",
        "react": "^18.3.1",
        "react-chartjs-2": "^5.2.0",
        "react-dom": "^18.3.1",
        "react-router-dom": "^6.26.2",
        "three": "^0.182.0"
      },
      "devDependencies": {
        "@vitejs/plugin-react": "^4.3.2",
        "vite": "^5.4.3"
      }
    },
    "node_modules/@babel/code-frame": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.27.1.tgz",
      "integrity": "sha512-cjQ7ZlQ0Mv3b47hABuTevyTuYN4i+loJKGeV9flcCgIK37cCXRh+L1bd3iBHlynerhQ7BhCkn2BPbQUL+rGqFg==",
      "dev": true,
      "dependencies": {
        "@babel/helper-validator-identifier": "^7.27.1",
        "js-tokens": "^4.0.0",
        "picocolors": "^1.1.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/compat-data": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.28.5.tgz",
      "integrity": "sha512-6uFXyCayocRbqhZOB+6XcuZbkMNimwfVGFji8CTZnCzOHVGvDqzvitu1re2AU5LROliz7eQPhB8CpAMvnx9EjA==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/core": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.28.5.tgz",
      "integrity": "sha512-e7jT4DxYvIDLk1ZHmU/m/mB19rex9sv0c2ftBtjSBv+kVM/902eh0fINUzD7UwLLNR+jU585GxUJ8/EBfAM5fw==",
      "dev": true,
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.5",
        "@babel/helper-compilation-targets": "^7.27.2",
        "@babel/helper-module-transforms": "^7.28.3",
        "@babel/helpers": "^7.28.4",
        "@babel/parser": "^7.28.5",
        "@babel/template": "^7.27.2",
        "@babel/traverse": "^7.28.5",
        "@babel/types": "^7.28.5",
        "@jridgewell/remapping": "^2.3.5",
        "convert-source-map": "^2.0.0",
        "debug": "^4.1.0",
        "gensync": "^1.0.0-beta.2",
        "json5": "^2.2.3",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/babel"
      }
    },
    "node_modules/@babel/generator": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.28.5.tgz",
      "integrity": "sha512-3EwLFhZ38J4VyIP6WNtt2kUdW9dokXA9Cr4IVIFHuCpZ3H8/YFOl5JjZHisrn1fATPBmKKqXzDFvh9fUwHz6CQ==",
      "dev": true,
      "dependencies": {
        "@babel/parser": "^7.28.5",
        "@babel/types": "^7.28.5",
        "@jridgewell/gen-mapping": "^0.3.12",
        "@jridgewell/trace-mapping": "^0.3.28",
        "jsesc": "^3.0.2"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-compilation-targets": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.27.2.tgz",
      "integrity": "sha512-2+1thGUUWWjLTYTHZWK1n8Yga0ijBz1XAhUXcKy81rd5g6yh7hGqMp45v7cadSbEHc9G3OTv45SyneRN3ps4DQ==",
      "dev": true,
      "dependencies": {
        "@babel/compat-data": "^7.27.2",
        "@babel/helper-validator-option": "^7.27.1",
        "browserslist": "^4.24.0",
        "lru-cache": "^5.1.1",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-globals": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@babel/helper-globals/-/helper-globals-7.28.0.tgz",
      "integrity": "sha512-+W6cISkXFa1jXsDEdYA8HeevQT/FULhxzR99pxphltZcVaugps53THCeiWA8SguxxpSp3gKPiuYfSWopkLQ4hw==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-imports": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.27.1.tgz",
      "integrity": "sha512-0gSFWUPNXNopqtIPQvlD5WgXYI5GY2kP2cCvoT8kczjbfcfuIljTbcWrulD1CIPIX2gt1wghbDy08yE1p+/r3w==",
      "dev": true,
      "dependencies": {
        "@babel/traverse": "^7.27.1",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-transforms": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.28.3.tgz",
      "integrity": "sha512-gytXUbs8k2sXS9PnQptz5o0QnpLL51SwASIORY6XaBKF88nsOT0Zw9szLqlSGQDP/4TljBAD5y98p2U1fqkdsw==",
      "dev": true,
      "dependencies": {
        "@babel/helper-module-imports": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.27.1",
        "@babel/traverse": "^7.28.3"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-plugin-utils": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.27.1.tgz",
      "integrity": "sha512-1gn1Up5YXka3YYAHGKpbideQ5Yjf1tDa9qYcgysz+cNCXukyLl6DjPXhD3VRwSb8c0J9tA4b2+rHEZtc6R0tlw==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-string-parser": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
      "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-identifier": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.28.5.tgz",
      "integrity": "sha512-qSs4ifwzKJSV39ucNjsvc6WVHs6b7S03sOh2OcHF9UHfVPqWWALUsNUVzhSBiItjRZoLHx7nIarVjqKVusUZ1Q==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-option": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.27.1.tgz",
      "integrity": "sha512-YvjJow9FxbhFFKDSuFnVCe2WxXk1zWc22fFePVNEaWJEu8IrZVlda6N0uHwzZrUM1il7NC9Mlp4MaJYbYd9JSg==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helpers": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.28.4.tgz",
      "integrity": "sha512-HFN59MmQXGHVyYadKLVumYsA9dBFun/ldYxipEjzA4196jpLZd8UjEEBLkbEkvfYreDqJhZxYAWFPtrfhNpj4w==",
      "dev": true,
      "dependencies": {
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.4"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/parser": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.28.5.tgz",
      "integrity": "sha512-KKBU1VGYR7ORr3At5HAtUQ+TV3SzRCXmA/8OdDZiLDBIZxVyzXuztPjfLd3BV1PRAQGCMWWSHYhL0F8d5uHBDQ==",
      "dev": true,
      "dependencies": {
        "@babel/types": "^7.28.5"
      },
      "bin": {
        "parser": "bin/babel-parser.js"
      },
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-self": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-self/-/plugin-transform-react-jsx-self-7.27.1.tgz",
      "integrity": "sha512-6UzkCs+ejGdZ5mFFC/OCUrv028ab2fp1znZmCZjAOBKiBK2jXD1O+BPSfX8X2qjJ75fZBMSnQn3Rq2mrBJK2mw==",
      "dev": true,
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-source": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-source/-/plugin-transform-react-jsx-source-7.27.1.tgz",
      "integrity": "sha512-zbwoTsBruTeKB9hSq73ha66iFeJHuaFkUbwvqElnygoNbj/jHRsSeokowZFN3CZ64IvEqcmmkVe89OPXc7ldAw==",
      "dev": true,
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/template": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.27.2.tgz",
      "integrity": "sha512-LPDZ85aEJyYSd18/DkjNh4/y1ntkE5KwUHWTiqgRxruuZL2F1yuHligVHLvcHY2vMHXttKFpJn6LwfI7cw7ODw==",
      "dev": true,
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/parser": "^7.27.2",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/traverse": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.28.5.tgz",
      "integrity": "sha512-TCCj4t55U90khlYkVV/0TfkJkAkUg3jZFA3Neb7unZT8CPok7iiRfaX0F+WnqWqt7OxhOn0uBKXCw4lbL8W0aQ==",
      "dev": true,
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.5",
        "@babel/helper-globals": "^7.28.0",
        "@babel/parser": "^7.28.5",
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.5",
        "debug": "^4.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/types": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.28.5.tgz",
      "integrity": "sha512-qQ5m48eI/MFLQ5PxQj4PFaprjyCTLI37ElWMmNs0K8Lk3dVeOdNpB3ks8jc7yM5CDmVC73eMVk/trk3fgmrUpA==",
      "dev": true,
      "dependencies": {
        "@babel/helper-string-parser": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.28.5"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@esbuild/aix-ppc64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
      "integrity": "sha512-1SDgH6ZSPTlggy1yI6+Dbkiz8xzpHJEVAlF/AM1tHPLsf5STom9rwtjE4hKAF20FfXXNTFqEYXyJNWh1GiZedQ==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "aix"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-arm": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.21.5.tgz",
      "integrity": "sha512-vCPvzSjpPHEi1siZdlvAlsPxXl7WbOVUBBAowWug4rJHb68Ox8KualB+1ocNvT5fjv6wpkX6o/iEpbDrf68zcg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.21.5.tgz",
      "integrity": "sha512-c0uX9VAUBQ7dTDCjq+wdyGLowMdtR/GoC2U5IYk/7D1H1JYC0qseD7+11iMP2mRLN9RcCMRcjC4YMclCzGwS/A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.21.5.tgz",
      "integrity": "sha512-D7aPRUUNHRBwHxzxRvp856rjUHRFW1SdQATKXH2hqA0kAZb1hKmi02OpYRacl0TxIGz/ZmXWlbZgjwWYaCakTA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/darwin-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.21.5.tgz",
      "integrity": "sha512-DwqXqZyuk5AiWWf3UfLiRDJ5EDd49zg6O9wclZ7kUMv2WRFr4HKjXp/5t8JZ11QbQfUS6/cRCKGwYhtNAY88kQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/darwin-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.21.5.tgz",
      "integrity": "sha512-se/JjF8NlmKVG4kNIuyWMV/22ZaerB+qaSi5MdrXtd6R08kvs2qCN4C09miupktDitvh8jRFflwGFBQcxZRjbw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/freebsd-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.21.5.tgz",
      "integrity": "sha512-5JcRxxRDUJLX8JXp/wcBCy3pENnCgBR9bN6JsY4OmhfUtIHe3ZW0mawA7+RDAcMLrMIZaf03NlQiX9DGyB8h4g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/freebsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.21.5.tgz",
      "integrity": "sha512-J95kNBj1zkbMXtHVH29bBriQygMXqoVQOQYA+ISs0/2l3T9/kj42ow2mpqerRBxDJnmkUDCaQT/dfNXWX/ZZCQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-arm": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.21.5.tgz",
      "integrity": "sha512-bPb5AHZtbeNGjCKVZ9UGqGwo8EUu4cLq68E95A53KlxAPRmUyYv2D6F0uUI65XisGOL1hBP5mTronbgo+0bFcA==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.21.5.tgz",
      "integrity": "sha512-ibKvmyYzKsBeX8d8I7MH/TMfWDXBF3db4qM6sy+7re0YXya+K1cem3on9XgdT2EQGMu4hQyZhan7TeQ8XkGp4Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-ia32": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.21.5.tgz",
      "integrity": "sha512-YvjXDqLRqPDl2dvRODYmmhz4rPeVKYvppfGYKSNGdyZkA01046pLWyRKKI3ax8fbJoK5QbxblURkwK/MWY18Tg==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-loong64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.21.5.tgz",
      "integrity": "sha512-uHf1BmMG8qEvzdrzAqg2SIG/02+4/DHB6a9Kbya0XDvwDEKCoC8ZRWI5JJvNdUjtciBGFQ5PuBlpEOXQj+JQSg==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-mips64el": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.21.5.tgz",
      "integrity": "sha512-IajOmO+KJK23bj52dFSNCMsz1QP1DqM6cwLUv3W1QwyxkyIWecfafnI555fvSGqEKwjMXVLokcV5ygHW5b3Jbg==",
      "cpu": [
        "mips64el"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-ppc64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.21.5.tgz",
      "integrity": "sha512-1hHV/Z4OEfMwpLO8rp7CvlhBDnjsC3CttJXIhBi+5Aj5r+MBvy4egg7wCbe//hSsT+RvDAG7s81tAvpL2XAE4w==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-riscv64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.21.5.tgz",
      "integrity": "sha512-2HdXDMd9GMgTGrPWnJzP2ALSokE/0O5HhTUvWIbD3YdjME8JwvSCnNGBnTThKGEB91OZhzrJ4qIIxk/SBmyDDA==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-s390x": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.21.5.tgz",
      "integrity": "sha512-zus5sxzqBJD3eXxwvjN1yQkRepANgxE9lgOW2qLnmr8ikMTphkjgXu1HR01K4FJg8h1kEEDAqDcZQtbrRnB41A==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.21.5.tgz",
      "integrity": "sha512-1rYdTpyv03iycF1+BhzrzQJCdOuAOtaqHTWJZCWvijKD2N5Xu0TtVC8/+1faWqcP9iBCWOmjmhoH94dH82BxPQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/netbsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.21.5.tgz",
      "integrity": "sha512-Woi2MXzXjMULccIwMnLciyZH4nCIMpWQAs049KEeMvOcNADVxo0UBIQPfSmxB3CWKedngg7sWZdLvLczpe0tLg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/openbsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.21.5.tgz",
      "integrity": "sha512-HLNNw99xsvx12lFBUwoT8EVCsSvRNDVxNpjZ7bPn947b8gJPzeHWyNVhFsaerc0n3TsbOINvRP2byTZ5LKezow==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/sunos-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.21.5.tgz",
      "integrity": "sha512-6+gjmFpfy0BHU5Tpptkuh8+uw3mnrvgs+dSPQXQOv3ekbordwnzTVEb4qnIvQcYXq6gzkyTnoZ9dZG+D4garKg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "sunos"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.21.5.tgz",
      "integrity": "sha512-Z0gOTd75VvXqyq7nsl93zwahcTROgqvuAcYDUr+vOv8uHhNSKROyU961kgtCD1e95IqPKSQKH7tBTslnS3tA8A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-ia32": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.21.5.tgz",
      "integrity": "sha512-SWXFF1CL2RVNMaVs+BBClwtfZSvDgtL//G/smwAc5oVK/UPu2Gu9tIaRgFmYFFKrmg3SyAjSrElf0TiJ1v8fYA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.21.5.tgz",
      "integrity": "sha512-tQd/1efJuzPC6rCFwEvLtci/xNFcTZknmXs98FYDfGE4wP9ClFV98nyKrzJKVPMhdDnjzLhdUyMX4PsQAPjwIw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@jridgewell/gen-mapping": {
      "version": "0.3.13",
      "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
      "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
      "dev": true,
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.0",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/remapping": {
      "version": "2.3.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/remapping/-/remapping-2.3.5.tgz",
      "integrity": "sha512-LI9u/+laYG4Ds1TDKSJW2YPrIlcVYOwi2fUC6xB43lueCjgxV4lffOCZCtYFiH6TNOX+tQKXx97T4IKHbhyHEQ==",
      "dev": true,
      "dependencies": {
        "@jridgewell/gen-mapping": "^0.3.5",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/resolve-uri": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
      "dev": true,
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@jridgewell/sourcemap-codec": {
      "version": "1.5.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
      "integrity": "sha512-cYQ9310grqxueWbl+WuIUIaiUaDcj7WOq5fVhEljNVgRfOUhY9fy2zTvfoqWsnebh8Sl70VScFbICvJnLKB0Og==",
      "dev": true
    },
    "node_modules/@jridgewell/trace-mapping": {
      "version": "0.3.31",
      "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.31.tgz",
      "integrity": "sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==",
      "dev": true,
      "dependencies": {
        "@jridgewell/resolve-uri": "^3.1.0",
        "@jridgewell/sourcemap-codec": "^1.4.14"
      }
    },
    "node_modules/@kurkle/color": {
      "version": "0.3.4",
      "resolved": "https://registry.npmjs.org/@kurkle/color/-/color-0.3.4.tgz",
      "integrity": "sha512-M5UknZPHRu3DEDWoipU6sE8PdkZ6Z/S+v4dD+Ke8IaNlpdSQah50lz1KtcFBa2vsdOnwbbnxJwVM4wty6udA5w=="
    },
    "node_modules/@remix-run/router": {
      "version": "1.23.2",
      "resolved": "https://registry.npmjs.org/@remix-run/router/-/router-1.23.2.tgz",
      "integrity": "sha512-Ic6m2U/rMjTkhERIa/0ZtXJP17QUi2CbWE7cqx4J58M8aA3QTfW+2UlQ4psvTX9IO1RfNVhK3pcpdjej7L+t2w==",
      "engines": {
        "node": ">=14.0.0"
      }
    },
    "node_modules/@rolldown/pluginutils": {
      "version": "1.0.0-beta.27",
      "resolved": "https://registry.npmjs.org/@rolldown/pluginutils/-/pluginutils-1.0.0-beta.27.tgz",
      "integrity": "sha512-+d0F4MKMCbeVUJwG96uQ4SgAznZNSq93I3V+9NHA4OpvqG8mRCpGdKmK8l/dl02h2CCDHwW2FqilnTyDcAnqjA==",
      "dev": true
    },
    "node_modules/@rollup/rollup-android-arm-eabi": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.55.1.tgz",
      "integrity": "sha512-9R0DM/ykwfGIlNu6+2U09ga0WXeZ9MRC2Ter8jnz8415VbuIykVuc6bhdrbORFZANDmTDvq26mJrEVTl8TdnDg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-android-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.55.1.tgz",
      "integrity": "sha512-eFZCb1YUqhTysgW3sj/55du5cG57S7UTNtdMjCW7LwVcj3dTTcowCsC8p7uBdzKsZYa8J7IDE8lhMI+HX1vQvg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-darwin-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.55.1.tgz",
      "integrity": "sha512-p3grE2PHcQm2e8PSGZdzIhCKbMCw/xi9XvMPErPhwO17vxtvCN5FEA2mSLgmKlCjHGMQTP6phuQTYWUnKewwGg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-darwin-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.55.1.tgz",
      "integrity": "sha512-rDUjG25C9qoTm+e02Esi+aqTKSBYwVTaoS1wxcN47/Luqef57Vgp96xNANwt5npq9GDxsH7kXxNkJVEsWEOEaQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-arm64/-/rollup-freebsd-arm64-4.55.1.tgz",
      "integrity": "sha512-+JiU7Jbp5cdxekIgdte0jfcu5oqw4GCKr6i3PJTlXTCU5H5Fvtkpbs4XJHRmWNXF+hKmn4v7ogI5OQPaupJgOg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-x64/-/rollup-freebsd-x64-4.55.1.tgz",
      "integrity": "sha512-V5xC1tOVWtLLmr3YUk2f6EJK4qksksOYiz/TCsFHu/R+woubcLWdC9nZQmwjOAbmExBIVKsm1/wKmEy4z4u4Bw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.55.1.tgz",
      "integrity": "sha512-Rn3n+FUk2J5VWx+ywrG/HGPTD9jXNbicRtTM11e/uorplArnXZYsVifnPPqNNP5BsO3roI4n8332ukpY/zN7rQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-musleabihf": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.55.1.tgz",
      "integrity": "sha512-grPNWydeKtc1aEdrJDWk4opD7nFtQbMmV7769hiAaYyUKCT1faPRm2av8CX1YJsZ4TLAZcg9gTR1KvEzoLjXkg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.55.1.tgz",
      "integrity": "sha512-a59mwd1k6x8tXKcUxSyISiquLwB5pX+fJW9TkWU46lCqD/GRDe9uDN31jrMmVP3feI3mhAdvcCClhV8V5MhJFQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.55.1.tgz",
      "integrity": "sha512-puS1MEgWX5GsHSoiAsF0TYrpomdvkaXm0CofIMG5uVkP6IBV+ZO9xhC5YEN49nsgYo1DuuMquF9+7EDBVYu4uA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-gnu/-/rollup-linux-loong64-gnu-4.55.1.tgz",
      "integrity": "sha512-r3Wv40in+lTsULSb6nnoudVbARdOwb2u5fpeoOAZjFLznp6tDU8kd+GTHmJoqZ9lt6/Sys33KdIHUaQihFcu7g==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-musl/-/rollup-linux-loong64-musl-4.55.1.tgz",
      "integrity": "sha512-MR8c0+UxAlB22Fq4R+aQSPBayvYa3+9DrwG/i1TKQXFYEaoW3B5b/rkSRIypcZDdWjWnpcvxbNaAJDcSbJU3Lw==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-gnu/-/rollup-linux-ppc64-gnu-4.55.1.tgz",
      "integrity": "sha512-3KhoECe1BRlSYpMTeVrD4sh2Pw2xgt4jzNSZIIPLFEsnQn9gAnZagW9+VqDqAHgm1Xc77LzJOo2LdigS5qZ+gw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-musl/-/rollup-linux-ppc64-musl-4.55.1.tgz",
      "integrity": "sha512-ziR1OuZx0vdYZZ30vueNZTg73alF59DicYrPViG0NEgDVN8/Jl87zkAPu4u6VjZST2llgEUjaiNl9JM6HH1Vdw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.55.1.tgz",
      "integrity": "sha512-uW0Y12ih2XJRERZ4jAfKamTyIHVMPQnTZcQjme2HMVDAHY4amf5u414OqNYC+x+LzRdRcnIG1YodLrrtA8xsxw==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-musl/-/rollup-linux-riscv64-musl-4.55.1.tgz",
      "integrity": "sha512-u9yZ0jUkOED1BFrqu3BwMQoixvGHGZ+JhJNkNKY/hyoEgOwlqKb62qu+7UjbPSHYjiVy8kKJHvXKv5coH4wDeg==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-s390x-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.55.1.tgz",
      "integrity": "sha512-/0PenBCmqM4ZUd0190j7J0UsQ/1nsi735iPRakO8iPciE7BQ495Y6msPzaOmvx0/pn+eJVVlZrNrSh4WSYLxNg==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.55.1.tgz",
      "integrity": "sha512-a8G4wiQxQG2BAvo+gU6XrReRRqj+pLS2NGXKm8io19goR+K8lw269eTrPkSdDTALwMmJp4th2Uh0D8J9bEV1vg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.55.1.tgz",
      "integrity": "sha512-bD+zjpFrMpP/hqkfEcnjXWHMw5BIghGisOKPj+2NaNDuVT+8Ds4mPf3XcPHuat1tz89WRL+1wbcxKY3WSbiT7w==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-openbsd-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openbsd-x64/-/rollup-openbsd-x64-4.55.1.tgz",
      "integrity": "sha512-eLXw0dOiqE4QmvikfQ6yjgkg/xDM+MdU9YJuP4ySTibXU0oAvnEWXt7UDJmD4UkYialMfOGFPJnIHSe/kdzPxg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openbsd"
      ]
    },
    "node_modules/@rollup/rollup-openharmony-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openharmony-arm64/-/rollup-openharmony-arm64-4.55.1.tgz",
      "integrity": "sha512-xzm44KgEP11te3S2HCSyYf5zIzWmx3n8HDCc7EE59+lTcswEWNpvMLfd9uJvVX8LCg9QWG67Xt75AuHn4vgsXw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openharmony"
      ]
    },
    "node_modules/@rollup/rollup-win32-arm64-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.55.1.tgz",
      "integrity": "sha512-yR6Bl3tMC/gBok5cz/Qi0xYnVbIxGx5Fcf/ca0eB6/6JwOY+SRUcJfI0OpeTpPls7f194as62thCt/2BjxYN8g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-ia32-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.55.1.tgz",
      "integrity": "sha512-3fZBidchE0eY0oFZBnekYCfg+5wAB0mbpCBuofh5mZuzIU/4jIVkbESmd2dOsFNS78b53CYv3OAtwqkZZmU5nA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-gnu/-/rollup-win32-x64-gnu-4.55.1.tgz",
      "integrity": "sha512-xGGY5pXj69IxKb4yv/POoocPy/qmEGhimy/FoTpTSVju3FYXUQQMFCaZZXJVidsmGxRioZAwpThl/4zX41gRKg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.55.1.tgz",
      "integrity": "sha512-SPEpaL6DX4rmcXtnhdrQYgzQ5W2uW3SCJch88lB2zImhJRhIIK44fkUrgIV/Q8yUNfw5oyZ5vkeQsZLhCb06lw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@types/babel__core": {
      "version": "7.20.5",
      "resolved": "https://registry.npmjs.org/@types/babel__core/-/babel__core-7.20.5.tgz",
      "integrity": "sha512-qoQprZvz5wQFJwMDqeseRXWv3rqMvhgpbXFfVyWhbx9X47POIA6i/+dXefEmZKoAgOaTdaIgNSMqMIU61yRyzA==",
      "dev": true,
      "dependencies": {
        "@babel/parser": "^7.20.7",
        "@babel/types": "^7.20.7",
        "@types/babel__generator": "*",
        "@types/babel__template": "*",
        "@types/babel__traverse": "*"
      }
    },
    "node_modules/@types/babel__generator": {
      "version": "7.27.0",
      "resolved": "https://registry.npmjs.org/@types/babel__generator/-/babel__generator-7.27.0.tgz",
      "integrity": "sha512-ufFd2Xi92OAVPYsy+P4n7/U7e68fex0+Ee8gSG9KX7eo084CWiQ4sdxktvdl0bOPupXtVJPY19zk6EwWqUQ8lg==",
      "dev": true,
      "dependencies": {
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__template": {
      "version": "7.4.4",
      "resolved": "https://registry.npmjs.org/@types/babel__template/-/babel__template-7.4.4.tgz",
      "integrity": "sha512-h/NUaSyG5EyxBIp8YRxo4RMe2/qQgvyowRwVMzhYhBCONbW8PUsg4lkFMrhgZhUe5z3L3MiLDuvyJ/CaPa2A8A==",
      "dev": true,
      "dependencies": {
        "@babel/parser": "^7.1.0",
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__traverse": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@types/babel__traverse/-/babel__traverse-7.28.0.tgz",
      "integrity": "sha512-8PvcXf70gTDZBgt9ptxJ8elBeBjcLOAcOtoO/mPJjtji1+CdGbHgm77om1GrsPxsiE+uXIpNSK64UYaIwQXd4Q==",
      "dev": true,
      "dependencies": {
        "@babel/types": "^7.28.2"
      }
    },
    "node_modules/@types/estree": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.8.tgz",
      "integrity": "sha512-dWHzHa2WqEXI/O1E9OjrocMTKJl2mSrEolh1Iomrv6U+JuNwaHXsXx9bLu5gG7BUWFIN0skIQJQ/L1rIex4X6w==",
      "dev": true
    },
    "node_modules/@vitejs/plugin-react": {
      "version": "4.7.0",
      "resolved": "https://registry.npmjs.org/@vitejs/plugin-react/-/plugin-react-4.7.0.tgz",
      "integrity": "sha512-gUu9hwfWvvEDBBmgtAowQCojwZmJ5mcLn3aufeCsitijs3+f2NsrPtlAWIR6OPiqljl96GVCUbLe0HyqIpVaoA==",
      "dev": true,
      "dependencies": {
        "@babel/core": "^7.28.0",
        "@babel/plugin-transform-react-jsx-self": "^7.27.1",
        "@babel/plugin-transform-react-jsx-source": "^7.27.1",
        "@rolldown/pluginutils": "1.0.0-beta.27",
        "@types/babel__core": "^7.20.5",
        "react-refresh": "^0.17.0"
      },
      "engines": {
        "node": "^14.18.0 || >=16.0.0"
      },
      "peerDependencies": {
        "vite": "^4.2.0 || ^5.0.0 || ^6.0.0 || ^7.0.0"
      }
    },
    "node_modules/baseline-browser-mapping": {
      "version": "2.9.12",
      "resolved": "https://registry.npmjs.org/baseline-browser-mapping/-/baseline-browser-mapping-2.9.12.tgz",
      "integrity": "sha512-Mij6Lij93pTAIsSYy5cyBQ975Qh9uLEc5rwGTpomiZeXZL9yIS6uORJakb3ScHgfs0serMMfIbXzokPMuEiRyw==",
      "dev": true,
      "bin": {
        "baseline-browser-mapping": "dist/cli.js"
      }
    },
    "node_modules/browserslist": {
      "version": "4.28.1",
      "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.28.1.tgz",
      "integrity": "sha512-ZC5Bd0LgJXgwGqUknZY/vkUQ04r8NXnJZ3yYi4vDmSiZmC/pdSN0NbNRPxZpbtO4uAfDUAFffO8IZoM3Gj8IkA==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "dependencies": {
        "baseline-browser-mapping": "^2.9.0",
        "caniuse-lite": "^1.0.30001759",
        "electron-to-chromium": "^1.5.263",
        "node-releases": "^2.0.27",
        "update-browserslist-db": "^1.2.0"
      },
      "bin": {
        "browserslist": "cli.js"
      },
      "engines": {
        "node": "^6 || ^7 || ^8 || ^9 || ^10 || ^11 || ^12 || >=13.7"
      }
    },
    "node_modules/caniuse-lite": {
      "version": "1.0.30001763",
      "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001763.tgz",
      "integrity": "sha512-mh/dGtq56uN98LlNX9qdbKnzINhX0QzhiWBFEkFfsFO4QyCvL8YegrJAazCwXIeqkIob8BlZPGM3xdnY+sgmvQ==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/caniuse-lite"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ]
    },
    "node_modules/chart.js": {
      "version": "4.5.1",
      "resolved": "https://registry.npmjs.org/chart.js/-/chart.js-4.5.1.tgz",
      "integrity": "sha512-GIjfiT9dbmHRiYi6Nl2yFCq7kkwdkp1W/lp2J99rX0yo9tgJGn3lKQATztIjb5tVtevcBtIdICNWqlq5+E8/Pw==",
      "dependencies": {
        "@kurkle/color": "^0.3.0"
      },
      "engines": {
        "pnpm": ">=8"
      }
    },
    "node_modules/convert-source-map": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/convert-source-map/-/convert-source-map-2.0.0.tgz",
      "integrity": "sha512-Kvp459HrV2FEJ1CAsi1Ku+MY3kasH19TFykTz2xWmMeq6bk2NU3XXvfJ+Q61m0xktWwt+1HSYf3JZsTms3aRJg==",
      "dev": true
    },
    "node_modules/debug": {
      "version": "4.4.3",
      "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.3.tgz",
      "integrity": "sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==",
      "dev": true,
      "dependencies": {
        "ms": "^2.1.3"
      },
      "engines": {
        "node": ">=6.0"
      },
      "peerDependenciesMeta": {
        "supports-color": {
          "optional": true
        }
      }
    },
    "node_modules/electron-to-chromium": {
      "version": "1.5.267",
      "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.5.267.tgz",
      "integrity": "sha512-0Drusm6MVRXSOJpGbaSVgcQsuB4hEkMpHXaVstcPmhu5LIedxs1xNK/nIxmQIU/RPC0+1/o0AVZfBTkTNJOdUw==",
      "dev": true
    },
    "node_modules/esbuild": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.21.5.tgz",
      "integrity": "sha512-mg3OPMV4hXywwpoDxu3Qda5xCKQi+vCTZq8S9J/EpkhB2HzKXq4SNFZE3+NK93JYxc8VMSep+lOUSC/RVKaBqw==",
      "dev": true,
      "hasInstallScript": true,
      "bin": {
        "esbuild": "bin/esbuild"
      },
      "engines": {
        "node": ">=12"
      },
      "optionalDependencies": {
        "@esbuild/aix-ppc64": "0.21.5",
        "@esbuild/android-arm": "0.21.5",
        "@esbuild/android-arm64": "0.21.5",
        "@esbuild/android-x64": "0.21.5",
        "@esbuild/darwin-arm64": "0.21.5",
        "@esbuild/darwin-x64": "0.21.5",
        "@esbuild/freebsd-arm64": "0.21.5",
        "@esbuild/freebsd-x64": "0.21.5",
        "@esbuild/linux-arm": "0.21.5",
        "@esbuild/linux-arm64": "0.21.5",
        "@esbuild/linux-ia32": "0.21.5",
        "@esbuild/linux-loong64": "0.21.5",
        "@esbuild/linux-mips64el": "0.21.5",
        "@esbuild/linux-ppc64": "0.21.5",
        "@esbuild/linux-riscv64": "0.21.5",
        "@esbuild/linux-s390x": "0.21.5",
        "@esbuild/linux-x64": "0.21.5",
        "@esbuild/netbsd-x64": "0.21.5",
        "@esbuild/openbsd-x64": "0.21.5",
        "@esbuild/sunos-x64": "0.21.5",
        "@esbuild/win32-arm64": "0.21.5",
        "@esbuild/win32-ia32": "0.21.5",
        "@esbuild/win32-x64": "0.21.5"
      }
    },
    "node_modules/escalade": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz",
      "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
      "dev": true,
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/fsevents": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
      "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
      "dev": true,
      "hasInstallScript": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
      }
    },
    "node_modules/gensync": {
      "version": "1.0.0-beta.2",
      "resolved": "https://registry.npmjs.org/gensync/-/gensync-1.0.0-beta.2.tgz",
      "integrity": "sha512-3hN7NaskYvMDLQY55gnW3NQ+mesEAepTqlg+VEbj7zzqEMBVNhzcGYYeqFo/TlYz6eQiFcp1HcsCZO+nGgS8zg==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/js-tokens": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/js-tokens/-/js-tokens-4.0.0.tgz",
      "integrity": "sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ=="
    },
    "node_modules/jsesc": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/jsesc/-/jsesc-3.1.0.tgz",
      "integrity": "sha512-/sM3dO2FOzXjKQhJuo0Q173wf2KOo8t4I8vHy6lF9poUp7bKT0/NHE8fPX23PwfhnykfqnC2xRxOnVw5XuGIaA==",
      "dev": true,
      "bin": {
        "jsesc": "bin/jsesc"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/json5": {
      "version": "2.2.3",
      "resolved": "https://registry.npmjs.org/json5/-/json5-2.2.3.tgz",
      "integrity": "sha512-XmOWe7eyHYH14cLdVPoyg+GOH3rYX++KpzrylJwSW98t3Nk+U8XOl8FWKOgwtzdb8lXGf6zYwDUzeHMWfxasyg==",
      "dev": true,
      "bin": {
        "json5": "lib/cli.js"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/loose-envify": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/loose-envify/-/loose-envify-1.4.0.tgz",
      "integrity": "sha512-lyuxPGr/Wfhrlem2CL/UcnUc1zcqKAImBDzukY7Y5F/yQiNdko6+fRLevlw1HgMySw7f611UIY408EtxRSoK3Q==",
      "dependencies": {
        "js-tokens": "^3.0.0 || ^4.0.0"
      },
      "bin": {
        "loose-envify": "cli.js"
      }
    },
    "node_modules/lru-cache": {
      "version": "5.1.1",
      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-5.1.1.tgz",
      "integrity": "sha512-KpNARQA3Iwv+jTA0utUVVbrh+Jlrr1Fv0e56GGzAFOXN7dk/FviaDW8LHmK52DlcH4WP2n6gI8vN1aesBFgo9w==",
      "dev": true,
      "dependencies": {
        "yallist": "^3.0.2"
      }
    },
    "node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "dev": true
    },
    "node_modules/nanoid": {
      "version": "3.3.11",
      "resolved": "https://registry.npmjs.org/nanoid/-/nanoid-3.3.11.tgz",
      "integrity": "sha512-N8SpfPUnUp1bK+PMYW8qSWdl9U+wwNWI4QKxOYDy9JAro3WMX7p2OeVRF9v+347pnakNevPmiHhNmZ2HbFA76w==",
      "dev": true,
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "bin": {
        "nanoid": "bin/nanoid.cjs"
      },
      "engines": {
        "node": "^10 || ^12 || ^13.7 || ^14 || >=15.0.1"
      }
    },
    "node_modules/node-releases": {
      "version": "2.0.27",
      "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.27.tgz",
      "integrity": "sha512-nmh3lCkYZ3grZvqcCH+fjmQ7X+H0OeZgP40OierEaAptX4XofMh5kwNbWh7lBduUzCcV/8kZ+NDLCwm2iorIlA==",
      "dev": true
    },
    "node_modules/picocolors": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.1.tgz",
      "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
      "dev": true
    },
    "node_modules/postcss": {
      "version": "8.5.6",
      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.5.6.tgz",
      "integrity": "sha512-3Ybi1tAuwAP9s0r1UQ2J4n5Y0G05bJkpUIO0/bI9MhwmD70S5aTWbXGBwxHrelT+XM1k6dM0pk+SwNkpTRN7Pg==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/postcss"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "dependencies": {
        "nanoid": "^3.3.11",
        "picocolors": "^1.1.1",
        "source-map-js": "^1.2.1"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      }
    },
    "node_modules/react": {
      "version": "18.3.1",
      "resolved": "https://registry.npmjs.org/react/-/react-18.3.1.tgz",
      "integrity": "sha512-wS+hAgJShR0KhEvPJArfuPVN1+Hz1t0Y6n5jLrGQbkb4urgPE/0Rve+1kMB1v/oWgHgm4WIcV+i7F2pTVj+2iQ==",
      "dependencies": {
        "loose-envify": "^1.1.0"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-chartjs-2": {
      "version": "5.3.1",
      "resolved": "https://registry.npmjs.org/react-chartjs-2/-/react-chartjs-2-5.3.1.tgz",
      "integrity": "sha512-h5IPXKg9EXpjoBzUfyWJvllMjG2mQ4EiuHQFhms/AjUm0XSZHhyRy2xVmLXHKrtcdrPO4mnGqRtYoD0vp95A0A==",
      "peerDependencies": {
        "chart.js": "^4.1.1",
        "react": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0"
      }
    },
    "node_modules/react-dom": {
      "version": "18.3.1",
      "resolved": "https://registry.npmjs.org/react-dom/-/react-dom-18.3.1.tgz",
      "integrity": "sha512-5m4nQKp+rZRb09LNH59GM4BxTh9251/ylbKIbpe7TpGxfJ+9kv6BLkLBXIjjspbgbnIBNqlI23tRnTWT0snUIw==",
      "dependencies": {
        "loose-envify": "^1.1.0",
        "scheduler": "^0.23.2"
      },
      "peerDependencies": {
        "react": "^18.3.1"
      }
    },
    "node_modules/react-refresh": {
      "version": "0.17.0",
      "resolved": "https://registry.npmjs.org/react-refresh/-/react-refresh-0.17.0.tgz",
      "integrity": "sha512-z6F7K9bV85EfseRCp2bzrpyQ0Gkw1uLoCel9XBVWPg/TjRj94SkJzUTGfOa4bs7iJvBWtQG0Wq7wnI0syw3EBQ==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-router": {
      "version": "6.30.3",
      "resolved": "https://registry.npmjs.org/react-router/-/react-router-6.30.3.tgz",
      "integrity": "sha512-XRnlbKMTmktBkjCLE8/XcZFlnHvr2Ltdr1eJX4idL55/9BbORzyZEaIkBFDhFGCEWBBItsVrDxwx3gnisMitdw==",
      "dependencies": {
        "@remix-run/router": "1.23.2"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "react": ">=16.8"
      }
    },
    "node_modules/react-router-dom": {
      "version": "6.30.3",
      "resolved": "https://registry.npmjs.org/react-router-dom/-/react-router-dom-6.30.3.tgz",
      "integrity": "sha512-pxPcv1AczD4vso7G4Z3TKcvlxK7g7TNt3/FNGMhfqyntocvYKj+GCatfigGDjbLozC4baguJ0ReCigoDJXb0ag==",
      "dependencies": {
        "@remix-run/router": "1.23.2",
        "react-router": "6.30.3"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "react": ">=16.8",
        "react-dom": ">=16.8"
      }
    },
    "node_modules/rollup": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.55.1.tgz",
      "integrity": "sha512-wDv/Ht1BNHB4upNbK74s9usvl7hObDnvVzknxqY/E/O3X6rW1U1rV1aENEfJ54eFZDTNo7zv1f5N4edCluH7+A==",
      "dev": true,
      "dependencies": {
        "@types/estree": "1.0.8"
      },
      "bin": {
        "rollup": "dist/bin/rollup"
      },
      "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
      },
      "optionalDependencies": {
        "@rollup/rollup-android-arm-eabi": "4.55.1",
        "@rollup/rollup-android-arm64": "4.55.1",
        "@rollup/rollup-darwin-arm64": "4.55.1",
        "@rollup/rollup-darwin-x64": "4.55.1",
        "@rollup/rollup-freebsd-arm64": "4.55.1",
        "@rollup/rollup-freebsd-x64": "4.55.1",
        "@rollup/rollup-linux-arm-gnueabihf": "4.55.1",
        "@rollup/rollup-linux-arm-musleabihf": "4.55.1",
        "@rollup/rollup-linux-arm64-gnu": "4.55.1",
        "@rollup/rollup-linux-arm64-musl": "4.55.1",
        "@rollup/rollup-linux-loong64-gnu": "4.55.1",
        "@rollup/rollup-linux-loong64-musl": "4.55.1",
        "@rollup/rollup-linux-ppc64-gnu": "4.55.1",
        "@rollup/rollup-linux-ppc64-musl": "4.55.1",
        "@rollup/rollup-linux-riscv64-gnu": "4.55.1",
        "@rollup/rollup-linux-riscv64-musl": "4.55.1",
        "@rollup/rollup-linux-s390x-gnu": "4.55.1",
        "@rollup/rollup-linux-x64-gnu": "4.55.1",
        "@rollup/rollup-linux-x64-musl": "4.55.1",
        "@rollup/rollup-openbsd-x64": "4.55.1",
        "@rollup/rollup-openharmony-arm64": "4.55.1",
        "@rollup/rollup-win32-arm64-msvc": "4.55.1",
        "@rollup/rollup-win32-ia32-msvc": "4.55.1",
        "@rollup/rollup-win32-x64-gnu": "4.55.1",
        "@rollup/rollup-win32-x64-msvc": "4.55.1",
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/scheduler": {
      "version": "0.23.2",
      "resolved": "https://registry.npmjs.org/scheduler/-/scheduler-0.23.2.tgz",
      "integrity": "sha512-UOShsPwz7NrMUqhR6t0hWjFduvOzbtv7toDH1/hIrfRNIDBnnBWd0CwJTGvTpngVlmwGCdP9/Zl/tVrDqcuYzQ==",
      "dependencies": {
        "loose-envify": "^1.1.0"
      }
    },
    "node_modules/semver": {
      "version": "6.3.1",
      "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
      "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
      "dev": true,
      "bin": {
        "semver": "bin/semver.js"
      }
    },
    "node_modules/source-map-js": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
      "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/three": {
      "version": "0.182.0",
      "resolved": "https://registry.npmjs.org/three/-/three-0.182.0.tgz",
      "integrity": "sha512-GbHabT+Irv+ihI1/f5kIIsZ+Ef9Sl5A1Y7imvS5RQjWgtTPfPnZ43JmlYI7NtCRDK9zir20lQpfg8/9Yd02OvQ=="
    },
    "node_modules/update-browserslist-db": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.2.3.tgz",
      "integrity": "sha512-Js0m9cx+qOgDxo0eMiFGEueWztz+d4+M3rGlmKPT+T4IS/jP4ylw3Nwpu6cpTTP8R1MAC1kF4VbdLt3ARf209w==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "dependencies": {
        "escalade": "^3.2.0",
        "picocolors": "^1.1.1"
      },
      "bin": {
        "update-browserslist-db": "cli.js"
      },
      "peerDependencies": {
        "browserslist": ">= 4.21.0"
      }
    },
    "node_modules/vite": {
      "version": "5.4.21",
      "resolved": "https://registry.npmjs.org/vite/-/vite-5.4.21.tgz",
      "integrity": "sha512-o5a9xKjbtuhY6Bi5S3+HvbRERmouabWbyUcpXXUA1u+GNUKoROi9byOJ8M0nHbHYHkYICiMlqxkg1KkYmm25Sw==",
      "dev": true,
      "dependencies": {
        "esbuild": "^0.21.3",
        "postcss": "^8.4.43",
        "rollup": "^4.20.0"
      },
      "bin": {
        "vite": "bin/vite.js"
      },
      "engines": {
        "node": "^18.0.0 || >=20.0.0"
      },
      "funding": {
        "url": "https://github.com/vitejs/vite?sponsor=1"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.3"
      },
      "peerDependencies": {
        "@types/node": "^18.0.0 || >=20.0.0",
        "less": "*",
        "lightningcss": "^1.21.0",
        "sass": "*",
        "sass-embedded": "*",
        "stylus": "*",
        "sugarss": "*",
        "terser": "^5.4.0"
      },
      "peerDependenciesMeta": {
        "@types/node": {
          "optional": true
        },
        "less": {
          "optional": true
        },
        "lightningcss": {
          "optional": true
        },
        "sass": {
          "optional": true
        },
        "sass-embedded": {
          "optional": true
        },
        "stylus": {
          "optional": true
        },
        "sugarss": {
          "optional": true
        },
        "terser": {
          "optional": true
        }
      }
    },
    "node_modules/yallist": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/yallist/-/yallist-3.1.1.tgz",
      "integrity": "sha512-a4UGQaWPH59mOXUYnAG2ewncQS4i4F43Tv3JoAM+s2VDAmS9NsK8GpDMLrCHPksFT7h3K6TOoUNn2pb7RoXx4g==",
      "dev": true
    }
  }
}


────────────────── client/vite.config.js ──────────────────
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    // DEV convenience: allow the frontend to call /api/* without CORS headaches.
    // If VITE_API_URL is not set, the app falls back to same-origin /api calls.
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
      },
    },
  },
  build: {
    outDir: 'dist',
  }
});


────────────────── client/src/styles.css ──────────────────
:root{
  --bg: #f7f7fb;
  --surface: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --border: rgba(15, 23, 42, .12);
  --shadow: 0 1px 2px rgba(0,0,0,.04), 0 12px 38px rgba(15,23,42,.10);
  --shadow-sm: 0 1px 2px rgba(0,0,0,.05);
  --radius: 14px;
  --radius-sm: 10px;

  --primary: #111827;
  --primary-2: #0b1220;
  --primary-3: #0f172a;

  --accent: #2563eb;
  --ring: rgba(37, 99, 235, .35);

  --danger: #ef4444;
  --warning: #f59e0b;
  --success: #10b981;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  color: var(--text);
  background: var(--bg);
}

*{ box-sizing: border-box; }
html, body{ 
  height: 100%; 
  overflow-x: hidden; /* CORRECTIF PROACTIF : Empêche le scrollbar horizontal global */
}
body{ margin: 0; background: var(--bg); }

a{ color: inherit; text-decoration: none; }
a:hover{ text-decoration: underline; }

::selection{ background: rgba(37,99,235,.18);
}

/* ===================== LAYOUT ===================== */
.layout{
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
}

.main{
  min-width: 0;
}

.container{
  max-width: 1280px;
  margin: 0 auto;
  padding: 18px;
}

/* ===================== SIDEBAR ===================== */
.sidebar{
  position: sticky;
  top: 0;
  height: 100vh;
  background: linear-gradient(180deg, var(--primary-2), var(--primary));
  color: #fff;
  border-right: 1px solid rgba(255,255,255,.10);
  display: flex;
  flex-direction: column;
}

.sidebarHeader{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 16px 16px 12px;
}

.brand{
  display:flex;
  flex-direction: column;
  line-height: 1.1;
}
.brand b{ font-size: 14px;
letter-spacing: .3px; }
.brand span{ font-size: 12px; color: rgba(255,255,255,.70); }

.sidebar__user{
  padding: 12px 16px;
  border-top: 1px solid rgba(255,255,255,.10);
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.sidebar__userName{ font-weight: 800; font-size: 13px; }
.sidebar__userRole{ font-size: 12px; color: rgba(255,255,255,.72); margin-top: 3px; }

.sidebar__navWrap{
  padding: 10px;
  overflow: auto;
  flex: 1;
}
.sidebar__nav{
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.navItem{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 10px 10px;
  border-radius: 12px;
  color: rgba(255,255,255,.86);
  text-decoration: none !important;
  transition: background .15s ease, transform .08s ease;
}
.navItem:hover{
  background: rgba(255,255,255,.08);
}
.navItem:active{
  transform: translateY(1px);
}
.navItem.active{
  background: rgba(255,255,255,.14);
  color: #fff;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
}

.sidebarFooter{
  padding: 12px 16px 16px;
  border-top: 1px solid rgba(255,255,255,.10);
}

.sidebarOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 9998;
}

/* mobile off-canvas */
@media (max-width: 900px){
  .layout{ grid-template-columns: 1fr;
}
  .sidebar{
    position: fixed;
    left: 0;
    top: 0;
    transform: translateX(-105%);
    transition: transform .18s ease;
    width: 280px;
    z-index: 9999;
  }
  .sidebar.open{ transform: translateX(0); }
}

/* ===================== TOPBAR ===================== */
.topbar{
  position: sticky;
  top: 0;
  z-index: 50;
  backdrop-filter: blur(10px);
  background: rgba(247,247,251,.78);
  border-bottom: 1px solid var(--border);
  padding: 12px 18px;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
}

.topbarLeft{
  display:flex;
  align-items:center;
  gap: 10px;
  min-width: 0;
}

.topbarTitle{
  font-weight: 900;
  font-size: 14px;
  letter-spacing: .2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.topbarRight{
  display:flex;
  align-items:center;
  gap: 10px;
}

.topbar-logout{ display: none; }
@media (max-width: 900px){
  .topbar-logout{ display: inline-flex;
}
}

/* ===================== CARDS / TYPO ===================== */
h1,h2,h3{ margin: 0 0 10px 0; letter-spacing: .2px; }
h2{ font-size: 18px; }
h3{ font-size: 15px;
}

.card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow-sm);
}

.muted{ color: var(--muted); }
.error{ color: #b91c1c;
font-weight: 600; }

/* ===================== FORMS ===================== */
.form{ display:flex; flex-direction: column; gap: 10px; }
.field{ display:flex; flex-direction: column; gap: 6px; min-width: 220px;
}

.label{
  font-size: 12px;
  font-weight: 800;
  color: var(--primary-3);
}

.row{ display:flex; gap: 12px; align-items:center; }
.row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px;
}
.rowBetween{ display:flex; justify-content: space-between; gap: 12px; align-items:center; flex-wrap: wrap; }

input, select, textarea, .input{
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(15,23,42,.14);
  outline: none;
  background: #fff;
  transition: border-color .12s ease, box-shadow .12s ease, transform .08s ease;
}

textarea{ min-height: 90px; resize: vertical; }

input:focus, select:focus, textarea:focus, .input:focus{
  border-color: rgba(37,99,235,.55);
  box-shadow: 0 0 0 4px var(--ring);
}

input:disabled, select:disabled, textarea:disabled{
  background: rgba(15,23,42,.04);
  cursor: not-allowed;
}

/* ===================== BUTTONS ===================== */
.btn, button{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid transparent;
  background: var(--primary);
  color: #fff;
  cursor: pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  font-weight: 700;
}

.btn:hover, button:hover{ background: #0b1220;
}
.btn:active, button:active{ transform: translateY(1px); }
.btn:disabled, button:disabled{ opacity: .6; cursor: not-allowed; transform: none; }

.btn-sm{ padding: 8px 10px; border-radius: 10px; font-size: 13px;
}

.btn-outline{
  background: transparent;
  border-color: rgba(15,23,42,.20);
  color: var(--primary-3);
}
.btn-outline:hover{ background: rgba(15,23,42,.04); }

.btn-secondary{
  background: rgba(37,99,235,.10);
  color: #1d4ed8;
  border-color: rgba(37,99,235,.20);
}
.btn-secondary:hover{ background: rgba(37,99,235,.14); }

.btn-danger{
  background: rgba(239,68,68,.12);
  color: #b91c1c;
  border-color: rgba(239,68,68,.22);
}
.btn-danger:hover{ background: rgba(239,68,68,.16); }

.btn-primary{ background: var(--primary); color: #fff;
}
.btn-ghost{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.14);
  color: #fff;
}
.btn-ghost:hover{ background: rgba(255,255,255,.14);
}

/* small icon button (hamburger, close, bell) */
.iconBtn{
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 12px;
  background: rgba(15,23,42,.06);
  border: 1px solid rgba(15,23,42,.10);
  color: var(--primary-3);
}
.iconBtn:hover{ background: rgba(15,23,42,.10); }

/* ===================== TABLES ===================== */
.tableWrap{
  width: 100%;
  overflow: auto;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--surface);
  box-shadow: var(--shadow-sm);
}

.table{
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  min-width: 760px;
}

.table th, .table td{
  padding: 12px 12px;
  border-bottom: 1px solid rgba(15,23,42,.08);
  vertical-align: top;
}
.table th{
  position: sticky;
  top: 0;
  background: rgba(247,247,251,.92);
  backdrop-filter: blur(10px);
  text-align: left;
  font-size: 12px;
  font-weight: 900;
  color: rgba(15,23,42,.80);
  letter-spacing: .18px;
}

.table tbody tr:hover{
  background: rgba(37,99,235,.04);
}

/* ===================== BADGES ===================== */
.badge{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.14);
  background: rgba(15,23,42,.03);
  font-size: 12px;
  font-weight: 700;
}

.badge-warn{ background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.22);
color: #92400e; }
.badge-info{ background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.22); color: #1d4ed8; }
.badge-ok{ background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.22); color: #047857; }
.badge-bad{ background: rgba(239,68,68,.10);
border-color: rgba(239,68,68,.22); color: #b91c1c; }

/* ===================== ALERTS / NOTICES ===================== */
.alert{
  background: rgba(59,130,246,.08);
  border: 1px solid rgba(59,130,246,.18);
  color: #1d4ed8;
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 600;
}
.alert-danger{
  background: rgba(239,68,68,.08);
  border-color: rgba(239,68,68,.18);
  color: #b91c1c;
}
.notice{
  background: rgba(15,23,42,.04);
  border: 1px dashed rgba(15,23,42,.18);
  color: rgba(15,23,42,.78);
  padding: 10px 12px;
  border-radius: 12px;
}

/* ===================== TABS ===================== */
.tabs{ display:flex; gap: 8px;
flex-wrap: wrap; }
.tab{
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.14);
  cursor: pointer;
  background: #fff;
  font-weight: 700;
}
.tab.active{
  background: var(--primary);
  color: #fff;
  border-color: var(--primary);
}

/* ===================== MODAL ===================== */
.modalOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 18px;
  z-index: 9999;
  animation: fadeIn .15s ease-out;
}
.modal{
  width: 720px;
  max-width: 95vw;
  max-height: 85vh;
  overflow: auto;
  background: #fff;
  border-radius: 16px;
  border: 1px solid rgba(15,23,42,.14);
  box-shadow: 0 25px 70px rgba(0,0,0,.28);
  animation: popIn .15s ease-out;
}
.modalHeader{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  padding: 14px 14px 10px;
  border-bottom: 1px solid rgba(15,23,42,.10);
}
.modalTitle{ font-size: 14px;
font-weight: 900; }
.modalBody{ padding: 14px; }

@keyframes fadeIn{ from{ opacity: 0; } to{ opacity: 1;
} }
@keyframes popIn{ from{ transform: translateY(8px) scale(.98); opacity: 0; } to{ transform: translateY(0) scale(1); opacity: 1;
} }

/* ===================== TOASTS ===================== */
.toastHost{
  position: fixed;
  top: 72px;
  right: 18px;
  z-index: 10000;
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.toast{
  background: #0b1220;
  color: #fff;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 14px;
  padding: 12px 14px;
  min-width: 240px;
  box-shadow: 0 18px 55px rgba(0,0,0,.25);
  animation: toastIn .18s ease-out;
}
.toastRow{ display:flex; gap: 10px; align-items:flex-start; }
.toastDot{
  width: 10px;
  height: 10px;
  border-radius: 999px;
  margin-top: 4px;
  flex-shrink: 0;
}
.toastTitle{ font-weight: 900; font-size: 13px; margin-bottom: 2px; }
.toastMsg{ font-size: 12px; color: rgba(255,255,255,.78);
}
.toastTime{ font-size: 11px; color: rgba(255,255,255,.55); margin-top: 6px; }
@keyframes toastIn{ from{ transform: translateY(-6px); opacity: 0; } to{ transform: translateY(0); opacity: 1;
} }

/* ===================== PRINT ===================== */
.printWrap, .printPage{ background: var(--bg); min-height: 100vh; }
.paper{
  background: #fff;
  width: 210mm;
  min-height: 297mm;
  margin: 10px auto;
  padding: 14mm;
  border: 1px solid rgba(15,23,42,.10);
  box-shadow: var(--shadow);
}
.paperHeader{ display:flex; justify-content: space-between; }
.paperTitle{ text-align: center;
margin: 8px 0 16px; font-size: 22px; font-weight: 900; }

.printToolbar, .printBar{
  display:flex;
  gap: 10px;
  justify-content: center;
  padding: 12px;
}

.printTwoCol{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10mm;
  width: 210mm;
  margin: 10px auto;
}
.printBox{
  background: #fff;
  border: 1px solid rgba(15,23,42,.10);
  padding: 12mm;
}
.printHeader{ display:flex; justify-content: space-between; }
.printField{
  display:flex;
  justify-content: space-between;
  gap: 16px;
  padding: 6px 0;
  border-bottom: 1px dashed rgba(15,23,42,.16);
}
.printSignTable{
  width: 100%;
  border-collapse: collapse;
  margin-top: 14px;
}
.printSignTable th, .printSignTable td{
  border: 1px solid var(--primary);
  padding: 10px;
}

@media print{
  .noPrint{ display:none !important;
  }
  body{ 
    background: #fff; 
    overflow-x: visible !important; /* IMPORTANT: Restaurer le scroll/largeur pour l'impression */
  }
  .paper, .printTwoCol{ margin: 0; border: none; box-shadow: none;
  }
}

/* ===================== HELPERS ===================== */
hr{ border: none; border-top: 1px solid rgba(15,23,42,.10); margin: 16px 0; }
.grid2{ display:grid; grid-template-columns: 1fr 1fr;
gap: 12px; }
@media (max-width: 900px){
  .grid2{ grid-template-columns: 1fr; }
}

/* reduce motion */
@media (prefers-reduced-motion: reduce){
  *{ transition: none !important;
animation: none !important; }
}


/* ===================== DASH KPI GLOW CARDS ===================== */
.kpiGrid{
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 14px;
  margin-bottom: 12px;
}
@media (max-width: 1200px){
  .kpiGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (max-width: 900px){
  .kpiGrid{ grid-template-columns: 1fr;
}
}

.kpiWrap{
  position: relative;
  border-radius: 18px;
}
.kpiWrap::before{
  content: "";
  position: absolute;
  inset: -6px;
  border-radius: 22px;
  background: linear-gradient(90deg, var(--kpi-from), var(--kpi-to));
  filter: blur(10px);
  opacity: .22;
  transition: opacity .25s ease;
}
.kpiWrap:hover::before{ opacity: .42; }

/* PERF: pendant l'ouverture/fermeture du sidebar, on coupe les effets chers (blur/backdrop) */
.sidebar-animating .kpiWrap::before{ filter: none !important; opacity: 0 !important; }
.sidebar-animating .kpiCard{ box-shadow: 0 14px 40px rgba(2,6,23,.22) !important; }
.sidebar-animating .topbar{ backdrop-filter: none !important; }

.kpiCard{
  position: relative;
  border-radius: 18px;
  padding: 18px;
  color: rgba(255,255,255,.92);
  border: 1px solid rgba(255,255,255,.10);
  background:
    radial-gradient(900px 400px at 0% 0%, rgba(255,255,255,.06), transparent 45%),
    linear-gradient(180deg, #0b1220, #081226);
  box-shadow: 0 22px 70px rgba(2,6,23,.35);
  transform: translateZ(0);
  will-change: transform;
  overflow: hidden;
}

.kpiHeader{
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 14px;
}
.kpiHeaderLeft{
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 0;
}
.kpiIcon{
  width: 44px;
  height: 44px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  flex-shrink: 0;
}
.kpiIcon ion-icon{
  font-size: 22px;
  color: rgba(255,255,255,.92);
}

.kpiHeaderText{ min-width: 0; }
.kpiTitle{
  font-size: 18px;
  font-weight: 900;
  line-height: 1.15;
  background: linear-gradient(90deg, var(--kpi-from), var(--kpi-to));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}
.kpiSub{
  margin-top: 2px;
  font-size: 12px;
  color: rgba(255,255,255,.65);
}

.kpiPill{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(16,185,129,.10);
  border: 1px solid rgba(255,255,255,.10);
  flex-shrink: 0;
}
.kpiDot{
  width: 9px;
  height: 9px;
  border-radius: 999px;
  background: var(--kpi-from);
  animation: kpiPulse 1.2s ease-in-out infinite;
}
.kpiPillText{
  font-size: 12px;
  font-weight: 800;
  color: rgba(255,255,255,.88);
}
@keyframes kpiPulse{
  0%,100%{ transform: scale(1); opacity: .8; }
  50%{ transform: scale(1.35); opacity: 1; }
}

.kpiStats{
  display: grid;
  gap: 10px;
  margin-bottom: 14px;
}
.kpiStats.cols-2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
.kpiStats.cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }

.kpiStat{
  position: relative;
  border-radius: 14px;
  padding: 12px;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border: 1px solid rgba(255,255,255,.08);
  overflow: hidden;
}
.kpiStat::after{
  content:"";
  position:absolute;
  left:0;
  bottom:0;
  width:100%;
  height:4px;
  background: linear-gradient(90deg, var(--kpi-from), var(--kpi-to));
  opacity: .95;
}

.kpiValue{
  font-size: 20px;
  font-weight: 950;
  letter-spacing: .2px;
  color: #fff;
}
.kpiValue-1{ color: #7dd3fc;
}
.kpiValue-2{ color: #34d399; }

.kpiLabel{
  margin-top: 4px;
  font-size: 12px;
  color: rgba(255,255,255,.70);
  font-weight: 700;
}

.kpiProgressRow{
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: rgba(255,255,255,.70);
  margin-bottom: 6px;
}
.kpiBar{
  height: 8px;
  border-radius: 999px;
  overflow: hidden;
  background: rgba(255,255,255,.10);
}
.kpiBar > div{
  height: 100%;
  width: var(--kpi-pct, 0%);
  background: linear-gradient(90deg, var(--kpi-from), var(--kpi-to));
  border-radius: 999px;
  transform-origin: left;
  animation: kpiExpand .35s ease-out;
}
@keyframes kpiExpand{
  from{ transform: scaleX(.35); }
  to{ transform: scaleX(1); }
}

.kpiFooter{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-top: 14px;
}
.kpiChips{ display: flex; gap: 8px; }
.kpiChip{
  width: 36px;
  height: 36px;
  border-radius: 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size: 11px;
  font-weight: 900;
}
.kpiChipA{ background: linear-gradient(135deg, var(--kpi-from), #059669); }
.kpiChipB{ background: linear-gradient(135deg, var(--kpi-to), #0284c7);
}

button.kpiBtn{
  background: linear-gradient(90deg, var(--kpi-from), var(--kpi-to)) !important;
  border: 0 !important;
  color: #fff !important;
  padding: 10px 12px !important;
  border-radius: 12px !important;
  font-weight: 900 !important;
  box-shadow: 0 10px 26px rgba(2,6,23,.35);
}
button.kpiBtn:hover{ filter: brightness(1.06);
}

/* Sidebar: empêcher le underline global (a:hover) */
.sidebar a:hover{ text-decoration: none !important; }

/* Dashboard grids */
.kpiRow3{
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 14px;
}
.dashGrid3{
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 14px;
}


@media (max-width: 900px){
  .kpiRow3{ grid-template-columns: 1fr; }
}
@media (max-width: 720px){
  .dashGrid3{ grid-template-columns: 1fr; }
}

/* ✅ Date/heure à droite, avant username/rôle */
.topbarClock{
  text-align: right;
  line-height: 1.05;
  margin-right: 6px;
  white-space: nowrap;
}
.topbarClockDate{
  font-size: 12px;
  color: var(--muted);
  text-transform: capitalize; /* garde "Samedi" si besoin selon navigateur */
}
.topbarClockTime{
  font-size: 13px;
  font-weight: 900;
  letter-spacing: .2px;
}

/* ✅ Bloc user (remplace tes styles inline par du clean) */
.topbarUser{
  text-align: right;
  line-height: 1.1;
  margin-right: 6px;
}
.topbarUserName{
  font-weight: 800;
  font-size: 14px;
}
.topbarUserRole{
  font-size: 11px;
  color: var(--muted);
}

/* Optionnel: sur très petit écran on évite que ça casse */
@media (max-width: 520px){
  .topbarClockDate{ display: none;
}
}



────────────────── client/src/utils/api.js ──────────────────
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3001';

export function getApiUrl() {
  return API_URL;
}

async function parseResponse(res) {
  const text = await res.text();
  try {
    return text ? JSON.parse(text) : null;
  } catch (e) {
    return { raw: text, error: 'INVALID_JSON_RESPONSE' };
  }
}

/**
 * Petit helper : attend N ms
 */
function wait(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

export async function apiFetch(path, { token, method = 'GET', body, headers, retries = 2 } = {}) {
  const h = {
    'Content-Type': 'application/json',
    ...(headers || {})
  };

  if (token) {
    h.Authorization = `Bearer ${token}`;
  }

  const config = {
    method,
    headers: h,
    body: body ? JSON.stringify(body) : undefined
  };

  let lastError;

  for (let attempt = 0; attempt <= retries; attempt++) {
    try {
      const res = await fetch(`${API_URL}${path}`, config);
      const data = await parseResponse(res);

      if (!res.ok) {
        const msg = data?.message || data?.error || `Erreur HTTP ${res.status}`;
        const err = new Error(msg);
        err.status = res.status;
        err.payload = data;
        throw err;
      }

      return data;
    } catch (err) {
      lastError = err;
      // Si c'est une erreur réseau (serveur down/restart) ET qu'il reste des retries
      const isNetworkError = !err.status && (
        err.message?.includes('Failed to fetch') ||
        err.message?.includes('NetworkError') ||
        err.message?.includes('ERR_CONNECTION_REFUSED') ||
        err.message?.includes('Impossible de joindre')
      );
      if (isNetworkError && attempt < retries) {
        await wait(1000 * (attempt + 1)); // 1s, puis 2s
        continue;
      }
      // Si c'est une erreur HTTP (401, 403...) on ne retry pas
      throw err;
    }
  }

  throw lastError;
}

export async function apiUpload(path, { token, formData, method = 'POST' }) {
  const headers = {};
  if (token) {
    headers.Authorization = `Bearer ${token}`;
  }

  let res;
  try {
    res = await fetch(`${API_URL}${path}`, {
      method,
      headers,
      body: formData
    });
  } catch (networkErr) {
    throw new Error("Erreur réseau lors de l'upload.");
  }

  const data = await parseResponse(res);

  if (!res.ok) {
    const msg = data?.message || data?.error || `Upload échoué (${res.status})`;
    const err = new Error(msg);
    err.status = res.status;
    err.payload = data;
    throw err;
  }

  return data;
}


────────────────── client/src/main.jsx ──────────────────
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import App from './App.jsx';
import './styles.css';

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);


────────────────── client/src/pages/Dashboard.jsx ──────────────────
// client/src/pages/Dashboard.jsx
import React, { useCallback, useEffect, useMemo, useState, memo } from 'react';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  ArcElement,
  Tooltip,
  Legend,
  Filler,
  Title,
} from 'chart.js';

import { Line, Doughnut } from 'react-chartjs-2';

ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  ArcElement,
  Tooltip,
  Legend,
  Filler,
  Title
);

function toYMD(v) {
  if (!v) return '';
  const s = String(v);
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  if (/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.slice(0, 10);
  const d = new Date(v);
  if (!Number.isNaN(d.getTime())) return d.toLocaleDateString('fr-CA');
  return s;
}

function n0(v) {
  const x = Number(v);
  return Number.isFinite(x) ? x : 0;
}

function fmtMoneyAr(v) {
  return n0(v).toLocaleString('fr-FR');
}

function fmtLiters(v) {
  const x = n0(v);
  // garde 2 décimales mais sans forcer les zéros inutiles
  return x % 1 === 0 ? String(x) : x.toFixed(2);
}

function buildQs(from, to) {
  const qs = new URLSearchParams();
  if (from) qs.set('from', from);
  if (to) qs.set('to', to);
  return qs.toString();
}

function clampPct(v) {
  if (!Number.isFinite(v)) return 0;
  return Math.max(0, Math.min(100, v));
}

function pickPalette(i) {
  const palette = [
    { line: '#34d399', fill: 'rgba(52,211,153,.12)' }, // emerald
    { line: '#60a5fa', fill: 'rgba(96,165,250,.12)' }, // blue
    { line: '#f472b6', fill: 'rgba(244,114,182,.12)' }, // pink
    { line: '#fb923c', fill: 'rgba(251,146,60,.12)' },  // orange
    { line: '#a78bfa', fill: 'rgba(167,139,250,.12)' }, // violet
    { line: '#22d3ee', fill: 'rgba(34,211,238,.12)' },  // cyan
  ];
  return palette[i % palette.length];
}

function PremiumKpiCard({
  title,
  subtitle,
  montant,
  liters,
  refills,
  pct,
  accent = 'emerald',
  onOpen,
}) {
  const accentMap = {
    emerald: { a1: '#34d399', a2: '#22c55e' },
    orange: { a1: '#fb923c', a2: '#f97316' },
    violet: { a1: '#a78bfa', a2: '#8b5cf6' },
    blue: { a1: '#60a5fa', a2: '#3b82f6' },
  };
  const acc = accentMap[accent] || accentMap.emerald;

  return (
    <div
      className="kpiPremium"
      style={{
        background:
          'radial-gradient(1200px 700px at 10% 10%, rgba(255,255,255,.08), transparent 55%), ' +
          'linear-gradient(180deg, #0b1220, #070b14)',
        border: '1px solid rgba(255,255,255,.08)',
        borderRadius: 18,
        padding: 16,
        boxShadow: '0 24px 70px rgba(0,0,0,.28)',
        position: 'relative',
        overflow: 'hidden',
      }}
    >
      <div
        style={{
          position: 'absolute',
          inset: -1,
          background: `linear-gradient(90deg, ${acc.a1}, ${acc.a2})`,
          opacity: 0.08,
          filter: 'blur(18px)',
        }}
      />

      <div style={{ position: 'relative' }}>
        <div className="rowBetween" style={{ alignItems: 'center' }}>
          <div>
            <div style={{ fontWeight: 900, fontSize: 16, color: '#e5e7eb' }}>{title}</div>
            <div style={{ fontSize: 12, color: 'rgba(229,231,235,.65)', marginTop: 2 }}>
              {subtitle}
            </div>
          </div>

          <div
            style={{
              display: 'inline-flex',
              alignItems: 'center',
              gap: 8,
              padding: '6px 10px',
              borderRadius: 999,
              background: 'rgba(16,185,129,.10)',
              border: '1px solid rgba(16,185,129,.20)',
              color: '#a7f3d0',
              fontWeight: 800,
              fontSize: 12,
              whiteSpace: 'nowrap',
            }}
          >
            <span
              style={{
                width: 8,
                height: 8,
                borderRadius: 99,
                background: '#34d399',
                boxShadow: '0 0 0 4px rgba(52,211,153,.12)',
              }}
            />
            Active
          </div>
        </div>

        <div
          style={{
            marginTop: 14,
            display: 'grid',
            gridTemplateColumns: refills !== null && refills !== undefined ? 'repeat(3, minmax(0, 1fr))' : 'repeat(2, minmax(0, 1fr))',
            gap: 12,
          }}
        >
          <div
            style={{
              background: 'linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03))',
              border: '1px solid rgba(255,255,255,.08)',
              borderRadius: 14,
              padding: 12,
              position: 'relative',
              overflow: 'hidden',
            }}
          >
            <div style={{ color: 'rgba(229,231,235,.65)', fontSize: 12, fontWeight: 800 }}>Montant (Ar)</div>
            <div style={{ marginTop: 6, fontSize: 22, fontWeight: 900, color: '#fff' }}>
              {fmtMoneyAr(montant)} <span style={{ fontSize: 14, opacity: 0.75 }}>Ar</span>
            </div>
            <div
              style={{
                position: 'absolute',
                left: 0,
                bottom: 0,
                height: 3,
                width: '100%',
                background: `linear-gradient(90deg, ${acc.a1}, ${acc.a2})`,
                opacity: 0.9,
              }}
            />
          </div>

          <div
            style={{
              background: 'linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03))',
              border: '1px solid rgba(255,255,255,.08)',
              borderRadius: 14,
              padding: 12,
              position: 'relative',
              overflow: 'hidden',
            }}
          >
            <div style={{ color: 'rgba(229,231,235,.65)', fontSize: 12, fontWeight: 800 }}>Litres</div>
            <div style={{ marginTop: 6, fontSize: 22, fontWeight: 900, color: '#dbeafe' }}>
              {fmtLiters(liters)} <span style={{ fontSize: 14, opacity: 0.75 }}>L</span>
            </div>
            <div
              style={{
                position: 'absolute',
                left: 0,
                bottom: 0,
                height: 3,
                width: '100%',
                background: 'linear-gradient(90deg, #22d3ee, #60a5fa)',
                opacity: 0.9,
              }}
            />
          </div>

          {(refills !== null && refills !== undefined) && (
            <div
              style={{
                background: 'linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03))',
                border: '1px solid rgba(255,255,255,.08)',
                borderRadius: 14,
                padding: 12,
                position: 'relative',
                overflow: 'hidden',
              }}
            >
              <div style={{ color: 'rgba(229,231,235,.65)', fontSize: 12, fontWeight: 800 }}>Repleins</div>
              <div style={{ marginTop: 6, fontSize: 22, fontWeight: 900, color: '#bbf7d0' }}>
                {n0(refills)}
              </div>
              <div
                style={{
                  position: 'absolute',
                  left: 0,
                  bottom: 0,
                  height: 3,
                  width: '100%',
                  background: 'linear-gradient(90deg, #34d399, #22c55e)',
                  opacity: 0.9,
                }}
              />
            </div>
          )}
        </div>

        <div style={{ marginTop: 14 }}>
          <div className="rowBetween" style={{ marginBottom: 8 }}>
            <div style={{ color: 'rgba(229,231,235,.65)', fontSize: 12, fontWeight: 800 }}>
              Part du total (montant)
            </div>
            <div style={{ color: 'rgba(229,231,235,.80)', fontSize: 12, fontWeight: 900 }}>
              {clampPct(pct).toFixed(0)}%
            </div>
          </div>

          <div
            style={{
              height: 10,
              borderRadius: 999,
              background: 'rgba(255,255,255,.08)',
              border: '1px solid rgba(255,255,255,.10)',
              overflow: 'hidden',
            }}
          >
            <div
              style={{
                height: '100%',
                width: `${clampPct(pct)}%`,
                background: `linear-gradient(90deg, ${acc.a1}, ${acc.a2})`,
              }}
            />
          </div>
        </div>
        <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: 14 }}>

          <button
            onClick={onOpen}
            style={{
              padding: '10px 14px',
              borderRadius: 14,
              border: '1px solid rgba(255,255,255,.10)',
              background: `linear-gradient(90deg, ${acc.a1}, ${acc.a2})`,
              color: '#06101f',
              fontWeight: 900,
              cursor: 'pointer',
            }}
          >
            Ouvrir
          </button>
        </div>
      </div>
    </div>
  );
}

function ChartCard({ title, children, right }) {
  return (
    <div className="card" style={{ padding: 16 }}>
      <div className="rowBetween" style={{ marginBottom: 10 }}>
        <h3 style={{ margin: 0 }}>{title}</h3>
        {right || null}
      </div>
      <div style={{ height: 320 }}>
        {children}
      </div>
    </div>
  );
}

function Dashboard() {
  const { token } = useAuth();

  const [from, setFrom] = useState('');
  const [to, setTo] = useState('');

  const [vehicles, setVehicles] = useState([]);
  const [summary, setSummary] = useState(null);
  const [dailyTotal, setDailyTotal] = useState([]);
  const [byVehicle, setByVehicle] = useState([]);
  const [seriesByVehicleId, setSeriesByVehicleId] = useState({}); // { [id]: points[] }

  const [loading, setLoading] = useState(false);
  const [loadingSeries, setLoadingSeries] = useState(false);
  const [error, setError] = useState(null);

  // ✅ Charge la liste des véhicules
  useEffect(() => {
    apiFetch('/api/meta/vehicles', { token })
      .then((d) => setVehicles(d.vehicles || []))
      .catch(() => setVehicles([]));
  }, [token]);

  const vehicleList6 = useMemo(() => {
    const list = [...vehicles];
    list.sort((a, b) => String(a.plate || '').localeCompare(String(b.plate || '')));
    return list.slice(0, 6);
  }, [vehicles]);

    const loadSeries6 = useCallback(async (qs) => {
    // ✅ Séries individuelles pour 6 véhicules (1 seule requête backend)
    if (!vehicleList6.length) {
      setSeriesByVehicleId({});
      return;
    }

    setLoadingSeries(true);
    try {
      const ids = vehicleList6.map((v) => v.id).join(',');
      const bulk = await apiFetch(`/api/fuel/kpi/daily/bulk?${qs}&vehicle_ids=${encodeURIComponent(ids)}`, { token });
      const series = bulk?.series || {};

      const obj = {};
      for (const v of vehicleList6) {
        const pts = (series[v.id] || []).map((p) => ({
          log_date: toYMD(p.log_date),
          liters: n0(p.liters),
          montant_ar: n0(p.montant_ar),
          refills: n0(p.refills),
        }));
        obj[v.id] = pts;
      }

      setSeriesByVehicleId(obj);
    } catch (_) {
      setSeriesByVehicleId({});
    } finally {
      setLoadingSeries(false);
    }
  }, [token, vehicleList6]);

async function loadAll() {
    setLoading(true);
    setError(null);
    try {
      const qs = buildQs(from, to);

      const [sum, daily, top] = await Promise.all([
        apiFetch(`/api/fuel/report/summary?${qs}`, { token }),
        apiFetch(`/api/fuel/kpi/daily?${qs}`, { token }),
        apiFetch(`/api/fuel/kpi/by-vehicle?${qs}`, { token }),
      ]);

      setSummary(sum || null);

      const points = (daily.points || []).map((p) => ({
        log_date: toYMD(p.log_date),
        liters: n0(p.liters),
        montant_ar: n0(p.montant_ar),
        refills: n0(p.refills),
      }));
      setDailyTotal(points);

      const rows = (top.rows || []).map((r) => ({
        plate: r.plate,
        liters: n0(r.liters),
        montant_ar: n0(r.montant_ar),
        refills: n0(r.refills),
      }));
      setByVehicle(rows);

      await loadSeries6(qs);
    } catch (e) {
      setError(e?.message || 'Erreur de chargement');
    } finally {
      setLoading(false);
    }
  }

  // 1er chargement + recharge si la liste des véhicules arrive après
  useEffect(() => {
    loadAll();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    // ✅ Quand les véhicules sont chargés, on charge UNIQUEMENT les 6 séries (pas tout le dashboard)
    if (vehicles.length) {
      const qs = buildQs(from, to);
      loadSeries6(qs);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [vehicles.length]);

  const safeSummary = useMemo(() => {
    const s = summary || {};
    const vehicle = s.vehicle || {};
    const generator = s.generator || {};
    const other = s.other || {};
    return {
      vehicle: {
        montant_ar: n0(vehicle.montant_ar),
        liters: n0(vehicle.liters),
        refills: n0(vehicle.refills),
      },
      generator: {
        montant_ar: n0(generator.montant_ar),
        liters: n0(generator.liters),
      },
      other: {
        montant_ar: n0(other.montant_ar),
        liters: n0(other.liters),
      },
    };
  }, [summary]);

  const totals = useMemo(() => {
    const totalMontant =
      safeSummary.vehicle.montant_ar +
      safeSummary.generator.montant_ar +
      safeSummary.other.montant_ar;

    const totalLiters =
      safeSummary.vehicle.liters +
      safeSummary.generator.liters +
      safeSummary.other.liters;

    return { totalMontant, totalLiters };
  }, [safeSummary]);

  const pctVehicle = useMemo(() => {
    const t = totals.totalMontant || 1;
    return (safeSummary.vehicle.montant_ar / t) * 100;
  }, [safeSummary, totals]);

  const pctGenerator = useMemo(() => {
    const t = totals.totalMontant || 1;
    return (safeSummary.generator.montant_ar / t) * 100;
  }, [safeSummary, totals]);

  const pctOther = useMemo(() => {
    const t = totals.totalMontant || 1;
    return (safeSummary.other.montant_ar / t) * 100;
  }, [safeSummary, totals]);

  const baseLineOptions = useMemo(() => ({
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { position: 'top' },
      tooltip: { enabled: true },
      title: { display: false },
    },
    scales: {
      x: {
        ticks: { maxRotation: 45, minRotation: 45 },
        grid: { color: 'rgba(15,23,42,.06)' },
      },
      y: {
        grid: { color: 'rgba(15,23,42,.06)' },
        ticks: { callback: (v) => String(v) },
      },
    },
  }), []);

  // ===== Line double-axe : Total véhicules (Montant vs Litres)
  const totalVehicleChart = useMemo(() => {
    const labels = dailyTotal.map((p) => p.log_date);
    return {
      data: {
        labels,
        datasets: [
          {
            label: 'Montant véhicule (Ar)',
            data: dailyTotal.map((p) => p.montant_ar),
            borderColor: '#34d399',
            backgroundColor: 'rgba(52,211,153,.12)',
            tension: 0.35,
            fill: true,
            yAxisID: 'y',
            pointRadius: 0,
          },
          {
            label: 'Litres véhicule',
            data: dailyTotal.map((p) => p.liters),
            borderColor: '#60a5fa',
            backgroundColor: 'rgba(96,165,250,.10)',
            tension: 0.35,
            fill: false,
            yAxisID: 'y1',
            pointRadius: 0,
          },
        ],
      },
      options: {
        ...baseLineOptions,
        scales: {
          x: baseLineOptions.scales.x,
          y: {
            position: 'left',
            grid: { color: 'rgba(15,23,42,.06)' },
            ticks: {
              callback: (v) => String(v),
            },
          },
          y1: {
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: {
              callback: (v) => String(v),
            },
          },
        },
      },
    };
  }, [dailyTotal, baseLineOptions]);

  // ===== Doughnut Montant : Groupe vs Autres
  const doughnutMontant = useMemo(() => ({
    data: {
      labels: ['Groupe électrogène', 'Autres'],
      datasets: [
        {
          label: 'Montant (Ar)',
          data: [safeSummary.generator.montant_ar, safeSummary.other.montant_ar],
          backgroundColor: ['rgba(251,146,60,.75)', 'rgba(167,139,250,.75)'],
          borderColor: ['rgba(251,146,60,1)', 'rgba(167,139,250,1)'],
          borderWidth: 1,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
    animation: false,
      plugins: { legend: { position: 'bottom' } },
      cutout: '68%',
    },
  }), [safeSummary]);

  // ===== Doughnut Litres : Groupe vs Autres
  const doughnutLiters = useMemo(() => ({
    data: {
      labels: ['Groupe électrogène', 'Autres'],
      datasets: [
        {
          label: 'Litres',
          data: [safeSummary.generator.liters, safeSummary.other.liters],
          backgroundColor: ['rgba(34,211,238,.70)', 'rgba(96,165,250,.70)'],
          borderColor: ['rgba(34,211,238,1)', 'rgba(96,165,250,1)'],
          borderWidth: 1,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
    animation: false,
      plugins: { legend: { position: 'bottom' } },
      cutout: '68%',
    },
  }), [safeSummary]);

  // ===== Multi-axes : 6 véhicules (Montant) — 1 axe par véhicule (axes secondaires masqués)
  const multiVehicleChart = useMemo(() => {
    const ids = vehicleList6.map((v) => v.id);
    const allDates = new Set();
    for (const id of ids) {
      const pts = seriesByVehicleId[id] || [];
      for (const p of pts) allDates.add(p.log_date);
    }
    const labels = Array.from(allDates);
    labels.sort((a, b) => (a < b ? -1 : a > b ? 1 : 0));

    const scales = {
      x: {
        ticks: { maxRotation: 45, minRotation: 45 },
        grid: { color: 'rgba(15,23,42,.06)' },
      },
    };

    const datasets = vehicleList6.map((v, idx) => {
      const pts = seriesByVehicleId[v.id] || [];
      const map = new Map(pts.map((p) => [p.log_date, p.montant_ar]));
      const pal = pickPalette(idx);
      const axisId = `y_${v.id}`;

      // ✅ un axe par véhicule
      scales[axisId] = {
        position: idx % 2 === 0 ? 'left' : 'right',
        display: idx === 0, // n'affiche que le 1er axe (sinon trop chargé)
        grid: idx === 0 ? { color: 'rgba(15,23,42,.06)' } : { drawOnChartArea: false },
        ticks: idx === 0 ? { callback: (val) => String(val) } : { display: false },
      };

      return {
        label: v.plate || `Véhicule ${idx + 1}`,
        data: labels.map((d) => n0(map.get(d))),
        borderColor: pal.line,
        backgroundColor: pal.fill,
        tension: 0.35,
        fill: false,
        yAxisID: axisId,
        pointRadius: 0,
      };
    });

    return {
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
    animation: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'top' },
          tooltip: { enabled: true },
        },
        scales,
      },
    };
  }, [vehicleList6, seriesByVehicleId]);

  // ===== 6 charts individuels : (Montant + Litres en double axe)
  const perVehicleCharts = useMemo(() => {
    return vehicleList6.map((v, idx) => {
      const pts = seriesByVehicleId[v.id] || [];
      const labels = pts.map((p) => p.log_date);
      const pal = pickPalette(idx);

      return {
        key: v.id,
        plate: v.plate,
        data: {
          labels,
          datasets: [
            {
              label: 'Montant (Ar)',
              data: pts.map((p) => p.montant_ar),
              borderColor: pal.line,
              backgroundColor: pal.fill,
              tension: 0.35,
              fill: true,
              yAxisID: 'y',
              pointRadius: 0,
            },
            {
              label: 'Litres',
              data: pts.map((p) => p.liters),
              borderColor: '#60a5fa',
              backgroundColor: 'rgba(96,165,250,.10)',
              tension: 0.35,
              fill: false,
              yAxisID: 'y1',
              pointRadius: 0,
            },
          ],
        },
        options: {
          ...baseLineOptions,
          scales: {
            x: baseLineOptions.scales.x,
            y: {
              position: 'left',
              grid: { color: 'rgba(15,23,42,.06)' },
              ticks: { callback: (val) => String(val) },
            },
            y1: {
              position: 'right',
              grid: { drawOnChartArea: false },
              ticks: { callback: (val) => String(val) },
            },
          },
        },
      };
    });
  }, [vehicleList6, seriesByVehicleId, baseLineOptions]);

  return (
    <>
      <div className="rowBetween" style={{ alignItems: 'center' }}>
        <h2>Dashboard</h2>
        <div className="row" style={{ gap: 10 }}>
          <div className="field" style={{ minWidth: 180 }}>
            <label>Du</label>
            <input type="date" value={from} onChange={(e) => setFrom(e.target.value)} />
          </div>
          <div className="field" style={{ minWidth: 180 }}>
            <label>Au</label>
            <input type="date" value={to} onChange={(e) => setTo(e.target.value)} />
          </div>
          <div className="row" style={{ alignItems: 'end' }}>
            <button className="btn" onClick={loadAll} disabled={loading || loadingSeries}>
              {(loading || loadingSeries) ? 'Chargement...' : 'Actualiser'}
            </button>
          </div>
        </div>
      </div>

      {error && (
        <div className="notice" style={{ marginTop: 12, color: '#b91c1c' }}>
          {error}
        </div>
      )}

      {/* KPI cards premium */}
      <div
        className="kpiRow3"
        style={{
          marginTop: 14,
          display: 'grid',
          gridTemplateColumns: 'repeat(3, minmax(0, 1fr))',
          gap: 14,
        }}
      >
        <PremiumKpiCard
          title="Véhicules"
          subtitle="Suivi carburant"
          montant={safeSummary.vehicle.montant_ar}
          liters={safeSummary.vehicle.liters}
          refills={safeSummary.vehicle.refills}
          pct={pctVehicle}
          accent="emerald"
          onOpen={() => (window.location.href = '/app/fuel')}
        />

        <PremiumKpiCard
          title="Groupe électrogène"
          subtitle="Suivi carburant"
          montant={safeSummary.generator.montant_ar}
          liters={safeSummary.generator.liters}
          refills={null}
          pct={pctGenerator}
          accent="orange"
          onOpen={() => (window.location.href = '/app/fuel')}
        />

        <PremiumKpiCard
          title="Autres"
          subtitle="Suivi carburant"
          montant={safeSummary.other.montant_ar}
          liters={safeSummary.other.liters}
          refills={null}
          pct={pctOther}
          accent="violet"
          onOpen={() => (window.location.href = '/app/fuel')}
        />
      </div>

      {/* Charts zone */}
      <div
        style={{
          marginTop: 16,
          display: 'grid',
          gridTemplateColumns: '1.2fr .8fr',
          gap: 14,
          alignItems: 'start',
        }}
      >
        {/* Total véhicules double axe */}
        <ChartCard
          title="Véhicules — évolution par jour (total)"
          right={
            <span className="badge badge-info">
              {dailyTotal.length} jours
            </span>
          }
        >
          <Line data={totalVehicleChart.data} options={totalVehicleChart.options} />
        </ChartCard>

        {/* Right column: doughnuts + top table */}
        <div style={{ display: 'grid', gap: 14 }}>
          <ChartCard title="Groupe électrogène vs Autres — Montant (Ar)">
            <Doughnut data={doughnutMontant.data} options={doughnutMontant.options} />
          </ChartCard>

          <ChartCard title="Groupe électrogène vs Autres — Litres">
            <Doughnut data={doughnutLiters.data} options={doughnutLiters.options} />
          </ChartCard>

          <div className="card">
            <h3 style={{ marginBottom: 10 }}>Top véhicules (montant)</h3>
            <div style={{ overflowX: 'auto' }}>
              <table className="table" style={{ minWidth: 520 }}>
                <thead>
                  <tr>
                    <th>Véhicule</th>
                    <th>Montant</th>
                    <th>Litres</th>
                    <th>Repleins</th>
                  </tr>
                </thead>
                <tbody>
                  {byVehicle.slice(0, 10).map((r) => (
                    <tr key={r.plate}>
                      <td style={{ fontWeight: 900 }}>{r.plate}</td>
                      <td>{fmtMoneyAr(r.montant_ar)} Ar</td>
                      <td>{fmtLiters(r.liters)}</td>
                      <td>{r.refills}</td>
                    </tr>
                  ))}
                  {!byVehicle.length && (
                    <tr>
                      <td colSpan={4} style={{ padding: 14, color: '#6b7280' }}>
                        Aucune donnée
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

     

    

      {/* Responsive quick fix sans toucher styles.css */}
      <style>{`
        
        @media (max-width: 900px){
          .kpiRow3 { grid-template-columns: 200px !important; }
        }
        @media (max-width: 720px){
          .dashGrid3 { grid-template-columns: 200px !important; }
        }
      `}</style>
    </>
  );
}



export default memo(Dashboard);

────────────────── client/src/pages/CarRequestsManage.jsx ──────────────────
import React, { useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

export default function CarRequestsManage() {
  const { token, user } = useAuth();
  const role = user?.role;

  const [requests, setRequests] = useState([]);
  const [vehicles, setVehicles] = useState([]);
  const [drivers, setDrivers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const [viewId, setViewId] = useState(null);
  const [viewData, setViewData] = useState(null);
  const [viewLoading, setViewLoading] = useState(false);

  const [editId, setEditId] = useState(null);
  const [draft, setDraft] = useState(null);

  const [visa, setVisa] = useState(null); // {id, vehicle_id, driver_id}

  async function load() {
    setLoading(true);
    setError(null);
    try {
      const [r, v, d] = await Promise.all([
        apiFetch('/api/requests/car?status=SUBMITTED', { token }),
        apiFetch('/api/meta/vehicles', { token }),
        apiFetch('/api/meta/drivers', { token })
      ]);
      setRequests(r.requests || []);
      setVehicles(v.vehicles || []);
      setDrivers(d.drivers || []);
    } catch (e) {
      setError(e.message);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => { load(); }, []);

  const canManage = useMemo(() => ['LOGISTIQUE','ADMIN'].includes(role), [role]);

  async function openView(id) {
    setViewId(id);
    setViewLoading(true);
    try {
      const d = await apiFetch(`/api/requests/car/${id}`, { token });
      setViewData(d.request);
    } catch (e) {
      alert(e.message);
      setViewId(null);
      setViewData(null);
    } finally {
      setViewLoading(false);
    }
  }

  function openEdit(row) {
    setEditId(row.id);
    setDraft({
      proposed_date: row.proposed_date || '',
      objet: row.objet || '',
      itinerary: row.itinerary || '',
      people: row.people || '',
      depart_time_wanted: row.depart_time_wanted || '',
      return_time_expected: row.return_time_expected || '',
      vehicle_hint: row.vehicle_hint || '',
      driver_hint: row.driver_hint || ''
    });
  }

  async function saveEdit(id) {
    try {
      await apiFetch(`/api/requests/car/${id}`, { token, method: 'PUT', body: { ...draft } });
      setEditId(null);
      setDraft(null);
      await load();
    } catch (e) {
      alert(e.message);
    }
  }

  function cancelEdit() {
    setEditId(null);
    setDraft(null);
  }

  async function softDelete(id) {
    if (!confirm('Déplacer en Corbeille ?')) return;
    try {
      await apiFetch(`/api/requests/car/${id}`, { token, method: 'DELETE' });
      await load();
      alert('OK ✅ Déplacé dans Corbeille');
    } catch (e) {
      alert(e.message);
    }
  }

  function openVisa(row) {
    setVisa({
      id: row.id,
      vehicle_id: row.vehicle_id || '',
      driver_id: row.driver_id || ''
    });
  }

  async function doVisa() {
    if (!visa?.id) return;
    if (!visa.vehicle_id || !visa.driver_id) {
      alert('Choisis véhicule + chauffeur avant Visa.');
      return;
    }
    try {
      await apiFetch(`/api/requests/car/${visa.id}/visa`, { token, method: 'POST', body: { vehicle_id: visa.vehicle_id, driver_id: visa.driver_id } });
      setVisa(null);
      await load();
    } catch (e) {
      alert(e.message);
    }
  }

  async function reject(id) {
    const reason = prompt('Motif rejet (optionnel)') || null;
    try {
      await apiFetch(`/api/requests/car/${id}/reject`, { token, method: 'POST', body: { reason } });
      await load();
    } catch (e) {
      alert(e.message);
    }
  }

  async function printOne(id) {
    try {
      const d = await apiFetch(`/api/requests/car/${id}/print`, { token });
      window.open(d.url, '_blank');
    } catch (e) {
      alert(e.message);
    }
  }

  return (
    <div className="card">
      <h2>Validation voiture (Logistique/Admin)</h2>
      {error && <div className="alert">{error}</div>}
      {loading ? <div className="muted">Chargement...</div> : null}

      <table className="table">
        <thead>
          <tr>
            <th>N°</th>
            <th>Date proposée</th>
            <th>Objet</th>
            <th>Statut</th>
            <th style={{ width: 420 }}></th>
          </tr>
        </thead>
        <tbody>
          {requests.map((r) => {
            const editing = editId === r.id;
            return (
              <tr key={r.id}>
                <td>{r.request_no}</td>
                <td>
                  {editing ? (
                    <input className="input" type="date" value={draft.proposed_date} onChange={(e) => setDraft({ ...draft, proposed_date: e.target.value })} />
                  ) : r.proposed_date}
                </td>
                <td>
                  {editing ? (
                    <input className="input" value={draft.objet} onChange={(e) => setDraft({ ...draft, objet: e.target.value })} />
                  ) : (
                    <div style={{ maxWidth: 420, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{r.objet}</div>
                  )}
                </td>
                <td><span className="badge badge-info">{r.status}</span></td>
                <td style={{ whiteSpace: 'nowrap' }}>
                  <button className="btn btn-outline btn-sm" onClick={() => openView(r.id)}>Voir</button>
                  <span style={{ display: 'inline-block', width: 8 }} />

                  {editing ? (
                    <>
                      <button className="btn btn-sm" onClick={() => saveEdit(r.id)}>Valider</button>
                      <span style={{ display: 'inline-block', width: 8 }} />
                      <button className="btn btn-outline btn-sm" onClick={cancelEdit}>Annuler</button>
                    </>
                  ) : (
                    <button className="btn btn-outline btn-sm" onClick={() => openEdit(r)}>Modifier</button>
                  )}

                  <span style={{ display: 'inline-block', width: 8 }} />
                  <button className="btn btn-secondary btn-sm" onClick={() => printOne(r.id)}>Imprimer</button>

                  {canManage && !editing ? (
                    <>
                      <span style={{ display: 'inline-block', width: 8 }} />
                      <button className="btn btn-sm" onClick={() => openVisa(r)}>Visa Logistique</button>
                      <span style={{ display: 'inline-block', width: 8 }} />
                      <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Rejeter</button>
                      <span style={{ display: 'inline-block', width: 8 }} />
                      <button className="btn btn-danger btn-sm" onClick={() => softDelete(r.id)}>Supprimer</button>
                    </>
                  ) : null}
                </td>
              </tr>
            );
          })}
          {!requests.length && (
            <tr><td colSpan={5} className="muted">Aucune demande en attente.</td></tr>
          )}
        </tbody>
      </table>

      {viewId && (
        <Modal title="Détails demande voiture" onClose={() => { setViewId(null); setViewData(null); }} width={860}>
          {viewLoading ? (
            <div className="muted">Chargement...</div>
          ) : viewData ? (
            <div className="grid2">
              <div className="card">
                <div className="label">N°</div><div><b>{viewData.request_no}</b></div>
                <div className="label" style={{ marginTop: 10 }}>Date proposée</div><div>{viewData.proposed_date}</div>
                <div className="label" style={{ marginTop: 10 }}>Objet</div><div>{viewData.objet}</div>
                <div className="label" style={{ marginTop: 10 }}>Itinéraire</div><div>{viewData.itinerary || <span className="muted">—</span>}</div>
                <div className="label" style={{ marginTop: 10 }}>Personnes</div><div>{viewData.people || <span className="muted">—</span>}</div>
              </div>
              <div className="card">
                <div className="label">Heure départ</div><div>{viewData.depart_time_wanted || <span className="muted">—</span>}</div>
                <div className="label" style={{ marginTop: 10 }}>Heure retour</div><div>{viewData.return_time_expected || <span className="muted">—</span>}</div>
                <div className="label" style={{ marginTop: 10 }}>Hints</div>
                <div className="muted">Véhicule: {viewData.vehicle_hint || '—'} • Chauffeur: {viewData.driver_hint || '—'}</div>
                <div className="label" style={{ marginTop: 10 }}>Statut</div>
                <div><span className="badge">{viewData.status}</span></div>
              </div>
            </div>
          ) : <div className="muted">Aucune donnée</div>}
        </Modal>
      )}

      {visa && (
        <Modal title="Visa Logistique (assigner véhicule + chauffeur)" onClose={() => setVisa(null)} width={700}>
          <div className="form">
            <label>
              Véhicule
              <select value={visa.vehicle_id} onChange={(e) => setVisa({ ...visa, vehicle_id: e.target.value })}>
                <option value="">-- sélectionner --</option>
                {vehicles.map((v) => <option key={v.id} value={v.id}>{v.plate}</option>)}
              </select>
            </label>
            <label>
              Chauffeur
              <select value={visa.driver_id} onChange={(e) => setVisa({ ...visa, driver_id: e.target.value })}>
                <option value="">-- sélectionner --</option>
                {drivers.map((d) => <option key={d.id} value={d.id}>{d.full_name}</option>)}
              </select>
            </label>
            <div className="row">
              <button className="btn" onClick={doVisa}>Valider Visa</button>
              <button className="btn btn-outline" onClick={() => setVisa(null)}>Annuler</button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
}


────────────────── client/src/pages/CarRequests.jsx ──────────────────
import React, { useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

export default function CarRequests() {
  const { token, user } = useAuth();
  const role = user?.role;

  const [requests, setRequests] = useState([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);

  const [vehicles, setVehicles] = useState([]);
  const [drivers, setDrivers] = useState([]);

  const [form, setForm] = useState({
    proposed_date: new Date().toISOString().slice(0, 10),
    objet: '',
    itinerary: '',
    people: '',
    depart_time_wanted: '',
    return_time_expected: '',
    vehicle_hint: '',
    driver_hint: ''
  });
  const [creating, setCreating] = useState(false);

  const [view, setView] = useState(null); // {loading, data}
  const [editId, setEditId] = useState(null);
  const [draft, setDraft] = useState(null);

  const [visaModal, setVisaModal] = useState(null); // {id, vehicle_id, driver_id}

  const canCreate = role === 'DEMANDEUR';
  const canVisaLogistique = ['LOGISTIQUE', 'ADMIN'].includes(role);
  const canVisaRaf = ['RAF', 'ADMIN'].includes(role);
  const canSoftDelete = ['LOGISTIQUE', 'ADMIN'].includes(role);

  const columns = useMemo(() => ['N°', 'Date', 'Objet', 'Statut', 'Actions'], []);

  async function load() {
    setLoading(true);
    setErr(null);
    try {
      const d = await apiFetch('/api/requests/car', { token });
      setRequests(d.requests || []);
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setLoading(false);
    }
  }

  async function loadMeta() {
    try {
      const [v, dr] = await Promise.all([
        apiFetch('/api/meta/vehicles', { token }),
        apiFetch('/api/meta/drivers', { token })
      ]);
      setVehicles(v.vehicles || []);
      setDrivers(dr.drivers || []);
    } catch {
      // ignore
    }
  }

  useEffect(() => {
    load();
    loadMeta();
  }, []);

  const create = async () => {
    setCreating(true);
    setErr(null);
    try {
      await apiFetch('/api/requests/car', { method: 'POST', token, body: form });
      setForm({ proposed_date: new Date().toISOString().slice(0, 10), objet: '', itinerary: '', people: '', depart_time_wanted: '', return_time_expected: '', vehicle_hint: '', driver_hint: '' });
      await load();
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setCreating(false);
    }
  };

  const openView = async (id) => {
    setView({ loading: true, data: null });
    try {
      const d = await apiFetch(`/api/requests/car/${id}`, { token });
      setView({ loading: false, data: d.request });
    } catch (e) {
      setView({ loading: false, data: null });
      alert(String(e.message || e));
    }
  };

  const openEdit = (r) => {
    setEditId(r.id);
    setDraft({
      proposed_date: (r.proposed_date || '').slice(0, 10),
      objet: r.objet || '',
      itinerary: r.itinerary || '',
      people: r.people || '',
      depart_time_wanted: r.depart_time_wanted || '',
      return_time_expected: r.return_time_expected || '',
      vehicle_hint: r.vehicle_hint || '',
      driver_hint: r.driver_hint || ''
    });
  };

  const cancelEdit = () => {
    setEditId(null);
    setDraft(null);
  };

  const saveEdit = async () => {
    if (!editId || !draft) return;
    try {
      const body = {
        proposed_date: draft.proposed_date,
        objet: draft.objet,
        itinerary: draft.itinerary,
        people: draft.people,
        depart_time_wanted: draft.depart_time_wanted || null,
        return_time_expected: draft.return_time_expected || null,
        vehicle_hint: draft.vehicle_hint || null,
        driver_hint: draft.driver_hint || null
      };
      await apiFetch(`/api/requests/car/${editId}`, { method: 'PUT', token, body });
      cancelEdit();
      await load();
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const softDelete = async (r) => {
    if (!canSoftDelete) return;
    if (!confirm(`Déplacer dans Corbeille ?\n${r.request_no}`)) return;
    try {
      await apiFetch(`/api/requests/car/${r.id}`, { method: 'DELETE', token });
      await load();
      alert('OK: déplacé dans Corbeille ✅');
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const logisticsVisa = async (id, vehicle_id, driver_id) => {
    try {
      await apiFetch(`/api/requests/car/${id}/visa`, { method: 'POST', token, body: { vehicle_id: vehicle_id || null, driver_id: driver_id || null } });
      setVisaModal(null);
      await load();
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const rafApprove = async (id) => {
    try {
      await apiFetch(`/api/requests/car/${id}/approve`, { method: 'POST', token });
      await load();
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const reject = async (id) => {
    const reason = prompt('Motif rejet (optionnel)');
    try {
      await apiFetch(`/api/requests/car/${id}/reject`, { method: 'POST', token, body: { reason: reason || null } });
      await load();
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const canEditRow = (r) => {
    if (role === 'DEMANDEUR') return r.status === 'SUBMITTED';
    if (['ADMIN', 'LOGISTIQUE'].includes(role)) return r.status === 'SUBMITTED';
    return false;
  };

  return (
    <div>
      <h1 style={{ marginTop: 0 }}>Demandes voiture</h1>

      {err && <div className="muted" style={{ color: '#b91c1c' }}>{err}</div>}

      {canCreate && (
        <div className="card" style={{ marginBottom: 16 }}>
          <div style={{ fontWeight: 800, marginBottom: 10 }}>Nouvelle demande</div>
          <div className="grid2">
            <div className="field">
              <div className="label">Date proposée</div>
              <input className="input" type="date" value={form.proposed_date} onChange={(e) => setForm({ ...form, proposed_date: e.target.value })} />
            </div>
            <div className="field">
              <div className="label">Objet</div>
              <input className="input" value={form.objet} onChange={(e) => setForm({ ...form, objet: e.target.value })} placeholder="Objet..." />
            </div>
            <div className="field">
              <div className="label">Itinéraire</div>
              <textarea className="input" rows={3} value={form.itinerary} onChange={(e) => setForm({ ...form, itinerary: e.target.value })} placeholder="Départ → Arrivée..." />
            </div>
            <div className="field">
              <div className="label">Personnes transportées</div>
              <textarea className="input" rows={3} value={form.people} onChange={(e) => setForm({ ...form, people: e.target.value })} placeholder="Liste des personnes..." />
            </div>
            <div className="field">
              <div className="label">Heure départ souhaitée</div>
              <input className="input" type="time" value={form.depart_time_wanted} onChange={(e) => setForm({ ...form, depart_time_wanted: e.target.value })} />
            </div>
            <div className="field">
              <div className="label">Heure probable retour</div>
              <input className="input" type="time" value={form.return_time_expected} onChange={(e) => setForm({ ...form, return_time_expected: e.target.value })} />
            </div>
            <div className="field">
              <div className="label">Immatriculation (si connu)</div>
              <input className="input" value={form.vehicle_hint} onChange={(e) => setForm({ ...form, vehicle_hint: e.target.value })} placeholder="ex: 39961 WWT" />
            </div>
            <div className="field">
              <div className="label">Chauffeur (si connu)</div>
              <input className="input" value={form.driver_hint} onChange={(e) => setForm({ ...form, driver_hint: e.target.value })} placeholder="Nom chauffeur..." />
            </div>
          </div>
          <div style={{ marginTop: 10 }}>
            <button className="btn" onClick={create} disabled={creating}>Envoyer</button>
          </div>
        </div>
      )}

      <div style={{ overflow: 'auto' }}>
        <table className="table">
          <thead>
            <tr>
              {columns.map((c) => (<th key={c}>{c}</th>))}
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr><td colSpan={columns.length} className="muted">Chargement...</td></tr>
            ) : requests.length ? (
              requests.map((r) => {
                const editing = editId === r.id;
                return (
                  <tr key={r.id}>
                    <td><b>{r.request_no}</b></td>
                    <td>
                      {editing ? (
                        <input className="input" type="date" value={draft?.proposed_date || ''} onChange={(e) => setDraft({ ...draft, proposed_date: e.target.value })} />
                      ) : (
                        String(r.proposed_date || '')
                      )}
                    </td>
                    <td>
                      {editing ? (
                        <input className="input" value={draft?.objet || ''} onChange={(e) => setDraft({ ...draft, objet: e.target.value })} />
                      ) : (
                        <span>{r.objet}</span>
                      )}
                    </td>
                    <td><span className="badge badge-ok">{r.status}</span></td>
                    <td style={{ whiteSpace: 'nowrap' }}>
                      <button className="btn btn-outline btn-sm" onClick={() => openView(r.id)}>Voir</button>
                      <span style={{ display: 'inline-block', width: 8 }} />

                      {editing ? (
                        <>
                          <button className="btn btn-sm" onClick={saveEdit}>Valider</button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                          <button className="btn btn-outline btn-sm" onClick={cancelEdit}>Annuler</button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                        </>
                      ) : (
                        canEditRow(r) && (
                          <>
                            <button className="btn btn-outline btn-sm" onClick={() => openEdit(r)}>Modifier</button>
                            <span style={{ display: 'inline-block', width: 8 }} />
                          </>
                        )
                      )}

                      <a className="btn btn-outline btn-sm" href={`/print/car/${r.id}`} target="_blank" rel="noreferrer">Imprimer</a>
                      <span style={{ display: 'inline-block', width: 8 }} />

                      {canVisaLogistique && r.status === 'SUBMITTED' && (
                        <>
                          <button
                            className="btn btn-sm"
                            onClick={() => setVisaModal({ id: r.id, vehicle_id: r.vehicle_id || '', driver_id: r.driver_id || '' })}
                          >
                            Visa logistique
                          </button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                        </>
                      )}

                      {canVisaRaf && r.status === 'LOGISTICS_APPROVED' && (
                        <>
                          <button className="btn btn-sm" onClick={() => rafApprove(r.id)}>Visa RAF</button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                        </>
                      )}

                      {canVisaLogistique && r.status === 'SUBMITTED' && (
                        <>
                          <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Non-valider</button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                        </>
                      )}

                      {canVisaRaf && r.status === 'LOGISTICS_APPROVED' && (
                        <>
                          <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Non-valider</button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                        </>
                      )}

                      {canSoftDelete && (
                        <button className="btn btn-danger btn-sm" onClick={() => softDelete(r)}>Corbeille</button>
                      )}
                    </td>
                  </tr>
                );
              })
            ) : (
              <tr><td colSpan={columns.length} className="muted">Aucune demande.</td></tr>
            )}
          </tbody>
        </table>
      </div>

      {view && (
        <Modal title={view.loading ? 'Chargement...' : `Détails ${view.data?.request_no || ''}`} onClose={() => setView(null)} width={720}>
          {view.loading ? (
            <div className="muted">Chargement...</div>
          ) : view.data ? (
            <div>
              <div className="grid2">
                <div className="card">
                  <div className="muted">Date proposée</div>
                  <div style={{ fontWeight: 800 }}>{String(view.data.proposed_date || '')}</div>
                </div>
                <div className="card">
                  <div className="muted">Statut</div>
                  <div style={{ fontWeight: 800 }}>{String(view.data.status || '')}</div>
                </div>
              </div>
              <div className="card" style={{ marginTop: 10 }}>
                <div className="muted">Objet</div>
                <div style={{ fontWeight: 700 }}>{view.data.objet}</div>
                <hr />
                <div className="muted">Itinéraire</div>
                <div>{view.data.itinerary}</div>
                <hr />
                <div className="muted">Personnes transportées</div>
                <div>{view.data.people}</div>
                <hr />
                <div className="row" style={{ gap: 10 }}>
                  <div className="card" style={{ flex: 1 }}>
                    <div className="muted">Départ souhaité</div>
                    <div style={{ fontWeight: 800 }}>{String(view.data.depart_time_wanted || '')}</div>
                  </div>
                  <div className="card" style={{ flex: 1 }}>
                    <div className="muted">Retour probable</div>
                    <div style={{ fontWeight: 800 }}>{String(view.data.return_time_expected || '')}</div>
                  </div>
                </div>
                <hr />
                <div className="row" style={{ gap: 10 }}>
                  <div className="card" style={{ flex: 1 }}>
                    <div className="muted">Véhicule (hint)</div>
                    <div style={{ fontWeight: 800 }}>{String(view.data.vehicle_hint || '')}</div>
                  </div>
                  <div className="card" style={{ flex: 1 }}>
                    <div className="muted">Chauffeur (hint)</div>
                    <div style={{ fontWeight: 800 }}>{String(view.data.driver_hint || '')}</div>
                  </div>
                </div>
              </div>
              <div className="row" style={{ justifyContent: 'flex-end', marginTop: 10 }}>
                <a className="btn" href={`/print/car/${view.data.id}`} target="_blank" rel="noreferrer">Imprimer</a>
              </div>
            </div>
          ) : (
            <div className="muted">Impossible de charger ce détail.</div>
          )}
        </Modal>
      )}

      {visaModal && (
        <Modal title="Visa logistique" onClose={() => setVisaModal(null)} width={640}>
          <div className="muted" style={{ marginBottom: 8 }}>
            Optionnel: tu peux assigner un véhicule + chauffeur au moment du visa.
          </div>
          <div className="grid2">
            <div className="field">
              <div className="label">Véhicule</div>
              <select className="input" value={visaModal.vehicle_id} onChange={(e) => setVisaModal({ ...visaModal, vehicle_id: e.target.value })}>
                <option value="">(aucun)</option>
                {vehicles.map((v) => (
                  <option key={v.id} value={v.id}>{v.plate} {v.label ? `— ${v.label}` : ''}</option>
                ))}
              </select>
            </div>
            <div className="field">
              <div className="label">Chauffeur</div>
              <select className="input" value={visaModal.driver_id} onChange={(e) => setVisaModal({ ...visaModal, driver_id: e.target.value })}>
                <option value="">(aucun)</option>
                {drivers.map((d) => (
                  <option key={d.id} value={d.id}>{d.full_name} {d.phone ? `— ${d.phone}` : ''}</option>
                ))}
              </select>
            </div>
          </div>

          <div className="row" style={{ justifyContent: 'flex-end', marginTop: 12 }}>
            <button className="btn btn-outline" onClick={() => setVisaModal(null)}>Annuler</button>
            <button className="btn" onClick={() => logisticsVisa(visaModal.id, visaModal.vehicle_id, visaModal.driver_id)}>Valider visa</button>
          </div>
        </Modal>
      )}
    </div>
  );
}

────────────────── client/src/pages/CalendarView.jsx ──────────────────
import React, { useEffect, useState, useMemo } from 'react';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';
import Modal from '../components/Modal.jsx';

export default function CalendarView() {
  const { token } = useAuth();
  const [requests, setRequests] = useState([]);
  const [loading, setLoading] = useState(true);
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(null);
  const [viewModal, setViewModal] = useState(null);

  // ✅ Filtre statut (UI)
  const [statusFilter, setStatusFilter] = useState('ALL');

  useEffect(() => {
    loadRequests();
  }, []);

  async function loadRequests() {
    setLoading(true);
    try {
      const data = await apiFetch('/api/requests/car', { token });
      setRequests(data.requests || []);
    } catch (e) {
      console.error('Failed to load requests:', e);
    } finally {
      setLoading(false);
    }
  }

  const STATUS_OPTIONS = useMemo(
    () => [
      { value: 'ALL', label: 'Tous' },
      { value: 'SUBMITTED', label: 'Soumis' },
      { value: 'APPROVED', label: 'Approuvé (tous)' },
      { value: 'LOGISTICS_APPROVED', label: 'Visa Logistique' },
      { value: 'RAF_APPROVED', label: 'Visa RAF (Approuvé)' },
      { value: 'REJECTED', label: 'Rejeté' },
    ],
    []
  );

  const filterRequestsByStatus = (list) => {
    if (statusFilter === 'ALL') return list;
    if (statusFilter === 'APPROVED') {
      return list.filter((r) => ['LOGISTICS_APPROVED', 'RAF_APPROVED'].includes(r.status));
    }
    return list.filter((r) => r.status === statusFilter);
  };

  // ✅ Normalisation date (robuste si proposed_date contient une heure)
  const normalizedRequests = useMemo(() => {
    return (requests || []).map((r) => ({
      ...r,
      _dateKey: String(r.proposed_date || '').slice(0, 10),
    }));
  }, [requests]);

  // ✅ Appliquer le filtre
  const filteredRequests = useMemo(() => {
    return filterRequestsByStatus(normalizedRequests).filter((r) => r._dateKey);
  }, [normalizedRequests, statusFilter]);

  // ✅ Grouper les demandes par date (sur la liste filtrée)
  const requestsByDate = useMemo(() => {
    const map = {};
    filteredRequests.forEach((req) => {
      const date = req._dateKey;
      if (!map[date]) map[date] = [];
      map[date].push(req);
    });
    return map;
  }, [filteredRequests]);

  // ✅ Générer les jours du mois (avec padding fin de mois pour une grille propre)
  const calendarDays = useMemo(() => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay(); // 0 = Dimanche
    const daysInMonth = lastDay.getDate();

    const days = [];

    // Jours du mois précédent (padding)
    for (let i = 0; i < startDay; i++) {
      days.push({ date: null, isCurrentMonth: false });
    }

    // Jours du mois actuel
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      days.push({ date: dateStr, isCurrentMonth: true });
    }

    // Padding fin de mois pour compléter la dernière semaine
    const remainder = days.length % 7;
    if (remainder !== 0) {
      const toAdd = 7 - remainder;
      for (let i = 0; i < toAdd; i++) {
        days.push({ date: null, isCurrentMonth: false });
      }
    }

    return days;
  }, [currentMonth]);

  const changeMonth = (offset) => {
    const newDate = new Date(currentMonth);
    newDate.setMonth(newDate.getMonth() + offset);
    setCurrentMonth(newDate);
  };

  const openDayModal = (dateStr) => {
    setSelectedDate(dateStr);
  };

  const openViewModal = async (id) => {
    setViewModal({ loading: true, data: null });
    try {
      const d = await apiFetch(`/api/requests/car/${id}`, { token });
      setViewModal({ loading: false, data: d.request });
    } catch (e) {
      alert(e.message);
      setViewModal(null);
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'SUBMITTED':
        return '#f59e0b';
      case 'LOGISTICS_APPROVED':
        return '#3b82f6';
      case 'RAF_APPROVED':
        return '#10b981';
      case 'REJECTED':
        return '#ef4444';
      default:
        return '#6b7280';
    }
  };

  const todayStr = new Date().toISOString().slice(0, 10);

  return (
    <div>
      <div className="row" style={{ justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 }}>
        <h1 style={{ margin: 0 }}>📅 Calendrier Demandes Voiture</h1>
        <div className="row" style={{ gap: 8 }}>
          <button className="btn btn-outline" onClick={() => changeMonth(-1)}>
            ← Mois précédent
          </button>
          <button className="btn btn-outline" onClick={() => setCurrentMonth(new Date())}>
            Aujourd'hui
          </button>
          <button className="btn btn-outline" onClick={() => changeMonth(1)}>
            Mois suivant →
          </button>
        </div>
      </div>

      {/* ✅ Filtre statut + infos */}
      <div className="card" style={{ marginBottom: 14 }}>
        <div className="rowBetween" style={{ gap: 12, flexWrap: 'wrap' }}>
          <div className="row" style={{ gap: 10, alignItems: 'center', flexWrap: 'wrap' }}>
            <div style={{ fontWeight: 800 }}>Filtrer par statut :</div>
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value)}
              style={{ padding: '8px 10px', borderRadius: 10, border: '1px solid rgba(15,23,42,.16)' }}
            >
              {STATUS_OPTIONS.map((o) => (
                <option key={o.value} value={o.value}>
                  {o.label}
                </option>
              ))}
            </select>

            <div className="muted" style={{ fontSize: 13 }}>
              Affichées: <b>{filteredRequests.length}</b> / Total: <b>{requests.length}</b>
            </div>
          </div>

          <button className="btn btn-secondary btn-sm" onClick={loadRequests}>
            🔄 Rafraîchir
          </button>
        </div>
      </div>

      {/* En-tête mois/année */}
      <div style={{ textAlign: 'center', marginBottom: 16, fontSize: '20px', fontWeight: '700' }}>
        {currentMonth
          .toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })
          .replace(/^\w/, (c) => c.toUpperCase())}
      </div>

      {loading ? (
        <div style={{ textAlign: 'center', padding: 40, color: '#6b7280' }}>Chargement...</div>
      ) : (
        <div className="card" style={{ padding: 0, overflow: 'hidden' }}>
          {/* Grille calendrier */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: 1, background: '#e5e7eb' }}>
            {/* En-têtes jours */}
            {['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'].map((day) => (
              <div
                key={day}
                style={{
                  background: '#f9fafb',
                  padding: '8px',
                  textAlign: 'center',
                  fontWeight: '700',
                  fontSize: '12px',
                }}
              >
                {day}
              </div>
            ))}

            {/* Jours du mois */}
            {calendarDays.map((day, idx) => {
              if (!day.isCurrentMonth || !day.date) {
                return <div key={idx} style={{ background: '#fafafa', minHeight: 110 }} />;
              }

              const dayRequests = requestsByDate[day.date] || [];
              const dayNumber = parseInt(day.date.split('-')[2], 10);
              const isToday = day.date === todayStr;

              return (
                <div
                  key={idx}
                  style={{
                    background: 'white',
                    minHeight: 110,
                    padding: '8px',
                    cursor: dayRequests.length > 0 ? 'pointer' : 'default',
                    border: isToday ? '2px solid #3b82f6' : 'none',
                    position: 'relative',
                  }}
                  onClick={() => dayRequests.length > 0 && openDayModal(day.date)}
                >
                  {/* Numéro du jour */}
                  <div style={{ fontWeight: '700', fontSize: '14px', marginBottom: 6, color: isToday ? '#3b82f6' : '#111827' }}>
                    {dayNumber}
                  </div>

                  {/* ✅ Badge compteur total (même si <= 3) */}
                  {dayRequests.length > 0 && (
                    <div
                      title="Nombre total de demandes"
                      style={{
                        position: 'absolute',
                        top: 8,
                        right: 8,
                        background: 'rgba(15,23,42,.85)',
                        color: '#fff',
                        fontSize: 11,
                        fontWeight: 800,
                        padding: '3px 7px',
                        borderRadius: 999,
                        lineHeight: 1.2,
                      }}
                      onClick={(e) => {
                        e.stopPropagation();
                        openDayModal(day.date);
                      }}
                    >
                      {dayRequests.length}
                    </div>
                  )}

                  {/* ✅ Demandes (clic direct sur badge -> détail) */}
                  {dayRequests.slice(0, 3).map((req) => (
                    <div
                      key={req.id}
                      style={{
                        background: getStatusColor(req.status),
                        color: 'white',
                        padding: '2px 6px',
                        borderRadius: '4px',
                        fontSize: '10px',
                        marginBottom: 2,
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: 'nowrap',
                        cursor: 'pointer',
                      }}
                      title={`${req.request_no} — ${req.objet || ''}`}
                      onClick={(e) => {
                        e.stopPropagation();
                        openViewModal(req.id);
                      }}
                    >
                      {req.request_no}
                    </div>
                  ))}

                  {/* Indication si plus de 3 */}
                  {dayRequests.length > 3 && (
                    <div
                      style={{ fontSize: '10px', color: '#6b7280', marginTop: 3, textDecoration: 'underline', cursor: 'pointer' }}
                      onClick={(e) => {
                        e.stopPropagation();
                        openDayModal(day.date);
                      }}
                    >
                      +{dayRequests.length - 3} autre(s)
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Légende */}
      <div className="card" style={{ marginTop: 16 }}>
        <div style={{ fontWeight: '700', marginBottom: 8 }}>Légende</div>
        <div className="row" style={{ gap: 16, flexWrap: 'wrap' }}>
          <div className="row" style={{ gap: 6 }}>
            <div style={{ width: 16, height: 16, background: '#f59e0b', borderRadius: 4 }} />
            <span style={{ fontSize: 12 }}>Soumis</span>
          </div>
          <div className="row" style={{ gap: 6 }}>
            <div style={{ width: 16, height: 16, background: '#3b82f6', borderRadius: 4 }} />
            <span style={{ fontSize: 12 }}>Visa Logistique</span>
          </div>
          <div className="row" style={{ gap: 6 }}>
            <div style={{ width: 16, height: 16, background: '#10b981', borderRadius: 4 }} />
            <span style={{ fontSize: 12 }}>Visa RAF (Approuvé)</span>
          </div>
          <div className="row" style={{ gap: 6 }}>
            <div style={{ width: 16, height: 16, background: '#ef4444', borderRadius: 4 }} />
            <span style={{ fontSize: 12 }}>Rejeté</span>
          </div>
        </div>
      </div>

      {/* Modal jour sélectionné */}
      {selectedDate && (
        <Modal
          title={`Demandes du ${new Date(selectedDate + 'T00:00:00').toLocaleDateString('fr-FR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
          })}`}
          onClose={() => setSelectedDate(null)}
          width={700}
        >
          <div>
            {(requestsByDate[selectedDate] || []).length === 0 ? (
              <div className="muted" style={{ padding: 10 }}>
                Aucune demande pour ce jour (selon le filtre).
              </div>
            ) : (
              (requestsByDate[selectedDate] || []).map((req) => (
                <div
                  key={req.id}
                  className="card"
                  style={{ marginBottom: 12, cursor: 'pointer' }}
                  onClick={() => openViewModal(req.id)}
                >
                  <div className="row" style={{ justifyContent: 'space-between', alignItems: 'center' }}>
                    <div>
                      <div style={{ fontWeight: '700' }}>{req.request_no}</div>
                      <div style={{ fontSize: 13, color: '#6b7280', marginTop: 4 }}>{req.objet}</div>
                    </div>

                    {/* ✅ Badge cliquable (ouvre détail) */}
                    <span
                      className="badge"
                      style={{ background: getStatusColor(req.status), color: 'white', border: 'none', cursor: 'pointer' }}
                      onClick={(e) => {
                        e.stopPropagation();
                        openViewModal(req.id);
                      }}
                      title="Cliquer pour ouvrir le détail"
                    >
                      {req.status}
                    </span>
                  </div>
                </div>
              ))
            )}
          </div>
        </Modal>
      )}

      {/* Modal détails demande */}
      {viewModal && (
        <Modal
          title={viewModal.loading ? 'Chargement...' : `Détails ${viewModal.data?.request_no || ''}`}
          onClose={() => setViewModal(null)}
          width={720}
        >
          {viewModal.loading ? (
            <div className="muted">Chargement...</div>
          ) : viewModal.data ? (
            <div>
              <div className="grid2">
                <div className="card">
                  <div className="muted">Date proposée</div>
                  <div style={{ fontWeight: 800 }}>{String(viewModal.data.proposed_date || '').slice(0, 10)}</div>
                </div>
                <div className="card">
                  <div className="muted">Statut</div>
                  <div style={{ fontWeight: 800 }}>{String(viewModal.data.status || '')}</div>
                </div>
              </div>
              <div className="card" style={{ marginTop: 10 }}>
                <div className="muted">Objet</div>
                <div style={{ fontWeight: 700 }}>{viewModal.data.objet}</div>
                <hr />
                <div className="muted">Itinéraire</div>
                <div>{viewModal.data.itinerary}</div>
                <hr />
                <div className="muted">Personnes transportées</div>
                <div>{viewModal.data.people}</div>
              </div>
            </div>
          ) : (
            <div className="muted">Impossible de charger ce détail.</div>
          )}
        </Modal>
      )}
    </div>
  );
}


────────────────── client/src/components/FloatingLines.css ──────────────────
.floating-lines-container {
  position: relative;
  inset: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  z-index: 0;
}

.floating-lines-container canvas {
  display: block;
}


────────────────── client/src/components/GlowStatCard.jsx ──────────────────
import React from "react";
import "./GlowStatCard.css";

const toneMap = {
  emerald: {
    from: "#10b981",
    to: "#0ea5e9",
    value: "#34d399",
    badgeBg: "rgba(16,185,129,.12)",
    badgeText: "#34d399",
    dot: "#10b981",
  },
  sky: {
    from: "#0ea5e9",
    to: "#10b981",
    value: "#38bdf8",
    badgeBg: "rgba(14,165,233,.12)",
    badgeText: "#38bdf8",
    dot: "#0ea5e9",
  },
  violet: {
    from: "#8b5cf6",
    to: "#0ea5e9",
    value: "#a78bfa",
    badgeBg: "rgba(139,92,246,.12)",
    badgeText: "#a78bfa",
    dot: "#8b5cf6",
  },
};

export default function GlowStatCard({
  title,
  subtitle,
  badgeLabel = "Actif",
  tone = "emerald",
  stats = [], // [{ label, value, tone? }]
  className = "",
}) {
  const t = toneMap[tone] || toneMap.emerald;

  return (
    <div className={`gscWrap ${className}`}>
      <div
        className="gscGlow"
        style={{
          background: `linear-gradient(90deg, ${t.from}, ${t.to})`,
        }}
      />
      <div className="gscCard">
        <div className="gscHeader">
          <div className="gscTitleBlock">
            <div
              className="gscTitle"
              style={{
                backgroundImage: `linear-gradient(90deg, ${t.from}, ${t.to})`,
              }}
            >
              {title}
            </div>
            {subtitle ? <div className="gscSubtitle">{subtitle}</div> : null}
          </div>

          <div
            className="gscBadge"
            style={{
              background: t.badgeBg,
              color: t.badgeText,
            }}
          >
            <span
              className="gscDot"
              style={{ background: t.dot }}
              aria-hidden="true"
            />
            <span className="gscBadgeText">{badgeLabel}</span>
          </div>
        </div>

        <div
          className="gscGrid"
          style={{
            gridTemplateColumns: `repeat(${Math.min(
              Math.max(stats.length, 1),
              3
            )}, minmax(0, 1fr))`,
          }}
        >
          {stats.map((s, idx) => {
            const st = toneMap[s.tone] || t;
            return (
              <div
                key={`${s.label}-${idx}`}
                className="gscStat"
                style={{
                  ["--statValue"]: st.value,
                  ["--statFrom"]: st.from,
                  ["--statTo"]: st.to,
                }}
              >
                <div className="gscStatValue">{s.value}</div>
                <div className="gscStatLabel">{s.label}</div>
                <div className="gscStatBar" />
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}


────────────────── client/src/components/Modal.jsx ──────────────────
import React, { useEffect, useRef } from 'react';

export default function Modal({ title, children, onClose, width = 720 }) {
  const closeBtnRef = useRef(null);

  useEffect(() => {
    const onKeyDown = (e) => {
      if (e.key === 'Escape') onClose?.();
    };
    document.addEventListener('keydown', onKeyDown);
    // focus close btn by default
    closeBtnRef.current?.focus?.();
    return () => document.removeEventListener('keydown', onKeyDown);
  }, [onClose]);

  return (
    <div className="modalOverlay" onMouseDown={onClose} role="presentation">
      <div
        className="modal"
        style={{ width }}
        role="dialog"
        aria-modal="true"
        aria-label={title || 'Dialog'}
        onMouseDown={(e) => e.stopPropagation()}
      >
        <div className="modalHeader">
          <div className="modalTitle">{title}</div>
          <button ref={closeBtnRef} className="btn btn-outline btn-sm" onClick={onClose} aria-label="Fermer">
            Fermer
          </button>
        </div>
        <div className="modalBody">{children}</div>
      </div>
    </div>
  );
}


────────────────── client/src/components/ToastContext.jsx ──────────────────
import React, { createContext, useContext, useState, useCallback } from 'react';

const ToastContext = createContext(null);

export function ToastProvider({ children }) {
  const [toasts, setToasts] = useState([]);

  const addToast = useCallback((message, type = 'info') => {
    const id = Date.now();
    setToasts((prev) => [...prev, { id, message, type }]);
    setTimeout(() => {
      setToasts((prev) => prev.filter((t) => t.id !== id));
    }, 4000);
  }, []);

  const removeToast = (id) => {
    setToasts((prev) => prev.filter((t) => t.id !== id));
  };

  return (
    <ToastContext.Provider value={{ addToast }}>
      {children}
      <div style={{
        position: 'fixed', bottom: '24px', right: '24px', zIndex: 9999,
        display: 'flex', flexDirection: 'column', gap: '12px'
      }}>
        {toasts.map((t) => (
          <div key={t.id} onClick={() => removeToast(t.id)} style={{
            minWidth: '300px',
            padding: '16px 20px',
            borderRadius: '12px',
            background: 'white',
            boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)',
            borderLeft: `6px solid ${
              t.type === 'success' ? '#10b981' : 
              t.type === 'error' ? '#ef4444' : 
              '#3b82f6'
            }`,
            display: 'flex', justifyContent: 'space-between', alignItems: 'center',
            animation: 'slideInRight 0.3s ease-out',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '500',
            color: '#1e293b'
          }}>
            <span>{t.message}</span>
            <span style={{ marginLeft: '12px', opacity: 0.5 }}>✕</span>
          </div>
        ))}
      </div>
      <style>{`
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `}</style>
    </ToastContext.Provider>
  );
}

export function useToast() {
  return useContext(ToastContext);
}

────────────────── client/src/components/ProtectedRoute.jsx ──────────────────
import React from 'react';
import { Navigate } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';

export default function ProtectedRoute({ children, roles }) {
  const { user, loading } = useAuth();
  if (loading) return <div className="container"><div className="card">Chargement...</div></div>;
  if (!user) return <Navigate to="/login" replace />;
  if (roles && !roles.includes(user.role)) return <Navigate to="/" replace />;
  return children;
}


────────────────── client/src/components/NotificationBell.jsx ──────────────────
import React, { useEffect, useMemo, useRef, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

function severityToDot(sev) {
  if (sev === 'error') return 'var(--danger)';
  if (sev === 'warning') return 'var(--warning)';
  if (sev === 'success') return 'var(--success)';
  if (sev === 'info') return 'var(--accent)';
  return 'rgba(255,255,255,.55)';
}

function formatTimestamp(ts) {
  if (!ts) return '';
  const date = new Date(ts);
  const now = new Date();
  const diff = now - date;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);

  if (minutes < 1) return "À l'instant";
  if (minutes < 60) return `Il y a ${minutes} min`;
  if (hours < 24) return `Il y a ${hours}h`;
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
}

export default function NotificationBell() {
  const { token } = useAuth();
  const navigate = useNavigate();

  const [notifications, setNotifications] = useState([]);
  const [unread, setUnread] = useState(0);
  const [open, setOpen] = useState(false);

  const [toasts, setToasts] = useState([]);
  const prevCountRef = useRef(0);
  const dropdownRef = useRef(null);

  async function fetchNotifications() {
    if (!token) return;
    try {
      const data = await apiFetch('/api/notifications', { token });
      const newNotifs = data.notifications || [];
      const newCount = Number(data.count || 0);

      setNotifications(newNotifs);
      setUnread(newCount);

      // toast quand ça augmente (sauf au tout premier load)
      const prev = prevCountRef.current;
      if (prev > 0 && newCount > prev) {
        const delta = newCount - prev;
        pushToast({
          title: 'Nouvelle notification',
          message: `🔔 ${delta} nouvelle(s) notification(s)`,
          severity: 'info'
        });
      }
      prevCountRef.current = newCount;
    } catch (e) {
      // silencieux: on évite de spam l'utilisateur
      console.error('Notifications: fetch failed', e);
    }
  }

  function pushToast(t) {
    const id = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
    const toast = { id, timestamp: new Date().toISOString(), ...t };
    setToasts((prev) => [toast, ...prev].slice(0, 4));
    setTimeout(() => {
      setToasts((prev) => prev.filter((x) => x.id !== id));
    }, 3500);
  }

  useEffect(() => {
    fetchNotifications();
    const interval = setInterval(fetchNotifications, 10000);
    return () => clearInterval(interval);
  }, [token]);

  // close on outside click
  useEffect(() => {
    const onDown = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setOpen(false);
      }
    };
    document.addEventListener('mousedown', onDown);
    return () => document.removeEventListener('mousedown', onDown);
  }, []);

  const latest = useMemo(() => notifications.slice(0, 10), [notifications]);

  function handleClickNotif(n) {
    setOpen(false);
    if (n?.link) navigate(n.link);
  }

  return (
    <>
      {/* Toasts */}
      {toasts.length > 0 && (
        <div className="toastHost" aria-live="polite">
          {toasts.map((t) => (
            <div key={t.id} className="toast">
              <div className="toastRow">
                <div className="toastDot" style={{ background: severityToDot(t.severity) }} />
                <div style={{ flex: 1 }}>
                  <div className="toastTitle">{t.title}</div>
                  <div className="toastMsg">{t.message}</div>
                  <div className="toastTime">{formatTimestamp(t.timestamp)}</div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Bell */}
      <div style={{ position: 'relative' }} ref={dropdownRef}>
        <button
          className="iconBtn"
          onClick={() => {
            const next = !open;
            setOpen(next);
            if (next) fetchNotifications(); // refresh on open
          }}
          aria-label="Notifications"
          style={{ position: 'relative' }}
        >
          {/* simple bell icon */}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2Zm6-6V11a6 6 0 0 0-5-5.9V4a1 1 0 1 0-2 0v1.1A6 6 0 0 0 6 11v5l-2 2v1h16v-1l-2-2Z"
              stroke="currentColor"
              strokeWidth="1.6"
              strokeLinejoin="round"
            />
          </svg>

          {unread > 0 && (
            <span
              style={{
                position: 'absolute',
                top: 6,
                right: 6,
                width: 9,
                height: 9,
                borderRadius: 999,
                background: 'var(--danger)',
                boxShadow: '0 0 0 2px rgba(247,247,251,.9)'
              }}
            />
          )}
        </button>

        {open && (
          <div
            style={{
              position: 'absolute',
              right: 0,
              top: 48,
              width: 360,
              maxWidth: '92vw',
              background: 'white',
              border: '1px solid rgba(15,23,42,.12)',
              borderRadius: 16,
              boxShadow: '0 18px 60px rgba(15,23,42,.18)',
              overflow: 'hidden',
              zIndex: 9999
            }}
          >
            <div style={{ padding: 12, display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '1px solid rgba(15,23,42,.08)' }}>
              <div style={{ fontWeight: 900, fontSize: 13 }}>Notifications</div>
              <div className="badge badge-info">{unread} non lue(s)</div>
            </div>

            <div style={{ maxHeight: 420, overflow: 'auto' }}>
              {latest.length === 0 ? (
                <div style={{ padding: 14 }} className="muted">
                  Rien pour le moment.
                </div>
              ) : (
                latest.map((n) => (
                  <button
                    key={n.id}
                    onClick={() => handleClickNotif(n)}
                    className="btn"
                    style={{
                      width: '100%',
                      background: 'transparent',
                      color: 'inherit',
                      border: 'none',
                      borderBottom: '1px solid rgba(15,23,42,.06)',
                      textAlign: 'left',
                      padding: 12,
                      borderRadius: 0,
                      justifyContent: 'flex-start'
                    }}
                  >
                    <div style={{ display: 'flex', gap: 10, width: '100%' }}>
                      <div style={{ width: 10, display: 'flex', justifyContent: 'center' }}>
                        <span style={{ width: 8, height: 8, borderRadius: 99, background: severityToDot(n.severity) }} />
                      </div>

                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontWeight: 900, fontSize: 13, marginBottom: 3, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                          {n.title}
                        </div>
                        <div style={{ fontSize: 12, color: 'rgba(15,23,42,.62)', marginBottom: 6 }}>
                          {n.message}
                        </div>
                        <div style={{ fontSize: 11, color: 'rgba(15,23,42,.45)' }}>
                          {formatTimestamp(n.timestamp)}
                        </div>
                      </div>
                    </div>
                  </button>
                ))
              )}
            </div>
          </div>
        )}
      </div>
    </>
  );
}


────────────────── client/src/components/Layout.jsx ──────────────────
import React, { useMemo, useState, useEffect, useCallback } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import NotificationBell from './NotificationBell.jsx';
import AnimatedSidebar from './AnimatedSidebar.jsx';

// Définition des menus par rôle
const MENU = {
  common: [
    { to: '/app', label: 'Dashboard' },
    { to: '/app/fuel', label: 'Suivi carburant' },
    { to: '/app/calendar', label: 'Calendrier' }
  ],
  demandeur: [
    { to: '/app/requests/fuel', label: 'Demande carburant' },
    { to: '/app/requests/car', label: 'Demande voiture' }
  ],
  logistique: [
    { to: '/app/import', label: 'Import Excel' },
    { to: '/app/requests/fuel/manage', label: 'Valid. carburant' },
    { to: '/app/requests/car/manage', label: 'Valid. voiture' },
    { to: '/app/logbooks', label: 'Journal de bord' },
    { to: '/app/meta', label: 'Flotte & Chauffeurs' },
    { to: '/app/trash', label: 'Corbeille' }
  ],
  raf: [
    { to: '/app/requests/fuel/raf', label: 'Visa RAF carburant' },
    { to: '/app/requests/car/raf', label: 'Visa RAF voiture' },
    { to: '/app/logbooks', label: 'Journal de bord' }
  ],
  admin: [
    { to: '/app', label: 'Dashboard' },
    { to: '/app/users', label: 'Utilisateurs' },
    { to: '/app/fuel', label: 'Suivi carburant' },
    { to: '/app/import', label: 'Import Excel' },
    { to: '/app/meta', label: 'Flotte & Chauffeurs' },
    { to: '/app/requests/fuel/manage', label: 'Valid. carburant' },
    { to: '/app/requests/car/manage', label: 'Valid. voiture' },
    { to: '/app/logbooks', label: 'Journal de bord' },
    { to: '/app/trash', label: 'Corbeille' }
  ]
};

function getMenu(role) {
  const base = [...MENU.common];
  if (role === 'DEMANDEUR') return [...base, ...MENU.demandeur];
  if (role === 'LOGISTIQUE') return [...base, ...MENU.logistique];
  if (role === 'RAF') return [...base, ...MENU.raf];
  if (role === 'ADMIN') return MENU.admin;
  return base;
}

// ✅ Très important: évite que tout le contenu (Dashboard charts etc.) re-render
// à chaque open/close du sidebar ou à chaque tick de l’horloge.
const MemoChildren = React.memo(function MemoChildren({ children }) {
  return children;
});

export default function Layout({ children }) {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();

  // Responsive
  const [isMobile, setIsMobile] = useState(() => window.innerWidth <= 768);
  const [mobileOpen, setMobileOpen] = useState(false);

  // Menu selon rôle
  const menu = useMemo(() => getMenu(user?.role), [user?.role]);

  // Titre dynamique
  const currentTitle = useMemo(() => {
    const path = location.pathname;
    const found = menu.find((m) => m.to === path || path.startsWith(m.to + '/'));
    return found?.label || 'PRIRTEM';
  }, [menu, location.pathname]);

  // ✅ Date/heure live (ne re-render plus les pages grâce à MemoChildren)
  const [now, setNow] = useState(() => new Date());
  useEffect(() => {
    const id = setInterval(() => setNow(new Date()), 30_000);
    return () => clearInterval(id);
  }, []);

  const dateLabel = useMemo(() => {
    return new Intl.DateTimeFormat('fr-FR', {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    }).format(now);
  }, [now]);

  const timeLabel = useMemo(() => {
    return new Intl.DateTimeFormat('fr-FR', {
      hour: '2-digit',
      minute: '2-digit'
    }).format(now);
  }, [now]);

  // Resize listener
  useEffect(() => {
    const handleResize = () => {
      const mobile = window.innerWidth <= 768;
      setIsMobile(mobile);
      if (!mobile) setMobileOpen(false);
    };
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // Empêcher le scroll horizontal quand la sidebar bouge
  useEffect(() => {
    const prev = document.body.style.overflowX;
    document.body.style.overflowX = 'hidden';
    return () => {
      document.body.style.overflowX = prev;
    };
  }, []);

  const handleLogout = useCallback(() => {
    logout();
    navigate('/login');
  }, [logout, navigate]);

  const openMobile = useCallback(() => setMobileOpen(true), []);
  const closeMobile = useCallback(() => setMobileOpen(false), []);

  // ✅ IMPORTANT :
  // - Sur desktop, on utilise une CSS var --app-main-offset (pilotée par AnimatedSidebar)
  // - Et surtout: PAS de transition margin-left => pas de recalcul “à chaque frame”
  const mainStyle = useMemo(
    () => ({
      marginLeft: isMobile ? 0 : 'var(--app-main-offset, 110px)',
      padding: 16,
      height: '100vh',
      boxSizing: 'border-box',
      display: 'flex',
      flexDirection: 'column',
      gap: 16,
      overflow: 'hidden', // le scroll est dans le conteneur, pas sur toute la page
      background: 'var(--bg)'
    }),
    [isMobile]
  );

  const topbarStyle = useMemo(
    () => ({
      marginBottom: 0,
      borderRadius: 14,
      border: 'none',
      flex: '0 0 auto'
    }),
    []
  );

  // ✅ LE CONTENEUR (comme ton image): toutes les pages dedans
  const contentContainerStyle = useMemo(
    () => ({
      flex: '1 1 auto',
      minHeight: 0,
      overflow: 'auto',
      borderRadius: 14,
      border: 'none',
      padding: 16
    }),
    []
  );

  return (
    <div style={{ minHeight: '100vh', background: 'var(--bg)' }}>
      <AnimatedSidebar
        menu={menu}
        isMobile={isMobile}
        isMobileOpen={mobileOpen}
        closeMobile={closeMobile}
        onLogout={handleLogout}
      />

      <main style={mainStyle}>
        {/* Topbar */}
        <div className="topbar card" style={topbarStyle}>
          <div className="topbarLeft">
            {isMobile && (
              <button className="iconBtn" onClick={openMobile} aria-label="Ouvrir le menu">
                <ion-icon name="menu-outline" style={{ fontSize: 24 }}></ion-icon>
              </button>
            )}
            <div className="topbarTitle" style={{ fontSize: 18 }}>
              {currentTitle}
            </div>
          </div>

          <div className="topbarRight">
            <div className="topbarClock">
              <div className="topbarClockDate">{dateLabel}</div>
              <div className="topbarClockTime">{timeLabel}</div>
            </div>

            <div className="topbarUser">
              <div className="topbarUserName">{user?.username || 'Utilisateur'}</div>
              <div className="topbarUserRole">{user?.role || ''}</div>
            </div>

            <NotificationBell />

            <button className="iconBtn" onClick={handleLogout} aria-label="Déconnexion">
              <ion-icon name="log-out-outline" style={{ fontSize: 22 }}></ion-icon>
            </button>
          </div>
        </div>

        {/* ✅ CONTENEUR GLOBAL : tous les contenus ici */}
        <section className="card" style={contentContainerStyle}>
          <MemoChildren>{children}</MemoChildren>
        </section>
      </main>
    </div>
  );
}


────────────────── client/src/components/GlowStatCard.css ──────────────────
.gscWrap{
  position: relative;
  border-radius: 18px;
}

.gscGlow{
  position:absolute;
  inset:-6px;
  border-radius: 18px;
  filter: blur(14px);
  opacity:.22;
  transition: opacity .35s ease;
}

.gscWrap:hover .gscGlow{
  opacity:.42;
}

.gscCard{
  position:relative;
  border-radius: 18px;
  padding: 18px;
  background: #0f172a; /* slate-900 */
  box-shadow: 0 14px 40px rgba(2,6,23,.25);
  border: 1px solid rgba(255,255,255,.06);
  color: #e5e7eb;
}

.gscHeader{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 12px;
  margin-bottom: 14px;
}

.gscTitleBlock{ min-width: 0; }

.gscTitle{
  font-weight: 800;
  font-size: 20px;
  line-height: 1.1;
  background-clip:text;
  -webkit-background-clip:text;
  color: transparent;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.gscSubtitle{
  margin-top: 4px;
  font-size: 12px;
  color: rgba(226,232,240,.75);
}

.gscBadge{
  display:flex;
  align-items:center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.06);
  user-select:none;
  flex-shrink:0;
}

.gscDot{
  width:8px;height:8px;border-radius:999px;
  animation: gscPulse 1.3s infinite;
}

@keyframes gscPulse{
  0%{ transform: scale(1); opacity: 1; }
  50%{ transform: scale(1.35); opacity: .65; }
  100%{ transform: scale(1); opacity: 1; }
}

.gscBadgeText{
  font-size: 12px;
  font-weight: 700;
}

.gscGrid{
  display:grid;
  gap: 12px;
}

.gscStat{
  position: relative;
  overflow: hidden;
  border-radius: 14px;
  padding: 14px;
  background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border: 1px solid rgba(255,255,255,.06);
}

.gscStatValue{
  font-size: 22px;
  font-weight: 900;
  color: var(--statValue, #34d399);
  letter-spacing: .2px;
}

.gscStatLabel{
  margin-top: 2px;
  font-size: 12px;
  color: rgba(226,232,240,.78);
}

.gscStatBar{
  position:absolute;
  left:0; right:0; bottom:0;
  height: 4px;
  background: linear-gradient(90deg, var(--statFrom, #10b981), var(--statTo, #0ea5e9));
  opacity:.95;
}


────────────────── client/src/components/FloatingLines.jsx ──────────────────
import { useEffect, useMemo, useRef } from 'react';
import {
  Scene,
  OrthographicCamera,
  WebGLRenderer,
  PlaneGeometry,
  Mesh,
  ShaderMaterial,
  Vector3,
  Vector2,
  Clock
} from 'three';

import './FloatingLines.css';

const vertexShader = `
precision highp float;

void main() {
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`;

const fragmentShader = `
precision highp float;

uniform float iTime;
uniform vec3  iResolution;
uniform float animationSpeed;

uniform bool enableTop;
uniform bool enableMiddle;
uniform bool enableBottom;

uniform int topLineCount;
uniform int middleLineCount;
uniform int bottomLineCount;

uniform float topLineDistance;
uniform float middleLineDistance;
uniform float bottomLineDistance;

uniform vec3 topWavePosition;
uniform vec3 middleWavePosition;
uniform vec3 bottomWavePosition;

uniform vec2 iMouse;
uniform bool interactive;
uniform float bendRadius;
uniform float bendStrength;
uniform float bendInfluence;

uniform bool parallax;
uniform float parallaxStrength;
uniform vec2 parallaxOffset;

uniform vec3 lineGradient[8];
uniform int lineGradientCount;

const vec3 BLACK = vec3(0.0);
const vec3 PINK  = vec3(233.0, 71.0, 245.0) / 255.0;
const vec3 BLUE  = vec3(47.0,  75.0, 162.0) / 255.0;

mat2 rotate(float r) {
  return mat2(cos(r), sin(r), -sin(r), cos(r));
}

vec3 background_color(vec2 uv) {
  vec3 col = vec3(0.0);

  float y = sin(uv.x - 0.2) * 0.3 - 0.1;
  float m = uv.y - y;

  col += mix(BLUE, BLACK, smoothstep(0.0, 1.0, abs(m)));
  col += mix(PINK, BLACK, smoothstep(0.0, 1.0, abs(m - 0.8)));
  return col * 0.5;
}

vec3 getLineColor(float t, vec3 baseColor) {
  if (lineGradientCount <= 0) {
    return baseColor;
  }

  vec3 gradientColor;

  if (lineGradientCount == 1) {
    gradientColor = lineGradient[0];
  } else {
    float clampedT = clamp(t, 0.0, 0.9999);
    float scaled = clampedT * float(lineGradientCount - 1);
    int idx = int(floor(scaled));
    float f = fract(scaled);
    int idx2 = min(idx + 1, lineGradientCount - 1);

    vec3 c1 = lineGradient[idx];
    vec3 c2 = lineGradient[idx2];

    gradientColor = mix(c1, c2, f);
  }

  return gradientColor * 0.5;
}

float wave(vec2 uv, float offset, vec2 screenUv, vec2 mouseUv, bool shouldBend) {
  float time = iTime * animationSpeed;

  float x_offset   = offset;
  float x_movement = time * 0.1;
  float amp        = sin(offset + time * 0.2) * 0.3;
  float y          = sin(uv.x + x_offset + x_movement) * amp;

  if (shouldBend) {
    vec2 d = screenUv - mouseUv;
    float influence = exp(-dot(d, d) * bendRadius);
    float bendOffset = (mouseUv.y - screenUv.y) * influence * bendStrength * bendInfluence;
    y += bendOffset;
  }

  float m = uv.y - y;
  return 0.0175 / max(abs(m) + 0.01, 1e-3) + 0.01;
}

void mainImage(out vec4 fragColor, in vec2 fragCoord) {
  vec2 baseUv = (2.0 * fragCoord - iResolution.xy) / iResolution.y;
  baseUv.y *= -1.0;

  if (parallax) {
    baseUv += parallaxOffset;
  }

  vec3 col = vec3(0.0);

  vec3 b = lineGradientCount > 0 ? vec3(0.0) : background_color(baseUv);

  vec2 mouseUv = vec2(0.0);
  if (interactive) {
    mouseUv = (2.0 * iMouse - iResolution.xy) / iResolution.y;
    mouseUv.y *= -1.0;
  }

  if (enableBottom) {
    for (int i = 0; i < bottomLineCount; ++i) {
      float fi = float(i);
      float t = fi / max(float(bottomLineCount - 1), 1.0);
      vec3 lineCol = getLineColor(t, b);

      float angle = bottomWavePosition.z * log(length(baseUv) + 1.0);
      vec2 ruv = baseUv * rotate(angle);
      col += lineCol * wave(
        ruv + vec2(bottomLineDistance * fi + bottomWavePosition.x, bottomWavePosition.y),
        1.5 + 0.2 * fi,
        baseUv,
        mouseUv,
        interactive
      ) * 0.2;
    }
  }

  if (enableMiddle) {
    for (int i = 0; i < middleLineCount; ++i) {
      float fi = float(i);
      float t = fi / max(float(middleLineCount - 1), 1.0);
      vec3 lineCol = getLineColor(t, b);

      float angle = middleWavePosition.z * log(length(baseUv) + 1.0);
      vec2 ruv = baseUv * rotate(angle);
      col += lineCol * wave(
        ruv + vec2(middleLineDistance * fi + middleWavePosition.x, middleWavePosition.y),
        2.0 + 0.15 * fi,
        baseUv,
        mouseUv,
        interactive
      );
    }
  }

  if (enableTop) {
    for (int i = 0; i < topLineCount; ++i) {
      float fi = float(i);
      float t = fi / max(float(topLineCount - 1), 1.0);
      vec3 lineCol = getLineColor(t, b);

      float angle = topWavePosition.z * log(length(baseUv) + 1.0);
      vec2 ruv = baseUv * rotate(angle);
      ruv.x *= -1.0;
      col += lineCol * wave(
        ruv + vec2(topLineDistance * fi + topWavePosition.x, topWavePosition.y),
        1.0 + 0.2 * fi,
        baseUv,
        mouseUv,
        interactive
      ) * 0.1;
    }
  }

  fragColor = vec4(col, 1.0);
}

void main() {
  vec4 color = vec4(0.0);
  mainImage(color, gl_FragCoord.xy);
  gl_FragColor = color;
}
`;

const MAX_GRADIENT_STOPS = 8;

function hexToVec3(hex) {
  let value = (hex || '').trim();
  if (value.startsWith('#')) value = value.slice(1);

  let r = 255, g = 255, b = 255;

  if (value.length === 3) {
    r = parseInt(value[0] + value[0], 16);
    g = parseInt(value[1] + value[1], 16);
    b = parseInt(value[2] + value[2], 16);
  } else if (value.length === 6) {
    r = parseInt(value.slice(0, 2), 16);
    g = parseInt(value.slice(2, 4), 16);
    b = parseInt(value.slice(4, 6), 16);
  }

  return new Vector3(r / 255, g / 255, b / 255);
}

function computeCounts(enabledWaves, lineCount, lineDistance) {
  const waves = Array.isArray(enabledWaves) ? enabledWaves : ['top', 'middle', 'bottom'];

  const getLineCount = (waveType) => {
    if (typeof lineCount === 'number') return lineCount;
    if (!waves.includes(waveType)) return 0;
    const index = waves.indexOf(waveType);
    return lineCount?.[index] ?? 6;
  };

  const getLineDistance = (waveType) => {
    if (typeof lineDistance === 'number') return lineDistance;
    if (!waves.includes(waveType)) return 0.1;
    const index = waves.indexOf(waveType);
    return lineDistance?.[index] ?? 0.1;
  };

  const topLineCount = waves.includes('top') ? getLineCount('top') : 0;
  const middleLineCount = waves.includes('middle') ? getLineCount('middle') : 0;
  const bottomLineCount = waves.includes('bottom') ? getLineCount('bottom') : 0;

  const topLineDistance = waves.includes('top') ? getLineDistance('top') * 0.01 : 0.01;
  const middleLineDistance = waves.includes('middle') ? getLineDistance('middle') * 0.01 : 0.01;
  const bottomLineDistance = waves.includes('bottom') ? getLineDistance('bottom') * 0.01 : 0.01;

  return {
    waves,
    topLineCount,
    middleLineCount,
    bottomLineCount,
    topLineDistance,
    middleLineDistance,
    bottomLineDistance
  };
}

export default function FloatingLines({
  linesGradient,
  enabledWaves = ['top', 'middle', 'bottom'],
  lineCount = [6],
  lineDistance = [5],
  topWavePosition,
  middleWavePosition,
  bottomWavePosition = { x: 2.0, y: -0.7, rotate: -1 },
  animationSpeed = 1,
  interactive = true,
  bendRadius = 5.0,
  bendStrength = -0.5,
  mouseDamping = 0.05,
  parallax = true,
  parallaxStrength = 0.2,
  mixBlendMode = 'screen'
}) {
  const containerRef = useRef(null);

  // souris & parallax (refs pour ne pas recréer les handlers)
  const targetMouseRef = useRef(new Vector2(-1000, -1000));
  const currentMouseRef = useRef(new Vector2(-1000, -1000));
  const targetInfluenceRef = useRef(0);
  const currentInfluenceRef = useRef(0);

  const targetParallaxRef = useRef(new Vector2(0, 0));
  const currentParallaxRef = useRef(new Vector2(0, 0));

  // settings dynamiques (évite de relancer le WebGL)
  const settingsRef = useRef({
    interactive,
    parallax,
    parallaxStrength,
    mouseDamping
  });

  // objets Three persistants
  const threeRef = useRef({
    renderer: null,
    scene: null,
    camera: null,
    geometry: null,
    material: null,
    mesh: null,
    uniforms: null,
    clock: null,
    ro: null,
    raf: 0,
    disposed: false
  });

  // initialisation WebGL — 1 fois
  useEffect(() => {
    const el = containerRef.current;
    if (!el) return;

    const scene = new Scene();
    const camera = new OrthographicCamera(-1, 1, 1, -1, 0, 1);
    camera.position.z = 1;

    const renderer = new WebGLRenderer({ antialias: true, alpha: false });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    renderer.domElement.style.width = '100%';
    renderer.domElement.style.height = '100%';

    // guard StrictMode: si el a disparu
    if (!containerRef.current) {
      renderer.dispose();
      return;
    }
    containerRef.current.appendChild(renderer.domElement);

    const uniforms = {
      iTime: { value: 0 },
      iResolution: { value: new Vector3(1, 1, 1) },
      animationSpeed: { value: animationSpeed },

      enableTop: { value: true },
      enableMiddle: { value: true },
      enableBottom: { value: true },

      topLineCount: { value: 6 },
      middleLineCount: { value: 6 },
      bottomLineCount: { value: 6 },

      topLineDistance: { value: 0.05 },
      middleLineDistance: { value: 0.05 },
      bottomLineDistance: { value: 0.05 },

      topWavePosition: { value: new Vector3(10.0, 0.5, -0.4) },
      middleWavePosition: { value: new Vector3(5.0, 0.0, 0.2) },
      bottomWavePosition: { value: new Vector3(2.0, -0.7, 0.4) },

      iMouse: { value: new Vector2(-1000, -1000) },
      interactive: { value: interactive },
      bendRadius: { value: bendRadius },
      bendStrength: { value: bendStrength },
      bendInfluence: { value: 0 },

      parallax: { value: parallax },
      parallaxStrength: { value: parallaxStrength },
      parallaxOffset: { value: new Vector2(0, 0) },

      lineGradient: {
        value: Array.from({ length: MAX_GRADIENT_STOPS }, () => new Vector3(1, 1, 1))
      },
      lineGradientCount: { value: 0 }
    };

    const material = new ShaderMaterial({
      uniforms,
      vertexShader,
      fragmentShader
    });

    const geometry = new PlaneGeometry(2, 2);
    const mesh = new Mesh(geometry, material);
    scene.add(mesh);

    const clock = new Clock();

    const setSize = () => {
      const host = containerRef.current;
      if (!host || threeRef.current.disposed) return;

      const w = host.clientWidth || 1;
      const h = host.clientHeight || 1;

      renderer.setSize(w, h, false);

      const cw = renderer.domElement.width;
      const ch = renderer.domElement.height;
      uniforms.iResolution.value.set(cw, ch, 1);
    };

    setSize();

    // ResizeObserver safe
    const ro = typeof ResizeObserver !== 'undefined'
      ? new ResizeObserver(() => {
          if (!containerRef.current || threeRef.current.disposed) return;
          setSize();
        })
      : null;

    if (ro) ro.observe(containerRef.current);

    const handlePointerMove = (event) => {
      const { interactive: inter, parallax: para, parallaxStrength: ps } = settingsRef.current;
      if (!inter && !para) return;

      const rect = renderer.domElement.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      const dpr = renderer.getPixelRatio();

      if (inter) {
        targetMouseRef.current.set(x * dpr, (rect.height - y) * dpr);
        targetInfluenceRef.current = 1.0;
      }

      if (para) {
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        const offsetX = (x - centerX) / rect.width;
        const offsetY = -(y - centerY) / rect.height;
        targetParallaxRef.current.set(offsetX * ps, offsetY * ps);
      }
    };

    const handlePointerLeave = () => {
      if (!settingsRef.current.interactive) return;
      targetInfluenceRef.current = 0.0;
    };

    renderer.domElement.addEventListener('pointermove', handlePointerMove);
    renderer.domElement.addEventListener('pointerleave', handlePointerLeave);

    const renderLoop = () => {
      if (threeRef.current.disposed) return;

      uniforms.iTime.value = clock.getElapsedTime();

      const { interactive: inter, parallax: para, mouseDamping: md } = settingsRef.current;

      if (inter) {
        currentMouseRef.current.lerp(targetMouseRef.current, md);
        uniforms.iMouse.value.copy(currentMouseRef.current);

        currentInfluenceRef.current += (targetInfluenceRef.current - currentInfluenceRef.current) * md;
        uniforms.bendInfluence.value = currentInfluenceRef.current;
      } else {
        // pas d'interaction : influence = 0 (stable)
        uniforms.bendInfluence.value = 0;
      }

      if (para) {
        currentParallaxRef.current.lerp(targetParallaxRef.current, md);
        uniforms.parallaxOffset.value.copy(currentParallaxRef.current);
      } else {
        uniforms.parallaxOffset.value.set(0, 0);
      }

      renderer.render(scene, camera);
      threeRef.current.raf = requestAnimationFrame(renderLoop);
    };

    // stocke refs
    threeRef.current.renderer = renderer;
    threeRef.current.scene = scene;
    threeRef.current.camera = camera;
    threeRef.current.geometry = geometry;
    threeRef.current.material = material;
    threeRef.current.mesh = mesh;
    threeRef.current.uniforms = uniforms;
    threeRef.current.clock = clock;
    threeRef.current.ro = ro;
    threeRef.current.disposed = false;

    threeRef.current.raf = requestAnimationFrame(renderLoop);

    return () => {
      // cleanup StrictMode-safe
      threeRef.current.disposed = true;

      cancelAnimationFrame(threeRef.current.raf);

      if (ro) ro.disconnect();

      renderer.domElement.removeEventListener('pointermove', handlePointerMove);
      renderer.domElement.removeEventListener('pointerleave', handlePointerLeave);

      geometry.dispose();
      material.dispose();
      renderer.dispose();

      if (renderer.domElement.parentElement) {
        renderer.domElement.parentElement.removeChild(renderer.domElement);
      }

      // reset refs
      threeRef.current.renderer = null;
      threeRef.current.scene = null;
      threeRef.current.camera = null;
      threeRef.current.geometry = null;
      threeRef.current.material = null;
      threeRef.current.mesh = null;
      threeRef.current.uniforms = null;
      threeRef.current.clock = null;
      threeRef.current.ro = null;
      threeRef.current.raf = 0;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // ✅ Mise à jour des uniforms quand les props changent (sans recréer WebGL)
  useEffect(() => {
    // update settings refs (utilisées dans handlers/loop)
    settingsRef.current = {
      interactive,
      parallax,
      parallaxStrength,
      mouseDamping
    };

    const el = containerRef.current;
    if (el) el.style.mixBlendMode = mixBlendMode || 'screen';

    const uniforms = threeRef.current.uniforms;
    if (!uniforms) return;

    const counts = computeCounts(enabledWaves, lineCount, lineDistance);

    uniforms.animationSpeed.value = animationSpeed;

    uniforms.enableTop.value = counts.waves.includes('top');
    uniforms.enableMiddle.value = counts.waves.includes('middle');
    uniforms.enableBottom.value = counts.waves.includes('bottom');

    uniforms.topLineCount.value = counts.topLineCount;
    uniforms.middleLineCount.value = counts.middleLineCount;
    uniforms.bottomLineCount.value = counts.bottomLineCount;

    uniforms.topLineDistance.value = counts.topLineDistance;
    uniforms.middleLineDistance.value = counts.middleLineDistance;
    uniforms.bottomLineDistance.value = counts.bottomLineDistance;

    uniforms.topWavePosition.value.set(
      topWavePosition?.x ?? 10.0,
      topWavePosition?.y ?? 0.5,
      topWavePosition?.rotate ?? -0.4
    );

    uniforms.middleWavePosition.value.set(
      middleWavePosition?.x ?? 5.0,
      middleWavePosition?.y ?? 0.0,
      middleWavePosition?.rotate ?? 0.2
    );

    uniforms.bottomWavePosition.value.set(
      bottomWavePosition?.x ?? 2.0,
      bottomWavePosition?.y ?? -0.7,
      bottomWavePosition?.rotate ?? 0.4
    );

    uniforms.interactive.value = !!interactive;
    uniforms.bendRadius.value = bendRadius;
    uniforms.bendStrength.value = bendStrength;

    uniforms.parallax.value = !!parallax;
    uniforms.parallaxStrength.value = parallaxStrength;

    // gradient lines
    if (linesGradient && Array.isArray(linesGradient) && linesGradient.length > 0) {
      const stops = linesGradient.slice(0, MAX_GRADIENT_STOPS);
      uniforms.lineGradientCount.value = stops.length;

      stops.forEach((hex, i) => {
        const c = hexToVec3(hex);
        uniforms.lineGradient.value[i].set(c.x, c.y, c.z);
      });

      for (let i = stops.length; i < MAX_GRADIENT_STOPS; i++) {
        uniforms.lineGradient.value[i].set(1, 1, 1);
      }
    } else {
      uniforms.lineGradientCount.value = 0;
      for (let i = 0; i < MAX_GRADIENT_STOPS; i++) {
        uniforms.lineGradient.value[i].set(1, 1, 1);
      }
    }
  }, [
    linesGradient,
    enabledWaves,
    lineCount,
    lineDistance,
    topWavePosition,
    middleWavePosition,
    bottomWavePosition,
    animationSpeed,
    interactive,
    bendRadius,
    bendStrength,
    mouseDamping,
    parallax,
    parallaxStrength,
    mixBlendMode
  ]);

  return (
    <div ref={containerRef} className="floating-lines-container" />
  );
}


────────────────── client/src/components/AnimatedSidebar.jsx ──────────────────
import React, { useCallback, useLayoutEffect, useMemo, useRef, useState, useEffect } from 'react';
import { NavLink, useLocation } from 'react-router-dom';
import './animatedSidebar.css';

const MAIN_OFFSET_COLLAPSED = '110px';
const MAIN_OFFSET_EXPANDED = '290px';

function iconForPath(to) {
  if (to === '/app') return 'grid-outline';
  if (to.startsWith('/app/users')) return 'person-outline';
  if (to.startsWith('/app/fuel')) return 'speedometer-outline';
  if (to.startsWith('/app/import')) return 'cloud-upload-outline';
  if (to.startsWith('/app/meta')) return 'people-outline';
  if (to.startsWith('/app/logbooks')) return 'book-outline';
  if (to.startsWith('/app/trash')) return 'trash-outline';
  if (to.startsWith('/app/requests')) return 'checkbox-outline';
  if (to.startsWith('/app/calendar')) return 'calendar-outline';
  return 'ellipse-outline';
}

export default React.memo(function AnimatedSidebar({
  menu = [],
  isMobile = false,
  isMobileOpen = false,
  closeMobile,
  onLogout,

  // compat
  isExpanded: controlledExpanded,
  toggleSidebar: controlledToggle
}) {
  const location = useLocation();
  const listRef = useRef(null);

  const isControlled = typeof controlledExpanded === 'boolean' && typeof controlledToggle === 'function';

  const [expanded, setExpanded] = useState(() => {
    if (isControlled) return !!controlledExpanded;
    try {
      return localStorage.getItem('prirtem_sidebar_expanded') === '1';
    } catch {
      return false;
    }
  });

  const isExpanded = isControlled ? !!controlledExpanded : expanded;

  const animTimerRef = useRef(0);
  const startSidebarAnimHint = useCallback(() => {
    const root = document.documentElement;
    root.classList.add('sidebar-animating');

    window.clearTimeout(animTimerRef.current);
    animTimerRef.current = window.setTimeout(() => {
      root.classList.remove('sidebar-animating');
    }, 280);
  }, []);

  useEffect(() => {
    return () => window.clearTimeout(animTimerRef.current);
  }, []);

  const setRootOffset = useCallback((nextExpanded) => {
    const root = document.documentElement;
    root.style.setProperty('--app-main-offset', nextExpanded ? MAIN_OFFSET_EXPANDED : MAIN_OFFSET_COLLAPSED);
  }, []);

  useLayoutEffect(() => {
    setRootOffset(isExpanded);
  }, [isExpanded, setRootOffset]);

  const toggle = useCallback(() => {
    startSidebarAnimHint();

    if (isControlled) {
      controlledToggle();
      return;
    }
    setExpanded((v) => {
      const next = !v;
      try {
        localStorage.setItem('prirtem_sidebar_expanded', next ? '1' : '0');
      } catch {
        // ignore
      }
      setRootOffset(next);
      return next;
    });
  }, [isControlled, controlledToggle, setRootOffset, startSidebarAnimHint]);

  useEffect(() => {
    if (!isMobile) return;
    startSidebarAnimHint();
  }, [isMobile, isMobileOpen, startSidebarAnimHint]);

  const onNavClick = useCallback(() => {
    if (isMobile) closeMobile?.();
  }, [isMobile, closeMobile]);

  const [indicatorY, setIndicatorY] = useState(0);

  useLayoutEffect(() => {
    const el = listRef.current;
    if (!el) return;

    const active = el.querySelector('.asb-item.active');
    if (!active) {
      setIndicatorY(0);
      return;
    }
    setIndicatorY(active.offsetTop || 0);
  }, [location.pathname, menu]);

  const sidebarClass = useMemo(() => {
    const base = ['asb-sidebar'];
    if (isExpanded) base.push('active');
    if (isMobile && isMobileOpen) base.push('mobile-open');
    return base.join(' ');
  }, [isExpanded, isMobile, isMobileOpen]);

  return (
    <>
      {isMobile && isMobileOpen && (
        <div className="asb-overlay" onClick={closeMobile} role="presentation" />
      )}

      <aside
        className={sidebarClass}
        style={{
          // ✅ IMPORTANT: PAS de "paint" sinon le toggle est coupé
          contain: 'layout',
          willChange: isMobile ? 'transform' : 'width',
          transform: 'translateZ(0)'
        }}
      >
        <div className="asb-logo">
          <div className="asb-logo-icon">
            <ion-icon name="infinite-outline"></ion-icon>
          </div>
          <div className="asb-logo-text">PRIRTEM</div>
        </div>

        {!isMobile && (
          <div className="asb-toggle" onClick={toggle} role="button" aria-label="Réduire/Étendre">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </div>
        )}

        <ul className="asb-menu-list" ref={listRef}>
          <div
            className="asb-indicator"
            style={{
              transform: `translate3d(0, ${indicatorY}px, 0)`,
              willChange: 'transform'
            }}
          />

          {menu.map((m) => {
            const icon = iconForPath(m.to);

            return (
              <NavLink
                key={m.to}
                to={m.to}
                end={m.to === '/app'}
                className={({ isActive }) => `asb-item ${isActive ? 'active' : ''}`}
                onClick={onNavClick}
              >
                <div className="asb-link">
                  <span className="asb-icon">
                    <ion-icon name={icon}></ion-icon>
                  </span>
                  <span className="asb-text">{m.label}</span>
                </div>
              </NavLink>
            );
          })}
        </ul>

        
        {/* Footer / Logout */}
        <div className="asb-footer">
          <div className="asb-item">
            <button
              type="button"
              className="asb-link asb-logout"
              onClick={() => {
                onLogout();
                if (isMobile) closeMobile();
              }}
            >
              <span className="asb-icon">
                <ion-icon name="log-out-outline"></ion-icon>
              </span>
              <span className="asb-text">Déconnexion</span>
            </button>
          </div>
        </div>
      </aside>
    </>
  );
});


────────────────── server/src/sql/reset.js ──────────────────
#!/usr/bin/env node
/* eslint-disable no-console */

const fs = require('fs');
const path = require('path');
const { v4: uuidv4 } = require('uuid');
const bcrypt = require('bcryptjs');
const { Pool } = require('pg');

// Load server/.env automatically (so `npm run db:reset` works without manual export)
require('dotenv').config({
  path: path.join(__dirname, '..', '..', '.env')
});

const databaseUrl = process.env.DATABASE_URL;
if (!databaseUrl) {
  console.error('DATABASE_URL is required');
  process.exit(1);
}

const pool = new Pool({ connectionString: databaseUrl });

async function run() {
  const schemaPath = path.join(__dirname, 'schema.sql');
  const sql = fs.readFileSync(schemaPath, 'utf8');

  console.log('Applying schema.sql ...');
  await pool.query(sql);

  console.log('Seeding users + vehicles ...');

  const users = [
    { username: 'admin', role: 'ADMIN', password: 'admin123', first_name: 'Admin', last_name: 'PRIRTEM' },
    { username: 'logistique', role: 'LOGISTIQUE', password: 'logistique123', first_name: 'A', last_name: 'Logistique' },
    { username: 'raf', role: 'RAF', password: 'raf123', first_name: 'R', last_name: 'AF' },
    { username: 'demandeur', role: 'DEMANDEUR', password: 'demandeur123', first_name: 'Un', last_name: 'Demandeur' }
  ];

  for (const u of users) {
    const hash = await bcrypt.hash(u.password, 10);
    await pool.query(
      `INSERT INTO users (id, first_name, last_name, username, email, role, password_hash)
       VALUES ($1,$2,$3,$4,$5,$6,$7)
       ON CONFLICT (username) DO UPDATE SET
         first_name = EXCLUDED.first_name,
         last_name = EXCLUDED.last_name,
         email = EXCLUDED.email,
         role = EXCLUDED.role,
         password_hash = EXCLUDED.password_hash,
         is_active = TRUE`,
      [uuidv4(), u.first_name, u.last_name, u.username, `${u.username}@local`, u.role, hash]
    );
  }

  const plates = ['39111WWT','39112WWT','39114WWT','39961WWT','39962WWT','39963WWT'];
  for (const p of plates) {
    await pool.query(
      `INSERT INTO vehicles (id, plate, label)
       VALUES ($1,$2,$3)
       ON CONFLICT (plate) DO NOTHING`,
      [uuidv4(), p, null]
    );
  }

  console.log('Done.');
}

run()
  .catch((e) => {
    console.error(e);
    process.exitCode = 1;
  })
  .finally(async () => {
    await pool.end();
  });


────────────────── server/src/sql/initIfNeeded.js ──────────────────
#!/usr/bin/env node
/* eslint-disable no-console */

const { Pool } = require('pg');
const path = require('path');
const { execFileSync } = require('child_process');

// Load server/.env when running locally
require('dotenv').config({
  path: path.join(__dirname, '..', '..', '.env')
});

const databaseUrl = process.env.DATABASE_URL;
if (!databaseUrl) {
  console.error('DATABASE_URL is required');
  process.exit(1);
}

const pool = new Pool({ connectionString: databaseUrl });

async function tableExists(name) {
  const { rows } = await pool.query(
    `SELECT 1
     FROM information_schema.tables
     WHERE table_schema='public' AND table_name=$1
     LIMIT 1`,
    [name]
  );
  return !!rows[0];
}

async function run() {
  const hasUsers = await tableExists('users');
  if (hasUsers) {
    console.log('DB already initialized ✅');
    return;
  }

  console.log('DB not initialized, running db:reset ...');
  execFileSync(process.execPath, [path.join(__dirname, 'reset.js')], {
    stdio: 'inherit',
    env: process.env
  });
}

run()
  .catch((e) => {
    console.error(e);
    process.exitCode = 1;
  })
  .finally(async () => {
    await pool.end();
  });


────────────────── server/src/utils/mailer.js ──────────────────
/**
 * ────────────────── server/src/utils/mailer.js ──────────────────
 * CORRECTIF APPLIQUÉ : URL dynamique via env et meilleure gestion des logs.
 */
const nodemailer = require('nodemailer');

async function sendResetEmail(to, tokenPlain) {
  // Utilise APP_CLIENT_URL s'il est défini, sinon fallback local
  const appUrl = process.env.APP_CLIENT_URL || 'http://localhost:5173';
  const resetLink = `${appUrl}/reset?email=${encodeURIComponent(to)}&token=${encodeURIComponent(tokenPlain)}`;

  const host = process.env.SMTP_HOST;
  const port = process.env.SMTP_PORT;
  const user = process.env.SMTP_USER;
  const pass = process.env.SMTP_PASS;
  const from = process.env.SMTP_FROM || 'no-reply@prirtem.local';

  // Si SMTP non configuré, log en console (Mode DEV)
  if (!host || !port || !user || !pass) {
    console.log('⚠️ [MAIL MOCK] SMTP non configuré.');
    console.log(`📨 À: ${to}`);
    console.log(`🔗 Lien: ${resetLink}`);
    return;
  }

  try {
    const transporter = nodemailer.createTransport({
      host,
      port: Number(port),
      secure: Number(port) === 465, // true pour 465, false pour les autres
      auth: { user, pass }
    });

    await transporter.sendMail({
      from,
      to,
      subject: 'PRIRTEM - Réinitialisation mot de passe',
      text: `Bonjour,\n\nVous avez demandé la réinitialisation de votre mot de passe.\nCliquez sur ce lien pour continuer : ${resetLink}\n\nCe lien est valide 30 minutes.`,
      html: `<p>Bonjour,</p><p>Vous avez demandé la réinitialisation de votre mot de passe.</p><p><a href="${resetLink}">Cliquez ici pour réinitialiser votre mot de passe</a></p><p><i>Ce lien est valide 30 minutes.</i></p>`
    });
    console.log(`✅ Email envoyé à ${to}`);
  } catch (error) {
    console.error('❌ Erreur envoi email:', error);
    // On ne throw pas forcément l'erreur pour ne pas bloquer le front, mais on loggue
  }
}

module.exports = { sendResetEmail };

────────────────── server/src/utils/excel/parseGenerator.js ──────────────────
const { parseDate, toFloat, toInt, sheetTo2D, norm } = require('./parseUtils');

function parseGeneratorWorkbook(workbook, originalName) {
  const fileName = originalName || 'generator.xlsx';
  const sheetName = workbook.SheetNames[0];
  const sheet = workbook.Sheets[sheetName];
  const grid = sheetTo2D(sheet);

  // Trouver la ligne d'en-tête "Groupe électrogène"
  let titleRow = -1;
  for (let r = 0; r < Math.min(grid.length, 15); r++) {
    const row = (grid[r] || []).map(v => norm(v));
    if (row.some(v => v.includes('groupe') && v.includes('electrogene'))) {
      titleRow = r;
      break;
    }
  }

  if (titleRow < 0) {
    console.log('[GENERATOR] Titre "Groupe électrogène" non trouvé, recherche headers classiques...');
    // Fallback: recherche headers classiques
    for (let r = 0; r < Math.min(grid.length, 20); r++) {
      const row = (grid[r] || []).map(norm);
      if (row.includes('date') && row.some(v => v.includes('litre')) && row.some(v => v.includes('montant'))) {
        titleRow = r - 1; // Assume title is row before
        break;
      }
    }
  }

  if (titleRow < 0) return { records: [] };

  // La ligne des headers est juste après le titre
  const hRow = titleRow + 1;
  if (hRow >= grid.length) return { records: [] };

  const headers = (grid[hRow] || []).map(norm);
  
  // Colonnes: Date, Litres, Montant, Lien
  const dateCol = headers.findIndex(v => v === 'date');
  const litreCol = headers.findIndex(v => v.includes('litre'));
  const montantCol = headers.findIndex(v => v.includes('montant'));
  const lienCol = headers.findIndex(v => v === 'lien');

  if (dateCol < 0 || litreCol < 0 || montantCol < 0) {
    console.error('[GENERATOR] Colonnes essentielles manquantes:', { dateCol, litreCol, montantCol });
    return { records: [] };
  }

  const out = [];
  let emptyStreak = 0;

  for (let r = hRow + 1; r < grid.length; r++) {
    const row = grid[r] || [];
    
    // Check si ligne vide
    const hasAny = row.some(v => v !== null && v !== undefined && String(v).trim() !== '');
    if (!hasAny) {
      emptyStreak += 1;
      if (emptyStreak >= 10) break;
      continue;
    }
    emptyStreak = 0;

    const log_date = parseDate(row[dateCol]);
    const liters = toFloat(row[litreCol]);
    const montant_ar = toInt(row[montantCol]);

    // Skip si pas de date ET pas de données
    if (!log_date && liters === null && montant_ar === null) continue;
    
    // Skip si date invalide
    if (!log_date) continue;

    out.push({
      log_date,
      liters,
      montant_ar,
      source_file_name: fileName,
      sheet_name: sheetName,
      row_in_sheet: r + 1
    });
  }

  console.log(`[GENERATOR] Parsed ${out.length} lignes depuis ${fileName}`);
  return { records: out };
}

module.exports = { parseGeneratorWorkbook };

────────────────── server/src/sql/seed.js ──────────────────
#!/usr/bin/env node
/* eslint-disable no-console */

// Seeds ONLY (does NOT drop tables). Safe to run on an existing DB.

const path = require('path');
const { v4: uuidv4 } = require('uuid');
const bcrypt = require('bcryptjs');
const { Pool } = require('pg');

// Load server/.env automatically
require('dotenv').config({
  path: path.join(__dirname, '..', '..', '.env')
});

const databaseUrl = process.env.DATABASE_URL;
if (!databaseUrl) {
  console.error('DATABASE_URL is required');
  process.exit(1);
}

const pool = new Pool({ connectionString: databaseUrl });

async function run() {
  console.log('Seeding users + vehicles (no drop) ...');

  const users = [
    { username: 'admin', role: 'ADMIN', password: 'admin123', first_name: 'Admin', last_name: 'PRIRTEM' },
    { username: 'logistique', role: 'LOGISTIQUE', password: 'logistique123', first_name: 'A', last_name: 'Logistique' },
    { username: 'raf', role: 'RAF', password: 'raf123', first_name: 'R', last_name: 'AF' },
    { username: 'demandeur', role: 'DEMANDEUR', password: 'demandeur123', first_name: 'Un', last_name: 'Demandeur' }
  ];

  for (const u of users) {
    const hash = await bcrypt.hash(u.password, 10);
    await pool.query(
      `INSERT INTO users (id, first_name, last_name, username, email, role, password_hash)
       VALUES ($1,$2,$3,$4,$5,$6,$7)
       ON CONFLICT (username) DO UPDATE SET
         first_name = EXCLUDED.first_name,
         last_name = EXCLUDED.last_name,
         email = EXCLUDED.email,
         role = EXCLUDED.role,
         password_hash = EXCLUDED.password_hash,
         is_active = TRUE`,
      [uuidv4(), u.first_name, u.last_name, u.username, `${u.username}@local`, u.role, hash]
    );
  }

  const plates = ['39111WWT', '39112WWT', '39114WWT', '39961WWT', '39962WWT', '39963WWT'];
  for (const p of plates) {
    await pool.query(
      `INSERT INTO vehicles (id, plate, label)
       VALUES ($1,$2,$3)
       ON CONFLICT (plate) DO NOTHING`,
      [uuidv4(), p, null]
    );
  }

  console.log('Seed done.');
}

run()
  .catch((e) => {
    console.error(e);
    process.exitCode = 1;
  })
  .finally(async () => {
    await pool.end();
  });


────────────────── server/src/utils/excel/detectType.js ──────────────────
const XLSX = require('xlsx');
const { norm, sheetTo2D } = require('./parseUtils');

function detectFromName(name) {
  const n = norm(name);
  if (n.includes('groupe') && n.includes('elect')) return 'GENERATOR';
  if (n.includes('autres') && n.includes('carburant')) return 'OTHER';
  if (n.includes('suivi') && n.includes('carburant')) return 'VEHICLE';
  return null;
}

function detectFromWorkbook(workbook) {
  // quick scan of a few top cells across sheets
  for (const sheetName of workbook.SheetNames) {
    const sheet = workbook.Sheets[sheetName];
    const grid = sheetTo2D(sheet);
    for (let r = 0; r < Math.min(grid.length, 25); r++) {
      for (let c = 0; c < Math.min((grid[r] || []).length, 20); c++) {
        const v = grid[r][c];
        const s = norm(v);
        if (!s) continue;
        if (s.includes('suivi') && s.includes('carburant')) return 'VEHICLE';
        if (s.includes('groupe') && s.includes('electrogene')) return 'GENERATOR';
        if (s.includes('autres') && s.includes('carburants')) return 'OTHER';
        if (s.includes('demande de carburant')) return 'FUEL_REQUEST_FORM';
      }
    }
  }
  return 'UNKNOWN';
}

function detectExcelType(buffer, originalName) {
  const nameGuess = detectFromName(originalName || '');

  /**
   * ✅ Correctif : cellDates = false
   * On évite que XLSX transforme les dates en objets Date (sensibles au timezone).
   * Les dates restent des nombres Excel (serial), traités en UTC par parseDate().
   */
  const workbook = XLSX.read(buffer, { type: 'buffer', cellDates: false });

  const wbGuess = detectFromWorkbook(workbook);
  return { type: nameGuess || wbGuess, workbook };
}

module.exports = { detectExcelType };


────────────────── server/src/sql/schema.sql ──────────────────
-- PRIRTEM Fuel WebApp - Database schema (PostgreSQL)
-- NOTE: Designed to match the server controllers/routes in /server/src

BEGIN;

CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- ---------- TYPES ----------
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'user_role') THEN
    CREATE TYPE user_role AS ENUM ('DEMANDEUR', 'LOGISTIQUE', 'RAF', 'ADMIN');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'fuel_request_status') THEN
    CREATE TYPE fuel_request_status AS ENUM ('DRAFT','SUBMITTED','VERIFIED','APPROVED','REJECTED');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'car_request_status') THEN
    CREATE TYPE car_request_status AS ENUM ('SUBMITTED','LOGISTICS_APPROVED','RAF_APPROVED','REJECTED');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'logbook_status') THEN
    CREATE TYPE logbook_status AS ENUM ('DRAFT','SUBMITTED','LOCKED');
  END IF;
END $$;

-- ---------- DROP (safe re-run) ----------
DROP TABLE IF EXISTS car_logbook_fuel_supplies CASCADE;
DROP TABLE IF EXISTS car_logbook_trips CASCADE;
DROP TABLE IF EXISTS car_logbooks CASCADE;

DROP TABLE IF EXISTS car_requests CASCADE;
DROP TABLE IF EXISTS fuel_requests CASCADE;

DROP TABLE IF EXISTS vehicle_fuel_logs CASCADE;
DROP TABLE IF EXISTS generator_fuel_logs CASCADE;
DROP TABLE IF EXISTS other_fuel_logs CASCADE;

DROP TABLE IF EXISTS import_files CASCADE;
DROP TABLE IF EXISTS import_batches CASCADE;

DROP TABLE IF EXISTS drivers CASCADE;
DROP TABLE IF EXISTS vehicles CASCADE;

DROP TABLE IF EXISTS password_reset_tokens CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- ---------- COMMON ----------
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ---------- USERS ----------
CREATE TABLE users (
  id UUID PRIMARY KEY,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  username TEXT NOT NULL UNIQUE,
  email TEXT NOT NULL UNIQUE,
  role user_role NOT NULL,
  password_hash TEXT NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TRIGGER trig_users_updated
BEFORE UPDATE ON users
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE password_reset_tokens (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token_hash TEXT NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  used_at TIMESTAMPTZ NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_prt_user_id ON password_reset_tokens(user_id);

-- ---------- META ----------
CREATE TABLE vehicles (
  id UUID PRIMARY KEY,
  plate TEXT NOT NULL UNIQUE,
  label TEXT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ NULL
);

CREATE INDEX idx_vehicles_deleted_at ON vehicles(deleted_at);

CREATE TRIGGER trig_vehicles_updated
BEFORE UPDATE ON vehicles
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE drivers (
  id UUID PRIMARY KEY,
  full_name TEXT NOT NULL,
  phone TEXT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ NULL
);

CREATE INDEX idx_drivers_deleted_at ON drivers(deleted_at);

CREATE TRIGGER trig_drivers_updated
BEFORE UPDATE ON drivers
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- ---------- IMPORT HISTORY ----------
CREATE TABLE import_batches (
  id UUID PRIMARY KEY,
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE import_files (
  id UUID PRIMARY KEY,
  batch_id UUID NOT NULL REFERENCES import_batches(id) ON DELETE CASCADE,
  original_name TEXT NOT NULL,
  mime_type TEXT NULL,
  size_bytes INTEGER NOT NULL DEFAULT 0,
  detected_type TEXT NULL,
  inserted_rows INTEGER NOT NULL DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'PENDING',
  error_message TEXT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  processed_at TIMESTAMPTZ NULL
);

CREATE INDEX idx_import_files_batch ON import_files(batch_id);

-- ---------- FUEL LOGS ----------
CREATE TABLE vehicle_fuel_logs (
  id UUID PRIMARY KEY,
  vehicle_id UUID NOT NULL REFERENCES vehicles(id) ON DELETE CASCADE,

  log_date DATE NULL,
  day_name TEXT NULL,
  day_no INTEGER NULL,

  km_depart INTEGER NULL,
  km_arrivee INTEGER NULL,
  km_jour INTEGER NULL,

  km_between_refill INTEGER NULL,
  consumption DOUBLE PRECISION NULL,
  interval_days INTEGER NULL,

  compteur INTEGER NULL,
  liters DOUBLE PRECISION NULL,
  montant_ar INTEGER NULL,

  lien TEXT NULL,
  chauffeur TEXT NULL,
  frns TEXT NULL,

  is_refill BOOLEAN NOT NULL DEFAULT FALSE,
  is_mission BOOLEAN NOT NULL DEFAULT FALSE,
  mission_label TEXT NULL,

  source_file_name TEXT NOT NULL,
  sheet_name TEXT NOT NULL,
  row_in_sheet INTEGER NOT NULL,

  import_batch_id UUID NOT NULL REFERENCES import_batches(id) ON DELETE CASCADE,
  import_file_id UUID NOT NULL REFERENCES import_files(id) ON DELETE CASCADE,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_vfl_vehicle_date ON vehicle_fuel_logs(vehicle_id, log_date);
CREATE INDEX idx_vfl_batch ON vehicle_fuel_logs(import_batch_id);
CREATE INDEX idx_vfl_is_refill ON vehicle_fuel_logs(is_refill);

CREATE TABLE generator_fuel_logs (
  id UUID PRIMARY KEY,
  log_date DATE NOT NULL,
  liters DOUBLE PRECISION NULL,
  montant_ar INTEGER NULL,

  source_file_name TEXT NOT NULL,
  sheet_name TEXT NOT NULL,
  row_in_sheet INTEGER NOT NULL,

  import_batch_id UUID NOT NULL REFERENCES import_batches(id) ON DELETE CASCADE,
  import_file_id UUID NOT NULL REFERENCES import_files(id) ON DELETE CASCADE,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_gfl_date ON generator_fuel_logs(log_date);

CREATE TABLE other_fuel_logs (
  id UUID PRIMARY KEY,
  log_date DATE NOT NULL,
  liters DOUBLE PRECISION NULL,
  montant_ar INTEGER NULL,
  lien TEXT NULL,

  source_file_name TEXT NOT NULL,
  sheet_name TEXT NOT NULL,
  row_in_sheet INTEGER NOT NULL,

  import_batch_id UUID NOT NULL REFERENCES import_batches(id) ON DELETE CASCADE,
  import_file_id UUID NOT NULL REFERENCES import_files(id) ON DELETE CASCADE,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_ofl_date ON other_fuel_logs(log_date);

-- ---------- REQUESTS ----------
CREATE TABLE fuel_requests (
  id UUID PRIMARY KEY,
  year INTEGER NOT NULL,
  seq INTEGER NOT NULL,
  request_no TEXT NOT NULL UNIQUE,

  request_type TEXT NOT NULL CHECK (request_type IN ('SERVICE','MISSION')),
  objet TEXT NOT NULL,
  amount_estimated_ar INTEGER NOT NULL,
  amount_estimated_words TEXT NOT NULL,
  request_date DATE NOT NULL,

  status fuel_request_status NOT NULL DEFAULT 'DRAFT',

  requester_id UUID NOT NULL REFERENCES users(id),

  submitted_at TIMESTAMPTZ NULL,

  verified_by UUID NULL REFERENCES users(id),
  verified_at TIMESTAMPTZ NULL,

  approved_by UUID NULL REFERENCES users(id),
  approved_at TIMESTAMPTZ NULL,

  rejected_by UUID NULL REFERENCES users(id),
  rejected_at TIMESTAMPTZ NULL,
  reject_reason TEXT NULL,

  deleted_at TIMESTAMPTZ NULL,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_fr_status ON fuel_requests(status);
CREATE INDEX idx_fr_requester ON fuel_requests(requester_id);
CREATE INDEX idx_fr_deleted_at ON fuel_requests(deleted_at);

CREATE TRIGGER trig_fuel_requests_updated
BEFORE UPDATE ON fuel_requests
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE car_requests (
  id UUID PRIMARY KEY,
  year INTEGER NOT NULL,
  seq INTEGER NOT NULL,
  request_no TEXT NOT NULL UNIQUE,

  proposed_date DATE NOT NULL,
  objet TEXT NOT NULL,
  itinerary TEXT NOT NULL,
  people TEXT NOT NULL,

  depart_time_wanted TIME NULL,
  return_time_expected TIME NULL,

  vehicle_hint TEXT NULL,
  driver_hint TEXT NULL,

  -- Optional assignments done by Logistique
  vehicle_id UUID NULL REFERENCES vehicles(id),
  driver_id UUID NULL REFERENCES drivers(id),

  -- Auto filled when RAF validates (Visa RAF)
  authorization_date DATE NULL,
  authorization_time TIME NULL,

  status car_request_status NOT NULL DEFAULT 'SUBMITTED',

  requester_id UUID NOT NULL REFERENCES users(id),

  logistics_by UUID NULL REFERENCES users(id),
  logistics_at TIMESTAMPTZ NULL,

  raf_by UUID NULL REFERENCES users(id),
  raf_at TIMESTAMPTZ NULL,

  rejected_by UUID NULL REFERENCES users(id),
  rejected_at TIMESTAMPTZ NULL,
  reject_reason TEXT NULL,

  deleted_at TIMESTAMPTZ NULL,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_cr_status ON car_requests(status);
CREATE INDEX idx_cr_requester ON car_requests(requester_id);
CREATE INDEX idx_cr_deleted_at ON car_requests(deleted_at);

CREATE TRIGGER trig_car_requests_updated
BEFORE UPDATE ON car_requests
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- ---------- JOURNAL DE BORD VOITURE ----------
CREATE TABLE car_logbooks (
  id UUID PRIMARY KEY,
  vehicle_id UUID NOT NULL REFERENCES vehicles(id),
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  objet TEXT NULL,

  service_km INTEGER NOT NULL DEFAULT 0,
  mission_km INTEGER NOT NULL DEFAULT 0,

  chauffeur_signature TEXT NULL,

  status logbook_status NOT NULL DEFAULT 'DRAFT',

  created_by UUID NOT NULL REFERENCES users(id),
  submitted_at TIMESTAMPTZ NULL,
  locked_at TIMESTAMPTZ NULL,
  locked_by UUID NULL REFERENCES users(id),

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_cl_vehicle_period ON car_logbooks(vehicle_id, period_start, period_end);
CREATE INDEX idx_cl_status ON car_logbooks(status);

CREATE TRIGGER trig_car_logbooks_updated
BEFORE UPDATE ON car_logbooks
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE car_logbook_trips (
  id UUID PRIMARY KEY,
  logbook_id UUID NOT NULL REFERENCES car_logbooks(id) ON DELETE CASCADE,

  trip_date DATE NOT NULL,

  depart_time TIME NULL,
  depart_km INTEGER NULL,

  route_start TEXT NULL,
  route_end TEXT NULL,

  parking_place TEXT NULL,
  parking_duration_min INTEGER NULL,

  arrival_time TIME NULL,
  arrival_km INTEGER NULL,

  passengers TEXT NULL,
  emargement TEXT NULL,

  is_mission BOOLEAN NOT NULL DEFAULT FALSE,
  mission_label TEXT NULL,

  row_order INTEGER NOT NULL,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_clt_logbook ON car_logbook_trips(logbook_id, row_order);

CREATE TABLE car_logbook_fuel_supplies (
  id UUID PRIMARY KEY,
  logbook_id UUID NOT NULL REFERENCES car_logbooks(id) ON DELETE CASCADE,
  supply_date DATE NOT NULL,
  compteur_km INTEGER NOT NULL,
  liters DOUBLE PRECISION NOT NULL,
  montant_ar INTEGER NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_cls_logbook ON car_logbook_fuel_supplies(logbook_id, supply_date);

COMMIT;


────────────────── server/src/utils/excel/parseOther.js ──────────────────
const { parseDate, toFloat, toInt, sheetTo2D, norm } = require('./parseUtils');

function parseOtherWorkbook(workbook, originalName) {
  const fileName = originalName || 'other.xlsx';
  const out = [];

  for (const sheetName of workbook.SheetNames) {
    const sheet = workbook.Sheets[sheetName];
    const grid = sheetTo2D(sheet);

    // header row typically: Date | Litre | Montant | Lien
    let hRow = -1;
    for (let r=0;r<Math.min(grid.length,25);r++) {
      const row = (grid[r]||[]).map(norm);
      if (row.includes('date') && row.some(v=>v.includes('litre')) && row.some(v=>v.includes('montant'))) { hRow=r; break; }
    }
    if (hRow < 0) continue;

    const headers = (grid[hRow] || []).map(norm);
    const dateCol = headers.indexOf('date');
    const litreCol = headers.findIndex(v => v.includes('litre'));
    const montantCol = headers.findIndex(v => v.includes('montant'));
    const lienCol = headers.findIndex(v => v === 'lien');

    for (let r = hRow + 1; r < grid.length; r++) {
      const row = grid[r] || [];
      const log_date = parseDate(row[dateCol]);
      const liters = toFloat(row[litreCol]);
      const montant_ar = toInt(row[montantCol]);
      const lien = lienCol >= 0 && row[lienCol] ? String(row[lienCol]).trim() : null;

      if (!log_date && liters === null && montant_ar === null && !lien) continue;
      if (!log_date) continue;
      out.push({
        log_date,
        liters,
        montant_ar,
        lien,
        source_file_name: fileName,
        sheet_name: sheetName,
        row_in_sheet: r + 1
      });
    }
  }

  return { records: out };
}

module.exports = { parseOtherWorkbook };


────────────────── server/src/utils/asyncHandler.js ──────────────────
module.exports = function asyncHandler(fn) {
  return (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};


────────────────── server/src/utils/excel/parseUtils.js ──────────────────
const XLSX = require('xlsx');

function norm(s) {
  return String(s ?? '')
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/\p{Diacritic}/gu, '');
}

function parseNumber(v) {
  if (v === null || v === undefined || v === '') return null;

  // ✅ IMPORTANT: une Date ne doit JAMAIS devenir un nombre (timestamp ms)
  // sinon ça finit en 1738529964000 et ça casse l'insert int4.
  if (v instanceof Date) return null;

  if (typeof v === 'number') {
    if (!Number.isFinite(v)) return null;
    return v;
  }

  const s = String(v).trim();
  if (!s) return null;

  // remove non-breaking spaces, thin spaces
  const cleaned = s
    .replace(/\u00a0/g, ' ')
    .replace(/\s+/g, ' ')
    .replace(/ /g, '')
    .replace(/,/g, '.');

  const n = Number(cleaned);
  if (!Number.isFinite(n)) return null;
  return n;
}

function toInt(v) {
  const n = parseNumber(v);
  if (n === null) return null;
  const i = Math.trunc(n);

  // ✅ sécurité PostgreSQL int4
  if (i > 2147483647 || i < -2147483648) return null;

  return i;
}

function toFloat(v) {
  const n = parseNumber(v);
  if (n === null) return null;
  return Number(n);
}

function excelDateToJS(excelSerial) {
  // Excel 1900 system
  const d = XLSX.SSF.parse_date_code(excelSerial);
  if (!d) return null;
  // months are 1-based
  return new Date(Date.UTC(d.y, d.m - 1, d.d));
}

// ✅ vrai check calendrier
function isValidYMD(yyyy, mm, dd) {
  const y = Number(yyyy), m = Number(mm), d = Number(dd);
  if (!y || m < 1 || m > 12 || d < 1 || d > 31) return false;
  const dt = new Date(Date.UTC(y, m - 1, d));
  return (
    dt.getUTCFullYear() === y &&
    (dt.getUTCMonth() + 1) === m &&
    dt.getUTCDate() === d
  );
}

function parseDate(v) {
  if (v === null || v === undefined || v === '') return null;

  /**
   * ✅ Correctif TIMEZONE :
   * Si XLSX (ou autre) nous donne déjà un objet Date, on le lit en UTC
   * pour éviter le décalage qui peut transformer 2024-01-01 en 2023-12-31
   * selon le fuseau horaire du serveur.
   */
  if (v instanceof Date) {
    const yyyy = v.getUTCFullYear();
    const mm = String(v.getUTCMonth() + 1).padStart(2, '0');
    const dd = String(v.getUTCDate()).padStart(2, '0');
    if (!isValidYMD(yyyy, mm, dd)) return null;
    return `${yyyy}-${mm}-${dd}`;
  }

  // Excel serial date (nombre)
  if (typeof v === 'number') {
    const d = excelDateToJS(v);
    if (!d) return null;
    const yyyy = d.getUTCFullYear();
    const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
    const dd = String(d.getUTCDate()).padStart(2, '0');
    if (!isValidYMD(yyyy, mm, dd)) return null;
    return `${yyyy}-${mm}-${dd}`;
  }

  const s = String(v).trim();
  if (!s) return null;

  // dd/mm/yyyy
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) {
    const dd = String(m[1]).padStart(2, '0');
    const mm = String(m[2]).padStart(2, '0');
    const yyyy = m[3];
    if (!isValidYMD(yyyy, mm, dd)) return null;
    return `${yyyy}-${mm}-${dd}`;
  }

  // yyyy-mm-dd
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m2) {
    const [_, yyyy, mm, dd] = m2;
    if (!isValidYMD(yyyy, mm, dd)) return null;
    return s;
  }

  return null;
}

function sheetTo2D(sheet) {
  return XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null, raw: true });
}

module.exports = { norm, parseNumber, toInt, toFloat, parseDate, sheetTo2D, excelDateToJS, isValidYMD };


────────────────── server/src/utils/excel/parseVehicleFuel.js ──────────────────
const { norm, toInt, toFloat, parseDate, sheetTo2D } = require('./parseUtils');

function extractPlateFromFileName(name) {
  const m = String(name || '').toUpperCase().match(/(\d{5}\s*WWT)/);
  if (m) return m[1].replace(/\s+/g, '');
  return null;
}

function extractPlateFromGrid(grid) {
  for (let r = 0; r < Math.min(grid.length, 12); r++) {
    for (let c = 0; c < Math.min((grid[r] || []).length, 12); c++) {
      const v = grid[r][c];
      const s = String(v || '').toUpperCase();
      const m = s.match(/(\d{5}WWT)/);
      if (m) return m[1];
    }
  }
  return null;
}

function findHeaderRow(grid) {
  for (let r = 0; r < Math.min(grid.length, 60); r++) {
    const row = (grid[r] || []).map(norm);
    const hasDate = row.some(x => x === 'date');
    const hasKm = row.some(x => x.includes('kilometrage'));
    const hasKmJour = row.some(x => x.includes('kmjourn') || (x.includes('km') && x.includes('journal')));
    if (hasDate && hasKm && hasKmJour) return r;
  }
  return -1;
}

function indexOfHeader(rowNorm, predicate) {
  for (let i = 0; i < rowNorm.length; i++) {
    if (predicate(rowNorm[i])) return i;
  }
  return -1;
}

function isMissionRow(row) {
  return row.some(v => norm(v) === 'mission');
}

// ✅ safe get cell
function getCell(row, idx) {
  if (!row || idx === null || idx === undefined || idx < 0) return null;
  return row[idx];
}

function parseSheet(sheetName, grid, fileName) {
  const headerRow = findHeaderRow(grid);
  if (headerRow < 0) return [];

  const h1 = (grid[headerRow] || []).map(norm);
  const h2 = (grid[headerRow + 1] || []).map(norm);
  const hasSub = h2.some(v => v === 'depart') && h2.some(v => v === 'arrivee');

  const dateCol = indexOfHeader(h1, v => v === 'date');
  const kmGroupCol = indexOfHeader(h1, v => v.includes('kilometrage'));
  const kmJourCol = indexOfHeader(h1, v => v.includes('kmjourn') || (v.includes('km') && v.includes('journal')));
  const kmBetweenCol = indexOfHeader(h1, v => v.includes('entre') && v.includes('replein'));
  const consoCol = indexOfHeader(h1, v => v.includes('consomm'));
  const intervalCol = indexOfHeader(h1, v => v.includes('jours') && v.includes('interval'));
  const pleinGroupCol = indexOfHeader(h1, v => v === 'plein');
  const lienCol = indexOfHeader(h1, v => v === 'lien');
  const chauffeurCol = indexOfHeader(h1, v => v === 'chauffeur');
  const frnsCol = indexOfHeader(h1, v => v === 'frns' || v.includes('frns'));

  let kmDepartCol = -1;
  let kmArriveeCol = -1;
  let compteurCol = -1;
  let litreCol = -1;
  let montantCol = -1;

  if (hasSub) {
    kmDepartCol = indexOfHeader(h2, v => v === 'depart');
    kmArriveeCol = indexOfHeader(h2, v => v === 'arrivee');
    compteurCol = indexOfHeader(h2, v => v === 'compteur');
    litreCol = indexOfHeader(h2, v => v === 'litre' || v === 'litres');
    montantCol = indexOfHeader(h2, v => v.includes('montant'));
  } else {
    // common layout where km depart/arrivee are right after the Kilométrage merged cell
    if (kmGroupCol >= 0) {
      kmDepartCol = kmGroupCol;
      kmArriveeCol = kmGroupCol + 1;
    }
    // plein group: 3 columns after 'Plein'
    if (pleinGroupCol >= 0) {
      compteurCol = pleinGroupCol;
      litreCol = pleinGroupCol + 1;
      montantCol = pleinGroupCol + 2;
    }
  }

  // ✅ Guard colonnes critiques : stop avant d'aller lire row[-1]
  const must = [
    ['dateCol', dateCol],
    ['kmDepartCol', kmDepartCol],
    ['kmArriveeCol', kmArriveeCol],
    ['compteurCol', compteurCol],
    ['litreCol', litreCol],
    ['montantCol', montantCol],
  ];
  const missing = must.filter(([_, idx]) => idx === -1).map(([name]) => name);
  if (missing.length) {
    throw new Error(`MISSING_COLUMNS:${missing.join(',')}:sheet=${sheetName}`);
  }

  const startRow = headerRow + (hasSub ? 2 : 1);
  const out = [];
  let emptyStreak = 0;

  for (let r = startRow; r < grid.length; r++) {
    const row = grid[r] || [];
    const hasAny = row.some(v => v !== null && v !== undefined && String(v).trim() !== '');
    if (!hasAny) {
      emptyStreak += 1;
      if (emptyStreak >= 15) break;
      continue;
    }
    emptyStreak = 0;

    if (isMissionRow(row)) {
      const label = row
        .filter(v => typeof v === 'string' && norm(v) !== 'mission')
        .join(' ')
        .trim() || null;

      out.push({
        sheet_name: sheetName,
        source_file_name: fileName,
        row_in_sheet: r + 1,
        is_mission: true,
        mission_label: label
      });
      continue;
    }

    const log_date = parseDate(getCell(row, dateCol));
    const day_name = typeof getCell(row, 0) === 'string' ? String(getCell(row, 0)).trim() : null;
    const day_no = toInt(getCell(row, 1));

    const km_depart = toInt(getCell(row, kmDepartCol));
    const km_arrivee = toInt(getCell(row, kmArriveeCol));
    const km_jour = toInt(getCell(row, kmJourCol));
    const km_between_refill = toInt(getCell(row, kmBetweenCol));
    const consumption = toFloat(getCell(row, consoCol));
    const interval_days = toInt(getCell(row, intervalCol));

    const compteur = toInt(getCell(row, compteurCol));
    const liters = toFloat(getCell(row, litreCol));
    const montant_ar = toInt(getCell(row, montantCol));

    const lien = lienCol >= 0 ? (getCell(row, lienCol) ? String(getCell(row, lienCol)).trim() : null) : null;
    const chauffeur = chauffeurCol >= 0 ? (getCell(row, chauffeurCol) ? String(getCell(row, chauffeurCol)).trim() : null) : null;
    const frns = frnsCol >= 0 ? (getCell(row, frnsCol) ? String(getCell(row, frnsCol)).trim() : null) : null;

    // skip weird rows without date and without km values
    if (!log_date && km_depart === null && km_arrivee === null && km_jour === null && montant_ar === null && liters === null) {
      continue;
    }

    const is_refill = montant_ar !== null && montant_ar >= 200000;

    out.push({
      sheet_name: sheetName,
      source_file_name: fileName,
      row_in_sheet: r + 1,
      log_date,
      day_name,
      day_no,
      km_depart,
      km_arrivee,
      km_jour,
      km_between_refill,
      consumption,
      interval_days,
      compteur,
      liters,
      montant_ar,
      lien,
      chauffeur,
      frns,
      is_refill,
      is_mission: false,
      mission_label: null
    });
  }

  return out;
}

function parseVehicleFuelWorkbook(workbook, originalName) {
  const fileName = originalName || 'upload.xlsx';
  const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
  const grid0 = sheetTo2D(firstSheet);
  const plate = extractPlateFromFileName(fileName) || extractPlateFromGrid(grid0) || null;

  const records = [];
  for (const sheetName of workbook.SheetNames) {
    const sheet = workbook.Sheets[sheetName];
    const grid = sheetTo2D(sheet);
    const recs = parseSheet(sheetName, grid, fileName);
    records.push(...recs);
  }

  return { plate, records };
}

module.exports = { parseVehicleFuelWorkbook };


────────────────── client/src/components/animatedSidebar.css ──────────────────
@import url("https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap");

:root {
  --asb-primary: #763fee;
  --asb-secondary: #f7f7fb;
  --asb-text: #ffffff;

  --asb-width-collapsed: 80px;
  --asb-width-expanded: 260px;

  --asb-item-height: 56px;
  --asb-indicator-curve-size: 50px;
}

/* Container Principal */
.asb-sidebar {
  position: fixed;
  top: 16px;
  left: 16px;
  bottom: 16px;

  width: var(--asb-width-collapsed);
  height: calc(100vh - 32px);

  background: var(--asb-primary);
  border-radius: 20px;
  padding: 20px 0;

  overflow: visible; /* nécessaire pour le toggle qui dépasse */
  display: flex;
  flex-direction: column;

  z-index: 1000;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);

  /* ✅ perf sans couper le toggle */
  transform: translateZ(0);
  will-change: width;
  transition: width 0.24s cubic-bezier(0.22, 0.61, 0.36, 1);
}

.asb-sidebar.active {
  width: var(--asb-width-expanded);
}

/* Bouton Toggle */
.asb-toggle {
  position: absolute;
  top: 40px;
  right: -18px;

  width: 36px;
  height: 36px;

  background-color: var(--asb-primary);
  border: 4px solid var(--asb-secondary);
  border-radius: 50%;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
  color: #fff;
  z-index: 1001;
  font-size: 20px;

  transition: transform 0.24s cubic-bezier(0.22, 0.61, 0.36, 1);
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);

  will-change: transform;
}

.asb-sidebar.active .asb-toggle {
  transform: rotate(180deg);
}

/* Liste des menus */
.asb-menu-list {
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 10px;

  margin-top: 40px;
  padding-left: 10px;

  flex-grow: 1;
  overflow-y: auto;
  overflow-x: hidden;

  /* perf */
  contain: paint;
  overscroll-behavior: contain;

  scrollbar-width: none;
  -ms-overflow-style: none;
}

.asb-menu-list::-webkit-scrollbar {
  display: none;
}

/* Item (NavLink) */
.asb-item {
  position: relative;
  z-index: 2;
  display: block;
  list-style: none;
}

/* Link intérieur */
.asb-link {
  position: relative;
  display: flex;
  align-items: center;
  height: var(--asb-item-height);

  color: var(--asb-text);
  border-top-left-radius: 30px;
  border-bottom-left-radius: 30px;

  padding-left: 10px;

  transition: background-color .15s ease, color .15s ease;
}

/* Icon */
.asb-icon {
  min-width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
}

/* Text */
.asb-text {
  white-space: nowrap;
  font-family: "Poppins", sans-serif;
  font-weight: 500;
  font-size: 12px;
  margin-left: 15px;

  opacity: 0;
  visibility: hidden;
  transition: opacity 0s;
}

.asb-sidebar.active .asb-text {
  opacity: 1;
  visibility: visible;
  transition: opacity 0.18s ease 0.08s;
}

/* Active */
.asb-item.active .asb-link {
  color: var(--asb-primary);
}

/* Indicateur */
.asb-indicator {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: var(--asb-item-height);

  background: var(--asb-secondary);
  border-top-left-radius: 30px;
  border-bottom-left-radius: 30px;

  z-index: 1;
  opacity: 1;
  pointer-events: none;

  transition: transform 0.24s ease;
  will-change: transform;
  transform: translate3d(0,0,0);
}

.asb-indicator::before,
.asb-indicator::after {
  content: "";
  position: absolute;
  right: 0;
  width: var(--asb-indicator-curve-size);
  height: var(--asb-indicator-curve-size);
  background: var(--asb-primary);
  box-shadow: 15px 15px 0 var(--asb-secondary);
}

.asb-indicator::before {
  top: calc(-1 * var(--asb-indicator-curve-size));
  border-bottom-right-radius: 25px;
}

.asb-indicator::after {
  bottom: calc(-1 * var(--asb-indicator-curve-size));
  border-top-right-radius: 25px;
  box-shadow: 15px -15px 0 var(--asb-secondary);
}

/* Logo */
.asb-logo {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 0 18px;
  margin-bottom: 14px;
  min-height: 48px;
}

.asb-logo-icon {
  width: 42px;
  height: 42px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.16);
  color: #fff;
  font-size: 22px;
}

.asb-logo-text {
  font-family: "Poppins", sans-serif;
  font-weight: 800;
  color: #fff;
  letter-spacing: .3px;

  opacity: 0;
  transform: translateX(-6px);
  visibility: hidden;

  transition: opacity .18s ease, transform .18s ease;
  will-change: transform, opacity;
}

.asb-sidebar.active .asb-logo-text {
  opacity: 1;
  transform: translateX(0);
  visibility: visible;
}

/* Footer */
.asb-footer{
  padding-bottom: 8px;
}

.asb-footer .asb-link {
  width: 100%;
  display: flex;
  justify-content: center; /* ou flex-start si tu veux aligner à gauche */
  align-items: center;
}

/* ✅ Bouton logout : neutralise les styles globaux button{} */
.asb-logout{
  background: transparent;
  border: 0;
  cursor: pointer;
  font: inherit;
  color: inherit;

  /* On enlève le padding top/right/bottom du button
     sans toucher le padding-left déjà géré par .asb-link */
  padding-top: 0;
  padding-right: 0;
  padding-bottom: 0;
}
/* optionnel : enlève le style bouton natif */
.asb-logout:focus{
  outline: none;
}
/* Mobile off-canvas via transform */
@media (max-width: 768px){
  .asb-sidebar{
    width: var(--asb-width-expanded);
    left: 16px;
    transform: translate3d(-120%, 0, 0);
    transition: transform 0.24s cubic-bezier(0.22, 0.61, 0.36, 1);
    will-change: transform;
  }
  .asb-sidebar.mobile-open{
    transform: translate3d(0, 0, 0);
  }
  .asb-sidebar.mobile-open .asb-toggle{
    display: none;
  }
}

/* Overlay mobile */
.asb-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 900;
  transition: opacity .18s ease;
}

/* PERF: pendant anim sidebar, coupe blur global */
.sidebar-animating .topbar { backdrop-filter: none !important; }

@media (prefers-reduced-motion: reduce){
  .asb-sidebar,
  .asb-toggle,
  .asb-sidebar.mobile-open,
  .asb-indicator{
    transition: none !important;
  }
}


────────────────── server/src/routes/fuel.js ──────────────────
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/fuelController');

const router = express.Router();
router.use(authRequired);

// Lists
router.get('/vehicle', asyncHandler(ctrl.listVehicleFuel));
router.get('/generator', asyncHandler(ctrl.listGeneratorFuel));
router.get('/other', asyncHandler(ctrl.listOtherFuel));

// Manual add (LOGISTIQUE / ADMIN)
router.post('/vehicle', asyncHandler(ctrl.manualAddVehicle));
router.post('/generator', asyncHandler(ctrl.manualAddGenerator));
router.post('/other', asyncHandler(ctrl.manualAddOther));

// ========== CRUD: UPDATE & SOFT DELETE (NOUVEAUX) ==========
router.put('/vehicle/:id', asyncHandler(ctrl.updateVehicleFuel));
router.delete('/vehicle/:id', asyncHandler(ctrl.softDeleteVehicleFuel));

router.put('/generator/:id', asyncHandler(ctrl.updateGeneratorFuel));
router.delete('/generator/:id', asyncHandler(ctrl.softDeleteGeneratorFuel));

router.put('/other/:id', asyncHandler(ctrl.updateOtherFuel));
router.delete('/other/:id', asyncHandler(ctrl.softDeleteOtherFuel));

// Exports (LOGISTIQUE / ADMIN)
router.get('/export/:type', asyncHandler(ctrl.exportCsv));

// Reports & KPIs
router.get('/report/summary', asyncHandler(ctrl.reportSummary));
router.get('/kpi/daily/bulk', asyncHandler(ctrl.kpiDailyBulk));
router.get('/kpi/daily', asyncHandler(ctrl.kpiDaily));
router.get('/kpi/by-vehicle', asyncHandler(ctrl.kpiByVehicle));

module.exports = router;

────────────────── server/src/middleware/auth.js ──────────────────
const jwt = require('jsonwebtoken');

function authRequired(req, res, next) {
  const header = req.headers.authorization || '';
  const [type, token] = header.split(' ');
  if (type !== 'Bearer' || !token) {
    return res.status(401).json({ error: 'UNAUTHORIZED' });
  }
  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    req.user = payload;
    return next();
  } catch (e) {
    return res.status(401).json({ error: 'INVALID_TOKEN' });
  }
}

function requireRole(...allowed) {
  return (req, res, next) => {
    const role = req.user?.role;
    if (!role || !allowed.includes(role)) {
      return res.status(403).json({ error: 'FORBIDDEN' });
    }
    return next();
  };
}

module.exports = { authRequired, requireRole };


────────────────── server/src/routes/carRequests.js ──────────────────
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/carRequestsController');

const router = express.Router();
router.use(authRequired);

router.get('/', asyncHandler(ctrl.list));
router.get('/:id', asyncHandler(ctrl.getOne));
router.post('/', asyncHandler(ctrl.create));
router.put('/:id', asyncHandler(ctrl.update));

// Preferred endpoints (used by client)
router.post('/:id/visa', asyncHandler(ctrl.logisticsApprove));
router.post('/:id/approve', asyncHandler(ctrl.rafApprove));
router.post('/:id/reject', asyncHandler(ctrl.reject));

// Legacy/alt endpoints
router.patch('/:id/logistics-approve', asyncHandler(ctrl.logisticsApprove));
router.patch('/:id/raf-approve', asyncHandler(ctrl.rafApprove));
router.patch('/:id/reject', asyncHandler(ctrl.reject));

// Corbeille (soft delete)
router.delete('/:id', asyncHandler(ctrl.softDelete));

module.exports = router;


────────────────── server/src/routes/auth.js ──────────────────
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const { register, login, forgotPassword, resetPassword, me, ROLES } = require('../controllers/authController');

const router = express.Router();

router.get('/roles', (req, res) => res.json({ roles: ROLES }));
router.post('/register', asyncHandler(register));
router.post('/login', asyncHandler(login));
router.post('/forgot', asyncHandler(forgotPassword));
router.post('/reset', asyncHandler(resetPassword));
router.get('/me', authRequired, asyncHandler(me));

module.exports = router;


────────────────── client/src/App.jsx ──────────────────
import React from 'react';
import { Navigate, Route, Routes } from 'react-router-dom';
import { AuthProvider } from './auth/AuthContext.jsx';
import { ToastProvider } from './components/ToastContext.jsx';
import ProtectedRoute from './components/ProtectedRoute.jsx';
import Layout from './components/Layout.jsx';

import Login from './pages/Login.jsx';
import Forgot from './pages/Forgot.jsx';
import Reset from './pages/Reset.jsx';

import Dashboard from './pages/Dashboard.jsx';
import Fuel from './pages/Fuel.jsx';
import ImportExcel from './pages/ImportExcel.jsx';
import FuelRequests from './pages/FuelRequests.jsx';
import CarRequests from './pages/CarRequests.jsx';
import CalendarView from './pages/CalendarView.jsx';
import Logbooks from './pages/Logbooks.jsx';
import LogbookEdit from './pages/LogbookEdit.jsx';
import PrintFuelRequest from './pages/PrintFuelRequest.jsx';
import PrintCarRequest from './pages/PrintCarRequest.jsx';
import PrintLogbook from './pages/PrintLogbook.jsx';
import Meta from './pages/Meta.jsx';
import Trash from './pages/Trash.jsx';
import Users from './pages/Users.jsx'; // <--- IMPORT NÉCESSAIRE

export default function App() {
  return (
    <AuthProvider>
      <ToastProvider>
      <Routes>
        <Route path="/" element={<Navigate to="/login" replace />} />
        <Route path="/login" element={<Login />} />
        {/* On retire /register pour la sécurité, ou on le garde pour dev uniquement */}
        <Route path="/forgot" element={<Forgot />} />
        <Route path="/reset" element={<Reset />} />

        {/* Print routes */}
        <Route path="/print/fuel/:id" element={
          <ProtectedRoute>
            <PrintFuelRequest />
          </ProtectedRoute>
        } />
        <Route path="/print/car/:id" element={
          <ProtectedRoute>
            <PrintCarRequest />
          </ProtectedRoute>
        } />
        <Route path="/print/logbook/:id" element={
          <ProtectedRoute>
            <PrintLogbook />
          </ProtectedRoute>
        } />

        <Route path="/app" element={
          <ProtectedRoute>
            <Layout><Dashboard /></Layout>
          </ProtectedRoute>
        } />
        
        {/* --- CORRECTION: Route Users ajoutée --- */}
        <Route path="/app/users" element={
          <ProtectedRoute roles={['ADMIN']}>
            <Layout><Users /></Layout>
          </ProtectedRoute>
        } />
        {/* --------------------------------------- */}

        <Route path="/app/fuel" element={
          <ProtectedRoute>
            <Layout><Fuel /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/import" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE']}>
            <Layout><ImportExcel /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/fuel" element={
          <ProtectedRoute>
            <Layout><FuelRequests /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/fuel/manage" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE']}>
            <Layout><FuelRequests /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/fuel/raf" element={
          <ProtectedRoute roles={['ADMIN','RAF']}>
            <Layout><FuelRequests /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/car" element={
          <ProtectedRoute>
            <Layout><CarRequests /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/car/manage" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE']}>
            <Layout><CarRequests /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/car/raf" element={
          <ProtectedRoute roles={['ADMIN','RAF']}>
            <Layout><CarRequests /></Layout>
          </ProtectedRoute>
        } />

        <Route path="/app/calendar" element={
          <ProtectedRoute>
            <Layout><CalendarView /></Layout>
          </ProtectedRoute>
        } />

        <Route path="/app/meta" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE']}>
            <Layout><Meta /></Layout>
          </ProtectedRoute>
        } />

        <Route path="/app/trash" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE']}>
            <Layout><Trash /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/logbooks" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE','RAF']}>
            <Layout><Logbooks /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/logbooks/:id" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE','RAF']}>
            <Layout><LogbookEdit /></Layout>
          </ProtectedRoute>
        } />

        <Route path="*" element={<Navigate to="/login" replace />} />
      </Routes>
      </ToastProvider>
    </AuthProvider>
  );
}

────────────────── server/src/index.js ──────────────────
require('dotenv').config();

const express = require('express');
const cors = require('cors');
const path = require('path');
const fs = require('fs');

// Routes
const authRoutes = require('./routes/auth');
const metaRoutes = require('./routes/meta');
const fuelRoutes = require('./routes/fuel');
const importRoutes = require('./routes/import');
const fuelRequestsRoutes = require('./routes/fuelRequests');
const carRequestsRoutes = require('./routes/carRequests');
const logbooksRoutes = require('./routes/logbooks');
const trashRoutes = require('./routes/trash');
const notificationsRoutes = require('./routes/notifications');
const usersRoutes = require('./routes/users'); // <--- AJOUT

const app = express();
const corsOptions = {
  origin: process.env.CLIENT_URL || true, 
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS']
};
app.use(cors(corsOptions));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Health Check
app.get('/api/health', (req, res) => res.json({ status: 'ok', uptime: process.uptime() }));

// API Routes
app.use('/api/auth', authRoutes);
app.use('/api/meta', metaRoutes);
app.use('/api/fuel', fuelRoutes);
app.use('/api/import', importRoutes);
app.use('/api/requests/fuel', fuelRequestsRoutes);
app.use('/api/requests/car', carRequestsRoutes);
app.use('/api/logbooks', logbooksRoutes);
app.use('/api/trash', trashRoutes);
app.use('/api/notifications', notificationsRoutes);
app.use('/api/users', usersRoutes); // <--- AJOUT

// Serve Static Files (Production / Docker)
const publicDir = path.join(__dirname, '..', 'public');
const publicIndex = path.join(publicDir, 'index.html');
if (fs.existsSync(publicIndex)) {
  app.use(express.static(publicDir));
  app.get(/^\/(?!api).*/, (req, res) => res.sendFile(publicIndex));
}

// 404 Handler
app.use('/api/*', (req, res) => {
  res.status(404).json({ error: 'NOT_FOUND', message: 'Endpoint not found' });
});

// Global Error Handler
app.use((err, req, res, next) => {
  console.error('[SERVER ERROR]', err);

  if (res.headersSent) {
    return next(err);
  }

  if (err.code === 'LIMIT_FILE_SIZE') {
    return res.status(400).json({ error: 'FILE_TOO_LARGE', message: 'Fichier trop volumineux (max 10MB)' });
  }

  const status = err.statusCode || 500;
  const message = err.message || 'Internal Server Error';
  
  res.status(status).json({ 
    error: err.name || 'SERVER_ERROR', 
    message: message,
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
});

const port = Number(process.env.PORT || 3001);
app.listen(port, () => {
  console.log(`🚀 Server running on port ${port}`);
  console.log(`🌍 Environment: ${process.env.NODE_ENV || 'development'}`);
});

────────────────── server/src/db.js ──────────────────
/**
 * ────────────────── server/src/controllers/db.js ──────────────────
 * CORRECTIF APPLIQUÉ :
 * 1) Gestion des erreurs inattendues sur le pool (anti-crash).
 * 2) IMPORTANT : Forcer PostgreSQL DATE (OID 1082) à rester une string "YYYY-MM-DD"
 *    (évite les décalages et le format ...T21:00:00.000Z dans le JSON).
 */
const { Pool, types } = require('pg');

const connectionString = process.env.DATABASE_URL;

if (!connectionString) {
  throw new Error('DATABASE_URL is required in .env');
}

/**
 * ✅ Fix DATE Postgres :
 * OID 1082 = DATE
 * On force la sortie en STRING "YYYY-MM-DD" (pas de Date JS).
 */
types.setTypeParser(1082, (val) => val);

// Configuration recommandée pour la prod (SSL si besoin)
const pool = new Pool({
  connectionString,
  // max: 20, // (Optionnel) Limite de connexions simultanées
  // idleTimeoutMillis: 30000
});

// IMPORTANT : Capture les erreurs sur les clients inactifs pour éviter le crash du serveur
pool.on('error', (err, client) => {
  console.error('❌ Unexpected error on idle client', err);
  // Ne pas exit(-1) ici, on laisse le pool essayer de se reconnecter
});

module.exports = { pool };


────────────────── server/src/routes/users.js ──────────────────
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired, requireRole } = require('../middleware/auth');
const ctrl = require('../controllers/usersController');

const router = express.Router();

router.use(authRequired);
router.use(requireRole('ADMIN')); // Seul l'admin accède ici

router.get('/', asyncHandler(ctrl.list));
router.post('/', asyncHandler(ctrl.create));
router.put('/:id', asyncHandler(ctrl.update));

module.exports = router;

────────────────── server/src/routes/trash.js ──────────────────
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired, requireRole } = require('../middleware/auth');
const ctrl = require('../controllers/trashController');

const router = express.Router();
router.use(authRequired);
router.use(requireRole('ADMIN', 'LOGISTIQUE'));

router.get('/:entity', asyncHandler(ctrl.list));
router.post('/:entity/:id/restore', asyncHandler(ctrl.restore));
router.delete('/:entity/:id/hard', asyncHandler(ctrl.hardDelete));

module.exports = router;


────────────────── client/src/auth/AuthContext.jsx ──────────────────
import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';

const AuthContext = createContext(null);

const LS_KEY = 'prirtem_auth';

export function AuthProvider({ children }) {
  const [token, setToken] = useState(null);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed?.token) setToken(parsed.token);
        if (parsed?.user) setUser(parsed.user);
      }
    } catch {
      // ignore
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    if (!token) return;
    // refresh me (best effort)
    apiFetch('/api/auth/me', { token })
      .then((d) => {
        if (d?.user) {
          setUser(d.user);
          localStorage.setItem(LS_KEY, JSON.stringify({ token, user: d.user }));
        }
      })
      .catch((err) => {
        // Token may be expired or invalid (e.g. after DB reset / JWT_SECRET change)
        if (err?.status === 401) {
          setToken(null);
          setUser(null);
          localStorage.removeItem(LS_KEY);
        }
      });
  }, [token]);

  const value = useMemo(() => {
    return {
      token,
      user,
      loading,
      isAuthed: !!token,
      login: (tokenNew, userNew) => {
        setToken(tokenNew);
        setUser(userNew);
        localStorage.setItem(LS_KEY, JSON.stringify({ token: tokenNew, user: userNew }));
      },
      // Backward-compat: older pages call setSession(token,user)
      setSession: (tokenNew, userNew) => {
        setToken(tokenNew);
        setUser(userNew);
        localStorage.setItem(LS_KEY, JSON.stringify({ token: tokenNew, user: userNew }));
      },
      logout: () => {
        setToken(null);
        setUser(null);
        localStorage.removeItem(LS_KEY);
      }
    };
  }, [token, user, loading]);

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
}

export function useAuth() {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error('useAuth must be used inside AuthProvider');
  return ctx;
}


────────────────── server/src/routes/notifications.js ──────────────────
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/notificationsController');

const router = express.Router();
router.use(authRequired);

router.get('/', asyncHandler(ctrl.getNotifications));
router.post('/:id/read', asyncHandler(ctrl.markAsRead));

module.exports = router;

────────────────── server/src/routes/meta.js ──────────────────
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired, requireRole } = require('../middleware/auth');
const { listVehicles, createVehicle, updateVehicle, deleteVehicle, listDrivers, createDriver, updateDriver, deleteDriver } = require('../controllers/metaController');

const router = express.Router();

router.use(authRequired);
router.get('/vehicles', asyncHandler(listVehicles));
router.post('/vehicles', requireRole('LOGISTIQUE','ADMIN'), asyncHandler(createVehicle));
router.put('/vehicles/:id', requireRole('LOGISTIQUE','ADMIN'), asyncHandler(updateVehicle));
router.delete('/vehicles/:id', requireRole('LOGISTIQUE','ADMIN'), asyncHandler(deleteVehicle));

router.get('/drivers', asyncHandler(listDrivers));
router.post('/drivers', requireRole('LOGISTIQUE', 'ADMIN'), asyncHandler(createDriver));
router.put('/drivers/:id', requireRole('LOGISTIQUE', 'ADMIN'), asyncHandler(updateDriver));
router.delete('/drivers/:id', requireRole('LOGISTIQUE', 'ADMIN'), asyncHandler(deleteDriver));

module.exports = router;


────────────────── server/src/routes/logbooks.js ──────────────────
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/logbooksController');

const router = express.Router();
router.use(authRequired);

router.get('/', asyncHandler(ctrl.list));
router.post('/', asyncHandler(ctrl.create));
router.get('/:id', asyncHandler(ctrl.getOne));
router.put('/:id', asyncHandler(ctrl.update));
router.put('/:id/trips', asyncHandler(ctrl.replaceTrips));
router.put('/:id/supplies', asyncHandler(ctrl.replaceSupplies));
router.patch('/:id/submit', asyncHandler(ctrl.submit));
router.patch('/:id/lock', asyncHandler(ctrl.lock));

module.exports = router;


────────────────── server/src/routes/import.js ──────────────────
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/importController');

const router = express.Router();
router.use(authRequired);

router.post('/batch', asyncHandler(ctrl.createBatch));
router.get('/batches', asyncHandler(ctrl.listBatches));
router.get('/batches/:batch_id/files', asyncHandler(ctrl.listFiles));
router.post('/upload', ctrl.upload.array('files', 10), asyncHandler(ctrl.uploadAndImport));

module.exports = router;


────────────────── server/src/routes/fuelRequests.js ──────────────────
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/fuelRequestsController');

const router = express.Router();
router.use(authRequired);

router.get('/', asyncHandler(ctrl.list));
router.get('/:id', asyncHandler(ctrl.getOne));
router.post('/', asyncHandler(ctrl.create));
router.put('/:id', asyncHandler(ctrl.update));
router.patch('/:id/submit', asyncHandler(ctrl.submit));
router.patch('/:id/verify', asyncHandler(ctrl.verify));
router.patch('/:id/approve', asyncHandler(ctrl.approve));
router.patch('/:id/reject', asyncHandler(ctrl.reject));

// Corbeille (soft delete)
router.delete('/:id', asyncHandler(ctrl.softDelete));

module.exports = router;


────────────────── server/package.json ──────────────────
{
  "name": "prirtem-fuel-server",
  "version": "1.0.0",
  "private": true,
  "type": "commonjs",
  "main": "src/index.js",
  "scripts": {
    "dev": "node --watch src/index.js",
    "start": "node src/index.js",
    "db:reset": "node src/sql/reset.js",
    "db:seed": "node src/sql/seed.js"
  },
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "express-rate-limit": "^8.2.1",
    "helmet": "^8.1.0",
    "jsonwebtoken": "^9.0.2",
    "multer": "^1.4.5-lts.1",
    "nodemailer": "^6.9.14",
    "pg": "^8.12.0",
    "uuid": "^9.0.1",
    "xlsx": "^0.18.5",
    "zod": "^3.23.8"
  }
}


────────────────── server/package-lock.json ──────────────────
{
  "name": "prirtem-fuel-server",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "prirtem-fuel-server",
      "version": "1.0.0",
      "dependencies": {
        "bcryptjs": "^2.4.3",
        "cors": "^2.8.5",
        "dotenv": "^16.4.5",
        "express": "^4.19.2",
        "express-rate-limit": "^8.2.1",
        "helmet": "^8.1.0",
        "jsonwebtoken": "^9.0.2",
        "multer": "^1.4.5-lts.1",
        "nodemailer": "^6.9.14",
        "pg": "^8.12.0",
        "uuid": "^9.0.1",
        "xlsx": "^0.18.5",
        "zod": "^3.23.8"
      }
    },
    "node_modules/accepts": {
      "version": "1.3.8",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/accepts/-/accepts-1.3.8.tgz",
      "integrity": "sha512-PYAthTa2m2VKxuvSD3DPC/Gy+U+sOA1LAuT8mkmRuvw+NACSaeXEQ+NHcVF7rONl6qcaxV3Uuemwawk+7+SJLw==",
      "license": "MIT",
      "dependencies": {
        "mime-types": "~2.1.34",
        "negotiator": "0.6.3"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/adler-32": {
      "version": "1.3.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/adler-32/-/adler-32-1.3.1.tgz",
      "integrity": "sha512-ynZ4w/nUUv5rrsR8UUGoe1VC9hZj6V5hU9Qw1HlMDJGEJw5S7TfTErWTjMys6M7vr0YWcPqs3qAr4ss0nDfP+A==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/append-field": {
      "version": "1.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/append-field/-/append-field-1.0.0.tgz",
      "integrity": "sha512-klpgFSWLW1ZEs8svjfb7g4qWY0YS5imI82dTg+QahUvJ8YqAY0P10Uk8tTyh9ZGuYEZEMaeJYCF5BFuX552hsw==",
      "license": "MIT"
    },
    "node_modules/array-flatten": {
      "version": "1.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/array-flatten/-/array-flatten-1.1.1.tgz",
      "integrity": "sha512-PCVAQswWemu6UdxsDFFX/+gVeYqKAod3D3UVm91jHwynguOwAvYPhx8nNlM++NqRcK6CxxpUafjmhIdKiHibqg==",
      "license": "MIT"
    },
    "node_modules/bcryptjs": {
      "version": "2.4.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/bcryptjs/-/bcryptjs-2.4.3.tgz",
      "integrity": "sha512-V/Hy/X9Vt7f3BbPJEi8BdVFMByHi+jNXrYkW3huaybV/kQ0KJg0Y6PkEMbn+zeT+i+SiKZ/HMqJGIIt4LZDqNQ==",
      "license": "MIT"
    },
    "node_modules/body-parser": {
      "version": "1.20.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/body-parser/-/body-parser-1.20.4.tgz",
      "integrity": "sha512-ZTgYYLMOXY9qKU/57FAo8F+HA2dGX7bqGc71txDRC1rS4frdFI5R7NhluHxH6M0YItAP0sHB4uqAOcYKxO6uGA==",
      "license": "MIT",
      "dependencies": {
        "bytes": "~3.1.2",
        "content-type": "~1.0.5",
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "~1.2.0",
        "http-errors": "~2.0.1",
        "iconv-lite": "~0.4.24",
        "on-finished": "~2.4.1",
        "qs": "~6.14.0",
        "raw-body": "~2.5.3",
        "type-is": "~1.6.18",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8",
        "npm": "1.2.8000 || >= 1.4.16"
      }
    },
    "node_modules/buffer-equal-constant-time": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/buffer-equal-constant-time/-/buffer-equal-constant-time-1.0.1.tgz",
      "integrity": "sha512-zRpUiDwd/xk6ADqPMATG8vc9VPrkck7T07OIx0gnjmJAnHnTVXNQG3vfvWNuiZIkwu9KrKdA1iJKfsfTVxE6NA==",
      "license": "BSD-3-Clause"
    },
    "node_modules/buffer-from": {
      "version": "1.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/buffer-from/-/buffer-from-1.1.2.tgz",
      "integrity": "sha512-E+XQCRwSbaaiChtv6k6Dwgc+bx+Bs6vuKJHHl5kox/BaKbhiXzqQOwK4cO22yElGp2OCmjwVhT3HmxgyPGnJfQ==",
      "license": "MIT"
    },
    "node_modules/busboy": {
      "version": "1.6.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/busboy/-/busboy-1.6.0.tgz",
      "integrity": "sha512-8SFQbg/0hQ9xy3UNTB0YEnsNBbWfhf7RtnzpL7TkBiTBRfrQ9Fxcnz7VJsleJpyp6rVLvXiuORqjlHi5q+PYuA==",
      "dependencies": {
        "streamsearch": "^1.1.0"
      },
      "engines": {
        "node": ">=10.16.0"
      }
    },
    "node_modules/bytes": {
      "version": "3.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/bytes/-/bytes-3.1.2.tgz",
      "integrity": "sha512-/Nf7TyzTx6S3yRJObOAV7956r8cr2+Oj8AC5dt8wSP3BQAoeX58NoHyCU8P8zGkNXStjTSi6fzO6F0pBdcYbEg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/call-bind-apply-helpers": {
      "version": "1.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/call-bind-apply-helpers/-/call-bind-apply-helpers-1.0.2.tgz",
      "integrity": "sha512-Sp1ablJ0ivDkSzjcaJdxEunN5/XvksFJ2sMBFfq6x0ryhQV/2b/KwFe21cMpmHtPOSij8K99/wSfoEuTObmuMQ==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/call-bound": {
      "version": "1.0.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/call-bound/-/call-bound-1.0.4.tgz",
      "integrity": "sha512-+ys997U96po4Kx/ABpBCqhA9EuxJaQWDQg7295H4hBphv3IZg0boBKuwYpt4YXp6MZ5AmZQnU/tyMTlRpaSejg==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "get-intrinsic": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/cfb": {
      "version": "1.2.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/cfb/-/cfb-1.2.2.tgz",
      "integrity": "sha512-KfdUZsSOw19/ObEWasvBP/Ac4reZvAGauZhs6S/gqNhXhI7cKwvlH7ulj+dOEYnca4bm4SGo8C1bTAQvnTjgQA==",
      "license": "Apache-2.0",
      "dependencies": {
        "adler-32": "~1.3.0",
        "crc-32": "~1.2.0"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/codepage": {
      "version": "1.15.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/codepage/-/codepage-1.15.0.tgz",
      "integrity": "sha512-3g6NUTPd/YtuuGrhMnOMRjFc+LJw/bnMp3+0r/Wcz3IXUuCosKRJvMphm5+Q+bvTVGcJJuRvVLuYba+WojaFaA==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/concat-stream": {
      "version": "1.6.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/concat-stream/-/concat-stream-1.6.2.tgz",
      "integrity": "sha512-27HBghJxjiZtIk3Ycvn/4kbJk/1uZuJFfuPEns6LaEvpvG1f0hTea8lilrouyo9mVc2GWdcEZ8OLoGmSADlrCw==",
      "engines": [
        "node >= 0.8"
      ],
      "license": "MIT",
      "dependencies": {
        "buffer-from": "^1.0.0",
        "inherits": "^2.0.3",
        "readable-stream": "^2.2.2",
        "typedarray": "^0.0.6"
      }
    },
    "node_modules/content-disposition": {
      "version": "0.5.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/content-disposition/-/content-disposition-0.5.4.tgz",
      "integrity": "sha512-FveZTNuGw04cxlAiWbzi6zTAL/lhehaWbTtgluJh4/E95DqMwTmha3KZN1aAWA8cFIhHzMZUvLevkw5Rqk+tSQ==",
      "license": "MIT",
      "dependencies": {
        "safe-buffer": "5.2.1"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/content-type": {
      "version": "1.0.5",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/content-type/-/content-type-1.0.5.tgz",
      "integrity": "sha512-nTjqfcBFEipKdXCv4YDQWCfmcLZKm81ldF0pAopTvyrFGVbcR6P/VAAd5G7N+0tTr8QqiU0tFadD6FK4NtJwOA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/cookie": {
      "version": "0.7.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/cookie/-/cookie-0.7.2.tgz",
      "integrity": "sha512-yki5XnKuf750l50uGTllt6kKILY4nQ1eNIQatoXEByZ5dWgnKqbnqmTrBE5B4N7lrMJKQ2ytWMiTO2o0v6Ew/w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/cookie-signature": {
      "version": "1.0.7",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/cookie-signature/-/cookie-signature-1.0.7.tgz",
      "integrity": "sha512-NXdYc3dLr47pBkpUCHtKSwIOQXLVn8dZEuywboCOJY/osA0wFSLlSawr3KN8qXJEyX66FcONTH8EIlVuK0yyFA==",
      "license": "MIT"
    },
    "node_modules/core-util-is": {
      "version": "1.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/core-util-is/-/core-util-is-1.0.3.tgz",
      "integrity": "sha512-ZQBvi1DcpJ4GDqanjucZ2Hj3wEO5pZDS89BWbkcrvdxksJorwUDDZamX9ldFkp9aw2lmBDLgkObEA4DWNJ9FYQ==",
      "license": "MIT"
    },
    "node_modules/cors": {
      "version": "2.8.5",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/cors/-/cors-2.8.5.tgz",
      "integrity": "sha512-KIHbLJqu73RGr/hnbrO9uBeixNGuvSQjul/jdFvS/KFSIH1hWVd1ng7zOHx+YrEfInLG7q4n6GHQ9cDtxv/P6g==",
      "license": "MIT",
      "dependencies": {
        "object-assign": "^4",
        "vary": "^1"
      },
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/crc-32": {
      "version": "1.2.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/crc-32/-/crc-32-1.2.2.tgz",
      "integrity": "sha512-ROmzCKrTnOwybPcJApAA6WBWij23HVfGVNKqqrZpuyZOHqK2CwHSvpGuyt/UNNvaIjEd8X5IFGp4Mh+Ie1IHJQ==",
      "license": "Apache-2.0",
      "bin": {
        "crc32": "bin/crc32.njs"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "license": "MIT",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/depd": {
      "version": "2.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/depd/-/depd-2.0.0.tgz",
      "integrity": "sha512-g7nH6P6dyDioJogAAGprGpCtVImJhpPk/roCzdb3fIh61/s/nPsfR6onyMwkCAR/OlC3yBC0lESvUoQEAssIrw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/destroy": {
      "version": "1.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/destroy/-/destroy-1.2.0.tgz",
      "integrity": "sha512-2sJGJTaXIIaR1w4iJSNoN0hnMY7Gpc/n8D4qSCJw8QqFWXf7cuAgnEHxBpweaVcPevC2l3KpjYCx3NypQQgaJg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8",
        "npm": "1.2.8000 || >= 1.4.16"
      }
    },
    "node_modules/dotenv": {
      "version": "16.6.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/dotenv/-/dotenv-16.6.1.tgz",
      "integrity": "sha512-uBq4egWHTcTt33a72vpSG0z3HnPuIl6NqYcTrKEg2azoEyl2hpW0zqlxysq2pK9HlDIHyHyakeYaYnSAwd8bow==",
      "license": "BSD-2-Clause",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://dotenvx.com"
      }
    },
    "node_modules/dunder-proto": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/dunder-proto/-/dunder-proto-1.0.1.tgz",
      "integrity": "sha512-KIN/nDJBQRcXw0MLVhZE9iQHmG68qAVIBg9CqmUYjmQIhgij9U5MFvrqkUL5FbtyyzZuOeOt0zdeRe4UY7ct+A==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.1",
        "es-errors": "^1.3.0",
        "gopd": "^1.2.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/ecdsa-sig-formatter": {
      "version": "1.0.11",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ecdsa-sig-formatter/-/ecdsa-sig-formatter-1.0.11.tgz",
      "integrity": "sha512-nagl3RYrbNv6kQkeJIpt6NJZy8twLB/2vtz6yN9Z4vRKHN4/QZJIEbqohALSgwKdnksuY3k5Addp5lg8sVoVcQ==",
      "license": "Apache-2.0",
      "dependencies": {
        "safe-buffer": "^5.0.1"
      }
    },
    "node_modules/ee-first": {
      "version": "1.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ee-first/-/ee-first-1.1.1.tgz",
      "integrity": "sha512-WMwm9LhRUo+WUaRN+vRuETqG89IgZphVSNkdFgeb6sS/E4OrDIN7t48CAewSHXc6C8lefD8KKfr5vY61brQlow==",
      "license": "MIT"
    },
    "node_modules/encodeurl": {
      "version": "2.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/encodeurl/-/encodeurl-2.0.0.tgz",
      "integrity": "sha512-Q0n9HRi4m6JuGIV1eFlmvJB7ZEVxu93IrMyiMsGC0lrMJMWzRgx6WGquyfQgZVb31vhGgXnfmPNNXmxnOkRBrg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/es-define-property": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/es-define-property/-/es-define-property-1.0.1.tgz",
      "integrity": "sha512-e3nRfgfUZ4rNGL232gUgX06QNyyez04KdjFrF+LTRoOXmrOgFKDg4BCdsjW8EnT69eqdYGmRpJwiPVYNrCaW3g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-errors": {
      "version": "1.3.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/es-errors/-/es-errors-1.3.0.tgz",
      "integrity": "sha512-Zf5H2Kxt2xjTvbJvP2ZWLEICxA6j+hAmMzIlypy4xcBg1vKVnx89Wy0GbS+kf5cwCVFFzdCFh2XSCFNULS6csw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-object-atoms": {
      "version": "1.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/es-object-atoms/-/es-object-atoms-1.1.1.tgz",
      "integrity": "sha512-FGgH2h8zKNim9ljj7dankFPcICIK9Cp5bm+c2gQSYePhpaG5+esrLODihIorn+Pe6FGJzWhXQotPv73jTaldXA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/escape-html": {
      "version": "1.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/escape-html/-/escape-html-1.0.3.tgz",
      "integrity": "sha512-NiSupZ4OeuGwr68lGIeym/ksIZMJodUGOSCZ/FSnTxcrekbvqrgdUxlJOMpijaKZVjAJrWrGs/6Jy8OMuyj9ow==",
      "license": "MIT"
    },
    "node_modules/etag": {
      "version": "1.8.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/etag/-/etag-1.8.1.tgz",
      "integrity": "sha512-aIL5Fx7mawVa300al2BnEE4iNvo1qETxLrPI/o05L7z6go7fCw1J6EQmbK4FmJ2AS7kgVF/KEZWufBfdClMcPg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/express": {
      "version": "4.22.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/express/-/express-4.22.1.tgz",
      "integrity": "sha512-F2X8g9P1X7uCPZMA3MVf9wcTqlyNp7IhH5qPCI0izhaOIYXaW9L535tGA3qmjRzpH+bZczqq7hVKxTR4NWnu+g==",
      "license": "MIT",
      "dependencies": {
        "accepts": "~1.3.8",
        "array-flatten": "1.1.1",
        "body-parser": "~1.20.3",
        "content-disposition": "~0.5.4",
        "content-type": "~1.0.4",
        "cookie": "~0.7.1",
        "cookie-signature": "~1.0.6",
        "debug": "2.6.9",
        "depd": "2.0.0",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "finalhandler": "~1.3.1",
        "fresh": "~0.5.2",
        "http-errors": "~2.0.0",
        "merge-descriptors": "1.0.3",
        "methods": "~1.1.2",
        "on-finished": "~2.4.1",
        "parseurl": "~1.3.3",
        "path-to-regexp": "~0.1.12",
        "proxy-addr": "~2.0.7",
        "qs": "~6.14.0",
        "range-parser": "~1.2.1",
        "safe-buffer": "5.2.1",
        "send": "~0.19.0",
        "serve-static": "~1.16.2",
        "setprototypeof": "1.2.0",
        "statuses": "~2.0.1",
        "type-is": "~1.6.18",
        "utils-merge": "1.0.1",
        "vary": "~1.1.2"
      },
      "engines": {
        "node": ">= 0.10.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/express"
      }
    },
    "node_modules/express-rate-limit": {
      "version": "8.2.1",
      "resolved": "https://registry.npmjs.org/express-rate-limit/-/express-rate-limit-8.2.1.tgz",
      "integrity": "sha512-PCZEIEIxqwhzw4KF0n7QF4QqruVTcF73O5kFKUnGOyjbCCgizBBiFaYpd/fnBLUMPw/BWw9OsiN7GgrNYr7j6g==",
      "dependencies": {
        "ip-address": "10.0.1"
      },
      "engines": {
        "node": ">= 16"
      },
      "funding": {
        "url": "https://github.com/sponsors/express-rate-limit"
      },
      "peerDependencies": {
        "express": ">= 4.11"
      }
    },
    "node_modules/finalhandler": {
      "version": "1.3.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/finalhandler/-/finalhandler-1.3.2.tgz",
      "integrity": "sha512-aA4RyPcd3badbdABGDuTXCMTtOneUCAYH/gxoYRTZlIJdF0YPWuGqiAsIrhNnnqdXGswYk6dGujem4w80UJFhg==",
      "license": "MIT",
      "dependencies": {
        "debug": "2.6.9",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "on-finished": "~2.4.1",
        "parseurl": "~1.3.3",
        "statuses": "~2.0.2",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/forwarded": {
      "version": "0.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/forwarded/-/forwarded-0.2.0.tgz",
      "integrity": "sha512-buRG0fpBtRHSTCOASe6hD258tEubFoRLb4ZNA6NxMVHNw2gOcwHo9wyablzMzOA5z9xA9L1KNjk/Nt6MT9aYow==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/frac": {
      "version": "1.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/frac/-/frac-1.1.2.tgz",
      "integrity": "sha512-w/XBfkibaTl3YDqASwfDUqkna4Z2p9cFSr1aHDt0WoMTECnRfBOv2WArlZILlqgWlmdIlALXGpM2AOhEk5W3IA==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/fresh": {
      "version": "0.5.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/fresh/-/fresh-0.5.2.tgz",
      "integrity": "sha512-zJ2mQYM18rEFOudeV4GShTGIQ7RbzA7ozbU9I/XBpm7kqgMywgmylMwXHxZJmkVoYkna9d2pVXVXPdYTP9ej8Q==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/function-bind": {
      "version": "1.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/function-bind/-/function-bind-1.1.2.tgz",
      "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-intrinsic": {
      "version": "1.3.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/get-intrinsic/-/get-intrinsic-1.3.0.tgz",
      "integrity": "sha512-9fSjSaos/fRIVIp+xSJlE6lfwhES7LNtKaCBIamHsjr2na1BiABJPo0mOjjz8GJDURarmCPGqaiVg5mfjb98CQ==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "es-define-property": "^1.0.1",
        "es-errors": "^1.3.0",
        "es-object-atoms": "^1.1.1",
        "function-bind": "^1.1.2",
        "get-proto": "^1.0.1",
        "gopd": "^1.2.0",
        "has-symbols": "^1.1.0",
        "hasown": "^2.0.2",
        "math-intrinsics": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-proto": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/get-proto/-/get-proto-1.0.1.tgz",
      "integrity": "sha512-sTSfBjoXBp89JvIKIefqw7U2CCebsc74kiY6awiGogKtoSGbgjYE/G/+l9sF3MWFPNc9IcoOC4ODfKHfxFmp0g==",
      "license": "MIT",
      "dependencies": {
        "dunder-proto": "^1.0.1",
        "es-object-atoms": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/gopd": {
      "version": "1.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/gopd/-/gopd-1.2.0.tgz",
      "integrity": "sha512-ZUKRh6/kUFoAiTAtTYPZJ3hw9wNxx+BIBOijnlG9PnrJsCcSjs1wyyD6vJpaYtgnzDrKYRSqf3OO6Rfa93xsRg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/has-symbols": {
      "version": "1.1.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/has-symbols/-/has-symbols-1.1.0.tgz",
      "integrity": "sha512-1cDNdwJ2Jaohmb3sg4OmKaMBwuC48sYni5HUw2DvsC8LjGTLK9h+eb1X6RyuOHe4hT0ULCW68iomhjUoKUqlPQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/hasown": {
      "version": "2.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/hasown/-/hasown-2.0.2.tgz",
      "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
      "license": "MIT",
      "dependencies": {
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/helmet": {
      "version": "8.1.0",
      "resolved": "https://registry.npmjs.org/helmet/-/helmet-8.1.0.tgz",
      "integrity": "sha512-jOiHyAZsmnr8LqoPGmCjYAaiuWwjAPLgY8ZX2XrmHawt99/u1y6RgrZMTeoPfpUbV96HOalYgz1qzkRbw54Pmg==",
      "engines": {
        "node": ">=18.0.0"
      }
    },
    "node_modules/http-errors": {
      "version": "2.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/http-errors/-/http-errors-2.0.1.tgz",
      "integrity": "sha512-4FbRdAX+bSdmo4AUFuS0WNiPz8NgFt+r8ThgNWmlrjQjt1Q7ZR9+zTlce2859x4KSXrwIsaeTqDoKQmtP8pLmQ==",
      "license": "MIT",
      "dependencies": {
        "depd": "~2.0.0",
        "inherits": "~2.0.4",
        "setprototypeof": "~1.2.0",
        "statuses": "~2.0.2",
        "toidentifier": "~1.0.1"
      },
      "engines": {
        "node": ">= 0.8"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/express"
      }
    },
    "node_modules/iconv-lite": {
      "version": "0.4.24",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/iconv-lite/-/iconv-lite-0.4.24.tgz",
      "integrity": "sha512-v3MXnZAcvnywkTUEZomIActle7RXXeedOR31wwl7VlyoXO4Qi9arvSenNQWne1TcRwhCL1HwLI21bEqdpj8/rA==",
      "license": "MIT",
      "dependencies": {
        "safer-buffer": ">= 2.1.2 < 3"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/inherits": {
      "version": "2.0.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/inherits/-/inherits-2.0.4.tgz",
      "integrity": "sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==",
      "license": "ISC"
    },
    "node_modules/ip-address": {
      "version": "10.0.1",
      "resolved": "https://registry.npmjs.org/ip-address/-/ip-address-10.0.1.tgz",
      "integrity": "sha512-NWv9YLW4PoW2B7xtzaS3NCot75m6nK7Icdv0o3lfMceJVRfSoQwqD4wEH5rLwoKJwUiZ/rfpiVBhnaF0FK4HoA==",
      "engines": {
        "node": ">= 12"
      }
    },
    "node_modules/ipaddr.js": {
      "version": "1.9.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ipaddr.js/-/ipaddr.js-1.9.1.tgz",
      "integrity": "sha512-0KI/607xoxSToH7GjN1FfSbLoU0+btTicjsQSWQlh/hZykN8KpmMf7uYwPW3R+akZ6R/w18ZlXSHBYXiYUPO3g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/isarray": {
      "version": "1.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/isarray/-/isarray-1.0.0.tgz",
      "integrity": "sha512-VLghIWNM6ELQzo7zwmcg0NmTVyWKYjvIeM83yjp0wRDTmUnrM678fQbcKBo6n2CJEF0szoG//ytg+TKla89ALQ==",
      "license": "MIT"
    },
    "node_modules/jsonwebtoken": {
      "version": "9.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/jsonwebtoken/-/jsonwebtoken-9.0.3.tgz",
      "integrity": "sha512-MT/xP0CrubFRNLNKvxJ2BYfy53Zkm++5bX9dtuPbqAeQpTVe0MQTFhao8+Cp//EmJp244xt6Drw/GVEGCUj40g==",
      "license": "MIT",
      "dependencies": {
        "jws": "^4.0.1",
        "lodash.includes": "^4.3.0",
        "lodash.isboolean": "^3.0.3",
        "lodash.isinteger": "^4.0.4",
        "lodash.isnumber": "^3.0.3",
        "lodash.isplainobject": "^4.0.6",
        "lodash.isstring": "^4.0.1",
        "lodash.once": "^4.0.0",
        "ms": "^2.1.1",
        "semver": "^7.5.4"
      },
      "engines": {
        "node": ">=12",
        "npm": ">=6"
      }
    },
    "node_modules/jsonwebtoken/node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/jwa": {
      "version": "2.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/jwa/-/jwa-2.0.1.tgz",
      "integrity": "sha512-hRF04fqJIP8Abbkq5NKGN0Bbr3JxlQ+qhZufXVr0DvujKy93ZCbXZMHDL4EOtodSbCWxOqR8MS1tXA5hwqCXDg==",
      "license": "MIT",
      "dependencies": {
        "buffer-equal-constant-time": "^1.0.1",
        "ecdsa-sig-formatter": "1.0.11",
        "safe-buffer": "^5.0.1"
      }
    },
    "node_modules/jws": {
      "version": "4.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/jws/-/jws-4.0.1.tgz",
      "integrity": "sha512-EKI/M/yqPncGUUh44xz0PxSidXFr/+r0pA70+gIYhjv+et7yxM+s29Y+VGDkovRofQem0fs7Uvf4+YmAdyRduA==",
      "license": "MIT",
      "dependencies": {
        "jwa": "^2.0.1",
        "safe-buffer": "^5.0.1"
      }
    },
    "node_modules/lodash.includes": {
      "version": "4.3.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.includes/-/lodash.includes-4.3.0.tgz",
      "integrity": "sha512-W3Bx6mdkRTGtlJISOvVD/lbqjTlPPUDTMnlXZFnVwi9NKJ6tiAk6LVdlhZMm17VZisqhKcgzpO5Wz91PCt5b0w==",
      "license": "MIT"
    },
    "node_modules/lodash.isboolean": {
      "version": "3.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.isboolean/-/lodash.isboolean-3.0.3.tgz",
      "integrity": "sha512-Bz5mupy2SVbPHURB98VAcw+aHh4vRV5IPNhILUCsOzRmsTmSQ17jIuqopAentWoehktxGd9e/hbIXq980/1QJg==",
      "license": "MIT"
    },
    "node_modules/lodash.isinteger": {
      "version": "4.0.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.isinteger/-/lodash.isinteger-4.0.4.tgz",
      "integrity": "sha512-DBwtEWN2caHQ9/imiNeEA5ys1JoRtRfY3d7V9wkqtbycnAmTvRRmbHKDV4a0EYc678/dia0jrte4tjYwVBaZUA==",
      "license": "MIT"
    },
    "node_modules/lodash.isnumber": {
      "version": "3.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.isnumber/-/lodash.isnumber-3.0.3.tgz",
      "integrity": "sha512-QYqzpfwO3/CWf3XP+Z+tkQsfaLL/EnUlXWVkIk5FUPc4sBdTehEqZONuyRt2P67PXAk+NXmTBcc97zw9t1FQrw==",
      "license": "MIT"
    },
    "node_modules/lodash.isplainobject": {
      "version": "4.0.6",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.isplainobject/-/lodash.isplainobject-4.0.6.tgz",
      "integrity": "sha512-oSXzaWypCMHkPC3NvBEaPHf0KsA5mvPrOPgQWDsbg8n7orZ290M0BmC/jgRZ4vcJ6DTAhjrsSYgdsW/F+MFOBA==",
      "license": "MIT"
    },
    "node_modules/lodash.isstring": {
      "version": "4.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.isstring/-/lodash.isstring-4.0.1.tgz",
      "integrity": "sha512-0wJxfxH1wgO3GrbuP+dTTk7op+6L41QCXbGINEmD+ny/G/eCqGzxyCsh7159S+mgDDcoarnBw6PC1PS5+wUGgw==",
      "license": "MIT"
    },
    "node_modules/lodash.once": {
      "version": "4.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.once/-/lodash.once-4.1.1.tgz",
      "integrity": "sha512-Sb487aTOCr9drQVL8pIxOzVhafOjZN9UU54hiN8PU3uAiSV7lx1yYNpbNmex2PK6dSJoNTSJUUswT651yww3Mg==",
      "license": "MIT"
    },
    "node_modules/math-intrinsics": {
      "version": "1.1.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/math-intrinsics/-/math-intrinsics-1.1.0.tgz",
      "integrity": "sha512-/IXtbwEk5HTPyEwyKX6hGkYXxM9nbj64B+ilVJnC/R6B0pH5G4V3b0pVbL7DBj4tkhBAppbQUlf6F6Xl9LHu1g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/media-typer": {
      "version": "0.3.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/media-typer/-/media-typer-0.3.0.tgz",
      "integrity": "sha512-dq+qelQ9akHpcOl/gUVRTxVIOkAJ1wR3QAvb4RsVjS8oVoFjDGTc679wJYmUmknUF5HwMLOgb5O+a3KxfWapPQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/merge-descriptors": {
      "version": "1.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/merge-descriptors/-/merge-descriptors-1.0.3.tgz",
      "integrity": "sha512-gaNvAS7TZ897/rVaZ0nMtAyxNyi/pdbjbAwUpFQpN70GqnVfOiXpeUUMKRBmzXaSQ8DdTX4/0ms62r2K+hE6mQ==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/methods": {
      "version": "1.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/methods/-/methods-1.1.2.tgz",
      "integrity": "sha512-iclAHeNqNm68zFtnZ0e+1L2yUIdvzNoauKU4WBA3VvH/vPFieF7qfRlwUZU+DA9P9bPXIS90ulxoUoCH23sV2w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime": {
      "version": "1.6.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/mime/-/mime-1.6.0.tgz",
      "integrity": "sha512-x0Vn8spI+wuJ1O6S7gnbaQg8Pxh4NNHb7KSINmEWKiPE4RKOplvijn+NkmYmmRgP68mc70j2EbeTFRsrswaQeg==",
      "license": "MIT",
      "bin": {
        "mime": "cli.js"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/mime-db": {
      "version": "1.52.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/mime-db/-/mime-db-1.52.0.tgz",
      "integrity": "sha512-sPU4uV7dYlvtWJxwwxHD0PuihVNiE7TyAbQ5SWxDCB9mUYvOgroQOwYQQOKPJ8CIbE+1ETVlOoK1UC2nU3gYvg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime-types": {
      "version": "2.1.35",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/mime-types/-/mime-types-2.1.35.tgz",
      "integrity": "sha512-ZDY+bPm5zTTF+YpCrAU9nK0UgICYPT0QtT1NZWFv4s++TNkcgVaT0g6+4R2uI4MjQjzysHB1zxuWL50hzaeXiw==",
      "license": "MIT",
      "dependencies": {
        "mime-db": "1.52.0"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/minimist": {
      "version": "1.2.8",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/minimist/-/minimist-1.2.8.tgz",
      "integrity": "sha512-2yyAR8qBkN3YuheJanUpWC5U3bb5osDywNB8RzDVlDwDHbocAJveqqj1u8+SVD7jkWT4yvsHCpWqqWqAxb0zCA==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/mkdirp": {
      "version": "0.5.6",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/mkdirp/-/mkdirp-0.5.6.tgz",
      "integrity": "sha512-FP+p8RB8OWpF3YZBCrP5gtADmtXApB5AMLn+vdyA+PyxCjrCs00mjyUozssO33cwDeT3wNGdLxJ5M//YqtHAJw==",
      "license": "MIT",
      "dependencies": {
        "minimist": "^1.2.6"
      },
      "bin": {
        "mkdirp": "bin/cmd.js"
      }
    },
    "node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A==",
      "license": "MIT"
    },
    "node_modules/multer": {
      "version": "1.4.5-lts.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/multer/-/multer-1.4.5-lts.2.tgz",
      "integrity": "sha512-VzGiVigcG9zUAoCNU+xShztrlr1auZOlurXynNvO9GiWD1/mTBbUljOKY+qMeazBqXgRnjzeEgJI/wyjJUHg9A==",
      "deprecated": "Multer 1.x is impacted by a number of vulnerabilities, which have been patched in 2.x. You should upgrade to the latest 2.x version.",
      "license": "MIT",
      "dependencies": {
        "append-field": "^1.0.0",
        "busboy": "^1.0.0",
        "concat-stream": "^1.5.2",
        "mkdirp": "^0.5.4",
        "object-assign": "^4.1.1",
        "type-is": "^1.6.4",
        "xtend": "^4.0.0"
      },
      "engines": {
        "node": ">= 6.0.0"
      }
    },
    "node_modules/negotiator": {
      "version": "0.6.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/negotiator/-/negotiator-0.6.3.tgz",
      "integrity": "sha512-+EUsqGPLsM+j/zdChZjsnX51g4XrHFOIXwfnCVPGlQk/k5giakcKsuxCObBRu6DSm9opw/O6slWbJdghQM4bBg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/nodemailer": {
      "version": "6.10.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/nodemailer/-/nodemailer-6.10.1.tgz",
      "integrity": "sha512-Z+iLaBGVaSjbIzQ4pX6XV41HrooLsQ10ZWPUehGmuantvzWoDVBnmsdUcOIDM1t+yPor5pDhVlDESgOMEGxhHA==",
      "license": "MIT-0",
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/object-assign": {
      "version": "4.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/object-assign/-/object-assign-4.1.1.tgz",
      "integrity": "sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/object-inspect": {
      "version": "1.13.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/object-inspect/-/object-inspect-1.13.4.tgz",
      "integrity": "sha512-W67iLl4J2EXEGTbfeHCffrjDfitvLANg0UlX3wFUUSTx92KXRFegMHUVgSqE+wvhAbi4WqjGg9czysTV2Epbew==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/on-finished": {
      "version": "2.4.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/on-finished/-/on-finished-2.4.1.tgz",
      "integrity": "sha512-oVlzkg3ENAhCk2zdv7IJwd/QUD4z2RxRwpkcGY8psCVcCYZNq4wYnVWALHM+brtuJjePWiYF/ClmuDr8Ch5+kg==",
      "license": "MIT",
      "dependencies": {
        "ee-first": "1.1.1"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/parseurl": {
      "version": "1.3.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/parseurl/-/parseurl-1.3.3.tgz",
      "integrity": "sha512-CiyeOxFT/JZyN5m0z9PfXw4SCBJ6Sygz1Dpl0wqjlhDEGGBP1GnsUVEL0p63hoG1fcj3fHynXi9NYO4nWOL+qQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/path-to-regexp": {
      "version": "0.1.12",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/path-to-regexp/-/path-to-regexp-0.1.12.tgz",
      "integrity": "sha512-RA1GjUVMnvYFxuqovrEqZoxxW5NUZqbwKtYz/Tt7nXerk0LbLblQmrsgdeOxV5SFHf0UDggjS/bSeOZwt1pmEQ==",
      "license": "MIT"
    },
    "node_modules/pg": {
      "version": "8.16.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg/-/pg-8.16.3.tgz",
      "integrity": "sha512-enxc1h0jA/aq5oSDMvqyW3q89ra6XIIDZgCX9vkMrnz5DFTw/Ny3Li2lFQ+pt3L6MCgm/5o2o8HW9hiJji+xvw==",
      "license": "MIT",
      "dependencies": {
        "pg-connection-string": "^2.9.1",
        "pg-pool": "^3.10.1",
        "pg-protocol": "^1.10.3",
        "pg-types": "2.2.0",
        "pgpass": "1.0.5"
      },
      "engines": {
        "node": ">= 16.0.0"
      },
      "optionalDependencies": {
        "pg-cloudflare": "^1.2.7"
      },
      "peerDependencies": {
        "pg-native": ">=3.0.1"
      },
      "peerDependenciesMeta": {
        "pg-native": {
          "optional": true
        }
      }
    },
    "node_modules/pg-cloudflare": {
      "version": "1.2.7",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-cloudflare/-/pg-cloudflare-1.2.7.tgz",
      "integrity": "sha512-YgCtzMH0ptvZJslLM1ffsY4EuGaU0cx4XSdXLRFae8bPP4dS5xL1tNB3k2o/N64cHJpwU7dxKli/nZ2lUa5fLg==",
      "license": "MIT",
      "optional": true
    },
    "node_modules/pg-connection-string": {
      "version": "2.9.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-connection-string/-/pg-connection-string-2.9.1.tgz",
      "integrity": "sha512-nkc6NpDcvPVpZXxrreI/FOtX3XemeLl8E0qFr6F2Lrm/I8WOnaWNhIPK2Z7OHpw7gh5XJThi6j6ppgNoaT1w4w==",
      "license": "MIT"
    },
    "node_modules/pg-int8": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-int8/-/pg-int8-1.0.1.tgz",
      "integrity": "sha512-WCtabS6t3c8SkpDBUlb1kjOs7l66xsGdKpIPZsg4wR+B3+u9UAum2odSsF9tnvxg80h4ZxLWMy4pRjOsFIqQpw==",
      "license": "ISC",
      "engines": {
        "node": ">=4.0.0"
      }
    },
    "node_modules/pg-pool": {
      "version": "3.10.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-pool/-/pg-pool-3.10.1.tgz",
      "integrity": "sha512-Tu8jMlcX+9d8+QVzKIvM/uJtp07PKr82IUOYEphaWcoBhIYkoHpLXN3qO59nAI11ripznDsEzEv8nUxBVWajGg==",
      "license": "MIT",
      "peerDependencies": {
        "pg": ">=8.0"
      }
    },
    "node_modules/pg-protocol": {
      "version": "1.10.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-protocol/-/pg-protocol-1.10.3.tgz",
      "integrity": "sha512-6DIBgBQaTKDJyxnXaLiLR8wBpQQcGWuAESkRBX/t6OwA8YsqP+iVSiond2EDy6Y/dsGk8rh/jtax3js5NeV7JQ==",
      "license": "MIT"
    },
    "node_modules/pg-types": {
      "version": "2.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-types/-/pg-types-2.2.0.tgz",
      "integrity": "sha512-qTAAlrEsl8s4OiEQY69wDvcMIdQN6wdz5ojQiOy6YRMuynxenON0O5oCpJI6lshc6scgAY8qvJ2On/p+CXY0GA==",
      "license": "MIT",
      "dependencies": {
        "pg-int8": "1.0.1",
        "postgres-array": "~2.0.0",
        "postgres-bytea": "~1.0.0",
        "postgres-date": "~1.0.4",
        "postgres-interval": "^1.1.0"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/pgpass": {
      "version": "1.0.5",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pgpass/-/pgpass-1.0.5.tgz",
      "integrity": "sha512-FdW9r/jQZhSeohs1Z3sI1yxFQNFvMcnmfuj4WBMUTxOrAyLMaTcE1aAMBiTlbMNaXvBCQuVi0R7hd8udDSP7ug==",
      "license": "MIT",
      "dependencies": {
        "split2": "^4.1.0"
      }
    },
    "node_modules/postgres-array": {
      "version": "2.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/postgres-array/-/postgres-array-2.0.0.tgz",
      "integrity": "sha512-VpZrUqU5A69eQyW2c5CA1jtLecCsN2U/bD6VilrFDWq5+5UIEVO7nazS3TEcHf1zuPYO/sqGvUvW62g86RXZuA==",
      "license": "MIT",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/postgres-bytea": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/postgres-bytea/-/postgres-bytea-1.0.1.tgz",
      "integrity": "sha512-5+5HqXnsZPE65IJZSMkZtURARZelel2oXUEO8rH83VS/hxH5vv1uHquPg5wZs8yMAfdv971IU+kcPUczi7NVBQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/postgres-date": {
      "version": "1.0.7",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/postgres-date/-/postgres-date-1.0.7.tgz",
      "integrity": "sha512-suDmjLVQg78nMK2UZ454hAG+OAW+HQPZ6n++TNDUX+L0+uUlLywnoxJKDou51Zm+zTCjrCl0Nq6J9C5hP9vK/Q==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/postgres-interval": {
      "version": "1.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/postgres-interval/-/postgres-interval-1.2.0.tgz",
      "integrity": "sha512-9ZhXKM/rw350N1ovuWHbGxnGh/SNJ4cnxHiM0rxE4VN41wsg8P8zWn9hv/buK00RP4WvlOyr/RBDiptyxVbkZQ==",
      "license": "MIT",
      "dependencies": {
        "xtend": "^4.0.0"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/process-nextick-args": {
      "version": "2.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/process-nextick-args/-/process-nextick-args-2.0.1.tgz",
      "integrity": "sha512-3ouUOpQhtgrbOa17J7+uxOTpITYWaGP7/AhoR3+A+/1e9skrzelGi/dXzEYyvbxubEF6Wn2ypscTKiKJFFn1ag==",
      "license": "MIT"
    },
    "node_modules/proxy-addr": {
      "version": "2.0.7",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/proxy-addr/-/proxy-addr-2.0.7.tgz",
      "integrity": "sha512-llQsMLSUDUPT44jdrU/O37qlnifitDP+ZwrmmZcoSKyLKvtZxpyV0n2/bD/N4tBAAZ/gJEdZU7KMraoK1+XYAg==",
      "license": "MIT",
      "dependencies": {
        "forwarded": "0.2.0",
        "ipaddr.js": "1.9.1"
      },
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/qs": {
      "version": "6.14.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/qs/-/qs-6.14.0.tgz",
      "integrity": "sha512-YWWTjgABSKcvs/nWBi9PycY/JiPJqOD4JA6o9Sej2AtvSGarXxKC3OQSk4pAarbdQlKAh5D4FCQkJNkW+GAn3w==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "side-channel": "^1.1.0"
      },
      "engines": {
        "node": ">=0.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/range-parser": {
      "version": "1.2.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/range-parser/-/range-parser-1.2.1.tgz",
      "integrity": "sha512-Hrgsx+orqoygnmhFbKaHE6c296J+HTAQXoxEF6gNupROmmGJRoyzfG3ccAveqCBrwr/2yxQ5BVd/GTl5agOwSg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/raw-body": {
      "version": "2.5.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/raw-body/-/raw-body-2.5.3.tgz",
      "integrity": "sha512-s4VSOf6yN0rvbRZGxs8Om5CWj6seneMwK3oDb4lWDH0UPhWcxwOWw5+qk24bxq87szX1ydrwylIOp2uG1ojUpA==",
      "license": "MIT",
      "dependencies": {
        "bytes": "~3.1.2",
        "http-errors": "~2.0.1",
        "iconv-lite": "~0.4.24",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/readable-stream": {
      "version": "2.3.8",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/readable-stream/-/readable-stream-2.3.8.tgz",
      "integrity": "sha512-8p0AUk4XODgIewSi0l8Epjs+EVnWiK7NoDIEGU0HhE7+ZyY8D1IMY7odu5lRrFXGg71L15KG8QrPmum45RTtdA==",
      "license": "MIT",
      "dependencies": {
        "core-util-is": "~1.0.0",
        "inherits": "~2.0.3",
        "isarray": "~1.0.0",
        "process-nextick-args": "~2.0.0",
        "safe-buffer": "~5.1.1",
        "string_decoder": "~1.1.1",
        "util-deprecate": "~1.0.1"
      }
    },
    "node_modules/readable-stream/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g==",
      "license": "MIT"
    },
    "node_modules/safe-buffer": {
      "version": "5.2.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/safe-buffer/-/safe-buffer-5.2.1.tgz",
      "integrity": "sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==",
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ],
      "license": "MIT"
    },
    "node_modules/safer-buffer": {
      "version": "2.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/safer-buffer/-/safer-buffer-2.1.2.tgz",
      "integrity": "sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg==",
      "license": "MIT"
    },
    "node_modules/semver": {
      "version": "7.7.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/semver/-/semver-7.7.3.tgz",
      "integrity": "sha512-SdsKMrI9TdgjdweUSR9MweHA4EJ8YxHn8DFaDisvhVlUOe4BF1tLD7GAj0lIqWVl+dPb/rExr0Btby5loQm20Q==",
      "license": "ISC",
      "bin": {
        "semver": "bin/semver.js"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/send": {
      "version": "0.19.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/send/-/send-0.19.2.tgz",
      "integrity": "sha512-VMbMxbDeehAxpOtWJXlcUS5E8iXh6QmN+BkRX1GARS3wRaXEEgzCcB10gTQazO42tpNIya8xIyNx8fll1OFPrg==",
      "license": "MIT",
      "dependencies": {
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "1.2.0",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "fresh": "~0.5.2",
        "http-errors": "~2.0.1",
        "mime": "1.6.0",
        "ms": "2.1.3",
        "on-finished": "~2.4.1",
        "range-parser": "~1.2.1",
        "statuses": "~2.0.2"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/send/node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/serve-static": {
      "version": "1.16.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/serve-static/-/serve-static-1.16.3.tgz",
      "integrity": "sha512-x0RTqQel6g5SY7Lg6ZreMmsOzncHFU7nhnRWkKgWuMTu5NN0DR5oruckMqRvacAN9d5w6ARnRBXl9xhDCgfMeA==",
      "license": "MIT",
      "dependencies": {
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "parseurl": "~1.3.3",
        "send": "~0.19.1"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/setprototypeof": {
      "version": "1.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/setprototypeof/-/setprototypeof-1.2.0.tgz",
      "integrity": "sha512-E5LDX7Wrp85Kil5bhZv46j8jOeboKq5JMmYM3gVGdGH8xFpPWXUMsNrlODCrkoxMEeNi/XZIwuRvY4XNwYMJpw==",
      "license": "ISC"
    },
    "node_modules/side-channel": {
      "version": "1.1.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/side-channel/-/side-channel-1.1.0.tgz",
      "integrity": "sha512-ZX99e6tRweoUXqR+VBrslhda51Nh5MTQwou5tnUDgbtyM0dBgmhEDtWGP/xbKn6hqfPRHujUNwz5fy/wbbhnpw==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "object-inspect": "^1.13.3",
        "side-channel-list": "^1.0.0",
        "side-channel-map": "^1.0.1",
        "side-channel-weakmap": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-list": {
      "version": "1.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/side-channel-list/-/side-channel-list-1.0.0.tgz",
      "integrity": "sha512-FCLHtRD/gnpCiCHEiJLOwdmFP+wzCmDEkc9y7NsYxeF4u7Btsn1ZuwgwJGxImImHicJArLP4R0yX4c2KCrMrTA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "object-inspect": "^1.13.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-map": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/side-channel-map/-/side-channel-map-1.0.1.tgz",
      "integrity": "sha512-VCjCNfgMsby3tTdo02nbjtM/ewra6jPHmpThenkTYh8pG9ucZ/1P8So4u4FGBek/BjpOVsDCMoLA/iuBKIFXRA==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.5",
        "object-inspect": "^1.13.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-weakmap": {
      "version": "1.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/side-channel-weakmap/-/side-channel-weakmap-1.0.2.tgz",
      "integrity": "sha512-WPS/HvHQTYnHisLo9McqBHOJk2FkHO/tlpvldyrnem4aeQp4hai3gythswg6p01oSoTl58rcpiFAjF2br2Ak2A==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.5",
        "object-inspect": "^1.13.3",
        "side-channel-map": "^1.0.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/split2": {
      "version": "4.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/split2/-/split2-4.2.0.tgz",
      "integrity": "sha512-UcjcJOWknrNkF6PLX83qcHM6KHgVKNkV62Y8a5uYDVv9ydGQVwAHMKqHdJje1VTWpljG0WYpCDhrCdAOYH4TWg==",
      "license": "ISC",
      "engines": {
        "node": ">= 10.x"
      }
    },
    "node_modules/ssf": {
      "version": "0.11.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ssf/-/ssf-0.11.2.tgz",
      "integrity": "sha512-+idbmIXoYET47hH+d7dfm2epdOMUDjqcB4648sTZ+t2JwoyBFL/insLfB/racrDmsKB3diwsDA696pZMieAC5g==",
      "license": "Apache-2.0",
      "dependencies": {
        "frac": "~1.1.2"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/statuses": {
      "version": "2.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/statuses/-/statuses-2.0.2.tgz",
      "integrity": "sha512-DvEy55V3DB7uknRo+4iOGT5fP1slR8wQohVdknigZPMpMstaKJQWhwiYBACJE3Ul2pTnATihhBYnRhZQHGBiRw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/streamsearch": {
      "version": "1.1.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/streamsearch/-/streamsearch-1.1.0.tgz",
      "integrity": "sha512-Mcc5wHehp9aXz1ax6bZUyY5afg9u2rv5cqQI3mRrYkGC8rW2hM02jWuwjtL++LS5qinSyhj2QfLyNsuc+VsExg==",
      "engines": {
        "node": ">=10.0.0"
      }
    },
    "node_modules/string_decoder": {
      "version": "1.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/string_decoder/-/string_decoder-1.1.1.tgz",
      "integrity": "sha512-n/ShnvDi6FHbbVfviro+WojiFzv+s8MPMHBczVePfUpDJLwoLT0ht1l4YwBCbi8pJAveEEdnkHyPyTP/mzRfwg==",
      "license": "MIT",
      "dependencies": {
        "safe-buffer": "~5.1.0"
      }
    },
    "node_modules/string_decoder/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g==",
      "license": "MIT"
    },
    "node_modules/toidentifier": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/toidentifier/-/toidentifier-1.0.1.tgz",
      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
      "license": "MIT",
      "engines": {
        "node": ">=0.6"
      }
    },
    "node_modules/type-is": {
      "version": "1.6.18",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/type-is/-/type-is-1.6.18.tgz",
      "integrity": "sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==",
      "license": "MIT",
      "dependencies": {
        "media-typer": "0.3.0",
        "mime-types": "~2.1.24"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/typedarray": {
      "version": "0.0.6",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/typedarray/-/typedarray-0.0.6.tgz",
      "integrity": "sha512-/aCDEGatGvZ2BIk+HmLf4ifCJFwvKFNb9/JeZPMulfgFracn9QFcAf5GO8B/mweUjSoblS5In0cWhqpfs/5PQA==",
      "license": "MIT"
    },
    "node_modules/unpipe": {
      "version": "1.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/unpipe/-/unpipe-1.0.0.tgz",
      "integrity": "sha512-pjy2bYhSsufwWlKwPc+l3cN7+wuJlK6uz0YdJEOlQDbl6jo/YlPi4mb8agUkVC8BF7V8NuzeyPNqRksA3hztKQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/util-deprecate": {
      "version": "1.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/util-deprecate/-/util-deprecate-1.0.2.tgz",
      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
      "license": "MIT"
    },
    "node_modules/utils-merge": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/utils-merge/-/utils-merge-1.0.1.tgz",
      "integrity": "sha512-pMZTvIkT1d+TFGvDOqodOclx0QWkkgi6Tdoa8gC8ffGAAqz9pzPTZWAybbsHHoED/ztMtkv/VoYTYyShUn81hA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4.0"
      }
    },
    "node_modules/uuid": {
      "version": "9.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/uuid/-/uuid-9.0.1.tgz",
      "integrity": "sha512-b+1eJOlsR9K8HJpow9Ok3fiWOWSIcIzXodvv0rQjVoOVNpWMpxf1wZNpt4y9h10odCNrqnYp1OBzRktckBe3sA==",
      "funding": [
        "https://github.com/sponsors/broofa",
        "https://github.com/sponsors/ctavan"
      ],
      "license": "MIT",
      "bin": {
        "uuid": "dist/bin/uuid"
      }
    },
    "node_modules/vary": {
      "version": "1.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/vary/-/vary-1.1.2.tgz",
      "integrity": "sha512-BNGbWLfd0eUPabhkXUVm0j8uuvREyTh5ovRa/dyow/BqAbZJyC+5fU+IzQOzmAKzYqYRAISoRhdQr3eIZ/PXqg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/wmf": {
      "version": "1.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/wmf/-/wmf-1.0.2.tgz",
      "integrity": "sha512-/p9K7bEh0Dj6WbXg4JG0xvLQmIadrner1bi45VMJTfnbVHsc7yIajZyoSoK60/dtVBs12Fm6WkUI5/3WAVsNMw==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/word": {
      "version": "0.3.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/word/-/word-0.3.0.tgz",
      "integrity": "sha512-OELeY0Q61OXpdUfTp+oweA/vtLVg5VDOXh+3he3PNzLGG/y0oylSOC1xRVj0+l4vQ3tj/bB1HVHv1ocXkQceFA==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/xlsx": {
      "version": "0.18.5",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/xlsx/-/xlsx-0.18.5.tgz",
      "integrity": "sha512-dmg3LCjBPHZnQp5/F/+nnTa+miPJxUXB6vtk42YjBBKayDNagxGEeIdWApkYPOf3Z3pm3k62Knjzp7lMeTEtFQ==",
      "license": "Apache-2.0",
      "dependencies": {
        "adler-32": "~1.3.0",
        "cfb": "~1.2.1",
        "codepage": "~1.15.0",
        "crc-32": "~1.2.1",
        "ssf": "~0.11.2",
        "wmf": "~1.0.1",
        "word": "~0.3.0"
      },
      "bin": {
        "xlsx": "bin/xlsx.njs"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/xtend": {
      "version": "4.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/xtend/-/xtend-4.0.2.tgz",
      "integrity": "sha512-LKYU1iAXJXUgAXn9URjiu+MWhyUXHsvfp7mcuYm9dSUKK0/CjtrUwFAxD82/mCWbtLsGjFIad0wIsod4zrTAEQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.4"
      }
    },
    "node_modules/zod": {
      "version": "3.25.76",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/zod/-/zod-3.25.76.tgz",
      "integrity": "sha512-gzUt/qt81nXsFGKIFcC3YnfEAx5NkunCfnDlvuBSSFS02bcXu4Lmea0AFIUwbLWxWPx3d9p8S5QoaujKcNQxcQ==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/colinhacks"
      }
    }
  }
}


────────────────── server/Dockerfile.dev ──────────────────
FROM node:20-alpine
WORKDIR /app

# Keep image tiny + tools for node-gyp if needed (bcryptjs is pure JS but ok)
RUN apk add --no-cache bash

COPY package*.json ./
RUN npm install

COPY . .
EXPOSE 3001

CMD ["npm","run","dev"]


────────────────── client/src/pages/Meta.jsx ──────────────────
import React, { useEffect, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';

function InlineRowEditor({ row, columns, onSave, onDelete }) {
  const [editing, setEditing] = useState(false);
  const [draft, setDraft] = useState(row);

  useEffect(() => {
    setDraft(row);
  }, [row]);

  const setField = (key, value) => {
    setDraft((prev) => ({ ...prev, [key]: value }));
  };

  const doSave = async () => {
    await onSave(draft);
    setEditing(false);
  };

  return (
    <tr>
      {columns.map((c) => (
        <td key={c.key}>
          {editing && c.editable ? (
            c.type === 'checkbox' ? (
              <input
                type="checkbox"
                checked={!!draft[c.key]}
                onChange={(e) => setField(c.key, e.target.checked)}
              />
            ) : c.type === 'number' ? (
              <input
                className="input"
                type="number"
                value={draft[c.key] ?? ''}
                onChange={(e) => setField(c.key, e.target.value)}
              />
            ) : (
              <input
                className="input"
                value={draft[c.key] ?? ''}
                onChange={(e) => setField(c.key, e.target.value)}
              />
            )
          ) : (
            <span>
              {c.type === 'checkbox' 
                ? (row[c.key] ? '✅' : '❌') 
                : (row[c.key] ?? '')}
            </span>
          )}
        </td>
      ))}

      <td style={{ whiteSpace: 'nowrap' }}>
        {!editing ? (
          <>
            <button className="btn btn-outline" onClick={() => setEditing(true)}>
              Modifier
            </button>
            <span style={{ display: 'inline-block', width: 8 }} />
            <button className="btn btn-outline" onClick={() => onDelete(row)}>
              Supprimer
            </button>
          </>
        ) : (
          <>
            <button className="btn" onClick={doSave}>
              Valider
            </button>
            <span style={{ display: 'inline-block', width: 8 }} />
            <button
              className="btn btn-outline"
              onClick={() => {
                setDraft(row);
                setEditing(false);
              }}
            >
              Annuler
            </button>
          </>
        )}
      </td>
    </tr>
  );
}

function Section({ title, fetchUrl, createUrl, updateUrl, deleteUrl, columns, createInitial }) {
  const { token } = useAuth();
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);

  const [create, setCreate] = useState(createInitial);

  async function load() {
    setLoading(true);
    setErr(null);
    try {
      const data = await apiFetch(fetchUrl, { token });
      const key = Object.keys(data).find((k) => Array.isArray(data[k]));
      setItems(key ? data[key] : []);
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const createField = (k, v) => setCreate((p) => ({ ...p, [k]: v }));

  const doCreate = async () => {
    setErr(null);
    try {
      await apiFetch(createUrl, { method: 'POST', token, body: create });
      setCreate(createInitial);
      await load();
    } catch (e) {
      setErr(String(e.message || e));
    }
  };

  const doSave = async (row) => {
    await apiFetch(updateUrl(row.id), { method: 'PUT', token, body: row });
    await load();
  };

  const doDelete = async (row) => {
    const ok = confirm(`Envoyer dans la corbeille ?\n\n${title}: ${row.id}`);
    if (!ok) return;
    await apiFetch(deleteUrl(row.id), { method: 'DELETE', token });
    await load();
  };

  return (
    <div className="card" style={{ marginBottom: 16 }}>
      <div className="row" style={{ justifyContent: 'space-between' }}>
        <h2 style={{ margin: 0 }}>{title}</h2>
        <button className="btn btn-outline" onClick={load}>
          Recharger
        </button>
      </div>

      {err && <div className="muted" style={{ color: '#b91c1c' }}>{err}</div>}

      <div className="card" style={{ marginTop: 12, background: '#fafafa' }}>
        <div className="row" style={{ alignItems: 'flex-end', flexWrap: 'wrap', gap: 10 }}>
          {columns
            .filter((c) => c.creatable)
            .map((c) => (
              <div key={c.key} className="field" style={{ minWidth: 150 }}>
                <div className="label">{c.label}</div>
                {c.type === 'checkbox' ? (
                  <input
                    type="checkbox"
                    checked={!!create[c.key]}
                    onChange={(e) => createField(c.key, e.target.checked)}
                  />
                ) : (
                  <input
                    className="input"
                    type={c.type || 'text'}
                    value={create[c.key] ?? ''}
                    onChange={(e) => createField(c.key, e.target.value)}
                  />
                )}
              </div>
            ))}
          <button className="btn" onClick={doCreate}>
            Ajouter
          </button>
        </div>
      </div>

      <div style={{ overflow: 'auto', marginTop: 12 }}>
        <table className="table">
          <thead>
            <tr>
              {columns.map((c) => (
                <th key={c.key}>{c.label}</th>
              ))}
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td colSpan={columns.length + 1} className="muted">
                  Chargement...
                </td>
              </tr>
            ) : items.length ? (
              items.map((row) => (
                <InlineRowEditor
                  key={row.id}
                  row={row}
                  columns={columns}
                  onSave={doSave}
                  onDelete={doDelete}
                />
              ))
            ) : (
              <tr>
                <td colSpan={columns.length + 1} className="muted">
                  Aucune donnée
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

export default function Meta() {
  return (
    <div>
      <h1 style={{ marginTop: 0 }}>Véhicules & Chauffeurs</h1>

      <Section
        title="Véhicules"
        fetchUrl="/api/meta/vehicles"
        createUrl="/api/meta/vehicles"
        updateUrl={(id) => `/api/meta/vehicles/${id}`}
        deleteUrl={(id) => `/api/meta/vehicles/${id}`}
        createInitial={{ plate: '', label: '', brand: '', model: '', energy_type: '', seats: 5 }}
        columns={[
          { key: 'plate', label: 'Immatriculation', editable: true, creatable: true },
          { key: 'brand', label: 'Marque', editable: true, creatable: true },
          { key: 'model', label: 'Modèle', editable: true, creatable: true },
          { key: 'energy_type', label: 'Carburant', editable: true, creatable: true },
          { key: 'seats', label: 'Places', editable: true, creatable: true, type: 'number' },
          { key: 'label', label: 'Libellé (ex: Couleur)', editable: true, creatable: true },
          { key: 'is_active', label: 'Actif', editable: false, creatable: false, type: 'checkbox' }
        ]}
      />

      <Section
        title="Chauffeurs"
        fetchUrl="/api/meta/drivers"
        createUrl="/api/meta/drivers"
        updateUrl={(id) => `/api/meta/drivers/${id}`}
        deleteUrl={(id) => `/api/meta/drivers/${id}`}
        createInitial={{ full_name: '', phone: '', is_active: true }}
        columns={[
          { key: 'full_name', label: 'Nom complet', editable: true, creatable: true },
          { key: 'phone', label: 'Téléphone', editable: true, creatable: true },
          { key: 'is_active', label: 'Actif', editable: true, creatable: true, type: 'checkbox' }
        ]}
      />

      <div className="muted">
        Suppression = envoi dans la corbeille. Pour supprimer définitivement: menu Corbeille.
      </div>
    </div>
  );
}

────────────────── client/src/pages/Users.jsx ──────────────────
import React, { useEffect, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

const ROLES = [
  { value: 'DEMANDEUR', label: 'Demandeur' },
  { value: 'LOGISTIQUE', label: 'Logistique' },
  { value: 'RAF', label: 'RAF' },
  { value: 'ADMIN', label: 'Admin' }
];

export default function Users() {
  const { token } = useAuth();
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // État pour la création / modification
  const [showModal, setShowModal] = useState(false);
  const [editingUser, setEditingUser] = useState(null); // null = mode création
  const [formData, setFormData] = useState({
    first_name: '',
    last_name: '',
    username: '',
    email: '',
    role: 'DEMANDEUR',
    password: '',
    is_active: true
  });

  async function loadUsers() {
    setLoading(true);
    setError(null);
    try {
      // NOTE: Assurez-vous d'avoir créé la route GET /api/users dans le backend
      const data = await apiFetch('/api/users', { token });
      setUsers(data.users || []);
    } catch (e) {
      setError(e.message || "Erreur lors du chargement des utilisateurs.");
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    loadUsers();
  }, []);

  const openCreate = () => {
    setEditingUser(null);
    setFormData({
      first_name: '',
      last_name: '',
      username: '',
      email: '',
      role: 'DEMANDEUR',
      password: '',
      is_active: true
    });
    setShowModal(true);
  };

  const openEdit = (user) => {
    setEditingUser(user);
    setFormData({
      first_name: user.first_name,
      last_name: user.last_name,
      username: user.username,
      email: user.email,
      role: user.role,
      password: '', // On laisse vide pour ne pas modifier
      is_active: user.is_active
    });
    setShowModal(true);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);

    try {
      if (editingUser) {
        // Mode Modification
        // NOTE: Assurez-vous d'avoir créé la route PUT /api/users/:id
        await apiFetch(`/api/users/${editingUser.id}`, {
          method: 'PUT',
          token,
          body: formData
        });
      } else {
        // Mode Création
        if (!formData.password) {
          alert("Le mot de passe est obligatoire pour la création.");
          return;
        }
        // NOTE: On utilise la route existante ou une nouvelle route admin
        await apiFetch('/api/users', { // ou /api/auth/register-admin
          method: 'POST',
          token,
          body: formData
        });
      }
      setShowModal(false);
      await loadUsers();
    } catch (err) {
      alert(err.message);
    }
  };

  return (
    <div className="container">
      <div className="card">
        <div className="rowBetween" style={{ marginBottom: 16 }}>
          <h2 style={{ margin: 0 }}>Gestion des Utilisateurs</h2>
          <div className="row" style={{ gap: 10 }}>
            <button className="btn btn-outline" onClick={loadUsers}>Actualiser</button>
            <button className="btn" onClick={openCreate}>+ Nouvel Utilisateur</button>
          </div>
        </div>

        {error && <div className="alert alert-danger">{error}</div>}

        <div className="tableWrap">
          <table className="table">
            <thead>
              <tr>
                <th>Nom complet</th>
                <th>Utilisateur</th>
                <th>Email</th>
                <th>Rôle</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {loading ? (
                <tr><td colSpan={6} className="muted">Chargement...</td></tr>
              ) : users.length === 0 ? (
                <tr><td colSpan={6} className="muted">Aucun utilisateur trouvé.</td></tr>
              ) : (
                users.map(u => (
                  <tr key={u.id} style={{ opacity: u.is_active ? 1 : 0.6 }}>
                    <td>{u.first_name} {u.last_name}</td>
                    <td><b>{u.username}</b></td>
                    <td>{u.email}</td>
                    <td><span className="badge badge-info">{u.role}</span></td>
                    <td>
                      {u.is_active ? (
                        <span className="badge badge-ok">Actif</span>
                      ) : (
                        <span className="badge badge-bad">Inactif</span>
                      )}
                    </td>
                    <td>
                      <button className="btn btn-sm btn-outline" onClick={() => openEdit(u)}>
                        Modifier
                      </button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {showModal && (
        <Modal title={editingUser ? "Modifier Utilisateur" : "Créer Utilisateur"} onClose={() => setShowModal(false)} width={600}>
          <form onSubmit={handleSubmit} className="form">
            <div className="grid2">
              <label className="field">
                <span className="label">Prénom</span>
                <input required className="input" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
              </label>
              <label className="field">
                <span className="label">Nom</span>
                <input required className="input" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
              </label>
            </div>

            <div className="grid2">
              <label className="field">
                <span className="label">Identifiant (Login)</span>
                <input required className="input" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} />
              </label>
              <label className="field">
                <span className="label">Email</span>
                <input required type="email" className="input" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
              </label>
            </div>

            <div className="grid2">
              <label className="field">
                <span className="label">Rôle</span>
                <select className="input" value={formData.role} onChange={e => setFormData({...formData, role: e.target.value})}>
                  {ROLES.map(r => <option key={r.value} value={r.value}>{r.label}</option>)}
                </select>
              </label>
              
              <label className="field" style={{ flexDirection: 'row', alignItems: 'center', gap: 10, marginTop: 20 }}>
                <input type="checkbox" checked={formData.is_active} onChange={e => setFormData({...formData, is_active: e.target.checked})} />
                <span className="label" style={{ marginBottom: 0 }}>Compte Actif</span>
              </label>
            </div>

            <div className="field">
              <span className="label">Mot de passe {editingUser && "(Laisser vide pour ne pas changer)"}</span>
              <input 
                type="password" 
                className="input" 
                placeholder={editingUser ? "Nouveau mot de passe..." : "Mot de passe obligatoire"}
                value={formData.password} 
                onChange={e => setFormData({...formData, password: e.target.value})} 
                required={!editingUser} // Obligatoire seulement à la création
              />
            </div>

            <div className="row" style={{ justifyContent: 'flex-end', marginTop: 16, gap: 10 }}>
              <button type="button" className="btn btn-outline" onClick={() => setShowModal(false)}>Annuler</button>
              <button type="submit" className="btn btn-primary">{editingUser ? "Enregistrer" : "Créer"}</button>
            </div>
          </form>
        </Modal>
      )}
    </div>
  );
}

────────────────── server/src/controllers/usersController.js ──────────────────
const bcrypt = require('bcryptjs');
const { pool } = require('../db');
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');

async function list(req, res) {
  const { rows } = await pool.query(
    'SELECT id, username, email, first_name, last_name, role, is_active, created_at FROM users ORDER BY created_at DESC'
  );
  res.json({ users: rows });
}

async function create(req, res) {
  const { first_name, last_name, username, email, role, password, is_active } = req.body;
  
  // Validation basique
  if (!username || !password || !role) {
    return res.status(400).json({ error: "Champs obligatoires manquants" });
  }

  const password_hash = await bcrypt.hash(password, 10);
  const id = uuidv4();

  try {
    await pool.query(
      `INSERT INTO users (id, first_name, last_name, username, email, role, password_hash, is_active)
       VALUES ($1, $2, $3, $4, $5, $6, $7, $8)`,
      [id, first_name, last_name, username, email, role, password_hash, is_active ?? true]
    );
    res.json({ ok: true, id });
  } catch (e) {
    if (e.message.includes('unique')) {
      return res.status(409).json({ error: "Utilisateur ou Email déjà existant" });
    }
    throw e;
  }
}

async function update(req, res) {
  const { id } = req.params;
  const { first_name, last_name, username, email, role, is_active, password } = req.body;
  
  let pwdHash = null;
  if (password && password.trim() !== '') {
    pwdHash = await bcrypt.hash(password, 10);
  }

  try {
    await pool.query(
      `UPDATE users SET 
         first_name = COALESCE($2, first_name),
         last_name = COALESCE($3, last_name),
         username = COALESCE($4, username),
         email = COALESCE($5, email),
         role = COALESCE($6, role), 
         is_active = COALESCE($7, is_active),
         password_hash = COALESCE($8, password_hash),
         updated_at = now()
       WHERE id = $1`,
      [id, first_name, last_name, username, email, role, is_active, pwdHash]
    );
    res.json({ ok: true });
  } catch (e) {
    throw e;
  }
}

module.exports = { list, create, update };

────────────────── server/src/controllers/trashController.js ──────────────────
const { pool } = require('../db');

// ========== ENTITÉS AVEC fuel_logs ==========
const ENTITIES = {
  vehicles: {
    table: 'vehicles',
    select: 'id, plate, label, is_active, deleted_at'
  },
  drivers: {
    table: 'drivers',
    select: 'id, full_name, phone, is_active, deleted_at'
  },
  fuel_requests: {
    table: 'fuel_requests',
    select: 'id, request_no, request_date, request_type, objet, amount_estimated_ar, status, deleted_at'
  },
  car_requests: {
    table: 'car_requests',
    select: 'id, request_no, proposed_date, objet, status, deleted_at'
  },
  // ========== NOUVEAUX: FUEL LOGS ==========
  vehicle_fuel_logs: {
    table: 'vehicle_fuel_logs',
    select: 'id, log_date, km_depart, km_arrivee, montant_ar, deleted_at'
  },
  generator_fuel_logs: {
    table: 'generator_fuel_logs',
    select: 'id, log_date, liters, montant_ar, deleted_at'
  },
  other_fuel_logs: {
    table: 'other_fuel_logs',
    select: 'id, log_date, liters, montant_ar, lien, deleted_at'
  }
};

function getEntity(name) {
  const ent = ENTITIES[name];
  if (!ent) {
    const err = new Error('UNKNOWN_ENTITY');
    err.statusCode = 400;
    throw err;
  }
  return ent;
}

async function list(req, res) {
  const { entity } = req.params;
  const ent = getEntity(entity);

  const { rows } = await pool.query(
    `SELECT ${ent.select}
     FROM ${ent.table}
     WHERE deleted_at IS NOT NULL
     ORDER BY deleted_at DESC
     LIMIT 500`
  );

  res.json({ items: rows });
}

async function restore(req, res) {
  const { entity, id } = req.params;
  const ent = getEntity(entity);

  const { rows } = await pool.query(
    `UPDATE ${ent.table}
     SET deleted_at=NULL
     WHERE id=$1 AND deleted_at IS NOT NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}

async function hardDelete(req, res) {
  const { entity, id } = req.params;
  const ent = getEntity(entity);

  const { rows } = await pool.query(
    `DELETE FROM ${ent.table}
     WHERE id=$1 AND deleted_at IS NOT NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}

module.exports = { list, restore, hardDelete };

────────────────── server/src/controllers/notificationsController.js ──────────────────
const { pool } = require('../db');

/**
 * Récupère les notifications pour l'utilisateur connecté
 * Basé sur son rôle et les événements récents
 */
async function getNotifications(req, res) {
  const userId = req.user.id;
  const role = req.user.role;
  
  const notifications = [];
  const now = new Date();
  const last24h = new Date(now - 24 * 60 * 60 * 1000);

  try {
    // ========== NOTIFICATIONS DEMANDEUR ==========
    if (role === 'DEMANDEUR') {
      // Demandes carburant rejetées/approuvées
      const fuelRes = await pool.query(
        `SELECT id, request_no, status, rejected_at, approved_at, reject_reason
         FROM fuel_requests
         WHERE requester_id=$1 
           AND status IN ('REJECTED', 'APPROVED')
           AND (rejected_at > $2 OR approved_at > $2)
         ORDER BY updated_at DESC
         LIMIT 10`,
        [userId, last24h]
      );

      for (const r of fuelRes.rows) {
        if (r.status === 'REJECTED') {
          notifications.push({
            id: `fuel-rejected-${r.id}`,
            type: 'fuel_request_rejected',
            title: `Demande carburant ${r.request_no} rejetée`,
            message: r.reject_reason || 'Aucun motif fourni',
            link: `/app/requests/fuel`,
            timestamp: r.rejected_at,
            severity: 'error'
          });
        } else if (r.status === 'APPROVED') {
          notifications.push({
            id: `fuel-approved-${r.id}`,
            type: 'fuel_request_approved',
            title: `Demande carburant ${r.request_no} approuvée ✅`,
            message: 'Votre demande a été validée par le RAF',
            link: `/app/requests/fuel`,
            timestamp: r.approved_at,
            severity: 'success'
          });
        }
      }

      // Demandes voiture rejetées/approuvées
      const carRes = await pool.query(
        `SELECT id, request_no, status, rejected_at, raf_at, reject_reason
         FROM car_requests
         WHERE requester_id=$1 
           AND status IN ('REJECTED', 'RAF_APPROVED')
           AND (rejected_at > $2 OR raf_at > $2)
         ORDER BY updated_at DESC
         LIMIT 10`,
        [userId, last24h]
      );

      for (const r of carRes.rows) {
        if (r.status === 'REJECTED') {
          notifications.push({
            id: `car-rejected-${r.id}`,
            type: 'car_request_rejected',
            title: `Demande voiture ${r.request_no} rejetée`,
            message: r.reject_reason || 'Aucun motif fourni',
            link: `/app/requests/car`,
            timestamp: r.rejected_at,
            severity: 'error'
          });
        } else if (r.status === 'RAF_APPROVED') {
          notifications.push({
            id: `car-approved-${r.id}`,
            type: 'car_request_approved',
            title: `Demande voiture ${r.request_no} approuvée ✅`,
            message: 'Votre demande a reçu le visa RAF',
            link: `/app/requests/car`,
            timestamp: r.raf_at,
            severity: 'success'
          });
        }
      }
    }

    // ========== NOTIFICATIONS LOGISTIQUE ==========
    if (['LOGISTIQUE', 'ADMIN'].includes(role)) {
      // Nouvelles demandes carburant à valider
      const newFuel = await pool.query(
        `SELECT id, request_no, submitted_at
         FROM fuel_requests
         WHERE status='SUBMITTED' AND submitted_at > $1
         ORDER BY submitted_at DESC
         LIMIT 5`,
        [last24h]
      );

      for (const r of newFuel.rows) {
        notifications.push({
          id: `fuel-new-${r.id}`,
          type: 'fuel_request_new',
          title: `Nouvelle demande carburant ${r.request_no}`,
          message: 'En attente de validation logistique',
          link: `/app/requests/fuel/manage`,
          timestamp: r.submitted_at,
          severity: 'info'
        });
      }

      // Nouvelles demandes voiture
      const newCar = await pool.query(
        `SELECT id, request_no, created_at
         FROM car_requests
         WHERE status='SUBMITTED' AND created_at > $1
         ORDER BY created_at DESC
         LIMIT 5`,
        [last24h]
      );

      for (const r of newCar.rows) {
        notifications.push({
          id: `car-new-${r.id}`,
          type: 'car_request_new',
          title: `Nouvelle demande voiture ${r.request_no}`,
          message: 'En attente de visa logistique',
          link: `/app/requests/car/manage`,
          timestamp: r.created_at,
          severity: 'info'
        });
      }
    }

    // ========== NOTIFICATIONS RAF ==========
    if (['RAF', 'ADMIN'].includes(role)) {
      // Demandes carburant vérifiées (à approuver)
      const verifiedFuel = await pool.query(
        `SELECT id, request_no, verified_at
         FROM fuel_requests
         WHERE status='VERIFIED' AND verified_at > $1
         ORDER BY verified_at DESC
         LIMIT 5`,
        [last24h]
      );

      for (const r of verifiedFuel.rows) {
        notifications.push({
          id: `fuel-verified-${r.id}`,
          type: 'fuel_request_verified',
          title: `Demande carburant ${r.request_no} à viser`,
          message: 'Validée par logistique, en attente de visa RAF',
          link: `/app/requests/fuel/raf`,
          timestamp: r.verified_at,
          severity: 'warning'
        });
      }

      // Demandes voiture approuvées par logistique
      const logisticsCar = await pool.query(
        `SELECT id, request_no, logistics_at
         FROM car_requests
         WHERE status='LOGISTICS_APPROVED' AND logistics_at > $1
         ORDER BY logistics_at DESC
         LIMIT 5`,
        [last24h]
      );

      for (const r of logisticsCar.rows) {
        notifications.push({
          id: `car-logistics-${r.id}`,
          type: 'car_request_logistics',
          title: `Demande voiture ${r.request_no} à viser`,
          message: 'Validée par logistique, en attente de visa RAF',
          link: `/app/requests/car/raf`,
          timestamp: r.logistics_at,
          severity: 'warning'
        });
      }
    }

    // Trier par timestamp décroissant
    notifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    res.json({ 
      notifications,
      count: notifications.length,
      unread: notifications.length // Simple: tout est "non lu" pour cette version
    });

  } catch (error) {
    console.error('Error fetching notifications:', error);
    res.status(500).json({ error: 'INTERNAL_ERROR', message: error.message });
  }
}

/**
 * Marquer une notification comme lue (stub pour future implémentation)
 */
async function markAsRead(req, res) {
  // Pour l'instant, on retourne juste OK
  // Future: table notifications avec user_id + read_at
  res.json({ ok: true });
}

module.exports = {
  getNotifications,
  markAsRead
};

────────────────── server/src/controllers/metaController.js ──────────────────
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');

const vehicleSchema = z.object({
  plate: z.string().min(3),
  label: z.string().optional().nullable()
});

async function listVehicles(req, res) {
  const { rows } = await pool.query(
    'SELECT id, plate, label, is_active, created_at, updated_at FROM vehicles WHERE deleted_at IS NULL ORDER BY plate'
  );
  res.json({ vehicles: rows });
}

async function createVehicle(req, res) {
  const parsed = vehicleSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }
  const id = uuidv4();
  const { plate, label } = parsed.data;
  try {
    await pool.query('INSERT INTO vehicles (id, plate, label, is_active) VALUES ($1,$2,$3,TRUE)', [id, plate, label || null]);
  } catch (e) {
    if (String(e.message).includes('vehicles_plate_key')) return res.status(409).json({ error: 'DUPLICATE_PLATE' });
    throw e;
  }
  const { rows } = await pool.query('SELECT id, plate, label, is_active, created_at, updated_at FROM vehicles WHERE id=$1', [id]);
  res.json({ vehicle: rows[0] });
}

async function updateVehicle(req, res) {
  const { id } = req.params;
  const parsed = vehicleSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }
  const { plate, label } = parsed.data;
  const { rows } = await pool.query(
    `UPDATE vehicles
     SET plate=$2, label=$3, updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id, plate, label, is_active, created_at, updated_at`,
    [id, plate, label || null]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ vehicle: rows[0] });
}

async function deleteVehicle(req, res) {
  const { id } = req.params;
  const { rows } = await pool.query(
    `UPDATE vehicles SET deleted_at=now(), updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}

const driverSchema = z.object({
  full_name: z.string().min(3),
  phone: z.string().optional().nullable(),
  is_active: z.boolean().optional()
});

async function listDrivers(req, res) {
  const { rows } = await pool.query(
    'SELECT id, full_name, phone, is_active, created_at, updated_at FROM drivers WHERE deleted_at IS NULL ORDER BY full_name'
  );
  res.json({ drivers: rows });
}

async function createDriver(req, res) {
  const parsed = driverSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }
  const id = uuidv4();
  const { full_name, phone, is_active } = parsed.data;
  await pool.query(
    'INSERT INTO drivers (id, full_name, phone, is_active) VALUES ($1,$2,$3,$4)',
    [id, full_name, phone || null, is_active ?? true]
  );
  const { rows } = await pool.query('SELECT id, full_name, phone, is_active, created_at, updated_at FROM drivers WHERE id=$1', [id]);
  res.json({ driver: rows[0] });
}

async function updateDriver(req, res) {
  const { id } = req.params;
  const parsed = driverSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }
  const { full_name, phone, is_active } = parsed.data;
  const { rows } = await pool.query(
    `UPDATE drivers
     SET full_name=$2, phone=$3, is_active=$4, updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id, full_name, phone, is_active, created_at, updated_at`,
    [id, full_name, phone || null, is_active ?? true]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ driver: rows[0] });
}

async function deleteDriver(req, res) {
  const { id } = req.params;
  const { rows } = await pool.query(
    `UPDATE drivers SET deleted_at=now(), updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}

module.exports = {
  listVehicles,
  createVehicle,
  updateVehicle,
  deleteVehicle,
  listDrivers,
  createDriver,
  updateDriver,
  deleteDriver
};


────────────────── server/src/controllers/logbooksController.js ──────────────────
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');

const createSchema = z.object({
  vehicle_id: z.string().uuid(),
  period_start: z.string().min(4),
  period_end: z.string().min(4),
  objet: z.string().optional().nullable()
});

async function list(req, res) {
  const role = req.user.role;
  const params = [];
  let sql = `SELECT cl.*, v.plate, v.label
             FROM car_logbooks cl
             JOIN vehicles v ON v.id=cl.vehicle_id`;
  // RAF can read; Demandeur can read none by default
  if (role === 'DEMANDEUR') {
    return res.json({ logbooks: [] });
  }
  sql += ' ORDER BY cl.period_start DESC, v.plate ASC LIMIT 500';
  const { rows } = await pool.query(sql, params);
  res.json({ logbooks: rows });
}

async function create(req, res) {
  const parsed = createSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const id = uuidv4();
  const d = parsed.data;
  await pool.query(
    `INSERT INTO car_logbooks (id, vehicle_id, period_start, period_end, objet, status, created_by)
     VALUES ($1,$2,$3,$4,$5,'DRAFT',$6)`,
    [id, d.vehicle_id, d.period_start, d.period_end, d.objet || null, req.user.id]
  );
  const { rows } = await pool.query(
    `SELECT cl.*, v.plate, v.label
     FROM car_logbooks cl JOIN vehicles v ON v.id=cl.vehicle_id
     WHERE cl.id=$1`,
    [id]
  );
  res.json({ logbook: rows[0] });
}

async function getOne(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  if (role === 'DEMANDEUR') return res.status(403).json({ error: 'FORBIDDEN' });

  const bookRes = await pool.query(
    `SELECT cl.*, v.plate, v.label
     FROM car_logbooks cl JOIN vehicles v ON v.id=cl.vehicle_id
     WHERE cl.id=$1`,
    [id]
  );
  const book = bookRes.rows[0];
  if (!book) return res.status(404).json({ error: 'NOT_FOUND' });

  const tripsRes = await pool.query(
    `SELECT * FROM car_logbook_trips WHERE logbook_id=$1 ORDER BY row_order ASC, created_at ASC`,
    [id]
  );
  const supRes = await pool.query(
    `SELECT * FROM car_logbook_fuel_supplies WHERE logbook_id=$1 ORDER BY supply_date ASC, created_at ASC`,
    [id]
  );

  res.json({ logbook: book, trips: tripsRes.rows, supplies: supRes.rows });
}

const updateSchema = z.object({
  objet: z.string().optional().nullable(),
  service_km: z.number().int().nonnegative().optional(),
  mission_km: z.number().int().nonnegative().optional(),
  chauffeur_signature: z.string().optional().nullable()
});

async function update(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const parsed = updateSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const d = parsed.data;
  const { rows } = await pool.query(
    `UPDATE car_logbooks
     SET objet=COALESCE($2, objet),
         service_km=COALESCE($3, service_km),
         mission_km=COALESCE($4, mission_km),
         chauffeur_signature=COALESCE($5, chauffeur_signature),
         updated_at=now()
     WHERE id=$1 AND status IN ('DRAFT','SUBMITTED')
     RETURNING *`,
    [id, d.objet ?? null, d.service_km ?? null, d.mission_km ?? null, d.chauffeur_signature ?? null]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_LOCKED' });
  res.json({ logbook: rows[0] });
}

const tripSchema = z.object({
  trip_date: z.string().min(4),
  depart_time: z.string().optional().nullable(),
  depart_km: z.number().int().optional().nullable(),
  route_start: z.string().optional().nullable(),
  route_end: z.string().optional().nullable(),
  parking_place: z.string().optional().nullable(),
  parking_duration_min: z.number().int().optional().nullable(),
  arrival_time: z.string().optional().nullable(),
  arrival_km: z.number().int().optional().nullable(),
  passengers: z.string().optional().nullable(),
  emargement: z.string().optional().nullable(),
  is_mission: z.boolean().optional(),
  mission_label: z.string().optional().nullable(),
  row_order: z.number().int()
});

async function replaceTrips(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const trips = Array.isArray(req.body?.trips) ? req.body.trips : [];
  const parsed = z.array(tripSchema).safeParse(trips);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const client = await pool.connect();
  try {
    await client.query('BEGIN');
    const statusRes = await client.query('SELECT status FROM car_logbooks WHERE id=$1', [id]);
    if (!statusRes.rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
    if (statusRes.rows[0].status === 'LOCKED') return res.status(409).json({ error: 'LOCKED' });

    await client.query('DELETE FROM car_logbook_trips WHERE logbook_id=$1', [id]);
    for (const t of parsed.data) {
      await client.query(
        `INSERT INTO car_logbook_trips (
          id, logbook_id, trip_date, depart_time, depart_km, route_start, route_end,
          parking_place, parking_duration_min, arrival_time, arrival_km,
          passengers, emargement, is_mission, mission_label, row_order
        ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16)`,
        [
          uuidv4(),
          id,
          t.trip_date,
          t.depart_time || null,
          t.depart_km ?? null,
          t.route_start || null,
          t.route_end || null,
          t.parking_place || null,
          t.parking_duration_min ?? null,
          t.arrival_time || null,
          t.arrival_km ?? null,
          t.passengers || null,
          t.emargement || null,
          !!t.is_mission,
          t.mission_label || null,
          t.row_order
        ]
      );
    }
    await client.query('COMMIT');
    res.json({ ok: true });
  } catch (e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    client.release();
  }
}

const supplySchema = z.object({
  supply_date: z.string().min(4),
  compteur_km: z.number().int(),
  liters: z.number(),
  montant_ar: z.number().int().nonnegative()
});

async function replaceSupplies(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const supplies = Array.isArray(req.body?.supplies) ? req.body.supplies : [];
  const parsed = z.array(supplySchema).safeParse(supplies);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const client = await pool.connect();
  try {
    await client.query('BEGIN');
    const statusRes = await client.query('SELECT status FROM car_logbooks WHERE id=$1', [id]);
    if (!statusRes.rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
    if (statusRes.rows[0].status === 'LOCKED') return res.status(409).json({ error: 'LOCKED' });

    await client.query('DELETE FROM car_logbook_fuel_supplies WHERE logbook_id=$1', [id]);
    for (const s of parsed.data) {
      await client.query(
        `INSERT INTO car_logbook_fuel_supplies (id, logbook_id, supply_date, compteur_km, liters, montant_ar)
         VALUES ($1,$2,$3,$4,$5,$6)`,
        [uuidv4(), id, s.supply_date, s.compteur_km, s.liters, s.montant_ar]
      );
    }
    await client.query('COMMIT');
    res.json({ ok: true });
  } catch (e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    client.release();
  }
}

async function submit(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const { rows } = await pool.query(
    `UPDATE car_logbooks
     SET status='SUBMITTED', submitted_at=now(), updated_at=now()
     WHERE id=$1 AND status='DRAFT'
     RETURNING *`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ logbook: rows[0] });
}

async function lock(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const { rows } = await pool.query(
    `UPDATE car_logbooks
     SET status='LOCKED', locked_at=now(), locked_by=$2, updated_at=now()
     WHERE id=$1 AND status IN ('DRAFT','SUBMITTED')
     RETURNING *`,
    [id, req.user.id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ logbook: rows[0] });
}

module.exports = { list, create, getOne, update, replaceTrips, replaceSupplies, submit, lock };


────────────────── server/src/controllers/importController.js ──────────────────
const multer = require('multer');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');
const { detectExcelType } = require('../utils/excel/detectType');
const { parseVehicleFuelWorkbook } = require('../utils/excel/parseVehicleFuel');
const { parseGeneratorWorkbook } = require('../utils/excel/parseGenerator');
const { parseOtherWorkbook } = require('../utils/excel/parseOther');

const upload = multer({ storage: multer.memoryStorage(), limits: { fileSize: 25 * 1024 * 1024 } });

async function ensureVehicle(plate) {
  if (!plate) return null;
  const p = plate.replace(/\s+/g,'').toUpperCase();
  const existing = await pool.query('SELECT id FROM vehicles WHERE plate=$1', [p]);
  if (existing.rows[0]) return existing.rows[0].id;
  const id = uuidv4();
  await pool.query('INSERT INTO vehicles (id, plate) VALUES ($1,$2)', [id, p]);
  return id;
}

async function createBatch(req, res) {
  const id = uuidv4();
  await pool.query('INSERT INTO import_batches (id, created_by) VALUES ($1,$2)', [id, req.user.id]);
  res.json({ batch_id: id });
}

async function uploadAndImport(req, res) {
  // Role: ADMIN or LOGISTIQUE only
  if (!['ADMIN', 'LOGISTIQUE'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const batch_id = req.body.batch_id || uuidv4();
  await pool.query(
    'INSERT INTO import_batches (id, created_by) VALUES ($1,$2) ON CONFLICT (id) DO NOTHING',
    [batch_id, req.user.id]
  );

  const files = req.files || [];
  if (!files.length) return res.status(400).json({ error: 'NO_FILES' });

  const results = [];

  for (const f of files) {
    const file_id = uuidv4();
    await pool.query(
      `INSERT INTO import_files (id, batch_id, original_name, mime_type, size_bytes, status)
       VALUES ($1,$2,$3,$4,$5,'PROCESSING')`,
      [file_id, batch_id, f.originalname, f.mimetype, f.size]
    );

    try {
      const { type, workbook } = detectExcelType(f.buffer, f.originalname);
      let inserted = 0;

      const client = await pool.connect();
      try {
        await client.query('BEGIN');

        if (type === 'VEHICLE') {
          const { plate, records } = parseVehicleFuelWorkbook(workbook, f.originalname);
          const vehicle_id = await ensureVehicle(plate);

          // allow re-import of the same file: delete previous rows from this source
          await client.query(
            'DELETE FROM vehicle_fuel_logs WHERE source_file_name=$1',
            [f.originalname]
          );

          for (const r of records) {
            await client.query(
              `INSERT INTO vehicle_fuel_logs (
                id, vehicle_id, log_date, day_name, day_no,
                km_depart, km_arrivee, km_jour,
                km_between_refill, consumption, interval_days,
                compteur, liters, montant_ar,
                lien, chauffeur, frns,
                is_refill, is_mission, mission_label,
                source_file_name, sheet_name, row_in_sheet,
                import_batch_id, import_file_id
              ) VALUES (
                $1,$2,$3,$4,$5,
                $6,$7,$8,
                $9,$10,$11,
                $12,$13,$14,
                $15,$16,$17,
                $18,$19,$20,
                $21,$22,$23,
                $24,$25
              )`,
              [
                uuidv4(),
                vehicle_id,
                r.log_date || null,
                r.day_name || null,
                r.day_no || null,
                r.km_depart,
                r.km_arrivee,
                r.km_jour,
                r.km_between_refill,
                r.consumption,
                r.interval_days,
                r.compteur,
                r.liters,
                r.montant_ar,
                r.lien,
                r.chauffeur,
                r.frns,
                !!r.is_refill,
                !!r.is_mission,
                r.mission_label || null,
                r.source_file_name,
                r.sheet_name,
                r.row_in_sheet,
                batch_id,
                file_id
              ]
            );
            inserted += 1;
          }
        } else if (type === 'GENERATOR') {
          const { records } = parseGeneratorWorkbook(workbook, f.originalname);
          await client.query('DELETE FROM generator_fuel_logs WHERE source_file_name=$1', [f.originalname]);
          for (const r of records) {
            await client.query(
              `INSERT INTO generator_fuel_logs (
                id, log_date, liters, montant_ar,
                source_file_name, sheet_name, row_in_sheet,
                import_batch_id, import_file_id
              ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9)`,
              [uuidv4(), r.log_date, r.liters, r.montant_ar, r.source_file_name, r.sheet_name, r.row_in_sheet, batch_id, file_id]
            );
            inserted += 1;
          }
        } else if (type === 'OTHER') {
          const { records } = parseOtherWorkbook(workbook, f.originalname);
          await client.query('DELETE FROM other_fuel_logs WHERE source_file_name=$1', [f.originalname]);
          for (const r of records) {
            await client.query(
              `INSERT INTO other_fuel_logs (
                id, log_date, liters, montant_ar, lien,
                source_file_name, sheet_name, row_in_sheet,
                import_batch_id, import_file_id
              ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10)`,
              [uuidv4(), r.log_date, r.liters, r.montant_ar, r.lien, r.source_file_name, r.sheet_name, r.row_in_sheet, batch_id, file_id]
            );
            inserted += 1;
          }
        } else {
          throw new Error(`TYPE_NOT_SUPPORTED:${type}`);
        }

        await client.query(
          'UPDATE import_files SET status=$2, detected_type=$3, inserted_rows=$4, processed_at=now() WHERE id=$1',
          [file_id, 'DONE', type, inserted]
        );

        await client.query('COMMIT');
        results.push({ file: f.originalname, type, inserted });
      } catch (e) {
        await client.query('ROLLBACK');
        throw e;
      } finally {
        client.release();
      }

    } catch (e) {
      await pool.query(
        'UPDATE import_files SET status=$2, error_message=$3, processed_at=now() WHERE id=$1',
        [file_id, 'ERROR', String(e.message || e)]
      );
      results.push({ file: f.originalname, error: String(e.message || e) });
    }
  }

  res.json({ batch_id, results });
}

async function listBatches(req, res) {
  if (!['ADMIN', 'LOGISTIQUE', 'RAF'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const { rows } = await pool.query(
    `SELECT ib.id, ib.created_at, u.username AS created_by, COUNT(if2.id) AS files,
            COALESCE(SUM(if2.inserted_rows),0) AS inserted_rows
     FROM import_batches ib
     JOIN users u ON u.id=ib.created_by
     LEFT JOIN import_files if2 ON if2.batch_id=ib.id
     GROUP BY ib.id, ib.created_at, u.username
     ORDER BY ib.created_at DESC
     LIMIT 100`
  );
  res.json({ batches: rows });
}

async function listFiles(req, res) {
  if (!['ADMIN', 'LOGISTIQUE', 'RAF'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const { batch_id } = req.params;
  const { rows } = await pool.query(
    `SELECT * FROM import_files WHERE batch_id=$1 ORDER BY created_at ASC`,
    [batch_id]
  );
  res.json({ files: rows });
}

module.exports = { upload, createBatch, uploadAndImport, listBatches, listFiles };


────────────────── server/src/controllers/fuelRequestsController.js ──────────────────
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');

function fmtNo(seq, year) {
  return `N° ${String(seq).padStart(3, '0')}/${year}`;
}

async function nextRequestNo(client) {
  const year = new Date().getFullYear();
  const { rows } = await client.query(
    `SELECT COALESCE(MAX(seq),0) AS max_seq
     FROM fuel_requests
     WHERE year=$1`,
    [year]
  );
  const nextSeq = Number(rows[0].max_seq) + 1;
  return { year, seq: nextSeq, request_no: fmtNo(nextSeq, year) };
}

const createSchema = z.object({
  request_type: z.enum(['SERVICE', 'MISSION']),
  objet: z.string().min(1),
  amount_estimated_ar: z.number().int().nonnegative(),
  amount_estimated_words: z.string().min(1),
  request_date: z.string().min(4) // YYYY-MM-DD
});

async function list(req, res) {
  const role = req.user.role;
  const userId = req.user.id;

  let sql = `SELECT fr.*, u.username AS requester_username
             FROM fuel_requests fr
             JOIN users u ON u.id=fr.requester_id`;
  const params = [];
  if (role === 'DEMANDEUR') {
    sql += ' WHERE fr.deleted_at IS NULL AND fr.requester_id=$1';
    params.push(userId);
  } else {
    sql += ' WHERE fr.deleted_at IS NULL';
  }
  sql += ' ORDER BY fr.created_at DESC LIMIT 500';

  const { rows } = await pool.query(sql, params);
  res.json({ requests: rows });
}

async function getOne(req, res) {
  const { id } = req.params;
  const role = req.user.role;

  const params = [id];
  let where = 'fr.id=$1';
  if (role === 'DEMANDEUR') {
    params.push(req.user.id);
    where += ' AND fr.requester_id=$2';
  }

  where = `fr.deleted_at IS NULL AND ${where}`;

  const { rows } = await pool.query(
    `SELECT fr.*, u.username AS requester_username
     FROM fuel_requests fr
     JOIN users u ON u.id=fr.requester_id
     WHERE ${where}`,
    params
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ request: rows[0] });
}

async function softDelete(req, res) {
  const { id } = req.params;
  if (!['ADMIN', 'LOGISTIQUE'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE fuel_requests
     SET deleted_at=now(), updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}

async function create(req, res) {
  const parsed = createSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const client = await pool.connect();
  try {
    await client.query('BEGIN');
    const { year, seq, request_no } = await nextRequestNo(client);

    const id = uuidv4();
    const data = parsed.data;
    await client.query(
      `INSERT INTO fuel_requests (
        id, year, seq, request_no, request_type, objet,
        amount_estimated_ar, amount_estimated_words, request_date,
        status, requester_id
      ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,'DRAFT',$10)`,
      [
        id,
        year,
        seq,
        request_no,
        data.request_type,
        data.objet,
        data.amount_estimated_ar,
        data.amount_estimated_words,
        data.request_date,
        req.user.id
      ]
    );
    await client.query('COMMIT');

    const { rows } = await pool.query(
      `SELECT fr.*, u.username AS requester_username
       FROM fuel_requests fr JOIN users u ON u.id=fr.requester_id
       WHERE fr.id=$1`,
      [id]
    );
    res.json({ request: rows[0] });
  } catch (e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    client.release();
  }
}

async function submit(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  if (role !== 'DEMANDEUR') return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE fuel_requests
     SET status='SUBMITTED', submitted_at=now(), updated_at=now()
     WHERE id=$1 AND requester_id=$2 AND status IN ('DRAFT','REJECTED')
     RETURNING *`,
    [id, req.user.id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ request: rows[0] });
}

async function verify(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  if (!['LOGISTIQUE', 'ADMIN'].includes(role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE fuel_requests
     SET status='VERIFIED', verified_at=now(), verified_by=$2, updated_at=now()
     WHERE id=$1 AND status='SUBMITTED'
     RETURNING *`,
    [id, req.user.id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

async function approve(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  if (!['RAF', 'ADMIN'].includes(role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE fuel_requests
     SET status='APPROVED', approved_at=now(), approved_by=$2, updated_at=now()
     WHERE id=$1 AND status='VERIFIED'
     RETURNING *`,
    [id, req.user.id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

async function reject(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  if (!['LOGISTIQUE', 'RAF', 'ADMIN'].includes(role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { reason } = req.body || {};
  const { rows } = await pool.query(
    `UPDATE fuel_requests
     SET status='REJECTED', rejected_at=now(), rejected_by=$2, reject_reason=$3, updated_at=now()
     WHERE id=$1 AND status IN ('SUBMITTED','VERIFIED')
     RETURNING *`,
    [id, req.user.id, reason || null]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}



const updateSchema = z.object({
  request_type: z.enum(['SERVICE', 'MISSION']).optional(),
  objet: z.string().min(1).optional(),
  amount_estimated_ar: z.number().int().nonnegative().optional(),
  amount_estimated_words: z.string().min(1).optional(),
  request_date: z.string().min(4).optional() // YYYY-MM-DD
});

async function update(req, res) {
  const { id } = req.params;
  const role = req.user.role;

  const parsed = updateSchema.safeParse(req.body || {});
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  const data = parsed.data;

  // Nothing to update
  if (!Object.keys(data).length) return res.json({ ok: true });

  // Permissions:
  // - Demandeur can update own request only when DRAFT or REJECTED
  // - Admin/Logistique can update any non-deleted request (used for corrections)
  const params = [id];
  let where = 'id=$1 AND deleted_at IS NULL';
  if (role === 'DEMANDEUR') {
    params.push(req.user.id);
    where += " AND requester_id=$2 AND status IN ('DRAFT','REJECTED')";
  } else if (!['ADMIN', 'LOGISTIQUE'].includes(role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const set = [];
  const values = [];
  let idx = params.length + 1

  for (const [k, v] of Object.entries(data)) {
    set.push(`${k}=$${idx++}`);
    values.push(v);
  }
  set.push(`updated_at=now()`);

  const sql = `UPDATE fuel_requests SET ${set.join(', ')} WHERE ${where} RETURNING *`;
  const { rows } = await pool.query(sql, [...params, ...values]);
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_FORBIDDEN_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

module.exports = { list, getOne, create, submit, verify, approve, reject, softDelete, update };


────────────────── server/src/controllers/fuelController.js ──────────────────
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');

// SEUIL pour considérer un ajout comme un "PLEIN" (en Ariary)
// Idéalement, à mettre dans une table 'settings' en base de données.
const REFILL_THRESHOLD = 200000;

function buildWhereVehicle({ vehicle_id, from, to, only_refill }) {
  const clauses = [];
  const params = [];
  // Toujours exclure les éléments supprimés
  clauses.push('vfl.deleted_at IS NULL');
  
  if (vehicle_id) {
    params.push(vehicle_id);
    clauses.push(`vehicle_id=$${params.length}`);
  }
  if (from) {
    params.push(from);
    clauses.push(`log_date >= $${params.length}`);
  }
  if (to) {
    params.push(to);
    clauses.push(`log_date <= $${params.length}`);
  }
  if (only_refill === 'true') {
    clauses.push(`is_refill=true`);
  }
  return { where: clauses.length ? 'WHERE ' + clauses.join(' AND ') : '', params };
}

function buildWhereDate({ from, to }) {
  const clauses = [];
  const params = [];
  // Toujours exclure les éléments supprimés
  clauses.push('deleted_at IS NULL');
  
  if (from) {
    params.push(from);
    clauses.push(`log_date >= $${params.length}`);
  }
  if (to) {
    params.push(to);
    clauses.push(`log_date <= $${params.length}`);
  }
  return { where: clauses.length ? 'WHERE ' + clauses.join(' AND ') : '', params };
}

// ========== LIST ==========
async function listVehicleFuel(req, res) {
  const { vehicle_id, from, to, only_refill } = req.query;
  const { where, params } = buildWhereVehicle({ vehicle_id, from, to, only_refill });
  const { rows } = await pool.query(
    `SELECT vfl.*, v.plate
     FROM vehicle_fuel_logs vfl
     JOIN vehicles v ON v.id=vfl.vehicle_id
     ${where}
     ORDER BY log_date ASC NULLS LAST, sheet_name ASC, row_in_sheet ASC
     LIMIT 5000`,
    params
  );
  res.json({ logs: rows });
}

async function listGeneratorFuel(req, res) {
  const { from, to } = req.query;
  const { where, params } = buildWhereDate({ from, to });
  const { rows } = await pool.query(
    `SELECT * FROM generator_fuel_logs ${where} ORDER BY log_date ASC NULLS LAST LIMIT 5000`,
    params
  );
  res.json({ logs: rows });
}

async function listOtherFuel(req, res) {
  const { from, to } = req.query;
  const { where, params } = buildWhereDate({ from, to });
  const { rows } = await pool.query(
    `SELECT * FROM other_fuel_logs ${where} ORDER BY log_date ASC NULLS LAST LIMIT 5000`,
    params
  );
  res.json({ logs: rows });
}

// ========== UPDATE VEHICLE FUEL (avec logique métier) ==========
const updateVehicleSchema = z.object({
  log_date: z.string().min(4).optional(),
  km_depart: z.number().int().optional().nullable(),
  km_arrivee: z.number().int().optional().nullable(),
  km_jour: z.number().int().optional().nullable(),
  compteur: z.number().int().optional().nullable(),
  liters: z.number().optional().nullable(),
  montant_ar: z.number().int().optional().nullable(),
  lien: z.string().optional().nullable(),
  chauffeur: z.string().optional().nullable(),
  frns: z.string().optional().nullable()
});

async function updateVehicleFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  const parsed = updateVehicleSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const data = parsed.data;
  
  // ========== LOGIQUE MÉTIER : Calcul automatique ==========
  // Si km_depart ou km_arrivee change, recalculer km_jour
  if (data.km_depart !== undefined || data.km_arrivee !== undefined) {
    const current = await pool.query('SELECT km_depart, km_arrivee FROM vehicle_fuel_logs WHERE id=$1 AND deleted_at IS NULL', [id]);
    if (current.rows[0]) {
      const kmDep = data.km_depart ?? current.rows[0].km_depart;
      const kmArr = data.km_arrivee ?? current.rows[0].km_arrivee;
      if (kmDep !== null && kmArr !== null) {
        data.km_jour = kmArr - kmDep;
      }
    }
  }

  // Si montant_ar change, recalculer is_refill
  if (data.montant_ar !== undefined) {
    data.is_refill = data.montant_ar !== null && data.montant_ar >= REFILL_THRESHOLD;
  }

  const fields = [];
  const values = [];
  let idx = 1;
  for (const [key, val] of Object.entries(data)) {
    fields.push(`${key}=$${idx++}`);
    values.push(val);
  }

  if (fields.length === 0) {
    return res.json({ ok: true });
  }

  values.push(id);
  const sql = `UPDATE vehicle_fuel_logs SET ${fields.join(', ')} WHERE id=$${idx} AND deleted_at IS NULL RETURNING *`;
  const { rows } = await pool.query(sql, values);
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ log: rows[0] });
}

// ========== SOFT DELETE VEHICLE FUEL ==========
async function softDeleteVehicleFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  
  const { rows } = await pool.query(
    'UPDATE vehicle_fuel_logs SET deleted_at=now() WHERE id=$1 AND deleted_at IS NULL RETURNING id',
    [id]
  );
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ ok: true, message: 'Déplacé dans la corbeille' });
}

// ========== UPDATE GENERATOR FUEL ==========
const updateGeneratorSchema = z.object({
  log_date: z.string().min(4).optional(),
  liters: z.number().optional().nullable(),
  montant_ar: z.number().int().optional().nullable()
});

async function updateGeneratorFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  const parsed = updateGeneratorSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const data = parsed.data;
  const fields = [];
  const values = [];
  let idx = 1;
  for (const [key, val] of Object.entries(data)) {
    fields.push(`${key}=$${idx++}`);
    values.push(val);
  }

  if (fields.length === 0) {
    return res.json({ ok: true });
  }

  values.push(id);
  const sql = `UPDATE generator_fuel_logs SET ${fields.join(', ')} WHERE id=$${idx} AND deleted_at IS NULL RETURNING *`;
  const { rows } = await pool.query(sql, values);
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ log: rows[0] });
}

// ========== SOFT DELETE GENERATOR FUEL ==========
async function softDeleteGeneratorFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  
  const { rows } = await pool.query(
    'UPDATE generator_fuel_logs SET deleted_at=now() WHERE id=$1 AND deleted_at IS NULL RETURNING id',
    [id]
  );
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ ok: true, message: 'Déplacé dans la corbeille' });
}

// ========== UPDATE OTHER FUEL ==========
const updateOtherSchema = z.object({
  log_date: z.string().min(4).optional(),
  liters: z.number().optional().nullable(),
  montant_ar: z.number().int().optional().nullable(),
  lien: z.string().optional().nullable()
});

async function updateOtherFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  const parsed = updateOtherSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const data = parsed.data;
  const fields = [];
  const values = [];
  let idx = 1;
  for (const [key, val] of Object.entries(data)) {
    fields.push(`${key}=$${idx++}`);
    values.push(val);
  }

  if (fields.length === 0) {
    return res.json({ ok: true });
  }

  values.push(id);
  const sql = `UPDATE other_fuel_logs SET ${fields.join(', ')} WHERE id=$${idx} AND deleted_at IS NULL RETURNING *`;
  const { rows } = await pool.query(sql, values);
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ log: rows[0] });
}

// ========== SOFT DELETE OTHER FUEL ==========
async function softDeleteOtherFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  
  const { rows } = await pool.query(
    'UPDATE other_fuel_logs SET deleted_at=now() WHERE id=$1 AND deleted_at IS NULL RETURNING id',
    [id]
  );
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ ok: true, message: 'Déplacé dans la corbeille' });
}

// ========== REPORTS & KPIs ==========
async function reportSummary(req, res) {
  const { from, to, vehicle_id } = req.query;
  const v = buildWhereVehicle({ vehicle_id, from, to, only_refill: 'false' });
  const d = buildWhereDate({ from, to });

  const vehicleRes = await pool.query(
    `SELECT COALESCE(SUM(montant_ar),0) AS montant_ar,
            COALESCE(SUM(liters),0) AS liters,
            COUNT(*) FILTER (WHERE is_refill) AS refills
     FROM vehicle_fuel_logs vfl
     ${v.where}`,
    v.params
  );
  const genRes = await pool.query(
    `SELECT COALESCE(SUM(montant_ar),0) AS montant_ar,
            COALESCE(SUM(liters),0) AS liters,
            COUNT(*) AS count
     FROM generator_fuel_logs
     ${d.where}`,
    d.params
  );
  const otherRes = await pool.query(
    `SELECT COALESCE(SUM(montant_ar),0) AS montant_ar,
            COALESCE(SUM(liters),0) AS liters,
            COUNT(*) AS count
     FROM other_fuel_logs
     ${d.where}`,
    d.params
  );

  res.json({
    vehicle: vehicleRes.rows[0],
    generator: genRes.rows[0],
    other: otherRes.rows[0]
  });
}

async function kpiDaily(req, res) {
  const { from, to, vehicle_id } = req.query;
  const v = buildWhereVehicle({ vehicle_id, from, to, only_refill: 'false' });
  const { rows } = await pool.query(
    `SELECT log_date,
            COALESCE(SUM(liters),0) AS liters,
            COALESCE(SUM(montant_ar),0) AS montant_ar,
            COUNT(*) FILTER (WHERE is_refill) AS refills
     FROM vehicle_fuel_logs vfl
     ${v.where}
     GROUP BY log_date
     ORDER BY log_date ASC NULLS LAST`,
    v.params
  );
  res.json({ points: rows });
}


async function kpiDailyBulk(req, res) {
  const { from, to, vehicle_ids } = req.query;

  // vehicle_ids attendu: "uuid1,uuid2,uuid3"
  const raw = String(vehicle_ids || '');
  const ids = raw
    .split(',')
    .map((s) => s.trim())
    .filter(Boolean);

  const parsed = z.array(z.string().uuid()).max(50).safeParse(ids);
  if (!parsed.success || parsed.data.length === 0) {
    return res.status(400).json({ error: 'vehicle_ids invalide' });
  }

  const clauses = ['vfl.deleted_at IS NULL'];
  const params = [];

  if (from) {
    params.push(from);
    clauses.push(`vfl.log_date >= $${params.length}`);
  }
  if (to) {
    params.push(to);
    clauses.push(`vfl.log_date <= $${params.length}`);
  }

  params.push(parsed.data);
  clauses.push(`vfl.vehicle_id = ANY($${params.length}::uuid[])`);

  const where = 'WHERE ' + clauses.join(' AND ');

  const { rows } = await pool.query(
    `SELECT vfl.vehicle_id,
            vfl.log_date,
            COALESCE(SUM(vfl.liters),0) AS liters,
            COALESCE(SUM(vfl.montant_ar),0) AS montant_ar,
            COUNT(*) FILTER (WHERE vfl.is_refill) AS refills
     FROM vehicle_fuel_logs vfl
     ${where}
     GROUP BY vfl.vehicle_id, vfl.log_date
     ORDER BY vfl.vehicle_id ASC, vfl.log_date ASC NULLS LAST`,
    params
  );

  // { [vehicle_id]: points[] } (toujours inclure les ids demandés)
  const series = {};
  for (const id of parsed.data) series[id] = [];
  for (const r of rows) {
    if (!series[r.vehicle_id]) series[r.vehicle_id] = [];
    series[r.vehicle_id].push({
      log_date: r.log_date,
      liters: r.liters,
      montant_ar: r.montant_ar,
      refills: r.refills,
    });
  }

  res.json({ series });
}

async function kpiByVehicle(req, res) {
  const { from, to } = req.query;
  const v = buildWhereVehicle({ vehicle_id: null, from, to, only_refill: 'false' });
  const { rows } = await pool.query(
    `SELECT v.plate,
            COALESCE(SUM(vfl.liters),0) AS liters,
            COALESCE(SUM(vfl.montant_ar),0) AS montant_ar,
            COUNT(*) FILTER (WHERE vfl.is_refill) AS refills
     FROM vehicle_fuel_logs vfl
     JOIN vehicles v ON v.id=vfl.vehicle_id
     ${v.where}
     GROUP BY v.plate
     ORDER BY montant_ar DESC`,
    v.params
  );
  res.json({ rows });
}

// ========== MANUAL ADD ==========
const manualVehicleSchema = z.object({
  vehicle_id: z.string().uuid(),
  log_date: z.string().min(4),
  km_depart: z.number().int().optional().nullable(),
  km_arrivee: z.number().int().optional().nullable(),
  km_jour: z.number().int().optional().nullable(),
  compteur: z.number().int().optional().nullable(),
  liters: z.number().optional().nullable(),
  montant_ar: z.number().int().optional().nullable(),
  lien: z.string().optional().nullable(),
  chauffeur: z.string().optional().nullable(),
  frns: z.string().optional().nullable()
});

async function manualAddVehicle(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const parsed = manualVehicleSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const d = parsed.data;
  const is_refill = d.montant_ar !== null && d.montant_ar !== undefined && d.montant_ar >= REFILL_THRESHOLD;

  const id = uuidv4();
  await pool.query(
    `INSERT INTO vehicle_fuel_logs (
      id, vehicle_id, log_date,
      km_depart, km_arrivee, km_jour,
      compteur, liters, montant_ar,
      lien, chauffeur, frns,
      is_refill,
      source_file_name, sheet_name, row_in_sheet,
      import_batch_id, import_file_id
    ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,'MANUAL','MANUAL',0,NULL,NULL)`,
    [
      id,
      d.vehicle_id,
      d.log_date,
      d.km_depart ?? null,
      d.km_arrivee ?? null,
      d.km_jour ?? null,
      d.compteur ?? null,
      d.liters ?? null,
      d.montant_ar ?? null,
      d.lien ?? null,
      d.chauffeur ?? null,
      d.frns ?? null,
      is_refill
    ]
  );
  const { rows } = await pool.query(
    `SELECT vfl.*, v.plate
     FROM vehicle_fuel_logs vfl JOIN vehicles v ON v.id=vfl.vehicle_id
     WHERE vfl.id=$1`,
    [id]
  );
  res.json({ log: rows[0] });
}

const manualSimpleSchema = z.object({
  log_date: z.string().min(4),
  liters: z.number().optional().nullable(),
  montant_ar: z.number().int().optional().nullable(),
  lien: z.string().optional().nullable()
});

async function manualAddGenerator(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const parsed = manualSimpleSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  const d = parsed.data;
  const id = uuidv4();
  await pool.query(
    `INSERT INTO generator_fuel_logs (id, log_date, liters, montant_ar, source_file_name, sheet_name, row_in_sheet)
     VALUES ($1,$2,$3,$4,'MANUAL','MANUAL',0)`,
    [id, d.log_date, d.liters ?? null, d.montant_ar ?? null]
  );
  const { rows } = await pool.query('SELECT * FROM generator_fuel_logs WHERE id=$1', [id]);
  res.json({ log: rows[0] });
}

async function manualAddOther(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const parsed = manualSimpleSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  const d = parsed.data;
  const id = uuidv4();
  await pool.query(
    `INSERT INTO other_fuel_logs (id, log_date, liters, montant_ar, lien, source_file_name, sheet_name, row_in_sheet)
     VALUES ($1,$2,$3,$4,$5,'MANUAL','MANUAL',0)`,
    [id, d.log_date, d.liters ?? null, d.montant_ar ?? null, d.lien ?? null]
  );
  const { rows } = await pool.query('SELECT * FROM other_fuel_logs WHERE id=$1', [id]);
  res.json({ log: rows[0] });
}

// ========== EXPORT CSV ==========
function csvEscape(v) {
  if (v === null || v === undefined) return '';
  const s = String(v);
  if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
  return s;
}

async function exportCsv(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { type } = req.params;
  const { from, to, vehicle_id } = req.query;

  let rows = [];
  let header = [];

  if (type === 'vehicle') {
    const v = buildWhereVehicle({ vehicle_id, from, to, only_refill: 'false' });
    const q = await pool.query(
      `SELECT v.plate, vfl.*
       FROM vehicle_fuel_logs vfl
       JOIN vehicles v ON v.id=vfl.vehicle_id
       ${v.where}
       ORDER BY log_date ASC NULLS LAST, sheet_name ASC, row_in_sheet ASC`,
      v.params
    );
    rows = q.rows;
    header = [
      'plate','log_date','day_name','day_no','km_depart','km_arrivee','km_jour','km_between_refill','consumption',
      'interval_days','compteur','liters','montant_ar','lien','chauffeur','frns','is_refill','is_mission','mission_label',
      'source_file_name','sheet_name','row_in_sheet'
    ];
  } else if (type === 'generator') {
    const d = buildWhereDate({ from, to });
    const q = await pool.query(
      `SELECT * FROM generator_fuel_logs ${d.where} ORDER BY log_date ASC NULLS LAST`,
      d.params
    );
    rows = q.rows;
    header = ['log_date','liters','montant_ar','source_file_name','sheet_name','row_in_sheet'];
  } else if (type === 'other') {
    const d = buildWhereDate({ from, to });
    const q = await pool.query(
      `SELECT * FROM other_fuel_logs ${d.where} ORDER BY log_date ASC NULLS LAST`,
      d.params
    );
    rows = q.rows;
    header = ['log_date','liters','montant_ar','lien','source_file_name','sheet_name','row_in_sheet'];
  } else {
    return res.status(400).json({ error: 'BAD_TYPE' });
  }

  const lines = [];
  lines.push(header.join(','));
  for (const r of rows) {
    lines.push(header.map((h) => csvEscape(r[h])).join(','));
  }

  res.setHeader('Content-Type', 'text/csv; charset=utf-8');
  res.setHeader('Content-Disposition', `attachment; filename="${type}_export.csv"`);
  res.send(lines.join('\n'));
}

module.exports = {
  listVehicleFuel,
  listGeneratorFuel,
  listOtherFuel,
  reportSummary,
  kpiDaily,
  kpiDailyBulk,
  kpiByVehicle,
  manualAddVehicle,
  manualAddGenerator,
  manualAddOther,
  exportCsv,
  updateVehicleFuel,
  softDeleteVehicleFuel,
  updateGeneratorFuel,
  softDeleteGeneratorFuel,
  updateOtherFuel,
  softDeleteOtherFuel
};

────────────────── server/src/controllers/carRequestsController.js ──────────────────
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');

function fmtNo(seq, year) {
  return `N° ${String(seq).padStart(3, '0')}/${year}`;
}

async function nextRequestNo(client) {
  const year = new Date().getFullYear();
  const { rows } = await client.query(
    `SELECT COALESCE(MAX(seq),0) AS max_seq
     FROM car_requests
     WHERE year=$1`,
    [year]
  );
  const nextSeq = Number(rows[0].max_seq) + 1;
  return { year, seq: nextSeq, request_no: fmtNo(nextSeq, year) };
}

const createSchema = z.object({
  proposed_date: z.string().min(4),
  objet: z.string().min(1),
  itinerary: z.string().min(1),
  people: z.string().optional().nullable(),
  depart_time_wanted: z.string().optional().nullable(),
  return_time_expected: z.string().optional().nullable(),
  vehicle_hint: z.string().optional().nullable(),
  driver_hint: z.string().optional().nullable()
});

async function list(req, res) {
  const role = req.user.role;
  const userId = req.user.id;

  let sql = `SELECT cr.*, u.username AS requester_username,
                    v.plate AS vehicle_plate, d.full_name AS driver_name
             FROM car_requests cr
             JOIN users u ON u.id=cr.requester_id
             LEFT JOIN vehicles v ON v.id=cr.vehicle_id
             LEFT JOIN drivers d ON d.id=cr.driver_id`;
  const params = [];
  if (role === 'DEMANDEUR') {
    sql += ' WHERE cr.deleted_at IS NULL AND cr.requester_id=$1';
    params.push(userId);
  } else {
    sql += ' WHERE cr.deleted_at IS NULL';
  }
  sql += ' ORDER BY cr.created_at DESC LIMIT 500';
  const { rows } = await pool.query(sql, params);
  res.json({ requests: rows });
}

async function getOne(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  const params = [id];
  let where = 'cr.deleted_at IS NULL AND cr.id=$1';
  if (role === 'DEMANDEUR') {
    params.push(req.user.id);
    where += ' AND cr.requester_id=$2';
  }
  const { rows } = await pool.query(
    `SELECT cr.*, u.username AS requester_username,
            v.plate AS vehicle_plate, d.full_name AS driver_name
     FROM car_requests cr
     JOIN users u ON u.id=cr.requester_id
     LEFT JOIN vehicles v ON v.id=cr.vehicle_id
     LEFT JOIN drivers d ON d.id=cr.driver_id
     WHERE ${where}`,
    params
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ request: rows[0] });
}

async function create(req, res) {
  const parsed = createSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const client = await pool.connect();
  try {
    await client.query('BEGIN');
    const { year, seq, request_no } = await nextRequestNo(client);

    const id = uuidv4();
    const d = parsed.data;
    await client.query(
      `INSERT INTO car_requests (
        id, year, seq, request_no,
        proposed_date, objet, itinerary, people,
        depart_time_wanted, return_time_expected,
        vehicle_hint, driver_hint,
        status, requester_id
      ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,'SUBMITTED',$13)`,
      [
        id,
        year,
        seq,
        request_no,
        d.proposed_date,
        d.objet,
        d.itinerary,
        d.people || null,
        d.depart_time_wanted || null,
        d.return_time_expected || null,
        d.vehicle_hint || null,
        d.driver_hint || null,
        req.user.id
      ]
    );
    await client.query('COMMIT');

    const { rows } = await pool.query('SELECT * FROM car_requests WHERE id=$1', [id]);
    res.json({ request: rows[0] });
  } catch (e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    client.release();
  }
}

async function logisticsApprove(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { vehicle_id, driver_id } = req.body || {};

  const { rows } = await pool.query(
    `UPDATE car_requests
     SET status='LOGISTICS_APPROVED', logistics_at=now(), logistics_by=$2,
         vehicle_id=$3, driver_id=$4, updated_at=now()
     WHERE id=$1 AND status='SUBMITTED'
     RETURNING *`,
    [id, req.user.id, vehicle_id || null, driver_id || null]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

async function rafApprove(req, res) {
  const { id } = req.params;
  if (!['RAF', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE car_requests
     SET status='RAF_APPROVED', raf_at=now(), raf_by=$2,
         authorization_date=COALESCE(authorization_date, CURRENT_DATE),
         authorization_time=COALESCE(authorization_time, CURRENT_TIME),
         updated_at=now()
     WHERE id=$1 AND status='LOGISTICS_APPROVED'
     RETURNING *`,
    [id, req.user.id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

async function reject(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'RAF', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const { reason } = req.body || {};

  const { rows } = await pool.query(
    `UPDATE car_requests
     SET status='REJECTED', rejected_at=now(), rejected_by=$2, reject_reason=$3, updated_at=now()
     WHERE id=$1 AND status IN ('SUBMITTED','LOGISTICS_APPROVED')
     RETURNING *`,
    [id, req.user.id, reason || null]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

async function softDelete(req, res) {
  const { id } = req.params;
  if (!['ADMIN', 'LOGISTIQUE'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE car_requests
     SET deleted_at=now(), updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}



const updateSchema = z.object({
  proposed_date: z.string().min(4).optional(),
  objet: z.string().min(1).optional(),
  itinerary: z.string().min(1).optional(),
  people: z.string().min(1).optional(),
  depart_time_wanted: z.string().optional().nullable(),
  return_time_expected: z.string().optional().nullable(),
  vehicle_hint: z.string().optional().nullable(),
  driver_hint: z.string().optional().nullable()
});

async function update(req, res) {
  const { id } = req.params;
  const role = req.user.role;

  const parsed = updateSchema.safeParse(req.body || {});
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  const data = parsed.data;
  if (!Object.keys(data).length) return res.json({ ok: true });

  const params = [id];
  let where = "id=$1 AND deleted_at IS NULL AND status='SUBMITTED'";

  if (role === 'DEMANDEUR') {
    params.push(req.user.id);
    where += ' AND requester_id=$2';
  } else if (!['ADMIN', 'LOGISTIQUE'].includes(role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const set = [];
  const values = [];
  let idx = params.length + 1;

  for (const [k, v] of Object.entries(data)) {
    set.push(`${k}=$${idx++}`);
    values.push(v === '' ? null : v);
  }
  set.push('updated_at=now()');

  const sql = `UPDATE car_requests SET ${set.join(', ')} WHERE ${where} RETURNING *`;
  const { rows } = await pool.query(sql, [...params, ...values]);
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_FORBIDDEN_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

module.exports = { list, getOne, create, update, logisticsApprove, rafApprove, reject, softDelete };


────────────────── server/src/controllers/authController.js ──────────────────
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const { v4: uuidv4 } = require('uuid');
const { z } = require('zod');
const { pool } = require('../db');
const { sendResetEmail } = require('../utils/mailer');

const ROLES = ['DEMANDEUR', 'LOGISTIQUE', 'RAF', 'ADMIN'];

function signToken(user) {
  return jwt.sign(
    {
      id: user.id,
      username: user.username,
      role: user.role,
      first_name: user.first_name,
      last_name: user.last_name
    },
    process.env.JWT_SECRET,
    { expiresIn: '12h' }
  );
}

const registerSchema = z.object({
  first_name: z.string().min(1),
  last_name: z.string().min(1),
  username: z.string().min(3),
  email: z.string().email(),
  role: z.enum(ROLES),
  password: z.string().min(6)
});

async function register(req, res) {
  const parsed = registerSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const { first_name, last_name, username, email, role, password } = parsed.data;
  const password_hash = await bcrypt.hash(password, 10);

  const id = uuidv4();
  try {
    await pool.query(
      `INSERT INTO users (id, first_name, last_name, username, email, role, password_hash)
       VALUES ($1,$2,$3,$4,$5,$6,$7)`,
      [id, first_name, last_name, username, email, role, password_hash]
    );
  } catch (e) {
    if (String(e.message).includes('users_username_key') || String(e.message).includes('users_email_key')) {
      return res.status(409).json({ error: 'DUPLICATE_USER' });
    }
    throw e;
  }

  const { rows } = await pool.query('SELECT id, first_name, last_name, username, email, role FROM users WHERE id=$1', [id]);
  const user = rows[0];
  const token = signToken(user);
  return res.json({ token, user });
}

const loginSchema = z.object({
  username: z.string().min(1),
  role: z.enum(ROLES),
  password: z.string().min(1)
});

async function login(req, res) {
  const parsed = loginSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  // Trim to avoid common UX issues (copy/paste spaces)
  const username = String(parsed.data.username || '').trim();
  const role = parsed.data.role;
  const password = String(parsed.data.password || '');
  const { rows } = await pool.query(
    'SELECT id, first_name, last_name, username, email, role, password_hash, is_active FROM users WHERE username=$1',
    [username]
  );
  const user = rows[0];
  if (!user || !user.is_active) {
    return res.status(401).json({ error: 'INVALID_CREDENTIALS' });
  }
  if (user.role !== role) {
    return res.status(401).json({ error: 'ROLE_MISMATCH', expectedRole: user.role });
  }
  const ok = await bcrypt.compare(password, user.password_hash);
  if (!ok) {
    return res.status(401).json({ error: 'INVALID_CREDENTIALS' });
  }

  const token = signToken(user);
  const safeUser = {
    id: user.id,
    first_name: user.first_name,
    last_name: user.last_name,
    username: user.username,
    email: user.email,
    role: user.role
  };
  return res.json({ token, user: safeUser });
}

const forgotSchema = z.object({ email: z.string().email() });

async function forgotPassword(req, res) {
  const parsed = forgotSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const { email } = parsed.data;
  const { rows } = await pool.query('SELECT id, email FROM users WHERE email=$1 AND is_active=true', [email]);
  const user = rows[0];
  // Always return OK to avoid user enumeration
  if (!user) {
    return res.json({ ok: true });
  }

  const tokenPlain = uuidv4().replace(/-/g, '') + uuidv4().replace(/-/g, '');
  const tokenHash = await bcrypt.hash(tokenPlain, 10);
  const expiresAt = new Date(Date.now() + 1000 * 60 * 30); // 30 min

  await pool.query(
    `INSERT INTO password_reset_tokens (id, user_id, token_hash, expires_at)
     VALUES ($1,$2,$3,$4)`,
    [uuidv4(), user.id, tokenHash, expiresAt]
  );

  await sendResetEmail(email, tokenPlain);
  return res.json({ ok: true });
}

const resetSchema = z.object({
  email: z.string().email(),
  token: z.string().min(10),
  new_password: z.string().min(6)
});

async function resetPassword(req, res) {
  const parsed = resetSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const { email, token, new_password } = parsed.data;
  const userRes = await pool.query('SELECT id FROM users WHERE email=$1 AND is_active=true', [email]);
  const user = userRes.rows[0];
  if (!user) {
    return res.status(400).json({ error: 'INVALID_TOKEN' });
  }

  const resetRes = await pool.query(
    `SELECT id, token_hash, expires_at, used_at
     FROM password_reset_tokens
     WHERE user_id=$1
     ORDER BY created_at DESC
     LIMIT 10`,
    [user.id]
  );

  const now = new Date();
  const resetRow = resetRes.rows.find(r => !r.used_at && new Date(r.expires_at) > now);
  if (!resetRow) {
    return res.status(400).json({ error: 'INVALID_TOKEN' });
  }

  const ok = await bcrypt.compare(token, resetRow.token_hash);
  if (!ok) {
    return res.status(400).json({ error: 'INVALID_TOKEN' });
  }

  const password_hash = await bcrypt.hash(new_password, 10);
  await pool.query('UPDATE users SET password_hash=$1 WHERE id=$2', [password_hash, user.id]);
  await pool.query('UPDATE password_reset_tokens SET used_at=now() WHERE id=$1', [resetRow.id]);

  return res.json({ ok: true });
}

async function me(req, res) {
  const { rows } = await pool.query(
    'SELECT id, first_name, last_name, username, email, role FROM users WHERE id=$1',
    [req.user.id]
  );
  return res.json({ user: rows[0] });
}

module.exports = { ROLES, register, login, forgotPassword, resetPassword, me };


────────────────── client/src/pages/Trash.jsx ──────────────────
import React, { useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

const ENTITIES = [
  { key: 'vehicles', label: 'Véhicules' },
  { key: 'drivers', label: 'Chauffeurs' },
  { key: 'fuel_requests', label: 'Demandes carburant' },
  { key: 'car_requests', label: 'Demandes voiture' },
  { key: 'vehicle_fuel_logs', label: 'Suivi carburant (Véhicules)' },
  { key: 'generator_fuel_logs', label: 'Suivi carburant (Groupe électrogène)' },
  { key: 'other_fuel_logs', label: 'Suivi carburant (Autres)' }
];

export default function Trash() {
  const { token } = useAuth();
  const [entity, setEntity] = useState('vehicles');
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);

  const [confirm, setConfirm] = useState(null);
  const [confirmWord, setConfirmWord] = useState('');

  const columns = useMemo(() => {
    if (entity === 'vehicles') return ['plate', 'label', 'deleted_at'];
    if (entity === 'drivers') return ['full_name', 'phone', 'deleted_at'];
    if (entity === 'fuel_requests') return ['request_no', 'request_date', 'request_type', 'amount_estimated_ar', 'status', 'deleted_at'];
    if (entity === 'car_requests') return ['request_no', 'proposed_date', 'objet', 'status', 'deleted_at'];
    if (entity === 'vehicle_fuel_logs') return ['log_date', 'km_depart', 'km_arrivee', 'montant_ar', 'deleted_at'];
    if (entity === 'generator_fuel_logs') return ['log_date', 'liters', 'montant_ar', 'deleted_at'];
    if (entity === 'other_fuel_logs') return ['log_date', 'liters', 'montant_ar', 'lien', 'deleted_at'];
    return ['id', 'deleted_at'];
  }, [entity]);

  async function load() {
    setLoading(true);
    setErr(null);
    try {
      const d = await apiFetch(`/api/trash/${entity}`, { token });
      setItems(d.items || []);
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
  }, [entity]);

  const openRestore = (item) => {
    setConfirm({ type: 'restore', item });
    setConfirmWord('');
  };

  const openHard = (item) => {
    setConfirm({ type: 'hard', item });
    setConfirmWord('');
  };

  const runConfirm = async () => {
    if (!confirm) return;
    const { type, item } = confirm;

    try {
      if (type === 'restore') {
        await apiFetch(`/api/trash/${entity}/${item.id}/restore`, { method: 'POST', token });
        alert('✅ Restauré avec succès');
        setConfirm(null);
        await load();
        return;
      }

      if (type === 'hard') {
        if (confirmWord !== 'SUPPRIMER') {
          alert('⚠️ Tapez exactement "SUPPRIMER" pour confirmer');
          return;
        }
        await apiFetch(`/api/trash/${entity}/${item.id}/hard`, { method: 'DELETE', token });
        alert('✅ Supprimé définitivement');
        setConfirm(null);
        await load();
      }
    } catch (e) {
      alert(`❌ Erreur: ${e.message}`);
    }
  };

  return (
    <div>
      <h1 style={{ marginTop: 0 }}>🗑️ Corbeille</h1>

      <div className="row" style={{ alignItems: 'flex-end', marginBottom: 12 }}>
        <div className="field" style={{ minWidth: 300 }}>
          <div className="label">Type</div>
          <select className="input" value={entity} onChange={(e) => setEntity(e.target.value)}>
            {ENTITIES.map((e) => (
              <option key={e.key} value={e.key}>{e.label}</option>
            ))}
          </select>
        </div>
        <button className="btn btn-outline" onClick={load}>Recharger</button>
      </div>

      {err && <div className="muted" style={{ color: '#b91c1c', marginBottom: 12 }}>{err}</div>}

      <div style={{ overflow: 'auto' }}>
        <table className="table">
          <thead>
            <tr>
              <th>ID</th>
              {columns.map((c) => (<th key={c}>{c}</th>))}
              <th style={{ width: 260 }}>Actions</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr><td colSpan={columns.length + 2} className="muted">Chargement...</td></tr>
            ) : items.length ? (
              items.map((it) => (
                <tr key={it.id}>
                  <td className="muted" style={{ fontSize: 11 }}>{String(it.id).slice(0, 8)}...</td>
                  {columns.map((c) => (
                    <td key={c}>
                      {c === 'amount_estimated_ar' || c === 'montant_ar' ? Number(it[c] || 0).toLocaleString('fr-FR') + ' Ar' :
                       c === 'deleted_at' ? new Date(it[c]).toLocaleString('fr-FR') :
                       String(it[c] ?? '')}
                    </td>
                  ))}
                  <td style={{ whiteSpace: 'nowrap' }}>
                    <button className="btn btn-outline btn-sm" onClick={() => openRestore(it)}>Restaurer</button>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <button className="btn btn-danger btn-sm" onClick={() => openHard(it)}>Supprimer définitif</button>
                  </td>
                </tr>
              ))
            ) : (
              <tr><td colSpan={columns.length + 2} className="muted">Corbeille vide ✅</td></tr>
            )}
          </tbody>
        </table>
      </div>

      <div className="muted" style={{ marginTop: 16, padding: 12, background: '#f9fafb', borderRadius: 8 }}>
        <strong>💡 Comment ça marche ?</strong>
        <ul style={{ marginTop: 8, paddingLeft: 20 }}>
          <li><strong>Restaurer</strong> : Remet l'élément dans l'app (accessible normalement)</li>
          <li><strong>Supprimer définitif</strong> : Efface DÉFINITIVEMENT de la base de données (irréversible)</li>
        </ul>
      </div>

      {confirm && (
        <Modal
          title={confirm.type === 'restore' ? 'Restaurer cet élément ?' : 'Suppression définitive'}
          onClose={() => setConfirm(null)}
          width={560}
        >
          {confirm.type === 'restore' ? (
            <div>
              <div style={{ marginBottom: 12 }}>
                Voulez-vous restaurer cet élément ?<br />
                <span className="muted">Il redeviendra accessible normalement.</span>
              </div>
              <div className="row" style={{ justifyContent: 'flex-end', gap: 8 }}>
                <button className="btn btn-outline" onClick={() => setConfirm(null)}>Annuler</button>
                <button className="btn" onClick={runConfirm}>✅ Restaurer</button>
              </div>
            </div>
          ) : (
            <div>
              <div style={{ marginBottom: 10, padding: 12, background: '#fef2f2', borderRadius: 8, border: '1px solid #fca5a5' }}>
                <strong style={{ color: '#b91c1c' }}>⚠️ ATTENTION : Cette action est IRRÉVERSIBLE</strong><br />
                <span className="muted">L'élément sera supprimé définitivement de la base de données.</span>
              </div>
              <div style={{ marginBottom: 10 }}>
                Tapez exactement <strong style={{ color: '#b91c1c' }}>SUPPRIMER</strong> pour confirmer :
              </div>
              <input
                className="input"
                value={confirmWord}
                onChange={(e) => setConfirmWord(e.target.value)}
                placeholder="SUPPRIMER"
                style={{ fontWeight: 700, textTransform: 'uppercase' }}
              />
              <div className="row" style={{ justifyContent: 'flex-end', marginTop: 12, gap: 8 }}>
                <button className="btn btn-outline" onClick={() => setConfirm(null)}>Annuler</button>
                <button 
                  className="btn btn-danger" 
                  disabled={confirmWord !== 'SUPPRIMER'} 
                  onClick={runConfirm}
                >
                  🗑️ Supprimer définitif
                </button>
              </div>
            </div>
          )}
        </Modal>
      )}
    </div>
  );
}

────────────────── client/src/pages/Reset.jsx ──────────────────
import React, { useMemo, useState } from 'react';
import { Link, useSearchParams, useNavigate } from 'react-router-dom';
import { apiFetch } from '../utils/api.js';

export default function Reset() {
  const [params] = useSearchParams();
  const nav = useNavigate();
  const email = useMemo(() => params.get('email') || '', [params]);
  const token = useMemo(() => params.get('token') || '', [params]);

  const [newPassword, setNewPassword] = useState('');
  const [done, setDone] = useState(false);
  const [error, setError] = useState(null);

  async function onSubmit(e) {
    e.preventDefault();
    setError(null);
    try {
      await apiFetch('/api/auth/reset', {
        method: 'POST',
        body: { email, token, new_password: newPassword }
      });
      setDone(true);
      setTimeout(() => nav('/login'), 700);
    } catch (err) {
      setError(err.message);
    }
  }

  return (
    <div className="container">
      <div className="card" style={{ maxWidth: 520, margin: '40px auto' }}>
        <h2 style={{ marginTop: 0 }}>Réinitialiser mot de passe</h2>
        {done ? (
          <div className="notice">Mot de passe modifié ✅ Redirection...</div>
        ) : (
          <>
            <div className="muted" style={{ marginBottom: 12 }}>
              Email: <b>{email || '—'}</b>
            </div>
            {error && <div className="notice error">{error}</div>}
            <form onSubmit={onSubmit} className="form">
              <label className="label">Nouveau mot de passe</label>
              <input className="input" type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} />
              <button className="btn btn-primary" type="submit">Valider</button>
            </form>
          </>
        )}
        <div style={{ marginTop: 12 }}>
          <Link to="/login">Retour connexion</Link>
        </div>
      </div>
    </div>
  );
}


────────────────── client/src/pages/Register.jsx ──────────────────
import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';

const ROLES = [
  { value: 'DEMANDEUR', label: 'Demandeur' },
  { value: 'LOGISTIQUE', label: 'Logistique' },
  { value: 'RAF', label: 'RAF' }
];

export default function Register() {
  const nav = useNavigate();
  const { setSession } = useAuth();
  const [form, setForm] = useState({ first_name: '', last_name: '', username: '', email: '', role: 'DEMANDEUR', password: '', password2: '' });
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  async function onSubmit(e) {
    e.preventDefault();
    setError(null);
    if (form.password !== form.password2) {
      setError('Les mots de passe ne correspondent pas');
      return;
    }
    setLoading(true);
    try {
      const data = await apiFetch('/api/auth/register', {
        method: 'POST',
        body: {
          first_name: form.first_name,
          last_name: form.last_name,
          username: form.username,
          email: form.email,
          role: form.role,
          password: form.password
        }
      });
      setSession(data.token, data.user);
      nav('/app');
    } catch (e2) {
      setError(e2.message);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="container" style={{ maxWidth: 520 }}>
      <div className="card">
        <h2>Inscription</h2>
        <p className="muted">Compte PRIRTEM (offline).</p>
        {error && <div className="alert alert-danger">{error}</div>}

        <form onSubmit={onSubmit} className="form">
          <div className="grid2">
            <label className="field">
              <span>Nom</span>
              <input value={form.last_name} onChange={(e) => setForm({ ...form, last_name: e.target.value })} required />
            </label>
            <label className="field">
              <span>Prénom</span>
              <input value={form.first_name} onChange={(e) => setForm({ ...form, first_name: e.target.value })} required />
            </label>
          </div>

          <label className="field">
            <span>Nom d'utilisateur</span>
            <input value={form.username} onChange={(e) => setForm({ ...form, username: e.target.value })} required />
          </label>

          <label className="field">
            <span>Email</span>
            <input type="email" value={form.email} onChange={(e) => setForm({ ...form, email: e.target.value })} required />
          </label>

          <label className="field">
            <span>Rôle</span>
            <select value={form.role} onChange={(e) => setForm({ ...form, role: e.target.value })}>
              {ROLES.map((r) => <option key={r.value} value={r.value}>{r.label}</option>)}
            </select>
          </label>

          <div className="grid2">
            <label className="field">
              <span>Mot de passe</span>
              <input type="password" value={form.password} onChange={(e) => setForm({ ...form, password: e.target.value })} required />
            </label>
            <label className="field">
              <span>Confirmer</span>
              <input type="password" value={form.password2} onChange={(e) => setForm({ ...form, password2: e.target.value })} required />
            </label>
          </div>

          <button className="btn btn-primary" disabled={loading}>{loading ? 'Création...' : 'Créer le compte'}</button>
        </form>

        <div style={{ marginTop: 12 }}>
          <Link to="/login">Déjà inscrit ? Se connecter</Link>
        </div>
      </div>
    </div>
  );
}


────────────────── client/src/pages/PrintLogbook.jsx ──────────────────
import React, { useEffect, useState } from 'react';
import { Link, useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

function fmtDate(d) {
  if (!d) return '';
  const date = new Date(d);
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  return `${day}/${month}`;
}

export default function PrintLogbook() {
  const { id } = useParams();
  const { token } = useAuth();
  const [data, setData] = useState(null);

  useEffect(() => {
    apiFetch(`/api/logbooks/${id}`, { token }).then(setData);
  }, [id, token]);

  if (!data) return <div>Chargement...</div>;
  const { logbook, trips, supplies } = data;

  return (
    <div style={{ background: '#eee', minHeight: '100vh', padding: 20 }}>
      <div className="noPrint" style={{ marginBottom: 20, textAlign: 'center' }}>
        <Link className="btn btn-outline" to="/app/logbooks">← Retour</Link>
        <button className="btn" onClick={() => window.print()} style={{ marginLeft: 10 }}>Imprimer</button>
      </div>

      <div style={{
        background: 'white',
        width: '297mm', // A4 Paysage
        height: '210mm',
        padding: '10mm',
        margin: '0 auto',
        fontFamily: 'Arial, sans-serif',
        fontSize: '11px',
        color: 'black',
        boxShadow: '0 4px 10px rgba(0,0,0,0.1)'
      }} className="paper">
        
        {/* HEADER */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 15 }}>
          <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-start' }}>
            <div style={{ fontSize: '24px', fontWeight: '900', border: '3px solid black', padding: '0 8px', letterSpacing: '-1px' }}>
              Z
            </div>
            <div style={{ fontWeight: 'bold', fontSize: '10px', marginTop: 2 }}>CEP</div>
            <div style={{ fontWeight: 'bold', fontSize: '10px' }}>PRIRTEM</div>
          </div>
          
          <div style={{ textAlign: 'center', flex: 1 }}>
            <h1 style={{ fontSize: '18px', fontWeight: 'bold', textTransform: 'uppercase', margin: 0 }}>Journal de bord voiture</h1>
            <div style={{ fontSize: '12px', marginTop: 5 }}>
              Du {new Date(logbook.period_start).toLocaleDateString('fr-FR')} au {new Date(logbook.period_end).toLocaleDateString('fr-FR')}
            </div>
          </div>
        </div>

        <div style={{ marginBottom: 10 }}>
          <span style={{ fontWeight: 'bold' }}>Objet :</span> {logbook.objet || '...........................................'} <br/>
          <span style={{ fontWeight: 'bold' }}>Immatriculation :</span> <span style={{ textDecoration: 'underline' }}>{logbook.plate}</span>
        </div>

        {/* MAIN TABLE */}
        <table style={{ width: '100%', borderCollapse: 'collapse', border: '2px solid black', textAlign: 'center', fontSize: '10px' }}>
          <thead>
            <tr>
              <th rowSpan="2" style={thStyle}>DATE</th>
              <th colSpan="2" style={thStyle}>DEPART</th>
              <th colSpan="4" style={thStyle}>ITINERAIRES</th>
              <th colSpan="2" style={thStyle}>ARRIVEE</th>
              <th rowSpan="2" style={thStyle}>PERSONNES<br/>TRANSPORTEES</th>
              <th rowSpan="2" style={thStyle}>EMARGEMENT</th>
            </tr>
            <tr>
              <th style={thStyle}>Heures</th>
              <th style={thStyle}>Km</th>
              <th style={thStyle}>Début de trajet</th>
              <th style={thStyle}>Fin de trajet</th>
              <th style={thStyle}>Lieu de<br/>stationnement</th>
              <th style={thStyle}>Durée de<br/>stationnement</th>
              <th style={thStyle}>Heures</th>
              <th style={thStyle}>Km</th>
            </tr>
          </thead>
          <tbody>
            {trips.map((t, i) => (
              <tr key={i} style={{ height: '24px' }}>
                <td style={tdStyle}>{fmtDate(t.trip_date)}</td>
                <td style={tdStyle}>{t.depart_time ? t.depart_time.slice(0, 5).replace(':','H') : ''}</td>
                <td style={tdStyle}>{t.depart_km}</td>
                <td style={tdStyle}>{t.route_start}</td>
                <td style={tdStyle}>{t.route_end}</td>
                <td style={tdStyle}>{t.parking_place}</td>
                <td style={tdStyle}>{t.parking_duration_min ? t.parking_duration_min + ' min' : ''}</td>
                <td style={tdStyle}>{t.arrival_time ? t.arrival_time.slice(0, 5).replace(':','H') : ''}</td>
                <td style={tdStyle}>{t.arrival_km}</td>
                <td style={tdStyle}>{t.passengers}</td>
                <td style={tdStyle}>{t.emargement}</td>
              </tr>
            ))}
            {/* Lignes vides pour remplir la page si besoin */}
            {Array.from({ length: Math.max(0, 15 - trips.length) }).map((_, i) => (
              <tr key={`empty-${i}`} style={{ height: '24px' }}>
                <td style={tdStyle}></td><td style={tdStyle}></td><td style={tdStyle}></td>
                <td style={tdStyle}></td><td style={tdStyle}></td><td style={tdStyle}></td>
                <td style={tdStyle}></td><td style={tdStyle}></td><td style={tdStyle}></td>
                <td style={tdStyle}></td><td style={tdStyle}></td>
              </tr>
            ))}
          </tbody>
        </table>

        {/* FOOTER: APPRO & SIGNATURE */}
        <div style={{ display: 'flex', marginTop: 15, gap: 20 }}>
          <div style={{ flex: 1 }}>
            <div style={{ fontWeight: 'bold', marginBottom: 5 }}>Approvisionnement Carburant</div>
            <table style={{ width: '100%', borderCollapse: 'collapse', border: '1px solid black', fontSize: '10px' }}>
              <thead>
                <tr>
                  <th style={tdStyle}>Date</th>
                  <th style={tdStyle}>Compteur Km</th>
                  <th style={tdStyle}>Litre</th>
                </tr>
              </thead>
              <tbody>
                {supplies.length > 0 ? supplies.map((s, i) => (
                  <tr key={i}>
                    <td style={tdStyle}>{fmtDate(s.supply_date)}</td>
                    <td style={tdStyle}>{s.compteur_km}</td>
                    <td style={tdStyle}>{s.liters}</td>
                  </tr>
                )) : (
                  <tr><td colSpan={3} style={{ ...tdStyle, height: '40px' }}></td></tr>
                )}
              </tbody>
            </table>
          </div>

          <div style={{ width: '250px', display: 'flex', flexDirection: 'column', gap: 10 }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', borderBottom: '1px dotted black', paddingBottom: 5 }}>
              <span>Services :</span>
              <span>{logbook.service_km || '.....'} km</span>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', borderBottom: '1px dotted black', paddingBottom: 5 }}>
              <span>Mission :</span>
              <span>{logbook.mission_km || '.....'} km</span>
            </div>
            <div style={{ marginTop: 10 }}>
              Chauffeur : <br/>
              <span style={{ fontFamily: 'monospace' }}>{logbook.chauffeur_signature}</span>
            </div>
          </div>
        </div>

      </div>
      <style>{`@media print { .noPrint { display: none; } @page { size: A4 landscape; margin: 0; } body { background: white; } .paper { box-shadow: none; } }`}</style>
    </div>
  );
}

const thStyle = { border: '1px solid black', padding: '4px', background: '#fff', fontWeight: 'bold' };
const tdStyle = { border: '1px solid black', padding: '4px' };

────────────────── client/src/pages/PrintFuelRequest.jsx ──────────────────
import React, { useEffect, useState } from 'react';
import { Link, useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

export default function PrintFuelRequest() {
  const { id } = useParams();
  const { token } = useAuth();
  const [req, setReq] = useState(null);

  useEffect(() => {
    (async () => {
      const data = await apiFetch(`/api/requests/fuel/${id}`, { token });
      setReq(data.request);
    })();
  }, [id, token]);

  if (!req) return <div>Chargement...</div>;

  return (
    <div style={{ minHeight: '100vh', background: '#f3f4f6', padding: 20 }}>
      <div className="noPrint" style={{ textAlign: 'center', marginBottom: 20 }}>
        <Link to="/app/requests/fuel" className="btn btn-secondary">← Retour</Link>
        <button className="btn" onClick={() => window.print()} style={{ marginLeft: 10 }}>Imprimer</button>
      </div>

      <div className="paper" style={{
        width: '210mm', minHeight: '130mm', // Demi page A4 environ ou ajusté
        background: 'white', margin: '0 auto', padding: '20mm',
        position: 'relative', fontFamily: 'Arial, sans-serif', color: '#000'
      }}>
        
        {/* Header gauche / droite */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 20 }}>
          <div style={{ textAlign: 'center' }}>
            <div style={{ fontWeight: 'normal', fontSize: '14px' }}>CEP</div>
            <div style={{ fontWeight: 'normal', fontSize: '14px' }}>PRIRTEM</div>
          </div>
          <div style={{ fontSize: '14px' }}>N° <span style={{ textDecoration: 'underline' }}>{req.request_no.split(' ')[1]}</span></div>
        </div>

        {/* Titre */}
        <div style={{ textAlign: 'center', fontSize: '18px', marginBottom: 30 }}>
          DEMANDE DE CARBURANT
        </div>

        {/* Checkbox Service / Mission */}
        <div style={{ display: 'flex', justifyContent: 'center', gap: 100, marginBottom: 30 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
            <span>SERVICE</span>
            <div style={boxStyle}>{req.request_type === 'SERVICE' ? 'X' : ''}</div>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
            <span>MISSION</span>
            <div style={boxStyle}>{req.request_type === 'MISSION' ? 'X' : ''}</div>
          </div>
        </div>

        {/* Champs lignes */}
        <div style={lineGroupStyle}>
          <span>OBJET : </span>
          <div style={lineStyle}>{req.objet}</div>
        </div>

        <div style={{ ...lineGroupStyle, marginTop: 25 }}>
          <span>Montant prévisionnel (en chiffre) : </span>
          <div style={{ ...lineStyle, width: '200px' }}>{Number(req.amount_estimated_ar).toLocaleString('fr-FR')}</div>
          <span>Ar</span>
        </div>

        <div style={{ ...lineGroupStyle, marginTop: 25 }}>
          <span style={{ width: '150px' }}>(en lettre) :</span>
          <div style={lineStyle}>{req.amount_estimated_words}</div>
        </div>

        <div style={{ textAlign: 'right', marginTop: 40, marginBottom: 10 }}>
          Date ____/____/________
        </div>

        {/* Tableau Signatures */}
        <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: 20 }}>
          <thead>
            <tr>
              <th style={cellStyle}>Le Demandeur</th>
              <th style={cellStyle}>Vérifié par : A/Logistique</th>
              <th style={cellStyle}>Visé par : Le RAF</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style={{ ...cellStyle, height: '100px', verticalAlign: 'bottom', textAlign:'center' }}>
                {req.requester_username || ''}
              </td>
              <td style={{ ...cellStyle, height: '100px' }}></td>
              <td style={{ ...cellStyle, height: '100px' }}></td>
            </tr>
          </tbody>
        </table>

      </div>
      <style>{`@media print { .noPrint { display: none; } body { margin: 0; } .paper { box-shadow: none; border: none; } }`}</style>
    </div>
  );
}

const boxStyle = { width: '20px', height: '20px', border: '1px solid black', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', fontWeight: 'bold' };
const lineGroupStyle = { display: 'flex', alignItems: 'baseline', fontSize: '14px' };
const lineStyle = { flex: 1, borderBottom: '1px solid black', paddingLeft: '10px', height: '24px' };
const cellStyle = { border: '1px solid black', padding: '5px', textAlign: 'center', width: '33%' };

────────────────── client/src/pages/PrintCarRequest.jsx ──────────────────
import React, { useEffect, useState } from 'react';
import { Link, useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

export default function PrintCarRequest() {
  const { id } = useParams();
  const { token } = useAuth();
  const [req, setReq] = useState(null);

  useEffect(() => {
    (async () => {
      const data = await apiFetch(`/api/requests/car/${id}`, { token });
      setReq(data.request);
    })();
  }, [id, token]);

  if (!req) return <div>Chargement...</div>;

  return (
    <div style={{ background: '#f3f4f6', minHeight: '100vh', padding: 20 }}>
      <div className="noPrint" style={{ textAlign: 'center', marginBottom: 20 }}>
        <Link to="/app/requests/car" className="btn btn-secondary">← Retour</Link>
        <button className="btn" onClick={() => window.print()} style={{ marginLeft: 10 }}>Imprimer</button>
      </div>

      <div className="paper" style={{
        width: '270mm', height: '190mm',
        background: 'white', margin: '0 auto', padding: '15mm',
        display: 'flex', gap: '10mm', fontFamily: 'Arial, sans-serif'
      }}>
        
        {/* ----- PARTIE GAUCHE: DEMANDE ----- */}
        <div style={{ flex: 1, borderRight: '1px dashed black', paddingRight: '10mm', display: 'flex', flexDirection: 'column' }}>
          
          <div style={{ display: 'flex', gap: 15, marginBottom: 20 }}>
            {/* Logo Z sim */}
            <div style={{ border: '4px solid #555', padding: '5px 10px', fontWeight: '900', fontSize: '24px', color: '#555', lineHeight: '24px' }}>Z</div>
            <div>
              <div style={{fontWeight:'bold'}}>CEP</div>
              <div style={{fontWeight:'bold'}}>PRIRTEM</div>
            </div>
          </div>

          <div style={{ fontWeight: 'bold', textTransform: 'uppercase', marginBottom: 30, fontSize: '16px' }}>
            Demande de voiture
          </div>

          <Field label="Date proposée" value={fmtDate(req.proposed_date)} />
          <Field label="Objet" value={req.objet} />
          <div style={{ margin: '15px 0', borderBottom: '1px dotted #999' }}></div>
          <Field label="Itinéraire" value={req.itinerary} multiline />
          <div style={{ margin: '15px 0', borderBottom: '1px dotted #999' }}></div>
          <Field label="Personnes transportées" value={req.people} />
          <div style={{ margin: '15px 0', borderBottom: '1px dotted #999' }}></div>
          
          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
            <div style={{ flex: 1 }}>
              <Field label="Heure de départ souhaitée" value={fmtTime(req.depart_time_wanted)} />
              <Field label="Heure probable de retour" value={fmtTime(req.return_time_expected)} />
              <Field label="Immatriculation" value={req.vehicle_plate || '...................'} />
              <Field label="Chauffeur" value={req.driver_name || '...................'} />
            </div>
          </div>

          <div style={{ marginTop: 'auto' }}>
            <div>Date : ___________________</div>
            <div style={{ marginTop: 10 }}>Le Demandeur,</div>
            <div style={{ height: 50 }}></div>
          </div>
        </div>

        {/* ----- PARTIE DROITE: AUTORISATION ----- */}
        <div style={{ flex: 1, paddingLeft: '5mm', display: 'flex', flexDirection: 'column' }}>
          
          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 20 }}>
            <div style={{ display: 'flex', gap: 15 }}>
              <div style={{ border: '4px solid #555', padding: '5px 10px', fontWeight: '900', fontSize: '24px', color: '#555', lineHeight: '24px' }}>Z</div>
              <div>
                <div style={{fontWeight:'bold'}}>CEP</div>
                <div style={{fontWeight:'bold'}}>PRIRTEM</div>
              </div>
            </div>
            <div style={{ fontSize: '14px', fontWeight: 'bold' }}>
              N° <span style={{ textDecoration:'underline' }}>{req.request_no.split(' ')[1]}</span>
            </div>
          </div>

          <div style={{ fontWeight: 'bold', textTransform: 'uppercase', marginBottom: 30, fontSize: '16px' }}>
            Autorisation sortie de voiture
          </div>

          <Field label="Date" value={fmtDate(req.authorization_date)} />
          <Field label="Heure" value={fmtTime(req.authorization_time)} />
          <Field label="Immatriculation" value={req.vehicle_plate || '.......................'} />
          <Field label="Chauffeur" value={req.driver_name || '.......................'} />
          <Field label="Itinéraire" value={req.itinerary} />

          <div style={{ marginTop: 'auto', borderTop: '2px solid black', paddingTop: 10 }}>
            <div style={{ display: 'flex', border: '1px solid black' }}>
              <div style={{ flex: 1, borderRight: '1px solid black', padding: 5, minHeight: 80 }}>
                <div style={{ textAlign: 'center', fontWeight: 'bold', fontSize: '12px' }}>Visa<br/>A/Logistique</div>
                {/* Espace Signature */}
              </div>
              <div style={{ flex: 1, padding: 5, minHeight: 80 }}>
                <div style={{ textAlign: 'center', fontWeight: 'bold', fontSize: '12px' }}>Approuvée<br/>par Le RAF</div>
                {/* Espace Signature */}
              </div>
            </div>
          </div>

        </div>

      </div>
      <style>{`@media print { .noPrint { display: none; } @page { size: A4 landscape; margin: 5mm; } body { margin: 0; background: white; } .paper { margin: 0; box-shadow: none; width: 100%; height: 100%; } }`}</style>
    </div>
  );
}

function Field({ label, value, multiline }) {
  return (
    <div style={{ display: 'flex', alignItems: multiline ? 'flex-start' : 'baseline', marginBottom: 8, fontSize: '13px' }}>
      <span style={{ fontWeight: 'bold', marginRight: 10, minWidth: 60 }}>{label} :</span>
      <div style={{ flex: 1, borderBottom: '1px dotted #333', paddingLeft: 5, minHeight: 18 }}>
        {value}
      </div>
    </div>
  );
}

function fmtDate(d) { return d ? new Date(d).toLocaleDateString('fr-FR') : ''; }
function fmtTime(t) { return t ? t.slice(0, 5) : ''; }

────────────────── client/src/pages/Login.jsx ──────────────────
import React, { useMemo, useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import FloatingLines from '../components/FloatingLines.jsx';

const ROLES = [
  { value: 'DEMANDEUR', label: 'Demandeur' },
  { value: 'LOGISTIQUE', label: 'Logistique' },
  { value: 'RAF', label: 'RAF' },
  { value: 'ADMIN', label: 'Admin' }
];

export default function Login() {
  const navigate = useNavigate();
  const { setSession } = useAuth();

  const [username, setUsername] = useState('');
  const [role, setRole] = useState('DEMANDEUR');
  const [password, setPassword] = useState('');
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  // ✅ PROPS STABLES (ne changent pas quand tu tapes)
  const enabledWaves = useMemo(() => ['top', 'middle', 'bottom'], []);
  const bottomWavePosition = useMemo(() => ({ x: 2.0, y: -0.7, rotate: -1 }), []);
  const topWavePosition = useMemo(() => ({ x: 10.0, y: 0.5, rotate: -0.4 }), []);
  const middleWavePosition = useMemo(() => ({ x: 5.0, y: 0.0, rotate: 0.2 }), []);

  // si tu veux un gradient lignes custom : useMemo(() => ['#E947F5','#2F4BA2'], [])
  const linesGradient = useMemo(() => undefined, []);

  async function onSubmit(e) {
    e.preventDefault();
    setError(null);
    setLoading(true);

    try {
      const data = await apiFetch('/api/auth/login', {
        method: 'POST',
        body: { username, role, password }
      });
      setSession(data.token, data.user);
      navigate('/app');
    } catch (err) {
      setError(err.message || 'Erreur de connexion');
    } finally {
      setLoading(false);
    }
  }

  return (
    <div
      style={{
        minHeight: '100vh',
        position: 'relative',
        overflow: 'hidden',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        background: 'linear-gradient(135deg, #4f46e5 0%, #0f172a 100%)',
        padding: '20px'
      }}
    >
      {/* Background */}
      <div
        aria-hidden="true"
        style={{
          position: 'absolute',
          inset: 0,
          zIndex: 0,
          pointerEvents: 'none'
        }}
      >
        <FloatingLines
          enabledWaves={enabledWaves}
          lineCount={5}
          lineDistance={5}
          topWavePosition={topWavePosition}
          middleWavePosition={middleWavePosition}
          bottomWavePosition={bottomWavePosition}
          animationSpeed={1}
          interactive={true}
          parallax={true}
          parallaxStrength={0.2}
          bendRadius={5}
          bendStrength={-0.5}
          mouseDamping={0.05}
          linesGradient={linesGradient}
          mixBlendMode="screen"
        />
      </div>

      {/* Card */}
      <div
        className="card"
        style={{
          position: 'relative',
          zIndex: 1,
          width: '100%',
          maxWidth: '420px',
          padding: '40px',
          borderRadius: '24px',
          boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
          backdropFilter: 'blur(6px)'
        }}
      >
        <div style={{ textAlign: 'center', marginBottom: '32px' }}>
          <div
            style={{
              width: 60,
              height: 60,
              background: '#4f46e5',
              borderRadius: 16,
              margin: '0 auto 16px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: 32,
              color: 'white',
              fontWeight: 800
            }}
          >
            P
          </div>
          <h2 style={{ fontSize: '24px', marginBottom: '8px' }}>Bienvenue</h2>
          <p className="muted">Connectez-vous à PRIRTEM Flotte</p>
        </div>

        {error && (
          <div
            style={{
              background: '#fee2e2',
              color: '#991b1b',
              padding: '12px',
              borderRadius: '8px',
              marginBottom: '20px',
              fontSize: '14px',
              textAlign: 'center'
            }}
          >
            {error}
          </div>
        )}

        <form onSubmit={onSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
          <div>
            <label className="label">Nom d'utilisateur</label>
            <input
              className="input"
              style={{ padding: '12px' }}
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              placeholder="Votre identifiant"
              autoComplete="username"
            />
          </div>

          <div>
            <label className="label">Rôle</label>
            <select className="input" style={{ padding: '12px' }} value={role} onChange={(e) => setRole(e.target.value)}>
              {ROLES.map((r) => (
                <option key={r.value} value={r.value}>
                  {r.label}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="label">Mot de passe</label>
            <input
              className="input"
              style={{ padding: '12px' }}
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="••••••••"
              autoComplete="current-password"
            />
          </div>

          <button className="btn" style={{ marginTop: '8px', padding: '14px', fontSize: '1rem' }} disabled={loading}>
            {loading ? 'Connexion...' : 'Se connecter'}
          </button>
        </form>

        <div style={{ marginTop: '24px', textAlign: 'center', fontSize: '14px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
          <Link to="/forgot" style={{ color: '#4f46e5' }}>Mot de passe oublié ?</Link>
          {/* Lien d'inscription supprimé pour sécurité */}
        </div>
      </div>
    </div>
  );
}


────────────────── client/src/pages/Logbooks.jsx ──────────────────
// client/src/pages/Logbooks.jsx
import React, { useEffect, useMemo, useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import Modal from '../components/Modal.jsx';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

function fmtDate(d) {
  if (!d) return '';
  const s = String(d);
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (m) return `${m[3]}/${m[2]}/${m[1]}`;
  return s;
}

function toYmd(s) {
  if (!s) return null;
  const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})/);
  return m ? `${m[1]}-${m[2]}-${m[3]}` : null;
}

export default function Logbooks() {
  const { token, user } = useAuth();
  const role = user?.role;
  const navigate = useNavigate();

  const [vehicles, setVehicles] = useState([]);
  const [logbooks, setLogbooks] = useState([]);

  const [form, setForm] = useState({
    vehicle_id: '',
    period_start: '',
    period_end: '',
    objet: ''
  });

  const [filter, setFilter] = useState({
    vehicle_id: '',
    status: '',
    date_from: '',
    date_to: '',
    q: ''
  });

  const [error, setError] = useState(null);
  const [creating, setCreating] = useState(false);
  const [view, setView] = useState(null); // {loading, book, trips, supplies}

  async function load() {
    setError(null);
    const v = await apiFetch('/api/meta/vehicles', { token });
    setVehicles(v.vehicles || []);
    const lb = await apiFetch('/api/logbooks', { token });
    setLogbooks(lb.logbooks || []);
  }

  useEffect(() => {
    if (!token) return;
    load().catch((e) => setError(e.message || String(e)));
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [token]);

  async function openView(id) {
    setView({ loading: true, book: null, trips: [], supplies: [] });
    try {
      const d = await apiFetch(`/api/logbooks/${id}`, { token });
      setView({
        loading: false,
        book: d.logbook,
        trips: d.trips || [],
        supplies: d.supplies || []
      });
    } catch (e) {
      setView(null);
      alert(e.message || String(e));
    }
  }

  async function create(e) {
    e.preventDefault();
    if (!['LOGISTIQUE', 'ADMIN'].includes(role)) return;

    if (!form.vehicle_id || !form.period_start || !form.period_end) {
      setError('Veuillez remplir Véhicule, Du, Au.');
      return;
    }
    if (form.period_end < form.period_start) {
      setError('La date de fin doit être ≥ à la date de début.');
      return;
    }

    setCreating(true);
    setError(null);

    try {
      const created = await apiFetch('/api/logbooks', {
        token,
        method: 'POST',
        body: { ...form, objet: form.objet || null }
      });

      // ✅ “Créer et ouvrir” : on ouvre directement le journal créé
      const newId = created?.logbook?.id;
      setForm({ vehicle_id: '', period_start: '', period_end: '', objet: '' });
      await load();

      if (newId) navigate(`/app/logbooks/${newId}`);
    } catch (e2) {
      setError(e2.message || String(e2));
    } finally {
      setCreating(false);
    }
  }

  const vehicleMap = useMemo(() => {
    const m = new Map();
    vehicles.forEach((v) => m.set(String(v.id), v));
    return m;
  }, [vehicles]);

  const filtered = useMemo(() => {
    const q = filter.q.trim().toLowerCase();
    const fVeh = filter.vehicle_id ? String(filter.vehicle_id) : '';
    const fStatus = filter.status || '';
    const fFrom = filter.date_from ? toYmd(filter.date_from) : null;
    const fTo = filter.date_to ? toYmd(filter.date_to) : null;

    return (logbooks || []).filter((lb) => {
      if (fVeh) {
        if (lb.vehicle_id != null) {
          if (String(lb.vehicle_id) !== fVeh) return false;
        } else {
          const v = vehicleMap.get(fVeh);
          if (v?.plate && String(lb.plate) !== String(v.plate)) return false;
        }
      }

      if (fStatus && String(lb.status) !== fStatus) return false;

      const ps = toYmd(lb.period_start) || '';
      const pe = toYmd(lb.period_end) || '';

      if (fFrom && pe && pe < fFrom) return false;
      if (fTo && ps && ps > fTo) return false;

      if (q) {
        const hay = `${lb.plate || ''} ${lb.objet || ''} ${lb.status || ''}`.toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });
  }, [logbooks, filter, vehicleMap]);

  function badgeClass(status) {
    if (status === 'LOCKED') return 'badge-ok';
    if (status === 'SUBMITTED') return 'badge-info';
    if (status === 'REJECTED') return 'badge-bad';
    return 'badge-warn'; // DRAFT
  }

  function resetFilters() {
    setFilter({ vehicle_id: '', status: '', date_from: '', date_to: '', q: '' });
  }

  return (
    <div className="grid2">
      {/* LISTE */}
      <div className="card">
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', gap: 12 }}>
          <h2 style={{ margin: 0 }}>Journaux de bord voiture</h2>
          <div className="muted" style={{ fontSize: 13 }}>
            {filtered.length} / {logbooks.length}
          </div>
        </div>

        {error && <div className="alert">{error}</div>}

        {/* FILTRES */}
        <div className="card" style={{ marginTop: 12, padding: 12, background: '#fafafa' }}>
          <div className="row2">
            <label>
              Véhicule
              <select
                value={filter.vehicle_id}
                onChange={(e) => setFilter({ ...filter, vehicle_id: e.target.value })}
              >
                <option value="">Tous</option>
                {vehicles.map((v) => (
                  <option key={v.id} value={v.id}>
                    {v.plate}
                  </option>
                ))}
              </select>
            </label>

            <label>
              Statut
              <select value={filter.status} onChange={(e) => setFilter({ ...filter, status: e.target.value })}>
                <option value="">Tous</option>
                <option value="DRAFT">DRAFT</option>
                <option value="SUBMITTED">SUBMITTED</option>
                <option value="LOCKED">LOCKED</option>
                <option value="REJECTED">REJECTED</option>
              </select>
            </label>
          </div>

          <div className="row2" style={{ marginTop: 10 }}>
            <label>
              Du
              <input
                type="date"
                value={filter.date_from}
                onChange={(e) => setFilter({ ...filter, date_from: e.target.value })}
              />
            </label>
            <label>
              Au
              <input
                type="date"
                value={filter.date_to}
                onChange={(e) => setFilter({ ...filter, date_to: e.target.value })}
              />
            </label>
          </div>

          <div style={{ display: 'flex', gap: 10, marginTop: 10, alignItems: 'flex-end' }}>
            <label style={{ flex: 1 }}>
              Recherche
              <input
                value={filter.q}
                onChange={(e) => setFilter({ ...filter, q: e.target.value })}
                placeholder="Immatriculation, objet, statut..."
              />
            </label>
            <button className="btn btn-outline" type="button" onClick={resetFilters}>
              Reset
            </button>
          </div>
        </div>

        {/* TABLE */}
        <div style={{ overflowX: 'auto', marginTop: 12 }}>
          <table className="table">
            <thead>
              <tr>
                <th>Véhicule</th>
                <th>Période</th>
                <th>Objet</th>
                <th>Km</th>
                <th>Statut</th>
                <th style={{ width: 320 }}></th>
              </tr>
            </thead>
            <tbody>
              {filtered.map((lb) => (
                <tr key={lb.id}>
                  <td>
                    <b>{lb.plate}</b>
                  </td>
                  <td>
                    {fmtDate(lb.period_start)} → {fmtDate(lb.period_end)}
                  </td>
                  <td>{lb.objet ? String(lb.objet).slice(0, 60) : <span className="muted">—</span>}</td>
                  <td style={{ whiteSpace: 'nowrap' }}>
                    <span className="badge badge-info" style={{ marginRight: 6 }}>
                      S: {lb.service_km ?? 0}
                    </span>
                    <span className="badge badge-warn">M: {lb.mission_km ?? 0}</span>
                  </td>
                  <td>
                    <span className={`badge ${badgeClass(lb.status)}`}>{lb.status}</span>
                  </td>
                  <td style={{ whiteSpace: 'nowrap' }}>
                    <button className="btn btn-outline btn-sm" onClick={() => openView(lb.id)}>
                      Voir
                    </button>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <Link className="btn btn-secondary btn-sm" to={`/app/logbooks/${lb.id}`}>
                      Ouvrir
                    </Link>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <a className="btn btn-sm" href={`/print/logbook/${lb.id}`} target="_blank" rel="noreferrer">
                      Imprimer
                    </a>
                  </td>
                </tr>
              ))}

              {!filtered.length && (
                <tr>
                  <td colSpan={6} className="muted">
                    Aucun journal.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* CREATE */}
      <div className="card">
        <h3>Créer un journal</h3>
        {!['LOGISTIQUE', 'ADMIN'].includes(role) ? (
          <div className="muted">Accès Logistique/Admin.</div>
        ) : (
          <form onSubmit={create} className="form">
            <label>
              Véhicule
              <select
                value={form.vehicle_id}
                onChange={(e) => setForm({ ...form, vehicle_id: e.target.value })}
                required
              >
                <option value="">-- sélectionner --</option>
                {vehicles.map((v) => (
                  <option key={v.id} value={v.id}>
                    {v.plate}
                  </option>
                ))}
              </select>
            </label>

            <div className="row2">
              <label>
                Du
                <input
                  type="date"
                  value={form.period_start}
                  onChange={(e) => setForm({ ...form, period_start: e.target.value })}
                  required
                />
              </label>
              <label>
                Au
                <input
                  type="date"
                  value={form.period_end}
                  onChange={(e) => setForm({ ...form, period_end: e.target.value })}
                  required
                />
              </label>
            </div>

            <label>
              Objet
              <input
                value={form.objet}
                onChange={(e) => setForm({ ...form, objet: e.target.value })}
                placeholder="(optionnel)"
              />
            </label>

            <button className="btn" disabled={creating}>
              {creating ? '...' : 'Créer et ouvrir'}
            </button>
          </form>
        )}
      </div>

      {/* MODAL DETAILS */}
      {view && (
        <Modal title="Détails journal de bord" onClose={() => setView(null)} width={900}>
          {view.loading ? (
            <div className="muted">Chargement...</div>
          ) : view.book ? (
            <div className="grid2">
              <div className="card">
                <div className="label">Véhicule</div>
                <div>
                  <b>{view.book.plate}</b> <span className="muted">{view.book.label || ''}</span>
                </div>

                <div className="label" style={{ marginTop: 10 }}>
                  Période
                </div>
                <div>
                  <b>{fmtDate(view.book.period_start)}</b> → <b>{fmtDate(view.book.period_end)}</b>
                </div>

                <div className="label" style={{ marginTop: 10 }}>
                  Objet
                </div>
                <div>{view.book.objet || <span className="muted">—</span>}</div>

                <div className="label" style={{ marginTop: 10 }}>
                  Km
                </div>
                <div>
                  <span className="badge badge-info" style={{ marginRight: 6 }}>
                    Services: {view.book.service_km ?? 0}
                  </span>
                  <span className="badge badge-warn">Mission: {view.book.mission_km ?? 0}</span>
                </div>

                <div className="label" style={{ marginTop: 10 }}>
                  Statut
                </div>
                <div>
                  <span className={`badge ${badgeClass(view.book.status)}`}>{view.book.status}</span>
                </div>
              </div>

              <div className="card">
                <div className="label">Résumé</div>
                <div className="muted">
                  Trajets: {view.trips.length} • Appro carburant: {view.supplies.length}
                </div>

                <hr />

                <div className="label">Derniers trajets</div>
                <ul className="muted" style={{ marginTop: 8 }}>
                  {view.trips.slice(0, 6).map((t) => (
                    <li key={t.id}>
                      {fmtDate(t.trip_date)} — {t.route_start || '...'} → {t.route_end || '...'}
                    </li>
                  ))}
                  {!view.trips.length && <li>—</li>}
                </ul>

                <div style={{ marginTop: 12, display: 'flex', gap: 10 }}>
                  <Link className="btn btn-secondary" to={`/app/logbooks/${view.book.id}`}>
                    Ouvrir
                  </Link>
                  <a className="btn" href={`/print/logbook/${view.book.id}`} target="_blank" rel="noreferrer">
                    Imprimer
                  </a>
                </div>
              </div>
            </div>
          ) : (
            <div className="muted">Aucune donnée</div>
          )}
        </Modal>
      )}
    </div>
  );
}


────────────────── client/src/pages/LogbookEdit.jsx ──────────────────
import React, { useEffect, useMemo, useState } from 'react';
import { Link, useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

const draftKey = (id) => `prirtem:logbook:${id}:draft:v1`;

function safeJsonParse(s) {
  try { return JSON.parse(s); } catch { return null; }
}

function genId() {
  try {
    if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
  } catch {}
  return `${Date.now()}-${Math.random()}`;
}

/**
 * Accepte:
 * - "150" => 150 min
 * - "2h" => 120
 * - "2h30" => 150
 * - "02:30" => 150
 */
function parseDurationToMinutes(v) {
  if (v === null || v === undefined) return null;
  const s = String(v).trim();
  if (!s) return null;

  if (/^\d+$/.test(s)) return Number(s);

  // 2h30 / 2h / 2 h 30
  const m1 = s.match(/^(\d+)\s*h\s*(\d+)?$/i);
  if (m1) {
    const h = Number(m1[1] || 0);
    const min = Number(m1[2] || 0);
    return h * 60 + min;
  }

  // 02:30
  const m2 = s.match(/^(\d+)\s*:\s*(\d+)$/);
  if (m2) {
    const h = Number(m2[1] || 0);
    const min = Number(m2[2] || 0);
    return h * 60 + min;
  }

  const n = Number(s.replace(',', '.'));
  return Number.isFinite(n) ? Math.round(n) : null;
}

function minutesToPretty(v) {
  if (v === null || v === undefined || v === '') return '';
  const n = Number(v);
  if (!Number.isFinite(n)) return String(v);
  const nn = Math.round(n);
  if (nn < 60) return String(nn);
  const h = Math.floor(nn / 60);
  const m = nn % 60;
  return m ? `${h}h${String(m).padStart(2, '0')}` : `${h}h`;
}

function mapTripFromApi(t) {
  return {
    id: (t.id ?? genId()),
    date: (t.trip_date || '').slice(0, 10),
    departHeure: t.depart_time || '',
    departKm: t.depart_km ?? '',
    debutTrajet: t.route_start || '',
    finTrajet: t.route_end || '',
    lieuStationnement: t.parking_place || '',
    dureeStationnement: t.parking_duration_min ?? '',
    arriveeHeure: t.arrival_time || '',
    arriveeKm: t.arrival_km ?? '',
    personnesTransportees: t.passengers || '',
    emargement: t.emargement || '',
    isMission: !!t.is_mission,
    missionLabel: t.mission_label || '',
  };
}

function mapSupplyFromApi(s) {
  return {
    id: (s.id ?? genId()),
    date: (s.supply_date || '').slice(0, 10),
    compteurKm: s.compteur_km ?? '',
    litres: s.liters ?? '',
    montantAr: s.montant_ar ?? '',
  };
}

function sameId(a, b) {
  return String(a) === String(b);
}

export default function LogbookEdit() {
  const { token, user } = useAuth();
  const { id } = useParams();

  const canEdit = ['LOGISTIQUE', 'ADMIN'].includes(user?.role);

  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);

  const [logbook, setLogbook] = useState(null);

  // Filtre période (UI only)
  const [headerFilter, setHeaderFilter] = useState({
    dateDebut: '',
    dateFin: '',
  });

  // Trajets
  const [trajets, setTrajets] = useState([]);
  const [showTrajetForm, setShowTrajetForm] = useState(false);
  // ✅ Correctif: on stocke l'ID du trajet en cours d'édition (et non l'index)
  const [editingTrajetId, setEditingTrajetId] = useState(null);

  const [currentTrajet, setCurrentTrajet] = useState({
    date: '',
    departHeure: '',
    departKm: '',
    debutTrajet: '',
    finTrajet: '',
    lieuStationnement: '',
    dureeStationnement: '',
    arriveeHeure: '',
    arriveeKm: '',
    personnesTransportees: '',
    emargement: '',
    isMission: false,
    missionLabel: '',
  });

  // Carburants
  const [carburants, setCarburants] = useState([]);
  const [showCarburantForm, setShowCarburantForm] = useState(false);
  const [editingCarburant, setEditingCarburant] = useState(null);
  const [currentCarburant, setCurrentCarburant] = useState({
    date: '',
    compteurKm: '',
    litres: '',
    montantAr: '',
  });

  // Corbeille (UI only)
  const [corbeille, setCorbeille] = useState({ trajets: [], carburants: [] });
  const [showCorbeille, setShowCorbeille] = useState(false);

  const locked = logbook?.status === 'LOCKED';

  async function load() {
    setLoading(true);
    setErr(null);
    try {
      const data = await apiFetch(`/api/logbooks/${id}`, { token });
      const book = data.logbook;

      const base = {
        logbook: book,
        headerFilter: {
          dateDebut: (book?.period_start || '').slice(0, 10),
          dateFin: (book?.period_end || '').slice(0, 10),
        },
        trajets: (data.trips || []).map(mapTripFromApi),
        carburants: (data.supplies || []).map(mapSupplyFromApi),
        corbeille: { trajets: [], carburants: [] },
      };

      // Restore draft si dispo
      const draftRaw = localStorage.getItem(draftKey(id));
      const draft = draftRaw ? safeJsonParse(draftRaw) : null;

      if (draft?.logbookId !== undefined && sameId(draft.logbookId, id)) {
        setLogbook({ ...base.logbook, ...draft.logbookEdits });
        setHeaderFilter(draft.headerFilter || base.headerFilter);
        setTrajets(Array.isArray(draft.trajets) ? draft.trajets : base.trajets);
        setCarburants(Array.isArray(draft.carburants) ? draft.carburants : base.carburants);
        setCorbeille(draft.corbeille || base.corbeille);
      } else {
        setLogbook(base.logbook);
        setHeaderFilter(base.headerFilter);
        setTrajets(base.trajets);
        setCarburants(base.carburants);
        setCorbeille(base.corbeille);
      }
    } catch (e) {
      setErr(e.message || String(e));
    } finally {
      setLoading(false);
    }
  }

  // ✅ Ajout token en dépendance (évite un load avec token périmé après login/refresh)
  useEffect(() => { load(); }, [id, token]);

  // Sauvegarde brouillon local (UI)
  useEffect(() => {
    if (loading) return;
    if (!logbook) return;

    const payload = {
      logbookId: id,
      savedAt: Date.now(),
      headerFilter,
      logbookEdits: {
        objet: logbook.objet ?? '',
        chauffeur_signature: logbook.chauffeur_signature ?? '',
        service_km: logbook.service_km ?? 0,
        mission_km: logbook.mission_km ?? 0,
      },
      trajets,
      carburants,
      corbeille,
    };
    localStorage.setItem(draftKey(id), JSON.stringify(payload));
  }, [loading, id, headerFilter, logbook, trajets, carburants, corbeille]);

  function clearLocalDraft() {
    localStorage.removeItem(draftKey(id));
    alert('✅ Brouillon local supprimé.');
  }

  // ===== Trajets =====
  function resetTrajetForm() {
    setCurrentTrajet({
      date: '',
      departHeure: '',
      departKm: '',
      debutTrajet: '',
      finTrajet: '',
      lieuStationnement: '',
      dureeStationnement: '',
      arriveeHeure: '',
      arriveeKm: '',
      personnesTransportees: '',
      emargement: '',
      isMission: false,
      missionLabel: '',
    });
    setShowTrajetForm(false);
    setEditingTrajetId(null);
  }

  function handleAddTrajet() {
    if (locked || !canEdit) return;

    const isMission = !!currentTrajet.isMission;

    if (!currentTrajet.date) {
      alert('Veuillez renseigner la date.');
      return;
    }

    if (!isMission) {
      if (currentTrajet.departKm === '' || currentTrajet.arriveeKm === '') {
        alert('Veuillez remplir au minimum les kilomètres départ/arrivée.');
        return;
      }
    } else {
      if (!String(currentTrajet.missionLabel || '').trim()) {
        alert('Veuillez renseigner le libellé de mission.');
        return;
      }
    }

    const item = { ...currentTrajet, id: currentTrajet.id || genId() };

    // ✅ Correctif: update par ID (fiable même si liste filtrée/triée)
    if (editingTrajetId !== null) {
      const idx = trajets.findIndex((x) => sameId(x.id, editingTrajetId));
      if (idx !== -1) {
        const updated = [...trajets];
        updated[idx] = item;
        setTrajets(updated);
      } else {
        setTrajets([...trajets, item]);
      }
    } else {
      setTrajets([...trajets, item]);
    }

    resetTrajetForm();
  }

  // ✅ Correctif: on reçoit l'ID, pas l'index
  function handleEditTrajet(trajetId) {
    if (locked || !canEdit) return;
    const idx = trajets.findIndex((x) => sameId(x.id, trajetId));
    if (idx === -1) return;
    setCurrentTrajet(trajets[idx]);
    setEditingTrajetId(trajetId);
    setShowTrajetForm(true);
  }

  // ✅ Correctif: delete par ID
  function handleDeleteTrajet(trajetId) {
    if (locked || !canEdit) return;
    const idx = trajets.findIndex((x) => sameId(x.id, trajetId));
    if (idx === -1) return;
    const trajetToDelete = trajets[idx];
    setCorbeille((prev) => ({ ...prev, trajets: [...prev.trajets, trajetToDelete] }));
    setTrajets(trajets.filter((x) => !sameId(x.id, trajetId)));
  }

  // ===== Carburants =====
  function resetCarburantForm() {
    setCurrentCarburant({ date: '', compteurKm: '', litres: '', montantAr: '' });
    setShowCarburantForm(false);
    setEditingCarburant(null);
  }

  function handleAddCarburant() {
    if (locked || !canEdit) return;

    if (!currentCarburant.date || currentCarburant.compteurKm === '' || currentCarburant.litres === '' || currentCarburant.montantAr === '') {
      alert('Veuillez remplir Date, Compteur, Litres et Montant.');
      return;
    }

    const item = { ...currentCarburant, id: currentCarburant.id || genId() };

    if (editingCarburant !== null) {
      const updated = [...carburants];
      updated[editingCarburant] = item;
      setCarburants(updated);
    } else {
      setCarburants([...carburants, item]);
    }

    resetCarburantForm();
  }

  function handleEditCarburant(index) {
    if (locked || !canEdit) return;
    setCurrentCarburant(carburants[index]);
    setEditingCarburant(index);
    setShowCarburantForm(true);
  }

  function handleDeleteCarburant(index) {
    if (locked || !canEdit) return;
    const carburantToDelete = carburants[index];
    setCorbeille((prev) => ({ ...prev, carburants: [...prev.carburants, carburantToDelete] }));
    setCarburants(carburants.filter((_, i) => i !== index));
  }

  // ===== Corbeille =====
  function restaurerTrajet(index) {
    if (locked || !canEdit) return;
    const x = corbeille.trajets[index];
    setTrajets([...trajets, x]);
    setCorbeille((prev) => ({ ...prev, trajets: prev.trajets.filter((_, i) => i !== index) }));
  }

  function restaurerCarburant(index) {
    if (locked || !canEdit) return;
    const x = corbeille.carburants[index];
    setCarburants([...carburants, x]);
    setCorbeille((prev) => ({ ...prev, carburants: prev.carburants.filter((_, i) => i !== index) }));
  }

  function viderCorbeille() {
    if (locked || !canEdit) return;
    if (window.confirm('Êtes-vous sûr de vouloir vider la corbeille ?')) {
      setCorbeille({ trajets: [], carburants: [] });
    }
  }

  // ===== Filtrage =====
  const trajetsFiltered = useMemo(() => {
    return trajets.filter((t) => {
      if (!headerFilter.dateDebut || !headerFilter.dateFin || !t.date) return true;
      return t.date >= headerFilter.dateDebut && t.date <= headerFilter.dateFin;
    });
  }, [trajets, headerFilter]);

  // ===== Stats =====
  const distanceTotale = useMemo(() => {
    return trajetsFiltered.reduce((acc, t) => {
      if (t.isMission) return acc;
      const dep = parseInt(t.departKm || 0, 10);
      const arr = parseInt(t.arriveeKm || 0, 10);
      const d = (Number.isFinite(arr) ? arr : 0) - (Number.isFinite(dep) ? dep : 0);
      return acc + (Number.isFinite(d) ? d : 0);
    }, 0);
  }, [trajetsFiltered]);

  // ===== Save backend =====
  async function saveAll() {
    if (!canEdit || locked) return;

    try {
      // Header
      await apiFetch(`/api/logbooks/${id}`, {
        token,
        method: 'PUT',
        body: {
          objet: logbook.objet ?? '',
          chauffeur_signature: logbook.chauffeur_signature ?? '',
          service_km: Number(logbook.service_km || 0),
          mission_km: Number(logbook.mission_km || 0),
        },
      });

      // Trips
      const tripsPayload = trajets.map((t, idx) => ({
        trip_date: t.date,
        depart_time: t.isMission ? null : (t.departHeure || null),
        depart_km: t.isMission ? null : (t.departKm === '' ? null : Number(t.departKm)),
        route_start: t.isMission ? null : (t.debutTrajet || null),
        route_end: t.isMission ? null : (t.finTrajet || null),
        parking_place: t.isMission ? null : (t.lieuStationnement || null),
        parking_duration_min: t.isMission ? null : parseDurationToMinutes(t.dureeStationnement),
        arrival_time: t.isMission ? null : (t.arriveeHeure || null),
        arrival_km: t.isMission ? null : (t.arriveeKm === '' ? null : Number(t.arriveeKm)),
        passengers: t.isMission ? null : (t.personnesTransportees || null),
        emargement: t.isMission ? null : (t.emargement || null),
        is_mission: !!t.isMission,
        mission_label: t.isMission ? (t.missionLabel || 'MISSION') : null,
        row_order: idx + 1,
      }));

      await apiFetch(`/api/logbooks/${id}/trips`, {
        token,
        method: 'PUT',
        body: { trips: tripsPayload },
      });

      // Supplies
      const suppliesPayload = carburants.map((s) => ({
        supply_date: s.date,
        compteur_km: Number(s.compteurKm),
        liters: Number(s.litres),
        montant_ar: Number(s.montantAr),
      }));

      await apiFetch(`/api/logbooks/${id}/supplies`, {
        token,
        method: 'PUT',
        body: { supplies: suppliesPayload },
      });

      // clear draft local (car synced)
      localStorage.removeItem(draftKey(id));

      alert('✅ Enregistré avec succès');
      await load();
    } catch (e) {
      alert('❌ Erreur lors de la sauvegarde : ' + (e.message || String(e)));
    }
  }

  async function submitLogbook() {
    if (!canEdit || locked) return;
    if (!window.confirm('Soumettre ce journal ?')) return;
    try {
      await apiFetch(`/api/logbooks/${id}/submit`, { token, method: 'PATCH' });
      await load();
      alert('✅ Journal soumis.');
    } catch (e) {
      alert('❌ ' + (e.message || String(e)));
    }
  }

  async function lockLogbook() {
    if (!canEdit || locked) return;
    if (!window.confirm('Verrouiller définitivement ce journal ? (Aucune modification ensuite)')) return;
    try {
      await apiFetch(`/api/logbooks/${id}/lock`, { token, method: 'PATCH' });
      localStorage.removeItem(draftKey(id));
      await load();
      alert('🔒 Journal verrouillé.');
    } catch (e) {
      alert('❌ ' + (e.message || String(e)));
    }
  }

  function handlePrint() {
    window.open(`/print/logbook/${id}`, '_blank', 'noopener,noreferrer');
  }

  if (loading) return <div className="card">Chargement...</div>;
  if (err) return <div className="card"><div className="error">{err}</div><Link to="/app/logbooks">Retour</Link></div>;
  if (!logbook) return <div className="card">Journal de bord non trouvé.</div>;

  const corbeilleCount = (corbeille.trajets.length + corbeille.carburants.length);

  return (
    <div className="container">
      {/* HEADER */}
      <div className="card" style={{ marginBottom: 16 }}>
        <div className="rowBetween" style={{ alignItems: 'flex-start' }}>
          <div style={{ display: 'flex', gap: 12, alignItems: 'center' }}>
            <div style={{
              background: '#111827',
              color: '#fff',
              padding: '10px 14px',
              borderRadius: 12,
              minWidth: 88,
              textAlign: 'center'
            }}>
              <div style={{ fontWeight: 900, lineHeight: 1 }}>CEP</div>
              <div style={{ fontSize: 11, opacity: .9 }}>PRIRTEM</div>
            </div>

            <div>
              <div style={{ fontSize: 22, fontWeight: 900, marginBottom: 4 }}>JOURNAL DE BORD VOITURE</div>
              <div className="muted" style={{ fontSize: 13, display: 'flex', gap: 12, flexWrap: 'wrap' }}>
                <span><b>Immatriculation:</b> {logbook.plate}</span>
                <span><b>Période:</b> {String(logbook.period_start).slice(0,10)} → {String(logbook.period_end).slice(0,10)}</span>
                <span className={`badge ${logbook.status === 'LOCKED' ? 'badge-bad' : logbook.status === 'SUBMITTED' ? 'badge-info' : 'badge-warn'}`}>
                  {logbook.status}
                </span>
              </div>
            </div>
          </div>

          <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', justifyContent: 'flex-end' }}>
            <button className="btn btn-secondary" onClick={() => setShowCorbeille((v) => !v)}>
              🗑️ Corbeille ({corbeilleCount})
            </button>
            <button className="btn btn-secondary" onClick={handlePrint}>
              🖨️ Imprimer
            </button>
            <Link className="btn btn-outline" to="/app/logbooks">
              ← Retour
            </Link>
            {canEdit && !locked && (
              <button className="btn" onClick={saveAll}>
                💾 Enregistrer
              </button>
            )}
          </div>
        </div>
      </div>

      {/* Infos générales */}
      <div className="card" style={{ marginBottom: 16 }}>
        <div className="grid2">
          <div className="field">
            <div className="label">Objet</div>
            <input
              disabled={!canEdit || locked}
              value={logbook.objet || ''}
              onChange={(e) => setLogbook({ ...logbook, objet: e.target.value })}
              placeholder="Description du véhicule/mission"
            />
          </div>

          <div className="field">
            <div className="label">Immatriculation</div>
            <input disabled value={logbook.plate || ''} />
          </div>
        </div>

        <div style={{ height: 12 }} />

        <div className="grid2">
          <div className="field">
            <div className="label">Période du (filtre)</div>
            <input
              type="date"
              value={headerFilter.dateDebut || ''}
              onChange={(e) => setHeaderFilter({ ...headerFilter, dateDebut: e.target.value })}
            />
          </div>
          <div className="field">
            <div className="label">au (filtre)</div>
            <input
              type="date"
              value={headerFilter.dateFin || ''}
              onChange={(e) => setHeaderFilter({ ...headerFilter, dateFin: e.target.value })}
            />
          </div>
        </div>

        <div style={{ marginTop: 10, display: 'flex', gap: 8, flexWrap: 'wrap' }}>
          <button className="btn btn-outline btn-sm" onClick={clearLocalDraft}>
            ♻️ Supprimer brouillon local
          </button>
        </div>
      </div>

      {/* Corbeille */}
      {showCorbeille && (
        <div className="card" style={{ marginBottom: 16, border: '2px solid rgba(15,23,42,.18)', background: 'rgba(15,23,42,.02)' }}>
          <div className="rowBetween" style={{ marginBottom: 10 }}>
            <div style={{ fontWeight: 900, fontSize: 18 }}>Corbeille</div>
            <button className="btn btn-danger btn-sm" onClick={viderCorbeille} disabled={!canEdit || locked}>
              Vider la corbeille
            </button>
          </div>

          {corbeille.trajets.length > 0 && (
            <div style={{ marginBottom: 12 }}>
              <div style={{ fontWeight: 800, marginBottom: 6 }}>Trajets supprimés</div>
              {corbeille.trajets.map((t, i) => (
                <div key={i} className="card" style={{ padding: 10, marginBottom: 8 }}>
                  <div className="rowBetween">
                    <div style={{ fontSize: 13 }}>
                      <b>{t.date}</b>
                      {' — '}
                      {t.isMission ? `MISSION: ${t.missionLabel || ''}` : `${t.debutTrajet} → ${t.finTrajet}`}
                    </div>
                    <button className="btn btn-secondary btn-sm" onClick={() => restaurerTrajet(i)} disabled={!canEdit || locked}>
                      ↩ Restaurer
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}

          {corbeille.carburants.length > 0 && (
            <div>
              <div style={{ fontWeight: 800, marginBottom: 6 }}>Carburants supprimés</div>
              {corbeille.carburants.map((c, i) => (
                <div key={i} className="card" style={{ padding: 10, marginBottom: 8 }}>
                  <div className="rowBetween">
                    <div style={{ fontSize: 13 }}>
                      <b>{c.date}</b> — {c.compteurKm} km — {c.litres} L — {c.montantAr} Ar
                    </div>
                    <button className="btn btn-secondary btn-sm" onClick={() => restaurerCarburant(i)} disabled={!canEdit || locked}>
                      ↩ Restaurer
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}

          {corbeille.trajets.length === 0 && corbeille.carburants.length === 0 && (
            <div className="muted" style={{ textAlign: 'center', padding: 10 }}>La corbeille est vide</div>
          )}
        </div>
      )}

      {/* Trajets */}
      <div className="card" style={{ marginBottom: 16 }}>
        <div className="rowBetween" style={{ marginBottom: 10 }}>
          <div style={{ fontWeight: 900, fontSize: 18 }}>Trajets</div>
          {canEdit && !locked && (
            <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
              <button
                className="btn btn-secondary btn-sm"
                onClick={() => {
                  setCurrentTrajet((p) => ({ ...p, isMission: false }));
                  setShowTrajetForm((v) => !v);
                }}
              >
                ➕ Ajouter un trajet
              </button>
              <button
                className="btn btn-secondary btn-sm"
                onClick={() => {
                  setCurrentTrajet({
                    ...currentTrajet,
                    date: headerFilter.dateDebut || currentTrajet.date || '',
                    isMission: true,
                    missionLabel: currentTrajet.missionLabel || 'MISSION',
                    departHeure: '',
                    departKm: '',
                    debutTrajet: '',
                    finTrajet: '',
                    lieuStationnement: '',
                    dureeStationnement: '',
                    arriveeHeure: '',
                    arriveeKm: '',
                    personnesTransportees: '',
                    emargement: '',
                  });
                  setEditingTrajetId(null);
                  setShowTrajetForm(true);
                }}
              >
                🎯 Ajouter mission
              </button>
            </div>
          )}
        </div>

        {/* Form trajet */}
        {showTrajetForm && (
          <div className="card" style={{ marginBottom: 12, border: '2px solid rgba(37,99,235,.18)', background: 'rgba(37,99,235,.04)' }}>
            <div style={{ fontWeight: 800, marginBottom: 10 }}>
              {editingTrajetId !== null ? 'Modifier' : 'Nouveau'} {currentTrajet.isMission ? ' (MISSION)' : ''}
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, minmax(0,1fr))', gap: 12 }}>
              <div className="field">
                <div className="label">Date *</div>
                <input
                  type="date"
                  value={currentTrajet.date}
                  onChange={(e) => setCurrentTrajet({ ...currentTrajet, date: e.target.value })}
                  disabled={!canEdit || locked}
                />
              </div>

              {!currentTrajet.isMission && (
                <>
                  <div className="field">
                    <div className="label">Départ - Heure</div>
                    <input
                      type="time"
                      value={currentTrajet.departHeure}
                      onChange={(e) => setCurrentTrajet({ ...currentTrajet, departHeure: e.target.value })}
                      disabled={!canEdit || locked}
                    />
                  </div>
                  <div className="field">
                    <div className="label">Départ - Km *</div>
                    <input
                      type="number"
                      value={currentTrajet.departKm}
                      onChange={(e) => setCurrentTrajet({ ...currentTrajet, departKm: e.target.value })}
                      disabled={!canEdit || locked}
                    />
                  </div>
                </>
              )}

              {currentTrajet.isMission && (
                <div className="field" style={{ gridColumn: 'span 2' }}>
                  <div className="label">Libellé mission *</div>
                  <input
                    value={currentTrajet.missionLabel}
                    onChange={(e) => setCurrentTrajet({ ...currentTrajet, missionLabel: e.target.value })}
                    disabled={!canEdit || locked}
                    placeholder="Détails mission..."
                  />
                </div>
              )}

              {!currentTrajet.isMission && (
                <>
                  <div className="field">
                    <div className="label">Début de trajet</div>
                    <input
                      value={currentTrajet.debutTrajet}
                      onChange={(e) => setCurrentTrajet({ ...currentTrajet, debutTrajet: e.target.value })}
                      disabled={!canEdit || locked}
                    />
                  </div>
                  <div className="field">
                    <div className="label">Fin de trajet</div>
                    <input
                      value={currentTrajet.finTrajet}
                      onChange={(e) => setCurrentTrajet({ ...currentTrajet, finTrajet: e.target.value })}
                      disabled={!canEdit || locked}
                    />
                  </div>
                  <div className="field">
                    <div className="label">Lieu de stationnement</div>
                    <input
                      value={currentTrajet.lieuStationnement}
                      onChange={(e) => setCurrentTrajet({ ...currentTrajet, lieuStationnement: e.target.value })}
                      disabled={!canEdit || locked}
                    />
                  </div>

                  <div className="field">
                    <div className="label">Durée stationnement (min / 2h30)</div>
                    <input
                      value={currentTrajet.dureeStationnement}
                      onChange={(e) => setCurrentTrajet({ ...currentTrajet, dureeStationnement: e.target.value })}
                      disabled={!canEdit || locked}
                      placeholder="Ex: 150 ou 2h30"
                    />
                  </div>
                  <div className="field">
                    <div className="label">Arrivée - Heure</div>
                    <input
                      type="time"
                      value={currentTrajet.arriveeHeure}
                      onChange={(e) => setCurrentTrajet({ ...currentTrajet, arriveeHeure: e.target.value })}
                      disabled={!canEdit || locked}
                    />
                  </div>
                  <div className="field">
                    <div className="label">Arrivée - Km *</div>
                    <input
                      type="number"
                      value={currentTrajet.arriveeKm}
                      onChange={(e) => setCurrentTrajet({ ...currentTrajet, arriveeKm: e.target.value })}
                      disabled={!canEdit || locked}
                    />
                  </div>

                  <div className="field">
                    <div className="label">Personnes transportées</div>
                    <input
                      value={currentTrajet.personnesTransportees}
                      onChange={(e) => setCurrentTrajet({ ...currentTrajet, personnesTransportees: e.target.value })}
                      disabled={!canEdit || locked}
                    />
                  </div>
                  <div className="field">
                    <div className="label">Émargement</div>
                    <input
                      value={currentTrajet.emargement}
                      onChange={(e) => setCurrentTrajet({ ...currentTrajet, emargement: e.target.value })}
                      disabled={!canEdit || locked}
                    />
                  </div>
                </>
              )}
            </div>

            <div style={{ marginTop: 12, display: 'flex', gap: 8, flexWrap: 'wrap' }}>
              <button className="btn btn-secondary" onClick={handleAddTrajet} disabled={!canEdit || locked}>
                💾 {editingTrajetId !== null ? 'Mettre à jour' : 'Enregistrer'}
              </button>
              <button className="btn btn-outline" onClick={resetTrajetForm}>
                Annuler
              </button>
            </div>
          </div>
        )}

        {/* Table trajets */}
        <div className="tableWrap">
          <table className="table" style={{ minWidth: 1100, fontSize: 12 }}>
            <thead>
              <tr>
                <th>DATE</th>
                <th>DÉPART (H)</th>
                <th>DÉPART (KM)</th>
                <th>DÉBUT</th>
                <th>FIN</th>
                <th>LIEU STATION.</th>
                <th>DURÉE</th>
                <th>ARRIVÉE (H)</th>
                <th>ARRIVÉE (KM)</th>
                <th>PERSONNES</th>
                <th>ÉMARGEMENT</th>
                {canEdit && !locked && <th style={{ width: 110 }}>ACTIONS</th>}
              </tr>
            </thead>
            <tbody>
              {trajetsFiltered.length === 0 ? (
                <tr>
                  <td colSpan={canEdit && !locked ? 12 : 11} className="muted" style={{ padding: 16 }}>
                    Aucun trajet enregistré.
                  </td>
                </tr>
              ) : (
                trajetsFiltered.map((t) => (
                  t.isMission ? (
                    <tr key={t.id} style={{ background: 'rgba(16,185,129,.10)' }}>
                      <td><b>{t.date}</b></td>
                      <td colSpan={canEdit && !locked ? 10 : 9}>
                        <b>🎯 MISSION</b> — {t.missionLabel || ''}
                      </td>
                      {canEdit && !locked && (
                        <td>
                          <div style={{ display: 'flex', gap: 6 }}>
                            <button className="btn btn-outline btn-sm" onClick={() => handleEditTrajet(t.id)}>✏️</button>
                            <button className="btn btn-danger btn-sm" onClick={() => handleDeleteTrajet(t.id)}>🗑️</button>
                          </div>
                        </td>
                      )}
                    </tr>
                  ) : (
                    <tr key={t.id}>
                      <td>{t.date}</td>
                      <td>{t.departHeure}</td>
                      <td>{t.departKm}</td>
                      <td>{t.debutTrajet}</td>
                      <td>{t.finTrajet}</td>
                      <td>{t.lieuStationnement}</td>
                      <td>{minutesToPretty(t.dureeStationnement)}</td>
                      <td>{t.arriveeHeure}</td>
                      <td>{t.arriveeKm}</td>
                      <td>{t.personnesTransportees}</td>
                      <td>{t.emargement}</td>
                      {canEdit && !locked && (
                        <td>
                          <div style={{ display: 'flex', gap: 6 }}>
                            <button className="btn btn-outline btn-sm" onClick={() => handleEditTrajet(t.id)}>✏️</button>
                            <button className="btn btn-danger btn-sm" onClick={() => handleDeleteTrajet(t.id)}>🗑️</button>
                          </div>
                        </td>
                      )}
                    </tr>
                  )
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Approvisionnement Carburant */}
      <div className="card" style={{ marginBottom: 16 }}>
        <div className="rowBetween" style={{ marginBottom: 10 }}>
          <div style={{ fontWeight: 900, fontSize: 18 }}>Approvisionnement Carburant</div>
          {canEdit && !locked && (
            <button className="btn btn-secondary btn-sm" onClick={() => setShowCarburantForm((v) => !v)}>
              ➕ Ajouter carburant
            </button>
          )}
        </div>

        {showCarburantForm && (
          <div className="card" style={{ marginBottom: 12, border: '2px solid rgba(16,185,129,.18)', background: 'rgba(16,185,129,.04)' }}>
            <div style={{ fontWeight: 800, marginBottom: 10 }}>
              {editingCarburant !== null ? 'Modifier' : 'Nouvel'} approvisionnement
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, minmax(0,1fr))', gap: 12 }}>
              <div className="field">
                <div className="label">Date *</div>
                <input
                  type="date"
                  value={currentCarburant.date}
                  onChange={(e) => setCurrentCarburant({ ...currentCarburant, date: e.target.value })}
                  disabled={!canEdit || locked}
                />
              </div>
              <div className="field">
                <div className="label">Compteur Km *</div>
                <input
                  type="number"
                  value={currentCarburant.compteurKm}
                  onChange={(e) => setCurrentCarburant({ ...currentCarburant, compteurKm: e.target.value })}
                  disabled={!canEdit || locked}
                />
              </div>
              <div className="field">
                <div className="label">Litres *</div>
                <input
                  type="number"
                  step="0.01"
                  value={currentCarburant.litres}
                  onChange={(e) => setCurrentCarburant({ ...currentCarburant, litres: e.target.value })}
                  disabled={!canEdit || locked}
                />
              </div>
              <div className="field">
                <div className="label">Montant (Ar) *</div>
                <input
                  type="number"
                  value={currentCarburant.montantAr}
                  onChange={(e) => setCurrentCarburant({ ...currentCarburant, montantAr: e.target.value })}
                  disabled={!canEdit || locked}
                />
              </div>
            </div>

            <div style={{ marginTop: 12, display: 'flex', gap: 8, flexWrap: 'wrap' }}>
              <button className="btn btn-secondary" onClick={handleAddCarburant} disabled={!canEdit || locked}>
                💾 {editingCarburant !== null ? 'Mettre à jour' : 'Enregistrer'}
              </button>
              <button className="btn btn-outline" onClick={resetCarburantForm}>
                Annuler
              </button>
            </div>
          </div>
        )}

        <div className="tableWrap">
          <table className="table" style={{ minWidth: 820, fontSize: 12 }}>
            <thead>
              <tr>
                <th>Date</th>
                <th>Compteur Km</th>
                <th>Litres</th>
                <th>Montant (Ar)</th>
                {canEdit && !locked && <th style={{ width: 110 }}>Actions</th>}
              </tr>
            </thead>
            <tbody>
              {carburants.length === 0 ? (
                <tr>
                  <td colSpan={canEdit && !locked ? 5 : 4} className="muted" style={{ padding: 16 }}>
                    Aucun approvisionnement enregistré.
                  </td>
                </tr>
              ) : (
                carburants.map((c, index) => (
                  <tr key={c.id}>
                    <td>{c.date}</td>
                    <td>{c.compteurKm}</td>
                    <td>{c.litres}</td>
                    <td>{c.montantAr}</td>
                    {canEdit && !locked && (
                      <td>
                        <div style={{ display: 'flex', gap: 6 }}>
                          <button className="btn btn-outline btn-sm" onClick={() => handleEditCarburant(index)}>✏️</button>
                          <button className="btn btn-danger btn-sm" onClick={() => handleDeleteCarburant(index)}>🗑️</button>
                        </div>
                      </td>
                    )}
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Footer stats + résumé */}
      <div className="card" style={{ marginBottom: 16 }}>
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, minmax(0,1fr))', gap: 12 }}>
          <div className="card" style={{ padding: 12, background: 'rgba(37,99,235,.06)' }}>
            <div className="label">Total trajets (filtrés)</div>
            <div style={{ fontSize: 26, fontWeight: 900 }}>{trajetsFiltered.length}</div>
          </div>

          <div className="card" style={{ padding: 12, background: 'rgba(16,185,129,.06)' }}>
            <div className="label">Total carburants</div>
            <div style={{ fontSize: 26, fontWeight: 900 }}>{carburants.length}</div>
          </div>

          <div className="card" style={{ padding: 12, background: 'rgba(245,158,11,.10)' }}>
            <div className="label">Distance totale (approx.)</div>
            <div style={{ fontSize: 26, fontWeight: 900 }}>{distanceTotale} km</div>
          </div>
        </div>

        <div style={{ height: 12 }} />

        <div className="grid2">
          <div className="field">
            <div className="label">Services (km) - manuel</div>
            <input
              type="number"
              disabled={!canEdit || locked}
              value={logbook.service_km ?? 0}
              onChange={(e) => setLogbook({ ...logbook, service_km: e.target.value })}
            />
          </div>
          <div className="field">
            <div className="label">Mission (km) - manuel</div>
            <input
              type="number"
              disabled={!canEdit || locked}
              value={logbook.mission_km ?? 0}
              onChange={(e) => setLogbook({ ...logbook, mission_km: e.target.value })}
            />
          </div>
        </div>

        <div style={{ height: 12 }} />

        <div className="field">
          <div className="label">Signature Chauffeur</div>
          <input
            disabled={!canEdit || locked}
            value={logbook.chauffeur_signature || ''}
            onChange={(e) => setLogbook({ ...logbook, chauffeur_signature: e.target.value })}
            placeholder="Nom du chauffeur"
          />
        </div>
      </div>

      {/* Actions de flux */}
      {canEdit && !locked && (
        <div className="rowBetween" style={{ marginBottom: 18 }}>
          <div className="muted" style={{ fontSize: 13 }}>
            Astuce: tu peux travailler puis cliquer <b>Enregistrer</b>. Le brouillon local évite de perdre en cas de refresh.
          </div>
          <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', justifyContent: 'flex-end' }}>
            {logbook.status === 'DRAFT' && (
              <button className="btn btn-secondary" onClick={submitLogbook}>
                📤 Soumettre
              </button>
            )}
            <button className="btn btn-danger" onClick={lockLogbook}>
              🔒 Verrouiller définitivement
            </button>
          </div>
        </div>
      )}

      {locked && (
        <div className="card" style={{ border: '2px solid rgba(239,68,68,.35)', background: 'rgba(239,68,68,.06)' }}>
          <div style={{ fontWeight: 900, color: '#b91c1c', textAlign: 'center' }}>
            🔒 Ce journal est VERROUILLÉ — aucune modification n’est possible.
          </div>
        </div>
      )}
    </div>
  );
}


────────────────── client/src/pages/ImportExcel.jsx ──────────────────
import React, { useEffect, useState } from 'react';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch, apiUpload } from '../utils/api.js';

export default function ImportExcel() {
  const { token, user } = useAuth();
  const [files, setFiles] = useState([]);
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const [batches, setBatches] = useState([]);
  const [selectedBatch, setSelectedBatch] = useState(null);
  const [batchFiles, setBatchFiles] = useState([]);
  const [error, setError] = useState(null);

  const isAllowed = ['ADMIN','LOGISTIQUE'].includes(user?.role);

  async function refreshBatches() {
    const data = await apiFetch('/api/import/batches', { token });
    setBatches(data.batches || []);
  }

  async function loadBatchFiles(batchId) {
    setSelectedBatch(batchId);
    const data = await apiFetch(`/api/import/batches/${batchId}/files`, { token });
    setBatchFiles(data.files || []);
  }

  useEffect(() => {
    if (token && ['ADMIN','LOGISTIQUE','RAF'].includes(user?.role)) {
      refreshBatches().catch(() => {});
    }
  }, [token, user?.role]);

  async function onUpload() {
    setError(null);
    if (!files.length) return;
    setLoading(true);
    try {
      const batch = await apiFetch('/api/import/batch', { token, method: 'POST', body: {} });
      const fd = new FormData();
      fd.append('batch_id', batch.batch_id);
      for (const f of files) fd.append('files', f);
      const data = await apiUpload('/api/import/upload', { token, formData: fd });
      setResult(data);
      await refreshBatches();
      await loadBatchFiles(data.batch_id);
      setFiles([]);
    } catch (e) {
      setError(e.message);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="grid" style={{ gridTemplateColumns: '1fr 1fr', gap: 16 }}>
      <div className="card">
        <h2>Import Excel (Admin/Logistique)</h2>
        {!isAllowed && <div className="muted">Accès réservé.</div>}
        {isAllowed && (
          <>
            <input
              type="file"
              multiple
              accept=".xlsx"
              onChange={(e) => setFiles(Array.from(e.target.files || []))}
            />
            <div style={{ height: 8 }} />
            <button className="btn" disabled={loading || !files.length} onClick={onUpload}>
              {loading ? 'Import...' : 'Importer'}
            </button>

            {error && <div className="alert">{error}</div>}

            {result && (
              <div style={{ marginTop: 12 }}>
                <div className="muted">Batch: {result.batch_id}</div>
                <table className="table" style={{ marginTop: 8 }}>
                  <thead>
                    <tr>
                      <th>Fichier</th>
                      <th>Type</th>
                      <th>Insérés</th>
                      <th>Erreur</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(result.results || []).map((r, idx) => (
                      <tr key={idx}>
                        <td>{r.file}</td>
                        <td>{r.type || '-'}</td>
                        <td>{r.inserted ?? '-'}</td>
                        <td>{r.error || ''}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </>
        )}
      </div>

      <div className="card">
        <h2>Historique imports</h2>
        <div className="muted">Clique un batch pour voir les détails.</div>

        <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', marginTop: 8 }}>
          {(batches || []).slice(0, 20).map((b) => (
            <button
              key={b.id}
              className="btn btn-secondary"
              onClick={() => loadBatchFiles(b.id)}
              title={`Batch ${b.id}`}
            >
              {new Date(b.created_at).toLocaleString('fr-FR')}
              {' • '}
              {b.created_by || '—'}
              {' • '}
              {b.files} fichiers
            </button>
          ))}
        </div>

        {selectedBatch && (
          <div style={{ marginTop: 12 }}>
            <h3 style={{ marginTop: 0 }}>Batch {selectedBatch}</h3>

            <table className="table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Insérés</th>
                  <th>Traité le</th>
                  <th>Erreur</th>
                </tr>
              </thead>
              <tbody>
                {(batchFiles || []).map((f) => (
                  <tr key={f.id}>
                    <td>{f.original_name}</td>
                    <td>{f.detected_type || '-'}</td>
                    <td>{f.status}</td>
                    <td>{f.inserted_rows ?? ''}</td>
                    <td>{f.processed_at ? new Date(f.processed_at).toLocaleString('fr-FR') : ''}</td>
                    <td>{f.error_message || ''}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}


────────────────── client/src/pages/FuelRequestsRaf.jsx ──────────────────
import React, { useEffect, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

function fmtAr(n) {
  try { return new Intl.NumberFormat('fr-FR').format(Number(n || 0)) + ' Ar'; } catch { return String(n || 0) + ' Ar'; }
}

export default function FuelRequestsRaf() {
  const { token, user } = useAuth();
  const role = user?.role;
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [view, setView] = useState(null);

  async function load() {
    setLoading(true);
    setError(null);
    try {
      const r = await apiFetch('/api/requests/fuel?status=VERIFIED', { token });
      setRows(r.requests || []);
    } catch (e) {
      setError(e.message);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => { load(); }, []);

  async function openView(id) {
    setView({ loading: true, data: null });
    try {
      const d = await apiFetch(`/api/requests/fuel/${id}`, { token });
      setView({ loading: false, data: d.request });
    } catch (e) {
      setView(null);
      alert(e.message || String(e));
    }
  }

  async function approve(id) {
    await apiFetch(`/api/requests/fuel/${id}/approve`, { token, method: 'POST' });
    await load();
  }

  async function reject(id) {
    const reason = prompt('Motif de rejet (obligatoire)') || '';
    if (!reason.trim()) return;
    await apiFetch(`/api/requests/fuel/${id}/reject`, { token, method: 'POST', body: { reason } });
    await load();
  }

  const can = ['RAF', 'ADMIN'].includes(role);

  return (
    <div className="card">
      <h2>Visa RAF carburant</h2>
      {error && <div className="alert">{error}</div>}
      {loading ? <div className="muted">Chargement...</div> : (
        <table className="table">
          <thead>
            <tr>
              <th>N°</th>
              <th>Date</th>
              <th>Type</th>
              <th>Objet</th>
              <th>Montant</th>
              <th style={{ width: 260 }}></th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r) => (
              <tr key={r.id}>
                <td><b>{r.request_no}</b></td>
                <td>{r.request_date}</td>
                <td>{r.request_type}</td>
                <td>{r.objet}</td>
                <td>{fmtAr(r.amount_estimated_ar)}</td>
                <td style={{ whiteSpace: 'nowrap' }}>
                  <button className="btn btn-outline btn-sm" onClick={() => openView(r.id)}>Voir</button>
                  <span style={{ display: 'inline-block', width: 8 }} />
                  {can && (
                    <>
                      <button className="btn btn-sm" onClick={() => approve(r.id)}>Approuver</button>
                      <span style={{ display: 'inline-block', width: 8 }} />
                      <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Rejeter</button>
                    </>
                  )}
                </td>
              </tr>
            ))}
            {!rows.length && <tr><td colSpan={6} className="muted">Rien à viser.</td></tr>}
          </tbody>
        </table>
      )}

      {view && (
        <Modal title="Détails demande carburant" onClose={() => setView(null)} width={800}>
          {view.loading ? <div className="muted">Chargement...</div> : (
            <div className="grid2">
              <div className="card">
                <div className="label">N°</div><div><b>{view.data.request_no}</b></div>
                <div className="label" style={{ marginTop: 10 }}>Date</div><div>{view.data.request_date}</div>
                <div className="label" style={{ marginTop: 10 }}>Type</div><div>{view.data.request_type}</div>
                <div className="label" style={{ marginTop: 10 }}>Objet</div><div>{view.data.objet}</div>
              </div>
              <div className="card">
                <div className="label">Montant</div><div><b>{fmtAr(view.data.amount_estimated_ar)}</b></div>
                <div className="label" style={{ marginTop: 10 }}>Montant (lettres)</div><div>{view.data.amount_estimated_words || <span className="muted">—</span>}</div>
                <div className="label" style={{ marginTop: 10 }}>Statut</div><div><span className="badge">{view.data.status}</span></div>
              </div>
            </div>
          )}
        </Modal>
      )}
    </div>
  );
}


────────────────── client/src/pages/FuelRequestsManage.jsx ──────────────────
import React, { useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

function fmtAr(n) {
  try { return new Intl.NumberFormat('fr-FR').format(Number(n || 0)) + ' Ar'; } catch { return String(n || 0) + ' Ar'; }
}

export default function FuelRequestsManage() {
  const { token, user } = useAuth();
  const role = user?.role;
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const [view, setView] = useState(null); // {loading,data}
  const [editId, setEditId] = useState(null);
  const [edit, setEdit] = useState({ request_date: '', request_type: 'SERVICE', objet: '', amount_estimated_ar: 0, amount_estimated_words: '' });

  const canManage = useMemo(() => ['LOGISTIQUE', 'ADMIN'].includes(role), [role]);

  async function load() {
    setLoading(true);
    setError(null);
    try {
      const d = await apiFetch('/api/requests/fuel?status=SUBMITTED', { token });
      setRows(d.requests || []);
    } catch (e) {
      setError(e.message || String(e));
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => { load(); }, []);

  async function openView(id) {
    setView({ loading: true, data: null });
    try {
      const d = await apiFetch(`/api/requests/fuel/${id}`, { token });
      setView({ loading: false, data: d.request });
    } catch (e) {
      setView(null);
      alert(e.message || String(e));
    }
  }

  function startEdit(r) {
    setEditId(r.id);
    setEdit({
      request_date: (r.request_date || '').slice(0, 10),
      request_type: r.request_type || 'SERVICE',
      objet: r.objet || '',
      amount_estimated_ar: Number(r.amount_estimated_ar || 0),
      amount_estimated_words: r.amount_estimated_words || ''
    });
  }

  async function saveEdit(id) {
    try {
      await apiFetch(`/api/requests/fuel/${id}`, {
        token,
        method: 'PUT',
        body: {
          request_date: edit.request_date,
          request_type: edit.request_type,
          objet: edit.objet,
          amount_estimated_ar: Number(edit.amount_estimated_ar || 0),
          amount_estimated_words: edit.amount_estimated_words
        }
      });
      setEditId(null);
      await load();
    } catch (e) {
      alert(e.message || String(e));
    }
  }

  async function softDelete(id) {
    if (!window.confirm('Déplacer dans Corbeille ?')) return;
    try {
      await apiFetch(`/api/requests/fuel/${id}`, { token, method: 'DELETE' });
      await load();
      alert('OK: déplacé dans Corbeille.');
    } catch (e) {
      alert(e.message || String(e));
    }
  }

  async function verify(id) {
    try {
      await apiFetch(`/api/requests/fuel/${id}/verify`, { token, method: 'POST' });
      await load();
    } catch (e) {
      alert(e.message || String(e));
    }
  }

  async function reject(id) {
    const reason = window.prompt('Motif de rejet (optionnel) :') || null;
    try {
      await apiFetch(`/api/requests/fuel/${id}/reject`, { token, method: 'POST', body: { reason } });
      await load();
    } catch (e) {
      alert(e.message || String(e));
    }
  }

  if (!canManage) return <div className="card"><h2>Validation carburant</h2><div className="muted">Accès Logistique/Admin.</div></div>;

  return (
    <div className="card">
      <h2>Validation carburant (Logistique)</h2>
      {error && <div className="alert">{error}</div>}
      {loading ? (
        <div className="muted">Chargement...</div>
      ) : (
        <table className="table">
          <thead>
            <tr>
              <th>N°</th>
              <th>Date</th>
              <th>Type</th>
              <th>Objet</th>
              <th>Montant</th>
              <th>Demandeur</th>
              <th style={{ width: 360 }}></th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r) => {
              const isEdit = editId === r.id;
              return (
                <tr key={r.id}>
                  <td>{r.request_no}</td>
                  <td>{isEdit ? <input className="input" type="date" value={edit.request_date} onChange={(e) => setEdit({ ...edit, request_date: e.target.value })} /> : (r.request_date || '').slice(0, 10)}</td>
                  <td>{isEdit ? (
                    <select className="input" value={edit.request_type} onChange={(e) => setEdit({ ...edit, request_type: e.target.value })}>
                      <option value="SERVICE">SERVICE</option>
                      <option value="MISSION">MISSION</option>
                    </select>
                  ) : r.request_type}</td>
                  <td>{isEdit ? <input className="input" value={edit.objet} onChange={(e) => setEdit({ ...edit, objet: e.target.value })} /> : r.objet}</td>
                  <td>{isEdit ? <input className="input" type="number" value={edit.amount_estimated_ar} onChange={(e) => setEdit({ ...edit, amount_estimated_ar: e.target.value })} /> : fmtAr(r.amount_estimated_ar)}</td>
                  <td>{r.requester_name}</td>
                  <td style={{ whiteSpace: 'nowrap' }}>
                    <button className="btn btn-outline btn-sm" onClick={() => openView(r.id)}>Voir</button>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    {isEdit ? (
                      <>
                        <button className="btn btn-sm" onClick={() => saveEdit(r.id)}>Valider</button>
                        <span style={{ display: 'inline-block', width: 8 }} />
                        <button className="btn btn-secondary btn-sm" onClick={() => setEditId(null)}>Annuler</button>
                      </>
                    ) : (
                      <button className="btn btn-secondary btn-sm" onClick={() => startEdit(r)}>Modifier</button>
                    )}
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <button className="btn btn-danger btn-sm" onClick={() => softDelete(r.id)}>Supprimer</button>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <button className="btn btn-sm" onClick={() => verify(r.id)}>Visa Logistique</button>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Non-validé</button>
                  </td>
                </tr>
              );
            })}
            {!rows.length && <tr><td colSpan={7} className="muted">Aucune demande SUBMITTED.</td></tr>}
          </tbody>
        </table>
      )}

      {view && (
        <Modal title={`Demande carburant — ${view.data?.request_no || ''}`} onClose={() => setView(null)} width={820}>
          {view.loading ? (
            <div className="muted">Chargement...</div>
          ) : view.data ? (
            <div className="grid2">
              <div className="card">
                <div className="label">Date</div>
                <div>{(view.data.request_date || '').slice(0, 10)}</div>
                <div className="label" style={{ marginTop: 10 }}>Type</div>
                <div>{view.data.request_type}</div>
                <div className="label" style={{ marginTop: 10 }}>Objet</div>
                <div>{view.data.objet}</div>
                <div className="label" style={{ marginTop: 10 }}>Montant</div>
                <div><b>{fmtAr(view.data.amount_estimated_ar)}</b></div>
              </div>
              <div className="card">
                <div className="label">Statut</div>
                <div><span className="badge badge-info">{view.data.status}</span></div>
                <div className="label" style={{ marginTop: 10 }}>Demandeur</div>
                <div>{view.data.requester_name}</div>
                <div className="label" style={{ marginTop: 10 }}>Motif rejet</div>
                <div>{view.data.rejected_reason || <span className="muted">—</span>}</div>
              </div>
            </div>
          ) : (
            <div className="muted">Aucune donnée</div>
          )}
        </Modal>
      )}
    </div>
  );
}


────────────────── client/src/pages/FuelRequests.jsx ──────────────────
import React, { useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

function fmtAr(n) {
  try { return new Intl.NumberFormat('fr-FR').format(Number(n || 0)) + ' Ar'; } catch { return String(n || 0) + ' Ar'; }
}

const TYPES = [
  { value: 'SERVICE', label: 'SERVICE' },
  { value: 'MISSION', label: 'MISSION' }
];

export default function FuelRequests() {
  const { token, user } = useAuth();
  const role = user?.role;

  const [requests, setRequests] = useState([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);

  const [form, setForm] = useState({
    request_type: 'SERVICE',
    objet: '',
    amount_estimated_ar: 0,
    amount_estimated_words: '',
    request_date: new Date().toISOString().slice(0, 10)
  });
  const [creating, setCreating] = useState(false);

  const [view, setView] = useState(null); // {loading, data}
  const [editId, setEditId] = useState(null);
  const [draft, setDraft] = useState(null);

  const canCreate = role === 'DEMANDEUR';
  const canVerify = ['LOGISTIQUE', 'ADMIN'].includes(role);
  const canApprove = ['RAF', 'ADMIN'].includes(role);
  const canSoftDelete = ['LOGISTIQUE', 'ADMIN'].includes(role);

  const columns = useMemo(() => {
    return ['N°', 'Date', 'Type', 'Objet', 'Montant', 'Statut', 'Actions'];
  }, []);

  async function load() {
    setLoading(true);
    setErr(null);
    try {
      const d = await apiFetch('/api/requests/fuel', { token });
      setRequests(d.requests || []);
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
  }, []);

  const create = async () => {
    setCreating(true);
    setErr(null);
    try {
      const body = {
        ...form,
        amount_estimated_ar: Number(form.amount_estimated_ar || 0)
      };
      await apiFetch('/api/requests/fuel', { method: 'POST', token, body });
      setForm({ request_type: 'SERVICE', objet: '', amount_estimated_ar: 0, amount_estimated_words: '', request_date: new Date().toISOString().slice(0, 10) });
      await load();
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setCreating(false);
    }
  };

  const openView = async (id) => {
    setView({ loading: true, data: null });
    try {
      const d = await apiFetch(`/api/requests/fuel/${id}`, { token });
      setView({ loading: false, data: d.request });
    } catch (e) {
      setView({ loading: false, data: null });
      alert(String(e.message || e));
    }
  };

  const openEdit = (r) => {
    setEditId(r.id);
    setDraft({
      request_date: (r.request_date || '').slice(0, 10),
      request_type: r.request_type || 'SERVICE',
      objet: r.objet || '',
      amount_estimated_ar: Number(r.amount_estimated_ar || 0),
      amount_estimated_words: r.amount_estimated_words || ''
    });
  };

  const cancelEdit = () => {
    setEditId(null);
    setDraft(null);
  };

  const saveEdit = async () => {
    if (!editId || !draft) return;
    try {
      const body = {
        request_date: draft.request_date,
        request_type: draft.request_type,
        objet: draft.objet,
        amount_estimated_ar: Number(draft.amount_estimated_ar || 0),
        amount_estimated_words: draft.amount_estimated_words
      };
      await apiFetch(`/api/requests/fuel/${editId}`, { method: 'PUT', token, body });
      cancelEdit();
      await load();
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const softDelete = async (id) => {
    const ok = confirm('Déplacer dans Corbeille ?');
    if (!ok) return;
    try {
      await apiFetch(`/api/requests/fuel/${id}`, { method: 'DELETE', token });
      await load();
      alert('OK ✅ Déplacé dans Corbeille');
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const submit = async (id) => {
    await apiFetch(`/api/requests/fuel/${id}/submit`, { method: 'PATCH', token });
    await load();
  };
  const verify = async (id) => {
    await apiFetch(`/api/requests/fuel/${id}/verify`, { method: 'PATCH', token });
    await load();
  };
  const approve = async (id) => {
    await apiFetch(`/api/requests/fuel/${id}/approve`, { method: 'PATCH', token });
    await load();
  };
  const reject = async (id) => {
    const reason = prompt('Motif de rejet (optionnel) :') || '';
    await apiFetch(`/api/requests/fuel/${id}/reject`, { method: 'PATCH', token, body: { reason } });
    await load();
  };

  return (
    <div>
      <h1 style={{ marginTop: 0 }}>Demande de carburant</h1>

      {canCreate && (
        <div className="card" style={{ marginBottom: 12 }}>
          <div className="row">
            <div className="field" style={{ minWidth: 160 }}>
              <div className="label">Date</div>
              <input
                className="input"
                type="date"
                value={form.request_date}
                onChange={(e) => setForm({ ...form, request_date: e.target.value })}
              />
            </div>
            <div className="field" style={{ minWidth: 160 }}>
              <div className="label">Type</div>
              <select
                className="input"
                value={form.request_type}
                onChange={(e) => setForm({ ...form, request_type: e.target.value })}
              >
                {TYPES.map((t) => (
                  <option key={t.value} value={t.value}>{t.label}</option>
                ))}
              </select>
            </div>
            <div className="field" style={{ flex: 1 }}>
              <div className="label">Objet</div>
              <input
                className="input"
                value={form.objet}
                onChange={(e) => setForm({ ...form, objet: e.target.value })}
                placeholder="Objet..."
              />
            </div>
          </div>
          <div className="row">
            <div className="field" style={{ minWidth: 200 }}>
              <div className="label">Montant prévisionnel (Ar)</div>
              <input
                className="input"
                type="number"
                value={form.amount_estimated_ar}
                onChange={(e) => setForm({ ...form, amount_estimated_ar: e.target.value })}
              />
            </div>
            <div className="field" style={{ flex: 1 }}>
              <div className="label">Montant (en lettre)</div>
              <input
                className="input"
                value={form.amount_estimated_words}
                onChange={(e) => setForm({ ...form, amount_estimated_words: e.target.value })}
                placeholder="..."
              />
            </div>
          </div>
          <div style={{ display: 'flex', justifyContent: 'flex-end' }}>
            <button className="btn" onClick={create} disabled={creating}>Créer (DRAFT)</button>
          </div>
          {err && <div className="muted" style={{ color: '#b91c1c', marginTop: 8 }}>{err}</div>}
        </div>
      )}

      {!canCreate && err && <div className="muted" style={{ color: '#b91c1c' }}>{err}</div>}

      <div style={{ overflow: 'auto' }}>
        <table className="table">
          <thead>
            <tr>
              {columns.map((c) => (<th key={c}>{c}</th>))}
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr><td colSpan={columns.length} className="muted">Chargement...</td></tr>
            ) : requests.length ? (
              requests.map((r) => {
                const isEditing = editId === r.id;
                const canEditRow = (
                  (role === 'DEMANDEUR' && r.status && ['DRAFT','REJECTED'].includes(r.status)) ||
                  (['ADMIN','LOGISTIQUE'].includes(role) && r.status && ['DRAFT','REJECTED','SUBMITTED','VERIFIED'].includes(r.status))
                );

                return (
                  <tr key={r.id}>
                    <td><b>{r.request_no}</b></td>
                    <td>
                      {isEditing ? (
                        <input
                          className="input"
                          type="date"
                          value={draft?.request_date || ''}
                          onChange={(e) => setDraft({ ...draft, request_date: e.target.value })}
                        />
                      ) : (r.request_date ? String(r.request_date).slice(0, 10) : '')}
                    </td>
                    <td>
                      {isEditing ? (
                        <select
                          className="input"
                          value={draft?.request_type || 'SERVICE'}
                          onChange={(e) => setDraft({ ...draft, request_type: e.target.value })}
                        >
                          {TYPES.map((t) => (
                            <option key={t.value} value={t.value}>{t.label}</option>
                          ))}
                        </select>
                      ) : (r.request_type || '')}
                    </td>
                    <td>
                      {isEditing ? (
                        <input
                          className="input"
                          value={draft?.objet || ''}
                          onChange={(e) => setDraft({ ...draft, objet: e.target.value })}
                        />
                      ) : (r.objet || '')}
                    </td>
                    <td>
                      {isEditing ? (
                        <input
                          className="input"
                          type="number"
                          value={draft?.amount_estimated_ar ?? 0}
                          onChange={(e) => setDraft({ ...draft, amount_estimated_ar: e.target.value })}
                        />
                      ) : fmtAr(r.amount_estimated_ar)}
                    </td>
                    <td>
                      <span className={`badge ${r.status === 'APPROVED' ? 'badge-ok' : r.status === 'REJECTED' ? 'badge-bad' : ''}`}>{r.status}</span>
                    </td>
                    <td style={{ whiteSpace: 'nowrap' }}>
                      <button className="btn btn-outline btn-sm" onClick={() => openView(r.id)}>Voir</button>
                      <span style={{ display: 'inline-block', width: 6 }} />

                      {isEditing ? (
                        <>
                          <button className="btn btn-sm" onClick={saveEdit}>Valider</button>
                          <span style={{ display: 'inline-block', width: 6 }} />
                          <button className="btn btn-outline btn-sm" onClick={cancelEdit}>Annuler</button>
                          <span style={{ display: 'inline-block', width: 6 }} />
                        </>
                      ) : (
                        canEditRow && <>
                          <button className="btn btn-outline btn-sm" onClick={() => openEdit(r)}>Modifier</button>
                          <span style={{ display: 'inline-block', width: 6 }} />
                        </>
                      )}

                      {canSoftDelete && (
                        <>
                          <button className="btn btn-danger btn-sm" onClick={() => softDelete(r.id)}>Corbeille</button>
                          <span style={{ display: 'inline-block', width: 6 }} />
                        </>
                      )}

                      <a className="btn btn-outline btn-sm" href={`/print/fuel/${r.id}`} target="_blank" rel="noreferrer">Imprimer</a>

                      {/* Workflow actions */}
                      <span style={{ display: 'inline-block', width: 10 }} />
                      {role === 'DEMANDEUR' && ['DRAFT', 'REJECTED'].includes(r.status) && (
                        <button className="btn btn-sm" onClick={() => submit(r.id)}>Envoyer</button>
                      )}
                      {canVerify && r.status === 'SUBMITTED' && (
                        <button className="btn btn-sm" onClick={() => verify(r.id)}>Vérifier (Logistique)</button>
                      )}
                      {canApprove && r.status === 'VERIFIED' && (
                        <>
                          <button className="btn btn-sm" onClick={() => approve(r.id)}>Visa RAF</button>
                          <span style={{ display: 'inline-block', width: 6 }} />
                          <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Rejeter</button>
                        </>
                      )}
                    </td>
                  </tr>
                );
              })
            ) : (
              <tr><td colSpan={columns.length} className="muted">Aucune demande.</td></tr>
            )}
          </tbody>
        </table>
      </div>

      {view && (
        <Modal title="Détail demande carburant" onClose={() => setView(null)} width={760}>
          {view.loading ? (
            <div className="muted">Chargement...</div>
          ) : view.data ? (
            <div>
              <div className="row" style={{ gap: 14 }}>
                <div className="card" style={{ flex: 1 }}>
                  <div className="muted">N°</div>
                  <div style={{ fontWeight: 800 }}>{view.data.request_no}</div>
                </div>
                <div className="card" style={{ flex: 1 }}>
                  <div className="muted">Statut</div>
                  <div style={{ fontWeight: 800 }}>{view.data.status}</div>
                </div>
              </div>

              <div className="card" style={{ marginTop: 10 }}>
                <div className="row">
                  <div style={{ flex: 1 }}>
                    <div className="muted">Date</div>
                    <div>{String(view.data.request_date || '').slice(0,10)}</div>
                  </div>
                  <div style={{ flex: 1 }}>
                    <div className="muted">Type</div>
                    <div>{view.data.request_type}</div>
                  </div>
                </div>
                <div style={{ marginTop: 8 }}>
                  <div className="muted">Objet</div>
                  <div>{view.data.objet}</div>
                </div>
                <div className="row" style={{ marginTop: 8 }}>
                  <div style={{ flex: 1 }}>
                    <div className="muted">Montant (chiffre)</div>
                    <div>{fmtAr(view.data.amount_estimated_ar)}</div>
                  </div>
                  <div style={{ flex: 1 }}>
                    <div className="muted">Montant (lettre)</div>
                    <div>{view.data.amount_estimated_words || ''}</div>
                  </div>
                </div>
                {view.data.reject_reason && (
                  <div style={{ marginTop: 8 }}>
                    <div className="muted">Motif rejet</div>
                    <div style={{ color: '#b91c1c' }}>{view.data.reject_reason}</div>
                  </div>
                )}
              </div>
            </div>
          ) : (
            <div className="muted">Introuvable.</div>
          )}
        </Modal>
      )}
    </div>
  );
}

────────────────── client/src/pages/Fuel.jsx ──────────────────
import React, { useEffect, useMemo, useState } from 'react';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch, getApiUrl } from '../utils/api.js';
import Modal from '../components/Modal.jsx';

function fmt(v) {
  if (v === null || v === undefined || v === '') return '';
  return String(v);
}

// ✅ Convertit n'importe quel format en "YYYY-MM-DD"
function toYMD(v) {
  if (!v) return '';
  const s = String(v);

  // déjà OK
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // ISO "2023-12-31T21:00:00.000Z" => "2023-12-31"
  if (/^\d{4}-\d{2}-\d{2}T/.test(s)) return s.slice(0, 10);

  // Date object ou string autre => essaye
  const d = new Date(v);
  if (!Number.isNaN(d.getTime())) {
    // ⚠️ On récupère le jour local (ton PC) => OK pour affichage
    // si tu veux absolument Madagascar : ajouter { timeZone: 'Indian/Antananarivo' }
    return d.toLocaleDateString('fr-CA'); // yyyy-mm-dd
  }

  return s;
}

function toMoneyAr(v) {
  const n = Number(v || 0);
  return n.toLocaleString('fr-FR');
}

export default function Fuel() {
  const { token, user } = useAuth();
  const [tab, setTab] = useState('vehicle');
  const [from, setFrom] = useState('');
  const [to, setTo] = useState('');
  const [vehicles, setVehicles] = useState([]);
  const [vehicleId, setVehicleId] = useState('');
  const [logs, setLogs] = useState([]);
  const [error, setError] = useState(null);

  // ========== ÉTAT POUR CRUD ==========
  const [viewModal, setViewModal] = useState(null); // {log}
  const [editModal, setEditModal] = useState(null); // {log, draft}

  const canManage = user && ['LOGISTIQUE', 'ADMIN'].includes(user.role);
  const canExport = canManage;

  useEffect(() => {
    apiFetch('/api/meta/vehicles', { token })
      .then((d) => setVehicles(d.vehicles || []))
      .catch(() => setVehicles([]));
  }, [token]);

  async function load() {
    setError(null);
    const qs = new URLSearchParams();
    if (from) qs.set('from', from);
    if (to) qs.set('to', to);
    if (tab === 'vehicle' && vehicleId) qs.set('vehicle_id', vehicleId);

    try {
      const d = await apiFetch(`/api/fuel/${tab}?${qs.toString()}`, { token });

      // ✅ Normalise log_date directement
      const fixed = (d.logs || []).map((r) => ({
        ...r,
        log_date: toYMD(r.log_date),
      }));

      setLogs(fixed);
    } catch (e) {
      setError(e.message);
      setLogs([]);
    }
  }

  useEffect(() => { load(); }, [tab]); // eslint-disable-line react-hooks/exhaustive-deps

  async function exportCsv() {
    const qs = new URLSearchParams();
    if (from) qs.set('from', from);
    if (to) qs.set('to', to);
    if (tab === 'vehicle' && vehicleId) qs.set('vehicle_id', vehicleId);

    const url = `${getApiUrl()}/api/fuel/export?type=${encodeURIComponent(tab)}&${qs.toString()}`;
    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) {
      const txt = await res.text();
      alert(`Export failed: ${txt}`);
      return;
    }
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `export_${tab}_${from || 'all'}_${to || 'all'}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // ========== VOIR DÉTAILS ==========
  function openView(log) {
    setViewModal({ log: { ...log, log_date: toYMD(log.log_date) } });
  }

  // ========== MODIFIER ==========
  function openEdit(log) {
    const fixedLog = { ...log, log_date: toYMD(log.log_date) };
    setEditModal({ log: fixedLog, draft: { ...fixedLog } });
  }

  async function saveEdit() {
    if (!editModal) return;
    setError(null);
    try {
      const endpoint = `/api/fuel/${tab}/${editModal.log.id}`;
      await apiFetch(endpoint, { token, method: 'PUT', body: editModal.draft });
      setEditModal(null);
      await load();
    } catch (e) {
      setError(e.message);
    }
  }

  // ========== SUPPRIMER (CORBEILLE) ==========
  async function handleDelete(log) {
    if (!confirm(`Supprimer cette ligne ?\n${log.log_date || ''}`)) return;
    setError(null);
    try {
      await apiFetch(`/api/fuel/${tab}/${log.id}`, { token, method: 'DELETE' });
      await load();
      alert('✅ Envoyé dans le corbeille');
    } catch (e) {
      setError(e.message);
    }
  }

  const columns = useMemo(() => {
    if (tab === 'vehicle') {
      return [
        ['log_date', 'Date'],
        ['plate', 'Véhicule'],
        ['day_name', 'Jour'],
        ['km_depart', 'Km départ'],
        ['km_arrivee', 'Km arrivée'],
        ['km_jour', 'Km/j'],
        ['compteur', 'Compteur'],
        ['liters', 'Litres'],
        ['montant_ar', 'Montant (Ar)'],
        ['is_refill', 'Plein'],
        ['chauffeur', 'Chauffeur'],
        ['lien', 'Lien']
      ];
    }
    if (tab === 'generator') {
      return [
        ['log_date', 'Date'],
        ['liters', 'Litres'],
        ['montant_ar', 'Montant (Ar)'],
        ['source_file_name', 'Fichier']
      ];
    }
    return [
      ['log_date', 'Date'],
      ['liters', 'Litres'],
      ['montant_ar', 'Montant (Ar)'],
      ['lien', 'Lien'],
      ['source_file_name', 'Fichier']
    ];
  }, [tab]);

  return (
    <>
      <div className="row" style={{ justifyContent: 'space-between', alignItems: 'center' }}>
        <h2>Suivi carburant</h2>
        <div className="row" style={{ gap: 8 }}>
          <button className={`btn ${tab === 'vehicle' ? '' : 'btn-secondary'}`} onClick={() => setTab('vehicle')}>Véhicules</button>
          <button className={`btn ${tab === 'generator' ? '' : 'btn-secondary'}`} onClick={() => setTab('generator')}>Groupe électrogène</button>
          <button className={`btn ${tab === 'other' ? '' : 'btn-secondary'}`} onClick={() => setTab('other')}>Autres</button>
        </div>
      </div>

      <div className="card" style={{ marginTop: 12 }}>
        <div className="row" style={{ flexWrap: 'wrap' }}>
          <div className="field">
            <label>Du</label>
            <input type="date" value={from} onChange={(e) => setFrom(e.target.value)} />
          </div>
          <div className="field">
            <label>Au</label>
            <input type="date" value={to} onChange={(e) => setTo(e.target.value)} />
          </div>
          {tab === 'vehicle' && (
            <div className="field">
              <label>Véhicule</label>
              <select value={vehicleId} onChange={(e) => setVehicleId(e.target.value)}>
                <option value="">(Tous)</option>
                {vehicles.map((v) => (
                  <option key={v.id} value={v.id}>{v.plate}</option>
                ))}
              </select>
            </div>
          )}
          <div className="row" style={{ alignItems: 'end', gap: 8 }}>
            <button className="btn" onClick={load}>Filtrer</button>
            {canExport && <button className="btn btn-secondary" onClick={exportCsv}>Export CSV</button>}
          </div>
        </div>

        {error && <div className="notice" style={{ marginTop: 12, color: '#b91c1c' }}>{error}</div>}

        <div style={{ overflowX: 'auto', marginTop: 12 }}>
          <table className="table">
            <thead>
              <tr>
                {columns.map((c) => <th key={c[0]}>{c[1]}</th>)}
                {canManage && <th style={{ width: 200 }}>Actions</th>}
              </tr>
            </thead>
            <tbody>
              {logs.map((row, idx) => (
                <tr key={row.id || idx} className={row.is_mission ? 'row-mission' : ''}>
                  {columns.map(([k]) => {
                    const v = row[k];
                    if (k === 'log_date') return <td key={k}>{toYMD(v)}</td>;
                    if (k === 'montant_ar') return <td key={k}>{toMoneyAr(v)}</td>;
                    if (k === 'is_refill') return <td key={k}>{row.is_refill ? 'Oui' : 'Non'}</td>;
                    if (k === 'lien' && v) return <td key={k}><a href={v} target="_blank" rel="noreferrer">Lien</a></td>;
                    return <td key={k}>{fmt(v)}</td>;
                  })}
                  {canManage && (
                    <td style={{ whiteSpace: 'nowrap' }}>
                      <button className="btn btn-outline btn-sm" onClick={() => openView(row)}>Voir</button>
                      <span style={{ display: 'inline-block', width: 6 }} />
                      <button className="btn btn-secondary btn-sm" onClick={() => openEdit(row)}>Modifier</button>
                      <span style={{ display: 'inline-block', width: 6 }} />
                      <button className="btn btn-danger btn-sm" onClick={() => handleDelete(row)}>Mettre dans le corbeille</button>
                    </td>
                  )}
                </tr>
              ))}
              {!logs.length && <tr><td colSpan={columns.length + (canManage ? 1 : 0)} style={{ padding: 16, color: '#6b7280' }}>Aucune donnée</td></tr>}
            </tbody>
          </table>
        </div>
      </div>

      {/* ========== MODAL VOIR DÉTAILS ========== */}
      {viewModal && (
        <Modal title="Détails" onClose={() => setViewModal(null)} width={700}>
          <div className="grid2">
            {columns.map(([key, label]) => (
              <div key={key} className="field">
                <div className="label">{label}</div>
                <div style={{ fontWeight: 600 }}>
                  {key === 'log_date' ? toYMD(viewModal.log[key]) :
                   key === 'montant_ar' ? toMoneyAr(viewModal.log[key]) :
                   key === 'is_refill' ? (viewModal.log[key] ? 'Oui' : 'Non') :
                   fmt(viewModal.log[key])}
                </div>
              </div>
            ))}
          </div>
        </Modal>
      )}

      {/* ========== MODAL MODIFIER ========== */}
      {editModal && (
        <Modal title="Modifier" onClose={() => setEditModal(null)} width={700}>
          <div className="grid2">
            {tab === 'vehicle' && (
              <>
                <div className="field">
                  <label>Date</label>
                  <input
                    type="date"
                    value={toYMD(editModal.draft.log_date) || ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, log_date: e.target.value } })}
                  />
                </div>
                <div className="field">
                  <label>Km départ</label>
                  <input
                    type="number"
                    value={editModal.draft.km_depart ?? ''}
                    onChange={(e) => {
                      const val = e.target.value === '' ? null : Number(e.target.value);
                      const draft = { ...editModal.draft, km_depart: val };
                      if (draft.km_arrivee !== null && val !== null) {
                        draft.km_jour = draft.km_arrivee - val;
                      }
                      setEditModal({ ...editModal, draft });
                    }}
                  />
                </div>
                <div className="field">
                  <label>Km arrivée</label>
                  <input
                    type="number"
                    value={editModal.draft.km_arrivee ?? ''}
                    onChange={(e) => {
                      const val = e.target.value === '' ? null : Number(e.target.value);
                      const draft = { ...editModal.draft, km_arrivee: val };
                      if (draft.km_depart !== null && val !== null) {
                        draft.km_jour = val - draft.km_depart;
                      }
                      setEditModal({ ...editModal, draft });
                    }}
                  />
                </div>
                <div className="field">
                  <label>Km/j (calculé auto)</label>
                  <input
                    type="number"
                    value={editModal.draft.km_jour ?? ''}
                    disabled
                    style={{ background: '#f3f4f6', cursor: 'not-allowed' }}
                  />
                </div>
                <div className="field">
                  <label>Compteur</label>
                  <input
                    type="number"
                    value={editModal.draft.compteur ?? ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, compteur: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Litres</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editModal.draft.liters ?? ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, liters: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Montant (Ar)</label>
                  <input
                    type="number"
                    value={editModal.draft.montant_ar ?? ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, montant_ar: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Chauffeur</label>
                  <input
                    value={editModal.draft.chauffeur || ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, chauffeur: e.target.value } })}
                  />
                </div>
                <div className="field">
                  <label>Lien</label>
                  <input
                    value={editModal.draft.lien || ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, lien: e.target.value } })}
                  />
                </div>
              </>
            )}

            {tab === 'generator' && (
              <>
                <div className="field">
                  <label>Date</label>
                  <input
                    type="date"
                    value={toYMD(editModal.draft.log_date) || ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, log_date: e.target.value } })}
                  />
                </div>
                <div className="field">
                  <label>Litres</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editModal.draft.liters ?? ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, liters: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Montant (Ar)</label>
                  <input
                    type="number"
                    value={editModal.draft.montant_ar ?? ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, montant_ar: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
              </>
            )}

            {tab === 'other' && (
              <>
                <div className="field">
                  <label>Date</label>
                  <input
                    type="date"
                    value={toYMD(editModal.draft.log_date) || ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, log_date: e.target.value } })}
                  />
                </div>
                <div className="field">
                  <label>Litres</label>
                  <input
                    type="number"
                    step="0.01"
                    value={editModal.draft.liters ?? ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, liters: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Montant (Ar)</label>
                  <input
                    type="number"
                    value={editModal.draft.montant_ar ?? ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, montant_ar: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Lien</label>
                  <input
                    value={editModal.draft.lien || ''}
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, lien: e.target.value } })}
                  />
                </div>
              </>
            )}
          </div>

          <div className="row" style={{ justifyContent: 'flex-end', marginTop: 16, gap: 8 }}>
            <button className="btn btn-outline" onClick={() => setEditModal(null)}>Annuler</button>
            <button className="btn" onClick={saveEdit}>Enregistrer</button>
          </div>
        </Modal>
      )}
    </>
  );
}


────────────────── client/src/pages/Forgot.jsx ──────────────────
import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import { apiFetch } from '../utils/api.js';

export default function Forgot() {
  const [email, setEmail] = useState('');
  const [sent, setSent] = useState(false);
  const [error, setError] = useState(null);

  async function onSubmit(e) {
    e.preventDefault();
    setError(null);
    try {
      await apiFetch('/api/auth/forgot', { method: 'POST', body: { email } });
      setSent(true);
    } catch (e2) {
      setError(e2.message);
    }
  }

  return (
    <div className="container" style={{ maxWidth: 520 }}>
      <div className="card">
        <h2>Mot de passe oublié</h2>
        {sent ? (
          <p className="muted">
            Si l’adresse existe, un lien de réinitialisation a été envoyé.
            (Si SMTP n’est pas configuré, le lien s’affiche dans la console du serveur.)
          </p>
        ) : (
          <form onSubmit={onSubmit} className="form">
            <label className="label">Email</label>
            <input className="input" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="ex: nom@prirtem.mg" />
            {error && <div className="error">{error}</div>}
            <button className="btn" type="submit">Envoyer</button>
          </form>
        )}
        <div style={{ marginTop: 10 }}>
          <Link to="/login">Retour</Link>
        </div>
      </div>
    </div>
  );
}


────────────────── client/index.html ──────────────────
<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>P</text></svg>">
    <title>PRIRTEM - Carburant & Flotte</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  </body>
</html>


────────────────── client/Dockerfile.dev ──────────────────
FROM node:20-alpine
WORKDIR /app
RUN apk add --no-cache bash

COPY package*.json ./
RUN npm install

COPY . .
EXPOSE 5173

CMD ["npm","run","dev","--","--host","0.0.0.0","--port","5173"]


────────────────── README.md ──────────────────
# PRIRTEM - Carburant & Flotte (V1)

Stack: **React/Vite (.jsx)** + **Node/Express (.js)** + **PostgreSQL**

## ✅ Ce que couvre cette V1
- Auth: Login / Register / Forgot / Reset (JWT)
- Rôles: **DEMANDEUR / LOGISTIQUE / RAF / ADMIN**
- Import Excel intelligent (admin/logistique):
  - `Suivi carburant ...` (véhicules)
  - `Groupe electrogène...`
  - `Autres carburants utilisés...`
- Suivi carburant + filtres + export CSV (logistique/admin)
- Tableaux de bord (KPI)
- Demande de carburant: workflow Demandeur → Logistique → RAF
- Demande de voiture + Autorisation sortie: workflow Demandeur → Logistique → RAF
- Journal de bord voiture (rempli par Logistique depuis les infos Chauffeur):
  - Lignes trajets + **LIGNE SPÉCIALE MISSION**
  - Approvisionnement carburant
  - **LOGISTIQUE_LOCK**: une fois verrouillé, plus de modification

> **service/mission km**: saisi à la main (pas de calcul auto), comme tu as dit.

---

## 1) Démarrage en local (DEV)

### Pré-requis
- Node.js 18+ (recommandé 20)
- PostgreSQL 14+

### A. Backend
```bash
cd server
cp .env.example .env
npm install
npm run db:reset
npm run dev
```

⚠️ Si tu as déjà des données importées et tu ne veux pas les perdre:
```bash
npm run db:seed
```
Backend: http://localhost:3001

**Comptes seed (après db:reset):**
- Admin: `admin` / `admin123`
- Logistique: `logistique` / `logistique123`
- RAF: `raf` / `raf123`
- Demandeur: `demandeur` / `demandeur123`

### B. Frontend
```bash
cd client
cp .env.example .env
npm install
npm run dev
```
Frontend: http://localhost:5173

---

## 2) Docker (mode DEV séparé: client + API + DB)
```bash
docker compose up --build
```

- Frontend (Vite): http://localhost:5173
- API: http://localhost:3001
- Postgres: localhost:5432 (user/pass: postgres/postgres, db: prirtem_fuel)

> Le premier lancement fait un `db:reset` automatiquement si la DB est vide.

### Docker (mode PROD, optionnel)
```bash
docker compose -f docker-compose.prod.yml up --build
```
App (prod): http://localhost:3001

---

## 3) Import Excel (admin/logistique)
Menu **Import Excel** → sélectionner plusieurs `.xlsx` → importer.

Détection:
- Nom de fichier contient `Suivi carburant` → type VEHICLE
- contient `Groupe` / `electrogène` → GENERATOR
- contient `Autres carburants` → OTHER

Pour les fichiers véhicules:
- gestion des en-têtes fusionnés (Kilométrage Départ/Arrivée, Plein Compteur/Litre/Montant)
- lignes "MISSION" (fusion/vert) → stockées comme **is_mission=true**
- montants < 200000 Ar → **is_refill=false** (non-replein)

---

## 4) Notes métier importantes
- Ariary stocké en **INTEGER**.
- Aucune “correction” automatique destructive sur les Excel: **on migre tout**, et on calcule/filtre côté app.
- Les samedis/dimanches peuvent être vides: normal.

---

## 5) Arborescence
- `server/` API + DB
- `client/` UI React
- `docker-compose.yml` + `server/Dockerfile.dev` + `client/Dockerfile.dev` pour DEV
- `docker-compose.prod.yml` + `Dockerfile` pour PROD



────────────────── Dockerfile ──────────────────
# Build client
FROM node:20-alpine AS client
WORKDIR /work/client
COPY client/package.json client/package-lock.json* ./
RUN npm install
COPY client ./
RUN npm run build

# Build server
FROM node:20-alpine
WORKDIR /work/server
COPY server/package.json server/package-lock.json* ./
RUN npm install
COPY server ./

# Copy built client into server public
COPY --from=client /work/client/dist ./public

ENV NODE_ENV=production
EXPOSE 3001
CMD ["node", "src/index.js"]


────────────────── docker-compose.yml ──────────────────
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: prirtem_fuel
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d prirtem_fuel"]
      interval: 5s
      timeout: 3s
      retries: 10

  server:
    image: prirtem-fuel-server-dev
    build:
      context: ./server
      dockerfile: Dockerfile.dev
    environment:
      PORT: 3001
      NODE_ENV: development
      DATABASE_URL: postgres://postgres:postgres@db:5432/prirtem_fuel
      JWT_SECRET: change_me_super_secret
      APP_URL: http://localhost:5173
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "3001:3001"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./server:/app
      - server_node_modules:/app/node_modules
    command: sh -c "npm install && node src/sql/initIfNeeded.js && npm run dev"

  client:
    image: prirtem-fuel-client-dev
    build:
      context: ./client
      dockerfile: Dockerfile.dev
    environment:
      VITE_API_URL: http://localhost:3001
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "5173:5173"
    depends_on:
      - server
    volumes:
      - ./client:/app
      - client_node_modules:/app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"

volumes:
  pgdata:
  server_node_modules:
  client_node_modules:


────────────────── docker-compose.prod.yml ──────────────────
services:
  db:
    image: postgres:16
    container_name: prirtem_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: prirtem_fuel
    ports:
      - "5432:5432"
    volumes:
      - prirtem_db_data:/var/lib/postgresql/data

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: prirtem_app
    environment:
      PORT: 3001
      DATABASE_URL: postgres://postgres:postgres@db:5432/prirtem_fuel
      JWT_SECRET: change_me_super_secret
      APP_URL: http://localhost:3001
    ports:
      - "3001:3001"
    depends_on:
      - db

volumes:
  prirtem_db_data:
