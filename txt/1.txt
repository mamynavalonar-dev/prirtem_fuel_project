prirtem-fuel-webapp-docker-final-fix5 ty no IZY/
â”œâ”€ client/
â”‚  â”œâ”€ src/
â”‚  â”‚  â”œâ”€ auth/
â”‚  â”‚  â”‚  â””â”€ AuthContext.jsx
â”‚  â”‚  â”œâ”€ components/
â”‚  â”‚  â”‚  â”œâ”€ Layout.jsx
â”‚  â”‚  â”‚  â”œâ”€ Modal.jsx
â”‚  â”‚  â”‚  â”œâ”€ NotificationBell.jsx
â”‚  â”‚  â”‚  â”œâ”€ ProtectedRoute.jsx
â”‚  â”‚  â”‚  â””â”€ ToastContext.jsx
â”‚  â”‚  â”œâ”€ pages/
â”‚  â”‚  â”‚  â”œâ”€ CalendarView.jsx
â”‚  â”‚  â”‚  â”œâ”€ CarRequests.jsx
â”‚  â”‚  â”‚  â”œâ”€ CarRequestsManage.jsx
â”‚  â”‚  â”‚  â”œâ”€ Dashboard.jsx
â”‚  â”‚  â”‚  â”œâ”€ Forgot.jsx
â”‚  â”‚  â”‚  â”œâ”€ Fuel.jsx
â”‚  â”‚  â”‚  â”œâ”€ FuelRequests.jsx
â”‚  â”‚  â”‚  â”œâ”€ FuelRequestsManage.jsx
â”‚  â”‚  â”‚  â”œâ”€ FuelRequestsRaf.jsx
â”‚  â”‚  â”‚  â”œâ”€ ImportExcel.jsx
â”‚  â”‚  â”‚  â”œâ”€ LogbookEdit.jsx
â”‚  â”‚  â”‚  â”œâ”€ Logbooks.jsx
â”‚  â”‚  â”‚  â”œâ”€ Login.jsx
â”‚  â”‚  â”‚  â”œâ”€ Meta.jsx
â”‚  â”‚  â”‚  â”œâ”€ PrintCarRequest.jsx
â”‚  â”‚  â”‚  â”œâ”€ PrintFuelRequest.jsx
â”‚  â”‚  â”‚  â”œâ”€ PrintLogbook.jsx
â”‚  â”‚  â”‚  â”œâ”€ Register.jsx
â”‚  â”‚  â”‚  â”œâ”€ Reset.jsx
â”‚  â”‚  â”‚  â””â”€ Trash.jsx
â”‚  â”‚  â”œâ”€ utils/
â”‚  â”‚  â”‚  â””â”€ api.js
â”‚  â”‚  â”œâ”€ App.jsx
â”‚  â”‚  â”œâ”€ main.jsx
â”‚  â”‚  â””â”€ styles.css
â”‚  â”œâ”€ Dockerfile.dev
â”‚  â”œâ”€ index.html
â”‚  â”œâ”€ package-lock.json
â”‚  â”œâ”€ package.json
â”‚  â””â”€ vite.config.js
â”œâ”€ server/
â”‚  â”œâ”€ src/
â”‚  â”‚  â”œâ”€ controllers/
â”‚  â”‚  â”‚  â”œâ”€ authController.js
â”‚  â”‚  â”‚  â”œâ”€ carRequestsController.js
â”‚  â”‚  â”‚  â”œâ”€ fuelController.js
â”‚  â”‚  â”‚  â”œâ”€ fuelRequestsController.js
â”‚  â”‚  â”‚  â”œâ”€ importController.js
â”‚  â”‚  â”‚  â”œâ”€ logbooksController.js
â”‚  â”‚  â”‚  â”œâ”€ metaController.js
â”‚  â”‚  â”‚  â”œâ”€ notificationsController.js
â”‚  â”‚  â”‚  â””â”€ trashController.js
â”‚  â”‚  â”œâ”€ middleware/
â”‚  â”‚  â”‚  â””â”€ auth.js
â”‚  â”‚  â”œâ”€ routes/
â”‚  â”‚  â”‚  â”œâ”€ auth.js
â”‚  â”‚  â”‚  â”œâ”€ carRequests.js
â”‚  â”‚  â”‚  â”œâ”€ fuel.js
â”‚  â”‚  â”‚  â”œâ”€ fuelRequests.js
â”‚  â”‚  â”‚  â”œâ”€ import.js
â”‚  â”‚  â”‚  â”œâ”€ logbooks.js
â”‚  â”‚  â”‚  â”œâ”€ meta.js
â”‚  â”‚  â”‚  â”œâ”€ notifications.js
â”‚  â”‚  â”‚  â””â”€ trash.js
â”‚  â”‚  â”œâ”€ sql/
â”‚  â”‚  â”‚  â”œâ”€ initIfNeeded.js
â”‚  â”‚  â”‚  â”œâ”€ reset.js
â”‚  â”‚  â”‚  â”œâ”€ schema.sql
â”‚  â”‚  â”‚  â””â”€ seed.js
â”‚  â”‚  â”œâ”€ utils/
â”‚  â”‚  â”‚  â”œâ”€ excel/
â”‚  â”‚  â”‚  â”‚  â”œâ”€ detectType.js
â”‚  â”‚  â”‚  â”‚  â”œâ”€ parseGenerator.js
â”‚  â”‚  â”‚  â”‚  â”œâ”€ parseOther.js
â”‚  â”‚  â”‚  â”‚  â”œâ”€ parseUtils.js
â”‚  â”‚  â”‚  â”‚  â””â”€ parseVehicleFuel.js
â”‚  â”‚  â”‚  â”œâ”€ asyncHandler.js
â”‚  â”‚  â”‚  â””â”€ mailer.js
â”‚  â”‚  â”œâ”€ db.js
â”‚  â”‚  â””â”€ index.js
â”‚  â”œâ”€ Dockerfile.dev
â”‚  â”œâ”€ package-lock.json
â”‚  â””â”€ package.json
â”œâ”€ Dockerfile
â”œâ”€ README.md
â”œâ”€ docker-compose.prod.yml
â””â”€ docker-compose.yml


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/utils/mailer.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/utils/mailer.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * CORRECTIF APPLIQUÃ‰ : URL dynamique via env et meilleure gestion des logs.
 */
const nodemailer = require('nodemailer');

async function sendResetEmail(to, tokenPlain) {
  // Utilise APP_CLIENT_URL s'il est dÃ©fini, sinon fallback local
  const appUrl = process.env.APP_CLIENT_URL || 'http://localhost:5173';
  const resetLink = `${appUrl}/reset?email=${encodeURIComponent(to)}&token=${encodeURIComponent(tokenPlain)}`;

  const host = process.env.SMTP_HOST;
  const port = process.env.SMTP_PORT;
  const user = process.env.SMTP_USER;
  const pass = process.env.SMTP_PASS;
  const from = process.env.SMTP_FROM || 'no-reply@prirtem.local';

  // Si SMTP non configurÃ©, log en console (Mode DEV)
  if (!host || !port || !user || !pass) {
    console.log('âš ï¸ [MAIL MOCK] SMTP non configurÃ©.');
    console.log(`ğŸ“¨ Ã€: ${to}`);
    console.log(`ğŸ”— Lien: ${resetLink}`);
    return;
  }

  try {
    const transporter = nodemailer.createTransport({
      host,
      port: Number(port),
      secure: Number(port) === 465, // true pour 465, false pour les autres
      auth: { user, pass }
    });

    await transporter.sendMail({
      from,
      to,
      subject: 'PRIRTEM - RÃ©initialisation mot de passe',
      text: `Bonjour,\n\nVous avez demandÃ© la rÃ©initialisation de votre mot de passe.\nCliquez sur ce lien pour continuer : ${resetLink}\n\nCe lien est valide 30 minutes.`,
      html: `<p>Bonjour,</p><p>Vous avez demandÃ© la rÃ©initialisation de votre mot de passe.</p><p><a href="${resetLink}">Cliquez ici pour rÃ©initialiser votre mot de passe</a></p><p><i>Ce lien est valide 30 minutes.</i></p>`
    });
    console.log(`âœ… Email envoyÃ© Ã  ${to}`);
  } catch (error) {
    console.error('âŒ Erreur envoi email:', error);
    // On ne throw pas forcÃ©ment l'erreur pour ne pas bloquer le front, mais on loggue
  }
}

module.exports = { sendResetEmail };

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/utils/asyncHandler.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
module.exports = function asyncHandler(fn) {
  return (req, res, next) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/utils/excel/parseVehicleFuel.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { norm, toInt, toFloat, parseDate, sheetTo2D } = require('./parseUtils');

function extractPlateFromFileName(name) {
  const m = String(name || '').toUpperCase().match(/(\d{5}\s*WWT)/);
  if (m) return m[1].replace(/\s+/g, '');
  return null;
}

function extractPlateFromGrid(grid) {
  for (let r = 0; r < Math.min(grid.length, 12); r++) {
    for (let c = 0; c < Math.min((grid[r] || []).length, 12); c++) {
      const v = grid[r][c];
      const s = String(v || '').toUpperCase();
      const m = s.match(/(\d{5}WWT)/);
      if (m) return m[1];
    }
  }
  return null;
}

function findHeaderRow(grid) {
  for (let r = 0; r < Math.min(grid.length, 60); r++) {
    const row = (grid[r] || []).map(norm);
    const hasDate = row.some(x => x === 'date');
    const hasKm = row.some(x => x.includes('kilometrage'));
    const hasKmJour = row.some(x => x.includes('kmjourn') || (x.includes('km') && x.includes('journal')));
    if (hasDate && hasKm && hasKmJour) return r;
  }
  return -1;
}

function indexOfHeader(rowNorm, predicate) {
  for (let i = 0; i < rowNorm.length; i++) {
    if (predicate(rowNorm[i])) return i;
  }
  return -1;
}

function isMissionRow(row) {
  return row.some(v => norm(v) === 'mission');
}

// âœ… safe get cell
function getCell(row, idx) {
  if (!row || idx === null || idx === undefined || idx < 0) return null;
  return row[idx];
}

function parseSheet(sheetName, grid, fileName) {
  const headerRow = findHeaderRow(grid);
  if (headerRow < 0) return [];

  const h1 = (grid[headerRow] || []).map(norm);
  const h2 = (grid[headerRow + 1] || []).map(norm);
  const hasSub = h2.some(v => v === 'depart') && h2.some(v => v === 'arrivee');

  const dateCol = indexOfHeader(h1, v => v === 'date');
  const kmGroupCol = indexOfHeader(h1, v => v.includes('kilometrage'));
  const kmJourCol = indexOfHeader(h1, v => v.includes('kmjourn') || (v.includes('km') && v.includes('journal')));
  const kmBetweenCol = indexOfHeader(h1, v => v.includes('entre') && v.includes('replein'));
  const consoCol = indexOfHeader(h1, v => v.includes('consomm'));
  const intervalCol = indexOfHeader(h1, v => v.includes('jours') && v.includes('interval'));
  const pleinGroupCol = indexOfHeader(h1, v => v === 'plein');
  const lienCol = indexOfHeader(h1, v => v === 'lien');
  const chauffeurCol = indexOfHeader(h1, v => v === 'chauffeur');
  const frnsCol = indexOfHeader(h1, v => v === 'frns' || v.includes('frns'));

  let kmDepartCol = -1;
  let kmArriveeCol = -1;
  let compteurCol = -1;
  let litreCol = -1;
  let montantCol = -1;

  if (hasSub) {
    kmDepartCol = indexOfHeader(h2, v => v === 'depart');
    kmArriveeCol = indexOfHeader(h2, v => v === 'arrivee');
    compteurCol = indexOfHeader(h2, v => v === 'compteur');
    litreCol = indexOfHeader(h2, v => v === 'litre' || v === 'litres');
    montantCol = indexOfHeader(h2, v => v.includes('montant'));
  } else {
    // common layout where km depart/arrivee are right after the KilomÃ©trage merged cell
    if (kmGroupCol >= 0) {
      kmDepartCol = kmGroupCol;
      kmArriveeCol = kmGroupCol + 1;
    }
    // plein group: 3 columns after 'Plein'
    if (pleinGroupCol >= 0) {
      compteurCol = pleinGroupCol;
      litreCol = pleinGroupCol + 1;
      montantCol = pleinGroupCol + 2;
    }
  }

  // âœ… Guard colonnes critiques : stop avant d'aller lire row[-1]
  const must = [
    ['dateCol', dateCol],
    ['kmDepartCol', kmDepartCol],
    ['kmArriveeCol', kmArriveeCol],
    ['compteurCol', compteurCol],
    ['litreCol', litreCol],
    ['montantCol', montantCol],
  ];
  const missing = must.filter(([_, idx]) => idx === -1).map(([name]) => name);
  if (missing.length) {
    throw new Error(`MISSING_COLUMNS:${missing.join(',')}:sheet=${sheetName}`);
  }

  const startRow = headerRow + (hasSub ? 2 : 1);
  const out = [];
  let emptyStreak = 0;

  for (let r = startRow; r < grid.length; r++) {
    const row = grid[r] || [];
    const hasAny = row.some(v => v !== null && v !== undefined && String(v).trim() !== '');
    if (!hasAny) {
      emptyStreak += 1;
      if (emptyStreak >= 15) break;
      continue;
    }
    emptyStreak = 0;

    if (isMissionRow(row)) {
      const label = row
        .filter(v => typeof v === 'string' && norm(v) !== 'mission')
        .join(' ')
        .trim() || null;

      out.push({
        sheet_name: sheetName,
        source_file_name: fileName,
        row_in_sheet: r + 1,
        is_mission: true,
        mission_label: label
      });
      continue;
    }

    const log_date = parseDate(getCell(row, dateCol));
    const day_name = typeof getCell(row, 0) === 'string' ? String(getCell(row, 0)).trim() : null;
    const day_no = toInt(getCell(row, 1));

    const km_depart = toInt(getCell(row, kmDepartCol));
    const km_arrivee = toInt(getCell(row, kmArriveeCol));
    const km_jour = toInt(getCell(row, kmJourCol));
    const km_between_refill = toInt(getCell(row, kmBetweenCol));
    const consumption = toFloat(getCell(row, consoCol));
    const interval_days = toInt(getCell(row, intervalCol));

    const compteur = toInt(getCell(row, compteurCol));
    const liters = toFloat(getCell(row, litreCol));
    const montant_ar = toInt(getCell(row, montantCol));

    const lien = lienCol >= 0 ? (getCell(row, lienCol) ? String(getCell(row, lienCol)).trim() : null) : null;
    const chauffeur = chauffeurCol >= 0 ? (getCell(row, chauffeurCol) ? String(getCell(row, chauffeurCol)).trim() : null) : null;
    const frns = frnsCol >= 0 ? (getCell(row, frnsCol) ? String(getCell(row, frnsCol)).trim() : null) : null;

    // skip weird rows without date and without km values
    if (!log_date && km_depart === null && km_arrivee === null && km_jour === null && montant_ar === null && liters === null) {
      continue;
    }

    const is_refill = montant_ar !== null && montant_ar >= 200000;

    out.push({
      sheet_name: sheetName,
      source_file_name: fileName,
      row_in_sheet: r + 1,
      log_date,
      day_name,
      day_no,
      km_depart,
      km_arrivee,
      km_jour,
      km_between_refill,
      consumption,
      interval_days,
      compteur,
      liters,
      montant_ar,
      lien,
      chauffeur,
      frns,
      is_refill,
      is_mission: false,
      mission_label: null
    });
  }

  return out;
}

function parseVehicleFuelWorkbook(workbook, originalName) {
  const fileName = originalName || 'upload.xlsx';
  const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
  const grid0 = sheetTo2D(firstSheet);
  const plate = extractPlateFromFileName(fileName) || extractPlateFromGrid(grid0) || null;

  const records = [];
  for (const sheetName of workbook.SheetNames) {
    const sheet = workbook.Sheets[sheetName];
    const grid = sheetTo2D(sheet);
    const recs = parseSheet(sheetName, grid, fileName);
    records.push(...recs);
  }

  return { plate, records };
}

module.exports = { parseVehicleFuelWorkbook };


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/utils/excel/parseUtils.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const XLSX = require('xlsx');

function norm(s) {
  return String(s ?? '')
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/\p{Diacritic}/gu, '');
}

function parseNumber(v) {
  if (v === null || v === undefined || v === '') return null;

  // âœ… IMPORTANT: une Date ne doit JAMAIS devenir un nombre (timestamp ms)
  // sinon Ã§a finit en 1738529964000 et Ã§a casse l'insert int4.
  if (v instanceof Date) return null;

  if (typeof v === 'number') {
    if (!Number.isFinite(v)) return null;
    return v;
  }

  const s = String(v).trim();
  if (!s) return null;

  // remove non-breaking spaces, thin spaces
  const cleaned = s
    .replace(/\u00a0/g, ' ')
    .replace(/\s+/g, ' ')
    .replace(/ /g, '')
    .replace(/,/g, '.');

  const n = Number(cleaned);
  if (!Number.isFinite(n)) return null;
  return n;
}

function toInt(v) {
  const n = parseNumber(v);
  if (n === null) return null;
  const i = Math.trunc(n);

  // âœ… sÃ©curitÃ© PostgreSQL int4
  if (i > 2147483647 || i < -2147483648) return null;

  return i;
}

function toFloat(v) {
  const n = parseNumber(v);
  if (n === null) return null;
  return Number(n);
}

function excelDateToJS(excelSerial) {
  // Excel 1900 system
  const d = XLSX.SSF.parse_date_code(excelSerial);
  if (!d) return null;
  // months are 1-based
  return new Date(Date.UTC(d.y, d.m - 1, d.d));
}

// âœ… vrai check calendrier
function isValidYMD(yyyy, mm, dd) {
  const y = Number(yyyy), m = Number(mm), d = Number(dd);
  if (!y || m < 1 || m > 12 || d < 1 || d > 31) return false;
  const dt = new Date(Date.UTC(y, m - 1, d));
  return (
    dt.getUTCFullYear() === y &&
    (dt.getUTCMonth() + 1) === m &&
    dt.getUTCDate() === d
  );
}

function parseDate(v) {
  if (v === null || v === undefined || v === '') return null;

  if (v instanceof Date) {
    const yyyy = v.getFullYear();
    const mm = String(v.getMonth() + 1).padStart(2, '0');
    const dd = String(v.getDate()).padStart(2, '0');
    if (!isValidYMD(yyyy, mm, dd)) return null;
    return `${yyyy}-${mm}-${dd}`;
  }

  if (typeof v === 'number') {
    const d = excelDateToJS(v);
    if (!d) return null;
    const yyyy = d.getUTCFullYear();
    const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
    const dd = String(d.getUTCDate()).padStart(2, '0');
    if (!isValidYMD(yyyy, mm, dd)) return null;
    return `${yyyy}-${mm}-${dd}`;
  }

  const s = String(v).trim();
  if (!s) return null;

  // dd/mm/yyyy
  const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) {
    const dd = String(m[1]).padStart(2, '0');
    const mm = String(m[2]).padStart(2, '0');
    const yyyy = m[3];
    if (!isValidYMD(yyyy, mm, dd)) return null;
    return `${yyyy}-${mm}-${dd}`;
  }

  // yyyy-mm-dd
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m2) {
    const [_, yyyy, mm, dd] = m2;
    if (!isValidYMD(yyyy, mm, dd)) return null;
    return s;
  }

  return null;
}

function sheetTo2D(sheet) {
  return XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null, raw: true });
}

module.exports = { norm, parseNumber, toInt, toFloat, parseDate, sheetTo2D, excelDateToJS, isValidYMD };


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/utils/excel/parseOther.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { parseDate, toFloat, toInt, sheetTo2D, norm } = require('./parseUtils');

function parseOtherWorkbook(workbook, originalName) {
  const fileName = originalName || 'other.xlsx';
  const out = [];

  for (const sheetName of workbook.SheetNames) {
    const sheet = workbook.Sheets[sheetName];
    const grid = sheetTo2D(sheet);

    // header row typically: Date | Litre | Montant | Lien
    let hRow = -1;
    for (let r=0;r<Math.min(grid.length,25);r++) {
      const row = (grid[r]||[]).map(norm);
      if (row.includes('date') && row.some(v=>v.includes('litre')) && row.some(v=>v.includes('montant'))) { hRow=r; break; }
    }
    if (hRow < 0) continue;

    const headers = (grid[hRow] || []).map(norm);
    const dateCol = headers.indexOf('date');
    const litreCol = headers.findIndex(v => v.includes('litre'));
    const montantCol = headers.findIndex(v => v.includes('montant'));
    const lienCol = headers.findIndex(v => v === 'lien');

    for (let r = hRow + 1; r < grid.length; r++) {
      const row = grid[r] || [];
      const log_date = parseDate(row[dateCol]);
      const liters = toFloat(row[litreCol]);
      const montant_ar = toInt(row[montantCol]);
      const lien = lienCol >= 0 && row[lienCol] ? String(row[lienCol]).trim() : null;

      if (!log_date && liters === null && montant_ar === null && !lien) continue;
      if (!log_date) continue;
      out.push({
        log_date,
        liters,
        montant_ar,
        lien,
        source_file_name: fileName,
        sheet_name: sheetName,
        row_in_sheet: r + 1
      });
    }
  }

  return { records: out };
}

module.exports = { parseOtherWorkbook };


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/utils/excel/parseGenerator.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { parseDate, toFloat, toInt, sheetTo2D, norm } = require('./parseUtils');

function parseGeneratorWorkbook(workbook, originalName) {
  const fileName = originalName || 'generator.xlsx';
  const sheetName = workbook.SheetNames[0];
  const sheet = workbook.Sheets[sheetName];
  const grid = sheetTo2D(sheet);

  // Trouver la ligne d'en-tÃªte "Groupe Ã©lectrogÃ¨ne"
  let titleRow = -1;
  for (let r = 0; r < Math.min(grid.length, 15); r++) {
    const row = (grid[r] || []).map(v => norm(v));
    if (row.some(v => v.includes('groupe') && v.includes('electrogene'))) {
      titleRow = r;
      break;
    }
  }

  if (titleRow < 0) {
    console.log('[GENERATOR] Titre "Groupe Ã©lectrogÃ¨ne" non trouvÃ©, recherche headers classiques...');
    // Fallback: recherche headers classiques
    for (let r = 0; r < Math.min(grid.length, 20); r++) {
      const row = (grid[r] || []).map(norm);
      if (row.includes('date') && row.some(v => v.includes('litre')) && row.some(v => v.includes('montant'))) {
        titleRow = r - 1; // Assume title is row before
        break;
      }
    }
  }

  if (titleRow < 0) return { records: [] };

  // La ligne des headers est juste aprÃ¨s le titre
  const hRow = titleRow + 1;
  if (hRow >= grid.length) return { records: [] };

  const headers = (grid[hRow] || []).map(norm);
  
  // Colonnes: Date, Litres, Montant, Lien
  const dateCol = headers.findIndex(v => v === 'date');
  const litreCol = headers.findIndex(v => v.includes('litre'));
  const montantCol = headers.findIndex(v => v.includes('montant'));
  const lienCol = headers.findIndex(v => v === 'lien');

  if (dateCol < 0 || litreCol < 0 || montantCol < 0) {
    console.error('[GENERATOR] Colonnes essentielles manquantes:', { dateCol, litreCol, montantCol });
    return { records: [] };
  }

  const out = [];
  let emptyStreak = 0;

  for (let r = hRow + 1; r < grid.length; r++) {
    const row = grid[r] || [];
    
    // Check si ligne vide
    const hasAny = row.some(v => v !== null && v !== undefined && String(v).trim() !== '');
    if (!hasAny) {
      emptyStreak += 1;
      if (emptyStreak >= 10) break;
      continue;
    }
    emptyStreak = 0;

    const log_date = parseDate(row[dateCol]);
    const liters = toFloat(row[litreCol]);
    const montant_ar = toInt(row[montantCol]);

    // Skip si pas de date ET pas de donnÃ©es
    if (!log_date && liters === null && montant_ar === null) continue;
    
    // Skip si date invalide
    if (!log_date) continue;

    out.push({
      log_date,
      liters,
      montant_ar,
      source_file_name: fileName,
      sheet_name: sheetName,
      row_in_sheet: r + 1
    });
  }

  console.log(`[GENERATOR] Parsed ${out.length} lignes depuis ${fileName}`);
  return { records: out };
}

module.exports = { parseGeneratorWorkbook };

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/utils/excel/detectType.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const XLSX = require('xlsx');
const { norm, sheetTo2D } = require('./parseUtils');

function detectFromName(name) {
  const n = norm(name);
  if (n.includes('groupe') && n.includes('elect')) return 'GENERATOR';
  if (n.includes('autres') && n.includes('carburant')) return 'OTHER';
  if (n.includes('suivi') && n.includes('carburant')) return 'VEHICLE';
  return null;
}

function detectFromWorkbook(workbook) {
  // quick scan of a few top cells across sheets
  for (const sheetName of workbook.SheetNames) {
    const sheet = workbook.Sheets[sheetName];
    const grid = sheetTo2D(sheet);
    for (let r = 0; r < Math.min(grid.length, 25); r++) {
      for (let c = 0; c < Math.min((grid[r]||[]).length, 20); c++) {
        const v = grid[r][c];
        const s = norm(v);
        if (!s) continue;
        if (s.includes('suivi') && s.includes('carburant')) return 'VEHICLE';
        if (s.includes('groupe') && s.includes('electrogene')) return 'GENERATOR';
        if (s.includes('autres') && s.includes('carburants')) return 'OTHER';
        if (s.includes('demande de carburant')) return 'FUEL_REQUEST_FORM';
      }
    }
  }
  return 'UNKNOWN';
}

function detectExcelType(buffer, originalName) {
  const nameGuess = detectFromName(originalName || '');
  const workbook = XLSX.read(buffer, { type: 'buffer', cellDates: true });
  const wbGuess = detectFromWorkbook(workbook);
  return { type: nameGuess || wbGuess, workbook };
}

module.exports = { detectExcelType };


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/routes/notifications.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/notificationsController');

const router = express.Router();
router.use(authRequired);

router.get('/', asyncHandler(ctrl.getNotifications));
router.post('/:id/read', asyncHandler(ctrl.markAsRead));

module.exports = router;

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/routes/trash.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired, requireRole } = require('../middleware/auth');
const ctrl = require('../controllers/trashController');

const router = express.Router();
router.use(authRequired);
router.use(requireRole('ADMIN', 'LOGISTIQUE'));

router.get('/:entity', asyncHandler(ctrl.list));
router.post('/:entity/:id/restore', asyncHandler(ctrl.restore));
router.delete('/:entity/:id/hard', asyncHandler(ctrl.hardDelete));

module.exports = router;


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/routes/meta.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired, requireRole } = require('../middleware/auth');
const { listVehicles, createVehicle, updateVehicle, deleteVehicle, listDrivers, createDriver, updateDriver, deleteDriver } = require('../controllers/metaController');

const router = express.Router();

router.use(authRequired);
router.get('/vehicles', asyncHandler(listVehicles));
router.post('/vehicles', requireRole('LOGISTIQUE','ADMIN'), asyncHandler(createVehicle));
router.put('/vehicles/:id', requireRole('LOGISTIQUE','ADMIN'), asyncHandler(updateVehicle));
router.delete('/vehicles/:id', requireRole('LOGISTIQUE','ADMIN'), asyncHandler(deleteVehicle));

router.get('/drivers', asyncHandler(listDrivers));
router.post('/drivers', requireRole('LOGISTIQUE', 'ADMIN'), asyncHandler(createDriver));
router.put('/drivers/:id', requireRole('LOGISTIQUE', 'ADMIN'), asyncHandler(updateDriver));
router.delete('/drivers/:id', requireRole('LOGISTIQUE', 'ADMIN'), asyncHandler(deleteDriver));

module.exports = router;


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/routes/logbooks.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/logbooksController');

const router = express.Router();
router.use(authRequired);

router.get('/', asyncHandler(ctrl.list));
router.post('/', asyncHandler(ctrl.create));
router.get('/:id', asyncHandler(ctrl.getOne));
router.put('/:id', asyncHandler(ctrl.update));
router.put('/:id/trips', asyncHandler(ctrl.replaceTrips));
router.put('/:id/supplies', asyncHandler(ctrl.replaceSupplies));
router.patch('/:id/submit', asyncHandler(ctrl.submit));
router.patch('/:id/lock', asyncHandler(ctrl.lock));

module.exports = router;


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/routes/import.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/importController');

const router = express.Router();
router.use(authRequired);

router.post('/batch', asyncHandler(ctrl.createBatch));
router.get('/batches', asyncHandler(ctrl.listBatches));
router.get('/batches/:batch_id/files', asyncHandler(ctrl.listFiles));
router.post('/upload', ctrl.upload.array('files', 10), asyncHandler(ctrl.uploadAndImport));

module.exports = router;


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/routes/fuelRequests.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/fuelRequestsController');

const router = express.Router();
router.use(authRequired);

router.get('/', asyncHandler(ctrl.list));
router.get('/:id', asyncHandler(ctrl.getOne));
router.post('/', asyncHandler(ctrl.create));
router.put('/:id', asyncHandler(ctrl.update));
router.patch('/:id/submit', asyncHandler(ctrl.submit));
router.patch('/:id/verify', asyncHandler(ctrl.verify));
router.patch('/:id/approve', asyncHandler(ctrl.approve));
router.patch('/:id/reject', asyncHandler(ctrl.reject));

// Corbeille (soft delete)
router.delete('/:id', asyncHandler(ctrl.softDelete));

module.exports = router;


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/routes/fuel.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/fuelController');

const router = express.Router();
router.use(authRequired);

// Lists
router.get('/vehicle', asyncHandler(ctrl.listVehicleFuel));
router.get('/generator', asyncHandler(ctrl.listGeneratorFuel));
router.get('/other', asyncHandler(ctrl.listOtherFuel));

// Manual add (LOGISTIQUE / ADMIN)
router.post('/vehicle', asyncHandler(ctrl.manualAddVehicle));
router.post('/generator', asyncHandler(ctrl.manualAddGenerator));
router.post('/other', asyncHandler(ctrl.manualAddOther));

// ========== CRUD: UPDATE & SOFT DELETE (NOUVEAUX) ==========
router.put('/vehicle/:id', asyncHandler(ctrl.updateVehicleFuel));
router.delete('/vehicle/:id', asyncHandler(ctrl.softDeleteVehicleFuel));

router.put('/generator/:id', asyncHandler(ctrl.updateGeneratorFuel));
router.delete('/generator/:id', asyncHandler(ctrl.softDeleteGeneratorFuel));

router.put('/other/:id', asyncHandler(ctrl.updateOtherFuel));
router.delete('/other/:id', asyncHandler(ctrl.softDeleteOtherFuel));

// Exports (LOGISTIQUE / ADMIN)
router.get('/export/:type', asyncHandler(ctrl.exportCsv));

// Reports & KPIs
router.get('/report/summary', asyncHandler(ctrl.reportSummary));
router.get('/kpi/daily', asyncHandler(ctrl.kpiDaily));
router.get('/kpi/by-vehicle', asyncHandler(ctrl.kpiByVehicle));

module.exports = router;

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/sql/seed.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#!/usr/bin/env node
/* eslint-disable no-console */

// Seeds ONLY (does NOT drop tables). Safe to run on an existing DB.

const path = require('path');
const { v4: uuidv4 } = require('uuid');
const bcrypt = require('bcryptjs');
const { Pool } = require('pg');

// Load server/.env automatically
require('dotenv').config({
  path: path.join(__dirname, '..', '..', '.env')
});

const databaseUrl = process.env.DATABASE_URL;
if (!databaseUrl) {
  console.error('DATABASE_URL is required');
  process.exit(1);
}

const pool = new Pool({ connectionString: databaseUrl });

async function run() {
  console.log('Seeding users + vehicles (no drop) ...');

  const users = [
    { username: 'admin', role: 'ADMIN', password: 'admin123', first_name: 'Admin', last_name: 'PRIRTEM' },
    { username: 'logistique', role: 'LOGISTIQUE', password: 'logistique123', first_name: 'A', last_name: 'Logistique' },
    { username: 'raf', role: 'RAF', password: 'raf123', first_name: 'R', last_name: 'AF' },
    { username: 'demandeur', role: 'DEMANDEUR', password: 'demandeur123', first_name: 'Un', last_name: 'Demandeur' }
  ];

  for (const u of users) {
    const hash = await bcrypt.hash(u.password, 10);
    await pool.query(
      `INSERT INTO users (id, first_name, last_name, username, email, role, password_hash)
       VALUES ($1,$2,$3,$4,$5,$6,$7)
       ON CONFLICT (username) DO UPDATE SET
         first_name = EXCLUDED.first_name,
         last_name = EXCLUDED.last_name,
         email = EXCLUDED.email,
         role = EXCLUDED.role,
         password_hash = EXCLUDED.password_hash,
         is_active = TRUE`,
      [uuidv4(), u.first_name, u.last_name, u.username, `${u.username}@local`, u.role, hash]
    );
  }

  const plates = ['39111WWT', '39112WWT', '39114WWT', '39961WWT', '39962WWT', '39963WWT'];
  for (const p of plates) {
    await pool.query(
      `INSERT INTO vehicles (id, plate, label)
       VALUES ($1,$2,$3)
       ON CONFLICT (plate) DO NOTHING`,
      [uuidv4(), p, null]
    );
  }

  console.log('Seed done.');
}

run()
  .catch((e) => {
    console.error(e);
    process.exitCode = 1;
  })
  .finally(async () => {
    await pool.end();
  });


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/routes/carRequests.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const ctrl = require('../controllers/carRequestsController');

const router = express.Router();
router.use(authRequired);

router.get('/', asyncHandler(ctrl.list));
router.get('/:id', asyncHandler(ctrl.getOne));
router.post('/', asyncHandler(ctrl.create));
router.put('/:id', asyncHandler(ctrl.update));

// Preferred endpoints (used by client)
router.post('/:id/visa', asyncHandler(ctrl.logisticsApprove));
router.post('/:id/approve', asyncHandler(ctrl.rafApprove));
router.post('/:id/reject', asyncHandler(ctrl.reject));

// Legacy/alt endpoints
router.patch('/:id/logistics-approve', asyncHandler(ctrl.logisticsApprove));
router.patch('/:id/raf-approve', asyncHandler(ctrl.rafApprove));
router.patch('/:id/reject', asyncHandler(ctrl.reject));

// Corbeille (soft delete)
router.delete('/:id', asyncHandler(ctrl.softDelete));

module.exports = router;


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/sql/schema.sql â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-- PRIRTEM Fuel WebApp - Database schema (PostgreSQL)
-- NOTE: Designed to match the server controllers/routes in /server/src

BEGIN;

CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- ---------- TYPES ----------
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'user_role') THEN
    CREATE TYPE user_role AS ENUM ('DEMANDEUR', 'LOGISTIQUE', 'RAF', 'ADMIN');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'fuel_request_status') THEN
    CREATE TYPE fuel_request_status AS ENUM ('DRAFT','SUBMITTED','VERIFIED','APPROVED','REJECTED');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'car_request_status') THEN
    CREATE TYPE car_request_status AS ENUM ('SUBMITTED','LOGISTICS_APPROVED','RAF_APPROVED','REJECTED');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'logbook_status') THEN
    CREATE TYPE logbook_status AS ENUM ('DRAFT','SUBMITTED','LOCKED');
  END IF;
END $$;

-- ---------- DROP (safe re-run) ----------
DROP TABLE IF EXISTS car_logbook_fuel_supplies CASCADE;
DROP TABLE IF EXISTS car_logbook_trips CASCADE;
DROP TABLE IF EXISTS car_logbooks CASCADE;

DROP TABLE IF EXISTS car_requests CASCADE;
DROP TABLE IF EXISTS fuel_requests CASCADE;

DROP TABLE IF EXISTS vehicle_fuel_logs CASCADE;
DROP TABLE IF EXISTS generator_fuel_logs CASCADE;
DROP TABLE IF EXISTS other_fuel_logs CASCADE;

DROP TABLE IF EXISTS import_files CASCADE;
DROP TABLE IF EXISTS import_batches CASCADE;

DROP TABLE IF EXISTS drivers CASCADE;
DROP TABLE IF EXISTS vehicles CASCADE;

DROP TABLE IF EXISTS password_reset_tokens CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- ---------- COMMON ----------
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ---------- USERS ----------
CREATE TABLE users (
  id UUID PRIMARY KEY,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  username TEXT NOT NULL UNIQUE,
  email TEXT NOT NULL UNIQUE,
  role user_role NOT NULL,
  password_hash TEXT NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TRIGGER trig_users_updated
BEFORE UPDATE ON users
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE password_reset_tokens (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token_hash TEXT NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,
  used_at TIMESTAMPTZ NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_prt_user_id ON password_reset_tokens(user_id);

-- ---------- META ----------
CREATE TABLE vehicles (
  id UUID PRIMARY KEY,
  plate TEXT NOT NULL UNIQUE,
  label TEXT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ NULL
);

CREATE INDEX idx_vehicles_deleted_at ON vehicles(deleted_at);

CREATE TRIGGER trig_vehicles_updated
BEFORE UPDATE ON vehicles
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE drivers (
  id UUID PRIMARY KEY,
  full_name TEXT NOT NULL,
  phone TEXT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ NULL
);

CREATE INDEX idx_drivers_deleted_at ON drivers(deleted_at);

CREATE TRIGGER trig_drivers_updated
BEFORE UPDATE ON drivers
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- ---------- IMPORT HISTORY ----------
CREATE TABLE import_batches (
  id UUID PRIMARY KEY,
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE import_files (
  id UUID PRIMARY KEY,
  batch_id UUID NOT NULL REFERENCES import_batches(id) ON DELETE CASCADE,
  original_name TEXT NOT NULL,
  mime_type TEXT NULL,
  size_bytes INTEGER NOT NULL DEFAULT 0,
  detected_type TEXT NULL,
  inserted_rows INTEGER NOT NULL DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'PENDING',
  error_message TEXT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  processed_at TIMESTAMPTZ NULL
);

CREATE INDEX idx_import_files_batch ON import_files(batch_id);

-- ---------- FUEL LOGS ----------
CREATE TABLE vehicle_fuel_logs (
  id UUID PRIMARY KEY,
  vehicle_id UUID NOT NULL REFERENCES vehicles(id) ON DELETE CASCADE,

  log_date DATE NULL,
  day_name TEXT NULL,
  day_no INTEGER NULL,

  km_depart INTEGER NULL,
  km_arrivee INTEGER NULL,
  km_jour INTEGER NULL,

  km_between_refill INTEGER NULL,
  consumption DOUBLE PRECISION NULL,
  interval_days INTEGER NULL,

  compteur INTEGER NULL,
  liters DOUBLE PRECISION NULL,
  montant_ar INTEGER NULL,

  lien TEXT NULL,
  chauffeur TEXT NULL,
  frns TEXT NULL,

  is_refill BOOLEAN NOT NULL DEFAULT FALSE,
  is_mission BOOLEAN NOT NULL DEFAULT FALSE,
  mission_label TEXT NULL,

  source_file_name TEXT NOT NULL,
  sheet_name TEXT NOT NULL,
  row_in_sheet INTEGER NOT NULL,

  import_batch_id UUID NOT NULL REFERENCES import_batches(id) ON DELETE CASCADE,
  import_file_id UUID NOT NULL REFERENCES import_files(id) ON DELETE CASCADE,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_vfl_vehicle_date ON vehicle_fuel_logs(vehicle_id, log_date);
CREATE INDEX idx_vfl_batch ON vehicle_fuel_logs(import_batch_id);
CREATE INDEX idx_vfl_is_refill ON vehicle_fuel_logs(is_refill);

CREATE TABLE generator_fuel_logs (
  id UUID PRIMARY KEY,
  log_date DATE NOT NULL,
  liters DOUBLE PRECISION NULL,
  montant_ar INTEGER NULL,

  source_file_name TEXT NOT NULL,
  sheet_name TEXT NOT NULL,
  row_in_sheet INTEGER NOT NULL,

  import_batch_id UUID NOT NULL REFERENCES import_batches(id) ON DELETE CASCADE,
  import_file_id UUID NOT NULL REFERENCES import_files(id) ON DELETE CASCADE,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_gfl_date ON generator_fuel_logs(log_date);

CREATE TABLE other_fuel_logs (
  id UUID PRIMARY KEY,
  log_date DATE NOT NULL,
  liters DOUBLE PRECISION NULL,
  montant_ar INTEGER NULL,
  lien TEXT NULL,

  source_file_name TEXT NOT NULL,
  sheet_name TEXT NOT NULL,
  row_in_sheet INTEGER NOT NULL,

  import_batch_id UUID NOT NULL REFERENCES import_batches(id) ON DELETE CASCADE,
  import_file_id UUID NOT NULL REFERENCES import_files(id) ON DELETE CASCADE,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_ofl_date ON other_fuel_logs(log_date);

-- ---------- REQUESTS ----------
CREATE TABLE fuel_requests (
  id UUID PRIMARY KEY,
  year INTEGER NOT NULL,
  seq INTEGER NOT NULL,
  request_no TEXT NOT NULL UNIQUE,

  request_type TEXT NOT NULL CHECK (request_type IN ('SERVICE','MISSION')),
  objet TEXT NOT NULL,
  amount_estimated_ar INTEGER NOT NULL,
  amount_estimated_words TEXT NOT NULL,
  request_date DATE NOT NULL,

  status fuel_request_status NOT NULL DEFAULT 'DRAFT',

  requester_id UUID NOT NULL REFERENCES users(id),

  submitted_at TIMESTAMPTZ NULL,

  verified_by UUID NULL REFERENCES users(id),
  verified_at TIMESTAMPTZ NULL,

  approved_by UUID NULL REFERENCES users(id),
  approved_at TIMESTAMPTZ NULL,

  rejected_by UUID NULL REFERENCES users(id),
  rejected_at TIMESTAMPTZ NULL,
  reject_reason TEXT NULL,

  deleted_at TIMESTAMPTZ NULL,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_fr_status ON fuel_requests(status);
CREATE INDEX idx_fr_requester ON fuel_requests(requester_id);
CREATE INDEX idx_fr_deleted_at ON fuel_requests(deleted_at);

CREATE TRIGGER trig_fuel_requests_updated
BEFORE UPDATE ON fuel_requests
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE car_requests (
  id UUID PRIMARY KEY,
  year INTEGER NOT NULL,
  seq INTEGER NOT NULL,
  request_no TEXT NOT NULL UNIQUE,

  proposed_date DATE NOT NULL,
  objet TEXT NOT NULL,
  itinerary TEXT NOT NULL,
  people TEXT NOT NULL,

  depart_time_wanted TIME NULL,
  return_time_expected TIME NULL,

  vehicle_hint TEXT NULL,
  driver_hint TEXT NULL,

  -- Optional assignments done by Logistique
  vehicle_id UUID NULL REFERENCES vehicles(id),
  driver_id UUID NULL REFERENCES drivers(id),

  -- Auto filled when RAF validates (Visa RAF)
  authorization_date DATE NULL,
  authorization_time TIME NULL,

  status car_request_status NOT NULL DEFAULT 'SUBMITTED',

  requester_id UUID NOT NULL REFERENCES users(id),

  logistics_by UUID NULL REFERENCES users(id),
  logistics_at TIMESTAMPTZ NULL,

  raf_by UUID NULL REFERENCES users(id),
  raf_at TIMESTAMPTZ NULL,

  rejected_by UUID NULL REFERENCES users(id),
  rejected_at TIMESTAMPTZ NULL,
  reject_reason TEXT NULL,

  deleted_at TIMESTAMPTZ NULL,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_cr_status ON car_requests(status);
CREATE INDEX idx_cr_requester ON car_requests(requester_id);
CREATE INDEX idx_cr_deleted_at ON car_requests(deleted_at);

CREATE TRIGGER trig_car_requests_updated
BEFORE UPDATE ON car_requests
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- ---------- JOURNAL DE BORD VOITURE ----------
CREATE TABLE car_logbooks (
  id UUID PRIMARY KEY,
  vehicle_id UUID NOT NULL REFERENCES vehicles(id),
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  objet TEXT NULL,

  service_km INTEGER NOT NULL DEFAULT 0,
  mission_km INTEGER NOT NULL DEFAULT 0,

  chauffeur_signature TEXT NULL,

  status logbook_status NOT NULL DEFAULT 'DRAFT',

  created_by UUID NOT NULL REFERENCES users(id),
  submitted_at TIMESTAMPTZ NULL,
  locked_at TIMESTAMPTZ NULL,
  locked_by UUID NULL REFERENCES users(id),

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_cl_vehicle_period ON car_logbooks(vehicle_id, period_start, period_end);
CREATE INDEX idx_cl_status ON car_logbooks(status);

CREATE TRIGGER trig_car_logbooks_updated
BEFORE UPDATE ON car_logbooks
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE car_logbook_trips (
  id UUID PRIMARY KEY,
  logbook_id UUID NOT NULL REFERENCES car_logbooks(id) ON DELETE CASCADE,

  trip_date DATE NOT NULL,

  depart_time TIME NULL,
  depart_km INTEGER NULL,

  route_start TEXT NULL,
  route_end TEXT NULL,

  parking_place TEXT NULL,
  parking_duration_min INTEGER NULL,

  arrival_time TIME NULL,
  arrival_km INTEGER NULL,

  passengers TEXT NULL,
  emargement TEXT NULL,

  is_mission BOOLEAN NOT NULL DEFAULT FALSE,
  mission_label TEXT NULL,

  row_order INTEGER NOT NULL,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_clt_logbook ON car_logbook_trips(logbook_id, row_order);

CREATE TABLE car_logbook_fuel_supplies (
  id UUID PRIMARY KEY,
  logbook_id UUID NOT NULL REFERENCES car_logbooks(id) ON DELETE CASCADE,
  supply_date DATE NOT NULL,
  compteur_km INTEGER NOT NULL,
  liters DOUBLE PRECISION NOT NULL,
  montant_ar INTEGER NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_cls_logbook ON car_logbook_fuel_supplies(logbook_id, supply_date);

COMMIT;


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/routes/auth.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const express = require('express');
const asyncHandler = require('../utils/asyncHandler');
const { authRequired } = require('../middleware/auth');
const { register, login, forgotPassword, resetPassword, me, ROLES } = require('../controllers/authController');

const router = express.Router();

router.get('/roles', (req, res) => res.json({ roles: ROLES }));
router.post('/register', asyncHandler(register));
router.post('/login', asyncHandler(login));
router.post('/forgot', asyncHandler(forgotPassword));
router.post('/reset', asyncHandler(resetPassword));
router.get('/me', authRequired, asyncHandler(me));

module.exports = router;


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/sql/reset.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#!/usr/bin/env node
/* eslint-disable no-console */

const fs = require('fs');
const path = require('path');
const { v4: uuidv4 } = require('uuid');
const bcrypt = require('bcryptjs');
const { Pool } = require('pg');

// Load server/.env automatically (so `npm run db:reset` works without manual export)
require('dotenv').config({
  path: path.join(__dirname, '..', '..', '.env')
});

const databaseUrl = process.env.DATABASE_URL;
if (!databaseUrl) {
  console.error('DATABASE_URL is required');
  process.exit(1);
}

const pool = new Pool({ connectionString: databaseUrl });

async function run() {
  const schemaPath = path.join(__dirname, 'schema.sql');
  const sql = fs.readFileSync(schemaPath, 'utf8');

  console.log('Applying schema.sql ...');
  await pool.query(sql);

  console.log('Seeding users + vehicles ...');

  const users = [
    { username: 'admin', role: 'ADMIN', password: 'admin123', first_name: 'Admin', last_name: 'PRIRTEM' },
    { username: 'logistique', role: 'LOGISTIQUE', password: 'logistique123', first_name: 'A', last_name: 'Logistique' },
    { username: 'raf', role: 'RAF', password: 'raf123', first_name: 'R', last_name: 'AF' },
    { username: 'demandeur', role: 'DEMANDEUR', password: 'demandeur123', first_name: 'Un', last_name: 'Demandeur' }
  ];

  for (const u of users) {
    const hash = await bcrypt.hash(u.password, 10);
    await pool.query(
      `INSERT INTO users (id, first_name, last_name, username, email, role, password_hash)
       VALUES ($1,$2,$3,$4,$5,$6,$7)
       ON CONFLICT (username) DO UPDATE SET
         first_name = EXCLUDED.first_name,
         last_name = EXCLUDED.last_name,
         email = EXCLUDED.email,
         role = EXCLUDED.role,
         password_hash = EXCLUDED.password_hash,
         is_active = TRUE`,
      [uuidv4(), u.first_name, u.last_name, u.username, `${u.username}@local`, u.role, hash]
    );
  }

  const plates = ['39111WWT','39112WWT','39114WWT','39961WWT','39962WWT','39963WWT'];
  for (const p of plates) {
    await pool.query(
      `INSERT INTO vehicles (id, plate, label)
       VALUES ($1,$2,$3)
       ON CONFLICT (plate) DO NOTHING`,
      [uuidv4(), p, null]
    );
  }

  console.log('Done.');
}

run()
  .catch((e) => {
    console.error(e);
    process.exitCode = 1;
  })
  .finally(async () => {
    await pool.end();
  });


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/sql/initIfNeeded.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#!/usr/bin/env node
/* eslint-disable no-console */

const { Pool } = require('pg');
const path = require('path');
const { execFileSync } = require('child_process');

// Load server/.env when running locally
require('dotenv').config({
  path: path.join(__dirname, '..', '..', '.env')
});

const databaseUrl = process.env.DATABASE_URL;
if (!databaseUrl) {
  console.error('DATABASE_URL is required');
  process.exit(1);
}

const pool = new Pool({ connectionString: databaseUrl });

async function tableExists(name) {
  const { rows } = await pool.query(
    `SELECT 1
     FROM information_schema.tables
     WHERE table_schema='public' AND table_name=$1
     LIMIT 1`,
    [name]
  );
  return !!rows[0];
}

async function run() {
  const hasUsers = await tableExists('users');
  if (hasUsers) {
    console.log('DB already initialized âœ…');
    return;
  }

  console.log('DB not initialized, running db:reset ...');
  execFileSync(process.execPath, [path.join(__dirname, 'reset.js')], {
    stdio: 'inherit',
    env: process.env
  });
}

run()
  .catch((e) => {
    console.error(e);
    process.exitCode = 1;
  })
  .finally(async () => {
    await pool.end();
  });


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/index.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
require('dotenv').config();

const express = require('express');
const cors = require('cors');
const path = require('path');
const fs = require('fs');

// Routes
const authRoutes = require('./routes/auth');
const metaRoutes = require('./routes/meta');
const fuelRoutes = require('./routes/fuel');
const importRoutes = require('./routes/import');
const fuelRequestsRoutes = require('./routes/fuelRequests');
const carRequestsRoutes = require('./routes/carRequests');
const logbooksRoutes = require('./routes/logbooks');
const trashRoutes = require('./routes/trash');
const notificationsRoutes = require('./routes/notifications'); // ========== NOUVEAU ==========

const app = express();

const corsOptions = {
  origin: process.env.CLIENT_URL || true, 
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS']
};

app.use(cors(corsOptions));
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Health Check
app.get('/api/health', (req, res) => res.json({ status: 'ok', uptime: process.uptime() }));

// API Routes
app.use('/api/auth', authRoutes);
app.use('/api/meta', metaRoutes);
app.use('/api/fuel', fuelRoutes);
app.use('/api/import', importRoutes);
app.use('/api/requests/fuel', fuelRequestsRoutes);
app.use('/api/requests/car', carRequestsRoutes);
app.use('/api/logbooks', logbooksRoutes);
app.use('/api/trash', trashRoutes);
app.use('/api/notifications', notificationsRoutes); // ========== NOUVEAU ==========

// Serve Static Files (Production / Docker)
const publicDir = path.join(__dirname, '..', 'public');
const publicIndex = path.join(publicDir, 'index.html');

if (fs.existsSync(publicIndex)) {
  app.use(express.static(publicDir));
  app.get(/^\/(?!api).*/, (req, res) => res.sendFile(publicIndex));
}

// 404 Handler
app.use('/api/*', (req, res) => {
  res.status(404).json({ error: 'NOT_FOUND', message: 'Endpoint not found' });
});

// Global Error Handler
app.use((err, req, res, next) => {
  console.error('[SERVER ERROR]', err);

  if (res.headersSent) {
    return next(err);
  }

  if (err.code === 'LIMIT_FILE_SIZE') {
    return res.status(400).json({ error: 'FILE_TOO_LARGE', message: 'Fichier trop volumineux (max 10MB)' });
  }

  const status = err.statusCode || 500;
  const message = err.message || 'Internal Server Error';
  
  res.status(status).json({ 
    error: err.name || 'SERVER_ERROR', 
    message: message,
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
});

const port = Number(process.env.PORT || 3001);
app.listen(port, () => {
  console.log(`ğŸš€ Server running on port ${port}`);
  console.log(`ğŸŒ Environment: ${process.env.NODE_ENV || 'development'}`);
});

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/db.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/db.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * CORRECTIF APPLIQUÃ‰ : Gestion des erreurs inattendues sur le pool (anti-crash).
 */
const { Pool } = require('pg');

const connectionString = process.env.DATABASE_URL;

if (!connectionString) {
  throw new Error('DATABASE_URL is required in .env');
}

// Configuration recommandÃ©e pour la prod (SSL si besoin)
const pool = new Pool({ 
  connectionString,
  // max: 20, // (Optionnel) Limite de connexions simultanÃ©es
  // idleTimeoutMillis: 30000
});

// IMPORTANT : Capture les erreurs sur les clients inactifs pour Ã©viter le crash du serveur
pool.on('error', (err, client) => {
  console.error('âŒ Unexpected error on idle client', err);
  // Ne pas exit(-1) ici, on laisse le pool essayer de se reconnecter
});

module.exports = { pool };

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/package.json â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  "name": "prirtem-fuel-server",
  "version": "1.0.0",
  "private": true,
  "type": "commonjs",
  "main": "src/index.js",
  "scripts": {
    "dev": "node --watch src/index.js",
    "start": "node src/index.js",
    "db:reset": "node src/sql/reset.js",
    "db:seed": "node src/sql/seed.js"
  },
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "express-rate-limit": "^8.2.1",
    "helmet": "^8.1.0",
    "jsonwebtoken": "^9.0.2",
    "multer": "^1.4.5-lts.1",
    "nodemailer": "^6.9.14",
    "pg": "^8.12.0",
    "uuid": "^9.0.1",
    "xlsx": "^0.18.5",
    "zod": "^3.23.8"
  }
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/package-lock.json â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  "name": "prirtem-fuel-server",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "prirtem-fuel-server",
      "version": "1.0.0",
      "dependencies": {
        "bcryptjs": "^2.4.3",
        "cors": "^2.8.5",
        "dotenv": "^16.4.5",
        "express": "^4.19.2",
        "express-rate-limit": "^8.2.1",
        "helmet": "^8.1.0",
        "jsonwebtoken": "^9.0.2",
        "multer": "^1.4.5-lts.1",
        "nodemailer": "^6.9.14",
        "pg": "^8.12.0",
        "uuid": "^9.0.1",
        "xlsx": "^0.18.5",
        "zod": "^3.23.8"
      }
    },
    "node_modules/accepts": {
      "version": "1.3.8",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/accepts/-/accepts-1.3.8.tgz",
      "integrity": "sha512-PYAthTa2m2VKxuvSD3DPC/Gy+U+sOA1LAuT8mkmRuvw+NACSaeXEQ+NHcVF7rONl6qcaxV3Uuemwawk+7+SJLw==",
      "license": "MIT",
      "dependencies": {
        "mime-types": "~2.1.34",
        "negotiator": "0.6.3"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/adler-32": {
      "version": "1.3.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/adler-32/-/adler-32-1.3.1.tgz",
      "integrity": "sha512-ynZ4w/nUUv5rrsR8UUGoe1VC9hZj6V5hU9Qw1HlMDJGEJw5S7TfTErWTjMys6M7vr0YWcPqs3qAr4ss0nDfP+A==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/append-field": {
      "version": "1.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/append-field/-/append-field-1.0.0.tgz",
      "integrity": "sha512-klpgFSWLW1ZEs8svjfb7g4qWY0YS5imI82dTg+QahUvJ8YqAY0P10Uk8tTyh9ZGuYEZEMaeJYCF5BFuX552hsw==",
      "license": "MIT"
    },
    "node_modules/array-flatten": {
      "version": "1.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/array-flatten/-/array-flatten-1.1.1.tgz",
      "integrity": "sha512-PCVAQswWemu6UdxsDFFX/+gVeYqKAod3D3UVm91jHwynguOwAvYPhx8nNlM++NqRcK6CxxpUafjmhIdKiHibqg==",
      "license": "MIT"
    },
    "node_modules/bcryptjs": {
      "version": "2.4.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/bcryptjs/-/bcryptjs-2.4.3.tgz",
      "integrity": "sha512-V/Hy/X9Vt7f3BbPJEi8BdVFMByHi+jNXrYkW3huaybV/kQ0KJg0Y6PkEMbn+zeT+i+SiKZ/HMqJGIIt4LZDqNQ==",
      "license": "MIT"
    },
    "node_modules/body-parser": {
      "version": "1.20.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/body-parser/-/body-parser-1.20.4.tgz",
      "integrity": "sha512-ZTgYYLMOXY9qKU/57FAo8F+HA2dGX7bqGc71txDRC1rS4frdFI5R7NhluHxH6M0YItAP0sHB4uqAOcYKxO6uGA==",
      "license": "MIT",
      "dependencies": {
        "bytes": "~3.1.2",
        "content-type": "~1.0.5",
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "~1.2.0",
        "http-errors": "~2.0.1",
        "iconv-lite": "~0.4.24",
        "on-finished": "~2.4.1",
        "qs": "~6.14.0",
        "raw-body": "~2.5.3",
        "type-is": "~1.6.18",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8",
        "npm": "1.2.8000 || >= 1.4.16"
      }
    },
    "node_modules/buffer-equal-constant-time": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/buffer-equal-constant-time/-/buffer-equal-constant-time-1.0.1.tgz",
      "integrity": "sha512-zRpUiDwd/xk6ADqPMATG8vc9VPrkck7T07OIx0gnjmJAnHnTVXNQG3vfvWNuiZIkwu9KrKdA1iJKfsfTVxE6NA==",
      "license": "BSD-3-Clause"
    },
    "node_modules/buffer-from": {
      "version": "1.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/buffer-from/-/buffer-from-1.1.2.tgz",
      "integrity": "sha512-E+XQCRwSbaaiChtv6k6Dwgc+bx+Bs6vuKJHHl5kox/BaKbhiXzqQOwK4cO22yElGp2OCmjwVhT3HmxgyPGnJfQ==",
      "license": "MIT"
    },
    "node_modules/busboy": {
      "version": "1.6.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/busboy/-/busboy-1.6.0.tgz",
      "integrity": "sha512-8SFQbg/0hQ9xy3UNTB0YEnsNBbWfhf7RtnzpL7TkBiTBRfrQ9Fxcnz7VJsleJpyp6rVLvXiuORqjlHi5q+PYuA==",
      "dependencies": {
        "streamsearch": "^1.1.0"
      },
      "engines": {
        "node": ">=10.16.0"
      }
    },
    "node_modules/bytes": {
      "version": "3.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/bytes/-/bytes-3.1.2.tgz",
      "integrity": "sha512-/Nf7TyzTx6S3yRJObOAV7956r8cr2+Oj8AC5dt8wSP3BQAoeX58NoHyCU8P8zGkNXStjTSi6fzO6F0pBdcYbEg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/call-bind-apply-helpers": {
      "version": "1.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/call-bind-apply-helpers/-/call-bind-apply-helpers-1.0.2.tgz",
      "integrity": "sha512-Sp1ablJ0ivDkSzjcaJdxEunN5/XvksFJ2sMBFfq6x0ryhQV/2b/KwFe21cMpmHtPOSij8K99/wSfoEuTObmuMQ==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/call-bound": {
      "version": "1.0.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/call-bound/-/call-bound-1.0.4.tgz",
      "integrity": "sha512-+ys997U96po4Kx/ABpBCqhA9EuxJaQWDQg7295H4hBphv3IZg0boBKuwYpt4YXp6MZ5AmZQnU/tyMTlRpaSejg==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "get-intrinsic": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/cfb": {
      "version": "1.2.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/cfb/-/cfb-1.2.2.tgz",
      "integrity": "sha512-KfdUZsSOw19/ObEWasvBP/Ac4reZvAGauZhs6S/gqNhXhI7cKwvlH7ulj+dOEYnca4bm4SGo8C1bTAQvnTjgQA==",
      "license": "Apache-2.0",
      "dependencies": {
        "adler-32": "~1.3.0",
        "crc-32": "~1.2.0"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/codepage": {
      "version": "1.15.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/codepage/-/codepage-1.15.0.tgz",
      "integrity": "sha512-3g6NUTPd/YtuuGrhMnOMRjFc+LJw/bnMp3+0r/Wcz3IXUuCosKRJvMphm5+Q+bvTVGcJJuRvVLuYba+WojaFaA==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/concat-stream": {
      "version": "1.6.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/concat-stream/-/concat-stream-1.6.2.tgz",
      "integrity": "sha512-27HBghJxjiZtIk3Ycvn/4kbJk/1uZuJFfuPEns6LaEvpvG1f0hTea8lilrouyo9mVc2GWdcEZ8OLoGmSADlrCw==",
      "engines": [
        "node >= 0.8"
      ],
      "license": "MIT",
      "dependencies": {
        "buffer-from": "^1.0.0",
        "inherits": "^2.0.3",
        "readable-stream": "^2.2.2",
        "typedarray": "^0.0.6"
      }
    },
    "node_modules/content-disposition": {
      "version": "0.5.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/content-disposition/-/content-disposition-0.5.4.tgz",
      "integrity": "sha512-FveZTNuGw04cxlAiWbzi6zTAL/lhehaWbTtgluJh4/E95DqMwTmha3KZN1aAWA8cFIhHzMZUvLevkw5Rqk+tSQ==",
      "license": "MIT",
      "dependencies": {
        "safe-buffer": "5.2.1"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/content-type": {
      "version": "1.0.5",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/content-type/-/content-type-1.0.5.tgz",
      "integrity": "sha512-nTjqfcBFEipKdXCv4YDQWCfmcLZKm81ldF0pAopTvyrFGVbcR6P/VAAd5G7N+0tTr8QqiU0tFadD6FK4NtJwOA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/cookie": {
      "version": "0.7.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/cookie/-/cookie-0.7.2.tgz",
      "integrity": "sha512-yki5XnKuf750l50uGTllt6kKILY4nQ1eNIQatoXEByZ5dWgnKqbnqmTrBE5B4N7lrMJKQ2ytWMiTO2o0v6Ew/w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/cookie-signature": {
      "version": "1.0.7",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/cookie-signature/-/cookie-signature-1.0.7.tgz",
      "integrity": "sha512-NXdYc3dLr47pBkpUCHtKSwIOQXLVn8dZEuywboCOJY/osA0wFSLlSawr3KN8qXJEyX66FcONTH8EIlVuK0yyFA==",
      "license": "MIT"
    },
    "node_modules/core-util-is": {
      "version": "1.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/core-util-is/-/core-util-is-1.0.3.tgz",
      "integrity": "sha512-ZQBvi1DcpJ4GDqanjucZ2Hj3wEO5pZDS89BWbkcrvdxksJorwUDDZamX9ldFkp9aw2lmBDLgkObEA4DWNJ9FYQ==",
      "license": "MIT"
    },
    "node_modules/cors": {
      "version": "2.8.5",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/cors/-/cors-2.8.5.tgz",
      "integrity": "sha512-KIHbLJqu73RGr/hnbrO9uBeixNGuvSQjul/jdFvS/KFSIH1hWVd1ng7zOHx+YrEfInLG7q4n6GHQ9cDtxv/P6g==",
      "license": "MIT",
      "dependencies": {
        "object-assign": "^4",
        "vary": "^1"
      },
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/crc-32": {
      "version": "1.2.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/crc-32/-/crc-32-1.2.2.tgz",
      "integrity": "sha512-ROmzCKrTnOwybPcJApAA6WBWij23HVfGVNKqqrZpuyZOHqK2CwHSvpGuyt/UNNvaIjEd8X5IFGp4Mh+Ie1IHJQ==",
      "license": "Apache-2.0",
      "bin": {
        "crc32": "bin/crc32.njs"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "license": "MIT",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/depd": {
      "version": "2.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/depd/-/depd-2.0.0.tgz",
      "integrity": "sha512-g7nH6P6dyDioJogAAGprGpCtVImJhpPk/roCzdb3fIh61/s/nPsfR6onyMwkCAR/OlC3yBC0lESvUoQEAssIrw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/destroy": {
      "version": "1.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/destroy/-/destroy-1.2.0.tgz",
      "integrity": "sha512-2sJGJTaXIIaR1w4iJSNoN0hnMY7Gpc/n8D4qSCJw8QqFWXf7cuAgnEHxBpweaVcPevC2l3KpjYCx3NypQQgaJg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8",
        "npm": "1.2.8000 || >= 1.4.16"
      }
    },
    "node_modules/dotenv": {
      "version": "16.6.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/dotenv/-/dotenv-16.6.1.tgz",
      "integrity": "sha512-uBq4egWHTcTt33a72vpSG0z3HnPuIl6NqYcTrKEg2azoEyl2hpW0zqlxysq2pK9HlDIHyHyakeYaYnSAwd8bow==",
      "license": "BSD-2-Clause",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://dotenvx.com"
      }
    },
    "node_modules/dunder-proto": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/dunder-proto/-/dunder-proto-1.0.1.tgz",
      "integrity": "sha512-KIN/nDJBQRcXw0MLVhZE9iQHmG68qAVIBg9CqmUYjmQIhgij9U5MFvrqkUL5FbtyyzZuOeOt0zdeRe4UY7ct+A==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.1",
        "es-errors": "^1.3.0",
        "gopd": "^1.2.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/ecdsa-sig-formatter": {
      "version": "1.0.11",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ecdsa-sig-formatter/-/ecdsa-sig-formatter-1.0.11.tgz",
      "integrity": "sha512-nagl3RYrbNv6kQkeJIpt6NJZy8twLB/2vtz6yN9Z4vRKHN4/QZJIEbqohALSgwKdnksuY3k5Addp5lg8sVoVcQ==",
      "license": "Apache-2.0",
      "dependencies": {
        "safe-buffer": "^5.0.1"
      }
    },
    "node_modules/ee-first": {
      "version": "1.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ee-first/-/ee-first-1.1.1.tgz",
      "integrity": "sha512-WMwm9LhRUo+WUaRN+vRuETqG89IgZphVSNkdFgeb6sS/E4OrDIN7t48CAewSHXc6C8lefD8KKfr5vY61brQlow==",
      "license": "MIT"
    },
    "node_modules/encodeurl": {
      "version": "2.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/encodeurl/-/encodeurl-2.0.0.tgz",
      "integrity": "sha512-Q0n9HRi4m6JuGIV1eFlmvJB7ZEVxu93IrMyiMsGC0lrMJMWzRgx6WGquyfQgZVb31vhGgXnfmPNNXmxnOkRBrg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/es-define-property": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/es-define-property/-/es-define-property-1.0.1.tgz",
      "integrity": "sha512-e3nRfgfUZ4rNGL232gUgX06QNyyez04KdjFrF+LTRoOXmrOgFKDg4BCdsjW8EnT69eqdYGmRpJwiPVYNrCaW3g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-errors": {
      "version": "1.3.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/es-errors/-/es-errors-1.3.0.tgz",
      "integrity": "sha512-Zf5H2Kxt2xjTvbJvP2ZWLEICxA6j+hAmMzIlypy4xcBg1vKVnx89Wy0GbS+kf5cwCVFFzdCFh2XSCFNULS6csw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-object-atoms": {
      "version": "1.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/es-object-atoms/-/es-object-atoms-1.1.1.tgz",
      "integrity": "sha512-FGgH2h8zKNim9ljj7dankFPcICIK9Cp5bm+c2gQSYePhpaG5+esrLODihIorn+Pe6FGJzWhXQotPv73jTaldXA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/escape-html": {
      "version": "1.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/escape-html/-/escape-html-1.0.3.tgz",
      "integrity": "sha512-NiSupZ4OeuGwr68lGIeym/ksIZMJodUGOSCZ/FSnTxcrekbvqrgdUxlJOMpijaKZVjAJrWrGs/6Jy8OMuyj9ow==",
      "license": "MIT"
    },
    "node_modules/etag": {
      "version": "1.8.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/etag/-/etag-1.8.1.tgz",
      "integrity": "sha512-aIL5Fx7mawVa300al2BnEE4iNvo1qETxLrPI/o05L7z6go7fCw1J6EQmbK4FmJ2AS7kgVF/KEZWufBfdClMcPg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/express": {
      "version": "4.22.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/express/-/express-4.22.1.tgz",
      "integrity": "sha512-F2X8g9P1X7uCPZMA3MVf9wcTqlyNp7IhH5qPCI0izhaOIYXaW9L535tGA3qmjRzpH+bZczqq7hVKxTR4NWnu+g==",
      "license": "MIT",
      "dependencies": {
        "accepts": "~1.3.8",
        "array-flatten": "1.1.1",
        "body-parser": "~1.20.3",
        "content-disposition": "~0.5.4",
        "content-type": "~1.0.4",
        "cookie": "~0.7.1",
        "cookie-signature": "~1.0.6",
        "debug": "2.6.9",
        "depd": "2.0.0",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "finalhandler": "~1.3.1",
        "fresh": "~0.5.2",
        "http-errors": "~2.0.0",
        "merge-descriptors": "1.0.3",
        "methods": "~1.1.2",
        "on-finished": "~2.4.1",
        "parseurl": "~1.3.3",
        "path-to-regexp": "~0.1.12",
        "proxy-addr": "~2.0.7",
        "qs": "~6.14.0",
        "range-parser": "~1.2.1",
        "safe-buffer": "5.2.1",
        "send": "~0.19.0",
        "serve-static": "~1.16.2",
        "setprototypeof": "1.2.0",
        "statuses": "~2.0.1",
        "type-is": "~1.6.18",
        "utils-merge": "1.0.1",
        "vary": "~1.1.2"
      },
      "engines": {
        "node": ">= 0.10.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/express"
      }
    },
    "node_modules/express-rate-limit": {
      "version": "8.2.1",
      "resolved": "https://registry.npmjs.org/express-rate-limit/-/express-rate-limit-8.2.1.tgz",
      "integrity": "sha512-PCZEIEIxqwhzw4KF0n7QF4QqruVTcF73O5kFKUnGOyjbCCgizBBiFaYpd/fnBLUMPw/BWw9OsiN7GgrNYr7j6g==",
      "dependencies": {
        "ip-address": "10.0.1"
      },
      "engines": {
        "node": ">= 16"
      },
      "funding": {
        "url": "https://github.com/sponsors/express-rate-limit"
      },
      "peerDependencies": {
        "express": ">= 4.11"
      }
    },
    "node_modules/finalhandler": {
      "version": "1.3.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/finalhandler/-/finalhandler-1.3.2.tgz",
      "integrity": "sha512-aA4RyPcd3badbdABGDuTXCMTtOneUCAYH/gxoYRTZlIJdF0YPWuGqiAsIrhNnnqdXGswYk6dGujem4w80UJFhg==",
      "license": "MIT",
      "dependencies": {
        "debug": "2.6.9",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "on-finished": "~2.4.1",
        "parseurl": "~1.3.3",
        "statuses": "~2.0.2",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/forwarded": {
      "version": "0.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/forwarded/-/forwarded-0.2.0.tgz",
      "integrity": "sha512-buRG0fpBtRHSTCOASe6hD258tEubFoRLb4ZNA6NxMVHNw2gOcwHo9wyablzMzOA5z9xA9L1KNjk/Nt6MT9aYow==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/frac": {
      "version": "1.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/frac/-/frac-1.1.2.tgz",
      "integrity": "sha512-w/XBfkibaTl3YDqASwfDUqkna4Z2p9cFSr1aHDt0WoMTECnRfBOv2WArlZILlqgWlmdIlALXGpM2AOhEk5W3IA==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/fresh": {
      "version": "0.5.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/fresh/-/fresh-0.5.2.tgz",
      "integrity": "sha512-zJ2mQYM18rEFOudeV4GShTGIQ7RbzA7ozbU9I/XBpm7kqgMywgmylMwXHxZJmkVoYkna9d2pVXVXPdYTP9ej8Q==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/function-bind": {
      "version": "1.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/function-bind/-/function-bind-1.1.2.tgz",
      "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-intrinsic": {
      "version": "1.3.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/get-intrinsic/-/get-intrinsic-1.3.0.tgz",
      "integrity": "sha512-9fSjSaos/fRIVIp+xSJlE6lfwhES7LNtKaCBIamHsjr2na1BiABJPo0mOjjz8GJDURarmCPGqaiVg5mfjb98CQ==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "es-define-property": "^1.0.1",
        "es-errors": "^1.3.0",
        "es-object-atoms": "^1.1.1",
        "function-bind": "^1.1.2",
        "get-proto": "^1.0.1",
        "gopd": "^1.2.0",
        "has-symbols": "^1.1.0",
        "hasown": "^2.0.2",
        "math-intrinsics": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-proto": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/get-proto/-/get-proto-1.0.1.tgz",
      "integrity": "sha512-sTSfBjoXBp89JvIKIefqw7U2CCebsc74kiY6awiGogKtoSGbgjYE/G/+l9sF3MWFPNc9IcoOC4ODfKHfxFmp0g==",
      "license": "MIT",
      "dependencies": {
        "dunder-proto": "^1.0.1",
        "es-object-atoms": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/gopd": {
      "version": "1.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/gopd/-/gopd-1.2.0.tgz",
      "integrity": "sha512-ZUKRh6/kUFoAiTAtTYPZJ3hw9wNxx+BIBOijnlG9PnrJsCcSjs1wyyD6vJpaYtgnzDrKYRSqf3OO6Rfa93xsRg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/has-symbols": {
      "version": "1.1.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/has-symbols/-/has-symbols-1.1.0.tgz",
      "integrity": "sha512-1cDNdwJ2Jaohmb3sg4OmKaMBwuC48sYni5HUw2DvsC8LjGTLK9h+eb1X6RyuOHe4hT0ULCW68iomhjUoKUqlPQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/hasown": {
      "version": "2.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/hasown/-/hasown-2.0.2.tgz",
      "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
      "license": "MIT",
      "dependencies": {
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/helmet": {
      "version": "8.1.0",
      "resolved": "https://registry.npmjs.org/helmet/-/helmet-8.1.0.tgz",
      "integrity": "sha512-jOiHyAZsmnr8LqoPGmCjYAaiuWwjAPLgY8ZX2XrmHawt99/u1y6RgrZMTeoPfpUbV96HOalYgz1qzkRbw54Pmg==",
      "engines": {
        "node": ">=18.0.0"
      }
    },
    "node_modules/http-errors": {
      "version": "2.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/http-errors/-/http-errors-2.0.1.tgz",
      "integrity": "sha512-4FbRdAX+bSdmo4AUFuS0WNiPz8NgFt+r8ThgNWmlrjQjt1Q7ZR9+zTlce2859x4KSXrwIsaeTqDoKQmtP8pLmQ==",
      "license": "MIT",
      "dependencies": {
        "depd": "~2.0.0",
        "inherits": "~2.0.4",
        "setprototypeof": "~1.2.0",
        "statuses": "~2.0.2",
        "toidentifier": "~1.0.1"
      },
      "engines": {
        "node": ">= 0.8"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/express"
      }
    },
    "node_modules/iconv-lite": {
      "version": "0.4.24",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/iconv-lite/-/iconv-lite-0.4.24.tgz",
      "integrity": "sha512-v3MXnZAcvnywkTUEZomIActle7RXXeedOR31wwl7VlyoXO4Qi9arvSenNQWne1TcRwhCL1HwLI21bEqdpj8/rA==",
      "license": "MIT",
      "dependencies": {
        "safer-buffer": ">= 2.1.2 < 3"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/inherits": {
      "version": "2.0.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/inherits/-/inherits-2.0.4.tgz",
      "integrity": "sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==",
      "license": "ISC"
    },
    "node_modules/ip-address": {
      "version": "10.0.1",
      "resolved": "https://registry.npmjs.org/ip-address/-/ip-address-10.0.1.tgz",
      "integrity": "sha512-NWv9YLW4PoW2B7xtzaS3NCot75m6nK7Icdv0o3lfMceJVRfSoQwqD4wEH5rLwoKJwUiZ/rfpiVBhnaF0FK4HoA==",
      "engines": {
        "node": ">= 12"
      }
    },
    "node_modules/ipaddr.js": {
      "version": "1.9.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ipaddr.js/-/ipaddr.js-1.9.1.tgz",
      "integrity": "sha512-0KI/607xoxSToH7GjN1FfSbLoU0+btTicjsQSWQlh/hZykN8KpmMf7uYwPW3R+akZ6R/w18ZlXSHBYXiYUPO3g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/isarray": {
      "version": "1.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/isarray/-/isarray-1.0.0.tgz",
      "integrity": "sha512-VLghIWNM6ELQzo7zwmcg0NmTVyWKYjvIeM83yjp0wRDTmUnrM678fQbcKBo6n2CJEF0szoG//ytg+TKla89ALQ==",
      "license": "MIT"
    },
    "node_modules/jsonwebtoken": {
      "version": "9.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/jsonwebtoken/-/jsonwebtoken-9.0.3.tgz",
      "integrity": "sha512-MT/xP0CrubFRNLNKvxJ2BYfy53Zkm++5bX9dtuPbqAeQpTVe0MQTFhao8+Cp//EmJp244xt6Drw/GVEGCUj40g==",
      "license": "MIT",
      "dependencies": {
        "jws": "^4.0.1",
        "lodash.includes": "^4.3.0",
        "lodash.isboolean": "^3.0.3",
        "lodash.isinteger": "^4.0.4",
        "lodash.isnumber": "^3.0.3",
        "lodash.isplainobject": "^4.0.6",
        "lodash.isstring": "^4.0.1",
        "lodash.once": "^4.0.0",
        "ms": "^2.1.1",
        "semver": "^7.5.4"
      },
      "engines": {
        "node": ">=12",
        "npm": ">=6"
      }
    },
    "node_modules/jsonwebtoken/node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/jwa": {
      "version": "2.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/jwa/-/jwa-2.0.1.tgz",
      "integrity": "sha512-hRF04fqJIP8Abbkq5NKGN0Bbr3JxlQ+qhZufXVr0DvujKy93ZCbXZMHDL4EOtodSbCWxOqR8MS1tXA5hwqCXDg==",
      "license": "MIT",
      "dependencies": {
        "buffer-equal-constant-time": "^1.0.1",
        "ecdsa-sig-formatter": "1.0.11",
        "safe-buffer": "^5.0.1"
      }
    },
    "node_modules/jws": {
      "version": "4.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/jws/-/jws-4.0.1.tgz",
      "integrity": "sha512-EKI/M/yqPncGUUh44xz0PxSidXFr/+r0pA70+gIYhjv+et7yxM+s29Y+VGDkovRofQem0fs7Uvf4+YmAdyRduA==",
      "license": "MIT",
      "dependencies": {
        "jwa": "^2.0.1",
        "safe-buffer": "^5.0.1"
      }
    },
    "node_modules/lodash.includes": {
      "version": "4.3.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.includes/-/lodash.includes-4.3.0.tgz",
      "integrity": "sha512-W3Bx6mdkRTGtlJISOvVD/lbqjTlPPUDTMnlXZFnVwi9NKJ6tiAk6LVdlhZMm17VZisqhKcgzpO5Wz91PCt5b0w==",
      "license": "MIT"
    },
    "node_modules/lodash.isboolean": {
      "version": "3.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.isboolean/-/lodash.isboolean-3.0.3.tgz",
      "integrity": "sha512-Bz5mupy2SVbPHURB98VAcw+aHh4vRV5IPNhILUCsOzRmsTmSQ17jIuqopAentWoehktxGd9e/hbIXq980/1QJg==",
      "license": "MIT"
    },
    "node_modules/lodash.isinteger": {
      "version": "4.0.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.isinteger/-/lodash.isinteger-4.0.4.tgz",
      "integrity": "sha512-DBwtEWN2caHQ9/imiNeEA5ys1JoRtRfY3d7V9wkqtbycnAmTvRRmbHKDV4a0EYc678/dia0jrte4tjYwVBaZUA==",
      "license": "MIT"
    },
    "node_modules/lodash.isnumber": {
      "version": "3.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.isnumber/-/lodash.isnumber-3.0.3.tgz",
      "integrity": "sha512-QYqzpfwO3/CWf3XP+Z+tkQsfaLL/EnUlXWVkIk5FUPc4sBdTehEqZONuyRt2P67PXAk+NXmTBcc97zw9t1FQrw==",
      "license": "MIT"
    },
    "node_modules/lodash.isplainobject": {
      "version": "4.0.6",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.isplainobject/-/lodash.isplainobject-4.0.6.tgz",
      "integrity": "sha512-oSXzaWypCMHkPC3NvBEaPHf0KsA5mvPrOPgQWDsbg8n7orZ290M0BmC/jgRZ4vcJ6DTAhjrsSYgdsW/F+MFOBA==",
      "license": "MIT"
    },
    "node_modules/lodash.isstring": {
      "version": "4.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.isstring/-/lodash.isstring-4.0.1.tgz",
      "integrity": "sha512-0wJxfxH1wgO3GrbuP+dTTk7op+6L41QCXbGINEmD+ny/G/eCqGzxyCsh7159S+mgDDcoarnBw6PC1PS5+wUGgw==",
      "license": "MIT"
    },
    "node_modules/lodash.once": {
      "version": "4.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/lodash.once/-/lodash.once-4.1.1.tgz",
      "integrity": "sha512-Sb487aTOCr9drQVL8pIxOzVhafOjZN9UU54hiN8PU3uAiSV7lx1yYNpbNmex2PK6dSJoNTSJUUswT651yww3Mg==",
      "license": "MIT"
    },
    "node_modules/math-intrinsics": {
      "version": "1.1.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/math-intrinsics/-/math-intrinsics-1.1.0.tgz",
      "integrity": "sha512-/IXtbwEk5HTPyEwyKX6hGkYXxM9nbj64B+ilVJnC/R6B0pH5G4V3b0pVbL7DBj4tkhBAppbQUlf6F6Xl9LHu1g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/media-typer": {
      "version": "0.3.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/media-typer/-/media-typer-0.3.0.tgz",
      "integrity": "sha512-dq+qelQ9akHpcOl/gUVRTxVIOkAJ1wR3QAvb4RsVjS8oVoFjDGTc679wJYmUmknUF5HwMLOgb5O+a3KxfWapPQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/merge-descriptors": {
      "version": "1.0.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/merge-descriptors/-/merge-descriptors-1.0.3.tgz",
      "integrity": "sha512-gaNvAS7TZ897/rVaZ0nMtAyxNyi/pdbjbAwUpFQpN70GqnVfOiXpeUUMKRBmzXaSQ8DdTX4/0ms62r2K+hE6mQ==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/methods": {
      "version": "1.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/methods/-/methods-1.1.2.tgz",
      "integrity": "sha512-iclAHeNqNm68zFtnZ0e+1L2yUIdvzNoauKU4WBA3VvH/vPFieF7qfRlwUZU+DA9P9bPXIS90ulxoUoCH23sV2w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime": {
      "version": "1.6.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/mime/-/mime-1.6.0.tgz",
      "integrity": "sha512-x0Vn8spI+wuJ1O6S7gnbaQg8Pxh4NNHb7KSINmEWKiPE4RKOplvijn+NkmYmmRgP68mc70j2EbeTFRsrswaQeg==",
      "license": "MIT",
      "bin": {
        "mime": "cli.js"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/mime-db": {
      "version": "1.52.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/mime-db/-/mime-db-1.52.0.tgz",
      "integrity": "sha512-sPU4uV7dYlvtWJxwwxHD0PuihVNiE7TyAbQ5SWxDCB9mUYvOgroQOwYQQOKPJ8CIbE+1ETVlOoK1UC2nU3gYvg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime-types": {
      "version": "2.1.35",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/mime-types/-/mime-types-2.1.35.tgz",
      "integrity": "sha512-ZDY+bPm5zTTF+YpCrAU9nK0UgICYPT0QtT1NZWFv4s++TNkcgVaT0g6+4R2uI4MjQjzysHB1zxuWL50hzaeXiw==",
      "license": "MIT",
      "dependencies": {
        "mime-db": "1.52.0"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/minimist": {
      "version": "1.2.8",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/minimist/-/minimist-1.2.8.tgz",
      "integrity": "sha512-2yyAR8qBkN3YuheJanUpWC5U3bb5osDywNB8RzDVlDwDHbocAJveqqj1u8+SVD7jkWT4yvsHCpWqqWqAxb0zCA==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/mkdirp": {
      "version": "0.5.6",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/mkdirp/-/mkdirp-0.5.6.tgz",
      "integrity": "sha512-FP+p8RB8OWpF3YZBCrP5gtADmtXApB5AMLn+vdyA+PyxCjrCs00mjyUozssO33cwDeT3wNGdLxJ5M//YqtHAJw==",
      "license": "MIT",
      "dependencies": {
        "minimist": "^1.2.6"
      },
      "bin": {
        "mkdirp": "bin/cmd.js"
      }
    },
    "node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A==",
      "license": "MIT"
    },
    "node_modules/multer": {
      "version": "1.4.5-lts.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/multer/-/multer-1.4.5-lts.2.tgz",
      "integrity": "sha512-VzGiVigcG9zUAoCNU+xShztrlr1auZOlurXynNvO9GiWD1/mTBbUljOKY+qMeazBqXgRnjzeEgJI/wyjJUHg9A==",
      "deprecated": "Multer 1.x is impacted by a number of vulnerabilities, which have been patched in 2.x. You should upgrade to the latest 2.x version.",
      "license": "MIT",
      "dependencies": {
        "append-field": "^1.0.0",
        "busboy": "^1.0.0",
        "concat-stream": "^1.5.2",
        "mkdirp": "^0.5.4",
        "object-assign": "^4.1.1",
        "type-is": "^1.6.4",
        "xtend": "^4.0.0"
      },
      "engines": {
        "node": ">= 6.0.0"
      }
    },
    "node_modules/negotiator": {
      "version": "0.6.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/negotiator/-/negotiator-0.6.3.tgz",
      "integrity": "sha512-+EUsqGPLsM+j/zdChZjsnX51g4XrHFOIXwfnCVPGlQk/k5giakcKsuxCObBRu6DSm9opw/O6slWbJdghQM4bBg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/nodemailer": {
      "version": "6.10.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/nodemailer/-/nodemailer-6.10.1.tgz",
      "integrity": "sha512-Z+iLaBGVaSjbIzQ4pX6XV41HrooLsQ10ZWPUehGmuantvzWoDVBnmsdUcOIDM1t+yPor5pDhVlDESgOMEGxhHA==",
      "license": "MIT-0",
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/object-assign": {
      "version": "4.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/object-assign/-/object-assign-4.1.1.tgz",
      "integrity": "sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/object-inspect": {
      "version": "1.13.4",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/object-inspect/-/object-inspect-1.13.4.tgz",
      "integrity": "sha512-W67iLl4J2EXEGTbfeHCffrjDfitvLANg0UlX3wFUUSTx92KXRFegMHUVgSqE+wvhAbi4WqjGg9czysTV2Epbew==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/on-finished": {
      "version": "2.4.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/on-finished/-/on-finished-2.4.1.tgz",
      "integrity": "sha512-oVlzkg3ENAhCk2zdv7IJwd/QUD4z2RxRwpkcGY8psCVcCYZNq4wYnVWALHM+brtuJjePWiYF/ClmuDr8Ch5+kg==",
      "license": "MIT",
      "dependencies": {
        "ee-first": "1.1.1"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/parseurl": {
      "version": "1.3.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/parseurl/-/parseurl-1.3.3.tgz",
      "integrity": "sha512-CiyeOxFT/JZyN5m0z9PfXw4SCBJ6Sygz1Dpl0wqjlhDEGGBP1GnsUVEL0p63hoG1fcj3fHynXi9NYO4nWOL+qQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/path-to-regexp": {
      "version": "0.1.12",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/path-to-regexp/-/path-to-regexp-0.1.12.tgz",
      "integrity": "sha512-RA1GjUVMnvYFxuqovrEqZoxxW5NUZqbwKtYz/Tt7nXerk0LbLblQmrsgdeOxV5SFHf0UDggjS/bSeOZwt1pmEQ==",
      "license": "MIT"
    },
    "node_modules/pg": {
      "version": "8.16.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg/-/pg-8.16.3.tgz",
      "integrity": "sha512-enxc1h0jA/aq5oSDMvqyW3q89ra6XIIDZgCX9vkMrnz5DFTw/Ny3Li2lFQ+pt3L6MCgm/5o2o8HW9hiJji+xvw==",
      "license": "MIT",
      "dependencies": {
        "pg-connection-string": "^2.9.1",
        "pg-pool": "^3.10.1",
        "pg-protocol": "^1.10.3",
        "pg-types": "2.2.0",
        "pgpass": "1.0.5"
      },
      "engines": {
        "node": ">= 16.0.0"
      },
      "optionalDependencies": {
        "pg-cloudflare": "^1.2.7"
      },
      "peerDependencies": {
        "pg-native": ">=3.0.1"
      },
      "peerDependenciesMeta": {
        "pg-native": {
          "optional": true
        }
      }
    },
    "node_modules/pg-cloudflare": {
      "version": "1.2.7",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-cloudflare/-/pg-cloudflare-1.2.7.tgz",
      "integrity": "sha512-YgCtzMH0ptvZJslLM1ffsY4EuGaU0cx4XSdXLRFae8bPP4dS5xL1tNB3k2o/N64cHJpwU7dxKli/nZ2lUa5fLg==",
      "license": "MIT",
      "optional": true
    },
    "node_modules/pg-connection-string": {
      "version": "2.9.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-connection-string/-/pg-connection-string-2.9.1.tgz",
      "integrity": "sha512-nkc6NpDcvPVpZXxrreI/FOtX3XemeLl8E0qFr6F2Lrm/I8WOnaWNhIPK2Z7OHpw7gh5XJThi6j6ppgNoaT1w4w==",
      "license": "MIT"
    },
    "node_modules/pg-int8": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-int8/-/pg-int8-1.0.1.tgz",
      "integrity": "sha512-WCtabS6t3c8SkpDBUlb1kjOs7l66xsGdKpIPZsg4wR+B3+u9UAum2odSsF9tnvxg80h4ZxLWMy4pRjOsFIqQpw==",
      "license": "ISC",
      "engines": {
        "node": ">=4.0.0"
      }
    },
    "node_modules/pg-pool": {
      "version": "3.10.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-pool/-/pg-pool-3.10.1.tgz",
      "integrity": "sha512-Tu8jMlcX+9d8+QVzKIvM/uJtp07PKr82IUOYEphaWcoBhIYkoHpLXN3qO59nAI11ripznDsEzEv8nUxBVWajGg==",
      "license": "MIT",
      "peerDependencies": {
        "pg": ">=8.0"
      }
    },
    "node_modules/pg-protocol": {
      "version": "1.10.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-protocol/-/pg-protocol-1.10.3.tgz",
      "integrity": "sha512-6DIBgBQaTKDJyxnXaLiLR8wBpQQcGWuAESkRBX/t6OwA8YsqP+iVSiond2EDy6Y/dsGk8rh/jtax3js5NeV7JQ==",
      "license": "MIT"
    },
    "node_modules/pg-types": {
      "version": "2.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pg-types/-/pg-types-2.2.0.tgz",
      "integrity": "sha512-qTAAlrEsl8s4OiEQY69wDvcMIdQN6wdz5ojQiOy6YRMuynxenON0O5oCpJI6lshc6scgAY8qvJ2On/p+CXY0GA==",
      "license": "MIT",
      "dependencies": {
        "pg-int8": "1.0.1",
        "postgres-array": "~2.0.0",
        "postgres-bytea": "~1.0.0",
        "postgres-date": "~1.0.4",
        "postgres-interval": "^1.1.0"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/pgpass": {
      "version": "1.0.5",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/pgpass/-/pgpass-1.0.5.tgz",
      "integrity": "sha512-FdW9r/jQZhSeohs1Z3sI1yxFQNFvMcnmfuj4WBMUTxOrAyLMaTcE1aAMBiTlbMNaXvBCQuVi0R7hd8udDSP7ug==",
      "license": "MIT",
      "dependencies": {
        "split2": "^4.1.0"
      }
    },
    "node_modules/postgres-array": {
      "version": "2.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/postgres-array/-/postgres-array-2.0.0.tgz",
      "integrity": "sha512-VpZrUqU5A69eQyW2c5CA1jtLecCsN2U/bD6VilrFDWq5+5UIEVO7nazS3TEcHf1zuPYO/sqGvUvW62g86RXZuA==",
      "license": "MIT",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/postgres-bytea": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/postgres-bytea/-/postgres-bytea-1.0.1.tgz",
      "integrity": "sha512-5+5HqXnsZPE65IJZSMkZtURARZelel2oXUEO8rH83VS/hxH5vv1uHquPg5wZs8yMAfdv971IU+kcPUczi7NVBQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/postgres-date": {
      "version": "1.0.7",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/postgres-date/-/postgres-date-1.0.7.tgz",
      "integrity": "sha512-suDmjLVQg78nMK2UZ454hAG+OAW+HQPZ6n++TNDUX+L0+uUlLywnoxJKDou51Zm+zTCjrCl0Nq6J9C5hP9vK/Q==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/postgres-interval": {
      "version": "1.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/postgres-interval/-/postgres-interval-1.2.0.tgz",
      "integrity": "sha512-9ZhXKM/rw350N1ovuWHbGxnGh/SNJ4cnxHiM0rxE4VN41wsg8P8zWn9hv/buK00RP4WvlOyr/RBDiptyxVbkZQ==",
      "license": "MIT",
      "dependencies": {
        "xtend": "^4.0.0"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/process-nextick-args": {
      "version": "2.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/process-nextick-args/-/process-nextick-args-2.0.1.tgz",
      "integrity": "sha512-3ouUOpQhtgrbOa17J7+uxOTpITYWaGP7/AhoR3+A+/1e9skrzelGi/dXzEYyvbxubEF6Wn2ypscTKiKJFFn1ag==",
      "license": "MIT"
    },
    "node_modules/proxy-addr": {
      "version": "2.0.7",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/proxy-addr/-/proxy-addr-2.0.7.tgz",
      "integrity": "sha512-llQsMLSUDUPT44jdrU/O37qlnifitDP+ZwrmmZcoSKyLKvtZxpyV0n2/bD/N4tBAAZ/gJEdZU7KMraoK1+XYAg==",
      "license": "MIT",
      "dependencies": {
        "forwarded": "0.2.0",
        "ipaddr.js": "1.9.1"
      },
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/qs": {
      "version": "6.14.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/qs/-/qs-6.14.0.tgz",
      "integrity": "sha512-YWWTjgABSKcvs/nWBi9PycY/JiPJqOD4JA6o9Sej2AtvSGarXxKC3OQSk4pAarbdQlKAh5D4FCQkJNkW+GAn3w==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "side-channel": "^1.1.0"
      },
      "engines": {
        "node": ">=0.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/range-parser": {
      "version": "1.2.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/range-parser/-/range-parser-1.2.1.tgz",
      "integrity": "sha512-Hrgsx+orqoygnmhFbKaHE6c296J+HTAQXoxEF6gNupROmmGJRoyzfG3ccAveqCBrwr/2yxQ5BVd/GTl5agOwSg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/raw-body": {
      "version": "2.5.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/raw-body/-/raw-body-2.5.3.tgz",
      "integrity": "sha512-s4VSOf6yN0rvbRZGxs8Om5CWj6seneMwK3oDb4lWDH0UPhWcxwOWw5+qk24bxq87szX1ydrwylIOp2uG1ojUpA==",
      "license": "MIT",
      "dependencies": {
        "bytes": "~3.1.2",
        "http-errors": "~2.0.1",
        "iconv-lite": "~0.4.24",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/readable-stream": {
      "version": "2.3.8",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/readable-stream/-/readable-stream-2.3.8.tgz",
      "integrity": "sha512-8p0AUk4XODgIewSi0l8Epjs+EVnWiK7NoDIEGU0HhE7+ZyY8D1IMY7odu5lRrFXGg71L15KG8QrPmum45RTtdA==",
      "license": "MIT",
      "dependencies": {
        "core-util-is": "~1.0.0",
        "inherits": "~2.0.3",
        "isarray": "~1.0.0",
        "process-nextick-args": "~2.0.0",
        "safe-buffer": "~5.1.1",
        "string_decoder": "~1.1.1",
        "util-deprecate": "~1.0.1"
      }
    },
    "node_modules/readable-stream/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g==",
      "license": "MIT"
    },
    "node_modules/safe-buffer": {
      "version": "5.2.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/safe-buffer/-/safe-buffer-5.2.1.tgz",
      "integrity": "sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==",
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ],
      "license": "MIT"
    },
    "node_modules/safer-buffer": {
      "version": "2.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/safer-buffer/-/safer-buffer-2.1.2.tgz",
      "integrity": "sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg==",
      "license": "MIT"
    },
    "node_modules/semver": {
      "version": "7.7.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/semver/-/semver-7.7.3.tgz",
      "integrity": "sha512-SdsKMrI9TdgjdweUSR9MweHA4EJ8YxHn8DFaDisvhVlUOe4BF1tLD7GAj0lIqWVl+dPb/rExr0Btby5loQm20Q==",
      "license": "ISC",
      "bin": {
        "semver": "bin/semver.js"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/send": {
      "version": "0.19.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/send/-/send-0.19.2.tgz",
      "integrity": "sha512-VMbMxbDeehAxpOtWJXlcUS5E8iXh6QmN+BkRX1GARS3wRaXEEgzCcB10gTQazO42tpNIya8xIyNx8fll1OFPrg==",
      "license": "MIT",
      "dependencies": {
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "1.2.0",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "fresh": "~0.5.2",
        "http-errors": "~2.0.1",
        "mime": "1.6.0",
        "ms": "2.1.3",
        "on-finished": "~2.4.1",
        "range-parser": "~1.2.1",
        "statuses": "~2.0.2"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/send/node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/serve-static": {
      "version": "1.16.3",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/serve-static/-/serve-static-1.16.3.tgz",
      "integrity": "sha512-x0RTqQel6g5SY7Lg6ZreMmsOzncHFU7nhnRWkKgWuMTu5NN0DR5oruckMqRvacAN9d5w6ARnRBXl9xhDCgfMeA==",
      "license": "MIT",
      "dependencies": {
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "parseurl": "~1.3.3",
        "send": "~0.19.1"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/setprototypeof": {
      "version": "1.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/setprototypeof/-/setprototypeof-1.2.0.tgz",
      "integrity": "sha512-E5LDX7Wrp85Kil5bhZv46j8jOeboKq5JMmYM3gVGdGH8xFpPWXUMsNrlODCrkoxMEeNi/XZIwuRvY4XNwYMJpw==",
      "license": "ISC"
    },
    "node_modules/side-channel": {
      "version": "1.1.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/side-channel/-/side-channel-1.1.0.tgz",
      "integrity": "sha512-ZX99e6tRweoUXqR+VBrslhda51Nh5MTQwou5tnUDgbtyM0dBgmhEDtWGP/xbKn6hqfPRHujUNwz5fy/wbbhnpw==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "object-inspect": "^1.13.3",
        "side-channel-list": "^1.0.0",
        "side-channel-map": "^1.0.1",
        "side-channel-weakmap": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-list": {
      "version": "1.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/side-channel-list/-/side-channel-list-1.0.0.tgz",
      "integrity": "sha512-FCLHtRD/gnpCiCHEiJLOwdmFP+wzCmDEkc9y7NsYxeF4u7Btsn1ZuwgwJGxImImHicJArLP4R0yX4c2KCrMrTA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "object-inspect": "^1.13.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-map": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/side-channel-map/-/side-channel-map-1.0.1.tgz",
      "integrity": "sha512-VCjCNfgMsby3tTdo02nbjtM/ewra6jPHmpThenkTYh8pG9ucZ/1P8So4u4FGBek/BjpOVsDCMoLA/iuBKIFXRA==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.5",
        "object-inspect": "^1.13.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-weakmap": {
      "version": "1.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/side-channel-weakmap/-/side-channel-weakmap-1.0.2.tgz",
      "integrity": "sha512-WPS/HvHQTYnHisLo9McqBHOJk2FkHO/tlpvldyrnem4aeQp4hai3gythswg6p01oSoTl58rcpiFAjF2br2Ak2A==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.5",
        "object-inspect": "^1.13.3",
        "side-channel-map": "^1.0.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/split2": {
      "version": "4.2.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/split2/-/split2-4.2.0.tgz",
      "integrity": "sha512-UcjcJOWknrNkF6PLX83qcHM6KHgVKNkV62Y8a5uYDVv9ydGQVwAHMKqHdJje1VTWpljG0WYpCDhrCdAOYH4TWg==",
      "license": "ISC",
      "engines": {
        "node": ">= 10.x"
      }
    },
    "node_modules/ssf": {
      "version": "0.11.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/ssf/-/ssf-0.11.2.tgz",
      "integrity": "sha512-+idbmIXoYET47hH+d7dfm2epdOMUDjqcB4648sTZ+t2JwoyBFL/insLfB/racrDmsKB3diwsDA696pZMieAC5g==",
      "license": "Apache-2.0",
      "dependencies": {
        "frac": "~1.1.2"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/statuses": {
      "version": "2.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/statuses/-/statuses-2.0.2.tgz",
      "integrity": "sha512-DvEy55V3DB7uknRo+4iOGT5fP1slR8wQohVdknigZPMpMstaKJQWhwiYBACJE3Ul2pTnATihhBYnRhZQHGBiRw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/streamsearch": {
      "version": "1.1.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/streamsearch/-/streamsearch-1.1.0.tgz",
      "integrity": "sha512-Mcc5wHehp9aXz1ax6bZUyY5afg9u2rv5cqQI3mRrYkGC8rW2hM02jWuwjtL++LS5qinSyhj2QfLyNsuc+VsExg==",
      "engines": {
        "node": ">=10.0.0"
      }
    },
    "node_modules/string_decoder": {
      "version": "1.1.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/string_decoder/-/string_decoder-1.1.1.tgz",
      "integrity": "sha512-n/ShnvDi6FHbbVfviro+WojiFzv+s8MPMHBczVePfUpDJLwoLT0ht1l4YwBCbi8pJAveEEdnkHyPyTP/mzRfwg==",
      "license": "MIT",
      "dependencies": {
        "safe-buffer": "~5.1.0"
      }
    },
    "node_modules/string_decoder/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g==",
      "license": "MIT"
    },
    "node_modules/toidentifier": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/toidentifier/-/toidentifier-1.0.1.tgz",
      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
      "license": "MIT",
      "engines": {
        "node": ">=0.6"
      }
    },
    "node_modules/type-is": {
      "version": "1.6.18",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/type-is/-/type-is-1.6.18.tgz",
      "integrity": "sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==",
      "license": "MIT",
      "dependencies": {
        "media-typer": "0.3.0",
        "mime-types": "~2.1.24"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/typedarray": {
      "version": "0.0.6",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/typedarray/-/typedarray-0.0.6.tgz",
      "integrity": "sha512-/aCDEGatGvZ2BIk+HmLf4ifCJFwvKFNb9/JeZPMulfgFracn9QFcAf5GO8B/mweUjSoblS5In0cWhqpfs/5PQA==",
      "license": "MIT"
    },
    "node_modules/unpipe": {
      "version": "1.0.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/unpipe/-/unpipe-1.0.0.tgz",
      "integrity": "sha512-pjy2bYhSsufwWlKwPc+l3cN7+wuJlK6uz0YdJEOlQDbl6jo/YlPi4mb8agUkVC8BF7V8NuzeyPNqRksA3hztKQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/util-deprecate": {
      "version": "1.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/util-deprecate/-/util-deprecate-1.0.2.tgz",
      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
      "license": "MIT"
    },
    "node_modules/utils-merge": {
      "version": "1.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/utils-merge/-/utils-merge-1.0.1.tgz",
      "integrity": "sha512-pMZTvIkT1d+TFGvDOqodOclx0QWkkgi6Tdoa8gC8ffGAAqz9pzPTZWAybbsHHoED/ztMtkv/VoYTYyShUn81hA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4.0"
      }
    },
    "node_modules/uuid": {
      "version": "9.0.1",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/uuid/-/uuid-9.0.1.tgz",
      "integrity": "sha512-b+1eJOlsR9K8HJpow9Ok3fiWOWSIcIzXodvv0rQjVoOVNpWMpxf1wZNpt4y9h10odCNrqnYp1OBzRktckBe3sA==",
      "funding": [
        "https://github.com/sponsors/broofa",
        "https://github.com/sponsors/ctavan"
      ],
      "license": "MIT",
      "bin": {
        "uuid": "dist/bin/uuid"
      }
    },
    "node_modules/vary": {
      "version": "1.1.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/vary/-/vary-1.1.2.tgz",
      "integrity": "sha512-BNGbWLfd0eUPabhkXUVm0j8uuvREyTh5ovRa/dyow/BqAbZJyC+5fU+IzQOzmAKzYqYRAISoRhdQr3eIZ/PXqg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/wmf": {
      "version": "1.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/wmf/-/wmf-1.0.2.tgz",
      "integrity": "sha512-/p9K7bEh0Dj6WbXg4JG0xvLQmIadrner1bi45VMJTfnbVHsc7yIajZyoSoK60/dtVBs12Fm6WkUI5/3WAVsNMw==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/word": {
      "version": "0.3.0",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/word/-/word-0.3.0.tgz",
      "integrity": "sha512-OELeY0Q61OXpdUfTp+oweA/vtLVg5VDOXh+3he3PNzLGG/y0oylSOC1xRVj0+l4vQ3tj/bB1HVHv1ocXkQceFA==",
      "license": "Apache-2.0",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/xlsx": {
      "version": "0.18.5",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/xlsx/-/xlsx-0.18.5.tgz",
      "integrity": "sha512-dmg3LCjBPHZnQp5/F/+nnTa+miPJxUXB6vtk42YjBBKayDNagxGEeIdWApkYPOf3Z3pm3k62Knjzp7lMeTEtFQ==",
      "license": "Apache-2.0",
      "dependencies": {
        "adler-32": "~1.3.0",
        "cfb": "~1.2.1",
        "codepage": "~1.15.0",
        "crc-32": "~1.2.1",
        "ssf": "~0.11.2",
        "wmf": "~1.0.1",
        "word": "~0.3.0"
      },
      "bin": {
        "xlsx": "bin/xlsx.njs"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/xtend": {
      "version": "4.0.2",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/xtend/-/xtend-4.0.2.tgz",
      "integrity": "sha512-LKYU1iAXJXUgAXn9URjiu+MWhyUXHsvfp7mcuYm9dSUKK0/CjtrUwFAxD82/mCWbtLsGjFIad0wIsod4zrTAEQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.4"
      }
    },
    "node_modules/zod": {
      "version": "3.25.76",
      "resolved": "https://packages.applied-caas-gateway1.internal.api.openai.org/artifactory/api/npm/npm-public/zod/-/zod-3.25.76.tgz",
      "integrity": "sha512-gzUt/qt81nXsFGKIFcC3YnfEAx5NkunCfnDlvuBSSFS02bcXu4Lmea0AFIUwbLWxWPx3d9p8S5QoaujKcNQxcQ==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/colinhacks"
      }
    }
  }
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/Dockerfile.dev â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM node:20-alpine
WORKDIR /app

# Keep image tiny + tools for node-gyp if needed (bcryptjs is pure JS but ok)
RUN apk add --no-cache bash

COPY package*.json ./
RUN npm install

COPY . .
EXPOSE 3001

CMD ["npm","run","dev"]


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ README.md â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PRIRTEM - Carburant & Flotte (V1)

Stack: **React/Vite (.jsx)** + **Node/Express (.js)** + **PostgreSQL**

## âœ… Ce que couvre cette V1
- Auth: Login / Register / Forgot / Reset (JWT)
- RÃ´les: **DEMANDEUR / LOGISTIQUE / RAF / ADMIN**
- Import Excel intelligent (admin/logistique):
  - `Suivi carburant ...` (vÃ©hicules)
  - `Groupe electrogÃ¨ne...`
  - `Autres carburants utilisÃ©s...`
- Suivi carburant + filtres + export CSV (logistique/admin)
- Tableaux de bord (KPI)
- Demande de carburant: workflow Demandeur â†’ Logistique â†’ RAF
- Demande de voiture + Autorisation sortie: workflow Demandeur â†’ Logistique â†’ RAF
- Journal de bord voiture (rempli par Logistique depuis les infos Chauffeur):
  - Lignes trajets + **LIGNE SPÃ‰CIALE MISSION**
  - Approvisionnement carburant
  - **LOGISTIQUE_LOCK**: une fois verrouillÃ©, plus de modification

> **service/mission km**: saisi Ã  la main (pas de calcul auto), comme tu as dit.

---

## 1) DÃ©marrage en local (DEV)

### PrÃ©-requis
- Node.js 18+ (recommandÃ© 20)
- PostgreSQL 14+

### A. Backend
```bash
cd server
cp .env.example .env
npm install
npm run db:reset
npm run dev
```

âš ï¸ Si tu as dÃ©jÃ  des donnÃ©es importÃ©es et tu ne veux pas les perdre:
```bash
npm run db:seed
```
Backend: http://localhost:3001

**Comptes seed (aprÃ¨s db:reset):**
- Admin: `admin` / `admin123`
- Logistique: `logistique` / `logistique123`
- RAF: `raf` / `raf123`
- Demandeur: `demandeur` / `demandeur123`

### B. Frontend
```bash
cd client
cp .env.example .env
npm install
npm run dev
```
Frontend: http://localhost:5173

---

## 2) Docker (mode DEV sÃ©parÃ©: client + API + DB)
```bash
docker compose up --build
```

- Frontend (Vite): http://localhost:5173
- API: http://localhost:3001
- Postgres: localhost:5432 (user/pass: postgres/postgres, db: prirtem_fuel)

> Le premier lancement fait un `db:reset` automatiquement si la DB est vide.

### Docker (mode PROD, optionnel)
```bash
docker compose -f docker-compose.prod.yml up --build
```
App (prod): http://localhost:3001

---

## 3) Import Excel (admin/logistique)
Menu **Import Excel** â†’ sÃ©lectionner plusieurs `.xlsx` â†’ importer.

DÃ©tection:
- Nom de fichier contient `Suivi carburant` â†’ type VEHICLE
- contient `Groupe` / `electrogÃ¨ne` â†’ GENERATOR
- contient `Autres carburants` â†’ OTHER

Pour les fichiers vÃ©hicules:
- gestion des en-tÃªtes fusionnÃ©s (KilomÃ©trage DÃ©part/ArrivÃ©e, Plein Compteur/Litre/Montant)
- lignes "MISSION" (fusion/vert) â†’ stockÃ©es comme **is_mission=true**
- montants < 200000 Ar â†’ **is_refill=false** (non-replein)

---

## 4) Notes mÃ©tier importantes
- Ariary stockÃ© en **INTEGER**.
- Aucune â€œcorrectionâ€ automatique destructive sur les Excel: **on migre tout**, et on calcule/filtre cÃ´tÃ© app.
- Les samedis/dimanches peuvent Ãªtre vides: normal.

---

## 5) Arborescence
- `server/` API + DB
- `client/` UI React
- `docker-compose.yml` + `server/Dockerfile.dev` + `client/Dockerfile.dev` pour DEV
- `docker-compose.prod.yml` + `Dockerfile` pour PROD



â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Dockerfile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Build client
FROM node:20-alpine AS client
WORKDIR /work/client
COPY client/package.json client/package-lock.json* ./
RUN npm install
COPY client ./
RUN npm run build

# Build server
FROM node:20-alpine
WORKDIR /work/server
COPY server/package.json server/package-lock.json* ./
RUN npm install
COPY server ./

# Copy built client into server public
COPY --from=client /work/client/dist ./public

ENV NODE_ENV=production
EXPOSE 3001
CMD ["node", "src/index.js"]


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ docker-compose.yml â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: prirtem_fuel
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d prirtem_fuel"]
      interval: 5s
      timeout: 3s
      retries: 10

  server:
    image: prirtem-fuel-server-dev
    build:
      context: ./server
      dockerfile: Dockerfile.dev
    environment:
      PORT: 3001
      NODE_ENV: development
      DATABASE_URL: postgres://postgres:postgres@db:5432/prirtem_fuel
      JWT_SECRET: change_me_super_secret
      APP_URL: http://localhost:5173
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "3001:3001"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./server:/app
      - server_node_modules:/app/node_modules
    command: sh -c "npm install && node src/sql/initIfNeeded.js && npm run dev"

  client:
    image: prirtem-fuel-client-dev
    build:
      context: ./client
      dockerfile: Dockerfile.dev
    environment:
      VITE_API_URL: http://localhost:3001
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "5173:5173"
    depends_on:
      - server
    volumes:
      - ./client:/app
      - client_node_modules:/app/node_modules
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"

volumes:
  pgdata:
  server_node_modules:
  client_node_modules:


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ docker-compose.prod.yml â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
services:
  db:
    image: postgres:16
    container_name: prirtem_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: prirtem_fuel
    ports:
      - "5432:5432"
    volumes:
      - prirtem_db_data:/var/lib/postgresql/data

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: prirtem_app
    environment:
      PORT: 3001
      DATABASE_URL: postgres://postgres:postgres@db:5432/prirtem_fuel
      JWT_SECRET: change_me_super_secret
      APP_URL: http://localhost:3001
    ports:
      - "3001:3001"
    depends_on:
      - db

volumes:
  prirtem_db_data:


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/controllers/fuelRequestsController.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');

function fmtNo(seq, year) {
  return `NÂ° ${String(seq).padStart(3, '0')}/${year}`;
}

async function nextRequestNo(client) {
  const year = new Date().getFullYear();
  const { rows } = await client.query(
    `SELECT COALESCE(MAX(seq),0) AS max_seq
     FROM fuel_requests
     WHERE year=$1`,
    [year]
  );
  const nextSeq = Number(rows[0].max_seq) + 1;
  return { year, seq: nextSeq, request_no: fmtNo(nextSeq, year) };
}

const createSchema = z.object({
  request_type: z.enum(['SERVICE', 'MISSION']),
  objet: z.string().min(1),
  amount_estimated_ar: z.number().int().nonnegative(),
  amount_estimated_words: z.string().min(1),
  request_date: z.string().min(4) // YYYY-MM-DD
});

async function list(req, res) {
  const role = req.user.role;
  const userId = req.user.id;

  let sql = `SELECT fr.*, u.username AS requester_username
             FROM fuel_requests fr
             JOIN users u ON u.id=fr.requester_id`;
  const params = [];
  if (role === 'DEMANDEUR') {
    sql += ' WHERE fr.deleted_at IS NULL AND fr.requester_id=$1';
    params.push(userId);
  } else {
    sql += ' WHERE fr.deleted_at IS NULL';
  }
  sql += ' ORDER BY fr.created_at DESC LIMIT 500';

  const { rows } = await pool.query(sql, params);
  res.json({ requests: rows });
}

async function getOne(req, res) {
  const { id } = req.params;
  const role = req.user.role;

  const params = [id];
  let where = 'fr.id=$1';
  if (role === 'DEMANDEUR') {
    params.push(req.user.id);
    where += ' AND fr.requester_id=$2';
  }

  where = `fr.deleted_at IS NULL AND ${where}`;

  const { rows } = await pool.query(
    `SELECT fr.*, u.username AS requester_username
     FROM fuel_requests fr
     JOIN users u ON u.id=fr.requester_id
     WHERE ${where}`,
    params
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ request: rows[0] });
}

async function softDelete(req, res) {
  const { id } = req.params;
  if (!['ADMIN', 'LOGISTIQUE'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE fuel_requests
     SET deleted_at=now(), updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}

async function create(req, res) {
  const parsed = createSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const client = await pool.connect();
  try {
    await client.query('BEGIN');
    const { year, seq, request_no } = await nextRequestNo(client);

    const id = uuidv4();
    const data = parsed.data;
    await client.query(
      `INSERT INTO fuel_requests (
        id, year, seq, request_no, request_type, objet,
        amount_estimated_ar, amount_estimated_words, request_date,
        status, requester_id
      ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,'DRAFT',$10)`,
      [
        id,
        year,
        seq,
        request_no,
        data.request_type,
        data.objet,
        data.amount_estimated_ar,
        data.amount_estimated_words,
        data.request_date,
        req.user.id
      ]
    );
    await client.query('COMMIT');

    const { rows } = await pool.query(
      `SELECT fr.*, u.username AS requester_username
       FROM fuel_requests fr JOIN users u ON u.id=fr.requester_id
       WHERE fr.id=$1`,
      [id]
    );
    res.json({ request: rows[0] });
  } catch (e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    client.release();
  }
}

async function submit(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  if (role !== 'DEMANDEUR') return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE fuel_requests
     SET status='SUBMITTED', submitted_at=now(), updated_at=now()
     WHERE id=$1 AND requester_id=$2 AND status IN ('DRAFT','REJECTED')
     RETURNING *`,
    [id, req.user.id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ request: rows[0] });
}

async function verify(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  if (!['LOGISTIQUE', 'ADMIN'].includes(role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE fuel_requests
     SET status='VERIFIED', verified_at=now(), verified_by=$2, updated_at=now()
     WHERE id=$1 AND status='SUBMITTED'
     RETURNING *`,
    [id, req.user.id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

async function approve(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  if (!['RAF', 'ADMIN'].includes(role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE fuel_requests
     SET status='APPROVED', approved_at=now(), approved_by=$2, updated_at=now()
     WHERE id=$1 AND status='VERIFIED'
     RETURNING *`,
    [id, req.user.id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

async function reject(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  if (!['LOGISTIQUE', 'RAF', 'ADMIN'].includes(role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { reason } = req.body || {};
  const { rows } = await pool.query(
    `UPDATE fuel_requests
     SET status='REJECTED', rejected_at=now(), rejected_by=$2, reject_reason=$3, updated_at=now()
     WHERE id=$1 AND status IN ('SUBMITTED','VERIFIED')
     RETURNING *`,
    [id, req.user.id, reason || null]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}



const updateSchema = z.object({
  request_type: z.enum(['SERVICE', 'MISSION']).optional(),
  objet: z.string().min(1).optional(),
  amount_estimated_ar: z.number().int().nonnegative().optional(),
  amount_estimated_words: z.string().min(1).optional(),
  request_date: z.string().min(4).optional() // YYYY-MM-DD
});

async function update(req, res) {
  const { id } = req.params;
  const role = req.user.role;

  const parsed = updateSchema.safeParse(req.body || {});
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  const data = parsed.data;

  // Nothing to update
  if (!Object.keys(data).length) return res.json({ ok: true });

  // Permissions:
  // - Demandeur can update own request only when DRAFT or REJECTED
  // - Admin/Logistique can update any non-deleted request (used for corrections)
  const params = [id];
  let where = 'id=$1 AND deleted_at IS NULL';
  if (role === 'DEMANDEUR') {
    params.push(req.user.id);
    where += " AND requester_id=$2 AND status IN ('DRAFT','REJECTED')";
  } else if (!['ADMIN', 'LOGISTIQUE'].includes(role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const set = [];
  const values = [];
  let idx = params.length + 1

  for (const [k, v] of Object.entries(data)) {
    set.push(`${k}=$${idx++}`);
    values.push(v);
  }
  set.push(`updated_at=now()`);

  const sql = `UPDATE fuel_requests SET ${set.join(', ')} WHERE ${where} RETURNING *`;
  const { rows } = await pool.query(sql, [...params, ...values]);
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_FORBIDDEN_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

module.exports = { list, getOne, create, submit, verify, approve, reject, softDelete, update };


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/controllers/logbooksController.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');

const createSchema = z.object({
  vehicle_id: z.string().uuid(),
  period_start: z.string().min(4),
  period_end: z.string().min(4),
  objet: z.string().optional().nullable()
});

async function list(req, res) {
  const role = req.user.role;
  const params = [];
  let sql = `SELECT cl.*, v.plate, v.label
             FROM car_logbooks cl
             JOIN vehicles v ON v.id=cl.vehicle_id`;
  // RAF can read; Demandeur can read none by default
  if (role === 'DEMANDEUR') {
    return res.json({ logbooks: [] });
  }
  sql += ' ORDER BY cl.period_start DESC, v.plate ASC LIMIT 500';
  const { rows } = await pool.query(sql, params);
  res.json({ logbooks: rows });
}

async function create(req, res) {
  const parsed = createSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const id = uuidv4();
  const d = parsed.data;
  await pool.query(
    `INSERT INTO car_logbooks (id, vehicle_id, period_start, period_end, objet, status, created_by)
     VALUES ($1,$2,$3,$4,$5,'DRAFT',$6)`,
    [id, d.vehicle_id, d.period_start, d.period_end, d.objet || null, req.user.id]
  );
  const { rows } = await pool.query(
    `SELECT cl.*, v.plate, v.label
     FROM car_logbooks cl JOIN vehicles v ON v.id=cl.vehicle_id
     WHERE cl.id=$1`,
    [id]
  );
  res.json({ logbook: rows[0] });
}

async function getOne(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  if (role === 'DEMANDEUR') return res.status(403).json({ error: 'FORBIDDEN' });

  const bookRes = await pool.query(
    `SELECT cl.*, v.plate, v.label
     FROM car_logbooks cl JOIN vehicles v ON v.id=cl.vehicle_id
     WHERE cl.id=$1`,
    [id]
  );
  const book = bookRes.rows[0];
  if (!book) return res.status(404).json({ error: 'NOT_FOUND' });

  const tripsRes = await pool.query(
    `SELECT * FROM car_logbook_trips WHERE logbook_id=$1 ORDER BY row_order ASC, created_at ASC`,
    [id]
  );
  const supRes = await pool.query(
    `SELECT * FROM car_logbook_fuel_supplies WHERE logbook_id=$1 ORDER BY supply_date ASC, created_at ASC`,
    [id]
  );

  res.json({ logbook: book, trips: tripsRes.rows, supplies: supRes.rows });
}

const updateSchema = z.object({
  objet: z.string().optional().nullable(),
  service_km: z.number().int().nonnegative().optional(),
  mission_km: z.number().int().nonnegative().optional(),
  chauffeur_signature: z.string().optional().nullable()
});

async function update(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const parsed = updateSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const d = parsed.data;
  const { rows } = await pool.query(
    `UPDATE car_logbooks
     SET objet=COALESCE($2, objet),
         service_km=COALESCE($3, service_km),
         mission_km=COALESCE($4, mission_km),
         chauffeur_signature=COALESCE($5, chauffeur_signature),
         updated_at=now()
     WHERE id=$1 AND status IN ('DRAFT','SUBMITTED')
     RETURNING *`,
    [id, d.objet ?? null, d.service_km ?? null, d.mission_km ?? null, d.chauffeur_signature ?? null]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_LOCKED' });
  res.json({ logbook: rows[0] });
}

const tripSchema = z.object({
  trip_date: z.string().min(4),
  depart_time: z.string().optional().nullable(),
  depart_km: z.number().int().optional().nullable(),
  route_start: z.string().optional().nullable(),
  route_end: z.string().optional().nullable(),
  parking_place: z.string().optional().nullable(),
  parking_duration_min: z.number().int().optional().nullable(),
  arrival_time: z.string().optional().nullable(),
  arrival_km: z.number().int().optional().nullable(),
  passengers: z.string().optional().nullable(),
  emargement: z.string().optional().nullable(),
  is_mission: z.boolean().optional(),
  mission_label: z.string().optional().nullable(),
  row_order: z.number().int()
});

async function replaceTrips(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const trips = Array.isArray(req.body?.trips) ? req.body.trips : [];
  const parsed = z.array(tripSchema).safeParse(trips);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const client = await pool.connect();
  try {
    await client.query('BEGIN');
    const statusRes = await client.query('SELECT status FROM car_logbooks WHERE id=$1', [id]);
    if (!statusRes.rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
    if (statusRes.rows[0].status === 'LOCKED') return res.status(409).json({ error: 'LOCKED' });

    await client.query('DELETE FROM car_logbook_trips WHERE logbook_id=$1', [id]);
    for (const t of parsed.data) {
      await client.query(
        `INSERT INTO car_logbook_trips (
          id, logbook_id, trip_date, depart_time, depart_km, route_start, route_end,
          parking_place, parking_duration_min, arrival_time, arrival_km,
          passengers, emargement, is_mission, mission_label, row_order
        ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16)`,
        [
          uuidv4(),
          id,
          t.trip_date,
          t.depart_time || null,
          t.depart_km ?? null,
          t.route_start || null,
          t.route_end || null,
          t.parking_place || null,
          t.parking_duration_min ?? null,
          t.arrival_time || null,
          t.arrival_km ?? null,
          t.passengers || null,
          t.emargement || null,
          !!t.is_mission,
          t.mission_label || null,
          t.row_order
        ]
      );
    }
    await client.query('COMMIT');
    res.json({ ok: true });
  } catch (e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    client.release();
  }
}

const supplySchema = z.object({
  supply_date: z.string().min(4),
  compteur_km: z.number().int(),
  liters: z.number(),
  montant_ar: z.number().int().nonnegative()
});

async function replaceSupplies(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const supplies = Array.isArray(req.body?.supplies) ? req.body.supplies : [];
  const parsed = z.array(supplySchema).safeParse(supplies);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const client = await pool.connect();
  try {
    await client.query('BEGIN');
    const statusRes = await client.query('SELECT status FROM car_logbooks WHERE id=$1', [id]);
    if (!statusRes.rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
    if (statusRes.rows[0].status === 'LOCKED') return res.status(409).json({ error: 'LOCKED' });

    await client.query('DELETE FROM car_logbook_fuel_supplies WHERE logbook_id=$1', [id]);
    for (const s of parsed.data) {
      await client.query(
        `INSERT INTO car_logbook_fuel_supplies (id, logbook_id, supply_date, compteur_km, liters, montant_ar)
         VALUES ($1,$2,$3,$4,$5,$6)`,
        [uuidv4(), id, s.supply_date, s.compteur_km, s.liters, s.montant_ar]
      );
    }
    await client.query('COMMIT');
    res.json({ ok: true });
  } catch (e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    client.release();
  }
}

async function submit(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const { rows } = await pool.query(
    `UPDATE car_logbooks
     SET status='SUBMITTED', submitted_at=now(), updated_at=now()
     WHERE id=$1 AND status='DRAFT'
     RETURNING *`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ logbook: rows[0] });
}

async function lock(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const { rows } = await pool.query(
    `UPDATE car_logbooks
     SET status='LOCKED', locked_at=now(), locked_by=$2, updated_at=now()
     WHERE id=$1 AND status IN ('DRAFT','SUBMITTED')
     RETURNING *`,
    [id, req.user.id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ logbook: rows[0] });
}

module.exports = { list, create, getOne, update, replaceTrips, replaceSupplies, submit, lock };


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/controllers/notificationsController.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { pool } = require('../db');

/**
 * RÃ©cupÃ¨re les notifications pour l'utilisateur connectÃ©
 * BasÃ© sur son rÃ´le et les Ã©vÃ©nements rÃ©cents
 */
async function getNotifications(req, res) {
  const userId = req.user.id;
  const role = req.user.role;
  
  const notifications = [];
  const now = new Date();
  const last24h = new Date(now - 24 * 60 * 60 * 1000);

  try {
    // ========== NOTIFICATIONS DEMANDEUR ==========
    if (role === 'DEMANDEUR') {
      // Demandes carburant rejetÃ©es/approuvÃ©es
      const fuelRes = await pool.query(
        `SELECT id, request_no, status, rejected_at, approved_at, reject_reason
         FROM fuel_requests
         WHERE requester_id=$1 
           AND status IN ('REJECTED', 'APPROVED')
           AND (rejected_at > $2 OR approved_at > $2)
         ORDER BY updated_at DESC
         LIMIT 10`,
        [userId, last24h]
      );

      for (const r of fuelRes.rows) {
        if (r.status === 'REJECTED') {
          notifications.push({
            id: `fuel-rejected-${r.id}`,
            type: 'fuel_request_rejected',
            title: `Demande carburant ${r.request_no} rejetÃ©e`,
            message: r.reject_reason || 'Aucun motif fourni',
            link: `/app/requests/fuel`,
            timestamp: r.rejected_at,
            severity: 'error'
          });
        } else if (r.status === 'APPROVED') {
          notifications.push({
            id: `fuel-approved-${r.id}`,
            type: 'fuel_request_approved',
            title: `Demande carburant ${r.request_no} approuvÃ©e âœ…`,
            message: 'Votre demande a Ã©tÃ© validÃ©e par le RAF',
            link: `/app/requests/fuel`,
            timestamp: r.approved_at,
            severity: 'success'
          });
        }
      }

      // Demandes voiture rejetÃ©es/approuvÃ©es
      const carRes = await pool.query(
        `SELECT id, request_no, status, rejected_at, raf_at, reject_reason
         FROM car_requests
         WHERE requester_id=$1 
           AND status IN ('REJECTED', 'RAF_APPROVED')
           AND (rejected_at > $2 OR raf_at > $2)
         ORDER BY updated_at DESC
         LIMIT 10`,
        [userId, last24h]
      );

      for (const r of carRes.rows) {
        if (r.status === 'REJECTED') {
          notifications.push({
            id: `car-rejected-${r.id}`,
            type: 'car_request_rejected',
            title: `Demande voiture ${r.request_no} rejetÃ©e`,
            message: r.reject_reason || 'Aucun motif fourni',
            link: `/app/requests/car`,
            timestamp: r.rejected_at,
            severity: 'error'
          });
        } else if (r.status === 'RAF_APPROVED') {
          notifications.push({
            id: `car-approved-${r.id}`,
            type: 'car_request_approved',
            title: `Demande voiture ${r.request_no} approuvÃ©e âœ…`,
            message: 'Votre demande a reÃ§u le visa RAF',
            link: `/app/requests/car`,
            timestamp: r.raf_at,
            severity: 'success'
          });
        }
      }
    }

    // ========== NOTIFICATIONS LOGISTIQUE ==========
    if (['LOGISTIQUE', 'ADMIN'].includes(role)) {
      // Nouvelles demandes carburant Ã  valider
      const newFuel = await pool.query(
        `SELECT id, request_no, submitted_at
         FROM fuel_requests
         WHERE status='SUBMITTED' AND submitted_at > $1
         ORDER BY submitted_at DESC
         LIMIT 5`,
        [last24h]
      );

      for (const r of newFuel.rows) {
        notifications.push({
          id: `fuel-new-${r.id}`,
          type: 'fuel_request_new',
          title: `Nouvelle demande carburant ${r.request_no}`,
          message: 'En attente de validation logistique',
          link: `/app/requests/fuel/manage`,
          timestamp: r.submitted_at,
          severity: 'info'
        });
      }

      // Nouvelles demandes voiture
      const newCar = await pool.query(
        `SELECT id, request_no, created_at
         FROM car_requests
         WHERE status='SUBMITTED' AND created_at > $1
         ORDER BY created_at DESC
         LIMIT 5`,
        [last24h]
      );

      for (const r of newCar.rows) {
        notifications.push({
          id: `car-new-${r.id}`,
          type: 'car_request_new',
          title: `Nouvelle demande voiture ${r.request_no}`,
          message: 'En attente de visa logistique',
          link: `/app/requests/car/manage`,
          timestamp: r.created_at,
          severity: 'info'
        });
      }
    }

    // ========== NOTIFICATIONS RAF ==========
    if (['RAF', 'ADMIN'].includes(role)) {
      // Demandes carburant vÃ©rifiÃ©es (Ã  approuver)
      const verifiedFuel = await pool.query(
        `SELECT id, request_no, verified_at
         FROM fuel_requests
         WHERE status='VERIFIED' AND verified_at > $1
         ORDER BY verified_at DESC
         LIMIT 5`,
        [last24h]
      );

      for (const r of verifiedFuel.rows) {
        notifications.push({
          id: `fuel-verified-${r.id}`,
          type: 'fuel_request_verified',
          title: `Demande carburant ${r.request_no} Ã  viser`,
          message: 'ValidÃ©e par logistique, en attente de visa RAF',
          link: `/app/requests/fuel/raf`,
          timestamp: r.verified_at,
          severity: 'warning'
        });
      }

      // Demandes voiture approuvÃ©es par logistique
      const logisticsCar = await pool.query(
        `SELECT id, request_no, logistics_at
         FROM car_requests
         WHERE status='LOGISTICS_APPROVED' AND logistics_at > $1
         ORDER BY logistics_at DESC
         LIMIT 5`,
        [last24h]
      );

      for (const r of logisticsCar.rows) {
        notifications.push({
          id: `car-logistics-${r.id}`,
          type: 'car_request_logistics',
          title: `Demande voiture ${r.request_no} Ã  viser`,
          message: 'ValidÃ©e par logistique, en attente de visa RAF',
          link: `/app/requests/car/raf`,
          timestamp: r.logistics_at,
          severity: 'warning'
        });
      }
    }

    // Trier par timestamp dÃ©croissant
    notifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    res.json({ 
      notifications,
      count: notifications.length,
      unread: notifications.length // Simple: tout est "non lu" pour cette version
    });

  } catch (error) {
    console.error('Error fetching notifications:', error);
    res.status(500).json({ error: 'INTERNAL_ERROR', message: error.message });
  }
}

/**
 * Marquer une notification comme lue (stub pour future implÃ©mentation)
 */
async function markAsRead(req, res) {
  // Pour l'instant, on retourne juste OK
  // Future: table notifications avec user_id + read_at
  res.json({ ok: true });
}

module.exports = {
  getNotifications,
  markAsRead
};

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/controllers/metaController.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');

const vehicleSchema = z.object({
  plate: z.string().min(3),
  label: z.string().optional().nullable()
});

async function listVehicles(req, res) {
  const { rows } = await pool.query(
    'SELECT id, plate, label, is_active, created_at, updated_at FROM vehicles WHERE deleted_at IS NULL ORDER BY plate'
  );
  res.json({ vehicles: rows });
}

async function createVehicle(req, res) {
  const parsed = vehicleSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }
  const id = uuidv4();
  const { plate, label } = parsed.data;
  try {
    await pool.query('INSERT INTO vehicles (id, plate, label, is_active) VALUES ($1,$2,$3,TRUE)', [id, plate, label || null]);
  } catch (e) {
    if (String(e.message).includes('vehicles_plate_key')) return res.status(409).json({ error: 'DUPLICATE_PLATE' });
    throw e;
  }
  const { rows } = await pool.query('SELECT id, plate, label, is_active, created_at, updated_at FROM vehicles WHERE id=$1', [id]);
  res.json({ vehicle: rows[0] });
}

async function updateVehicle(req, res) {
  const { id } = req.params;
  const parsed = vehicleSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }
  const { plate, label } = parsed.data;
  const { rows } = await pool.query(
    `UPDATE vehicles
     SET plate=$2, label=$3, updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id, plate, label, is_active, created_at, updated_at`,
    [id, plate, label || null]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ vehicle: rows[0] });
}

async function deleteVehicle(req, res) {
  const { id } = req.params;
  const { rows } = await pool.query(
    `UPDATE vehicles SET deleted_at=now(), updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}

const driverSchema = z.object({
  full_name: z.string().min(3),
  phone: z.string().optional().nullable(),
  is_active: z.boolean().optional()
});

async function listDrivers(req, res) {
  const { rows } = await pool.query(
    'SELECT id, full_name, phone, is_active, created_at, updated_at FROM drivers WHERE deleted_at IS NULL ORDER BY full_name'
  );
  res.json({ drivers: rows });
}

async function createDriver(req, res) {
  const parsed = driverSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }
  const id = uuidv4();
  const { full_name, phone, is_active } = parsed.data;
  await pool.query(
    'INSERT INTO drivers (id, full_name, phone, is_active) VALUES ($1,$2,$3,$4)',
    [id, full_name, phone || null, is_active ?? true]
  );
  const { rows } = await pool.query('SELECT id, full_name, phone, is_active, created_at, updated_at FROM drivers WHERE id=$1', [id]);
  res.json({ driver: rows[0] });
}

async function updateDriver(req, res) {
  const { id } = req.params;
  const parsed = driverSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }
  const { full_name, phone, is_active } = parsed.data;
  const { rows } = await pool.query(
    `UPDATE drivers
     SET full_name=$2, phone=$3, is_active=$4, updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id, full_name, phone, is_active, created_at, updated_at`,
    [id, full_name, phone || null, is_active ?? true]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ driver: rows[0] });
}

async function deleteDriver(req, res) {
  const { id } = req.params;
  const { rows } = await pool.query(
    `UPDATE drivers SET deleted_at=now(), updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}

module.exports = {
  listVehicles,
  createVehicle,
  updateVehicle,
  deleteVehicle,
  listDrivers,
  createDriver,
  updateDriver,
  deleteDriver
};


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/controllers/importController.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const multer = require('multer');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');
const { detectExcelType } = require('../utils/excel/detectType');
const { parseVehicleFuelWorkbook } = require('../utils/excel/parseVehicleFuel');
const { parseGeneratorWorkbook } = require('../utils/excel/parseGenerator');
const { parseOtherWorkbook } = require('../utils/excel/parseOther');

const upload = multer({ storage: multer.memoryStorage(), limits: { fileSize: 25 * 1024 * 1024 } });

async function ensureVehicle(plate) {
  if (!plate) return null;
  const p = plate.replace(/\s+/g,'').toUpperCase();
  const existing = await pool.query('SELECT id FROM vehicles WHERE plate=$1', [p]);
  if (existing.rows[0]) return existing.rows[0].id;
  const id = uuidv4();
  await pool.query('INSERT INTO vehicles (id, plate) VALUES ($1,$2)', [id, p]);
  return id;
}

async function createBatch(req, res) {
  const id = uuidv4();
  await pool.query('INSERT INTO import_batches (id, created_by) VALUES ($1,$2)', [id, req.user.id]);
  res.json({ batch_id: id });
}

async function uploadAndImport(req, res) {
  // Role: ADMIN or LOGISTIQUE only
  if (!['ADMIN', 'LOGISTIQUE'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const batch_id = req.body.batch_id || uuidv4();
  await pool.query(
    'INSERT INTO import_batches (id, created_by) VALUES ($1,$2) ON CONFLICT (id) DO NOTHING',
    [batch_id, req.user.id]
  );

  const files = req.files || [];
  if (!files.length) return res.status(400).json({ error: 'NO_FILES' });

  const results = [];

  for (const f of files) {
    const file_id = uuidv4();
    await pool.query(
      `INSERT INTO import_files (id, batch_id, original_name, mime_type, size_bytes, status)
       VALUES ($1,$2,$3,$4,$5,'PROCESSING')`,
      [file_id, batch_id, f.originalname, f.mimetype, f.size]
    );

    try {
      const { type, workbook } = detectExcelType(f.buffer, f.originalname);
      let inserted = 0;

      const client = await pool.connect();
      try {
        await client.query('BEGIN');

        if (type === 'VEHICLE') {
          const { plate, records } = parseVehicleFuelWorkbook(workbook, f.originalname);
          const vehicle_id = await ensureVehicle(plate);

          // allow re-import of the same file: delete previous rows from this source
          await client.query(
            'DELETE FROM vehicle_fuel_logs WHERE source_file_name=$1',
            [f.originalname]
          );

          for (const r of records) {
            await client.query(
              `INSERT INTO vehicle_fuel_logs (
                id, vehicle_id, log_date, day_name, day_no,
                km_depart, km_arrivee, km_jour,
                km_between_refill, consumption, interval_days,
                compteur, liters, montant_ar,
                lien, chauffeur, frns,
                is_refill, is_mission, mission_label,
                source_file_name, sheet_name, row_in_sheet,
                import_batch_id, import_file_id
              ) VALUES (
                $1,$2,$3,$4,$5,
                $6,$7,$8,
                $9,$10,$11,
                $12,$13,$14,
                $15,$16,$17,
                $18,$19,$20,
                $21,$22,$23,
                $24,$25
              )`,
              [
                uuidv4(),
                vehicle_id,
                r.log_date || null,
                r.day_name || null,
                r.day_no || null,
                r.km_depart,
                r.km_arrivee,
                r.km_jour,
                r.km_between_refill,
                r.consumption,
                r.interval_days,
                r.compteur,
                r.liters,
                r.montant_ar,
                r.lien,
                r.chauffeur,
                r.frns,
                !!r.is_refill,
                !!r.is_mission,
                r.mission_label || null,
                r.source_file_name,
                r.sheet_name,
                r.row_in_sheet,
                batch_id,
                file_id
              ]
            );
            inserted += 1;
          }
        } else if (type === 'GENERATOR') {
          const { records } = parseGeneratorWorkbook(workbook, f.originalname);
          await client.query('DELETE FROM generator_fuel_logs WHERE source_file_name=$1', [f.originalname]);
          for (const r of records) {
            await client.query(
              `INSERT INTO generator_fuel_logs (
                id, log_date, liters, montant_ar,
                source_file_name, sheet_name, row_in_sheet,
                import_batch_id, import_file_id
              ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9)`,
              [uuidv4(), r.log_date, r.liters, r.montant_ar, r.source_file_name, r.sheet_name, r.row_in_sheet, batch_id, file_id]
            );
            inserted += 1;
          }
        } else if (type === 'OTHER') {
          const { records } = parseOtherWorkbook(workbook, f.originalname);
          await client.query('DELETE FROM other_fuel_logs WHERE source_file_name=$1', [f.originalname]);
          for (const r of records) {
            await client.query(
              `INSERT INTO other_fuel_logs (
                id, log_date, liters, montant_ar, lien,
                source_file_name, sheet_name, row_in_sheet,
                import_batch_id, import_file_id
              ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10)`,
              [uuidv4(), r.log_date, r.liters, r.montant_ar, r.lien, r.source_file_name, r.sheet_name, r.row_in_sheet, batch_id, file_id]
            );
            inserted += 1;
          }
        } else {
          throw new Error(`TYPE_NOT_SUPPORTED:${type}`);
        }

        await client.query(
          'UPDATE import_files SET status=$2, detected_type=$3, inserted_rows=$4, processed_at=now() WHERE id=$1',
          [file_id, 'DONE', type, inserted]
        );

        await client.query('COMMIT');
        results.push({ file: f.originalname, type, inserted });
      } catch (e) {
        await client.query('ROLLBACK');
        throw e;
      } finally {
        client.release();
      }

    } catch (e) {
      await pool.query(
        'UPDATE import_files SET status=$2, error_message=$3, processed_at=now() WHERE id=$1',
        [file_id, 'ERROR', String(e.message || e)]
      );
      results.push({ file: f.originalname, error: String(e.message || e) });
    }
  }

  res.json({ batch_id, results });
}

async function listBatches(req, res) {
  if (!['ADMIN', 'LOGISTIQUE', 'RAF'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const { rows } = await pool.query(
    `SELECT ib.id, ib.created_at, u.username AS created_by, COUNT(if2.id) AS files,
            COALESCE(SUM(if2.inserted_rows),0) AS inserted_rows
     FROM import_batches ib
     JOIN users u ON u.id=ib.created_by
     LEFT JOIN import_files if2 ON if2.batch_id=ib.id
     GROUP BY ib.id, ib.created_at, u.username
     ORDER BY ib.created_at DESC
     LIMIT 100`
  );
  res.json({ batches: rows });
}

async function listFiles(req, res) {
  if (!['ADMIN', 'LOGISTIQUE', 'RAF'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const { batch_id } = req.params;
  const { rows } = await pool.query(
    `SELECT * FROM import_files WHERE batch_id=$1 ORDER BY created_at ASC`,
    [batch_id]
  );
  res.json({ files: rows });
}

module.exports = { upload, createBatch, uploadAndImport, listBatches, listFiles };


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/controllers/fuelController.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');

function buildWhereVehicle({ vehicle_id, from, to, only_refill }) {
  const clauses = [];
  const params = [];
  
  // Toujours exclure les Ã©lÃ©ments supprimÃ©s
  clauses.push('vfl.deleted_at IS NULL');
  
  if (vehicle_id) {
    params.push(vehicle_id);
    clauses.push(`vehicle_id=$${params.length}`);
  }
  if (from) {
    params.push(from);
    clauses.push(`log_date >= $${params.length}`);
  }
  if (to) {
    params.push(to);
    clauses.push(`log_date <= $${params.length}`);
  }
  if (only_refill === 'true') {
    clauses.push(`is_refill=true`);
  }
  return { where: clauses.length ? 'WHERE ' + clauses.join(' AND ') : '', params };
}

function buildWhereDate({ from, to }) {
  const clauses = [];
  const params = [];
  
  // Toujours exclure les Ã©lÃ©ments supprimÃ©s
  clauses.push('deleted_at IS NULL');
  
  if (from) {
    params.push(from);
    clauses.push(`log_date >= $${params.length}`);
  }
  if (to) {
    params.push(to);
    clauses.push(`log_date <= $${params.length}`);
  }
  return { where: clauses.length ? 'WHERE ' + clauses.join(' AND ') : '', params };
}

// ========== LIST ==========
async function listVehicleFuel(req, res) {
  const { vehicle_id, from, to, only_refill } = req.query;
  const { where, params } = buildWhereVehicle({ vehicle_id, from, to, only_refill });
  const { rows } = await pool.query(
    `SELECT vfl.*, v.plate
     FROM vehicle_fuel_logs vfl
     JOIN vehicles v ON v.id=vfl.vehicle_id
     ${where}
     ORDER BY log_date ASC NULLS LAST, sheet_name ASC, row_in_sheet ASC
     LIMIT 5000`,
    params
  );
  res.json({ logs: rows });
}

async function listGeneratorFuel(req, res) {
  const { from, to } = req.query;
  const { where, params } = buildWhereDate({ from, to });
  const { rows } = await pool.query(
    `SELECT * FROM generator_fuel_logs ${where} ORDER BY log_date ASC NULLS LAST LIMIT 5000`,
    params
  );
  res.json({ logs: rows });
}

async function listOtherFuel(req, res) {
  const { from, to } = req.query;
  const { where, params } = buildWhereDate({ from, to });
  const { rows } = await pool.query(
    `SELECT * FROM other_fuel_logs ${where} ORDER BY log_date ASC NULLS LAST LIMIT 5000`,
    params
  );
  res.json({ logs: rows });
}

// ========== UPDATE VEHICLE FUEL (avec logique mÃ©tier) ==========
const updateVehicleSchema = z.object({
  log_date: z.string().min(4).optional(),
  km_depart: z.number().int().optional().nullable(),
  km_arrivee: z.number().int().optional().nullable(),
  km_jour: z.number().int().optional().nullable(),
  compteur: z.number().int().optional().nullable(),
  liters: z.number().optional().nullable(),
  montant_ar: z.number().int().optional().nullable(),
  lien: z.string().optional().nullable(),
  chauffeur: z.string().optional().nullable(),
  frns: z.string().optional().nullable()
});

async function updateVehicleFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  const parsed = updateVehicleSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const data = parsed.data;

  // ========== LOGIQUE MÃ‰TIER : Calcul automatique ==========
  // Si km_depart ou km_arrivee change, recalculer km_jour
  if (data.km_depart !== undefined || data.km_arrivee !== undefined) {
    const current = await pool.query('SELECT km_depart, km_arrivee FROM vehicle_fuel_logs WHERE id=$1 AND deleted_at IS NULL', [id]);
    if (current.rows[0]) {
      const kmDep = data.km_depart ?? current.rows[0].km_depart;
      const kmArr = data.km_arrivee ?? current.rows[0].km_arrivee;
      if (kmDep !== null && kmArr !== null) {
        data.km_jour = kmArr - kmDep;
      }
    }
  }

  // Si montant_ar change, recalculer is_refill (>= 200000 Ar)
  if (data.montant_ar !== undefined) {
    data.is_refill = data.montant_ar !== null && data.montant_ar >= 200000;
  }

  const fields = [];
  const values = [];
  let idx = 1;

  for (const [key, val] of Object.entries(data)) {
    fields.push(`${key}=$${idx++}`);
    values.push(val);
  }

  if (fields.length === 0) {
    return res.json({ ok: true });
  }

  values.push(id);
  const sql = `UPDATE vehicle_fuel_logs SET ${fields.join(', ')} WHERE id=$${idx} AND deleted_at IS NULL RETURNING *`;
  
  const { rows } = await pool.query(sql, values);
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ log: rows[0] });
}

// ========== SOFT DELETE VEHICLE FUEL ==========
async function softDeleteVehicleFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  
  const { rows } = await pool.query(
    'UPDATE vehicle_fuel_logs SET deleted_at=now() WHERE id=$1 AND deleted_at IS NULL RETURNING id',
    [id]
  );
  
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ ok: true, message: 'DÃ©placÃ© dans la corbeille' });
}

// ========== UPDATE GENERATOR FUEL ==========
const updateGeneratorSchema = z.object({
  log_date: z.string().min(4).optional(),
  liters: z.number().optional().nullable(),
  montant_ar: z.number().int().optional().nullable()
});

async function updateGeneratorFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  const parsed = updateGeneratorSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const data = parsed.data;
  const fields = [];
  const values = [];
  let idx = 1;

  for (const [key, val] of Object.entries(data)) {
    fields.push(`${key}=$${idx++}`);
    values.push(val);
  }

  if (fields.length === 0) {
    return res.json({ ok: true });
  }

  values.push(id);
  const sql = `UPDATE generator_fuel_logs SET ${fields.join(', ')} WHERE id=$${idx} AND deleted_at IS NULL RETURNING *`;
  
  const { rows } = await pool.query(sql, values);
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ log: rows[0] });
}

// ========== SOFT DELETE GENERATOR FUEL ==========
async function softDeleteGeneratorFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  
  const { rows } = await pool.query(
    'UPDATE generator_fuel_logs SET deleted_at=now() WHERE id=$1 AND deleted_at IS NULL RETURNING id',
    [id]
  );
  
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ ok: true, message: 'DÃ©placÃ© dans la corbeille' });
}

// ========== UPDATE OTHER FUEL ==========
const updateOtherSchema = z.object({
  log_date: z.string().min(4).optional(),
  liters: z.number().optional().nullable(),
  montant_ar: z.number().int().optional().nullable(),
  lien: z.string().optional().nullable()
});

async function updateOtherFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  const parsed = updateOtherSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const data = parsed.data;
  const fields = [];
  const values = [];
  let idx = 1;

  for (const [key, val] of Object.entries(data)) {
    fields.push(`${key}=$${idx++}`);
    values.push(val);
  }

  if (fields.length === 0) {
    return res.json({ ok: true });
  }

  values.push(id);
  const sql = `UPDATE other_fuel_logs SET ${fields.join(', ')} WHERE id=$${idx} AND deleted_at IS NULL RETURNING *`;
  
  const { rows } = await pool.query(sql, values);
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ log: rows[0] });
}

// ========== SOFT DELETE OTHER FUEL ==========
async function softDeleteOtherFuel(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const { id } = req.params;
  
  const { rows } = await pool.query(
    'UPDATE other_fuel_logs SET deleted_at=now() WHERE id=$1 AND deleted_at IS NULL RETURNING id',
    [id]
  );
  
  if (!rows[0]) {
    return res.status(404).json({ error: 'NOT_FOUND' });
  }

  res.json({ ok: true, message: 'DÃ©placÃ© dans la corbeille' });
}

// ========== REPORTS & KPIs ==========
async function reportSummary(req, res) {
  const { from, to, vehicle_id } = req.query;

  const v = buildWhereVehicle({ vehicle_id, from, to, only_refill: 'false' });
  const d = buildWhereDate({ from, to });

  const vehicleRes = await pool.query(
    `SELECT COALESCE(SUM(montant_ar),0) AS montant_ar,
            COALESCE(SUM(liters),0) AS liters,
            COUNT(*) FILTER (WHERE is_refill) AS refills
     FROM vehicle_fuel_logs vfl
     ${v.where}`,
    v.params
  );

  const genRes = await pool.query(
    `SELECT COALESCE(SUM(montant_ar),0) AS montant_ar,
            COALESCE(SUM(liters),0) AS liters,
            COUNT(*) AS count
     FROM generator_fuel_logs
     ${d.where}`,
    d.params
  );

  const otherRes = await pool.query(
    `SELECT COALESCE(SUM(montant_ar),0) AS montant_ar,
            COALESCE(SUM(liters),0) AS liters,
            COUNT(*) AS count
     FROM other_fuel_logs
     ${d.where}`,
    d.params
  );

  res.json({
    vehicle: vehicleRes.rows[0],
    generator: genRes.rows[0],
    other: otherRes.rows[0]
  });
}

async function kpiDaily(req, res) {
  const { from, to, vehicle_id } = req.query;
  const v = buildWhereVehicle({ vehicle_id, from, to, only_refill: 'false' });
  const { rows } = await pool.query(
    `SELECT log_date,
            COALESCE(SUM(liters),0) AS liters,
            COALESCE(SUM(montant_ar),0) AS montant_ar,
            COUNT(*) FILTER (WHERE is_refill) AS refills
     FROM vehicle_fuel_logs vfl
     ${v.where}
     GROUP BY log_date
     ORDER BY log_date ASC NULLS LAST`,
    v.params
  );
  res.json({ points: rows });
}

async function kpiByVehicle(req, res) {
  const { from, to } = req.query;
  const v = buildWhereVehicle({ vehicle_id: null, from, to, only_refill: 'false' });
  const { rows } = await pool.query(
    `SELECT v.plate,
            COALESCE(SUM(vfl.liters),0) AS liters,
            COALESCE(SUM(vfl.montant_ar),0) AS montant_ar,
            COUNT(*) FILTER (WHERE vfl.is_refill) AS refills
     FROM vehicle_fuel_logs vfl
     JOIN vehicles v ON v.id=vfl.vehicle_id
     ${v.where}
     GROUP BY v.plate
     ORDER BY montant_ar DESC`,
    v.params
  );
  res.json({ rows });
}

// ========== MANUAL ADD ==========
const manualVehicleSchema = z.object({
  vehicle_id: z.string().uuid(),
  log_date: z.string().min(4),
  km_depart: z.number().int().optional().nullable(),
  km_arrivee: z.number().int().optional().nullable(),
  km_jour: z.number().int().optional().nullable(),
  compteur: z.number().int().optional().nullable(),
  liters: z.number().optional().nullable(),
  montant_ar: z.number().int().optional().nullable(),
  lien: z.string().optional().nullable(),
  chauffeur: z.string().optional().nullable(),
  frns: z.string().optional().nullable()
});

async function manualAddVehicle(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const parsed = manualVehicleSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const d = parsed.data;
  const is_refill = d.montant_ar !== null && d.montant_ar !== undefined && d.montant_ar >= 200000;

  const id = uuidv4();
  await pool.query(
    `INSERT INTO vehicle_fuel_logs (
      id, vehicle_id, log_date,
      km_depart, km_arrivee, km_jour,
      compteur, liters, montant_ar,
      lien, chauffeur, frns,
      is_refill,
      source_file_name, sheet_name, row_in_sheet,
      import_batch_id, import_file_id
    ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,'MANUAL','MANUAL',0,NULL,NULL)`,
    [
      id,
      d.vehicle_id,
      d.log_date,
      d.km_depart ?? null,
      d.km_arrivee ?? null,
      d.km_jour ?? null,
      d.compteur ?? null,
      d.liters ?? null,
      d.montant_ar ?? null,
      d.lien ?? null,
      d.chauffeur ?? null,
      d.frns ?? null,
      is_refill
    ]
  );

  const { rows } = await pool.query(
    `SELECT vfl.*, v.plate
     FROM vehicle_fuel_logs vfl JOIN vehicles v ON v.id=vfl.vehicle_id
     WHERE vfl.id=$1`,
    [id]
  );
  res.json({ log: rows[0] });
}

const manualSimpleSchema = z.object({
  log_date: z.string().min(4),
  liters: z.number().optional().nullable(),
  montant_ar: z.number().int().optional().nullable(),
  lien: z.string().optional().nullable()
});

async function manualAddGenerator(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const parsed = manualSimpleSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  const d = parsed.data;
  const id = uuidv4();
  await pool.query(
    `INSERT INTO generator_fuel_logs (id, log_date, liters, montant_ar, source_file_name, sheet_name, row_in_sheet)
     VALUES ($1,$2,$3,$4,'MANUAL','MANUAL',0)`,
    [id, d.log_date, d.liters ?? null, d.montant_ar ?? null]
  );
  const { rows } = await pool.query('SELECT * FROM generator_fuel_logs WHERE id=$1', [id]);
  res.json({ log: rows[0] });
}

async function manualAddOther(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const parsed = manualSimpleSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  const d = parsed.data;
  const id = uuidv4();
  await pool.query(
    `INSERT INTO other_fuel_logs (id, log_date, liters, montant_ar, lien, source_file_name, sheet_name, row_in_sheet)
     VALUES ($1,$2,$3,$4,$5,'MANUAL','MANUAL',0)`,
    [id, d.log_date, d.liters ?? null, d.montant_ar ?? null, d.lien ?? null]
  );
  const { rows } = await pool.query('SELECT * FROM other_fuel_logs WHERE id=$1', [id]);
  res.json({ log: rows[0] });
}

// ========== EXPORT CSV ==========
function csvEscape(v) {
  if (v === null || v === undefined) return '';
  const s = String(v);
  if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
  return s;
}

async function exportCsv(req, res) {
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { type } = req.params;
  const { from, to, vehicle_id } = req.query;

  let rows = [];
  let header = [];

  if (type === 'vehicle') {
    const v = buildWhereVehicle({ vehicle_id, from, to, only_refill: 'false' });
    const q = await pool.query(
      `SELECT v.plate, vfl.*
       FROM vehicle_fuel_logs vfl
       JOIN vehicles v ON v.id=vfl.vehicle_id
       ${v.where}
       ORDER BY log_date ASC NULLS LAST, sheet_name ASC, row_in_sheet ASC`,
      v.params
    );
    rows = q.rows;
    header = [
      'plate','log_date','day_name','day_no','km_depart','km_arrivee','km_jour','km_between_refill','consumption',
      'interval_days','compteur','liters','montant_ar','lien','chauffeur','frns','is_refill','is_mission','mission_label',
      'source_file_name','sheet_name','row_in_sheet'
    ];
  } else if (type === 'generator') {
    const d = buildWhereDate({ from, to });
    const q = await pool.query(
      `SELECT * FROM generator_fuel_logs ${d.where} ORDER BY log_date ASC NULLS LAST`,
      d.params
    );
    rows = q.rows;
    header = ['log_date','liters','montant_ar','source_file_name','sheet_name','row_in_sheet'];
  } else if (type === 'other') {
    const d = buildWhereDate({ from, to });
    const q = await pool.query(
      `SELECT * FROM other_fuel_logs ${d.where} ORDER BY log_date ASC NULLS LAST`,
      d.params
    );
    rows = q.rows;
    header = ['log_date','liters','montant_ar','lien','source_file_name','sheet_name','row_in_sheet'];
  } else {
    return res.status(400).json({ error: 'BAD_TYPE' });
  }

  const lines = [];
  lines.push(header.join(','));
  for (const r of rows) {
    lines.push(header.map((h) => csvEscape(r[h])).join(','));
  }

  res.setHeader('Content-Type', 'text/csv; charset=utf-8');
  res.setHeader('Content-Disposition', `attachment; filename="${type}_export.csv"`);
  res.send(lines.join('\n'));
}

module.exports = {
  listVehicleFuel,
  listGeneratorFuel,
  listOtherFuel,
  reportSummary,
  kpiDaily,
  kpiByVehicle,
  manualAddVehicle,
  manualAddGenerator,
  manualAddOther,
  exportCsv,
  updateVehicleFuel,
  softDeleteVehicleFuel,
  updateGeneratorFuel,
  softDeleteGeneratorFuel,
  updateOtherFuel,
  softDeleteOtherFuel
};

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/controllers/carRequestsController.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { z } = require('zod');
const { v4: uuidv4 } = require('uuid');
const { pool } = require('../db');

function fmtNo(seq, year) {
  return `NÂ° ${String(seq).padStart(3, '0')}/${year}`;
}

async function nextRequestNo(client) {
  const year = new Date().getFullYear();
  const { rows } = await client.query(
    `SELECT COALESCE(MAX(seq),0) AS max_seq
     FROM car_requests
     WHERE year=$1`,
    [year]
  );
  const nextSeq = Number(rows[0].max_seq) + 1;
  return { year, seq: nextSeq, request_no: fmtNo(nextSeq, year) };
}

const createSchema = z.object({
  proposed_date: z.string().min(4),
  objet: z.string().min(1),
  itinerary: z.string().min(1),
  people: z.string().optional().nullable(),
  depart_time_wanted: z.string().optional().nullable(),
  return_time_expected: z.string().optional().nullable(),
  vehicle_hint: z.string().optional().nullable(),
  driver_hint: z.string().optional().nullable()
});

async function list(req, res) {
  const role = req.user.role;
  const userId = req.user.id;

  let sql = `SELECT cr.*, u.username AS requester_username,
                    v.plate AS vehicle_plate, d.full_name AS driver_name
             FROM car_requests cr
             JOIN users u ON u.id=cr.requester_id
             LEFT JOIN vehicles v ON v.id=cr.vehicle_id
             LEFT JOIN drivers d ON d.id=cr.driver_id`;
  const params = [];
  if (role === 'DEMANDEUR') {
    sql += ' WHERE cr.deleted_at IS NULL AND cr.requester_id=$1';
    params.push(userId);
  } else {
    sql += ' WHERE cr.deleted_at IS NULL';
  }
  sql += ' ORDER BY cr.created_at DESC LIMIT 500';
  const { rows } = await pool.query(sql, params);
  res.json({ requests: rows });
}

async function getOne(req, res) {
  const { id } = req.params;
  const role = req.user.role;
  const params = [id];
  let where = 'cr.deleted_at IS NULL AND cr.id=$1';
  if (role === 'DEMANDEUR') {
    params.push(req.user.id);
    where += ' AND cr.requester_id=$2';
  }
  const { rows } = await pool.query(
    `SELECT cr.*, u.username AS requester_username,
            v.plate AS vehicle_plate, d.full_name AS driver_name
     FROM car_requests cr
     JOIN users u ON u.id=cr.requester_id
     LEFT JOIN vehicles v ON v.id=cr.vehicle_id
     LEFT JOIN drivers d ON d.id=cr.driver_id
     WHERE ${where}`,
    params
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ request: rows[0] });
}

async function create(req, res) {
  const parsed = createSchema.safeParse(req.body);
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });

  const client = await pool.connect();
  try {
    await client.query('BEGIN');
    const { year, seq, request_no } = await nextRequestNo(client);

    const id = uuidv4();
    const d = parsed.data;
    await client.query(
      `INSERT INTO car_requests (
        id, year, seq, request_no,
        proposed_date, objet, itinerary, people,
        depart_time_wanted, return_time_expected,
        vehicle_hint, driver_hint,
        status, requester_id
      ) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,'SUBMITTED',$13)`,
      [
        id,
        year,
        seq,
        request_no,
        d.proposed_date,
        d.objet,
        d.itinerary,
        d.people || null,
        d.depart_time_wanted || null,
        d.return_time_expected || null,
        d.vehicle_hint || null,
        d.driver_hint || null,
        req.user.id
      ]
    );
    await client.query('COMMIT');

    const { rows } = await pool.query('SELECT * FROM car_requests WHERE id=$1', [id]);
    res.json({ request: rows[0] });
  } catch (e) {
    await client.query('ROLLBACK');
    throw e;
  } finally {
    client.release();
  }
}

async function logisticsApprove(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { vehicle_id, driver_id } = req.body || {};

  const { rows } = await pool.query(
    `UPDATE car_requests
     SET status='LOGISTICS_APPROVED', logistics_at=now(), logistics_by=$2,
         vehicle_id=$3, driver_id=$4, updated_at=now()
     WHERE id=$1 AND status='SUBMITTED'
     RETURNING *`,
    [id, req.user.id, vehicle_id || null, driver_id || null]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

async function rafApprove(req, res) {
  const { id } = req.params;
  if (!['RAF', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE car_requests
     SET status='RAF_APPROVED', raf_at=now(), raf_by=$2,
         authorization_date=COALESCE(authorization_date, CURRENT_DATE),
         authorization_time=COALESCE(authorization_time, CURRENT_TIME),
         updated_at=now()
     WHERE id=$1 AND status='LOGISTICS_APPROVED'
     RETURNING *`,
    [id, req.user.id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

async function reject(req, res) {
  const { id } = req.params;
  if (!['LOGISTIQUE', 'RAF', 'ADMIN'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });
  const { reason } = req.body || {};

  const { rows } = await pool.query(
    `UPDATE car_requests
     SET status='REJECTED', rejected_at=now(), rejected_by=$2, reject_reason=$3, updated_at=now()
     WHERE id=$1 AND status IN ('SUBMITTED','LOGISTICS_APPROVED')
     RETURNING *`,
    [id, req.user.id, reason || null]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

async function softDelete(req, res) {
  const { id } = req.params;
  if (!['ADMIN', 'LOGISTIQUE'].includes(req.user.role)) return res.status(403).json({ error: 'FORBIDDEN' });

  const { rows } = await pool.query(
    `UPDATE car_requests
     SET deleted_at=now(), updated_at=now()
     WHERE id=$1 AND deleted_at IS NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}



const updateSchema = z.object({
  proposed_date: z.string().min(4).optional(),
  objet: z.string().min(1).optional(),
  itinerary: z.string().min(1).optional(),
  people: z.string().min(1).optional(),
  depart_time_wanted: z.string().optional().nullable(),
  return_time_expected: z.string().optional().nullable(),
  vehicle_hint: z.string().optional().nullable(),
  driver_hint: z.string().optional().nullable()
});

async function update(req, res) {
  const { id } = req.params;
  const role = req.user.role;

  const parsed = updateSchema.safeParse(req.body || {});
  if (!parsed.success) return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  const data = parsed.data;
  if (!Object.keys(data).length) return res.json({ ok: true });

  const params = [id];
  let where = "id=$1 AND deleted_at IS NULL AND status='SUBMITTED'";

  if (role === 'DEMANDEUR') {
    params.push(req.user.id);
    where += ' AND requester_id=$2';
  } else if (!['ADMIN', 'LOGISTIQUE'].includes(role)) {
    return res.status(403).json({ error: 'FORBIDDEN' });
  }

  const set = [];
  const values = [];
  let idx = params.length + 1;

  for (const [k, v] of Object.entries(data)) {
    set.push(`${k}=$${idx++}`);
    values.push(v === '' ? null : v);
  }
  set.push('updated_at=now()');

  const sql = `UPDATE car_requests SET ${set.join(', ')} WHERE ${where} RETURNING *`;
  const { rows } = await pool.query(sql, [...params, ...values]);
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND_OR_FORBIDDEN_OR_BAD_STATUS' });
  res.json({ request: rows[0] });
}

module.exports = { list, getOne, create, update, logisticsApprove, rafApprove, reject, softDelete };


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/middleware/auth.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const jwt = require('jsonwebtoken');

function authRequired(req, res, next) {
  const header = req.headers.authorization || '';
  const [type, token] = header.split(' ');
  if (type !== 'Bearer' || !token) {
    return res.status(401).json({ error: 'UNAUTHORIZED' });
  }
  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    req.user = payload;
    return next();
  } catch (e) {
    return res.status(401).json({ error: 'INVALID_TOKEN' });
  }
}

function requireRole(...allowed) {
  return (req, res, next) => {
    const role = req.user?.role;
    if (!role || !allowed.includes(role)) {
      return res.status(403).json({ error: 'FORBIDDEN' });
    }
    return next();
  };
}

module.exports = { authRequired, requireRole };


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/controllers/authController.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const { v4: uuidv4 } = require('uuid');
const { z } = require('zod');
const { pool } = require('../db');
const { sendResetEmail } = require('../utils/mailer');

const ROLES = ['DEMANDEUR', 'LOGISTIQUE', 'RAF', 'ADMIN'];

function signToken(user) {
  return jwt.sign(
    {
      id: user.id,
      username: user.username,
      role: user.role,
      first_name: user.first_name,
      last_name: user.last_name
    },
    process.env.JWT_SECRET,
    { expiresIn: '12h' }
  );
}

const registerSchema = z.object({
  first_name: z.string().min(1),
  last_name: z.string().min(1),
  username: z.string().min(3),
  email: z.string().email(),
  role: z.enum(ROLES),
  password: z.string().min(6)
});

async function register(req, res) {
  const parsed = registerSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const { first_name, last_name, username, email, role, password } = parsed.data;
  const password_hash = await bcrypt.hash(password, 10);

  const id = uuidv4();
  try {
    await pool.query(
      `INSERT INTO users (id, first_name, last_name, username, email, role, password_hash)
       VALUES ($1,$2,$3,$4,$5,$6,$7)`,
      [id, first_name, last_name, username, email, role, password_hash]
    );
  } catch (e) {
    if (String(e.message).includes('users_username_key') || String(e.message).includes('users_email_key')) {
      return res.status(409).json({ error: 'DUPLICATE_USER' });
    }
    throw e;
  }

  const { rows } = await pool.query('SELECT id, first_name, last_name, username, email, role FROM users WHERE id=$1', [id]);
  const user = rows[0];
  const token = signToken(user);
  return res.json({ token, user });
}

const loginSchema = z.object({
  username: z.string().min(1),
  role: z.enum(ROLES),
  password: z.string().min(1)
});

async function login(req, res) {
  const parsed = loginSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  // Trim to avoid common UX issues (copy/paste spaces)
  const username = String(parsed.data.username || '').trim();
  const role = parsed.data.role;
  const password = String(parsed.data.password || '');
  const { rows } = await pool.query(
    'SELECT id, first_name, last_name, username, email, role, password_hash, is_active FROM users WHERE username=$1',
    [username]
  );
  const user = rows[0];
  if (!user || !user.is_active) {
    return res.status(401).json({ error: 'INVALID_CREDENTIALS' });
  }
  if (user.role !== role) {
    return res.status(401).json({ error: 'ROLE_MISMATCH', expectedRole: user.role });
  }
  const ok = await bcrypt.compare(password, user.password_hash);
  if (!ok) {
    return res.status(401).json({ error: 'INVALID_CREDENTIALS' });
  }

  const token = signToken(user);
  const safeUser = {
    id: user.id,
    first_name: user.first_name,
    last_name: user.last_name,
    username: user.username,
    email: user.email,
    role: user.role
  };
  return res.json({ token, user: safeUser });
}

const forgotSchema = z.object({ email: z.string().email() });

async function forgotPassword(req, res) {
  const parsed = forgotSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const { email } = parsed.data;
  const { rows } = await pool.query('SELECT id, email FROM users WHERE email=$1 AND is_active=true', [email]);
  const user = rows[0];
  // Always return OK to avoid user enumeration
  if (!user) {
    return res.json({ ok: true });
  }

  const tokenPlain = uuidv4().replace(/-/g, '') + uuidv4().replace(/-/g, '');
  const tokenHash = await bcrypt.hash(tokenPlain, 10);
  const expiresAt = new Date(Date.now() + 1000 * 60 * 30); // 30 min

  await pool.query(
    `INSERT INTO password_reset_tokens (id, user_id, token_hash, expires_at)
     VALUES ($1,$2,$3,$4)`,
    [uuidv4(), user.id, tokenHash, expiresAt]
  );

  await sendResetEmail(email, tokenPlain);
  return res.json({ ok: true });
}

const resetSchema = z.object({
  email: z.string().email(),
  token: z.string().min(10),
  new_password: z.string().min(6)
});

async function resetPassword(req, res) {
  const parsed = resetSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: 'VALIDATION', details: parsed.error.flatten() });
  }

  const { email, token, new_password } = parsed.data;
  const userRes = await pool.query('SELECT id FROM users WHERE email=$1 AND is_active=true', [email]);
  const user = userRes.rows[0];
  if (!user) {
    return res.status(400).json({ error: 'INVALID_TOKEN' });
  }

  const resetRes = await pool.query(
    `SELECT id, token_hash, expires_at, used_at
     FROM password_reset_tokens
     WHERE user_id=$1
     ORDER BY created_at DESC
     LIMIT 10`,
    [user.id]
  );

  const now = new Date();
  const resetRow = resetRes.rows.find(r => !r.used_at && new Date(r.expires_at) > now);
  if (!resetRow) {
    return res.status(400).json({ error: 'INVALID_TOKEN' });
  }

  const ok = await bcrypt.compare(token, resetRow.token_hash);
  if (!ok) {
    return res.status(400).json({ error: 'INVALID_TOKEN' });
  }

  const password_hash = await bcrypt.hash(new_password, 10);
  await pool.query('UPDATE users SET password_hash=$1 WHERE id=$2', [password_hash, user.id]);
  await pool.query('UPDATE password_reset_tokens SET used_at=now() WHERE id=$1', [resetRow.id]);

  return res.json({ ok: true });
}

async function me(req, res) {
  const { rows } = await pool.query(
    'SELECT id, first_name, last_name, username, email, role FROM users WHERE id=$1',
    [req.user.id]
  );
  return res.json({ user: rows[0] });
}

module.exports = { ROLES, register, login, forgotPassword, resetPassword, me };


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ server/src/controllers/trashController.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const { pool } = require('../db');

// ========== ENTITÃ‰S AVEC fuel_logs ==========
const ENTITIES = {
  vehicles: {
    table: 'vehicles',
    select: 'id, plate, label, is_active, deleted_at'
  },
  drivers: {
    table: 'drivers',
    select: 'id, full_name, phone, is_active, deleted_at'
  },
  fuel_requests: {
    table: 'fuel_requests',
    select: 'id, request_no, request_date, request_type, objet, amount_estimated_ar, status, deleted_at'
  },
  car_requests: {
    table: 'car_requests',
    select: 'id, request_no, proposed_date, objet, status, deleted_at'
  },
  // ========== NOUVEAUX: FUEL LOGS ==========
  vehicle_fuel_logs: {
    table: 'vehicle_fuel_logs',
    select: 'id, log_date, km_depart, km_arrivee, montant_ar, deleted_at'
  },
  generator_fuel_logs: {
    table: 'generator_fuel_logs',
    select: 'id, log_date, liters, montant_ar, deleted_at'
  },
  other_fuel_logs: {
    table: 'other_fuel_logs',
    select: 'id, log_date, liters, montant_ar, lien, deleted_at'
  }
};

function getEntity(name) {
  const ent = ENTITIES[name];
  if (!ent) {
    const err = new Error('UNKNOWN_ENTITY');
    err.statusCode = 400;
    throw err;
  }
  return ent;
}

async function list(req, res) {
  const { entity } = req.params;
  const ent = getEntity(entity);

  const { rows } = await pool.query(
    `SELECT ${ent.select}
     FROM ${ent.table}
     WHERE deleted_at IS NOT NULL
     ORDER BY deleted_at DESC
     LIMIT 500`
  );

  res.json({ items: rows });
}

async function restore(req, res) {
  const { entity, id } = req.params;
  const ent = getEntity(entity);

  const { rows } = await pool.query(
    `UPDATE ${ent.table}
     SET deleted_at=NULL
     WHERE id=$1 AND deleted_at IS NOT NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}

async function hardDelete(req, res) {
  const { entity, id } = req.params;
  const ent = getEntity(entity);

  const { rows } = await pool.query(
    `DELETE FROM ${ent.table}
     WHERE id=$1 AND deleted_at IS NOT NULL
     RETURNING id`,
    [id]
  );
  if (!rows[0]) return res.status(404).json({ error: 'NOT_FOUND' });
  res.json({ ok: true });
}

module.exports = { list, restore, hardDelete };

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/vite.config.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    // DEV convenience: allow the frontend to call /api/* without CORS headaches.
    // If VITE_API_URL is not set, the app falls back to same-origin /api calls.
    proxy: {
      '/api': {
        target: 'http://localhost:3001',
        changeOrigin: true,
      },
    },
  },
  build: {
    outDir: 'dist',
  }
});


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/utils/api.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/utils/api.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * CORRECTIF APPLIQUÃ‰ : Gestion robuste du parsing JSON et des erreurs HTTP.
 */
const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:3001';

export function getApiUrl() {
  return API_URL;
}

/**
 * Helper interne pour parser la rÃ©ponse
 */
async function parseResponse(res) {
  const text = await res.text();
  try {
    return text ? JSON.parse(text) : null;
  } catch (e) {
    // Si ce n'est pas du JSON, on renvoie le texte brut (utile pour debug 500/502)
    return { raw: text, error: 'INVALID_JSON_RESPONSE' };
  }
}

export async function apiFetch(path, { token, method = 'GET', body, headers } = {}) {
  const h = {
    'Content-Type': 'application/json',
    ...(headers || {})
  };

  if (token) {
    h.Authorization = `Bearer ${token}`;
  }

  const config = {
    method,
    headers: h,
    body: body ? JSON.stringify(body) : undefined
  };

  let res;
  try {
    res = await fetch(`${API_URL}${path}`, config);
  } catch (networkErr) {
    // Erreur rÃ©seau (serveur Ã©teint, pas d'internet)
    throw new Error('Erreur rÃ©seau : Impossible de joindre le serveur.');
  }

  const data = await parseResponse(res);

  if (!res.ok) {
    // On construit une erreur propre
    const msg = data?.message || data?.error || `Erreur HTTP ${res.status}`;
    const err = new Error(msg);
    err.status = res.status;
    err.payload = data;
    throw err;
  }

  return data;
}

export async function apiUpload(path, { token, formData, method = 'POST' }) {
  const headers = {};
  if (token) {
    headers.Authorization = `Bearer ${token}`;
  }

  // Note: Ne PAS mettre 'Content-Type': 'multipart/form-data', 
  // le navigateur le fait automatiquement avec le boundary.

  let res;
  try {
    res = await fetch(`${API_URL}${path}`, {
      method,
      headers,
      body: formData
    });
  } catch (networkErr) {
    throw new Error('Erreur rÃ©seau lors de l\'upload.');
  }

  const data = await parseResponse(res);

  if (!res.ok) {
    const msg = data?.message || data?.error || `Upload Ã©chouÃ© (${res.status})`;
    const err = new Error(msg);
    err.status = res.status;
    err.payload = data;
    throw err;
  }

  return data;
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/styles.css â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
:root{
  --bg: #f7f7fb;
  --surface: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --border: rgba(15, 23, 42, .12);
  --shadow: 0 1px 2px rgba(0,0,0,.04), 0 12px 38px rgba(15,23,42,.10);
  --shadow-sm: 0 1px 2px rgba(0,0,0,.05);
  --radius: 14px;
  --radius-sm: 10px;

  --primary: #111827;
  --primary-2: #0b1220;
  --primary-3: #0f172a;

  --accent: #2563eb;
  --ring: rgba(37, 99, 235, .35);

  --danger: #ef4444;
  --warning: #f59e0b;
  --success: #10b981;

  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  color: var(--text);
  background: var(--bg);
}

*{ box-sizing: border-box; }
html, body{ height: 100%; }
body{ margin: 0; background: var(--bg); }

a{ color: inherit; text-decoration: none; }
a:hover{ text-decoration: underline; }

::selection{ background: rgba(37,99,235,.18); }

/* ===================== LAYOUT ===================== */
.layout{
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
}

.main{
  min-width: 0;
}

.container{
  max-width: 1280px;
  margin: 0 auto;
  padding: 18px;
}

/* ===================== SIDEBAR ===================== */
.sidebar{
  position: sticky;
  top: 0;
  height: 100vh;
  background: linear-gradient(180deg, var(--primary-2), var(--primary));
  color: #fff;
  border-right: 1px solid rgba(255,255,255,.10);
  display: flex;
  flex-direction: column;
}

.sidebarHeader{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 16px 16px 12px;
}

.brand{
  display:flex;
  flex-direction: column;
  line-height: 1.1;
}
.brand b{ font-size: 14px; letter-spacing: .3px; }
.brand span{ font-size: 12px; color: rgba(255,255,255,.70); }

.sidebar__user{
  padding: 12px 16px;
  border-top: 1px solid rgba(255,255,255,.10);
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.sidebar__userName{ font-weight: 800; font-size: 13px; }
.sidebar__userRole{ font-size: 12px; color: rgba(255,255,255,.72); margin-top: 3px; }

.sidebar__navWrap{
  padding: 10px;
  overflow: auto;
  flex: 1;
}
.sidebar__nav{
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.navItem{
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 10px 10px;
  border-radius: 12px;
  color: rgba(255,255,255,.86);
  text-decoration: none !important;
  transition: background .15s ease, transform .08s ease;
}
.navItem:hover{
  background: rgba(255,255,255,.08);
}
.navItem:active{
  transform: translateY(1px);
}
.navItem.active{
  background: rgba(255,255,255,.14);
  color: #fff;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
}

.sidebarFooter{
  padding: 12px 16px 16px;
  border-top: 1px solid rgba(255,255,255,.10);
}

.sidebarOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 9998;
}

/* mobile off-canvas */
@media (max-width: 900px){
  .layout{ grid-template-columns: 1fr; }
  .sidebar{
    position: fixed;
    left: 0;
    top: 0;
    transform: translateX(-105%);
    transition: transform .18s ease;
    width: 280px;
    z-index: 9999;
  }
  .sidebar.open{ transform: translateX(0); }
}

/* ===================== TOPBAR ===================== */
.topbar{
  position: sticky;
  top: 0;
  z-index: 50;
  backdrop-filter: blur(10px);
  background: rgba(247,247,251,.78);
  border-bottom: 1px solid var(--border);
  padding: 12px 18px;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
}

.topbarLeft{
  display:flex;
  align-items:center;
  gap: 10px;
  min-width: 0;
}

.topbarTitle{
  font-weight: 900;
  font-size: 14px;
  letter-spacing: .2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.topbarRight{
  display:flex;
  align-items:center;
  gap: 10px;
}

.topbar-logout{ display: none; }
@media (max-width: 900px){
  .topbar-logout{ display: inline-flex; }
}

/* ===================== CARDS / TYPO ===================== */
h1,h2,h3{ margin: 0 0 10px 0; letter-spacing: .2px; }
h2{ font-size: 18px; }
h3{ font-size: 15px; }

.card{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow-sm);
}

.muted{ color: var(--muted); }
.error{ color: #b91c1c; font-weight: 600; }

/* ===================== FORMS ===================== */
.form{ display:flex; flex-direction: column; gap: 10px; }
.field{ display:flex; flex-direction: column; gap: 6px; min-width: 220px; }

.label{
  font-size: 12px;
  font-weight: 800;
  color: var(--primary-3);
}

.row{ display:flex; gap: 12px; align-items:center; }
.row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.rowBetween{ display:flex; justify-content: space-between; gap: 12px; align-items:center; flex-wrap: wrap; }

input, select, textarea, .input{
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(15,23,42,.14);
  outline: none;
  background: #fff;
  transition: border-color .12s ease, box-shadow .12s ease, transform .08s ease;
}

textarea{ min-height: 90px; resize: vertical; }

input:focus, select:focus, textarea:focus, .input:focus{
  border-color: rgba(37,99,235,.55);
  box-shadow: 0 0 0 4px var(--ring);
}

input:disabled, select:disabled, textarea:disabled{
  background: rgba(15,23,42,.04);
  cursor: not-allowed;
}

/* ===================== BUTTONS ===================== */
.btn, button{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid transparent;
  background: var(--primary);
  color: #fff;
  cursor: pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
  font-weight: 700;
}

.btn:hover, button:hover{ background: #0b1220; }
.btn:active, button:active{ transform: translateY(1px); }
.btn:disabled, button:disabled{ opacity: .6; cursor: not-allowed; transform: none; }

.btn-sm{ padding: 8px 10px; border-radius: 10px; font-size: 13px; }

.btn-outline{
  background: transparent;
  border-color: rgba(15,23,42,.20);
  color: var(--primary-3);
}
.btn-outline:hover{ background: rgba(15,23,42,.04); }

.btn-secondary{
  background: rgba(37,99,235,.10);
  color: #1d4ed8;
  border-color: rgba(37,99,235,.20);
}
.btn-secondary:hover{ background: rgba(37,99,235,.14); }

.btn-danger{
  background: rgba(239,68,68,.12);
  color: #b91c1c;
  border-color: rgba(239,68,68,.22);
}
.btn-danger:hover{ background: rgba(239,68,68,.16); }

.btn-primary{ background: var(--primary); color: #fff; }
.btn-ghost{
  background: rgba(255,255,255,.10);
  border-color: rgba(255,255,255,.14);
  color: #fff;
}
.btn-ghost:hover{ background: rgba(255,255,255,.14); }

/* small icon button (hamburger, close, bell) */
.iconBtn{
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 12px;
  background: rgba(15,23,42,.06);
  border: 1px solid rgba(15,23,42,.10);
  color: var(--primary-3);
}
.iconBtn:hover{ background: rgba(15,23,42,.10); }

/* ===================== TABLES ===================== */
.tableWrap{
  width: 100%;
  overflow: auto;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--surface);
  box-shadow: var(--shadow-sm);
}

.table{
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  min-width: 760px;
}

.table th, .table td{
  padding: 12px 12px;
  border-bottom: 1px solid rgba(15,23,42,.08);
  vertical-align: top;
}
.table th{
  position: sticky;
  top: 0;
  background: rgba(247,247,251,.92);
  backdrop-filter: blur(10px);
  text-align: left;
  font-size: 12px;
  font-weight: 900;
  color: rgba(15,23,42,.80);
  letter-spacing: .18px;
}

.table tbody tr:hover{
  background: rgba(37,99,235,.04);
}

/* ===================== BADGES ===================== */
.badge{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.14);
  background: rgba(15,23,42,.03);
  font-size: 12px;
  font-weight: 700;
}

.badge-warn{ background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.22); color: #92400e; }
.badge-info{ background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.22); color: #1d4ed8; }
.badge-ok{ background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.22); color: #047857; }
.badge-bad{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.22); color: #b91c1c; }

/* ===================== ALERTS / NOTICES ===================== */
.alert{
  background: rgba(59,130,246,.08);
  border: 1px solid rgba(59,130,246,.18);
  color: #1d4ed8;
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 600;
}
.alert-danger{
  background: rgba(239,68,68,.08);
  border-color: rgba(239,68,68,.18);
  color: #b91c1c;
}
.notice{
  background: rgba(15,23,42,.04);
  border: 1px dashed rgba(15,23,42,.18);
  color: rgba(15,23,42,.78);
  padding: 10px 12px;
  border-radius: 12px;
}

/* ===================== TABS ===================== */
.tabs{ display:flex; gap: 8px; flex-wrap: wrap; }
.tab{
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.14);
  cursor: pointer;
  background: #fff;
  font-weight: 700;
}
.tab.active{
  background: var(--primary);
  color: #fff;
  border-color: var(--primary);
}

/* ===================== MODAL ===================== */
.modalOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 18px;
  z-index: 9999;
  animation: fadeIn .15s ease-out;
}
.modal{
  width: 720px;
  max-width: 95vw;
  max-height: 85vh;
  overflow: auto;
  background: #fff;
  border-radius: 16px;
  border: 1px solid rgba(15,23,42,.14);
  box-shadow: 0 25px 70px rgba(0,0,0,.28);
  animation: popIn .15s ease-out;
}
.modalHeader{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  padding: 14px 14px 10px;
  border-bottom: 1px solid rgba(15,23,42,.10);
}
.modalTitle{ font-size: 14px; font-weight: 900; }
.modalBody{ padding: 14px; }

@keyframes fadeIn{ from{ opacity: 0; } to{ opacity: 1; } }
@keyframes popIn{ from{ transform: translateY(8px) scale(.98); opacity: 0; } to{ transform: translateY(0) scale(1); opacity: 1; } }

/* ===================== TOASTS ===================== */
.toastHost{
  position: fixed;
  top: 72px;
  right: 18px;
  z-index: 10000;
  display:flex;
  flex-direction: column;
  gap: 10px;
}
.toast{
  background: #0b1220;
  color: #fff;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 14px;
  padding: 12px 14px;
  min-width: 240px;
  box-shadow: 0 18px 55px rgba(0,0,0,.25);
  animation: toastIn .18s ease-out;
}
.toastRow{ display:flex; gap: 10px; align-items:flex-start; }
.toastDot{
  width: 10px;
  height: 10px;
  border-radius: 999px;
  margin-top: 4px;
  flex-shrink: 0;
}
.toastTitle{ font-weight: 900; font-size: 13px; margin-bottom: 2px; }
.toastMsg{ font-size: 12px; color: rgba(255,255,255,.78); }
.toastTime{ font-size: 11px; color: rgba(255,255,255,.55); margin-top: 6px; }
@keyframes toastIn{ from{ transform: translateY(-6px); opacity: 0; } to{ transform: translateY(0); opacity: 1; } }

/* ===================== PRINT ===================== */
.printWrap, .printPage{ background: var(--bg); min-height: 100vh; }
.paper{
  background: #fff;
  width: 210mm;
  min-height: 297mm;
  margin: 10px auto;
  padding: 14mm;
  border: 1px solid rgba(15,23,42,.10);
  box-shadow: var(--shadow);
}
.paperHeader{ display:flex; justify-content: space-between; }
.paperTitle{ text-align: center; margin: 8px 0 16px; font-size: 22px; font-weight: 900; }

.printToolbar, .printBar{
  display:flex;
  gap: 10px;
  justify-content: center;
  padding: 12px;
}

.printTwoCol{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10mm;
  width: 210mm;
  margin: 10px auto;
}
.printBox{
  background: #fff;
  border: 1px solid rgba(15,23,42,.10);
  padding: 12mm;
}
.printHeader{ display:flex; justify-content: space-between; }
.printField{
  display:flex;
  justify-content: space-between;
  gap: 16px;
  padding: 6px 0;
  border-bottom: 1px dashed rgba(15,23,42,.16);
}
.printSignTable{
  width: 100%;
  border-collapse: collapse;
  margin-top: 14px;
}
.printSignTable th, .printSignTable td{
  border: 1px solid var(--primary);
  padding: 10px;
}

@media print{
  .noPrint{ display:none !important; }
  body{ background: #fff; }
  .paper, .printTwoCol{ margin: 0; border: none; box-shadow: none; }
}

/* ===================== HELPERS ===================== */
hr{ border: none; border-top: 1px solid rgba(15,23,42,.10); margin: 16px 0; }
.grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media (max-width: 900px){
  .grid2{ grid-template-columns: 1fr; }
}

/* reduce motion */
@media (prefers-reduced-motion: reduce){
  *{ transition: none !important; animation: none !important; }
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/Meta.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';

function InlineRowEditor({ row, columns, onSave, onDelete }) {
  const [editing, setEditing] = useState(false);
  const [draft, setDraft] = useState(row);

  useEffect(() => {
    setDraft(row);
  }, [row]);

  const setField = (key, value) => {
    setDraft((prev) => ({ ...prev, [key]: value }));
  };

  const doSave = async () => {
    await onSave(draft);
    setEditing(false);
  };

  return (
    <tr>
      {columns.map((c) => (
        <td key={c.key}>
          {editing && c.editable ? (
            c.type === 'checkbox' ? (
              <input
                type="checkbox"
                checked={!!draft[c.key]}
                onChange={(e) => setField(c.key, e.target.checked)}
              />
            ) : (
              <input
                className="input"
                value={draft[c.key] ?? ''}
                onChange={(e) => setField(c.key, e.target.value)}
              />
            )
          ) : (
            <span>{row[c.key] ?? ''}</span>
          )}
        </td>
      ))}

      <td style={{ whiteSpace: 'nowrap' }}>
        {!editing ? (
          <>
            <button className="btn btn-outline" onClick={() => setEditing(true)}>
              Modifier
            </button>
            <span style={{ display: 'inline-block', width: 8 }} />
            <button className="btn btn-outline" onClick={() => onDelete(row)}>
              Supprimer
            </button>
          </>
        ) : (
          <>
            <button className="btn" onClick={doSave}>
              Valider
            </button>
            <span style={{ display: 'inline-block', width: 8 }} />
            <button
              className="btn btn-outline"
              onClick={() => {
                setDraft(row);
                setEditing(false);
              }}
            >
              Annuler
            </button>
          </>
        )}
      </td>
    </tr>
  );
}

function Section({ title, fetchUrl, createUrl, updateUrl, deleteUrl, columns, createInitial }) {
  const { token } = useAuth();
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);

  const [create, setCreate] = useState(createInitial);

  async function load() {
    setLoading(true);
    setErr(null);
    try {
      const data = await apiFetch(fetchUrl, { token });
      const key = Object.keys(data).find((k) => Array.isArray(data[k]));
      setItems(key ? data[key] : []);
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const createField = (k, v) => setCreate((p) => ({ ...p, [k]: v }));

  const doCreate = async () => {
    setErr(null);
    try {
      await apiFetch(createUrl, { method: 'POST', token, body: create });
      setCreate(createInitial);
      await load();
    } catch (e) {
      setErr(String(e.message || e));
    }
  };

  const doSave = async (row) => {
    await apiFetch(updateUrl(row.id), { method: 'PUT', token, body: row });
    await load();
  };

  const doDelete = async (row) => {
    const ok = confirm(`Envoyer dans la corbeille ?\n\n${title}: ${row.id}`);
    if (!ok) return;
    await apiFetch(deleteUrl(row.id), { method: 'DELETE', token });
    await load();
  };

  return (
    <div className="card" style={{ marginBottom: 16 }}>
      <div className="row" style={{ justifyContent: 'space-between' }}>
        <h2 style={{ margin: 0 }}>{title}</h2>
        <button className="btn btn-outline" onClick={load}>
          Recharger
        </button>
      </div>

      {err && <div className="muted" style={{ color: '#b91c1c' }}>{err}</div>}

      <div className="card" style={{ marginTop: 12, background: '#fafafa' }}>
        <div className="row" style={{ alignItems: 'flex-end' }}>
          {columns
            .filter((c) => c.creatable)
            .map((c) => (
              <div key={c.key} className="field" style={{ minWidth: 200 }}>
                <div className="label">{c.label}</div>
                {c.type === 'checkbox' ? (
                  <input
                    type="checkbox"
                    checked={!!create[c.key]}
                    onChange={(e) => createField(c.key, e.target.checked)}
                  />
                ) : (
                  <input
                    className="input"
                    value={create[c.key] ?? ''}
                    onChange={(e) => createField(c.key, e.target.value)}
                  />
                )}
              </div>
            ))}
          <button className="btn" onClick={doCreate}>
            Ajouter
          </button>
        </div>
      </div>

      <div style={{ overflow: 'auto', marginTop: 12 }}>
        <table className="table">
          <thead>
            <tr>
              {columns.map((c) => (
                <th key={c.key}>{c.label}</th>
              ))}
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td colSpan={columns.length + 1} className="muted">
                  Chargement...
                </td>
              </tr>
            ) : items.length ? (
              items.map((row) => (
                <InlineRowEditor
                  key={row.id}
                  row={row}
                  columns={columns}
                  onSave={doSave}
                  onDelete={doDelete}
                />
              ))
            ) : (
              <tr>
                <td colSpan={columns.length + 1} className="muted">
                  Aucune donnÃ©e
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

export default function Meta() {
  return (
    <div>
      <h1 style={{ marginTop: 0 }}>VÃ©hicules & Chauffeurs</h1>

      <Section
        title="VÃ©hicules"
        fetchUrl="/api/meta/vehicles"
        createUrl="/api/meta/vehicles"
        updateUrl={(id) => `/api/meta/vehicles/${id}`}
        deleteUrl={(id) => `/api/meta/vehicles/${id}`}
        createInitial={{ plate: '', label: '' }}
        columns={[
          { key: 'plate', label: 'Immatriculation', editable: true, creatable: true },
          { key: '', label: 'Marque et Type', editable: true, creatable: true },
          { key: '', label: 'Source Ã©nergie', editable: true, creatable: true },
          { key: '', label: 'Nombre de place', editable: true, creatable: true },
          { key: 'label', label: 'LibellÃ©', editable: true, creatable: true },
          { key: 'is_active', label: 'Actif', editable: false, creatable: false }
        ]}
      />

      <Section
        title="Chauffeurs"
        fetchUrl="/api/meta/drivers"
        createUrl="/api/meta/drivers"
        updateUrl={(id) => `/api/meta/drivers/${id}`}
        deleteUrl={(id) => `/api/meta/drivers/${id}`}
        createInitial={{ full_name: '', phone: '', is_active: true }}
        columns={[
          { key: 'full_name', label: 'Nom complet', editable: true, creatable: true },
          { key: 'phone', label: 'TÃ©lÃ©phone', editable: true, creatable: true },
          { key: '', label: 'Voiture assigner', editable: true, creatable: true },
          { key: 'is_active', label: 'Actif', editable: true, creatable: true, type: 'checkbox' }
        ]}
      />

      <div className="muted">
        Suppression = envoi dans la corbeille. Pour supprimer dÃ©finitivement: menu Corbeille.
      </div>
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/Login.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// client/src/pages/Login.jsx
import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';

const ROLES = [
  { value: 'DEMANDEUR', label: 'Demandeur' },
  { value: 'LOGISTIQUE', label: 'Logistique' },
  { value: 'RAF', label: 'RAF' },
  { value: 'ADMIN', label: 'Admin' }
];

export default function Login() {
  const navigate = useNavigate();
  const { setSession } = useAuth();
  const [username, setUsername] = useState('');
  const [role, setRole] = useState('DEMANDEUR');
  const [password, setPassword] = useState('');
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  async function onSubmit(e) {
    e.preventDefault();
    setError(null);
    setLoading(true);
    try {
      const data = await apiFetch('/api/auth/login', {
        method: 'POST',
        body: { username, role, password }
      });
      setSession(data.token, data.user);
      navigate('/app');
    } catch (err) {
      // (Gestion d'erreur identique Ã  l'original)
      setError(err.message || 'Erreur de connexion');
    } finally {
      setLoading(false);
    }
  }

  return (
    <div style={{
      minHeight: '100vh',
      display: 'flex', alignItems: 'center', justifyContent: 'center',
      background: 'linear-gradient(135deg, #4f46e5 0%, #0f172a 100%)',
      padding: '20px'
    }}>
      <div className="card" style={{ 
        width: '100%', maxWidth: '420px', 
        padding: '40px', 
        borderRadius: '24px',
        boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)' 
      }}>
        <div style={{ textAlign: 'center', marginBottom: '32px' }}>
          <div style={{ width: 60, height: 60, background: '#4f46e5', borderRadius: 16, margin: '0 auto 16px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 32, color: 'white', fontWeight: 800 }}>P</div>
          <h2 style={{ fontSize: '24px', marginBottom: '8px' }}>Bienvenue</h2>
          <p className="muted">Connectez-vous Ã  PRIRTEM Flotte</p>
        </div>

        {error && <div style={{ background: '#fee2e2', color: '#991b1b', padding: '12px', borderRadius: '8px', marginBottom: '20px', fontSize: '14px', textAlign: 'center' }}>{error}</div>}

        <form onSubmit={onSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
          <div>
            <label className="label">Nom d'utilisateur</label>
            <input className="input" style={{ padding: '12px' }} value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Votre identifiant" />
          </div>

          <div>
            <label className="label">RÃ´le</label>
            <select className="input" style={{ padding: '12px' }} value={role} onChange={(e) => setRole(e.target.value)}>
              {ROLES.map((r) => (
                <option key={r.value} value={r.value}>{r.label}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="label">Mot de passe</label>
            <input className="input" style={{ padding: '12px' }} type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>

          <button className="btn" style={{ marginTop: '8px', padding: '14px', fontSize: '1rem' }} disabled={loading}>
            {loading ? 'Connexion...' : 'Se connecter'}
          </button>
        </form>

        <div style={{ marginTop: '24px', textAlign: 'center', fontSize: '14px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
          <Link to="/forgot" style={{ color: '#4f46e5' }}>Mot de passe oubliÃ© ?</Link>
          <div style={{ color: '#94a3b8' }}>Pas encore de compte ? <Link to="/register" style={{ color: '#4f46e5', fontWeight: '600' }}>CrÃ©er un compte</Link></div>
        </div>
      </div>
    </div>
  );
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/Logbooks.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useMemo, useState } from 'react';
import { Link } from 'react-router-dom';
import Modal from '../components/Modal.jsx';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

function fmtDate(d) {
  if (!d) return '';
  const s = String(d);
  // ISO -> YYYY-MM-DD...
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (m) return `${m[3]}/${m[2]}/${m[1]}`;
  return s;
}

function toYmd(s) {
  if (!s) return null;
  // accept "YYYY-MM-DD" or iso string
  const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})/);
  return m ? `${m[1]}-${m[2]}-${m[3]}` : null;
}

export default function Logbooks() {
  const { token, user } = useAuth();
  const role = user?.role;

  const [vehicles, setVehicles] = useState([]);
  const [logbooks, setLogbooks] = useState([]);

  const [form, setForm] = useState({ vehicle_id: '', period_start: '', period_end: '', objet: '' });

  // ğŸ” filtre UI
  const [filter, setFilter] = useState({
    vehicle_id: '',
    status: '',
    date_from: '',
    date_to: '',
    q: ''
  });

  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);
  const [view, setView] = useState(null); // {loading, book, trips, supplies}

  async function load() {
    setError(null);
    const v = await apiFetch('/api/meta/vehicles', { token });
    setVehicles(v.vehicles || []);
    const lb = await apiFetch('/api/logbooks', { token });
    setLogbooks(lb.logbooks || []);
  }

  useEffect(() => { load().catch((e) => setError(e.message)); }, []);

  async function openView(id) {
    setView({ loading: true, book: null, trips: [], supplies: [] });
    try {
      const d = await apiFetch(`/api/logbooks/${id}`, { token });
      setView({ loading: false, book: d.logbook, trips: d.trips || [], supplies: d.supplies || [] });
    } catch (e) {
      setView(null);
      alert(e.message || String(e));
    }
  }

  async function create(e) {
    e.preventDefault();
    if (!['LOGISTIQUE','ADMIN'].includes(role)) return;
    setLoading(true);
    setError(null);
    try {
      await apiFetch('/api/logbooks', { token, method: 'POST', body: { ...form, objet: form.objet || null } });
      setForm({ vehicle_id: '', period_start: '', period_end: '', objet: '' });
      await load();
    } catch (e2) {
      setError(e2.message);
    } finally {
      setLoading(false);
    }
  }

  const vehicleMap = useMemo(() => {
    const m = new Map();
    vehicles.forEach(v => m.set(String(v.id), v));
    return m;
  }, [vehicles]);

  const filtered = useMemo(() => {
    const q = filter.q.trim().toLowerCase();
    const fVeh = filter.vehicle_id ? String(filter.vehicle_id) : '';
    const fStatus = filter.status || '';
    const fFrom = filter.date_from ? toYmd(filter.date_from) : null;
    const fTo = filter.date_to ? toYmd(filter.date_to) : null;

    return (logbooks || []).filter(lb => {
      if (fVeh) {
        // lb.vehicle_id si dispo sinon fallback by plate compare
        if (lb.vehicle_id != null) {
          if (String(lb.vehicle_id) !== fVeh) return false;
        } else {
          const v = vehicleMap.get(fVeh);
          if (v?.plate && String(lb.plate) !== String(v.plate)) return false;
        }
      }
      if (fStatus && String(lb.status) !== fStatus) return false;

      const ps = toYmd(lb.period_start) || '';
      const pe = toYmd(lb.period_end) || '';

      if (fFrom && pe && pe < fFrom) return false; // le journal finit avant le filtre
      if (fTo && ps && ps > fTo) return false;     // le journal commence aprÃ¨s le filtre

      if (q) {
        const hay = `${lb.plate || ''} ${lb.objet || ''} ${lb.status || ''}`.toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });
  }, [logbooks, filter, vehicleMap]);

  function badgeClass(status) {
    if (status === 'LOCKED') return 'badge-ok';
    if (status === 'SUBMITTED') return 'badge-info';
    if (status === 'REJECTED') return 'badge-bad';
    return 'badge-warn';
  }

  return (
    <div className="grid2">
      <div className="card">
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', gap: 12 }}>
          <h2 style={{ margin: 0 }}>Journaux de bord voiture</h2>
          <div className="muted" style={{ fontSize: 13 }}>
            {filtered.length} / {logbooks.length}
          </div>
        </div>

        {error && <div className="alert">{error}</div>}

        {/* ğŸ” FILTRE */}
        <div className="card" style={{ marginTop: 12, padding: 12, background: '#fafafa' }}>
          <div className="row2">
            <label>
              VÃ©hicule
              <select
                value={filter.vehicle_id}
                onChange={(e) => setFilter({ ...filter, vehicle_id: e.target.value })}
              >
                <option value="">Tous</option>
                {vehicles.map(v => <option key={v.id} value={v.id}>{v.plate}</option>)}
              </select>
            </label>

            <label>
              Statut
              <select value={filter.status} onChange={(e) => setFilter({ ...filter, status: e.target.value })}>
                <option value="">Tous</option>
                <option value="DRAFT">DRAFT</option>
                <option value="SUBMITTED">SUBMITTED</option>
                <option value="LOCKED">LOCKED</option>
                <option value="REJECTED">REJECTED</option>
              </select>
            </label>
          </div>

          <div className="row2" style={{ marginTop: 10 }}>
            <label>
              Du
              <input type="date" value={filter.date_from} onChange={(e) => setFilter({ ...filter, date_from: e.target.value })} />
            </label>
            <label>
              Au
              <input type="date" value={filter.date_to} onChange={(e) => setFilter({ ...filter, date_to: e.target.value })} />
            </label>
          </div>

          <div style={{ display: 'flex', gap: 10, marginTop: 10, alignItems: 'flex-end' }}>
            <label style={{ flex: 1 }}>
              Recherche
              <input value={filter.q} onChange={(e) => setFilter({ ...filter, q: e.target.value })} placeholder="Immatriculation, objet, statut..." />
            </label>
            <button
              className="btn btn-outline"
              type="button"
              onClick={() => setFilter({ vehicle_id: '', status: '', date_from: '', date_to: '', q: '' })}
            >
              Reset
            </button>
          </div>
        </div>

        {/* LISTE */}
        <div style={{ overflowX: 'auto', marginTop: 12 }}>
          <table className="table">
            <thead>
              <tr>
                <th>VÃ©hicule</th>
                <th>PÃ©riode</th>
                <th>Objet</th>
                <th>Km</th>
                <th>Statut</th>
                <th style={{ width: 320 }}></th>
              </tr>
            </thead>
            <tbody>
              {filtered.map((lb) => (
                <tr key={lb.id}>
                  <td><b>{lb.plate}</b></td>
                  <td>{fmtDate(lb.period_start)} â†’ {fmtDate(lb.period_end)}</td>
                  <td>{lb.objet ? String(lb.objet).slice(0, 60) : <span className="muted">â€”</span>}</td>
                  <td style={{ whiteSpace: 'nowrap' }}>
                    <span className="badge badge-info" style={{ marginRight: 6 }}>S: {lb.service_km ?? 0}</span>
                    <span className="badge badge-warn">M: {lb.mission_km ?? 0}</span>
                  </td>
                  <td>
                    <span className={`badge ${badgeClass(lb.status)}`}>{lb.status}</span>
                  </td>
                  <td style={{ whiteSpace: 'nowrap' }}>
                    <button className="btn btn-outline btn-sm" onClick={() => openView(lb.id)}>Voir</button>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <Link className="btn btn-secondary btn-sm" to={`/app/logbooks/${lb.id}`}>Ouvrir</Link>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <a className="btn btn-sm" href={`/print/logbook/${lb.id}`} target="_blank" rel="noreferrer">Imprimer</a>
                  </td>
                </tr>
              ))}
              {!filtered.length && (
                <tr><td colSpan={6} className="muted">Aucun journal.</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* CREATE */}
      <div className="card">
        <h3>CrÃ©er un journal</h3>
        {!['LOGISTIQUE','ADMIN'].includes(role) ? (
          <div className="muted">AccÃ¨s Logistique/Admin.</div>
        ) : (
          <form onSubmit={create} className="form">
            <label>
              VÃ©hicule
              <select value={form.vehicle_id} onChange={(e) => setForm({ ...form, vehicle_id: e.target.value })} required>
                <option value="">-- sÃ©lectionner --</option>
                {vehicles.map((v) => <option key={v.id} value={v.id}>{v.plate}</option>)}
              </select>
            </label>

            <div className="row2">
              <label>
                Du
                <input type="date" value={form.period_start} onChange={(e) => setForm({ ...form, period_start: e.target.value })} required />
              </label>
              <label>
                Au
                <input type="date" value={form.period_end} onChange={(e) => setForm({ ...form, period_end: e.target.value })} required />
              </label>
            </div>

            <label>
              Objet
              <input value={form.objet} onChange={(e) => setForm({ ...form, objet: e.target.value })} placeholder="(optionnel)" />
            </label>

            <button className="btn" disabled={loading}>{loading ? '...' : 'CrÃ©er et ouvrir'}</button>
          </form>
        )}
      </div>

      {/* MODAL DETAILS */}
      {view && (
        <Modal title="DÃ©tails journal de bord" onClose={() => setView(null)} width={900}>
          {view.loading ? (
            <div className="muted">Chargement...</div>
          ) : view.book ? (
            <div className="grid2">
              <div className="card">
                <div className="label">VÃ©hicule</div>
                <div><b>{view.book.plate}</b> <span className="muted">{view.book.label || ''}</span></div>
                <div className="label" style={{ marginTop: 10 }}>PÃ©riode</div>
                <div><b>{fmtDate(view.book.period_start)}</b> â†’ <b>{fmtDate(view.book.period_end)}</b></div>
                <div className="label" style={{ marginTop: 10 }}>Objet</div>
                <div>{view.book.objet || <span className="muted">â€”</span>}</div>
                <div className="label" style={{ marginTop: 10 }}>Km</div>
                <div>
                  <span className="badge badge-info" style={{ marginRight: 6 }}>Services: {view.book.service_km ?? 0}</span>
                  <span className="badge badge-warn">Mission: {view.book.mission_km ?? 0}</span>
                </div>
                <div className="label" style={{ marginTop: 10 }}>Statut</div>
                <div><span className={`badge ${badgeClass(view.book.status)}`}>{view.book.status}</span></div>
              </div>

              <div className="card">
                <div className="label">RÃ©sumÃ©</div>
                <div className="muted">Trajets: {view.trips.length} â€¢ Appro carburant: {view.supplies.length}</div>
                <hr />
                <div className="label">Derniers trajets</div>
                <ul className="muted" style={{ marginTop: 8 }}>
                  {view.trips.slice(0, 6).map((t) => (
                    <li key={t.id}>{fmtDate(t.trip_date)} â€” {t.route_start || '...'} â†’ {t.route_end || '...'}</li>
                  ))}
                  {!view.trips.length && <li>â€”</li>}
                </ul>

                <div style={{ marginTop: 12, display: 'flex', gap: 10 }}>
                  <Link className="btn btn-secondary" to={`/app/logbooks/${view.book.id}`}>Ouvrir</Link>
                  <a className="btn" href={`/print/logbook/${view.book.id}`} target="_blank" rel="noreferrer">Imprimer</a>
                </div>
              </div>
            </div>
          ) : (
            <div className="muted">Aucune donnÃ©e</div>
          )}
        </Modal>
      )}
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/LogbookEdit.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useState } from 'react';
import { Link, useNavigate, useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

function makeTrip(row_order) {
  return {
    row_order,
    trip_date: '',
    depart_time: '',
    depart_km: '',
    route_start: '',
    route_end: '',
    parking_place: '',
    parking_duration_min: '',
    arrival_time: '',
    arrival_km: '',
    passengers: '',
    emargement: '',
    is_mission: false,
    mission_label: ''
  };
}

export default function LogbookEdit() {
  const { token, user } = useAuth();
  const { id } = useParams();
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);
  const [logbook, setLogbook] = useState(null);
  const [trips, setTrips] = useState([]);
  const [supplies, setSupplies] = useState([]);
  const canEdit = ['LOGISTIQUE','ADMIN'].includes(user?.role);

  async function load() {
    setLoading(true);
    setErr(null);
    try {
      const data = await apiFetch(`/api/logbooks/${id}`, { token }); // API call remains the same
      setLogbook(data.logbook);
      setTrips((data.trips || []).map((t) => ({
        ...t,
        trip_date: t.trip_date ? t.trip_date.substring(0,10) : '',
        is_mission: !!t.is_mission
      })));
      setSupplies((data.supplies || []).map((s) => ({
        ...s,
        supply_date: s.supply_date ? s.supply_date.substring(0,10) : ''
      })));
    } catch (e) {
      setErr(e.message);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => { load(); }, [id]);

  const locked = logbook?.status === 'LOCKED';

  function updateTrip(i, key, val) {
    setTrips((prev) => prev.map((t, idx) => idx === i ? { ...t, [key]: val } : t));
  }

  function addTrip() {
    // Logic to determine next row_order
    const nextOrder = trips.length ? Math.max(...trips.map(t => Number(t.row_order)||0)) + 1 : 1;
    setTrips((prev) => [...prev, makeTrip(nextOrder)]);
  }

  function removeTrip(i) {
    setTrips((prev) => prev.filter((_, idx) => idx !== i));
  }

  function addSupply() {
    setSupplies((prev) => [...prev, { supply_date: '', compteur_km: '', liters: '', montant_ar: '' }]);
  }

  function removeSupply(i) {
    setSupplies((prev) => prev.filter((_, idx) => idx !== i));
  }

  function updateSupply(i, key, val) {
    setSupplies((prev) => prev.map((s, idx) => idx === i ? { ...s, [key]: val } : s));
  }

  async function saveAll() {
    if (!canEdit) return;
    try {
      // 1. Update Header details (Objet, Signature Chauffeur)
      await apiFetch(`/api/logbooks/${id}`, {
        token, method: 'PUT',
        body: { objet: logbook.objet, chauffeur_signature: logbook.chauffeur_signature }
      });

      // 2. Update Trips
      const tripsPayload = trips.map((t, idx) => ({
        ...t, // Pass all trip data
        row_order: idx + 1, // Re-index row_order
        // Ensure numerical fields are correctly formatted or null
        depart_km: t.depart_km === '' ? null : Number(t.depart_km),
        arrival_km: t.arrival_km === '' ? null : Number(t.arrival_km),
        parking_duration_min: t.parking_duration_min === '' ? null : Number(t.parking_duration_min)
      }));
      await apiFetch(`/api/logbooks/${id}/trips`, { token, method: 'PUT', body: { trips: tripsPayload } });

      // 3. Update Supplies
      const supPayload = supplies
        .filter(s => s.supply_date || s.compteur_km || s.liters || s.montant_ar) // Filter out empty rows
        .map(s => ({
          ...s,
          compteur_km: Number(s.compteur_km),
          liters: Number(s.liters),
          montant_ar: Number(s.montant_ar)
      }));
      await apiFetch(`/api/logbooks/${id}/supplies`, { token, method: 'PUT', body: { supplies: supPayload } });
      
      alert('âœ… EnregistrÃ© avec succÃ¨s');
      await load(); // Reload data to reflect changes
    } catch (e) {
      alert('âŒ Erreur lors de la sauvegarde : ' + e.message);
    }
  }

  if (loading) return <div className="card">Chargement...</div>;
  if (err) return <div className="card"><div className="error">{err}</div><Link to="/app/logbooks">Retour</Link></div>;
  if (!logbook) return <div className="card">Journal de bord non trouvÃ©.</div>;

  return (
    <div style={{ padding: 20 }}>
      {/* ========== HEADER & ACTIONS ========== */}
      <div style={{ 
        display: 'flex', 
        justifyContent: 'space-between', 
        alignItems: 'center',
        marginBottom: '24px',
        paddingBottom: '16px',
        borderBottom: '2px solid #e5e7eb'
      }}>
        <div>
          <div style={{ fontSize: '24px', fontWeight: '800', marginBottom: '8px' }}>
            JOURNAL DE BORD VOITURE
          </div>
          {/* Info PÃ©riode & Immatriculation */}
          <div style={{ display: 'flex', gap: '16px', fontSize: '14px', color: '#6b7280' }}>
            {/* Il n'y a pas d'immatriculation filtrÃ©e ici, donc on affiche le plate */}
            <span><strong>PÃ©riode:</strong> Du {logbook.period_start} au {logbook.period_end}</span>
            <span><strong>Immatriculation:</strong> {logbook.plate}</span>
            <span className={`badge ${logbook.status === 'LOCKED' ? 'badge-bad' : logbook.status === 'SUBMITTED' ? 'badge-info' : 'badge-warn'}`}>
              {logbook.status}
            </span>
          </div>
        </div>
        <div style={{ display: 'flex', gap: '8px' }}>
          <a className="btn btn-secondary" href={`/print/logbook/${id}`} target="_blank" rel="noreferrer">
            ğŸ“„ Imprimer
          </a>
          <Link className="btn btn-outline" to="/app/logbooks">
            â† Retour
          </Link>
          {canEdit && !locked && (
             <button className="btn" onClick={saveAll}>
               ğŸ’¾ Enregistrer
             </button>
           )}
        </div>
      </div>

      {/* OBJET DU JOURNAL */}
      <div className="card" style={{ marginBottom: '24px' }}>
        <div style={{ fontWeight: '700', marginBottom: '12px' }}>Objet</div>
        <input
          disabled={!canEdit || locked}
          value={logbook.objet || ''}
          onChange={(e) => setLogbook({ ...logbook, objet: e.target.value })}
          placeholder="Description du journal..."
          style={{ width: '100%' }}
        />
      </div>

      {/* TABLEAU DES TRAJETS */}
      <div className="card" style={{ overflowX: 'auto', marginBottom: '24px' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
          <div style={{ fontWeight: '800', fontSize: '18px' }}>TRAJETS</div>
          {canEdit && !locked && (
            <div style={{ display: 'flex', gap: '8px' }}>
              <button className="btn btn-sm" onClick={addTrip}>+ Trajet</button>
              {/* Option pour ajouter une ligne "MISSION" */}
              <button className="btn btn-secondary btn-sm" onClick={() => setTrips(prev => [...prev, {...makeTrip(prev.length + 1), is_mission: true, mission_label: "MISSION"}])}>+ MISSION</button>
            </div>
          )}
        </div>

        <table className="table" style={{ fontSize: '12px', width: '100%' }}>
          <thead>
            <tr>
              <th rowSpan="2" style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700' }}>DATE</th>
              <th colSpan="2" style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700', textAlign: 'center' }}>DÃ‰PART</th>
              <th colSpan="4" style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700', textAlign: 'center' }}>ITINÃ‰RAIRES</th>
              <th colSpan="2" style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700', textAlign: 'center' }}>ARRIVÃ‰E</th>
              <th rowSpan="2" style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700' }}>PERSONNES TRANSPORTÃ‰ES</th>
              <th rowSpan="2" style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700' }}>Ã‰MARGEMENT</th>
              {canEdit && !locked && (
                <th rowSpan="2" style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700', width: '60px' }}>Actions</th>
              )}
            </tr>
            <tr>
              <th style={{ border: '1px solid #e5e7eb', padding: '8px', fontWeight: '600', fontSize: '12px' }}>Heures</th>
              <th style={{ border: '1px solid #e5e7eb', padding: '8px', fontWeight: '600', fontSize: '12px' }}>Km</th>
              <th style={{ border: '1px solid #e5e7eb', padding: '8px', fontWeight: '600', fontSize: '12px' }}>DÃ©but de trajet</th>
              <th style={{ border: '1px solid #e5e7eb', padding: '8px', fontWeight: '600', fontSize: '12px' }}>Fin de trajet</th>
              <th style={{ border: '1px solid #e5e7eb', padding: '8px', fontWeight: '600', fontSize: '12px' }}>Lieu stationnement</th>
              <th style={{ border: '1px solid #e5e7eb', padding: '8px', fontWeight: '600', fontSize: '12px' }}>DurÃ©e (min)</th>
              <th style={{ border: '1px solid #e5e7eb', padding: '8px', fontWeight: '600', fontSize: '12px' }}>Heures</th>
              <th style={{ border: '1px solid #e5e7eb', padding: '8px', fontWeight: '600', fontSize: '12px' }}>Km</th>
            </tr>
          </thead>
          <tbody>
            {trips.length === 0 && (
              <tr><td colSpan={canEdit && !locked ? 12 : 11} style={{ padding: '24px', textAlign: 'center', color: '#9ca3af' }}>Aucun trajet</td></tr>
            )}
            {/* Affichage des trajets */}
            {trips.map((t, i) => (
              t.is_mission ? ( // Ligne MISSION spÃ©ciale
                <tr key={i} style={{ background: '#ecfdf5' }}>
                  <td colSpan={canEdit && !locked ? 11 : 10} style={{ border: '1px solid #e5e7eb', padding: '12px' }}>
                    <strong style={{ fontSize: '14px' }}>ğŸ¯ MISSION</strong>
                    {canEdit && !locked ? (
                      <input
                        value={t.mission_label || ''}
                        onChange={(e) => updateTrip(i, 'mission_label', e.target.value)}
                        placeholder="DÃ©tails mission..."
                        style={{ marginLeft: '12px', width: 'calc(100% - 120px)', border: '1px solid #6ee7b7', borderRadius: '4px', padding: '6px' }}
                      />
                    ) : (
                      <span style={{ marginLeft: '12px', fontWeight: '600' }}>{t.mission_label || ''}</span>
                    )}
                  </td>
                  {canEdit && !locked && (
                    <td style={{ border: '1px solid #e5e7eb', padding: '8px', textAlign: 'center' }}>
                      <button className="btn btn-danger btn-sm" onClick={() => removeTrip(i)}>âœ•</button>
                    </td>
                  )}
                </tr>
              ) : ( // Ligne de trajet normale
                <tr key={i} style={{ background: i % 2 === 0 ? 'white' : '#f9fafb' }}>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input type="date" value={t.trip_date} onChange={(e) => updateTrip(i, 'trip_date', e.target.value)} disabled={!canEdit || locked} style={{ width: '90px', border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input type="time" value={t.depart_time} onChange={(e) => updateTrip(i, 'depart_time', e.target.value)} disabled={!canEdit || locked} style={{ width: '80px', border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input type="number" value={t.depart_km} onChange={(e) => updateTrip(i, 'depart_km', e.target.value)} disabled={!canEdit || locked} style={{ width: '70px', border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input value={t.route_start} onChange={(e) => updateTrip(i, 'route_start', e.target.value)} disabled={!canEdit || locked} style={{ border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input value={t.route_end} onChange={(e) => updateTrip(i, 'route_end', e.target.value)} disabled={!canEdit || locked} style={{ border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input value={t.parking_place} onChange={(e) => updateTrip(i, 'parking_place', e.target.value)} disabled={!canEdit || locked} placeholder="Lieu..." style={{ width: '100%', border: 'none', background: 'transparent', padding: '4px', marginBottom: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input value={t.parking_duration_min} onChange={(e) => updateTrip(i, 'parking_duration_min', e.target.value)} disabled={!canEdit || locked} placeholder="Min" style={{ width: '60px', border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input type="time" value={t.arrival_time} onChange={(e) => updateTrip(i, 'arrival_time', e.target.value)} disabled={!canEdit || locked} style={{ width: '80px', border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input type="number" value={t.arrival_km} onChange={(e) => updateTrip(i, 'arrival_km', e.target.value)} disabled={!canEdit || locked} style={{ width: '70px', border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input value={t.passengers} onChange={(e) => updateTrip(i, 'passengers', e.target.value)} disabled={!canEdit || locked} style={{ border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input value={t.emargement} onChange={(e) => updateTrip(i, 'emargement', e.target.value)} disabled={!canEdit || locked} style={{ border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  {canEdit && !locked && (
                    <td style={{ border: '1px solid #e5e7eb', padding: '8px', textAlign: 'center' }}>
                      <button className="btn btn-danger btn-sm" onClick={() => removeTrip(i)}>âœ•</button>
                    </td>
                  )}
                </tr>
              )
            ))}
          </tbody>
        </table>
        {!locked && <button className="btn btn-secondary btn-sm" style={{ marginTop: 10 }} onClick={addTrip}>+ Trajet</button>}
      </div>

      {/* APPROVISIONNEMENT CARBURANT */}
      <div className="card" style={{ marginBottom: '24px' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
          <div style={{ fontWeight: '800', fontSize: '18px' }}>APPROVISIONNEMENT CARBURANT</div>
          {canEdit && !locked && <button className="btn btn-sm" onClick={addSupply}>+ Ligne</button>}
        </div>

        <div style={{ overflowX: 'auto', border: '1px solid #e5e7eb', borderRadius: '8px' }}>
          <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
            <thead style={{ background: '#f9fafb' }}>
              <tr>
                <th style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700' }}>Date</th>
                <th style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700' }}>Compteur Km</th>
                <th style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700' }}>Litre</th>
                <th style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700' }}>Montant (Ar)</th>
                {canEdit && !locked && <th style={{ border: '1px solid #e5e7eb', padding: '10px', fontWeight: '700', width: '80px' }}>Actions</th> }
              </tr>
            </thead>
            <tbody>
              {supplies.length === 0 && <tr><td colSpan={canEdit && !locked ? 5 : 4} style={{ padding: '24px', textAlign: 'center', color: '#9ca3af' }}>Aucun approvisionnement</td></tr>}
              {supplies.map((s, i) => (
                <tr key={i} style={{ background: i % 2 === 0 ? 'white' : '#f9fafb' }}>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input type="date" value={s.supply_date} onChange={(e) => updateSupply(i, 'supply_date', e.target.value)} disabled={!canEdit || locked} style={{ width: '100%', border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input type="number" value={s.compteur_km} onChange={(e) => updateSupply(i, 'compteur_km', e.target.value)} disabled={!canEdit || locked} style={{ width: '100px', border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input type="number" step="0.01" value={s.liters} onChange={(e) => updateSupply(i, 'liters', e.target.value)} disabled={!canEdit || locked} style={{ width: '100px', border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  <td style={{ border: '1px solid #e5e7eb', padding: '8px' }}>
                    <input type="number" value={s.montant_ar} onChange={(e) => updateSupply(i, 'montant_ar', e.target.value)} disabled={!canEdit || locked} style={{ width: '120px', border: 'none', background: 'transparent', padding: '4px' }}/>
                  </td>
                  {canEdit && !locked && (
                    <td style={{ border: '1px solid #e5e7eb', padding: '8px', textAlign: 'center' }}>
                      <button className="btn btn-danger btn-sm" onClick={() => removeSupply(i)}>âœ•</button>
                    </td>
                  )}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* RÃ‰SUMÃ‰ & ACTIONS */}
      <div className="card" style={{ marginBottom: '24px' }}>
        <div style={{ fontWeight: '800', fontSize: '18px', marginBottom: '16px' }}>RÃ‰SUMÃ‰</div>
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px' }}>
          {/* KilomÃ©trage Services / Mission (non editable pour le moment car manuel) */}
          <div>
            <div className="label">Services (km) - manuel</div>
            <input disabled value={logbook.service_km ?? 0} style={{ width: '100%', background: '#f3f4f6' }}/>
          </div>
          <div>
            <div className="label">Mission (km) - manuel</div>
            <input disabled value={logbook.mission_km ?? 0} style={{ width: '100%', background: '#f3f4f6' }}/>
          </div>
          <div>
            <div className="label">Signature Chauffeur</div>
            <input
              disabled={!canEdit || locked}
              value={logbook.chauffeur_signature || ''}
              onChange={(e) => setLogbook({ ...logbook, chauffeur_signature: e.target.value })}
              placeholder="Nom du chauffeur"
              style={{ width: '100%' }}
            />
          </div>
        </div>
      </div>

      {/* ACTIONS DE FLUX (Soumettre, Verrouiller etc.) */}
      {canEdit && !locked && (
        <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
          {logbook.status === 'DRAFT' && (
            <button className="btn btn-secondary" onClick={() => alert('FonctionnalitÃ© Ã  implÃ©menter : soumettre')}>
              ğŸ“¤ Soumettre
            </button>
          )}
          <button className="btn btn-danger" onClick={() => alert('FonctionnalitÃ© Ã  implÃ©menter : verrouiller')}>
            ğŸ”’ Verrouiller dÃ©finitivement
          </button>
        </div>
      )}
      
      {/* Message si journal verrouillÃ© */}
      {locked && (
        <div style={{ padding: '16px', background: '#fef2f2', border: '2px solid #fca5a5', borderRadius: '8px', color: '#b91c1c', fontWeight: '600', textAlign: 'center' }}>
          ğŸ”’ Ce journal est VERROUILLÃ‰ - Aucune modification n'est possible
        </div>
      )}

      {err && <div style={{ marginTop: '16px', padding: '12px', background: '#fef2f2', border: '1px solid #fca5a5', borderRadius: '8px', color: '#b91c1c' }}>âŒ {err}</div>}
    </div>
  );
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/ImportExcel.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useState } from 'react';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch, apiUpload } from '../utils/api.js';

export default function ImportExcel() {
  const { token, user } = useAuth();
  const [files, setFiles] = useState([]);
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const [batches, setBatches] = useState([]);
  const [selectedBatch, setSelectedBatch] = useState(null);
  const [batchFiles, setBatchFiles] = useState([]);
  const [error, setError] = useState(null);

  const isAllowed = ['ADMIN','LOGISTIQUE'].includes(user?.role);

  async function refreshBatches() {
    const data = await apiFetch('/api/import/batches', { token });
    setBatches(data.batches || []);
  }

  async function loadBatchFiles(batchId) {
    setSelectedBatch(batchId);
    const data = await apiFetch(`/api/import/batches/${batchId}/files`, { token });
    setBatchFiles(data.files || []);
  }

  useEffect(() => {
    if (token && ['ADMIN','LOGISTIQUE','RAF'].includes(user?.role)) {
      refreshBatches().catch(() => {});
    }
  }, [token, user?.role]);

  async function onUpload() {
    setError(null);
    if (!files.length) return;
    setLoading(true);
    try {
      const batch = await apiFetch('/api/import/batch', { token, method: 'POST', body: {} });
      const fd = new FormData();
      fd.append('batch_id', batch.batch_id);
      for (const f of files) fd.append('files', f);
      const data = await apiUpload('/api/import/upload', { token, formData: fd });
      setResult(data);
      await refreshBatches();
      await loadBatchFiles(data.batch_id);
      setFiles([]);
    } catch (e) {
      setError(e.message);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="grid" style={{ gridTemplateColumns: '1fr 1fr', gap: 16 }}>
      <div className="card">
        <h2>Import Excel (Admin/Logistique)</h2>
        {!isAllowed && <div className="muted">AccÃ¨s rÃ©servÃ©.</div>}
        {isAllowed && (
          <>
            <input
              type="file"
              multiple
              accept=".xlsx"
              onChange={(e) => setFiles(Array.from(e.target.files || []))}
            />
            <div style={{ height: 8 }} />
            <button className="btn" disabled={loading || !files.length} onClick={onUpload}>
              {loading ? 'Import...' : 'Importer'}
            </button>

            {error && <div className="alert">{error}</div>}

            {result && (
              <div style={{ marginTop: 12 }}>
                <div className="muted">Batch: {result.batch_id}</div>
                <table className="table" style={{ marginTop: 8 }}>
                  <thead>
                    <tr>
                      <th>Fichier</th>
                      <th>Type</th>
                      <th>InsÃ©rÃ©s</th>
                      <th>Erreur</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(result.results || []).map((r, idx) => (
                      <tr key={idx}>
                        <td>{r.file}</td>
                        <td>{r.type || '-'}</td>
                        <td>{r.inserted ?? '-'}</td>
                        <td>{r.error || ''}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </>
        )}
      </div>

      <div className="card">
        <h2>Historique imports</h2>
        <div className="muted">Clique un batch pour voir les dÃ©tails.</div>

        <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', marginTop: 8 }}>
          {(batches || []).slice(0, 20).map((b) => (
            <button
              key={b.id}
              className="btn btn-secondary"
              onClick={() => loadBatchFiles(b.id)}
              title={`Batch ${b.id}`}
            >
              {new Date(b.created_at).toLocaleString('fr-FR')}
              {' â€¢ '}
              {b.created_by || 'â€”'}
              {' â€¢ '}
              {b.files} fichiers
            </button>
          ))}
        </div>

        {selectedBatch && (
          <div style={{ marginTop: 12 }}>
            <h3 style={{ marginTop: 0 }}>Batch {selectedBatch}</h3>

            <table className="table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>InsÃ©rÃ©s</th>
                  <th>TraitÃ© le</th>
                  <th>Erreur</th>
                </tr>
              </thead>
              <tbody>
                {(batchFiles || []).map((f) => (
                  <tr key={f.id}>
                    <td>{f.original_name}</td>
                    <td>{f.detected_type || '-'}</td>
                    <td>{f.status}</td>
                    <td>{f.inserted_rows ?? ''}</td>
                    <td>{f.processed_at ? new Date(f.processed_at).toLocaleString('fr-FR') : ''}</td>
                    <td>{f.error_message || ''}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/FuelRequestsRaf.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

function fmtAr(n) {
  try { return new Intl.NumberFormat('fr-FR').format(Number(n || 0)) + ' Ar'; } catch { return String(n || 0) + ' Ar'; }
}

export default function FuelRequestsRaf() {
  const { token, user } = useAuth();
  const role = user?.role;
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [view, setView] = useState(null);

  async function load() {
    setLoading(true);
    setError(null);
    try {
      const r = await apiFetch('/api/requests/fuel?status=VERIFIED', { token });
      setRows(r.requests || []);
    } catch (e) {
      setError(e.message);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => { load(); }, []);

  async function openView(id) {
    setView({ loading: true, data: null });
    try {
      const d = await apiFetch(`/api/requests/fuel/${id}`, { token });
      setView({ loading: false, data: d.request });
    } catch (e) {
      setView(null);
      alert(e.message || String(e));
    }
  }

  async function approve(id) {
    await apiFetch(`/api/requests/fuel/${id}/approve`, { token, method: 'POST' });
    await load();
  }

  async function reject(id) {
    const reason = prompt('Motif de rejet (obligatoire)') || '';
    if (!reason.trim()) return;
    await apiFetch(`/api/requests/fuel/${id}/reject`, { token, method: 'POST', body: { reason } });
    await load();
  }

  const can = ['RAF', 'ADMIN'].includes(role);

  return (
    <div className="card">
      <h2>Visa RAF carburant</h2>
      {error && <div className="alert">{error}</div>}
      {loading ? <div className="muted">Chargement...</div> : (
        <table className="table">
          <thead>
            <tr>
              <th>NÂ°</th>
              <th>Date</th>
              <th>Type</th>
              <th>Objet</th>
              <th>Montant</th>
              <th style={{ width: 260 }}></th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r) => (
              <tr key={r.id}>
                <td><b>{r.request_no}</b></td>
                <td>{r.request_date}</td>
                <td>{r.request_type}</td>
                <td>{r.objet}</td>
                <td>{fmtAr(r.amount_estimated_ar)}</td>
                <td style={{ whiteSpace: 'nowrap' }}>
                  <button className="btn btn-outline btn-sm" onClick={() => openView(r.id)}>Voir</button>
                  <span style={{ display: 'inline-block', width: 8 }} />
                  {can && (
                    <>
                      <button className="btn btn-sm" onClick={() => approve(r.id)}>Approuver</button>
                      <span style={{ display: 'inline-block', width: 8 }} />
                      <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Rejeter</button>
                    </>
                  )}
                </td>
              </tr>
            ))}
            {!rows.length && <tr><td colSpan={6} className="muted">Rien Ã  viser.</td></tr>}
          </tbody>
        </table>
      )}

      {view && (
        <Modal title="DÃ©tails demande carburant" onClose={() => setView(null)} width={800}>
          {view.loading ? <div className="muted">Chargement...</div> : (
            <div className="grid2">
              <div className="card">
                <div className="label">NÂ°</div><div><b>{view.data.request_no}</b></div>
                <div className="label" style={{ marginTop: 10 }}>Date</div><div>{view.data.request_date}</div>
                <div className="label" style={{ marginTop: 10 }}>Type</div><div>{view.data.request_type}</div>
                <div className="label" style={{ marginTop: 10 }}>Objet</div><div>{view.data.objet}</div>
              </div>
              <div className="card">
                <div className="label">Montant</div><div><b>{fmtAr(view.data.amount_estimated_ar)}</b></div>
                <div className="label" style={{ marginTop: 10 }}>Montant (lettres)</div><div>{view.data.amount_estimated_words || <span className="muted">â€”</span>}</div>
                <div className="label" style={{ marginTop: 10 }}>Statut</div><div><span className="badge">{view.data.status}</span></div>
              </div>
            </div>
          )}
        </Modal>
      )}
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/FuelRequestsManage.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

function fmtAr(n) {
  try { return new Intl.NumberFormat('fr-FR').format(Number(n || 0)) + ' Ar'; } catch { return String(n || 0) + ' Ar'; }
}

export default function FuelRequestsManage() {
  const { token, user } = useAuth();
  const role = user?.role;
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const [view, setView] = useState(null); // {loading,data}
  const [editId, setEditId] = useState(null);
  const [edit, setEdit] = useState({ request_date: '', request_type: 'SERVICE', objet: '', amount_estimated_ar: 0, amount_estimated_words: '' });

  const canManage = useMemo(() => ['LOGISTIQUE', 'ADMIN'].includes(role), [role]);

  async function load() {
    setLoading(true);
    setError(null);
    try {
      const d = await apiFetch('/api/requests/fuel?status=SUBMITTED', { token });
      setRows(d.requests || []);
    } catch (e) {
      setError(e.message || String(e));
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => { load(); }, []);

  async function openView(id) {
    setView({ loading: true, data: null });
    try {
      const d = await apiFetch(`/api/requests/fuel/${id}`, { token });
      setView({ loading: false, data: d.request });
    } catch (e) {
      setView(null);
      alert(e.message || String(e));
    }
  }

  function startEdit(r) {
    setEditId(r.id);
    setEdit({
      request_date: (r.request_date || '').slice(0, 10),
      request_type: r.request_type || 'SERVICE',
      objet: r.objet || '',
      amount_estimated_ar: Number(r.amount_estimated_ar || 0),
      amount_estimated_words: r.amount_estimated_words || ''
    });
  }

  async function saveEdit(id) {
    try {
      await apiFetch(`/api/requests/fuel/${id}`, {
        token,
        method: 'PUT',
        body: {
          request_date: edit.request_date,
          request_type: edit.request_type,
          objet: edit.objet,
          amount_estimated_ar: Number(edit.amount_estimated_ar || 0),
          amount_estimated_words: edit.amount_estimated_words
        }
      });
      setEditId(null);
      await load();
    } catch (e) {
      alert(e.message || String(e));
    }
  }

  async function softDelete(id) {
    if (!window.confirm('DÃ©placer dans Corbeille ?')) return;
    try {
      await apiFetch(`/api/requests/fuel/${id}`, { token, method: 'DELETE' });
      await load();
      alert('OK: dÃ©placÃ© dans Corbeille.');
    } catch (e) {
      alert(e.message || String(e));
    }
  }

  async function verify(id) {
    try {
      await apiFetch(`/api/requests/fuel/${id}/verify`, { token, method: 'POST' });
      await load();
    } catch (e) {
      alert(e.message || String(e));
    }
  }

  async function reject(id) {
    const reason = window.prompt('Motif de rejet (optionnel) :') || null;
    try {
      await apiFetch(`/api/requests/fuel/${id}/reject`, { token, method: 'POST', body: { reason } });
      await load();
    } catch (e) {
      alert(e.message || String(e));
    }
  }

  if (!canManage) return <div className="card"><h2>Validation carburant</h2><div className="muted">AccÃ¨s Logistique/Admin.</div></div>;

  return (
    <div className="card">
      <h2>Validation carburant (Logistique)</h2>
      {error && <div className="alert">{error}</div>}
      {loading ? (
        <div className="muted">Chargement...</div>
      ) : (
        <table className="table">
          <thead>
            <tr>
              <th>NÂ°</th>
              <th>Date</th>
              <th>Type</th>
              <th>Objet</th>
              <th>Montant</th>
              <th>Demandeur</th>
              <th style={{ width: 360 }}></th>
            </tr>
          </thead>
          <tbody>
            {rows.map((r) => {
              const isEdit = editId === r.id;
              return (
                <tr key={r.id}>
                  <td>{r.request_no}</td>
                  <td>{isEdit ? <input className="input" type="date" value={edit.request_date} onChange={(e) => setEdit({ ...edit, request_date: e.target.value })} /> : (r.request_date || '').slice(0, 10)}</td>
                  <td>{isEdit ? (
                    <select className="input" value={edit.request_type} onChange={(e) => setEdit({ ...edit, request_type: e.target.value })}>
                      <option value="SERVICE">SERVICE</option>
                      <option value="MISSION">MISSION</option>
                    </select>
                  ) : r.request_type}</td>
                  <td>{isEdit ? <input className="input" value={edit.objet} onChange={(e) => setEdit({ ...edit, objet: e.target.value })} /> : r.objet}</td>
                  <td>{isEdit ? <input className="input" type="number" value={edit.amount_estimated_ar} onChange={(e) => setEdit({ ...edit, amount_estimated_ar: e.target.value })} /> : fmtAr(r.amount_estimated_ar)}</td>
                  <td>{r.requester_name}</td>
                  <td style={{ whiteSpace: 'nowrap' }}>
                    <button className="btn btn-outline btn-sm" onClick={() => openView(r.id)}>Voir</button>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    {isEdit ? (
                      <>
                        <button className="btn btn-sm" onClick={() => saveEdit(r.id)}>Valider</button>
                        <span style={{ display: 'inline-block', width: 8 }} />
                        <button className="btn btn-secondary btn-sm" onClick={() => setEditId(null)}>Annuler</button>
                      </>
                    ) : (
                      <button className="btn btn-secondary btn-sm" onClick={() => startEdit(r)}>Modifier</button>
                    )}
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <button className="btn btn-danger btn-sm" onClick={() => softDelete(r.id)}>Supprimer</button>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <button className="btn btn-sm" onClick={() => verify(r.id)}>Visa Logistique</button>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Non-validÃ©</button>
                  </td>
                </tr>
              );
            })}
            {!rows.length && <tr><td colSpan={7} className="muted">Aucune demande SUBMITTED.</td></tr>}
          </tbody>
        </table>
      )}

      {view && (
        <Modal title={`Demande carburant â€” ${view.data?.request_no || ''}`} onClose={() => setView(null)} width={820}>
          {view.loading ? (
            <div className="muted">Chargement...</div>
          ) : view.data ? (
            <div className="grid2">
              <div className="card">
                <div className="label">Date</div>
                <div>{(view.data.request_date || '').slice(0, 10)}</div>
                <div className="label" style={{ marginTop: 10 }}>Type</div>
                <div>{view.data.request_type}</div>
                <div className="label" style={{ marginTop: 10 }}>Objet</div>
                <div>{view.data.objet}</div>
                <div className="label" style={{ marginTop: 10 }}>Montant</div>
                <div><b>{fmtAr(view.data.amount_estimated_ar)}</b></div>
              </div>
              <div className="card">
                <div className="label">Statut</div>
                <div><span className="badge badge-info">{view.data.status}</span></div>
                <div className="label" style={{ marginTop: 10 }}>Demandeur</div>
                <div>{view.data.requester_name}</div>
                <div className="label" style={{ marginTop: 10 }}>Motif rejet</div>
                <div>{view.data.rejected_reason || <span className="muted">â€”</span>}</div>
              </div>
            </div>
          ) : (
            <div className="muted">Aucune donnÃ©e</div>
          )}
        </Modal>
      )}
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/FuelRequests.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

function fmtAr(n) {
  try { return new Intl.NumberFormat('fr-FR').format(Number(n || 0)) + ' Ar'; } catch { return String(n || 0) + ' Ar'; }
}

const TYPES = [
  { value: 'SERVICE', label: 'SERVICE' },
  { value: 'MISSION', label: 'MISSION' }
];

export default function FuelRequests() {
  const { token, user } = useAuth();
  const role = user?.role;

  const [requests, setRequests] = useState([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);

  const [form, setForm] = useState({
    request_type: 'SERVICE',
    objet: '',
    amount_estimated_ar: 0,
    amount_estimated_words: '',
    request_date: new Date().toISOString().slice(0, 10)
  });
  const [creating, setCreating] = useState(false);

  const [view, setView] = useState(null); // {loading, data}
  const [editId, setEditId] = useState(null);
  const [draft, setDraft] = useState(null);

  const canCreate = role === 'DEMANDEUR';
  const canVerify = ['LOGISTIQUE', 'ADMIN'].includes(role);
  const canApprove = ['RAF', 'ADMIN'].includes(role);
  const canSoftDelete = ['LOGISTIQUE', 'ADMIN'].includes(role);

  const columns = useMemo(() => {
    return ['NÂ°', 'Date', 'Type', 'Objet', 'Montant', 'Statut', 'Actions'];
  }, []);

  async function load() {
    setLoading(true);
    setErr(null);
    try {
      const d = await apiFetch('/api/requests/fuel', { token });
      setRequests(d.requests || []);
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
  }, []);

  const create = async () => {
    setCreating(true);
    setErr(null);
    try {
      const body = {
        ...form,
        amount_estimated_ar: Number(form.amount_estimated_ar || 0)
      };
      await apiFetch('/api/requests/fuel', { method: 'POST', token, body });
      setForm({ request_type: 'SERVICE', objet: '', amount_estimated_ar: 0, amount_estimated_words: '', request_date: new Date().toISOString().slice(0, 10) });
      await load();
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setCreating(false);
    }
  };

  const openView = async (id) => {
    setView({ loading: true, data: null });
    try {
      const d = await apiFetch(`/api/requests/fuel/${id}`, { token });
      setView({ loading: false, data: d.request });
    } catch (e) {
      setView({ loading: false, data: null });
      alert(String(e.message || e));
    }
  };

  const openEdit = (r) => {
    setEditId(r.id);
    setDraft({
      request_date: (r.request_date || '').slice(0, 10),
      request_type: r.request_type || 'SERVICE',
      objet: r.objet || '',
      amount_estimated_ar: Number(r.amount_estimated_ar || 0),
      amount_estimated_words: r.amount_estimated_words || ''
    });
  };

  const cancelEdit = () => {
    setEditId(null);
    setDraft(null);
  };

  const saveEdit = async () => {
    if (!editId || !draft) return;
    try {
      const body = {
        request_date: draft.request_date,
        request_type: draft.request_type,
        objet: draft.objet,
        amount_estimated_ar: Number(draft.amount_estimated_ar || 0),
        amount_estimated_words: draft.amount_estimated_words
      };
      await apiFetch(`/api/requests/fuel/${editId}`, { method: 'PUT', token, body });
      cancelEdit();
      await load();
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const softDelete = async (id) => {
    const ok = confirm('DÃ©placer dans Corbeille ?');
    if (!ok) return;
    try {
      await apiFetch(`/api/requests/fuel/${id}`, { method: 'DELETE', token });
      await load();
      alert('OK âœ… DÃ©placÃ© dans Corbeille');
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const submit = async (id) => {
    await apiFetch(`/api/requests/fuel/${id}/submit`, { method: 'PATCH', token });
    await load();
  };
  const verify = async (id) => {
    await apiFetch(`/api/requests/fuel/${id}/verify`, { method: 'PATCH', token });
    await load();
  };
  const approve = async (id) => {
    await apiFetch(`/api/requests/fuel/${id}/approve`, { method: 'PATCH', token });
    await load();
  };
  const reject = async (id) => {
    const reason = prompt('Motif de rejet (optionnel) :') || '';
    await apiFetch(`/api/requests/fuel/${id}/reject`, { method: 'PATCH', token, body: { reason } });
    await load();
  };

  return (
    <div>
      <h1 style={{ marginTop: 0 }}>Demande de carburant</h1>

      {canCreate && (
        <div className="card" style={{ marginBottom: 12 }}>
          <div className="row">
            <div className="field" style={{ minWidth: 160 }}>
              <div className="label">Date</div>
              <input
                className="input"
                type="date"
                value={form.request_date}
                onChange={(e) => setForm({ ...form, request_date: e.target.value })}
              />
            </div>
            <div className="field" style={{ minWidth: 160 }}>
              <div className="label">Type</div>
              <select
                className="input"
                value={form.request_type}
                onChange={(e) => setForm({ ...form, request_type: e.target.value })}
              >
                {TYPES.map((t) => (
                  <option key={t.value} value={t.value}>{t.label}</option>
                ))}
              </select>
            </div>
            <div className="field" style={{ flex: 1 }}>
              <div className="label">Objet</div>
              <input
                className="input"
                value={form.objet}
                onChange={(e) => setForm({ ...form, objet: e.target.value })}
                placeholder="Objet..."
              />
            </div>
          </div>
          <div className="row">
            <div className="field" style={{ minWidth: 200 }}>
              <div className="label">Montant prÃ©visionnel (Ar)</div>
              <input
                className="input"
                type="number"
                value={form.amount_estimated_ar}
                onChange={(e) => setForm({ ...form, amount_estimated_ar: e.target.value })}
              />
            </div>
            <div className="field" style={{ flex: 1 }}>
              <div className="label">Montant (en lettre)</div>
              <input
                className="input"
                value={form.amount_estimated_words}
                onChange={(e) => setForm({ ...form, amount_estimated_words: e.target.value })}
                placeholder="..."
              />
            </div>
          </div>
          <div style={{ display: 'flex', justifyContent: 'flex-end' }}>
            <button className="btn" onClick={create} disabled={creating}>CrÃ©er (DRAFT)</button>
          </div>
          {err && <div className="muted" style={{ color: '#b91c1c', marginTop: 8 }}>{err}</div>}
        </div>
      )}

      {!canCreate && err && <div className="muted" style={{ color: '#b91c1c' }}>{err}</div>}

      <div style={{ overflow: 'auto' }}>
        <table className="table">
          <thead>
            <tr>
              {columns.map((c) => (<th key={c}>{c}</th>))}
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr><td colSpan={columns.length} className="muted">Chargement...</td></tr>
            ) : requests.length ? (
              requests.map((r) => {
                const isEditing = editId === r.id;
                const canEditRow = (
                  (role === 'DEMANDEUR' && r.status && ['DRAFT','REJECTED'].includes(r.status)) ||
                  (['ADMIN','LOGISTIQUE'].includes(role) && r.status && ['DRAFT','REJECTED','SUBMITTED','VERIFIED'].includes(r.status))
                );

                return (
                  <tr key={r.id}>
                    <td><b>{r.request_no}</b></td>
                    <td>
                      {isEditing ? (
                        <input
                          className="input"
                          type="date"
                          value={draft?.request_date || ''}
                          onChange={(e) => setDraft({ ...draft, request_date: e.target.value })}
                        />
                      ) : (r.request_date ? String(r.request_date).slice(0, 10) : '')}
                    </td>
                    <td>
                      {isEditing ? (
                        <select
                          className="input"
                          value={draft?.request_type || 'SERVICE'}
                          onChange={(e) => setDraft({ ...draft, request_type: e.target.value })}
                        >
                          {TYPES.map((t) => (
                            <option key={t.value} value={t.value}>{t.label}</option>
                          ))}
                        </select>
                      ) : (r.request_type || '')}
                    </td>
                    <td>
                      {isEditing ? (
                        <input
                          className="input"
                          value={draft?.objet || ''}
                          onChange={(e) => setDraft({ ...draft, objet: e.target.value })}
                        />
                      ) : (r.objet || '')}
                    </td>
                    <td>
                      {isEditing ? (
                        <input
                          className="input"
                          type="number"
                          value={draft?.amount_estimated_ar ?? 0}
                          onChange={(e) => setDraft({ ...draft, amount_estimated_ar: e.target.value })}
                        />
                      ) : fmtAr(r.amount_estimated_ar)}
                    </td>
                    <td>
                      <span className={`badge ${r.status === 'APPROVED' ? 'badge-ok' : r.status === 'REJECTED' ? 'badge-bad' : ''}`}>{r.status}</span>
                    </td>
                    <td style={{ whiteSpace: 'nowrap' }}>
                      <button className="btn btn-outline btn-sm" onClick={() => openView(r.id)}>Voir</button>
                      <span style={{ display: 'inline-block', width: 6 }} />

                      {isEditing ? (
                        <>
                          <button className="btn btn-sm" onClick={saveEdit}>Valider</button>
                          <span style={{ display: 'inline-block', width: 6 }} />
                          <button className="btn btn-outline btn-sm" onClick={cancelEdit}>Annuler</button>
                          <span style={{ display: 'inline-block', width: 6 }} />
                        </>
                      ) : (
                        canEditRow && <>
                          <button className="btn btn-outline btn-sm" onClick={() => openEdit(r)}>Modifier</button>
                          <span style={{ display: 'inline-block', width: 6 }} />
                        </>
                      )}

                      {canSoftDelete && (
                        <>
                          <button className="btn btn-danger btn-sm" onClick={() => softDelete(r.id)}>Corbeille</button>
                          <span style={{ display: 'inline-block', width: 6 }} />
                        </>
                      )}

                      <a className="btn btn-outline btn-sm" href={`/print/fuel/${r.id}`} target="_blank" rel="noreferrer">Imprimer</a>

                      {/* Workflow actions */}
                      <span style={{ display: 'inline-block', width: 10 }} />
                      {role === 'DEMANDEUR' && ['DRAFT', 'REJECTED'].includes(r.status) && (
                        <button className="btn btn-sm" onClick={() => submit(r.id)}>Envoyer</button>
                      )}
                      {canVerify && r.status === 'SUBMITTED' && (
                        <button className="btn btn-sm" onClick={() => verify(r.id)}>VÃ©rifier (Logistique)</button>
                      )}
                      {canApprove && r.status === 'VERIFIED' && (
                        <>
                          <button className="btn btn-sm" onClick={() => approve(r.id)}>Visa RAF</button>
                          <span style={{ display: 'inline-block', width: 6 }} />
                          <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Rejeter</button>
                        </>
                      )}
                    </td>
                  </tr>
                );
              })
            ) : (
              <tr><td colSpan={columns.length} className="muted">Aucune demande.</td></tr>
            )}
          </tbody>
        </table>
      </div>

      {view && (
        <Modal title="DÃ©tail demande carburant" onClose={() => setView(null)} width={760}>
          {view.loading ? (
            <div className="muted">Chargement...</div>
          ) : view.data ? (
            <div>
              <div className="row" style={{ gap: 14 }}>
                <div className="card" style={{ flex: 1 }}>
                  <div className="muted">NÂ°</div>
                  <div style={{ fontWeight: 800 }}>{view.data.request_no}</div>
                </div>
                <div className="card" style={{ flex: 1 }}>
                  <div className="muted">Statut</div>
                  <div style={{ fontWeight: 800 }}>{view.data.status}</div>
                </div>
              </div>

              <div className="card" style={{ marginTop: 10 }}>
                <div className="row">
                  <div style={{ flex: 1 }}>
                    <div className="muted">Date</div>
                    <div>{String(view.data.request_date || '').slice(0,10)}</div>
                  </div>
                  <div style={{ flex: 1 }}>
                    <div className="muted">Type</div>
                    <div>{view.data.request_type}</div>
                  </div>
                </div>
                <div style={{ marginTop: 8 }}>
                  <div className="muted">Objet</div>
                  <div>{view.data.objet}</div>
                </div>
                <div className="row" style={{ marginTop: 8 }}>
                  <div style={{ flex: 1 }}>
                    <div className="muted">Montant (chiffre)</div>
                    <div>{fmtAr(view.data.amount_estimated_ar)}</div>
                  </div>
                  <div style={{ flex: 1 }}>
                    <div className="muted">Montant (lettre)</div>
                    <div>{view.data.amount_estimated_words || ''}</div>
                  </div>
                </div>
                {view.data.reject_reason && (
                  <div style={{ marginTop: 8 }}>
                    <div className="muted">Motif rejet</div>
                    <div style={{ color: '#b91c1c' }}>{view.data.reject_reason}</div>
                  </div>
                )}
              </div>
            </div>
          ) : (
            <div className="muted">Introuvable.</div>
          )}
        </Modal>
      )}
    </div>
  );
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/Fuel.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useMemo, useState } from 'react';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch, getApiUrl } from '../utils/api.js';
import Modal from '../components/Modal.jsx';

function fmt(v) {
  if (v === null || v === undefined || v === '') return '';
  return String(v);
}

function toMoneyAr(v) {
  const n = Number(v || 0);
  return n.toLocaleString('fr-FR');
}

export default function Fuel() {
  const { token, user } = useAuth();
  const [tab, setTab] = useState('vehicle');
  const [from, setFrom] = useState('');
  const [to, setTo] = useState('');
  const [vehicles, setVehicles] = useState([]);
  const [vehicleId, setVehicleId] = useState('');
  const [logs, setLogs] = useState([]);
  const [error, setError] = useState(null);
  
  // ========== Ã‰TAT POUR CRUD ==========
  const [viewModal, setViewModal] = useState(null); // {log}
  const [editModal, setEditModal] = useState(null); // {log, draft}
  
  const canManage = user && ['LOGISTIQUE', 'ADMIN'].includes(user.role);
  const canExport = canManage;

  useEffect(() => {
    apiFetch('/api/meta/vehicles', { token }).then((d) => setVehicles(d.vehicles || [])).catch(() => setVehicles([]));
  }, [token]);

  async function load() {
    setError(null);
    const qs = new URLSearchParams();
    if (from) qs.set('from', from);
    if (to) qs.set('to', to);
    if (tab === 'vehicle' && vehicleId) qs.set('vehicle_id', vehicleId);
    try {
      const d = await apiFetch(`/api/fuel/${tab}?${qs.toString()}`, { token });
      setLogs(d.logs || []);
    } catch (e) {
      setError(e.message);
      setLogs([]);
    }
  }

  useEffect(() => { load(); }, [tab]);

  async function exportCsv() {
    const qs = new URLSearchParams();
    if (from) qs.set('from', from);
    if (to) qs.set('to', to);
    if (tab === 'vehicle' && vehicleId) qs.set('vehicle_id', vehicleId);

    const url = `${getApiUrl()}/api/fuel/export?type=${encodeURIComponent(tab)}&${qs.toString()}`;
    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) {
      const txt = await res.text();
      alert(`Export failed: ${txt}`);
      return;
    }
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `export_${tab}_${from || 'all'}_${to || 'all'}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // ========== VOIR DÃ‰TAILS ==========
  function openView(log) {
    setViewModal({ log });
  }

  // ========== MODIFIER ==========
  function openEdit(log) {
    setEditModal({ log, draft: { ...log } });
  }

  async function saveEdit() {
    if (!editModal) return;
    setError(null);
    try {
      const endpoint = `/api/fuel/${tab}/${editModal.log.id}`;
      await apiFetch(endpoint, { token, method: 'PUT', body: editModal.draft });
      setEditModal(null);
      await load();
    } catch (e) {
      setError(e.message);
    }
  }

  // ========== SUPPRIMER (CORBEILLE) ==========
  async function handleDelete(log) {
    if (!confirm(`Supprimer cette ligne ?\n${log.log_date || ''}`)) return;
    setError(null);
    try {
      await apiFetch(`/api/fuel/${tab}/${log.id}`, { token, method: 'DELETE' });
      await load();
      alert('âœ… EnvoyÃ© dans le corbeille');
    } catch (e) {
      setError(e.message);
    }
  }

  const columns = useMemo(() => {
    if (tab === 'vehicle') {
      return [
        ['log_date', 'Date'],
        ['plate', 'VÃ©hicule'],
        ['day_name', 'Jour'],
        ['km_depart', 'Km dÃ©part'],
        ['km_arrivee', 'Km arrivÃ©e'],
        ['km_jour', 'Km/j'],
        ['compteur', 'Compteur'],
        ['liters', 'Litres'],
        ['montant_ar', 'Montant (Ar)'],
        ['is_refill', 'Plein'],
        ['chauffeur', 'Chauffeur'],
        ['lien', 'Lien']
      ];
    }
    if (tab === 'generator') {
      return [
        ['log_date', 'Date'],
        ['liters', 'Litres'],
        ['montant_ar', 'Montant (Ar)'],
        ['source_file_name', 'Fichier']
      ];
    }
    return [
      ['log_date', 'Date'],
      ['liters', 'Litres'],
      ['montant_ar', 'Montant (Ar)'],
      ['lien', 'Lien'],
      ['source_file_name', 'Fichier']
    ];
  }, [tab]);

  return (
    <>
      <div className="row" style={{ justifyContent: 'space-between', alignItems: 'center' }}>
        <h2>Suivi carburant</h2>
        <div className="row" style={{ gap: 8 }}>
          <button className={`btn ${tab === 'vehicle' ? '' : 'btn-secondary'}`} onClick={() => setTab('vehicle')}>VÃ©hicules</button>
          <button className={`btn ${tab === 'generator' ? '' : 'btn-secondary'}`} onClick={() => setTab('generator')}>Groupe Ã©lectrogÃ¨ne</button>
          <button className={`btn ${tab === 'other' ? '' : 'btn-secondary'}`} onClick={() => setTab('other')}>Autres</button>
        </div>
      </div>

      <div className="card" style={{ marginTop: 12 }}>
        <div className="row" style={{ flexWrap: 'wrap' }}>
          <div className="field">
            <label>Du</label>
            <input type="date" value={from} onChange={(e) => setFrom(e.target.value)} />
          </div>
          <div className="field">
            <label>Au</label>
            <input type="date" value={to} onChange={(e) => setTo(e.target.value)} />
          </div>
          {tab === 'vehicle' && (
            <div className="field">
              <label>VÃ©hicule</label>
              <select value={vehicleId} onChange={(e) => setVehicleId(e.target.value)}>
                <option value="">(Tous)</option>
                {vehicles.map((v) => (
                  <option key={v.id} value={v.id}>{v.plate}</option>
                ))}
              </select>
            </div>
          )}
          <div className="row" style={{ alignItems: 'end', gap: 8 }}>
            <button className="btn" onClick={load}>Filtrer</button>
            {canExport && <button className="btn btn-secondary" onClick={exportCsv}>Export CSV</button>}
          </div>
        </div>

        {error && <div className="notice" style={{ marginTop: 12, color: '#b91c1c' }}>{error}</div>}

        <div style={{ overflowX: 'auto', marginTop: 12 }}>
          <table className="table">
            <thead>
              <tr>
                {columns.map((c) => <th key={c[0]}>{c[1]}</th>)}
                {canManage && <th style={{ width: 200 }}>Actions</th>}
              </tr>
            </thead>
            <tbody>
              {logs.map((row, idx) => (
                <tr key={row.id || idx} className={row.is_mission ? 'row-mission' : ''}>
                  {columns.map(([k]) => {
                    const v = row[k];
                    if (k === 'montant_ar') return <td key={k}>{toMoneyAr(v)}</td>;
                    if (k === 'is_refill') return <td key={k}>{row.is_refill ? 'Oui' : 'Non'}</td>;
                    if (k === 'lien' && v) return <td key={k}><a href={v} target="_blank" rel="noreferrer">Lien</a></td>;
                    return <td key={k}>{fmt(v)}</td>;
                  })}
                  {canManage && (
                    <td style={{ whiteSpace: 'nowrap' }}>
                      <button className="btn btn-outline btn-sm" onClick={() => openView(row)}>Voir</button>
                      <span style={{ display: 'inline-block', width: 6 }} />
                      <button className="btn btn-secondary btn-sm" onClick={() => openEdit(row)}>Modifier</button>
                      <span style={{ display: 'inline-block', width: 6 }} />
                      <button className="btn btn-danger btn-sm" onClick={() => handleDelete(row)}>Mettre dans le corbeille</button>
                    </td>
                  )}
                </tr>
              ))}
              {!logs.length && <tr><td colSpan={columns.length + (canManage ? 1 : 0)} style={{ padding: 16, color: '#6b7280' }}>Aucune donnÃ©e</td></tr>}
            </tbody>
          </table>
        </div>
      </div>

      {/* ========== MODAL VOIR DÃ‰TAILS ========== */}
      {viewModal && (
        <Modal title="DÃ©tails" onClose={() => setViewModal(null)} width={700}>
          <div className="grid2">
            {columns.map(([key, label]) => (
              <div key={key} className="field">
                <div className="label">{label}</div>
                <div style={{ fontWeight: 600 }}>
                  {key === 'montant_ar' ? toMoneyAr(viewModal.log[key]) : 
                   key === 'is_refill' ? (viewModal.log[key] ? 'Oui' : 'Non') :
                   fmt(viewModal.log[key])}
                </div>
              </div>
            ))}
          </div>
        </Modal>
      )}

      {/* ========== MODAL MODIFIER ========== */}
      {editModal && (
        <Modal title="Modifier" onClose={() => setEditModal(null)} width={700}>
          <div className="grid2">
            {tab === 'vehicle' && (
              <>
                <div className="field">
                  <label>Date</label>
                  <input 
                    type="date" 
                    value={editModal.draft.log_date || ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, log_date: e.target.value } })}
                  />
                </div>
                <div className="field">
                  <label>Km dÃ©part</label>
                  <input 
                    type="number" 
                    value={editModal.draft.km_depart ?? ''} 
                    onChange={(e) => {
                      const val = e.target.value === '' ? null : Number(e.target.value);
                      const draft = { ...editModal.draft, km_depart: val };
                      // Auto-calcul km_jour si km_arrivee existe
                      if (draft.km_arrivee !== null && val !== null) {
                        draft.km_jour = draft.km_arrivee - val;
                      }
                      setEditModal({ ...editModal, draft });
                    }}
                  />
                </div>
                <div className="field">
                  <label>Km arrivÃ©e</label>
                  <input 
                    type="number" 
                    value={editModal.draft.km_arrivee ?? ''} 
                    onChange={(e) => {
                      const val = e.target.value === '' ? null : Number(e.target.value);
                      const draft = { ...editModal.draft, km_arrivee: val };
                      // Auto-calcul km_jour si km_depart existe
                      if (draft.km_depart !== null && val !== null) {
                        draft.km_jour = val - draft.km_depart;
                      }
                      setEditModal({ ...editModal, draft });
                    }}
                  />
                </div>
                <div className="field">
                  <label>Km/j (calculÃ© auto)</label>
                  <input 
                    type="number" 
                    value={editModal.draft.km_jour ?? ''} 
                    disabled
                    style={{ background: '#f3f4f6', cursor: 'not-allowed' }}
                  />
                </div>
                <div className="field">
                  <label>Compteur</label>
                  <input 
                    type="number" 
                    value={editModal.draft.compteur ?? ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, compteur: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Litres</label>
                  <input 
                    type="number" 
                    step="0.01"
                    value={editModal.draft.liters ?? ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, liters: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Montant (Ar)</label>
                  <input 
                    type="number" 
                    value={editModal.draft.montant_ar ?? ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, montant_ar: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Chauffeur</label>
                  <input 
                    value={editModal.draft.chauffeur || ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, chauffeur: e.target.value } })}
                  />
                </div>
                <div className="field">
                  <label>Lien</label>
                  <input 
                    value={editModal.draft.lien || ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, lien: e.target.value } })}
                  />
                </div>
              </>
            )}

            {tab === 'generator' && (
              <>
                <div className="field">
                  <label>Date</label>
                  <input 
                    type="date" 
                    value={editModal.draft.log_date || ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, log_date: e.target.value } })}
                  />
                </div>
                <div className="field">
                  <label>Litres</label>
                  <input 
                    type="number" 
                    step="0.01"
                    value={editModal.draft.liters ?? ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, liters: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Montant (Ar)</label>
                  <input 
                    type="number" 
                    value={editModal.draft.montant_ar ?? ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, montant_ar: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
              </>
            )}

            {tab === 'other' && (
              <>
                <div className="field">
                  <label>Date</label>
                  <input 
                    type="date" 
                    value={editModal.draft.log_date || ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, log_date: e.target.value } })}
                  />
                </div>
                <div className="field">
                  <label>Litres</label>
                  <input 
                    type="number" 
                    step="0.01"
                    value={editModal.draft.liters ?? ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, liters: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Montant (Ar)</label>
                  <input 
                    type="number" 
                    value={editModal.draft.montant_ar ?? ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, montant_ar: e.target.value === '' ? null : Number(e.target.value) } })}
                  />
                </div>
                <div className="field">
                  <label>Lien</label>
                  <input 
                    value={editModal.draft.lien || ''} 
                    onChange={(e) => setEditModal({ ...editModal, draft: { ...editModal.draft, lien: e.target.value } })}
                  />
                </div>
              </>
            )}
          </div>

          <div className="row" style={{ justifyContent: 'flex-end', marginTop: 16, gap: 8 }}>
            <button className="btn btn-outline" onClick={() => setEditModal(null)}>Annuler</button>
            <button className="btn" onClick={saveEdit}>Enregistrer</button>
          </div>
        </Modal>
      )}
    </>
  );
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/Forgot.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import { apiFetch } from '../utils/api.js';

export default function Forgot() {
  const [email, setEmail] = useState('');
  const [sent, setSent] = useState(false);
  const [error, setError] = useState(null);

  async function onSubmit(e) {
    e.preventDefault();
    setError(null);
    try {
      await apiFetch('/api/auth/forgot', { method: 'POST', body: { email } });
      setSent(true);
    } catch (e2) {
      setError(e2.message);
    }
  }

  return (
    <div className="container" style={{ maxWidth: 520 }}>
      <div className="card">
        <h2>Mot de passe oubliÃ©</h2>
        {sent ? (
          <p className="muted">
            Si lâ€™adresse existe, un lien de rÃ©initialisation a Ã©tÃ© envoyÃ©.
            (Si SMTP nâ€™est pas configurÃ©, le lien sâ€™affiche dans la console du serveur.)
          </p>
        ) : (
          <form onSubmit={onSubmit} className="form">
            <label className="label">Email</label>
            <input className="input" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="ex: nom@prirtem.mg" />
            {error && <div className="error">{error}</div>}
            <button className="btn" type="submit">Envoyer</button>
          </form>
        )}
        <div style={{ marginTop: 10 }}>
          <Link to="/login">Retour</Link>
        </div>
      </div>
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/Dashboard.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useMemo, useState } from 'react';
import { Line } from 'react-chartjs-2';
import { Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend } from 'chart.js';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';

ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Tooltip, Legend);

function fmtAr(n) {
  const v = Number(n || 0);
  return v.toLocaleString('fr-FR');
}

export default function Dashboard() {
  const { token } = useAuth();
  const [from, setFrom] = useState('');
  const [to, setTo] = useState('');
  const [summary, setSummary] = useState(null);
  const [daily, setDaily] = useState([]);
  const [byVehicle, setByVehicle] = useState([]);
  const [err, setErr] = useState(null);

  async function load() {
    setErr(null);
    try {
      const s = await apiFetch(`/api/fuel/report/summary?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`, { token });
      const d = await apiFetch(`/api/fuel/kpi/daily?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`, { token });
      const bv = await apiFetch(`/api/fuel/kpi/by-vehicle?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`, { token });
      setSummary(s);
      setDaily(d.points || []);
      setByVehicle(bv.rows || []);
    } catch (e) {
      setErr(e.message);
    }
  }

  useEffect(() => { load(); // initial
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const chartData = useMemo(() => {
    const labels = daily.map(p => p.log_date || '');
    return {
      labels,
      datasets: [
        { label: 'Montant vÃ©hicule (Ar)', data: daily.map(p => Number(p.montant_ar || 0)) },
        { label: 'Litres vÃ©hicule', data: daily.map(p => Number(p.liters || 0)) }
      ]
    };
  }, [daily]);

  return (
    <div>
      <div className="row" style={{ marginBottom: 12 }}>
        <div className="card" style={{ flex: 1 }}>
          <div className="h1">Dashboard</div>
          <div className="row" style={{ gap: 10, alignItems: 'end' }}>
            <div>
              <div className="label">Du</div>
              <input className="input" type="date" value={from} onChange={(e) => setFrom(e.target.value)} />
            </div>
            <div>
              <div className="label">Au</div>
              <input className="input" type="date" value={to} onChange={(e) => setTo(e.target.value)} />
            </div>
            <button className="btn" onClick={load}>Actualiser</button>
          </div>
          {err && <div className="error" style={{ marginTop: 10 }}>{err}</div>}
        </div>
      </div>

      {summary && (
        <div className="row" style={{ gap: 12, marginBottom: 12 }}>
          <div className="card" style={{ flex: 1 }}>
            <div className="h2">VÃ©hicules</div>
            <div>Montant: <b>{fmtAr(summary.vehicle?.montant_ar)} Ar</b></div>
            <div>Litres: <b>{Number(summary.vehicle?.liters || 0).toFixed(2)}</b></div>
            <div>Repleins: <b>{summary.vehicle?.refills || 0}</b></div>
          </div>
          <div className="card" style={{ flex: 1 }}>
            <div className="h2">Groupe Ã©lectrogÃ¨ne</div>
            <div>Montant: <b>{fmtAr(summary.generator?.montant_ar)} Ar</b></div>
            <div>Litres: <b>{Number(summary.generator?.liters || 0).toFixed(2)}</b></div>
          </div>
          <div className="card" style={{ flex: 1 }}>
            <div className="h2">Autres</div>
            <div>Montant: <b>{fmtAr(summary.other?.montant_ar)} Ar</b></div>
            <div>Litres: <b>{Number(summary.other?.liters || 0).toFixed(2)}</b></div>
          </div>
        </div>
      )}

      <div className="row" style={{ gap: 12 }}>
        <div className="card" style={{ flex: 2 }}>
          <div className="h2">VÃ©hicule - Ã©volution par jour</div>
          <Line data={chartData} />
        </div>
        <div className="card" style={{ flex: 1 }}>
          <div className="h2">Top vÃ©hicules (montant)</div>
          <div className="tableWrap">
            <table>
              <thead>
                <tr><th>VÃ©hicule</th><th>Montant</th><th>Litres</th></tr>
              </thead>
              <tbody>
                {byVehicle.slice(0, 12).map((r) => (
                  <tr key={r.plate}>
                    <td>{r.plate}</td>
                    <td>{fmtAr(r.montant_ar)} Ar</td>
                    <td>{Number(r.liters || 0).toFixed(2)}</td>
                  </tr>
                ))}
                {!byVehicle.length && <tr><td colSpan="3" className="muted">Aucune donnÃ©e</td></tr>}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/CarRequestsManage.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

export default function CarRequestsManage() {
  const { token, user } = useAuth();
  const role = user?.role;

  const [requests, setRequests] = useState([]);
  const [vehicles, setVehicles] = useState([]);
  const [drivers, setDrivers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const [viewId, setViewId] = useState(null);
  const [viewData, setViewData] = useState(null);
  const [viewLoading, setViewLoading] = useState(false);

  const [editId, setEditId] = useState(null);
  const [draft, setDraft] = useState(null);

  const [visa, setVisa] = useState(null); // {id, vehicle_id, driver_id}

  async function load() {
    setLoading(true);
    setError(null);
    try {
      const [r, v, d] = await Promise.all([
        apiFetch('/api/requests/car?status=SUBMITTED', { token }),
        apiFetch('/api/meta/vehicles', { token }),
        apiFetch('/api/meta/drivers', { token })
      ]);
      setRequests(r.requests || []);
      setVehicles(v.vehicles || []);
      setDrivers(d.drivers || []);
    } catch (e) {
      setError(e.message);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => { load(); }, []);

  const canManage = useMemo(() => ['LOGISTIQUE','ADMIN'].includes(role), [role]);

  async function openView(id) {
    setViewId(id);
    setViewLoading(true);
    try {
      const d = await apiFetch(`/api/requests/car/${id}`, { token });
      setViewData(d.request);
    } catch (e) {
      alert(e.message);
      setViewId(null);
      setViewData(null);
    } finally {
      setViewLoading(false);
    }
  }

  function openEdit(row) {
    setEditId(row.id);
    setDraft({
      proposed_date: row.proposed_date || '',
      objet: row.objet || '',
      itinerary: row.itinerary || '',
      people: row.people || '',
      depart_time_wanted: row.depart_time_wanted || '',
      return_time_expected: row.return_time_expected || '',
      vehicle_hint: row.vehicle_hint || '',
      driver_hint: row.driver_hint || ''
    });
  }

  async function saveEdit(id) {
    try {
      await apiFetch(`/api/requests/car/${id}`, { token, method: 'PUT', body: { ...draft } });
      setEditId(null);
      setDraft(null);
      await load();
    } catch (e) {
      alert(e.message);
    }
  }

  function cancelEdit() {
    setEditId(null);
    setDraft(null);
  }

  async function softDelete(id) {
    if (!confirm('DÃ©placer en Corbeille ?')) return;
    try {
      await apiFetch(`/api/requests/car/${id}`, { token, method: 'DELETE' });
      await load();
      alert('OK âœ… DÃ©placÃ© dans Corbeille');
    } catch (e) {
      alert(e.message);
    }
  }

  function openVisa(row) {
    setVisa({
      id: row.id,
      vehicle_id: row.vehicle_id || '',
      driver_id: row.driver_id || ''
    });
  }

  async function doVisa() {
    if (!visa?.id) return;
    if (!visa.vehicle_id || !visa.driver_id) {
      alert('Choisis vÃ©hicule + chauffeur avant Visa.');
      return;
    }
    try {
      await apiFetch(`/api/requests/car/${visa.id}/visa`, { token, method: 'POST', body: { vehicle_id: visa.vehicle_id, driver_id: visa.driver_id } });
      setVisa(null);
      await load();
    } catch (e) {
      alert(e.message);
    }
  }

  async function reject(id) {
    const reason = prompt('Motif rejet (optionnel)') || null;
    try {
      await apiFetch(`/api/requests/car/${id}/reject`, { token, method: 'POST', body: { reason } });
      await load();
    } catch (e) {
      alert(e.message);
    }
  }

  async function printOne(id) {
    try {
      const d = await apiFetch(`/api/requests/car/${id}/print`, { token });
      window.open(d.url, '_blank');
    } catch (e) {
      alert(e.message);
    }
  }

  return (
    <div className="card">
      <h2>Validation voiture (Logistique/Admin)</h2>
      {error && <div className="alert">{error}</div>}
      {loading ? <div className="muted">Chargement...</div> : null}

      <table className="table">
        <thead>
          <tr>
            <th>NÂ°</th>
            <th>Date proposÃ©e</th>
            <th>Objet</th>
            <th>Statut</th>
            <th style={{ width: 420 }}></th>
          </tr>
        </thead>
        <tbody>
          {requests.map((r) => {
            const editing = editId === r.id;
            return (
              <tr key={r.id}>
                <td>{r.request_no}</td>
                <td>
                  {editing ? (
                    <input className="input" type="date" value={draft.proposed_date} onChange={(e) => setDraft({ ...draft, proposed_date: e.target.value })} />
                  ) : r.proposed_date}
                </td>
                <td>
                  {editing ? (
                    <input className="input" value={draft.objet} onChange={(e) => setDraft({ ...draft, objet: e.target.value })} />
                  ) : (
                    <div style={{ maxWidth: 420, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{r.objet}</div>
                  )}
                </td>
                <td><span className="badge badge-info">{r.status}</span></td>
                <td style={{ whiteSpace: 'nowrap' }}>
                  <button className="btn btn-outline btn-sm" onClick={() => openView(r.id)}>Voir</button>
                  <span style={{ display: 'inline-block', width: 8 }} />

                  {editing ? (
                    <>
                      <button className="btn btn-sm" onClick={() => saveEdit(r.id)}>Valider</button>
                      <span style={{ display: 'inline-block', width: 8 }} />
                      <button className="btn btn-outline btn-sm" onClick={cancelEdit}>Annuler</button>
                    </>
                  ) : (
                    <button className="btn btn-outline btn-sm" onClick={() => openEdit(r)}>Modifier</button>
                  )}

                  <span style={{ display: 'inline-block', width: 8 }} />
                  <button className="btn btn-secondary btn-sm" onClick={() => printOne(r.id)}>Imprimer</button>

                  {canManage && !editing ? (
                    <>
                      <span style={{ display: 'inline-block', width: 8 }} />
                      <button className="btn btn-sm" onClick={() => openVisa(r)}>Visa Logistique</button>
                      <span style={{ display: 'inline-block', width: 8 }} />
                      <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Rejeter</button>
                      <span style={{ display: 'inline-block', width: 8 }} />
                      <button className="btn btn-danger btn-sm" onClick={() => softDelete(r.id)}>Supprimer</button>
                    </>
                  ) : null}
                </td>
              </tr>
            );
          })}
          {!requests.length && (
            <tr><td colSpan={5} className="muted">Aucune demande en attente.</td></tr>
          )}
        </tbody>
      </table>

      {viewId && (
        <Modal title="DÃ©tails demande voiture" onClose={() => { setViewId(null); setViewData(null); }} width={860}>
          {viewLoading ? (
            <div className="muted">Chargement...</div>
          ) : viewData ? (
            <div className="grid2">
              <div className="card">
                <div className="label">NÂ°</div><div><b>{viewData.request_no}</b></div>
                <div className="label" style={{ marginTop: 10 }}>Date proposÃ©e</div><div>{viewData.proposed_date}</div>
                <div className="label" style={{ marginTop: 10 }}>Objet</div><div>{viewData.objet}</div>
                <div className="label" style={{ marginTop: 10 }}>ItinÃ©raire</div><div>{viewData.itinerary || <span className="muted">â€”</span>}</div>
                <div className="label" style={{ marginTop: 10 }}>Personnes</div><div>{viewData.people || <span className="muted">â€”</span>}</div>
              </div>
              <div className="card">
                <div className="label">Heure dÃ©part</div><div>{viewData.depart_time_wanted || <span className="muted">â€”</span>}</div>
                <div className="label" style={{ marginTop: 10 }}>Heure retour</div><div>{viewData.return_time_expected || <span className="muted">â€”</span>}</div>
                <div className="label" style={{ marginTop: 10 }}>Hints</div>
                <div className="muted">VÃ©hicule: {viewData.vehicle_hint || 'â€”'} â€¢ Chauffeur: {viewData.driver_hint || 'â€”'}</div>
                <div className="label" style={{ marginTop: 10 }}>Statut</div>
                <div><span className="badge">{viewData.status}</span></div>
              </div>
            </div>
          ) : <div className="muted">Aucune donnÃ©e</div>}
        </Modal>
      )}

      {visa && (
        <Modal title="Visa Logistique (assigner vÃ©hicule + chauffeur)" onClose={() => setVisa(null)} width={700}>
          <div className="form">
            <label>
              VÃ©hicule
              <select value={visa.vehicle_id} onChange={(e) => setVisa({ ...visa, vehicle_id: e.target.value })}>
                <option value="">-- sÃ©lectionner --</option>
                {vehicles.map((v) => <option key={v.id} value={v.id}>{v.plate}</option>)}
              </select>
            </label>
            <label>
              Chauffeur
              <select value={visa.driver_id} onChange={(e) => setVisa({ ...visa, driver_id: e.target.value })}>
                <option value="">-- sÃ©lectionner --</option>
                {drivers.map((d) => <option key={d.id} value={d.id}>{d.full_name}</option>)}
              </select>
            </label>
            <div className="row">
              <button className="btn" onClick={doVisa}>Valider Visa</button>
              <button className="btn btn-outline" onClick={() => setVisa(null)}>Annuler</button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/CarRequests.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

export default function CarRequests() {
  const { token, user } = useAuth();
  const role = user?.role;

  const [requests, setRequests] = useState([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);

  const [vehicles, setVehicles] = useState([]);
  const [drivers, setDrivers] = useState([]);

  const [form, setForm] = useState({
    proposed_date: new Date().toISOString().slice(0, 10),
    objet: '',
    itinerary: '',
    people: '',
    depart_time_wanted: '',
    return_time_expected: '',
    vehicle_hint: '',
    driver_hint: ''
  });
  const [creating, setCreating] = useState(false);

  const [view, setView] = useState(null); // {loading, data}
  const [editId, setEditId] = useState(null);
  const [draft, setDraft] = useState(null);

  const [visaModal, setVisaModal] = useState(null); // {id, vehicle_id, driver_id}

  const canCreate = role === 'DEMANDEUR';
  const canVisaLogistique = ['LOGISTIQUE', 'ADMIN'].includes(role);
  const canVisaRaf = ['RAF', 'ADMIN'].includes(role);
  const canSoftDelete = ['LOGISTIQUE', 'ADMIN'].includes(role);

  const columns = useMemo(() => ['NÂ°', 'Date', 'Objet', 'Statut', 'Actions'], []);

  async function load() {
    setLoading(true);
    setErr(null);
    try {
      const d = await apiFetch('/api/requests/car', { token });
      setRequests(d.requests || []);
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setLoading(false);
    }
  }

  async function loadMeta() {
    try {
      const [v, dr] = await Promise.all([
        apiFetch('/api/meta/vehicles', { token }),
        apiFetch('/api/meta/drivers', { token })
      ]);
      setVehicles(v.vehicles || []);
      setDrivers(dr.drivers || []);
    } catch {
      // ignore
    }
  }

  useEffect(() => {
    load();
    loadMeta();
  }, []);

  const create = async () => {
    setCreating(true);
    setErr(null);
    try {
      await apiFetch('/api/requests/car', { method: 'POST', token, body: form });
      setForm({ proposed_date: new Date().toISOString().slice(0, 10), objet: '', itinerary: '', people: '', depart_time_wanted: '', return_time_expected: '', vehicle_hint: '', driver_hint: '' });
      await load();
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setCreating(false);
    }
  };

  const openView = async (id) => {
    setView({ loading: true, data: null });
    try {
      const d = await apiFetch(`/api/requests/car/${id}`, { token });
      setView({ loading: false, data: d.request });
    } catch (e) {
      setView({ loading: false, data: null });
      alert(String(e.message || e));
    }
  };

  const openEdit = (r) => {
    setEditId(r.id);
    setDraft({
      proposed_date: (r.proposed_date || '').slice(0, 10),
      objet: r.objet || '',
      itinerary: r.itinerary || '',
      people: r.people || '',
      depart_time_wanted: r.depart_time_wanted || '',
      return_time_expected: r.return_time_expected || '',
      vehicle_hint: r.vehicle_hint || '',
      driver_hint: r.driver_hint || ''
    });
  };

  const cancelEdit = () => {
    setEditId(null);
    setDraft(null);
  };

  const saveEdit = async () => {
    if (!editId || !draft) return;
    try {
      const body = {
        proposed_date: draft.proposed_date,
        objet: draft.objet,
        itinerary: draft.itinerary,
        people: draft.people,
        depart_time_wanted: draft.depart_time_wanted || null,
        return_time_expected: draft.return_time_expected || null,
        vehicle_hint: draft.vehicle_hint || null,
        driver_hint: draft.driver_hint || null
      };
      await apiFetch(`/api/requests/car/${editId}`, { method: 'PUT', token, body });
      cancelEdit();
      await load();
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const softDelete = async (r) => {
    if (!canSoftDelete) return;
    if (!confirm(`DÃ©placer dans Corbeille ?\n${r.request_no}`)) return;
    try {
      await apiFetch(`/api/requests/car/${r.id}`, { method: 'DELETE', token });
      await load();
      alert('OK: dÃ©placÃ© dans Corbeille âœ…');
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const logisticsVisa = async (id, vehicle_id, driver_id) => {
    try {
      await apiFetch(`/api/requests/car/${id}/visa`, { method: 'POST', token, body: { vehicle_id: vehicle_id || null, driver_id: driver_id || null } });
      setVisaModal(null);
      await load();
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const rafApprove = async (id) => {
    try {
      await apiFetch(`/api/requests/car/${id}/approve`, { method: 'POST', token });
      await load();
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const reject = async (id) => {
    const reason = prompt('Motif rejet (optionnel)');
    try {
      await apiFetch(`/api/requests/car/${id}/reject`, { method: 'POST', token, body: { reason: reason || null } });
      await load();
    } catch (e) {
      alert(String(e.message || e));
    }
  };

  const canEditRow = (r) => {
    if (role === 'DEMANDEUR') return r.status === 'SUBMITTED';
    if (['ADMIN', 'LOGISTIQUE'].includes(role)) return r.status === 'SUBMITTED';
    return false;
  };

  return (
    <div>
      <h1 style={{ marginTop: 0 }}>Demandes voiture</h1>

      {err && <div className="muted" style={{ color: '#b91c1c' }}>{err}</div>}

      {canCreate && (
        <div className="card" style={{ marginBottom: 16 }}>
          <div style={{ fontWeight: 800, marginBottom: 10 }}>Nouvelle demande</div>
          <div className="grid2">
            <div className="field">
              <div className="label">Date proposÃ©e</div>
              <input className="input" type="date" value={form.proposed_date} onChange={(e) => setForm({ ...form, proposed_date: e.target.value })} />
            </div>
            <div className="field">
              <div className="label">Objet</div>
              <input className="input" value={form.objet} onChange={(e) => setForm({ ...form, objet: e.target.value })} placeholder="Objet..." />
            </div>
            <div className="field">
              <div className="label">ItinÃ©raire</div>
              <textarea className="input" rows={3} value={form.itinerary} onChange={(e) => setForm({ ...form, itinerary: e.target.value })} placeholder="DÃ©part â†’ ArrivÃ©e..." />
            </div>
            <div className="field">
              <div className="label">Personnes transportÃ©es</div>
              <textarea className="input" rows={3} value={form.people} onChange={(e) => setForm({ ...form, people: e.target.value })} placeholder="Liste des personnes..." />
            </div>
            <div className="field">
              <div className="label">Heure dÃ©part souhaitÃ©e</div>
              <input className="input" type="time" value={form.depart_time_wanted} onChange={(e) => setForm({ ...form, depart_time_wanted: e.target.value })} />
            </div>
            <div className="field">
              <div className="label">Heure probable retour</div>
              <input className="input" type="time" value={form.return_time_expected} onChange={(e) => setForm({ ...form, return_time_expected: e.target.value })} />
            </div>
            <div className="field">
              <div className="label">Immatriculation (si connu)</div>
              <input className="input" value={form.vehicle_hint} onChange={(e) => setForm({ ...form, vehicle_hint: e.target.value })} placeholder="ex: 39961 WWT" />
            </div>
            <div className="field">
              <div className="label">Chauffeur (si connu)</div>
              <input className="input" value={form.driver_hint} onChange={(e) => setForm({ ...form, driver_hint: e.target.value })} placeholder="Nom chauffeur..." />
            </div>
          </div>
          <div style={{ marginTop: 10 }}>
            <button className="btn" onClick={create} disabled={creating}>Envoyer</button>
          </div>
        </div>
      )}

      <div style={{ overflow: 'auto' }}>
        <table className="table">
          <thead>
            <tr>
              {columns.map((c) => (<th key={c}>{c}</th>))}
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr><td colSpan={columns.length} className="muted">Chargement...</td></tr>
            ) : requests.length ? (
              requests.map((r) => {
                const editing = editId === r.id;
                return (
                  <tr key={r.id}>
                    <td><b>{r.request_no}</b></td>
                    <td>
                      {editing ? (
                        <input className="input" type="date" value={draft?.proposed_date || ''} onChange={(e) => setDraft({ ...draft, proposed_date: e.target.value })} />
                      ) : (
                        String(r.proposed_date || '')
                      )}
                    </td>
                    <td>
                      {editing ? (
                        <input className="input" value={draft?.objet || ''} onChange={(e) => setDraft({ ...draft, objet: e.target.value })} />
                      ) : (
                        <span>{r.objet}</span>
                      )}
                    </td>
                    <td><span className="badge badge-ok">{r.status}</span></td>
                    <td style={{ whiteSpace: 'nowrap' }}>
                      <button className="btn btn-outline btn-sm" onClick={() => openView(r.id)}>Voir</button>
                      <span style={{ display: 'inline-block', width: 8 }} />

                      {editing ? (
                        <>
                          <button className="btn btn-sm" onClick={saveEdit}>Valider</button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                          <button className="btn btn-outline btn-sm" onClick={cancelEdit}>Annuler</button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                        </>
                      ) : (
                        canEditRow(r) && (
                          <>
                            <button className="btn btn-outline btn-sm" onClick={() => openEdit(r)}>Modifier</button>
                            <span style={{ display: 'inline-block', width: 8 }} />
                          </>
                        )
                      )}

                      <a className="btn btn-outline btn-sm" href={`/print/car/${r.id}`} target="_blank" rel="noreferrer">Imprimer</a>
                      <span style={{ display: 'inline-block', width: 8 }} />

                      {canVisaLogistique && r.status === 'SUBMITTED' && (
                        <>
                          <button
                            className="btn btn-sm"
                            onClick={() => setVisaModal({ id: r.id, vehicle_id: r.vehicle_id || '', driver_id: r.driver_id || '' })}
                          >
                            Visa logistique
                          </button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                        </>
                      )}

                      {canVisaRaf && r.status === 'LOGISTICS_APPROVED' && (
                        <>
                          <button className="btn btn-sm" onClick={() => rafApprove(r.id)}>Visa RAF</button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                        </>
                      )}

                      {canVisaLogistique && r.status === 'SUBMITTED' && (
                        <>
                          <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Non-valider</button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                        </>
                      )}

                      {canVisaRaf && r.status === 'LOGISTICS_APPROVED' && (
                        <>
                          <button className="btn btn-outline btn-sm" onClick={() => reject(r.id)}>Non-valider</button>
                          <span style={{ display: 'inline-block', width: 8 }} />
                        </>
                      )}

                      {canSoftDelete && (
                        <button className="btn btn-danger btn-sm" onClick={() => softDelete(r)}>Corbeille</button>
                      )}
                    </td>
                  </tr>
                );
              })
            ) : (
              <tr><td colSpan={columns.length} className="muted">Aucune demande.</td></tr>
            )}
          </tbody>
        </table>
      </div>

      {view && (
        <Modal title={view.loading ? 'Chargement...' : `DÃ©tails ${view.data?.request_no || ''}`} onClose={() => setView(null)} width={720}>
          {view.loading ? (
            <div className="muted">Chargement...</div>
          ) : view.data ? (
            <div>
              <div className="grid2">
                <div className="card">
                  <div className="muted">Date proposÃ©e</div>
                  <div style={{ fontWeight: 800 }}>{String(view.data.proposed_date || '')}</div>
                </div>
                <div className="card">
                  <div className="muted">Statut</div>
                  <div style={{ fontWeight: 800 }}>{String(view.data.status || '')}</div>
                </div>
              </div>
              <div className="card" style={{ marginTop: 10 }}>
                <div className="muted">Objet</div>
                <div style={{ fontWeight: 700 }}>{view.data.objet}</div>
                <hr />
                <div className="muted">ItinÃ©raire</div>
                <div>{view.data.itinerary}</div>
                <hr />
                <div className="muted">Personnes transportÃ©es</div>
                <div>{view.data.people}</div>
                <hr />
                <div className="row" style={{ gap: 10 }}>
                  <div className="card" style={{ flex: 1 }}>
                    <div className="muted">DÃ©part souhaitÃ©</div>
                    <div style={{ fontWeight: 800 }}>{String(view.data.depart_time_wanted || '')}</div>
                  </div>
                  <div className="card" style={{ flex: 1 }}>
                    <div className="muted">Retour probable</div>
                    <div style={{ fontWeight: 800 }}>{String(view.data.return_time_expected || '')}</div>
                  </div>
                </div>
                <hr />
                <div className="row" style={{ gap: 10 }}>
                  <div className="card" style={{ flex: 1 }}>
                    <div className="muted">VÃ©hicule (hint)</div>
                    <div style={{ fontWeight: 800 }}>{String(view.data.vehicle_hint || '')}</div>
                  </div>
                  <div className="card" style={{ flex: 1 }}>
                    <div className="muted">Chauffeur (hint)</div>
                    <div style={{ fontWeight: 800 }}>{String(view.data.driver_hint || '')}</div>
                  </div>
                </div>
              </div>
              <div className="row" style={{ justifyContent: 'flex-end', marginTop: 10 }}>
                <a className="btn" href={`/print/car/${view.data.id}`} target="_blank" rel="noreferrer">Imprimer</a>
              </div>
            </div>
          ) : (
            <div className="muted">Impossible de charger ce dÃ©tail.</div>
          )}
        </Modal>
      )}

      {visaModal && (
        <Modal title="Visa logistique" onClose={() => setVisaModal(null)} width={640}>
          <div className="muted" style={{ marginBottom: 8 }}>
            Optionnel: tu peux assigner un vÃ©hicule + chauffeur au moment du visa.
          </div>
          <div className="grid2">
            <div className="field">
              <div className="label">VÃ©hicule</div>
              <select className="input" value={visaModal.vehicle_id} onChange={(e) => setVisaModal({ ...visaModal, vehicle_id: e.target.value })}>
                <option value="">(aucun)</option>
                {vehicles.map((v) => (
                  <option key={v.id} value={v.id}>{v.plate} {v.label ? `â€” ${v.label}` : ''}</option>
                ))}
              </select>
            </div>
            <div className="field">
              <div className="label">Chauffeur</div>
              <select className="input" value={visaModal.driver_id} onChange={(e) => setVisaModal({ ...visaModal, driver_id: e.target.value })}>
                <option value="">(aucun)</option>
                {drivers.map((d) => (
                  <option key={d.id} value={d.id}>{d.full_name} {d.phone ? `â€” ${d.phone}` : ''}</option>
                ))}
              </select>
            </div>
          </div>

          <div className="row" style={{ justifyContent: 'flex-end', marginTop: 12 }}>
            <button className="btn btn-outline" onClick={() => setVisaModal(null)}>Annuler</button>
            <button className="btn" onClick={() => logisticsVisa(visaModal.id, visaModal.vehicle_id, visaModal.driver_id)}>Valider visa</button>
          </div>
        </Modal>
      )}
    </div>
  );
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/CalendarView.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useState, useMemo } from 'react';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';
import Modal from '../components/Modal.jsx';

export default function CalendarView() {
  const { token } = useAuth();
  const [requests, setRequests] = useState([]);
  const [loading, setLoading] = useState(true);
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(null);
  const [viewModal, setViewModal] = useState(null);

  useEffect(() => {
    loadRequests();
  }, []);

  async function loadRequests() {
    setLoading(true);
    try {
      const data = await apiFetch('/api/requests/car', { token });
      setRequests(data.requests || []);
    } catch (e) {
      console.error('Failed to load requests:', e);
    } finally {
      setLoading(false);
    }
  }

  // Grouper les demandes par date
  const requestsByDate = useMemo(() => {
    const map = {};
    requests.forEach(req => {
      const date = req.proposed_date;
      if (!map[date]) map[date] = [];
      map[date].push(req);
    });
    return map;
  }, [requests]);

  // GÃ©nÃ©rer les jours du mois
  const calendarDays = useMemo(() => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay(); // 0 = Dimanche
    const daysInMonth = lastDay.getDate();

    const days = [];
    
    // Jours du mois prÃ©cÃ©dent (padding)
    for (let i = 0; i < startDay; i++) {
      days.push({ date: null, isCurrentMonth: false });
    }

    // Jours du mois actuel
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      days.push({ date: dateStr, isCurrentMonth: true });
    }

    return days;
  }, [currentMonth]);

  const changeMonth = (offset) => {
    const newDate = new Date(currentMonth);
    newDate.setMonth(newDate.getMonth() + offset);
    setCurrentMonth(newDate);
  };

  const openDayModal = (dateStr) => {
    setSelectedDate(dateStr);
  };

  const openViewModal = async (id) => {
    setViewModal({ loading: true, data: null });
    try {
      const d = await apiFetch(`/api/requests/car/${id}`, { token });
      setViewModal({ loading: false, data: d.request });
    } catch (e) {
      alert(e.message);
      setViewModal(null);
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'SUBMITTED': return '#f59e0b';
      case 'LOGISTICS_APPROVED': return '#3b82f6';
      case 'RAF_APPROVED': return '#10b981';
      case 'REJECTED': return '#ef4444';
      default: return '#6b7280';
    }
  };

  return (
    <div>
      <div className="row" style={{ justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
        <h1 style={{ margin: 0 }}>ğŸ“… Calendrier Demandes Voiture</h1>
        <div className="row" style={{ gap: 8 }}>
          <button className="btn btn-outline" onClick={() => changeMonth(-1)}>â† Mois prÃ©cÃ©dent</button>
          <button className="btn btn-outline" onClick={() => setCurrentMonth(new Date())}>Aujourd'hui</button>
          <button className="btn btn-outline" onClick={() => changeMonth(1)}>Mois suivant â†’</button>
        </div>
      </div>

      {/* En-tÃªte mois/annÃ©e */}
      <div style={{ textAlign: 'center', marginBottom: 16, fontSize: '20px', fontWeight: '700' }}>
        {currentMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase())}
      </div>

      {loading ? (
        <div style={{ textAlign: 'center', padding: 40, color: '#6b7280' }}>Chargement...</div>
      ) : (
        <div className="card" style={{ padding: 0, overflow: 'hidden' }}>
          {/* Grille calendrier */}
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: 1, background: '#e5e7eb' }}>
            {/* En-tÃªtes jours */}
            {['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'].map(day => (
              <div key={day} style={{ background: '#f9fafb', padding: '8px', textAlign: 'center', fontWeight: '700', fontSize: '12px' }}>
                {day}
              </div>
            ))}

            {/* Jours du mois */}
            {calendarDays.map((day, idx) => {
              if (!day.isCurrentMonth) {
                return <div key={idx} style={{ background: '#fafafa', minHeight: 100 }} />;
              }

              const dayRequests = requestsByDate[day.date] || [];
              const dayNumber = parseInt(day.date.split('-')[2]);
              const isToday = day.date === new Date().toISOString().slice(0, 10);

              return (
                <div
                  key={idx}
                  style={{
                    background: 'white',
                    minHeight: 100,
                    padding: '8px',
                    cursor: dayRequests.length > 0 ? 'pointer' : 'default',
                    border: isToday ? '2px solid #3b82f6' : 'none',
                    position: 'relative'
                  }}
                  onClick={() => dayRequests.length > 0 && openDayModal(day.date)}
                >
                  {/* NumÃ©ro du jour */}
                  <div style={{ fontWeight: '700', fontSize: '14px', marginBottom: 4, color: isToday ? '#3b82f6' : '#111827' }}>
                    {dayNumber}
                  </div>

                  {/* Demandes */}
                  {dayRequests.slice(0, 3).map(req => (
                    <div
                      key={req.id}
                      style={{
                        background: getStatusColor(req.status),
                        color: 'white',
                        padding: '2px 6px',
                        borderRadius: '4px',
                        fontSize: '10px',
                        marginBottom: 2,
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: 'nowrap'
                      }}
                      title={req.objet}
                    >
                      {req.request_no}
                    </div>
                  ))}

                  {dayRequests.length > 3 && (
                    <div style={{ fontSize: '10px', color: '#6b7280', marginTop: 2 }}>
                      +{dayRequests.length - 3} autre(s)
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* LÃ©gende */}
      <div className="card" style={{ marginTop: 16 }}>
        <div style={{ fontWeight: '700', marginBottom: 8 }}>LÃ©gende</div>
        <div className="row" style={{ gap: 16, flexWrap: 'wrap' }}>
          <div className="row" style={{ gap: 6 }}>
            <div style={{ width: 16, height: 16, background: '#f59e0b', borderRadius: 4 }} />
            <span style={{ fontSize: 12 }}>Soumis</span>
          </div>
          <div className="row" style={{ gap: 6 }}>
            <div style={{ width: 16, height: 16, background: '#3b82f6', borderRadius: 4 }} />
            <span style={{ fontSize: 12 }}>Visa Logistique</span>
          </div>
          <div className="row" style={{ gap: 6 }}>
            <div style={{ width: 16, height: 16, background: '#10b981', borderRadius: 4 }} />
            <span style={{ fontSize: 12 }}>Visa RAF (ApprouvÃ©)</span>
          </div>
          <div className="row" style={{ gap: 6 }}>
            <div style={{ width: 16, height: 16, background: '#ef4444', borderRadius: 4 }} />
            <span style={{ fontSize: 12 }}>RejetÃ©</span>
          </div>
        </div>
      </div>

      {/* Modal jour sÃ©lectionnÃ© */}
      {selectedDate && (
        <Modal 
          title={`Demandes du ${new Date(selectedDate + 'T00:00:00').toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}`}
          onClose={() => setSelectedDate(null)}
          width={700}
        >
          <div>
            {(requestsByDate[selectedDate] || []).map(req => (
              <div
                key={req.id}
                className="card"
                style={{ marginBottom: 12, cursor: 'pointer' }}
                onClick={() => openViewModal(req.id)}
              >
                <div className="row" style={{ justifyContent: 'space-between', alignItems: 'center' }}>
                  <div>
                    <div style={{ fontWeight: '700' }}>{req.request_no}</div>
                    <div style={{ fontSize: 13, color: '#6b7280', marginTop: 4 }}>{req.objet}</div>
                  </div>
                  <span 
                    className="badge" 
                    style={{ background: getStatusColor(req.status), color: 'white', border: 'none' }}
                  >
                    {req.status}
                  </span>
                </div>
              </div>
            ))}
          </div>
        </Modal>
      )}

      {/* Modal dÃ©tails demande */}
      {viewModal && (
        <Modal 
          title={viewModal.loading ? 'Chargement...' : `DÃ©tails ${viewModal.data?.request_no || ''}`}
          onClose={() => setViewModal(null)}
          width={720}
        >
          {viewModal.loading ? (
            <div className="muted">Chargement...</div>
          ) : viewModal.data ? (
            <div>
              <div className="grid2">
                <div className="card">
                  <div className="muted">Date proposÃ©e</div>
                  <div style={{ fontWeight: 800 }}>{String(viewModal.data.proposed_date || '')}</div>
                </div>
                <div className="card">
                  <div className="muted">Statut</div>
                  <div style={{ fontWeight: 800 }}>{String(viewModal.data.status || '')}</div>
                </div>
              </div>
              <div className="card" style={{ marginTop: 10 }}>
                <div className="muted">Objet</div>
                <div style={{ fontWeight: 700 }}>{viewModal.data.objet}</div>
                <hr />
                <div className="muted">ItinÃ©raire</div>
                <div>{viewModal.data.itinerary}</div>
                <hr />
                <div className="muted">Personnes transportÃ©es</div>
                <div>{viewModal.data.people}</div>
              </div>
            </div>
          ) : (
            <div className="muted">Impossible de charger ce dÃ©tail.</div>
          )}
        </Modal>
      )}
    </div>
  );
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/main.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import { AuthProvider } from './auth/AuthContext.jsx';
import App from './App.jsx';
import './styles.css';

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <BrowserRouter>
      <AuthProvider>
        <App />
      </AuthProvider>
    </BrowserRouter>
  </React.StrictMode>
);


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/PrintCarRequest.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useState } from 'react';
import { Link, useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

export default function PrintCarRequest() {
  const { id } = useParams();
  const { token } = useAuth();
  const [req, setReq] = useState(null);

  useEffect(() => {
    (async () => {
      const data = await apiFetch(`/api/requests/car/${id}`, { token });
      setReq(data.request);
    })();
  }, [id, token]);

  if (!req) return <div>Chargement...</div>;

  return (
    <div style={{ background: '#f3f4f6', minHeight: '100vh', padding: 20 }}>
      <div className="noPrint" style={{ textAlign: 'center', marginBottom: 20 }}>
        <Link to="/app/requests/car" className="btn btn-secondary">â† Retour</Link>
        <button className="btn" onClick={() => window.print()} style={{ marginLeft: 10 }}>Imprimer</button>
      </div>

      <div className="paper" style={{
        width: '270mm', height: '190mm',
        background: 'white', margin: '0 auto', padding: '15mm',
        display: 'flex', gap: '10mm', fontFamily: 'Arial, sans-serif'
      }}>
        
        {/* ----- PARTIE GAUCHE: DEMANDE ----- */}
        <div style={{ flex: 1, borderRight: '1px dashed black', paddingRight: '10mm', display: 'flex', flexDirection: 'column' }}>
          
          <div style={{ display: 'flex', gap: 15, marginBottom: 20 }}>
            {/* Logo Z sim */}
            <div style={{ border: '4px solid #555', padding: '5px 10px', fontWeight: '900', fontSize: '24px', color: '#555', lineHeight: '24px' }}>Z</div>
            <div>
              <div style={{fontWeight:'bold'}}>CEP</div>
              <div style={{fontWeight:'bold'}}>PRIRTEM</div>
            </div>
          </div>

          <div style={{ fontWeight: 'bold', textTransform: 'uppercase', marginBottom: 30, fontSize: '16px' }}>
            Demande de voiture
          </div>

          <Field label="Date proposÃ©e" value={fmtDate(req.proposed_date)} />
          <Field label="Objet" value={req.objet} />
          <div style={{ margin: '15px 0', borderBottom: '1px dotted #999' }}></div>
          <Field label="ItinÃ©raire" value={req.itinerary} multiline />
          <div style={{ margin: '15px 0', borderBottom: '1px dotted #999' }}></div>
          <Field label="Personnes transportÃ©es" value={req.people} />
          <div style={{ margin: '15px 0', borderBottom: '1px dotted #999' }}></div>
          
          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
            <div style={{ flex: 1 }}>
              <Field label="Heure de dÃ©part souhaitÃ©e" value={fmtTime(req.depart_time_wanted)} />
              <Field label="Heure probable de retour" value={fmtTime(req.return_time_expected)} />
              <Field label="Immatriculation" value={req.vehicle_plate || '...................'} />
              <Field label="Chauffeur" value={req.driver_name || '...................'} />
            </div>
          </div>

          <div style={{ marginTop: 'auto' }}>
            <div>Date : ___________________</div>
            <div style={{ marginTop: 10 }}>Le Demandeur,</div>
            <div style={{ height: 50 }}></div>
          </div>
        </div>

        {/* ----- PARTIE DROITE: AUTORISATION ----- */}
        <div style={{ flex: 1, paddingLeft: '5mm', display: 'flex', flexDirection: 'column' }}>
          
          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 20 }}>
            <div style={{ display: 'flex', gap: 15 }}>
              <div style={{ border: '4px solid #555', padding: '5px 10px', fontWeight: '900', fontSize: '24px', color: '#555', lineHeight: '24px' }}>Z</div>
              <div>
                <div style={{fontWeight:'bold'}}>CEP</div>
                <div style={{fontWeight:'bold'}}>PRIRTEM</div>
              </div>
            </div>
            <div style={{ fontSize: '14px', fontWeight: 'bold' }}>
              NÂ° <span style={{ textDecoration:'underline' }}>{req.request_no.split(' ')[1]}</span>
            </div>
          </div>

          <div style={{ fontWeight: 'bold', textTransform: 'uppercase', marginBottom: 30, fontSize: '16px' }}>
            Autorisation sortie de voiture
          </div>

          <Field label="Date" value={fmtDate(req.authorization_date)} />
          <Field label="Heure" value={fmtTime(req.authorization_time)} />
          <Field label="Immatriculation" value={req.vehicle_plate || '.......................'} />
          <Field label="Chauffeur" value={req.driver_name || '.......................'} />
          <Field label="ItinÃ©raire" value={req.itinerary} />

          <div style={{ marginTop: 'auto', borderTop: '2px solid black', paddingTop: 10 }}>
            <div style={{ display: 'flex', border: '1px solid black' }}>
              <div style={{ flex: 1, borderRight: '1px solid black', padding: 5, minHeight: 80 }}>
                <div style={{ textAlign: 'center', fontWeight: 'bold', fontSize: '12px' }}>Visa<br/>A/Logistique</div>
                {/* Espace Signature */}
              </div>
              <div style={{ flex: 1, padding: 5, minHeight: 80 }}>
                <div style={{ textAlign: 'center', fontWeight: 'bold', fontSize: '12px' }}>ApprouvÃ©e<br/>par Le RAF</div>
                {/* Espace Signature */}
              </div>
            </div>
          </div>

        </div>

      </div>
      <style>{`@media print { .noPrint { display: none; } @page { size: A4 landscape; margin: 5mm; } body { margin: 0; background: white; } .paper { margin: 0; box-shadow: none; width: 100%; height: 100%; } }`}</style>
    </div>
  );
}

function Field({ label, value, multiline }) {
  return (
    <div style={{ display: 'flex', alignItems: multiline ? 'flex-start' : 'baseline', marginBottom: 8, fontSize: '13px' }}>
      <span style={{ fontWeight: 'bold', marginRight: 10, minWidth: 60 }}>{label} :</span>
      <div style={{ flex: 1, borderBottom: '1px dotted #333', paddingLeft: 5, minHeight: 18 }}>
        {value}
      </div>
    </div>
  );
}

function fmtDate(d) { return d ? new Date(d).toLocaleDateString('fr-FR') : ''; }
function fmtTime(t) { return t ? t.slice(0, 5) : ''; }

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/components/Modal.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useRef } from 'react';

export default function Modal({ title, children, onClose, width = 720 }) {
  const closeBtnRef = useRef(null);

  useEffect(() => {
    const onKeyDown = (e) => {
      if (e.key === 'Escape') onClose?.();
    };
    document.addEventListener('keydown', onKeyDown);
    // focus close btn by default
    closeBtnRef.current?.focus?.();
    return () => document.removeEventListener('keydown', onKeyDown);
  }, [onClose]);

  return (
    <div className="modalOverlay" onMouseDown={onClose} role="presentation">
      <div
        className="modal"
        style={{ width }}
        role="dialog"
        aria-modal="true"
        aria-label={title || 'Dialog'}
        onMouseDown={(e) => e.stopPropagation()}
      >
        <div className="modalHeader">
          <div className="modalTitle">{title}</div>
          <button ref={closeBtnRef} className="btn btn-outline btn-sm" onClick={onClose} aria-label="Fermer">
            Fermer
          </button>
        </div>
        <div className="modalBody">{children}</div>
      </div>
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/components/Layout.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useMemo, useState } from 'react';
import { NavLink, useLocation, useNavigate } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import NotificationBell from './NotificationBell.jsx';

const MENU = {
  common: [
    { to: '/app', label: 'Dashboard' },
    { to: '/app/fuel', label: 'Suivi carburant' },
    { to: '/app/calendar', label: 'ğŸ“… Calendrier' }
  ],
  demandeur: [
    { to: '/app/requests/fuel', label: 'Demande carburant' },
    { to: '/app/requests/car', label: 'Demande voiture' }
  ],
  logistique: [
    { to: '/app/import', label: 'Import Excel' },
    { to: '/app/requests/fuel/manage', label: 'Validation carburant' },
    { to: '/app/requests/car/manage', label: 'Validation voiture' },
    { to: '/app/logbooks', label: 'Journal de bord' },
    { to: '/app/meta', label: 'VÃ©hicules & Chauffeurs' },
    { to: '/app/trash', label: 'Corbeille' }
  ],
  raf: [
    { to: '/app/requests/fuel/raf', label: 'Visa RAF carburant' },
    { to: '/app/requests/car/raf', label: 'Visa RAF voiture' }
  ],
  admin: [
    { to: '/app/import', label: 'Import Excel' },
    { to: '/app/meta', label: 'VÃ©hicules & Chauffeurs' },
    { to: '/app/logbooks', label: 'Journal de bord' },
    { to: '/app/trash', label: 'Corbeille' }
  ]
};

function getMenu(role) {
  const base = [...MENU.common];
  if (role === 'DEMANDEUR') return [...base, ...MENU.demandeur];
  if (role === 'LOGISTIQUE') return [...base, ...MENU.logistique];
  if (role === 'RAF') return [...base, ...MENU.raf];
  if (role === 'ADMIN') return [...base, ...MENU.admin];
  return base;
}

function prettyRole(role) {
  if (!role) return '';
  if (role === 'DEMANDEUR') return 'Demandeur';
  if (role === 'LOGISTIQUE') return 'Logistique';
  if (role === 'RAF') return 'RAF';
  if (role === 'ADMIN') return 'Admin';
  return role;
}

export default function Layout({ children }) {
  const { user, logout } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();

  const [isMobile, setIsMobile] = useState(() => window.innerWidth <= 900);
  const [sidebarOpen, setSidebarOpen] = useState(() => window.innerWidth > 900);

  const role = user?.role;
  const menu = useMemo(() => getMenu(role), [role]);

  const currentTitle = useMemo(() => {
    const path = location.pathname || '';
    const best = menu.find((m) => path === m.to || path.startsWith(m.to + '/'));
    return best?.label || 'PRIRTEM';
  }, [menu, location.pathname]);

  useEffect(() => {
    const onResize = () => {
      const mobile = window.innerWidth <= 900;
      setIsMobile(mobile);
      if (!mobile) setSidebarOpen(true);
    };
    window.addEventListener('resize', onResize);
    return () => window.removeEventListener('resize', onResize);
  }, []);

  function handleLogout() {
    logout?.();
    navigate('/login');
  }

  function toggleSidebar() {
    setSidebarOpen((v) => !v);
  }

  function closeSidebarIfMobile() {
    if (isMobile) setSidebarOpen(false);
  }

  return (
    <div className="layout">
      {isMobile && sidebarOpen && <div className="sidebarOverlay" onClick={() => setSidebarOpen(false)} />}

      <aside className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
        <div className="sidebarHeader">
          <div className="brand">
            <b>PRIRTEM</b>
            <span>Carburant & Flotte</span>
          </div>

          {isMobile && (
            <button className="btn btn-ghost btn-sm" onClick={() => setSidebarOpen(false)} aria-label="Fermer le menu">
              âœ•
            </button>
          )}
        </div>

        <div className="sidebar__user">
          <div className="sidebar__userName">
            {user?.first_name || user?.last_name ? `${user?.first_name || ''} ${user?.last_name || ''}`.trim() : (user?.username || 'Utilisateur')}
          </div>
          <div className="sidebar__userRole">{prettyRole(role)}</div>
        </div>

        <div className="sidebar__navWrap">
          <nav className="sidebar__nav">
            {menu.map((item) => (
              <NavLink
                key={item.to}
                to={item.to}
                onClick={closeSidebarIfMobile}
                className={({ isActive }) => `navItem ${isActive ? 'active' : ''}`}
              >
                {item.label}
              </NavLink>
            ))}
          </nav>
        </div>

        <div className="sidebarFooter">
          <button className="btn btn-ghost" onClick={handleLogout}>
            DÃ©connexion
          </button>
        </div>
      </aside>

      <main className="main">
        <div className="topbar">
          <div className="topbarLeft">
            <button className="iconBtn" onClick={toggleSidebar} aria-label="Ouvrir le menu">
              â˜°
            </button>
            <div className="topbarTitle">{currentTitle}</div>
          </div>

          <div className="topbarRight">
            <NotificationBell />
            <button className="btn btn-outline topbar-logout" onClick={handleLogout}>
              DÃ©connexion
            </button>
          </div>
        </div>

        <div className="container">{children}</div>
      </main>
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/Trash.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';
import Modal from '../components/Modal.jsx';

const ENTITIES = [
  { key: 'vehicles', label: 'VÃ©hicules' },
  { key: 'drivers', label: 'Chauffeurs' },
  { key: 'fuel_requests', label: 'Demandes carburant' },
  { key: 'car_requests', label: 'Demandes voiture' },
  { key: 'vehicle_fuel_logs', label: 'Suivi carburant (VÃ©hicules)' },
  { key: 'generator_fuel_logs', label: 'Suivi carburant (Groupe Ã©lectrogÃ¨ne)' },
  { key: 'other_fuel_logs', label: 'Suivi carburant (Autres)' }
];

export default function Trash() {
  const { token } = useAuth();
  const [entity, setEntity] = useState('vehicles');
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState(null);

  const [confirm, setConfirm] = useState(null);
  const [confirmWord, setConfirmWord] = useState('');

  const columns = useMemo(() => {
    if (entity === 'vehicles') return ['plate', 'label', 'deleted_at'];
    if (entity === 'drivers') return ['full_name', 'phone', 'deleted_at'];
    if (entity === 'fuel_requests') return ['request_no', 'request_date', 'request_type', 'amount_estimated_ar', 'status', 'deleted_at'];
    if (entity === 'car_requests') return ['request_no', 'proposed_date', 'objet', 'status', 'deleted_at'];
    if (entity === 'vehicle_fuel_logs') return ['log_date', 'km_depart', 'km_arrivee', 'montant_ar', 'deleted_at'];
    if (entity === 'generator_fuel_logs') return ['log_date', 'liters', 'montant_ar', 'deleted_at'];
    if (entity === 'other_fuel_logs') return ['log_date', 'liters', 'montant_ar', 'lien', 'deleted_at'];
    return ['id', 'deleted_at'];
  }, [entity]);

  async function load() {
    setLoading(true);
    setErr(null);
    try {
      const d = await apiFetch(`/api/trash/${entity}`, { token });
      setItems(d.items || []);
    } catch (e) {
      setErr(String(e.message || e));
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    load();
  }, [entity]);

  const openRestore = (item) => {
    setConfirm({ type: 'restore', item });
    setConfirmWord('');
  };

  const openHard = (item) => {
    setConfirm({ type: 'hard', item });
    setConfirmWord('');
  };

  const runConfirm = async () => {
    if (!confirm) return;
    const { type, item } = confirm;

    try {
      if (type === 'restore') {
        await apiFetch(`/api/trash/${entity}/${item.id}/restore`, { method: 'POST', token });
        alert('âœ… RestaurÃ© avec succÃ¨s');
        setConfirm(null);
        await load();
        return;
      }

      if (type === 'hard') {
        if (confirmWord !== 'SUPPRIMER') {
          alert('âš ï¸ Tapez exactement "SUPPRIMER" pour confirmer');
          return;
        }
        await apiFetch(`/api/trash/${entity}/${item.id}/hard`, { method: 'DELETE', token });
        alert('âœ… SupprimÃ© dÃ©finitivement');
        setConfirm(null);
        await load();
      }
    } catch (e) {
      alert(`âŒ Erreur: ${e.message}`);
    }
  };

  return (
    <div>
      <h1 style={{ marginTop: 0 }}>ğŸ—‘ï¸ Corbeille</h1>

      <div className="row" style={{ alignItems: 'flex-end', marginBottom: 12 }}>
        <div className="field" style={{ minWidth: 300 }}>
          <div className="label">Type</div>
          <select className="input" value={entity} onChange={(e) => setEntity(e.target.value)}>
            {ENTITIES.map((e) => (
              <option key={e.key} value={e.key}>{e.label}</option>
            ))}
          </select>
        </div>
        <button className="btn btn-outline" onClick={load}>Recharger</button>
      </div>

      {err && <div className="muted" style={{ color: '#b91c1c', marginBottom: 12 }}>{err}</div>}

      <div style={{ overflow: 'auto' }}>
        <table className="table">
          <thead>
            <tr>
              <th>ID</th>
              {columns.map((c) => (<th key={c}>{c}</th>))}
              <th style={{ width: 260 }}>Actions</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr><td colSpan={columns.length + 2} className="muted">Chargement...</td></tr>
            ) : items.length ? (
              items.map((it) => (
                <tr key={it.id}>
                  <td className="muted" style={{ fontSize: 11 }}>{String(it.id).slice(0, 8)}...</td>
                  {columns.map((c) => (
                    <td key={c}>
                      {c === 'amount_estimated_ar' || c === 'montant_ar' ? Number(it[c] || 0).toLocaleString('fr-FR') + ' Ar' :
                       c === 'deleted_at' ? new Date(it[c]).toLocaleString('fr-FR') :
                       String(it[c] ?? '')}
                    </td>
                  ))}
                  <td style={{ whiteSpace: 'nowrap' }}>
                    <button className="btn btn-outline btn-sm" onClick={() => openRestore(it)}>Restaurer</button>
                    <span style={{ display: 'inline-block', width: 8 }} />
                    <button className="btn btn-danger btn-sm" onClick={() => openHard(it)}>Supprimer dÃ©finitif</button>
                  </td>
                </tr>
              ))
            ) : (
              <tr><td colSpan={columns.length + 2} className="muted">Corbeille vide âœ…</td></tr>
            )}
          </tbody>
        </table>
      </div>

      <div className="muted" style={{ marginTop: 16, padding: 12, background: '#f9fafb', borderRadius: 8 }}>
        <strong>ğŸ’¡ Comment Ã§a marche ?</strong>
        <ul style={{ marginTop: 8, paddingLeft: 20 }}>
          <li><strong>Restaurer</strong> : Remet l'Ã©lÃ©ment dans l'app (accessible normalement)</li>
          <li><strong>Supprimer dÃ©finitif</strong> : Efface DÃ‰FINITIVEMENT de la base de donnÃ©es (irrÃ©versible)</li>
        </ul>
      </div>

      {confirm && (
        <Modal
          title={confirm.type === 'restore' ? 'Restaurer cet Ã©lÃ©ment ?' : 'Suppression dÃ©finitive'}
          onClose={() => setConfirm(null)}
          width={560}
        >
          {confirm.type === 'restore' ? (
            <div>
              <div style={{ marginBottom: 12 }}>
                Voulez-vous restaurer cet Ã©lÃ©ment ?<br />
                <span className="muted">Il redeviendra accessible normalement.</span>
              </div>
              <div className="row" style={{ justifyContent: 'flex-end', gap: 8 }}>
                <button className="btn btn-outline" onClick={() => setConfirm(null)}>Annuler</button>
                <button className="btn" onClick={runConfirm}>âœ… Restaurer</button>
              </div>
            </div>
          ) : (
            <div>
              <div style={{ marginBottom: 10, padding: 12, background: '#fef2f2', borderRadius: 8, border: '1px solid #fca5a5' }}>
                <strong style={{ color: '#b91c1c' }}>âš ï¸ ATTENTION : Cette action est IRRÃ‰VERSIBLE</strong><br />
                <span className="muted">L'Ã©lÃ©ment sera supprimÃ© dÃ©finitivement de la base de donnÃ©es.</span>
              </div>
              <div style={{ marginBottom: 10 }}>
                Tapez exactement <strong style={{ color: '#b91c1c' }}>SUPPRIMER</strong> pour confirmer :
              </div>
              <input
                className="input"
                value={confirmWord}
                onChange={(e) => setConfirmWord(e.target.value)}
                placeholder="SUPPRIMER"
                style={{ fontWeight: 700, textTransform: 'uppercase' }}
              />
              <div className="row" style={{ justifyContent: 'flex-end', marginTop: 12, gap: 8 }}>
                <button className="btn btn-outline" onClick={() => setConfirm(null)}>Annuler</button>
                <button 
                  className="btn btn-danger" 
                  disabled={confirmWord !== 'SUPPRIMER'} 
                  onClick={runConfirm}
                >
                  ğŸ—‘ï¸ Supprimer dÃ©finitif
                </button>
              </div>
            </div>
          )}
        </Modal>
      )}
    </div>
  );
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/Reset.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useMemo, useState } from 'react';
import { Link, useSearchParams, useNavigate } from 'react-router-dom';
import { apiFetch } from '../utils/api.js';

export default function Reset() {
  const [params] = useSearchParams();
  const nav = useNavigate();
  const email = useMemo(() => params.get('email') || '', [params]);
  const token = useMemo(() => params.get('token') || '', [params]);

  const [newPassword, setNewPassword] = useState('');
  const [done, setDone] = useState(false);
  const [error, setError] = useState(null);

  async function onSubmit(e) {
    e.preventDefault();
    setError(null);
    try {
      await apiFetch('/api/auth/reset', {
        method: 'POST',
        body: { email, token, new_password: newPassword }
      });
      setDone(true);
      setTimeout(() => nav('/login'), 700);
    } catch (err) {
      setError(err.message);
    }
  }

  return (
    <div className="container">
      <div className="card" style={{ maxWidth: 520, margin: '40px auto' }}>
        <h2 style={{ marginTop: 0 }}>RÃ©initialiser mot de passe</h2>
        {done ? (
          <div className="notice">Mot de passe modifiÃ© âœ… Redirection...</div>
        ) : (
          <>
            <div className="muted" style={{ marginBottom: 12 }}>
              Email: <b>{email || 'â€”'}</b>
            </div>
            {error && <div className="notice error">{error}</div>}
            <form onSubmit={onSubmit} className="form">
              <label className="label">Nouveau mot de passe</label>
              <input className="input" type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} />
              <button className="btn btn-primary" type="submit">Valider</button>
            </form>
          </>
        )}
        <div style={{ marginTop: 12 }}>
          <Link to="/login">Retour connexion</Link>
        </div>
      </div>
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/Register.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { apiFetch } from '../utils/api.js';
import { useAuth } from '../auth/AuthContext.jsx';

const ROLES = [
  { value: 'DEMANDEUR', label: 'Demandeur' },
  { value: 'LOGISTIQUE', label: 'Logistique' },
  { value: 'RAF', label: 'RAF' }
];

export default function Register() {
  const nav = useNavigate();
  const { setSession } = useAuth();
  const [form, setForm] = useState({ first_name: '', last_name: '', username: '', email: '', role: 'DEMANDEUR', password: '', password2: '' });
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  async function onSubmit(e) {
    e.preventDefault();
    setError(null);
    if (form.password !== form.password2) {
      setError('Les mots de passe ne correspondent pas');
      return;
    }
    setLoading(true);
    try {
      const data = await apiFetch('/api/auth/register', {
        method: 'POST',
        body: {
          first_name: form.first_name,
          last_name: form.last_name,
          username: form.username,
          email: form.email,
          role: form.role,
          password: form.password
        }
      });
      setSession(data.token, data.user);
      nav('/app');
    } catch (e2) {
      setError(e2.message);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="container" style={{ maxWidth: 520 }}>
      <div className="card">
        <h2>Inscription</h2>
        <p className="muted">Compte PRIRTEM (offline).</p>
        {error && <div className="alert alert-danger">{error}</div>}

        <form onSubmit={onSubmit} className="form">
          <div className="grid2">
            <label className="field">
              <span>Nom</span>
              <input value={form.last_name} onChange={(e) => setForm({ ...form, last_name: e.target.value })} required />
            </label>
            <label className="field">
              <span>PrÃ©nom</span>
              <input value={form.first_name} onChange={(e) => setForm({ ...form, first_name: e.target.value })} required />
            </label>
          </div>

          <label className="field">
            <span>Nom d'utilisateur</span>
            <input value={form.username} onChange={(e) => setForm({ ...form, username: e.target.value })} required />
          </label>

          <label className="field">
            <span>Email</span>
            <input type="email" value={form.email} onChange={(e) => setForm({ ...form, email: e.target.value })} required />
          </label>

          <label className="field">
            <span>RÃ´le</span>
            <select value={form.role} onChange={(e) => setForm({ ...form, role: e.target.value })}>
              {ROLES.map((r) => <option key={r.value} value={r.value}>{r.label}</option>)}
            </select>
          </label>

          <div className="grid2">
            <label className="field">
              <span>Mot de passe</span>
              <input type="password" value={form.password} onChange={(e) => setForm({ ...form, password: e.target.value })} required />
            </label>
            <label className="field">
              <span>Confirmer</span>
              <input type="password" value={form.password2} onChange={(e) => setForm({ ...form, password2: e.target.value })} required />
            </label>
          </div>

          <button className="btn btn-primary" disabled={loading}>{loading ? 'CrÃ©ation...' : 'CrÃ©er le compte'}</button>
        </form>

        <div style={{ marginTop: 12 }}>
          <Link to="/login">DÃ©jÃ  inscrit ? Se connecter</Link>
        </div>
      </div>
    </div>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/PrintLogbook.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useState } from 'react';
import { Link, useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

function fmtDate(d) {
  if (!d) return '';
  const date = new Date(d);
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  return `${day}/${month}`;
}

export default function PrintLogbook() {
  const { id } = useParams();
  const { token } = useAuth();
  const [data, setData] = useState(null);

  useEffect(() => {
    apiFetch(`/api/logbooks/${id}`, { token }).then(setData);
  }, [id, token]);

  if (!data) return <div>Chargement...</div>;
  const { logbook, trips, supplies } = data;

  return (
    <div style={{ background: '#eee', minHeight: '100vh', padding: 20 }}>
      <div className="noPrint" style={{ marginBottom: 20, textAlign: 'center' }}>
        <Link className="btn btn-secondary" to={`/app/logbooks/${id}`}>â† Retour</Link>
        <button className="btn" onClick={() => window.print()} style={{ marginLeft: 10 }}>Imprimer</button>
      </div>

      <div style={{
        background: 'white',
        width: '297mm', // A4 Paysage
        height: '210mm',
        padding: '10mm',
        margin: '0 auto',
        fontFamily: 'Arial, sans-serif',
        fontSize: '11px',
        color: 'black',
        boxShadow: '0 4px 10px rgba(0,0,0,0.1)'
      }} className="paper">
        
        {/* HEADER */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 15 }}>
          <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-start' }}>
            <div style={{ fontSize: '24px', fontWeight: '900', border: '3px solid black', padding: '0 8px', letterSpacing: '-1px' }}>
              Z
            </div>
            <div style={{ fontWeight: 'bold', fontSize: '10px', marginTop: 2 }}>CEP</div>
            <div style={{ fontWeight: 'bold', fontSize: '10px' }}>PRIRTEM</div>
          </div>
          
          <div style={{ textAlign: 'center', flex: 1 }}>
            <h1 style={{ fontSize: '18px', fontWeight: 'bold', textTransform: 'uppercase', margin: 0 }}>Journal de bord voiture</h1>
            <div style={{ fontSize: '12px', marginTop: 5 }}>
              Du {new Date(logbook.period_start).toLocaleDateString('fr-FR')} au {new Date(logbook.period_end).toLocaleDateString('fr-FR')}
            </div>
          </div>
        </div>

        <div style={{ marginBottom: 10 }}>
          <span style={{ fontWeight: 'bold' }}>Objet :</span> {logbook.objet || '...........................................'} <br/>
          <span style={{ fontWeight: 'bold' }}>Immatriculation :</span> <span style={{ textDecoration: 'underline' }}>{logbook.plate}</span>
        </div>

        {/* MAIN TABLE */}
        <table style={{ width: '100%', borderCollapse: 'collapse', border: '2px solid black', textAlign: 'center', fontSize: '10px' }}>
          <thead>
            <tr>
              <th rowSpan="2" style={thStyle}>DATE</th>
              <th colSpan="2" style={thStyle}>DEPART</th>
              <th colSpan="4" style={thStyle}>ITINERAIRES</th>
              <th colSpan="2" style={thStyle}>ARRIVEE</th>
              <th rowSpan="2" style={thStyle}>PERSONNES<br/>TRANSPORTEES</th>
              <th rowSpan="2" style={thStyle}>EMARGEMENT</th>
            </tr>
            <tr>
              <th style={thStyle}>Heures</th>
              <th style={thStyle}>Km</th>
              <th style={thStyle}>DÃ©but de trajet</th>
              <th style={thStyle}>Fin de trajet</th>
              <th style={thStyle}>Lieu de<br/>stationnement</th>
              <th style={thStyle}>DurÃ©e de<br/>stationnement</th>
              <th style={thStyle}>Heures</th>
              <th style={thStyle}>Km</th>
            </tr>
          </thead>
          <tbody>
            {trips.map((t, i) => (
              <tr key={i} style={{ height: '24px' }}>
                <td style={tdStyle}>{fmtDate(t.trip_date)}</td>
                <td style={tdStyle}>{t.depart_time ? t.depart_time.slice(0, 5).replace(':','H') : ''}</td>
                <td style={tdStyle}>{t.depart_km}</td>
                <td style={tdStyle}>{t.route_start}</td>
                <td style={tdStyle}>{t.route_end}</td>
                <td style={tdStyle}>{t.parking_place}</td>
                <td style={tdStyle}>{t.parking_duration_min ? t.parking_duration_min + ' min' : ''}</td>
                <td style={tdStyle}>{t.arrival_time ? t.arrival_time.slice(0, 5).replace(':','H') : ''}</td>
                <td style={tdStyle}>{t.arrival_km}</td>
                <td style={tdStyle}>{t.passengers}</td>
                <td style={tdStyle}>{t.emargement}</td>
              </tr>
            ))}
            {/* Lignes vides pour remplir la page si besoin */}
            {Array.from({ length: Math.max(0, 15 - trips.length) }).map((_, i) => (
              <tr key={`empty-${i}`} style={{ height: '24px' }}>
                <td style={tdStyle}></td><td style={tdStyle}></td><td style={tdStyle}></td>
                <td style={tdStyle}></td><td style={tdStyle}></td><td style={tdStyle}></td>
                <td style={tdStyle}></td><td style={tdStyle}></td><td style={tdStyle}></td>
                <td style={tdStyle}></td><td style={tdStyle}></td>
              </tr>
            ))}
          </tbody>
        </table>

        {/* FOOTER: APPRO & SIGNATURE */}
        <div style={{ display: 'flex', marginTop: 15, gap: 20 }}>
          <div style={{ flex: 1 }}>
            <div style={{ fontWeight: 'bold', marginBottom: 5 }}>Approvisionnement Carburant</div>
            <table style={{ width: '100%', borderCollapse: 'collapse', border: '1px solid black', fontSize: '10px' }}>
              <thead>
                <tr>
                  <th style={tdStyle}>Date</th>
                  <th style={tdStyle}>Compteur Km</th>
                  <th style={tdStyle}>Litre</th>
                </tr>
              </thead>
              <tbody>
                {supplies.length > 0 ? supplies.map((s, i) => (
                  <tr key={i}>
                    <td style={tdStyle}>{fmtDate(s.supply_date)}</td>
                    <td style={tdStyle}>{s.compteur_km}</td>
                    <td style={tdStyle}>{s.liters}</td>
                  </tr>
                )) : (
                  <tr><td colSpan={3} style={{ ...tdStyle, height: '40px' }}></td></tr>
                )}
              </tbody>
            </table>
          </div>

          <div style={{ width: '250px', display: 'flex', flexDirection: 'column', gap: 10 }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', borderBottom: '1px dotted black', paddingBottom: 5 }}>
              <span>Services :</span>
              <span>{logbook.service_km || '.....'} km</span>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', borderBottom: '1px dotted black', paddingBottom: 5 }}>
              <span>Mission :</span>
              <span>{logbook.mission_km || '.....'} km</span>
            </div>
            <div style={{ marginTop: 10 }}>
              Chauffeur : <br/>
              <span style={{ fontFamily: 'monospace' }}>{logbook.chauffeur_signature}</span>
            </div>
          </div>
        </div>

      </div>
      <style>{`@media print { .noPrint { display: none; } @page { size: A4 landscape; margin: 0; } body { background: white; } .paper { box-shadow: none; } }`}</style>
    </div>
  );
}

const thStyle = { border: '1px solid black', padding: '4px', background: '#fff', fontWeight: 'bold' };
const tdStyle = { border: '1px solid black', padding: '4px' };

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/pages/PrintFuelRequest.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useState } from 'react';
import { Link, useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

export default function PrintFuelRequest() {
  const { id } = useParams();
  const { token } = useAuth();
  const [req, setReq] = useState(null);

  useEffect(() => {
    (async () => {
      const data = await apiFetch(`/api/requests/fuel/${id}`, { token });
      setReq(data.request);
    })();
  }, [id, token]);

  if (!req) return <div>Chargement...</div>;

  return (
    <div style={{ minHeight: '100vh', background: '#f3f4f6', padding: 20 }}>
      <div className="noPrint" style={{ textAlign: 'center', marginBottom: 20 }}>
        <Link to="/app/requests/fuel" className="btn btn-secondary">â† Retour</Link>
        <button className="btn" onClick={() => window.print()} style={{ marginLeft: 10 }}>Imprimer</button>
      </div>

      <div className="paper" style={{
        width: '210mm', minHeight: '130mm', // Demi page A4 environ ou ajustÃ©
        background: 'white', margin: '0 auto', padding: '20mm',
        position: 'relative', fontFamily: 'Arial, sans-serif', color: '#000'
      }}>
        
        {/* Header gauche / droite */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 20 }}>
          <div style={{ textAlign: 'center' }}>
            <div style={{ fontWeight: 'normal', fontSize: '14px' }}>CEP</div>
            <div style={{ fontWeight: 'normal', fontSize: '14px' }}>PRIRTEM</div>
          </div>
          <div style={{ fontSize: '14px' }}>NÂ° <span style={{ textDecoration: 'underline' }}>{req.request_no.split(' ')[1]}</span></div>
        </div>

        {/* Titre */}
        <div style={{ textAlign: 'center', fontSize: '18px', marginBottom: 30 }}>
          DEMANDE DE CARBURANT
        </div>

        {/* Checkbox Service / Mission */}
        <div style={{ display: 'flex', justifyContent: 'center', gap: 100, marginBottom: 30 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
            <span>SERVICE</span>
            <div style={boxStyle}>{req.request_type === 'SERVICE' ? 'X' : ''}</div>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
            <span>MISSION</span>
            <div style={boxStyle}>{req.request_type === 'MISSION' ? 'X' : ''}</div>
          </div>
        </div>

        {/* Champs lignes */}
        <div style={lineGroupStyle}>
          <span>OBJET : </span>
          <div style={lineStyle}>{req.objet}</div>
        </div>

        <div style={{ ...lineGroupStyle, marginTop: 25 }}>
          <span>Montant prÃ©visionnel (en chiffre) : </span>
          <div style={{ ...lineStyle, width: '200px' }}>{Number(req.amount_estimated_ar).toLocaleString('fr-FR')}</div>
          <span>Ar</span>
        </div>

        <div style={{ ...lineGroupStyle, marginTop: 25 }}>
          <span style={{ width: '150px' }}>(en lettre) :</span>
          <div style={lineStyle}>{req.amount_estimated_words}</div>
        </div>

        <div style={{ textAlign: 'right', marginTop: 40, marginBottom: 10 }}>
          Date ____/____/________
        </div>

        {/* Tableau Signatures */}
        <table style={{ width: '100%', borderCollapse: 'collapse', marginTop: 20 }}>
          <thead>
            <tr>
              <th style={cellStyle}>Le Demandeur</th>
              <th style={cellStyle}>VÃ©rifiÃ© par : A/Logistique</th>
              <th style={cellStyle}>VisÃ© par : Le RAF</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style={{ ...cellStyle, height: '100px', verticalAlign: 'bottom', textAlign:'center' }}>
                {req.requester_username || ''}
              </td>
              <td style={{ ...cellStyle, height: '100px' }}></td>
              <td style={{ ...cellStyle, height: '100px' }}></td>
            </tr>
          </tbody>
        </table>

      </div>
      <style>{`@media print { .noPrint { display: none; } body { margin: 0; } .paper { box-shadow: none; border: none; } }`}</style>
    </div>
  );
}

const boxStyle = { width: '20px', height: '20px', border: '1px solid black', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', fontWeight: 'bold' };
const lineGroupStyle = { display: 'flex', alignItems: 'baseline', fontSize: '14px' };
const lineStyle = { flex: 1, borderBottom: '1px solid black', paddingLeft: '10px', height: '24px' };
const cellStyle = { border: '1px solid black', padding: '5px', textAlign: 'center', width: '33%' };

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/components/ToastContext.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { createContext, useContext, useState, useCallback } from 'react';

const ToastContext = createContext(null);

export function ToastProvider({ children }) {
  const [toasts, setToasts] = useState([]);

  const addToast = useCallback((message, type = 'info') => {
    const id = Date.now();
    setToasts((prev) => [...prev, { id, message, type }]);
    setTimeout(() => {
      setToasts((prev) => prev.filter((t) => t.id !== id));
    }, 4000);
  }, []);

  const removeToast = (id) => {
    setToasts((prev) => prev.filter((t) => t.id !== id));
  };

  return (
    <ToastContext.Provider value={{ addToast }}>
      {children}
      <div style={{
        position: 'fixed', bottom: '24px', right: '24px', zIndex: 9999,
        display: 'flex', flexDirection: 'column', gap: '12px'
      }}>
        {toasts.map((t) => (
          <div key={t.id} onClick={() => removeToast(t.id)} style={{
            minWidth: '300px',
            padding: '16px 20px',
            borderRadius: '12px',
            background: 'white',
            boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)',
            borderLeft: `6px solid ${
              t.type === 'success' ? '#10b981' : 
              t.type === 'error' ? '#ef4444' : 
              '#3b82f6'
            }`,
            display: 'flex', justifyContent: 'space-between', alignItems: 'center',
            animation: 'slideInRight 0.3s ease-out',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '500',
            color: '#1e293b'
          }}>
            <span>{t.message}</span>
            <span style={{ marginLeft: '12px', opacity: 0.5 }}>âœ•</span>
          </div>
        ))}
      </div>
      <style>{`
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `}</style>
    </ToastContext.Provider>
  );
}

export function useToast() {
  return useContext(ToastContext);
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/components/ProtectedRoute.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React from 'react';
import { Navigate } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';

export default function ProtectedRoute({ children, roles }) {
  const { user, loading } = useAuth();
  if (loading) return <div className="container"><div className="card">Chargement...</div></div>;
  if (!user) return <Navigate to="/login" replace />;
  if (roles && !roles.includes(user.role)) return <Navigate to="/" replace />;
  return children;
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/components/NotificationBell.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { useEffect, useMemo, useRef, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext.jsx';
import { apiFetch } from '../utils/api.js';

function severityToDot(sev) {
  if (sev === 'error') return 'var(--danger)';
  if (sev === 'warning') return 'var(--warning)';
  if (sev === 'success') return 'var(--success)';
  if (sev === 'info') return 'var(--accent)';
  return 'rgba(255,255,255,.55)';
}

function formatTimestamp(ts) {
  if (!ts) return '';
  const date = new Date(ts);
  const now = new Date();
  const diff = now - date;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);

  if (minutes < 1) return "Ã€ l'instant";
  if (minutes < 60) return `Il y a ${minutes} min`;
  if (hours < 24) return `Il y a ${hours}h`;
  return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
}

export default function NotificationBell() {
  const { token } = useAuth();
  const navigate = useNavigate();

  const [notifications, setNotifications] = useState([]);
  const [unread, setUnread] = useState(0);
  const [open, setOpen] = useState(false);

  const [toasts, setToasts] = useState([]);
  const prevCountRef = useRef(0);
  const dropdownRef = useRef(null);

  async function fetchNotifications() {
    if (!token) return;
    try {
      const data = await apiFetch('/api/notifications', { token });
      const newNotifs = data.notifications || [];
      const newCount = Number(data.count || 0);

      setNotifications(newNotifs);
      setUnread(newCount);

      // toast quand Ã§a augmente (sauf au tout premier load)
      const prev = prevCountRef.current;
      if (prev > 0 && newCount > prev) {
        const delta = newCount - prev;
        pushToast({
          title: 'Nouvelle notification',
          message: `ğŸ”” ${delta} nouvelle(s) notification(s)`,
          severity: 'info'
        });
      }
      prevCountRef.current = newCount;
    } catch (e) {
      // silencieux: on Ã©vite de spam l'utilisateur
      console.error('Notifications: fetch failed', e);
    }
  }

  function pushToast(t) {
    const id = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
    const toast = { id, timestamp: new Date().toISOString(), ...t };
    setToasts((prev) => [toast, ...prev].slice(0, 4));
    setTimeout(() => {
      setToasts((prev) => prev.filter((x) => x.id !== id));
    }, 3500);
  }

  useEffect(() => {
    fetchNotifications();
    const interval = setInterval(fetchNotifications, 10000);
    return () => clearInterval(interval);
  }, [token]);

  // close on outside click
  useEffect(() => {
    const onDown = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setOpen(false);
      }
    };
    document.addEventListener('mousedown', onDown);
    return () => document.removeEventListener('mousedown', onDown);
  }, []);

  const latest = useMemo(() => notifications.slice(0, 10), [notifications]);

  function handleClickNotif(n) {
    setOpen(false);
    if (n?.link) navigate(n.link);
  }

  return (
    <>
      {/* Toasts */}
      {toasts.length > 0 && (
        <div className="toastHost" aria-live="polite">
          {toasts.map((t) => (
            <div key={t.id} className="toast">
              <div className="toastRow">
                <div className="toastDot" style={{ background: severityToDot(t.severity) }} />
                <div style={{ flex: 1 }}>
                  <div className="toastTitle">{t.title}</div>
                  <div className="toastMsg">{t.message}</div>
                  <div className="toastTime">{formatTimestamp(t.timestamp)}</div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Bell */}
      <div style={{ position: 'relative' }} ref={dropdownRef}>
        <button
          className="iconBtn"
          onClick={() => {
            const next = !open;
            setOpen(next);
            if (next) fetchNotifications(); // refresh on open
          }}
          aria-label="Notifications"
          style={{ position: 'relative' }}
        >
          {/* simple bell icon */}
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path
              d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2Zm6-6V11a6 6 0 0 0-5-5.9V4a1 1 0 1 0-2 0v1.1A6 6 0 0 0 6 11v5l-2 2v1h16v-1l-2-2Z"
              stroke="currentColor"
              strokeWidth="1.6"
              strokeLinejoin="round"
            />
          </svg>

          {unread > 0 && (
            <span
              style={{
                position: 'absolute',
                top: 6,
                right: 6,
                width: 9,
                height: 9,
                borderRadius: 999,
                background: 'var(--danger)',
                boxShadow: '0 0 0 2px rgba(247,247,251,.9)'
              }}
            />
          )}
        </button>

        {open && (
          <div
            style={{
              position: 'absolute',
              right: 0,
              top: 48,
              width: 360,
              maxWidth: '92vw',
              background: 'white',
              border: '1px solid rgba(15,23,42,.12)',
              borderRadius: 16,
              boxShadow: '0 18px 60px rgba(15,23,42,.18)',
              overflow: 'hidden',
              zIndex: 9999
            }}
          >
            <div style={{ padding: 12, display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '1px solid rgba(15,23,42,.08)' }}>
              <div style={{ fontWeight: 900, fontSize: 13 }}>Notifications</div>
              <div className="badge badge-info">{unread} non lue(s)</div>
            </div>

            <div style={{ maxHeight: 420, overflow: 'auto' }}>
              {latest.length === 0 ? (
                <div style={{ padding: 14 }} className="muted">
                  Rien pour le moment.
                </div>
              ) : (
                latest.map((n) => (
                  <button
                    key={n.id}
                    onClick={() => handleClickNotif(n)}
                    className="btn"
                    style={{
                      width: '100%',
                      background: 'transparent',
                      color: 'inherit',
                      border: 'none',
                      borderBottom: '1px solid rgba(15,23,42,.06)',
                      textAlign: 'left',
                      padding: 12,
                      borderRadius: 0,
                      justifyContent: 'flex-start'
                    }}
                  >
                    <div style={{ display: 'flex', gap: 10, width: '100%' }}>
                      <div style={{ width: 10, display: 'flex', justifyContent: 'center' }}>
                        <span style={{ width: 8, height: 8, borderRadius: 99, background: severityToDot(n.severity) }} />
                      </div>

                      <div style={{ flex: 1, minWidth: 0 }}>
                        <div style={{ fontWeight: 900, fontSize: 13, marginBottom: 3, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                          {n.title}
                        </div>
                        <div style={{ fontSize: 12, color: 'rgba(15,23,42,.62)', marginBottom: 6 }}>
                          {n.message}
                        </div>
                        <div style={{ fontSize: 11, color: 'rgba(15,23,42,.45)' }}>
                          {formatTimestamp(n.timestamp)}
                        </div>
                      </div>
                    </div>
                  </button>
                ))
              )}
            </div>
          </div>
        )}
      </div>
    </>
  );
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/auth/AuthContext.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';
import { apiFetch } from '../utils/api.js';

const AuthContext = createContext(null);

const LS_KEY = 'prirtem_auth';

export function AuthProvider({ children }) {
  const [token, setToken] = useState(null);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed?.token) setToken(parsed.token);
        if (parsed?.user) setUser(parsed.user);
      }
    } catch {
      // ignore
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    if (!token) return;
    // refresh me (best effort)
    apiFetch('/api/auth/me', { token })
      .then((d) => {
        if (d?.user) {
          setUser(d.user);
          localStorage.setItem(LS_KEY, JSON.stringify({ token, user: d.user }));
        }
      })
      .catch((err) => {
        // Token may be expired or invalid (e.g. after DB reset / JWT_SECRET change)
        if (err?.status === 401) {
          setToken(null);
          setUser(null);
          localStorage.removeItem(LS_KEY);
        }
      });
  }, [token]);

  const value = useMemo(() => {
    return {
      token,
      user,
      loading,
      isAuthed: !!token,
      login: (tokenNew, userNew) => {
        setToken(tokenNew);
        setUser(userNew);
        localStorage.setItem(LS_KEY, JSON.stringify({ token: tokenNew, user: userNew }));
      },
      // Backward-compat: older pages call setSession(token,user)
      setSession: (tokenNew, userNew) => {
        setToken(tokenNew);
        setUser(userNew);
        localStorage.setItem(LS_KEY, JSON.stringify({ token: tokenNew, user: userNew }));
      },
      logout: () => {
        setToken(null);
        setUser(null);
        localStorage.removeItem(LS_KEY);
      }
    };
  }, [token, user, loading]);

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
}

export function useAuth() {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error('useAuth must be used inside AuthProvider');
  return ctx;
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/src/App.jsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import React from 'react';
import { Navigate, Route, Routes } from 'react-router-dom';
import { AuthProvider } from './auth/AuthContext.jsx';
import { ToastProvider } from './components/ToastContext.jsx';
import ProtectedRoute from './components/ProtectedRoute.jsx';
import Layout from './components/Layout.jsx';

import Login from './pages/Login.jsx';
import Register from './pages/Register.jsx';
import Forgot from './pages/Forgot.jsx';
import Reset from './pages/Reset.jsx';

import Dashboard from './pages/Dashboard.jsx';
import Fuel from './pages/Fuel.jsx';
import ImportExcel from './pages/ImportExcel.jsx';
import FuelRequests from './pages/FuelRequests.jsx';
import CarRequests from './pages/CarRequests.jsx';
import CalendarView from './pages/CalendarView.jsx'; // ========== NOUVEAU ==========
import Logbooks from './pages/Logbooks.jsx';
import LogbookEdit from './pages/LogbookEdit.jsx';
import PrintFuelRequest from './pages/PrintFuelRequest.jsx';
import PrintCarRequest from './pages/PrintCarRequest.jsx';
import PrintLogbook from './pages/PrintLogbook.jsx';
import Meta from './pages/Meta.jsx';
import Trash from './pages/Trash.jsx';

export default function App() {
  return (
    <AuthProvider>
      <ToastProvider>
      <Routes>
        <Route path="/" element={<Navigate to="/login" replace />} />
        <Route path="/login" element={<Login />} />
        <Route path="/register" element={<Register />} />
        <Route path="/forgot" element={<Forgot />} />
        <Route path="/reset" element={<Reset />} />

        {/* Print routes */}
        <Route path="/print/fuel/:id" element={
          <ProtectedRoute>
            <PrintFuelRequest />
          </ProtectedRoute>
        } />
        <Route path="/print/fuel-request/:id" element={
          <ProtectedRoute>
            <PrintFuelRequest />
          </ProtectedRoute>
        } />
        <Route path="/print/car/:id" element={
          <ProtectedRoute>
            <PrintCarRequest />
          </ProtectedRoute>
        } />
        <Route path="/print/car-request/:id" element={
          <ProtectedRoute>
            <PrintCarRequest />
          </ProtectedRoute>
        } />
        <Route path="/print/logbook/:id" element={
          <ProtectedRoute>
            <PrintLogbook />
          </ProtectedRoute>
        } />

        <Route path="/app" element={
          <ProtectedRoute>
            <Layout><Dashboard /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/fuel" element={
          <ProtectedRoute>
            <Layout><Fuel /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/import" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE']}>
            <Layout><ImportExcel /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/fuel" element={
          <ProtectedRoute>
            <Layout><FuelRequests /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/fuel/manage" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE']}>
            <Layout><FuelRequests /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/fuel/raf" element={
          <ProtectedRoute roles={['ADMIN','RAF']}>
            <Layout><FuelRequests /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/car" element={
          <ProtectedRoute>
            <Layout><CarRequests /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/car/manage" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE']}>
            <Layout><CarRequests /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/requests/car/raf" element={
          <ProtectedRoute roles={['ADMIN','RAF']}>
            <Layout><CarRequests /></Layout>
          </ProtectedRoute>
        } />

        {/* ========== NOUVEAU: CALENDRIER ========== */}
        <Route path="/app/calendar" element={
          <ProtectedRoute>
            <Layout><CalendarView /></Layout>
          </ProtectedRoute>
        } />

        <Route path="/app/meta" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE']}>
            <Layout><Meta /></Layout>
          </ProtectedRoute>
        } />

        <Route path="/app/trash" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE']}>
            <Layout><Trash /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/logbooks" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE','RAF']}>
            <Layout><Logbooks /></Layout>
          </ProtectedRoute>
        } />
        <Route path="/app/logbooks/:id" element={
          <ProtectedRoute roles={['ADMIN','LOGISTIQUE','RAF']}>
            <Layout><LogbookEdit /></Layout>
          </ProtectedRoute>
        } />

        <Route path="*" element={<Navigate to="/login" replace />} />
      </Routes>
      </ToastProvider>
    </AuthProvider>
  );
}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/package.json â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  "name": "prirtem-fuel-client",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "chart.js": "^4.4.3",
    "react": "^18.3.1",
    "react-chartjs-2": "^5.2.0",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.26.2"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.2",
    "vite": "^5.4.3"
  }
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/package-lock.json â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  "name": "prirtem-fuel-client",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "prirtem-fuel-client",
      "version": "1.0.0",
      "dependencies": {
        "chart.js": "^4.4.3",
        "react": "^18.3.1",
        "react-chartjs-2": "^5.2.0",
        "react-dom": "^18.3.1",
        "react-router-dom": "^6.26.2"
      },
      "devDependencies": {
        "@vitejs/plugin-react": "^4.3.2",
        "vite": "^5.4.3"
      }
    },
    "node_modules/@babel/code-frame": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.27.1.tgz",
      "integrity": "sha512-cjQ7ZlQ0Mv3b47hABuTevyTuYN4i+loJKGeV9flcCgIK37cCXRh+L1bd3iBHlynerhQ7BhCkn2BPbQUL+rGqFg==",
      "dev": true,
      "dependencies": {
        "@babel/helper-validator-identifier": "^7.27.1",
        "js-tokens": "^4.0.0",
        "picocolors": "^1.1.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/compat-data": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.28.5.tgz",
      "integrity": "sha512-6uFXyCayocRbqhZOB+6XcuZbkMNimwfVGFji8CTZnCzOHVGvDqzvitu1re2AU5LROliz7eQPhB8CpAMvnx9EjA==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/core": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.28.5.tgz",
      "integrity": "sha512-e7jT4DxYvIDLk1ZHmU/m/mB19rex9sv0c2ftBtjSBv+kVM/902eh0fINUzD7UwLLNR+jU585GxUJ8/EBfAM5fw==",
      "dev": true,
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.5",
        "@babel/helper-compilation-targets": "^7.27.2",
        "@babel/helper-module-transforms": "^7.28.3",
        "@babel/helpers": "^7.28.4",
        "@babel/parser": "^7.28.5",
        "@babel/template": "^7.27.2",
        "@babel/traverse": "^7.28.5",
        "@babel/types": "^7.28.5",
        "@jridgewell/remapping": "^2.3.5",
        "convert-source-map": "^2.0.0",
        "debug": "^4.1.0",
        "gensync": "^1.0.0-beta.2",
        "json5": "^2.2.3",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/babel"
      }
    },
    "node_modules/@babel/generator": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.28.5.tgz",
      "integrity": "sha512-3EwLFhZ38J4VyIP6WNtt2kUdW9dokXA9Cr4IVIFHuCpZ3H8/YFOl5JjZHisrn1fATPBmKKqXzDFvh9fUwHz6CQ==",
      "dev": true,
      "dependencies": {
        "@babel/parser": "^7.28.5",
        "@babel/types": "^7.28.5",
        "@jridgewell/gen-mapping": "^0.3.12",
        "@jridgewell/trace-mapping": "^0.3.28",
        "jsesc": "^3.0.2"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-compilation-targets": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.27.2.tgz",
      "integrity": "sha512-2+1thGUUWWjLTYTHZWK1n8Yga0ijBz1XAhUXcKy81rd5g6yh7hGqMp45v7cadSbEHc9G3OTv45SyneRN3ps4DQ==",
      "dev": true,
      "dependencies": {
        "@babel/compat-data": "^7.27.2",
        "@babel/helper-validator-option": "^7.27.1",
        "browserslist": "^4.24.0",
        "lru-cache": "^5.1.1",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-globals": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@babel/helper-globals/-/helper-globals-7.28.0.tgz",
      "integrity": "sha512-+W6cISkXFa1jXsDEdYA8HeevQT/FULhxzR99pxphltZcVaugps53THCeiWA8SguxxpSp3gKPiuYfSWopkLQ4hw==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-imports": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.27.1.tgz",
      "integrity": "sha512-0gSFWUPNXNopqtIPQvlD5WgXYI5GY2kP2cCvoT8kczjbfcfuIljTbcWrulD1CIPIX2gt1wghbDy08yE1p+/r3w==",
      "dev": true,
      "dependencies": {
        "@babel/traverse": "^7.27.1",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-transforms": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.28.3.tgz",
      "integrity": "sha512-gytXUbs8k2sXS9PnQptz5o0QnpLL51SwASIORY6XaBKF88nsOT0Zw9szLqlSGQDP/4TljBAD5y98p2U1fqkdsw==",
      "dev": true,
      "dependencies": {
        "@babel/helper-module-imports": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.27.1",
        "@babel/traverse": "^7.28.3"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-plugin-utils": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.27.1.tgz",
      "integrity": "sha512-1gn1Up5YXka3YYAHGKpbideQ5Yjf1tDa9qYcgysz+cNCXukyLl6DjPXhD3VRwSb8c0J9tA4b2+rHEZtc6R0tlw==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-string-parser": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
      "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-identifier": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.28.5.tgz",
      "integrity": "sha512-qSs4ifwzKJSV39ucNjsvc6WVHs6b7S03sOh2OcHF9UHfVPqWWALUsNUVzhSBiItjRZoLHx7nIarVjqKVusUZ1Q==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-option": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.27.1.tgz",
      "integrity": "sha512-YvjJow9FxbhFFKDSuFnVCe2WxXk1zWc22fFePVNEaWJEu8IrZVlda6N0uHwzZrUM1il7NC9Mlp4MaJYbYd9JSg==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helpers": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.28.4.tgz",
      "integrity": "sha512-HFN59MmQXGHVyYadKLVumYsA9dBFun/ldYxipEjzA4196jpLZd8UjEEBLkbEkvfYreDqJhZxYAWFPtrfhNpj4w==",
      "dev": true,
      "dependencies": {
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.4"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/parser": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.28.5.tgz",
      "integrity": "sha512-KKBU1VGYR7ORr3At5HAtUQ+TV3SzRCXmA/8OdDZiLDBIZxVyzXuztPjfLd3BV1PRAQGCMWWSHYhL0F8d5uHBDQ==",
      "dev": true,
      "dependencies": {
        "@babel/types": "^7.28.5"
      },
      "bin": {
        "parser": "bin/babel-parser.js"
      },
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-self": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-self/-/plugin-transform-react-jsx-self-7.27.1.tgz",
      "integrity": "sha512-6UzkCs+ejGdZ5mFFC/OCUrv028ab2fp1znZmCZjAOBKiBK2jXD1O+BPSfX8X2qjJ75fZBMSnQn3Rq2mrBJK2mw==",
      "dev": true,
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-source": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-source/-/plugin-transform-react-jsx-source-7.27.1.tgz",
      "integrity": "sha512-zbwoTsBruTeKB9hSq73ha66iFeJHuaFkUbwvqElnygoNbj/jHRsSeokowZFN3CZ64IvEqcmmkVe89OPXc7ldAw==",
      "dev": true,
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/template": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.27.2.tgz",
      "integrity": "sha512-LPDZ85aEJyYSd18/DkjNh4/y1ntkE5KwUHWTiqgRxruuZL2F1yuHligVHLvcHY2vMHXttKFpJn6LwfI7cw7ODw==",
      "dev": true,
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/parser": "^7.27.2",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/traverse": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.28.5.tgz",
      "integrity": "sha512-TCCj4t55U90khlYkVV/0TfkJkAkUg3jZFA3Neb7unZT8CPok7iiRfaX0F+WnqWqt7OxhOn0uBKXCw4lbL8W0aQ==",
      "dev": true,
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.5",
        "@babel/helper-globals": "^7.28.0",
        "@babel/parser": "^7.28.5",
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.5",
        "debug": "^4.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/types": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.28.5.tgz",
      "integrity": "sha512-qQ5m48eI/MFLQ5PxQj4PFaprjyCTLI37ElWMmNs0K8Lk3dVeOdNpB3ks8jc7yM5CDmVC73eMVk/trk3fgmrUpA==",
      "dev": true,
      "dependencies": {
        "@babel/helper-string-parser": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.28.5"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@esbuild/aix-ppc64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
      "integrity": "sha512-1SDgH6ZSPTlggy1yI6+Dbkiz8xzpHJEVAlF/AM1tHPLsf5STom9rwtjE4hKAF20FfXXNTFqEYXyJNWh1GiZedQ==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "aix"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-arm": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.21.5.tgz",
      "integrity": "sha512-vCPvzSjpPHEi1siZdlvAlsPxXl7WbOVUBBAowWug4rJHb68Ox8KualB+1ocNvT5fjv6wpkX6o/iEpbDrf68zcg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.21.5.tgz",
      "integrity": "sha512-c0uX9VAUBQ7dTDCjq+wdyGLowMdtR/GoC2U5IYk/7D1H1JYC0qseD7+11iMP2mRLN9RcCMRcjC4YMclCzGwS/A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/android-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.21.5.tgz",
      "integrity": "sha512-D7aPRUUNHRBwHxzxRvp856rjUHRFW1SdQATKXH2hqA0kAZb1hKmi02OpYRacl0TxIGz/ZmXWlbZgjwWYaCakTA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/darwin-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.21.5.tgz",
      "integrity": "sha512-DwqXqZyuk5AiWWf3UfLiRDJ5EDd49zg6O9wclZ7kUMv2WRFr4HKjXp/5t8JZ11QbQfUS6/cRCKGwYhtNAY88kQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/darwin-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.21.5.tgz",
      "integrity": "sha512-se/JjF8NlmKVG4kNIuyWMV/22ZaerB+qaSi5MdrXtd6R08kvs2qCN4C09miupktDitvh8jRFflwGFBQcxZRjbw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/freebsd-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.21.5.tgz",
      "integrity": "sha512-5JcRxxRDUJLX8JXp/wcBCy3pENnCgBR9bN6JsY4OmhfUtIHe3ZW0mawA7+RDAcMLrMIZaf03NlQiX9DGyB8h4g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/freebsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.21.5.tgz",
      "integrity": "sha512-J95kNBj1zkbMXtHVH29bBriQygMXqoVQOQYA+ISs0/2l3T9/kj42ow2mpqerRBxDJnmkUDCaQT/dfNXWX/ZZCQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-arm": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.21.5.tgz",
      "integrity": "sha512-bPb5AHZtbeNGjCKVZ9UGqGwo8EUu4cLq68E95A53KlxAPRmUyYv2D6F0uUI65XisGOL1hBP5mTronbgo+0bFcA==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.21.5.tgz",
      "integrity": "sha512-ibKvmyYzKsBeX8d8I7MH/TMfWDXBF3db4qM6sy+7re0YXya+K1cem3on9XgdT2EQGMu4hQyZhan7TeQ8XkGp4Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-ia32": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.21.5.tgz",
      "integrity": "sha512-YvjXDqLRqPDl2dvRODYmmhz4rPeVKYvppfGYKSNGdyZkA01046pLWyRKKI3ax8fbJoK5QbxblURkwK/MWY18Tg==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-loong64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.21.5.tgz",
      "integrity": "sha512-uHf1BmMG8qEvzdrzAqg2SIG/02+4/DHB6a9Kbya0XDvwDEKCoC8ZRWI5JJvNdUjtciBGFQ5PuBlpEOXQj+JQSg==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-mips64el": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.21.5.tgz",
      "integrity": "sha512-IajOmO+KJK23bj52dFSNCMsz1QP1DqM6cwLUv3W1QwyxkyIWecfafnI555fvSGqEKwjMXVLokcV5ygHW5b3Jbg==",
      "cpu": [
        "mips64el"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-ppc64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.21.5.tgz",
      "integrity": "sha512-1hHV/Z4OEfMwpLO8rp7CvlhBDnjsC3CttJXIhBi+5Aj5r+MBvy4egg7wCbe//hSsT+RvDAG7s81tAvpL2XAE4w==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-riscv64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.21.5.tgz",
      "integrity": "sha512-2HdXDMd9GMgTGrPWnJzP2ALSokE/0O5HhTUvWIbD3YdjME8JwvSCnNGBnTThKGEB91OZhzrJ4qIIxk/SBmyDDA==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-s390x": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.21.5.tgz",
      "integrity": "sha512-zus5sxzqBJD3eXxwvjN1yQkRepANgxE9lgOW2qLnmr8ikMTphkjgXu1HR01K4FJg8h1kEEDAqDcZQtbrRnB41A==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/linux-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.21.5.tgz",
      "integrity": "sha512-1rYdTpyv03iycF1+BhzrzQJCdOuAOtaqHTWJZCWvijKD2N5Xu0TtVC8/+1faWqcP9iBCWOmjmhoH94dH82BxPQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/netbsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.21.5.tgz",
      "integrity": "sha512-Woi2MXzXjMULccIwMnLciyZH4nCIMpWQAs049KEeMvOcNADVxo0UBIQPfSmxB3CWKedngg7sWZdLvLczpe0tLg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/openbsd-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.21.5.tgz",
      "integrity": "sha512-HLNNw99xsvx12lFBUwoT8EVCsSvRNDVxNpjZ7bPn947b8gJPzeHWyNVhFsaerc0n3TsbOINvRP2byTZ5LKezow==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/sunos-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.21.5.tgz",
      "integrity": "sha512-6+gjmFpfy0BHU5Tpptkuh8+uw3mnrvgs+dSPQXQOv3ekbordwnzTVEb4qnIvQcYXq6gzkyTnoZ9dZG+D4garKg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "sunos"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-arm64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.21.5.tgz",
      "integrity": "sha512-Z0gOTd75VvXqyq7nsl93zwahcTROgqvuAcYDUr+vOv8uHhNSKROyU961kgtCD1e95IqPKSQKH7tBTslnS3tA8A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-ia32": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.21.5.tgz",
      "integrity": "sha512-SWXFF1CL2RVNMaVs+BBClwtfZSvDgtL//G/smwAc5oVK/UPu2Gu9tIaRgFmYFFKrmg3SyAjSrElf0TiJ1v8fYA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild/win32-x64": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.21.5.tgz",
      "integrity": "sha512-tQd/1efJuzPC6rCFwEvLtci/xNFcTZknmXs98FYDfGE4wP9ClFV98nyKrzJKVPMhdDnjzLhdUyMX4PsQAPjwIw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@jridgewell/gen-mapping": {
      "version": "0.3.13",
      "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
      "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
      "dev": true,
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.0",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/remapping": {
      "version": "2.3.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/remapping/-/remapping-2.3.5.tgz",
      "integrity": "sha512-LI9u/+laYG4Ds1TDKSJW2YPrIlcVYOwi2fUC6xB43lueCjgxV4lffOCZCtYFiH6TNOX+tQKXx97T4IKHbhyHEQ==",
      "dev": true,
      "dependencies": {
        "@jridgewell/gen-mapping": "^0.3.5",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/resolve-uri": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
      "dev": true,
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@jridgewell/sourcemap-codec": {
      "version": "1.5.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
      "integrity": "sha512-cYQ9310grqxueWbl+WuIUIaiUaDcj7WOq5fVhEljNVgRfOUhY9fy2zTvfoqWsnebh8Sl70VScFbICvJnLKB0Og==",
      "dev": true
    },
    "node_modules/@jridgewell/trace-mapping": {
      "version": "0.3.31",
      "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.31.tgz",
      "integrity": "sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==",
      "dev": true,
      "dependencies": {
        "@jridgewell/resolve-uri": "^3.1.0",
        "@jridgewell/sourcemap-codec": "^1.4.14"
      }
    },
    "node_modules/@kurkle/color": {
      "version": "0.3.4",
      "resolved": "https://registry.npmjs.org/@kurkle/color/-/color-0.3.4.tgz",
      "integrity": "sha512-M5UknZPHRu3DEDWoipU6sE8PdkZ6Z/S+v4dD+Ke8IaNlpdSQah50lz1KtcFBa2vsdOnwbbnxJwVM4wty6udA5w=="
    },
    "node_modules/@remix-run/router": {
      "version": "1.23.2",
      "resolved": "https://registry.npmjs.org/@remix-run/router/-/router-1.23.2.tgz",
      "integrity": "sha512-Ic6m2U/rMjTkhERIa/0ZtXJP17QUi2CbWE7cqx4J58M8aA3QTfW+2UlQ4psvTX9IO1RfNVhK3pcpdjej7L+t2w==",
      "engines": {
        "node": ">=14.0.0"
      }
    },
    "node_modules/@rolldown/pluginutils": {
      "version": "1.0.0-beta.27",
      "resolved": "https://registry.npmjs.org/@rolldown/pluginutils/-/pluginutils-1.0.0-beta.27.tgz",
      "integrity": "sha512-+d0F4MKMCbeVUJwG96uQ4SgAznZNSq93I3V+9NHA4OpvqG8mRCpGdKmK8l/dl02h2CCDHwW2FqilnTyDcAnqjA==",
      "dev": true
    },
    "node_modules/@rollup/rollup-android-arm-eabi": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.55.1.tgz",
      "integrity": "sha512-9R0DM/ykwfGIlNu6+2U09ga0WXeZ9MRC2Ter8jnz8415VbuIykVuc6bhdrbORFZANDmTDvq26mJrEVTl8TdnDg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-android-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.55.1.tgz",
      "integrity": "sha512-eFZCb1YUqhTysgW3sj/55du5cG57S7UTNtdMjCW7LwVcj3dTTcowCsC8p7uBdzKsZYa8J7IDE8lhMI+HX1vQvg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-darwin-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.55.1.tgz",
      "integrity": "sha512-p3grE2PHcQm2e8PSGZdzIhCKbMCw/xi9XvMPErPhwO17vxtvCN5FEA2mSLgmKlCjHGMQTP6phuQTYWUnKewwGg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-darwin-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.55.1.tgz",
      "integrity": "sha512-rDUjG25C9qoTm+e02Esi+aqTKSBYwVTaoS1wxcN47/Luqef57Vgp96xNANwt5npq9GDxsH7kXxNkJVEsWEOEaQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-arm64/-/rollup-freebsd-arm64-4.55.1.tgz",
      "integrity": "sha512-+JiU7Jbp5cdxekIgdte0jfcu5oqw4GCKr6i3PJTlXTCU5H5Fvtkpbs4XJHRmWNXF+hKmn4v7ogI5OQPaupJgOg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-x64/-/rollup-freebsd-x64-4.55.1.tgz",
      "integrity": "sha512-V5xC1tOVWtLLmr3YUk2f6EJK4qksksOYiz/TCsFHu/R+woubcLWdC9nZQmwjOAbmExBIVKsm1/wKmEy4z4u4Bw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.55.1.tgz",
      "integrity": "sha512-Rn3n+FUk2J5VWx+ywrG/HGPTD9jXNbicRtTM11e/uorplArnXZYsVifnPPqNNP5BsO3roI4n8332ukpY/zN7rQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-musleabihf": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.55.1.tgz",
      "integrity": "sha512-grPNWydeKtc1aEdrJDWk4opD7nFtQbMmV7769hiAaYyUKCT1faPRm2av8CX1YJsZ4TLAZcg9gTR1KvEzoLjXkg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.55.1.tgz",
      "integrity": "sha512-a59mwd1k6x8tXKcUxSyISiquLwB5pX+fJW9TkWU46lCqD/GRDe9uDN31jrMmVP3feI3mhAdvcCClhV8V5MhJFQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.55.1.tgz",
      "integrity": "sha512-puS1MEgWX5GsHSoiAsF0TYrpomdvkaXm0CofIMG5uVkP6IBV+ZO9xhC5YEN49nsgYo1DuuMquF9+7EDBVYu4uA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-gnu/-/rollup-linux-loong64-gnu-4.55.1.tgz",
      "integrity": "sha512-r3Wv40in+lTsULSb6nnoudVbARdOwb2u5fpeoOAZjFLznp6tDU8kd+GTHmJoqZ9lt6/Sys33KdIHUaQihFcu7g==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-musl/-/rollup-linux-loong64-musl-4.55.1.tgz",
      "integrity": "sha512-MR8c0+UxAlB22Fq4R+aQSPBayvYa3+9DrwG/i1TKQXFYEaoW3B5b/rkSRIypcZDdWjWnpcvxbNaAJDcSbJU3Lw==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-gnu/-/rollup-linux-ppc64-gnu-4.55.1.tgz",
      "integrity": "sha512-3KhoECe1BRlSYpMTeVrD4sh2Pw2xgt4jzNSZIIPLFEsnQn9gAnZagW9+VqDqAHgm1Xc77LzJOo2LdigS5qZ+gw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-musl/-/rollup-linux-ppc64-musl-4.55.1.tgz",
      "integrity": "sha512-ziR1OuZx0vdYZZ30vueNZTg73alF59DicYrPViG0NEgDVN8/Jl87zkAPu4u6VjZST2llgEUjaiNl9JM6HH1Vdw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.55.1.tgz",
      "integrity": "sha512-uW0Y12ih2XJRERZ4jAfKamTyIHVMPQnTZcQjme2HMVDAHY4amf5u414OqNYC+x+LzRdRcnIG1YodLrrtA8xsxw==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-musl/-/rollup-linux-riscv64-musl-4.55.1.tgz",
      "integrity": "sha512-u9yZ0jUkOED1BFrqu3BwMQoixvGHGZ+JhJNkNKY/hyoEgOwlqKb62qu+7UjbPSHYjiVy8kKJHvXKv5coH4wDeg==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-s390x-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.55.1.tgz",
      "integrity": "sha512-/0PenBCmqM4ZUd0190j7J0UsQ/1nsi735iPRakO8iPciE7BQ495Y6msPzaOmvx0/pn+eJVVlZrNrSh4WSYLxNg==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.55.1.tgz",
      "integrity": "sha512-a8G4wiQxQG2BAvo+gU6XrReRRqj+pLS2NGXKm8io19goR+K8lw269eTrPkSdDTALwMmJp4th2Uh0D8J9bEV1vg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-musl": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.55.1.tgz",
      "integrity": "sha512-bD+zjpFrMpP/hqkfEcnjXWHMw5BIghGisOKPj+2NaNDuVT+8Ds4mPf3XcPHuat1tz89WRL+1wbcxKY3WSbiT7w==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-openbsd-x64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openbsd-x64/-/rollup-openbsd-x64-4.55.1.tgz",
      "integrity": "sha512-eLXw0dOiqE4QmvikfQ6yjgkg/xDM+MdU9YJuP4ySTibXU0oAvnEWXt7UDJmD4UkYialMfOGFPJnIHSe/kdzPxg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openbsd"
      ]
    },
    "node_modules/@rollup/rollup-openharmony-arm64": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openharmony-arm64/-/rollup-openharmony-arm64-4.55.1.tgz",
      "integrity": "sha512-xzm44KgEP11te3S2HCSyYf5zIzWmx3n8HDCc7EE59+lTcswEWNpvMLfd9uJvVX8LCg9QWG67Xt75AuHn4vgsXw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "openharmony"
      ]
    },
    "node_modules/@rollup/rollup-win32-arm64-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.55.1.tgz",
      "integrity": "sha512-yR6Bl3tMC/gBok5cz/Qi0xYnVbIxGx5Fcf/ca0eB6/6JwOY+SRUcJfI0OpeTpPls7f194as62thCt/2BjxYN8g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-ia32-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.55.1.tgz",
      "integrity": "sha512-3fZBidchE0eY0oFZBnekYCfg+5wAB0mbpCBuofh5mZuzIU/4jIVkbESmd2dOsFNS78b53CYv3OAtwqkZZmU5nA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-gnu": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-gnu/-/rollup-win32-x64-gnu-4.55.1.tgz",
      "integrity": "sha512-xGGY5pXj69IxKb4yv/POoocPy/qmEGhimy/FoTpTSVju3FYXUQQMFCaZZXJVidsmGxRioZAwpThl/4zX41gRKg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-msvc": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.55.1.tgz",
      "integrity": "sha512-SPEpaL6DX4rmcXtnhdrQYgzQ5W2uW3SCJch88lB2zImhJRhIIK44fkUrgIV/Q8yUNfw5oyZ5vkeQsZLhCb06lw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@types/babel__core": {
      "version": "7.20.5",
      "resolved": "https://registry.npmjs.org/@types/babel__core/-/babel__core-7.20.5.tgz",
      "integrity": "sha512-qoQprZvz5wQFJwMDqeseRXWv3rqMvhgpbXFfVyWhbx9X47POIA6i/+dXefEmZKoAgOaTdaIgNSMqMIU61yRyzA==",
      "dev": true,
      "dependencies": {
        "@babel/parser": "^7.20.7",
        "@babel/types": "^7.20.7",
        "@types/babel__generator": "*",
        "@types/babel__template": "*",
        "@types/babel__traverse": "*"
      }
    },
    "node_modules/@types/babel__generator": {
      "version": "7.27.0",
      "resolved": "https://registry.npmjs.org/@types/babel__generator/-/babel__generator-7.27.0.tgz",
      "integrity": "sha512-ufFd2Xi92OAVPYsy+P4n7/U7e68fex0+Ee8gSG9KX7eo084CWiQ4sdxktvdl0bOPupXtVJPY19zk6EwWqUQ8lg==",
      "dev": true,
      "dependencies": {
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__template": {
      "version": "7.4.4",
      "resolved": "https://registry.npmjs.org/@types/babel__template/-/babel__template-7.4.4.tgz",
      "integrity": "sha512-h/NUaSyG5EyxBIp8YRxo4RMe2/qQgvyowRwVMzhYhBCONbW8PUsg4lkFMrhgZhUe5z3L3MiLDuvyJ/CaPa2A8A==",
      "dev": true,
      "dependencies": {
        "@babel/parser": "^7.1.0",
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__traverse": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@types/babel__traverse/-/babel__traverse-7.28.0.tgz",
      "integrity": "sha512-8PvcXf70gTDZBgt9ptxJ8elBeBjcLOAcOtoO/mPJjtji1+CdGbHgm77om1GrsPxsiE+uXIpNSK64UYaIwQXd4Q==",
      "dev": true,
      "dependencies": {
        "@babel/types": "^7.28.2"
      }
    },
    "node_modules/@types/estree": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.8.tgz",
      "integrity": "sha512-dWHzHa2WqEXI/O1E9OjrocMTKJl2mSrEolh1Iomrv6U+JuNwaHXsXx9bLu5gG7BUWFIN0skIQJQ/L1rIex4X6w==",
      "dev": true
    },
    "node_modules/@vitejs/plugin-react": {
      "version": "4.7.0",
      "resolved": "https://registry.npmjs.org/@vitejs/plugin-react/-/plugin-react-4.7.0.tgz",
      "integrity": "sha512-gUu9hwfWvvEDBBmgtAowQCojwZmJ5mcLn3aufeCsitijs3+f2NsrPtlAWIR6OPiqljl96GVCUbLe0HyqIpVaoA==",
      "dev": true,
      "dependencies": {
        "@babel/core": "^7.28.0",
        "@babel/plugin-transform-react-jsx-self": "^7.27.1",
        "@babel/plugin-transform-react-jsx-source": "^7.27.1",
        "@rolldown/pluginutils": "1.0.0-beta.27",
        "@types/babel__core": "^7.20.5",
        "react-refresh": "^0.17.0"
      },
      "engines": {
        "node": "^14.18.0 || >=16.0.0"
      },
      "peerDependencies": {
        "vite": "^4.2.0 || ^5.0.0 || ^6.0.0 || ^7.0.0"
      }
    },
    "node_modules/baseline-browser-mapping": {
      "version": "2.9.12",
      "resolved": "https://registry.npmjs.org/baseline-browser-mapping/-/baseline-browser-mapping-2.9.12.tgz",
      "integrity": "sha512-Mij6Lij93pTAIsSYy5cyBQ975Qh9uLEc5rwGTpomiZeXZL9yIS6uORJakb3ScHgfs0serMMfIbXzokPMuEiRyw==",
      "dev": true,
      "bin": {
        "baseline-browser-mapping": "dist/cli.js"
      }
    },
    "node_modules/browserslist": {
      "version": "4.28.1",
      "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.28.1.tgz",
      "integrity": "sha512-ZC5Bd0LgJXgwGqUknZY/vkUQ04r8NXnJZ3yYi4vDmSiZmC/pdSN0NbNRPxZpbtO4uAfDUAFffO8IZoM3Gj8IkA==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "dependencies": {
        "baseline-browser-mapping": "^2.9.0",
        "caniuse-lite": "^1.0.30001759",
        "electron-to-chromium": "^1.5.263",
        "node-releases": "^2.0.27",
        "update-browserslist-db": "^1.2.0"
      },
      "bin": {
        "browserslist": "cli.js"
      },
      "engines": {
        "node": "^6 || ^7 || ^8 || ^9 || ^10 || ^11 || ^12 || >=13.7"
      }
    },
    "node_modules/caniuse-lite": {
      "version": "1.0.30001763",
      "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001763.tgz",
      "integrity": "sha512-mh/dGtq56uN98LlNX9qdbKnzINhX0QzhiWBFEkFfsFO4QyCvL8YegrJAazCwXIeqkIob8BlZPGM3xdnY+sgmvQ==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/caniuse-lite"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ]
    },
    "node_modules/chart.js": {
      "version": "4.5.1",
      "resolved": "https://registry.npmjs.org/chart.js/-/chart.js-4.5.1.tgz",
      "integrity": "sha512-GIjfiT9dbmHRiYi6Nl2yFCq7kkwdkp1W/lp2J99rX0yo9tgJGn3lKQATztIjb5tVtevcBtIdICNWqlq5+E8/Pw==",
      "dependencies": {
        "@kurkle/color": "^0.3.0"
      },
      "engines": {
        "pnpm": ">=8"
      }
    },
    "node_modules/convert-source-map": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/convert-source-map/-/convert-source-map-2.0.0.tgz",
      "integrity": "sha512-Kvp459HrV2FEJ1CAsi1Ku+MY3kasH19TFykTz2xWmMeq6bk2NU3XXvfJ+Q61m0xktWwt+1HSYf3JZsTms3aRJg==",
      "dev": true
    },
    "node_modules/debug": {
      "version": "4.4.3",
      "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.3.tgz",
      "integrity": "sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==",
      "dev": true,
      "dependencies": {
        "ms": "^2.1.3"
      },
      "engines": {
        "node": ">=6.0"
      },
      "peerDependenciesMeta": {
        "supports-color": {
          "optional": true
        }
      }
    },
    "node_modules/electron-to-chromium": {
      "version": "1.5.267",
      "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.5.267.tgz",
      "integrity": "sha512-0Drusm6MVRXSOJpGbaSVgcQsuB4hEkMpHXaVstcPmhu5LIedxs1xNK/nIxmQIU/RPC0+1/o0AVZfBTkTNJOdUw==",
      "dev": true
    },
    "node_modules/esbuild": {
      "version": "0.21.5",
      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.21.5.tgz",
      "integrity": "sha512-mg3OPMV4hXywwpoDxu3Qda5xCKQi+vCTZq8S9J/EpkhB2HzKXq4SNFZE3+NK93JYxc8VMSep+lOUSC/RVKaBqw==",
      "dev": true,
      "hasInstallScript": true,
      "bin": {
        "esbuild": "bin/esbuild"
      },
      "engines": {
        "node": ">=12"
      },
      "optionalDependencies": {
        "@esbuild/aix-ppc64": "0.21.5",
        "@esbuild/android-arm": "0.21.5",
        "@esbuild/android-arm64": "0.21.5",
        "@esbuild/android-x64": "0.21.5",
        "@esbuild/darwin-arm64": "0.21.5",
        "@esbuild/darwin-x64": "0.21.5",
        "@esbuild/freebsd-arm64": "0.21.5",
        "@esbuild/freebsd-x64": "0.21.5",
        "@esbuild/linux-arm": "0.21.5",
        "@esbuild/linux-arm64": "0.21.5",
        "@esbuild/linux-ia32": "0.21.5",
        "@esbuild/linux-loong64": "0.21.5",
        "@esbuild/linux-mips64el": "0.21.5",
        "@esbuild/linux-ppc64": "0.21.5",
        "@esbuild/linux-riscv64": "0.21.5",
        "@esbuild/linux-s390x": "0.21.5",
        "@esbuild/linux-x64": "0.21.5",
        "@esbuild/netbsd-x64": "0.21.5",
        "@esbuild/openbsd-x64": "0.21.5",
        "@esbuild/sunos-x64": "0.21.5",
        "@esbuild/win32-arm64": "0.21.5",
        "@esbuild/win32-ia32": "0.21.5",
        "@esbuild/win32-x64": "0.21.5"
      }
    },
    "node_modules/escalade": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz",
      "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
      "dev": true,
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/fsevents": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
      "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
      "dev": true,
      "hasInstallScript": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
      }
    },
    "node_modules/gensync": {
      "version": "1.0.0-beta.2",
      "resolved": "https://registry.npmjs.org/gensync/-/gensync-1.0.0-beta.2.tgz",
      "integrity": "sha512-3hN7NaskYvMDLQY55gnW3NQ+mesEAepTqlg+VEbj7zzqEMBVNhzcGYYeqFo/TlYz6eQiFcp1HcsCZO+nGgS8zg==",
      "dev": true,
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/js-tokens": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/js-tokens/-/js-tokens-4.0.0.tgz",
      "integrity": "sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ=="
    },
    "node_modules/jsesc": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/jsesc/-/jsesc-3.1.0.tgz",
      "integrity": "sha512-/sM3dO2FOzXjKQhJuo0Q173wf2KOo8t4I8vHy6lF9poUp7bKT0/NHE8fPX23PwfhnykfqnC2xRxOnVw5XuGIaA==",
      "dev": true,
      "bin": {
        "jsesc": "bin/jsesc"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/json5": {
      "version": "2.2.3",
      "resolved": "https://registry.npmjs.org/json5/-/json5-2.2.3.tgz",
      "integrity": "sha512-XmOWe7eyHYH14cLdVPoyg+GOH3rYX++KpzrylJwSW98t3Nk+U8XOl8FWKOgwtzdb8lXGf6zYwDUzeHMWfxasyg==",
      "dev": true,
      "bin": {
        "json5": "lib/cli.js"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/loose-envify": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/loose-envify/-/loose-envify-1.4.0.tgz",
      "integrity": "sha512-lyuxPGr/Wfhrlem2CL/UcnUc1zcqKAImBDzukY7Y5F/yQiNdko6+fRLevlw1HgMySw7f611UIY408EtxRSoK3Q==",
      "dependencies": {
        "js-tokens": "^3.0.0 || ^4.0.0"
      },
      "bin": {
        "loose-envify": "cli.js"
      }
    },
    "node_modules/lru-cache": {
      "version": "5.1.1",
      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-5.1.1.tgz",
      "integrity": "sha512-KpNARQA3Iwv+jTA0utUVVbrh+Jlrr1Fv0e56GGzAFOXN7dk/FviaDW8LHmK52DlcH4WP2n6gI8vN1aesBFgo9w==",
      "dev": true,
      "dependencies": {
        "yallist": "^3.0.2"
      }
    },
    "node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "dev": true
    },
    "node_modules/nanoid": {
      "version": "3.3.11",
      "resolved": "https://registry.npmjs.org/nanoid/-/nanoid-3.3.11.tgz",
      "integrity": "sha512-N8SpfPUnUp1bK+PMYW8qSWdl9U+wwNWI4QKxOYDy9JAro3WMX7p2OeVRF9v+347pnakNevPmiHhNmZ2HbFA76w==",
      "dev": true,
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "bin": {
        "nanoid": "bin/nanoid.cjs"
      },
      "engines": {
        "node": "^10 || ^12 || ^13.7 || ^14 || >=15.0.1"
      }
    },
    "node_modules/node-releases": {
      "version": "2.0.27",
      "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.27.tgz",
      "integrity": "sha512-nmh3lCkYZ3grZvqcCH+fjmQ7X+H0OeZgP40OierEaAptX4XofMh5kwNbWh7lBduUzCcV/8kZ+NDLCwm2iorIlA==",
      "dev": true
    },
    "node_modules/picocolors": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.1.tgz",
      "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
      "dev": true
    },
    "node_modules/postcss": {
      "version": "8.5.6",
      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.5.6.tgz",
      "integrity": "sha512-3Ybi1tAuwAP9s0r1UQ2J4n5Y0G05bJkpUIO0/bI9MhwmD70S5aTWbXGBwxHrelT+XM1k6dM0pk+SwNkpTRN7Pg==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/postcss"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "dependencies": {
        "nanoid": "^3.3.11",
        "picocolors": "^1.1.1",
        "source-map-js": "^1.2.1"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      }
    },
    "node_modules/react": {
      "version": "18.3.1",
      "resolved": "https://registry.npmjs.org/react/-/react-18.3.1.tgz",
      "integrity": "sha512-wS+hAgJShR0KhEvPJArfuPVN1+Hz1t0Y6n5jLrGQbkb4urgPE/0Rve+1kMB1v/oWgHgm4WIcV+i7F2pTVj+2iQ==",
      "dependencies": {
        "loose-envify": "^1.1.0"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-chartjs-2": {
      "version": "5.3.1",
      "resolved": "https://registry.npmjs.org/react-chartjs-2/-/react-chartjs-2-5.3.1.tgz",
      "integrity": "sha512-h5IPXKg9EXpjoBzUfyWJvllMjG2mQ4EiuHQFhms/AjUm0XSZHhyRy2xVmLXHKrtcdrPO4mnGqRtYoD0vp95A0A==",
      "peerDependencies": {
        "chart.js": "^4.1.1",
        "react": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0"
      }
    },
    "node_modules/react-dom": {
      "version": "18.3.1",
      "resolved": "https://registry.npmjs.org/react-dom/-/react-dom-18.3.1.tgz",
      "integrity": "sha512-5m4nQKp+rZRb09LNH59GM4BxTh9251/ylbKIbpe7TpGxfJ+9kv6BLkLBXIjjspbgbnIBNqlI23tRnTWT0snUIw==",
      "dependencies": {
        "loose-envify": "^1.1.0",
        "scheduler": "^0.23.2"
      },
      "peerDependencies": {
        "react": "^18.3.1"
      }
    },
    "node_modules/react-refresh": {
      "version": "0.17.0",
      "resolved": "https://registry.npmjs.org/react-refresh/-/react-refresh-0.17.0.tgz",
      "integrity": "sha512-z6F7K9bV85EfseRCp2bzrpyQ0Gkw1uLoCel9XBVWPg/TjRj94SkJzUTGfOa4bs7iJvBWtQG0Wq7wnI0syw3EBQ==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-router": {
      "version": "6.30.3",
      "resolved": "https://registry.npmjs.org/react-router/-/react-router-6.30.3.tgz",
      "integrity": "sha512-XRnlbKMTmktBkjCLE8/XcZFlnHvr2Ltdr1eJX4idL55/9BbORzyZEaIkBFDhFGCEWBBItsVrDxwx3gnisMitdw==",
      "dependencies": {
        "@remix-run/router": "1.23.2"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "react": ">=16.8"
      }
    },
    "node_modules/react-router-dom": {
      "version": "6.30.3",
      "resolved": "https://registry.npmjs.org/react-router-dom/-/react-router-dom-6.30.3.tgz",
      "integrity": "sha512-pxPcv1AczD4vso7G4Z3TKcvlxK7g7TNt3/FNGMhfqyntocvYKj+GCatfigGDjbLozC4baguJ0ReCigoDJXb0ag==",
      "dependencies": {
        "@remix-run/router": "1.23.2",
        "react-router": "6.30.3"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "react": ">=16.8",
        "react-dom": ">=16.8"
      }
    },
    "node_modules/rollup": {
      "version": "4.55.1",
      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.55.1.tgz",
      "integrity": "sha512-wDv/Ht1BNHB4upNbK74s9usvl7hObDnvVzknxqY/E/O3X6rW1U1rV1aENEfJ54eFZDTNo7zv1f5N4edCluH7+A==",
      "dev": true,
      "dependencies": {
        "@types/estree": "1.0.8"
      },
      "bin": {
        "rollup": "dist/bin/rollup"
      },
      "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
      },
      "optionalDependencies": {
        "@rollup/rollup-android-arm-eabi": "4.55.1",
        "@rollup/rollup-android-arm64": "4.55.1",
        "@rollup/rollup-darwin-arm64": "4.55.1",
        "@rollup/rollup-darwin-x64": "4.55.1",
        "@rollup/rollup-freebsd-arm64": "4.55.1",
        "@rollup/rollup-freebsd-x64": "4.55.1",
        "@rollup/rollup-linux-arm-gnueabihf": "4.55.1",
        "@rollup/rollup-linux-arm-musleabihf": "4.55.1",
        "@rollup/rollup-linux-arm64-gnu": "4.55.1",
        "@rollup/rollup-linux-arm64-musl": "4.55.1",
        "@rollup/rollup-linux-loong64-gnu": "4.55.1",
        "@rollup/rollup-linux-loong64-musl": "4.55.1",
        "@rollup/rollup-linux-ppc64-gnu": "4.55.1",
        "@rollup/rollup-linux-ppc64-musl": "4.55.1",
        "@rollup/rollup-linux-riscv64-gnu": "4.55.1",
        "@rollup/rollup-linux-riscv64-musl": "4.55.1",
        "@rollup/rollup-linux-s390x-gnu": "4.55.1",
        "@rollup/rollup-linux-x64-gnu": "4.55.1",
        "@rollup/rollup-linux-x64-musl": "4.55.1",
        "@rollup/rollup-openbsd-x64": "4.55.1",
        "@rollup/rollup-openharmony-arm64": "4.55.1",
        "@rollup/rollup-win32-arm64-msvc": "4.55.1",
        "@rollup/rollup-win32-ia32-msvc": "4.55.1",
        "@rollup/rollup-win32-x64-gnu": "4.55.1",
        "@rollup/rollup-win32-x64-msvc": "4.55.1",
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/scheduler": {
      "version": "0.23.2",
      "resolved": "https://registry.npmjs.org/scheduler/-/scheduler-0.23.2.tgz",
      "integrity": "sha512-UOShsPwz7NrMUqhR6t0hWjFduvOzbtv7toDH1/hIrfRNIDBnnBWd0CwJTGvTpngVlmwGCdP9/Zl/tVrDqcuYzQ==",
      "dependencies": {
        "loose-envify": "^1.1.0"
      }
    },
    "node_modules/semver": {
      "version": "6.3.1",
      "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
      "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
      "dev": true,
      "bin": {
        "semver": "bin/semver.js"
      }
    },
    "node_modules/source-map-js": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
      "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/update-browserslist-db": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.2.3.tgz",
      "integrity": "sha512-Js0m9cx+qOgDxo0eMiFGEueWztz+d4+M3rGlmKPT+T4IS/jP4ylw3Nwpu6cpTTP8R1MAC1kF4VbdLt3ARf209w==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "dependencies": {
        "escalade": "^3.2.0",
        "picocolors": "^1.1.1"
      },
      "bin": {
        "update-browserslist-db": "cli.js"
      },
      "peerDependencies": {
        "browserslist": ">= 4.21.0"
      }
    },
    "node_modules/vite": {
      "version": "5.4.21",
      "resolved": "https://registry.npmjs.org/vite/-/vite-5.4.21.tgz",
      "integrity": "sha512-o5a9xKjbtuhY6Bi5S3+HvbRERmouabWbyUcpXXUA1u+GNUKoROi9byOJ8M0nHbHYHkYICiMlqxkg1KkYmm25Sw==",
      "dev": true,
      "dependencies": {
        "esbuild": "^0.21.3",
        "postcss": "^8.4.43",
        "rollup": "^4.20.0"
      },
      "bin": {
        "vite": "bin/vite.js"
      },
      "engines": {
        "node": "^18.0.0 || >=20.0.0"
      },
      "funding": {
        "url": "https://github.com/vitejs/vite?sponsor=1"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.3"
      },
      "peerDependencies": {
        "@types/node": "^18.0.0 || >=20.0.0",
        "less": "*",
        "lightningcss": "^1.21.0",
        "sass": "*",
        "sass-embedded": "*",
        "stylus": "*",
        "sugarss": "*",
        "terser": "^5.4.0"
      },
      "peerDependenciesMeta": {
        "@types/node": {
          "optional": true
        },
        "less": {
          "optional": true
        },
        "lightningcss": {
          "optional": true
        },
        "sass": {
          "optional": true
        },
        "sass-embedded": {
          "optional": true
        },
        "stylus": {
          "optional": true
        },
        "sugarss": {
          "optional": true
        },
        "terser": {
          "optional": true
        }
      }
    },
    "node_modules/yallist": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/yallist/-/yallist-3.1.1.tgz",
      "integrity": "sha512-a4UGQaWPH59mOXUYnAG2ewncQS4i4F43Tv3JoAM+s2VDAmS9NsK8GpDMLrCHPksFT7h3K6TOoUNn2pb7RoXx4g==",
      "dev": true
    }
  }
}


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/index.html â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PRIRTEM - Carburant & Flotte</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ client/Dockerfile.dev â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM node:20-alpine
WORKDIR /app
RUN apk add --no-cache bash

COPY package*.json ./
RUN npm install

COPY . .
EXPOSE 5173

CMD ["npm","run","dev","--","--host","0.0.0.0","--port","5173"]
